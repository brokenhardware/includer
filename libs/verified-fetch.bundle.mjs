/* esm.sh - @helia/verified-fetch@3.2.0 */
import __Process$ from "/node/process.mjs";
import { Buffer as __Buffer$ } from "/node/buffer.mjs";
var mF=Object.create;var F8=Object.defineProperty;var gF=Object.getOwnPropertyDescriptor;var yF=Object.getOwnPropertyNames;var wF=Object.getPrototypeOf,xF=Object.prototype.hasOwnProperty;var ht=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),Ut=(r,e)=>{for(var t in e)F8(r,t,{get:e[t],enumerable:!0})},bF=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of yF(e))!xF.call(r,o)&&o!==t&&F8(r,o,{get:()=>e[o],enumerable:!(n=gF(e,o))||n.enumerable});return r};var st=(r,e,t)=>(t=r!=null?mF(wF(r)):{},bF(e||!r||!r.__esModule?F8(t,"default",{value:r,enumerable:!0}):t,r));var Ig=ht((tue,W_)=>{var Pf=1e3,Rf=Pf*60,Df=Rf*60,il=Df*24,WV=il*7,GV=il*365.25;W_.exports=function(r,e){e=e||{};var t=typeof r;if(t==="string"&&r.length>0)return XV(r);if(t==="number"&&isFinite(r))return e.long?QV(r):YV(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function XV(r){if(r=String(r),!(r.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(e){var t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*GV;case"weeks":case"week":case"w":return t*WV;case"days":case"day":case"d":return t*il;case"hours":case"hour":case"hrs":case"hr":case"h":return t*Df;case"minutes":case"minute":case"mins":case"min":case"m":return t*Rf;case"seconds":case"second":case"secs":case"sec":case"s":return t*Pf;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function YV(r){var e=Math.abs(r);return e>=il?Math.round(r/il)+"d":e>=Df?Math.round(r/Df)+"h":e>=Rf?Math.round(r/Rf)+"m":e>=Pf?Math.round(r/Pf)+"s":r+"ms"}function QV(r){var e=Math.abs(r);return e>=il?Cg(r,e,il,"day"):e>=Df?Cg(r,e,Df,"hour"):e>=Rf?Cg(r,e,Rf,"minute"):e>=Pf?Cg(r,e,Pf,"second"):r+" ms"}function Cg(r,e,t,n){var o=e>=t*1.5;return Math.round(r/t)+" "+n+(o?"s":"")}});var eC=ht((due,_7)=>{"use strict";var aK=Object.prototype.hasOwnProperty,wn="~";function vp(){}Object.create&&(vp.prototype=Object.create(null),new vp().__proto__||(wn=!1));function cK(r,e,t){this.fn=r,this.context=e,this.once=t||!1}function J_(r,e,t,n,o){if(typeof t!="function")throw new TypeError("The listener must be a function");var i=new cK(t,n||r,o),s=wn?wn+e:e;return r._events[s]?r._events[s].fn?r._events[s]=[r._events[s],i]:r._events[s].push(i):(r._events[s]=i,r._eventsCount++),r}function kg(r,e){--r._eventsCount===0?r._events=new vp:delete r._events[e]}function tn(){this._events=new vp,this._eventsCount=0}tn.prototype.eventNames=function(){var e=[],t,n;if(this._eventsCount===0)return e;for(n in t=this._events)aK.call(t,n)&&e.push(wn?n.slice(1):n);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};tn.prototype.listeners=function(e){var t=wn?wn+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var o=0,i=n.length,s=new Array(i);o<i;o++)s[o]=n[o].fn;return s};tn.prototype.listenerCount=function(e){var t=wn?wn+e:e,n=this._events[t];return n?n.fn?1:n.length:0};tn.prototype.emit=function(e,t,n,o,i,s){var a=wn?wn+e:e;if(!this._events[a])return!1;var c=this._events[a],l=arguments.length,u,f;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),l){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,n),!0;case 4:return c.fn.call(c.context,t,n,o),!0;case 5:return c.fn.call(c.context,t,n,o,i),!0;case 6:return c.fn.call(c.context,t,n,o,i,s),!0}for(f=1,u=new Array(l-1);f<l;f++)u[f-1]=arguments[f];c.fn.apply(c.context,u)}else{var h=c.length,d;for(f=0;f<h;f++)switch(c[f].once&&this.removeListener(e,c[f].fn,void 0,!0),l){case 1:c[f].fn.call(c[f].context);break;case 2:c[f].fn.call(c[f].context,t);break;case 3:c[f].fn.call(c[f].context,t,n);break;case 4:c[f].fn.call(c[f].context,t,n,o);break;default:if(!u)for(d=1,u=new Array(l-1);d<l;d++)u[d-1]=arguments[d];c[f].fn.apply(c[f].context,u)}}return!0};tn.prototype.on=function(e,t,n){return J_(this,e,t,n,!1)};tn.prototype.once=function(e,t,n){return J_(this,e,t,n,!0)};tn.prototype.removeListener=function(e,t,n,o){var i=wn?wn+e:e;if(!this._events[i])return this;if(!t)return kg(this,i),this;var s=this._events[i];if(s.fn)s.fn===t&&(!o||s.once)&&(!n||s.context===n)&&kg(this,i);else{for(var a=0,c=[],l=s.length;a<l;a++)(s[a].fn!==t||o&&!s[a].once||n&&s[a].context!==n)&&c.push(s[a]);c.length?this._events[i]=c.length===1?c[0]:c:kg(this,i)}return this};tn.prototype.removeAllListeners=function(e){var t;return e?(t=wn?wn+e:e,this._events[t]&&kg(this,t)):(this._events=new vp,this._eventsCount=0),this};tn.prototype.off=tn.prototype.removeListener;tn.prototype.addListener=tn.prototype.on;tn.prefixed=wn;tn.EventEmitter=tn;typeof _7<"u"&&(_7.exports=tn)});var iC=ht((Lue,oC)=>{oC.exports=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function o(i,s){t[i]=s,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(i){return t[i]!==void 0||n[i]!==void 0},remove:function(i){t[i]!==void 0&&(t[i]=void 0),n[i]!==void 0&&(n[i]=void 0)},get:function(i){var s=t[i];if(s!==void 0)return s;if((s=n[i])!==void 0)return o(i,s),s},set:function(i,s){t[i]!==void 0?t[i]=s:o(i,s)},clear:function(){t=Object.create(null),n=Object.create(null)}}}});var fT=ht(zp=>{(function(){var r,e,t,n,o,i,s,a;a=function(c){var l,u,f,h;return l=(c&255<<24)>>>24,u=(c&255<<16)>>>16,f=(c&65280)>>>8,h=c&255,[l,u,f,h].join(".")},s=function(c){var l,u,f,h,d,m;for(l=[],f=h=0;h<=3&&c.length!==0;f=++h){if(f>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}m=e(c),d=m[0],u=m[1],c=c.substring(u),l.push(d)}if(c.length!==0)throw new Error("Invalid IP");switch(l.length){case 1:if(l[0]>4294967295)throw new Error("Invalid IP");return l[0]>>>0;case 2:if(l[0]>255||l[1]>16777215)throw new Error("Invalid IP");return(l[0]<<24|l[1])>>>0;case 3:if(l[0]>255||l[1]>255||l[2]>65535)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2])>>>0;case 4:if(l[0]>255||l[1]>255||l[2]>255||l[3]>255)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2]<<8|l[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),i=t("a"),o=t("A"),e=function(c){var l,u,f,h,d;for(h=0,l=10,u="9",f=0,c.length>1&&c[f]==="0"&&(c[f+1]==="x"||c[f+1]==="X"?(f+=2,l=16):"0"<=c[f+1]&&c[f+1]<="9"&&(f++,l=8,u="7")),d=f;f<c.length;){if("0"<=c[f]&&c[f]<=u)h=h*l+(t(c[f])-n)>>>0;else if(l===16)if("a"<=c[f]&&c[f]<="f")h=h*l+(10+t(c[f])-i)>>>0;else if("A"<=c[f]&&c[f]<="F")h=h*l+(10+t(c[f])-o)>>>0;else break;else break;if(h>4294967295)throw new Error("too large");f++}if(f===d)throw new Error("empty octet");return[h,f]},r=function(){function c(l,u){var f,h,d,m;if(typeof l!="string")throw new Error("Missing `net' parameter");if(u||(m=l.split("/",2),l=m[0],u=m[1]),u||(u=32),typeof u=="string"&&u.indexOf(".")>-1){try{this.maskLong=s(u)}catch(g){throw f=g,new Error("Invalid mask: "+u)}for(h=d=32;d>=0;h=--d)if(this.maskLong===4294967295<<32-h>>>0){this.bitmask=h;break}}else if(u||u===0)this.bitmask=parseInt(u,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(s(l)&this.maskLong)>>>0}catch(g){throw f=g,new Error("Invalid net address: "+l)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+u);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(l){return typeof l=="string"&&(l.indexOf("/")>0||l.split(".").length!==4)&&(l=new c(l)),l instanceof c?this.contains(l.base)&&this.contains(l.broadcast||l.last):(s(l)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(l){return l==null&&(l=1),new c(a(this.netLong+this.size*l),this.mask)},c.prototype.forEach=function(l){var u,f,h;for(h=s(this.first),f=s(this.last),u=0;h<=f;)l(a(h),h,u),u++,h++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),zp.ip2long=s,zp.long2ip=a,zp.Netmask=r}).call(zp)});var j2=ht((h0e,Ox)=>{var d0e=function(){typeof Ox<"u"&&(Ox.exports=g);var r=86400,e=3200,t=146097*e/400,n=r*t,o=1e3*n,i=864e13,s=4294967296,a=1e6,c="000000000",l=Math.trunc||function(P){var E=P-P%1;return E==0&&(P<0||P===0&&1/P!=1/0)?-0:E},u=g.prototype,f=(g.fromDate=function(P){return new g(+P)},g.fromInt64BE=S(0,1,2,3,0,4),g.fromInt64LE=S(3,2,1,0,4,0),g.fromString=function(C){var E,D=new g,C=(C+="").replace(/^\s*[+\-]?\d+/,function(T){var T=+T,V=1970+(T-1970)%400;return D.year=T-V,V}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(R,T,V){return T<0&&(V*=-1),E=6e4*(60*+T+ +V),""}).replace(/\.\d+$/,function(R){return D.nano=+(R+c).substr(1,9),""}).split(/\D+/);if(1<C.length?C[1]--:C[1]=0,D.time=E=Date.UTC.apply(Date,C)-(E||0),isNaN(E))throw new TypeError("Invalid Date");return w(D)},g.fromTimeT=function(P){return v(P,0)},u.year=0,u.time=0,u.nano=0,u.addNano=function(P){return this.nano+=+P||0,this},u.getNano=function(){var P=w(this);return(P.time%1e3*a+ +P.nano+1e9)%1e9},u.getTimeT=function(){var E=w(this),P=Math.floor(E.time/1e3),E=E.year;return E&&(P+=E*t*r/e),P},u.getYear=function(){return this.toDate().getUTCFullYear()+this.year},u.toDate=function(){return x(w(this).time)},u.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},u.toString=function(P){var E=this,D=E.toDate(),C={H:function(){return U(D.getUTCHours())},L:function(){return k(D.getUTCMilliseconds(),3)},M:function(){return U(D.getUTCMinutes())},N:function(){return k(E.getNano(),9)},S:function(){return U(D.getUTCSeconds())},Y:function(){var R=E.getYear();return 999999<R?"+"+R:9999<R?"+"+k(R,6):0<=R?k(R,4):-999999<=R?"-"+k(-R,6):R},a:function(){return d[D.getUTCDay()]},b:function(){return h[D.getUTCMonth()]},d:function(){return U(D.getUTCDate())},e:function(){return function(R){return(9<R?"":" ")+(0|R)}(D.getUTCDate())},m:function(){return U(D.getUTCMonth()+1)}};return function R(T){return T.replace(/%./g,function(V){var H=V[1],F=m[H],H=C[H];return F?R(F):H?H():V})}(P||f)},u.writeInt64BE=A(0,1,2,3,0,4),u.writeInt64LE=A(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),h=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],d=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],m={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return g;function g(P,E,D){var C=this;if(!(C instanceof g))return new g(P,E,D);C.time=+P||0,C.nano=+E||0,C.year=+D||0,w(C)}function w(P){var E,D,C,R=P.year,T=P.time,V=P.nano,F=((V<0||a<=V)&&(V-=(D=Math.floor(V/a))*a,T+=D,D=1),R%e);return(T<-i||i<T||F)&&((E=l(T/o))&&(R+=E*e,T-=E*o),(C=x(T)).setUTCFullYear(F+C.getUTCFullYear()),C=(T=+C)+(E=l((R-=F)/e))*o,E&&-i<=C&&C<=i&&(R-=E*e,T=C),D=1),D&&(P.year=R,P.time=T,P.nano=V),P}function x(P){var E=new Date(0);return E.setTime(P),E}function v(R,C){R=+R||0;var D=l((C=(C|0)*s)/n)+l(R/n),C=C%n+R%n,R=l(C/n);return R&&(D+=R,C-=R*n),new g(1e3*C,0,D*e)}function A(P,E,D,C,R,T){return function(F,H){var Q=w(this);F=F||new Array(8),_(F,H|=0);var X=Math.floor(Q.time/1e3),Q=Q.year*(t*r/e),Y=l(Q/s)+l(X/s),Q=Q%s+X%s,X=Math.floor(Q/s);return X&&(Y+=X,Q-=X*s),V(F,H+R,Y),V(F,H+T,Q),F};function V(F,H,Y){F[H+P]=Y>>24&255,F[H+E]=Y>>16&255,F[H+D]=Y>>8&255,F[H+C]=255&Y}}function S(P,E,D,C,R,T){return function(F,H){_(F,H|=0);var Y=V(F,H+R);return v(V(F,H+T),Y)};function V(F,H){return 16777216*F[H+P]+(F[H+E]<<16|F[H+D]<<8|F[H+C])}}function _(P,E){if(P=P&&P.length,P==null)throw new TypeError("Invalid Buffer");if(P<E+8)throw new RangeError("Out of range")}function U(P){return(9<P?"":"0")+(0|P)}function k(P,E){return(c+(0|P)).substr(-E)}}()});var QT=ht((Lye,YT)=>{"use strict";function Ij(r){return r>=55296&&r<=56319}function Tj(r){return r>=56320&&r<=57343}YT.exports=function(e,t,n){if(typeof t!="string")throw new Error("Input must be string");for(var o=t.length,i=0,s,a,c=0;c<o;c+=1){if(s=t.charCodeAt(c),a=t[c],Ij(s)&&Tj(t.charCodeAt(c+1))&&(c+=1,a+=t[c]),i+=e(a),i===n)return t.slice(0,c+1);if(i>n)return t.slice(0,c-a.length+1)}return t}});var JT=ht((Bye,ZT)=>{"use strict";function kj(r){return r>=55296&&r<=56319}function Pj(r){return r>=56320&&r<=57343}ZT.exports=function(e){if(typeof e!="string")throw new Error("Input must be string");for(var t=e.length,n=0,o=null,i=null,s=0;s<t;s++)o=e.charCodeAt(s),Pj(o)?i!=null&&kj(i)?n+=1:n+=3:o<=127?n+=1:o>=128&&o<=2047?n+=2:o>=2048&&o<=65535&&(n+=3),i=o;return n}});var tk=ht((Mye,ek)=>{"use strict";var Rj=QT(),Dj=JT();ek.exports=Rj.bind(null,Dj)});var ok=ht((Uye,nk)=>{"use strict";var Nj=tk(),Oj=/[\/\?<>\\:\*\|"]/g,Lj=/[\x00-\x1f\x80-\x9f]/g,Bj=/^\.+$/,Mj=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,Uj=/[\. ]+$/;function rk(r,e){if(typeof r!="string")throw new Error("Input must be string");var t=r.replace(Oj,e).replace(Lj,e).replace(Bj,e).replace(Mj,e).replace(Uj,e);return Nj(t,255)}nk.exports=function(r,e){var t=e&&e.replacement||"",n=rk(r,t);return t===""?n:rk(n,"")}});var qs=ht(ad=>{"use strict";var Hj="[object ArrayBuffer]",zs=class r{static isArrayBuffer(e){return Object.prototype.toString.call(e)===Hj}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){let n=r.toUint8Array(e),o=r.toUint8Array(t);if(n.length!==o.byteLength)return!1;for(let i=0;i<n.length;i++)if(n[i]!==o[i])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let n=0;for(let s of t)n+=s.byteLength;let o=new Uint8Array(n),i=0;for(let s of t){let a=this.toUint8Array(s);o.set(a,i),i+=a.length}return e[e.length-1]instanceof Function?this.toView(o,e[e.length-1]):o.buffer}},jx="string",$j=/^[0-9a-f\s]+$/i,Vj=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,Kj=/^[a-zA-Z0-9-_]+$/,fy=class{static fromString(e){let t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length);for(let o=0;o<t.length;o++)n[o]=t.charCodeAt(o);return n.buffer}static toString(e){let t=zs.toUint8Array(e),n="";for(let i=0;i<t.length;i++)n+=String.fromCharCode(t[i]);return decodeURIComponent(escape(n))}},Po=class{static toString(e,t=!1){let n=zs.toArrayBuffer(e),o=new DataView(n),i="";for(let s=0;s<n.byteLength;s+=2){let a=o.getUint16(s,t);i+=String.fromCharCode(a)}return i}static fromString(e,t=!1){let n=new ArrayBuffer(e.length*2),o=new DataView(n);for(let i=0;i<e.length;i++)o.setUint16(i*2,e.charCodeAt(i),t);return n}},dy=class r{static isHex(e){return typeof e===jx&&$j.test(e)}static isBase64(e){return typeof e===jx&&Vj.test(e)}static isBase64Url(e){return typeof e===jx&&Kj.test(e)}static ToString(e,t="utf8"){let n=zs.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(n);case"binary":return this.ToBinary(n);case"hex":return this.ToHex(n);case"base64":return this.ToBase64(n);case"base64url":return this.ToBase64Url(n);case"utf16le":return Po.toString(n,!0);case"utf16":case"utf16be":return Po.toString(n);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return Po.fromString(e,!0);case"utf16":case"utf16be":return Po.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){let t=zs.toUint8Array(e);if(typeof btoa<"u"){let n=this.ToString(t,"binary");return btoa(n)}else return __Buffer$.from(t).toString("base64")}static FromBase64(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(__Buffer$.from(t,"base64")).buffer}static FromBase64Url(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=r.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return fy.fromString(e);case"utf16":case"utf16be":return Po.fromString(e);case"utf16le":case"usc2":return Po.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=r.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return fy.toString(e);case"utf16":case"utf16be":return Po.toString(e);case"utf16le":case"usc2":return Po.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){let t=e.length,n=new Uint8Array(t);for(let o=0;o<t;o++)n[o]=e.charCodeAt(o);return n.buffer}static ToBinary(e){let t=zs.toUint8Array(e),n="";for(let o=0;o<t.length;o++)n+=String.fromCharCode(t[o]);return n}static ToHex(e){let t=zs.toUint8Array(e),n="",o=t.length;for(let i=0;i<o;i++){let s=t[i];s<16&&(n+="0"),n+=s.toString(16)}return n}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);let n=new Uint8Array(t.length/2);for(let o=0;o<t.length;o=o+2){let i=t.slice(o,o+2);n[o/2]=parseInt(i,16)}return n.buffer}static ToUtf16String(e,t=!1){return Po.toString(e,t)}static FromUtf16String(e,t=!1){return Po.fromString(e,t)}static Base64Padding(e){let t=4-e.length%4;if(t<4)for(let n=0;n<t;n++)e+="=";return e}static formatString(e){return e?.replace(/[\n\r\t ]/g,"")||""}};dy.DEFAULT_UTF8_ENCODING="utf8";function zj(r,...e){let t=arguments[0];for(let n=1;n<arguments.length;n++){let o=arguments[n];for(let i in o)t[i]=o[i]}return t}function qj(...r){let e=r.map(o=>o.byteLength).reduce((o,i)=>o+i),t=new Uint8Array(e),n=0;return r.map(o=>new Uint8Array(o)).forEach(o=>{for(let i of o)t[n++]=i}),t.buffer}function jj(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;let t=new Uint8Array(r),n=new Uint8Array(e);for(let o=0;o<r.byteLength;o++)if(t[o]!==n[o])return!1;return!0}ad.BufferSourceConverter=zs;ad.Convert=dy;ad.assign=zj;ad.combine=qj;ad.isEqual=jj});var TP=ht((H5e,IP)=>{function Oo(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}IP.exports=Oo;Oo.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};Oo.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};Oo.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},t),this._options.unref&&this._timer.unref(),!0};Oo.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};Oo.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};Oo.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};Oo.prototype.start=Oo.prototype.try;Oo.prototype.errors=function(){return this._errors};Oo.prototype.attempts=function(){return this._attempts};Oo.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,n=0;n<this._errors.length;n++){var o=this._errors[n],i=o.message,s=(r[i]||0)+1;r[i]=s,s>=t&&(e=o,t=s)}return e}});var kP=ht(Kl=>{var nG=TP();Kl.operation=function(r){var e=Kl.timeouts(r);return new nG(e,{forever:r&&(r.forever||r.retries===1/0),unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})};Kl.timeouts=function(r){if(r instanceof Array)return[].concat(r);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var t in r)e[t]=r[t];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var n=[],o=0;o<e.retries;o++)n.push(this.createTimeout(o,e));return r&&r.forever&&!n.length&&n.push(this.createTimeout(o,e)),n.sort(function(i,s){return i-s}),n};Kl.createTimeout=function(r,e){var t=e.randomize?Math.random()+1:1,n=Math.round(t*Math.max(e.minTimeout,1)*Math.pow(e.factor,r));return n=Math.min(n,e.maxTimeout),n};Kl.wrap=function(r,e,t){if(e instanceof Array&&(t=e,e=null),!t){t=[];for(var n in r)typeof r[n]=="function"&&t.push(n)}for(var o=0;o<t.length;o++){var i=t[o],s=r[i];r[i]=function(c){var l=Kl.operation(e),u=Array.prototype.slice.call(arguments,1),f=u.pop();u.push(function(h){l.retry(h)||(h&&(arguments[0]=l.mainError()),f.apply(this,arguments))}),l.attempt(function(){c.apply(r,u)})}.bind(r,s),r[i].options=e}}});var RP=ht((V5e,PP)=>{PP.exports=kP()});var TN=ht(()=>{var IN;(function(r){(function(e){var t=typeof globalThis=="object"||typeof globalThis=="object"?globalThis:typeof self=="object"?self:typeof this=="object"?this:a(),n=o(r);typeof t.Reflect<"u"&&(n=o(t.Reflect,n)),e(n,t),typeof t.Reflect>"u"&&(t.Reflect=r);function o(c,l){return function(u,f){Object.defineProperty(c,u,{configurable:!0,writable:!0,value:f}),l&&l(u,f)}}function i(){try{return Function("return this;")()}catch{}}function s(){try{return(0,eval)("(function() { return this; })()")}catch{}}function a(){return i()||s()}})(function(e,t){var n=Object.prototype.hasOwnProperty,o=typeof Symbol=="function",i=o&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",s=o&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",a=typeof Object.create=="function",c={__proto__:[]}instanceof Array,l=!a&&!c,u={create:a?function(){return U8(Object.create(null))}:c?function(){return U8({__proto__:null})}:function(){return U8({})},has:l?function(N,B){return n.call(N,B)}:function(N,B){return B in N},get:l?function(N,B){return n.call(N,B)?N[B]:void 0}:function(N,B){return N[B]}},f=Object.getPrototypeOf(Function),h=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:uF(),d=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:fF(),m=typeof WeakMap=="function"?WeakMap:dF(),g=o?Symbol.for("@reflect-metadata:registry"):void 0,w=aF(),x=cF(w);function v(N,B,z,ee){if(G(z)){if(!un(N))throw new TypeError;if(!Dh(B))throw new TypeError;return R(N,B)}else{if(!un(N))throw new TypeError;if(!ue(B))throw new TypeError;if(!ue(ee)&&!G(ee)&&!Te(ee))throw new TypeError;return Te(ee)&&(ee=void 0),z=pr(z),T(N,B,z,ee)}}e("decorate",v);function A(N,B){function z(ee,Ee){if(!ue(ee))throw new TypeError;if(!G(Ee)&&!iF(Ee))throw new TypeError;Q(N,B,ee,Ee)}return z}e("metadata",A);function S(N,B,z,ee){if(!ue(z))throw new TypeError;return G(ee)||(ee=pr(ee)),Q(N,B,z,ee)}e("defineMetadata",S);function _(N,B,z){if(!ue(B))throw new TypeError;return G(z)||(z=pr(z)),V(N,B,z)}e("hasMetadata",_);function U(N,B,z){if(!ue(B))throw new TypeError;return G(z)||(z=pr(z)),F(N,B,z)}e("hasOwnMetadata",U);function k(N,B,z){if(!ue(B))throw new TypeError;return G(z)||(z=pr(z)),H(N,B,z)}e("getMetadata",k);function P(N,B,z){if(!ue(B))throw new TypeError;return G(z)||(z=pr(z)),Y(N,B,z)}e("getOwnMetadata",P);function E(N,B){if(!ue(N))throw new TypeError;return G(B)||(B=pr(B)),X(N,B)}e("getMetadataKeys",E);function D(N,B){if(!ue(N))throw new TypeError;return G(B)||(B=pr(B)),me(N,B)}e("getOwnMetadataKeys",D);function C(N,B,z){if(!ue(B))throw new TypeError;if(G(z)||(z=pr(z)),!ue(B))throw new TypeError;G(z)||(z=pr(z));var ee=Nh(B,z,!1);return G(ee)?!1:ee.OrdinaryDeleteMetadata(N,B,z)}e("deleteMetadata",C);function R(N,B){for(var z=N.length-1;z>=0;--z){var ee=N[z],Ee=ee(B);if(!G(Ee)&&!Te(Ee)){if(!Dh(Ee))throw new TypeError;B=Ee}}return B}function T(N,B,z,ee){for(var Ee=N.length-1;Ee>=0;--Ee){var Gt=N[Ee],mr=Gt(B,z,ee);if(!G(mr)&&!Te(mr)){if(!ue(mr))throw new TypeError;ee=mr}}return ee}function V(N,B,z){var ee=F(N,B,z);if(ee)return!0;var Ee=M8(B);return Te(Ee)?!1:V(N,Ee,z)}function F(N,B,z){var ee=Nh(B,z,!1);return G(ee)?!1:Bt(ee.OrdinaryHasOwnMetadata(N,B,z))}function H(N,B,z){var ee=F(N,B,z);if(ee)return Y(N,B,z);var Ee=M8(B);if(!Te(Ee))return H(N,Ee,z)}function Y(N,B,z){var ee=Nh(B,z,!1);if(!G(ee))return ee.OrdinaryGetOwnMetadata(N,B,z)}function Q(N,B,z,ee){var Ee=Nh(z,ee,!0);Ee.OrdinaryDefineOwnMetadata(N,B,z,ee)}function X(N,B){var z=me(N,B),ee=M8(N);if(ee===null)return z;var Ee=X(ee,B);if(Ee.length<=0)return z;if(z.length<=0)return Ee;for(var Gt=new d,mr=[],Ue=0,ie=z;Ue<ie.length;Ue++){var ce=ie[Ue],fe=Gt.has(ce);fe||(Gt.add(ce),mr.push(ce))}for(var ge=0,He=Ee;ge<He.length;ge++){var ce=He[ge],fe=Gt.has(ce);fe||(Gt.add(ce),mr.push(ce))}return mr}function me(N,B){var z=Nh(N,B,!1);return z?z.OrdinaryOwnMetadataKeys(N,B):[]}function oe(N){if(N===null)return 1;switch(typeof N){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return N===null?1:6;default:return 6}}function G(N){return N===void 0}function Te(N){return N===null}function et(N){return typeof N=="symbol"}function ue(N){return typeof N=="object"?N!==null:typeof N=="function"}function it(N,B){switch(oe(N)){case 0:return N;case 1:return N;case 2:return N;case 3:return N;case 4:return N;case 5:return N}var z=B===3?"string":B===5?"number":"default",ee=yE(N,i);if(ee!==void 0){var Ee=ee.call(N,z);if(ue(Ee))throw new TypeError;return Ee}return rr(N,z==="default"?"number":z)}function rr(N,B){if(B==="string"){var z=N.toString;if(gs(z)){var ee=z.call(N);if(!ue(ee))return ee}var Ee=N.valueOf;if(gs(Ee)){var ee=Ee.call(N);if(!ue(ee))return ee}}else{var Ee=N.valueOf;if(gs(Ee)){var ee=Ee.call(N);if(!ue(ee))return ee}var Gt=N.toString;if(gs(Gt)){var ee=Gt.call(N);if(!ue(ee))return ee}}throw new TypeError}function Bt(N){return!!N}function Mt(N){return""+N}function pr(N){var B=it(N,3);return et(B)?B:Mt(B)}function un(N){return Array.isArray?Array.isArray(N):N instanceof Object?N instanceof Array:Object.prototype.toString.call(N)==="[object Array]"}function gs(N){return typeof N=="function"}function Dh(N){return typeof N=="function"}function iF(N){switch(oe(N)){case 3:return!0;case 4:return!0;default:return!1}}function B8(N,B){return N===B||N!==N&&B!==B}function yE(N,B){var z=N[B];if(z!=null){if(!gs(z))throw new TypeError;return z}}function wE(N){var B=yE(N,s);if(!gs(B))throw new TypeError;var z=B.call(N);if(!ue(z))throw new TypeError;return z}function xE(N){return N.value}function bE(N){var B=N.next();return B.done?!1:B}function vE(N){var B=N.return;B&&B.call(N)}function M8(N){var B=Object.getPrototypeOf(N);if(typeof N!="function"||N===f||B!==f)return B;var z=N.prototype,ee=z&&Object.getPrototypeOf(z);if(ee==null||ee===Object.prototype)return B;var Ee=ee.constructor;return typeof Ee!="function"||Ee===N?B:Ee}function sF(){var N;!G(g)&&typeof t.Reflect<"u"&&!(g in t.Reflect)&&typeof t.Reflect.defineMetadata=="function"&&(N=lF(t.Reflect));var B,z,ee,Ee=new m,Gt={registerProvider:mr,getProvider:ie,setProvider:fe};return Gt;function mr(ge){if(!Object.isExtensible(Gt))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case N===ge:break;case G(B):B=ge;break;case B===ge:break;case G(z):z=ge;break;case z===ge:break;default:ee===void 0&&(ee=new d),ee.add(ge);break}}function Ue(ge,He){if(!G(B)){if(B.isProviderFor(ge,He))return B;if(!G(z)){if(z.isProviderFor(ge,He))return B;if(!G(ee))for(var Et=wE(ee);;){var Xt=bE(Et);if(!Xt)return;var Go=xE(Xt);if(Go.isProviderFor(ge,He))return vE(Et),Go}}}if(!G(N)&&N.isProviderFor(ge,He))return N}function ie(ge,He){var Et=Ee.get(ge),Xt;return G(Et)||(Xt=Et.get(He)),G(Xt)&&(Xt=Ue(ge,He),G(Xt)||(G(Et)&&(Et=new h,Ee.set(ge,Et)),Et.set(He,Xt))),Xt}function ce(ge){if(G(ge))throw new TypeError;return B===ge||z===ge||!G(ee)&&ee.has(ge)}function fe(ge,He,Et){if(!ce(Et))throw new Error("Metadata provider not registered.");var Xt=ie(ge,He);if(Xt!==Et){if(!G(Xt))return!1;var Go=Ee.get(ge);G(Go)&&(Go=new h,Ee.set(ge,Go)),Go.set(He,Et)}return!0}}function aF(){var N;return!G(g)&&ue(t.Reflect)&&Object.isExtensible(t.Reflect)&&(N=t.Reflect[g]),G(N)&&(N=sF()),!G(g)&&ue(t.Reflect)&&Object.isExtensible(t.Reflect)&&Object.defineProperty(t.Reflect,g,{enumerable:!1,configurable:!1,writable:!1,value:N}),N}function cF(N){var B=new m,z={isProviderFor:function(ce,fe){var ge=B.get(ce);return G(ge)?!1:ge.has(fe)},OrdinaryDefineOwnMetadata:mr,OrdinaryHasOwnMetadata:Ee,OrdinaryGetOwnMetadata:Gt,OrdinaryOwnMetadataKeys:Ue,OrdinaryDeleteMetadata:ie};return w.registerProvider(z),z;function ee(ce,fe,ge){var He=B.get(ce),Et=!1;if(G(He)){if(!ge)return;He=new h,B.set(ce,He),Et=!0}var Xt=He.get(fe);if(G(Xt)){if(!ge)return;if(Xt=new h,He.set(fe,Xt),!N.setProvider(ce,fe,z))throw He.delete(fe),Et&&B.delete(ce),new Error("Wrong provider for target.")}return Xt}function Ee(ce,fe,ge){var He=ee(fe,ge,!1);return G(He)?!1:Bt(He.has(ce))}function Gt(ce,fe,ge){var He=ee(fe,ge,!1);if(!G(He))return He.get(ce)}function mr(ce,fe,ge,He){var Et=ee(ge,He,!0);Et.set(ce,fe)}function Ue(ce,fe){var ge=[],He=ee(ce,fe,!1);if(G(He))return ge;for(var Et=He.keys(),Xt=wE(Et),Go=0;;){var AE=bE(Xt);if(!AE)return ge.length=Go,ge;var hF=xE(AE);try{ge[Go]=hF}catch(pF){try{vE(Xt)}finally{throw pF}}Go++}}function ie(ce,fe,ge){var He=ee(fe,ge,!1);if(G(He)||!He.delete(ce))return!1;if(He.size===0){var Et=B.get(fe);G(Et)||(Et.delete(ge),Et.size===0&&B.delete(Et))}return!0}}function lF(N){var B=N.defineMetadata,z=N.hasOwnMetadata,ee=N.getOwnMetadata,Ee=N.getOwnMetadataKeys,Gt=N.deleteMetadata,mr=new m,Ue={isProviderFor:function(ie,ce){var fe=mr.get(ie);return!G(fe)&&fe.has(ce)?!0:Ee(ie,ce).length?(G(fe)&&(fe=new d,mr.set(ie,fe)),fe.add(ce),!0):!1},OrdinaryDefineOwnMetadata:B,OrdinaryHasOwnMetadata:z,OrdinaryGetOwnMetadata:ee,OrdinaryOwnMetadataKeys:Ee,OrdinaryDeleteMetadata:Gt};return Ue}function Nh(N,B,z){var ee=w.getProvider(N,B);if(!G(ee))return ee;if(z){if(w.setProvider(N,B,x))return x;throw new Error("Illegal state.")}}function uF(){var N={},B=[],z=function(){function Ue(ie,ce,fe){this._index=0,this._keys=ie,this._values=ce,this._selector=fe}return Ue.prototype["@@iterator"]=function(){return this},Ue.prototype[s]=function(){return this},Ue.prototype.next=function(){var ie=this._index;if(ie>=0&&ie<this._keys.length){var ce=this._selector(this._keys[ie],this._values[ie]);return ie+1>=this._keys.length?(this._index=-1,this._keys=B,this._values=B):this._index++,{value:ce,done:!1}}return{value:void 0,done:!0}},Ue.prototype.throw=function(ie){throw this._index>=0&&(this._index=-1,this._keys=B,this._values=B),ie},Ue.prototype.return=function(ie){return this._index>=0&&(this._index=-1,this._keys=B,this._values=B),{value:ie,done:!0}},Ue}(),ee=function(){function Ue(){this._keys=[],this._values=[],this._cacheKey=N,this._cacheIndex=-2}return Object.defineProperty(Ue.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),Ue.prototype.has=function(ie){return this._find(ie,!1)>=0},Ue.prototype.get=function(ie){var ce=this._find(ie,!1);return ce>=0?this._values[ce]:void 0},Ue.prototype.set=function(ie,ce){var fe=this._find(ie,!0);return this._values[fe]=ce,this},Ue.prototype.delete=function(ie){var ce=this._find(ie,!1);if(ce>=0){for(var fe=this._keys.length,ge=ce+1;ge<fe;ge++)this._keys[ge-1]=this._keys[ge],this._values[ge-1]=this._values[ge];return this._keys.length--,this._values.length--,B8(ie,this._cacheKey)&&(this._cacheKey=N,this._cacheIndex=-2),!0}return!1},Ue.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=N,this._cacheIndex=-2},Ue.prototype.keys=function(){return new z(this._keys,this._values,Ee)},Ue.prototype.values=function(){return new z(this._keys,this._values,Gt)},Ue.prototype.entries=function(){return new z(this._keys,this._values,mr)},Ue.prototype["@@iterator"]=function(){return this.entries()},Ue.prototype[s]=function(){return this.entries()},Ue.prototype._find=function(ie,ce){if(!B8(this._cacheKey,ie)){this._cacheIndex=-1;for(var fe=0;fe<this._keys.length;fe++)if(B8(this._keys[fe],ie)){this._cacheIndex=fe;break}}return this._cacheIndex<0&&ce&&(this._cacheIndex=this._keys.length,this._keys.push(ie),this._values.push(void 0)),this._cacheIndex},Ue}();return ee;function Ee(Ue,ie){return Ue}function Gt(Ue,ie){return ie}function mr(Ue,ie){return[Ue,ie]}}function fF(){var N=function(){function B(){this._map=new h}return Object.defineProperty(B.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),B.prototype.has=function(z){return this._map.has(z)},B.prototype.add=function(z){return this._map.set(z,z),this},B.prototype.delete=function(z){return this._map.delete(z)},B.prototype.clear=function(){this._map.clear()},B.prototype.keys=function(){return this._map.keys()},B.prototype.values=function(){return this._map.keys()},B.prototype.entries=function(){return this._map.entries()},B.prototype["@@iterator"]=function(){return this.keys()},B.prototype[s]=function(){return this.keys()},B}();return N}function dF(){var N=16,B=u.create(),z=ee();return function(){function ie(){this._key=ee()}return ie.prototype.has=function(ce){var fe=Ee(ce,!1);return fe!==void 0?u.has(fe,this._key):!1},ie.prototype.get=function(ce){var fe=Ee(ce,!1);return fe!==void 0?u.get(fe,this._key):void 0},ie.prototype.set=function(ce,fe){var ge=Ee(ce,!0);return ge[this._key]=fe,this},ie.prototype.delete=function(ce){var fe=Ee(ce,!1);return fe!==void 0?delete fe[this._key]:!1},ie.prototype.clear=function(){this._key=ee()},ie}();function ee(){var ie;do ie="@@WeakMap@@"+Ue();while(u.has(B,ie));return B[ie]=!0,ie}function Ee(ie,ce){if(!n.call(ie,z)){if(!ce)return;Object.defineProperty(ie,z,{value:u.create()})}return ie[z]}function Gt(ie,ce){for(var fe=0;fe<ce;++fe)ie[fe]=Math.random()*255|0;return ie}function mr(ie){if(typeof Uint8Array=="function"){var ce=new Uint8Array(ie);return typeof crypto<"u"?crypto.getRandomValues(ce):typeof msCrypto<"u"?msCrypto.getRandomValues(ce):Gt(ce,ie),ce}return Gt(new Array(ie),ie)}function Ue(){var ie=mr(N);ie[6]=ie[6]&79|64,ie[8]=ie[8]&191|128;for(var ce="",fe=0;fe<N;++fe){var ge=ie[fe];(fe===4||fe===6||fe===8)&&(ce+="-"),ge<16&&(ce+="0"),ce+=ge.toString(16).toLowerCase()}return ce}}function U8(N){return N.__=void 0,delete N.__,N}})})(IN||(IN={}))});var WL=ht(f5=>{"use strict";Object.defineProperty(f5,"__esModule",{value:!0});var _A=class{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;let t={value:e,done:!1};if(this.pullQueue.length){let n=this.pullQueue.shift();n&&n.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(let e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(let t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{let t=Promise.reject(e);t.catch(()=>{}),this.pushQueue.push(t)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:e=>{let t=this.pushQueue.shift();return t?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((n,o)=>{this.pullQueue.push({resolve:n,reject:o})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}},u5=class{constructor(e,{highWaterMark:t=100,lowWaterMark:n=1}={}){let o=new _A;o.highWaterMark=t,o.lowWaterMark=n,o.removeCallback=e({push:i=>o.push(i),stop:()=>o.stop(),fail:i=>o.fail(i),on:(i,s)=>{o.eventHandlers[i]=s}})||(()=>{}),this[Symbol.asyncIterator]=()=>o[Symbol.asyncIterator](),Object.freeze(this)}};f5.EventIterator=u5;f5.default=u5});var GL=ht(G1=>{"use strict";Object.defineProperty(G1,"__esModule",{value:!0});var CA=WL();G1.EventIterator=CA.EventIterator;function DQ(r,e,t){return new CA.EventIterator(({push:n})=>(this.addEventListener(r,n,e),()=>this.removeEventListener(r,n,e)),t)}G1.subscribe=DQ;G1.default=CA.EventIterator});var TB=ht((JXe,IB)=>{IB.exports=LA;var CB=128,zQ=127,qQ=~zQ,jQ=Math.pow(2,31);function LA(r,e,t){if(Number.MAX_SAFE_INTEGER&&r>Number.MAX_SAFE_INTEGER)throw LA.bytes=0,new RangeError("Could not encode varint");e=e||[],t=t||0;for(var n=t;r>=jQ;)e[t++]=r&255|CB,r/=128;for(;r&qQ;)e[t++]=r&255|CB,r>>>=7;return e[t]=r|0,LA.bytes=t-n+1,e}});var RB=ht((eYe,PB)=>{PB.exports=BA;var WQ=128,kB=127;function BA(r,n){var t=0,n=n||0,o=0,i=n,s,a=r.length;do{if(i>=a||o>49)throw BA.bytes=0,new RangeError("Could not decode varint");s=r[i++],t+=o<28?(s&kB)<<o:(s&kB)*Math.pow(2,o),o+=7}while(s>=WQ);return BA.bytes=i-n,t}});var NB=ht((tYe,DB)=>{var GQ=Math.pow(2,7),XQ=Math.pow(2,14),YQ=Math.pow(2,21),QQ=Math.pow(2,28),ZQ=Math.pow(2,35),JQ=Math.pow(2,42),eZ=Math.pow(2,49),tZ=Math.pow(2,56),rZ=Math.pow(2,63);DB.exports=function(r){return r<GQ?1:r<XQ?2:r<YQ?3:r<QQ?4:r<ZQ?5:r<JQ?6:r<eZ?7:r<tZ?8:r<rZ?9:10}});var k5=ht((rYe,OB)=>{OB.exports={encode:TB(),decode:RB(),encodingLength:NB()}});var JB=ht((i0,j5)=>{(function(r,e){"use strict";var t={version:"3.0.0",x86:{},x64:{},inputValidation:!0};function n(d){if(!Array.isArray(d)&&!ArrayBuffer.isView(d))return!1;for(var m=0;m<d.length;m++)if(!Number.isInteger(d[m])||d[m]<0||d[m]>255)return!1;return!0}function o(d,m){return(d&65535)*m+(((d>>>16)*m&65535)<<16)}function i(d,m){return d<<m|d>>>32-m}function s(d){return d^=d>>>16,d=o(d,2246822507),d^=d>>>13,d=o(d,3266489909),d^=d>>>16,d}function a(d,m){d=[d[0]>>>16,d[0]&65535,d[1]>>>16,d[1]&65535],m=[m[0]>>>16,m[0]&65535,m[1]>>>16,m[1]&65535];var g=[0,0,0,0];return g[3]+=d[3]+m[3],g[2]+=g[3]>>>16,g[3]&=65535,g[2]+=d[2]+m[2],g[1]+=g[2]>>>16,g[2]&=65535,g[1]+=d[1]+m[1],g[0]+=g[1]>>>16,g[1]&=65535,g[0]+=d[0]+m[0],g[0]&=65535,[g[0]<<16|g[1],g[2]<<16|g[3]]}function c(d,m){d=[d[0]>>>16,d[0]&65535,d[1]>>>16,d[1]&65535],m=[m[0]>>>16,m[0]&65535,m[1]>>>16,m[1]&65535];var g=[0,0,0,0];return g[3]+=d[3]*m[3],g[2]+=g[3]>>>16,g[3]&=65535,g[2]+=d[2]*m[3],g[1]+=g[2]>>>16,g[2]&=65535,g[2]+=d[3]*m[2],g[1]+=g[2]>>>16,g[2]&=65535,g[1]+=d[1]*m[3],g[0]+=g[1]>>>16,g[1]&=65535,g[1]+=d[2]*m[2],g[0]+=g[1]>>>16,g[1]&=65535,g[1]+=d[3]*m[1],g[0]+=g[1]>>>16,g[1]&=65535,g[0]+=d[0]*m[3]+d[1]*m[2]+d[2]*m[1]+d[3]*m[0],g[0]&=65535,[g[0]<<16|g[1],g[2]<<16|g[3]]}function l(d,m){return m%=64,m===32?[d[1],d[0]]:m<32?[d[0]<<m|d[1]>>>32-m,d[1]<<m|d[0]>>>32-m]:(m-=32,[d[1]<<m|d[0]>>>32-m,d[0]<<m|d[1]>>>32-m])}function u(d,m){return m%=64,m===0?d:m<32?[d[0]<<m|d[1]>>>32-m,d[1]<<m]:[d[1]<<m-32,0]}function f(d,m){return[d[0]^m[0],d[1]^m[1]]}function h(d){return d=f(d,[0,d[0]>>>1]),d=c(d,[4283543511,3981806797]),d=f(d,[0,d[0]>>>1]),d=c(d,[3301882366,444984403]),d=f(d,[0,d[0]>>>1]),d}t.x86.hash32=function(d,m){if(t.inputValidation&&!n(d))return e;m=m||0;for(var g=d.length%4,w=d.length-g,x=m,v=0,A=3432918353,S=461845907,_=0;_<w;_=_+4)v=d[_]|d[_+1]<<8|d[_+2]<<16|d[_+3]<<24,v=o(v,A),v=i(v,15),v=o(v,S),x^=v,x=i(x,13),x=o(x,5)+3864292196;switch(v=0,g){case 3:v^=d[_+2]<<16;case 2:v^=d[_+1]<<8;case 1:v^=d[_],v=o(v,A),v=i(v,15),v=o(v,S),x^=v}return x^=d.length,x=s(x),x>>>0},t.x86.hash128=function(d,m){if(t.inputValidation&&!n(d))return e;m=m||0;for(var g=d.length%16,w=d.length-g,x=m,v=m,A=m,S=m,_=0,U=0,k=0,P=0,E=597399067,D=2869860233,C=951274213,R=2716044179,T=0;T<w;T=T+16)_=d[T]|d[T+1]<<8|d[T+2]<<16|d[T+3]<<24,U=d[T+4]|d[T+5]<<8|d[T+6]<<16|d[T+7]<<24,k=d[T+8]|d[T+9]<<8|d[T+10]<<16|d[T+11]<<24,P=d[T+12]|d[T+13]<<8|d[T+14]<<16|d[T+15]<<24,_=o(_,E),_=i(_,15),_=o(_,D),x^=_,x=i(x,19),x+=v,x=o(x,5)+1444728091,U=o(U,D),U=i(U,16),U=o(U,C),v^=U,v=i(v,17),v+=A,v=o(v,5)+197830471,k=o(k,C),k=i(k,17),k=o(k,R),A^=k,A=i(A,15),A+=S,A=o(A,5)+2530024501,P=o(P,R),P=i(P,18),P=o(P,E),S^=P,S=i(S,13),S+=x,S=o(S,5)+850148119;switch(_=0,U=0,k=0,P=0,g){case 15:P^=d[T+14]<<16;case 14:P^=d[T+13]<<8;case 13:P^=d[T+12],P=o(P,R),P=i(P,18),P=o(P,E),S^=P;case 12:k^=d[T+11]<<24;case 11:k^=d[T+10]<<16;case 10:k^=d[T+9]<<8;case 9:k^=d[T+8],k=o(k,C),k=i(k,17),k=o(k,R),A^=k;case 8:U^=d[T+7]<<24;case 7:U^=d[T+6]<<16;case 6:U^=d[T+5]<<8;case 5:U^=d[T+4],U=o(U,D),U=i(U,16),U=o(U,C),v^=U;case 4:_^=d[T+3]<<24;case 3:_^=d[T+2]<<16;case 2:_^=d[T+1]<<8;case 1:_^=d[T],_=o(_,E),_=i(_,15),_=o(_,D),x^=_}return x^=d.length,v^=d.length,A^=d.length,S^=d.length,x+=v,x+=A,x+=S,v+=x,A+=x,S+=x,x=s(x),v=s(v),A=s(A),S=s(S),x+=v,x+=A,x+=S,v+=x,A+=x,S+=x,("00000000"+(x>>>0).toString(16)).slice(-8)+("00000000"+(v>>>0).toString(16)).slice(-8)+("00000000"+(A>>>0).toString(16)).slice(-8)+("00000000"+(S>>>0).toString(16)).slice(-8)},t.x64.hash128=function(d,m){if(t.inputValidation&&!n(d))return e;m=m||0;for(var g=d.length%16,w=d.length-g,x=[0,m],v=[0,m],A=[0,0],S=[0,0],_=[2277735313,289559509],U=[1291169091,658871167],k=0;k<w;k=k+16)A=[d[k+4]|d[k+5]<<8|d[k+6]<<16|d[k+7]<<24,d[k]|d[k+1]<<8|d[k+2]<<16|d[k+3]<<24],S=[d[k+12]|d[k+13]<<8|d[k+14]<<16|d[k+15]<<24,d[k+8]|d[k+9]<<8|d[k+10]<<16|d[k+11]<<24],A=c(A,_),A=l(A,31),A=c(A,U),x=f(x,A),x=l(x,27),x=a(x,v),x=a(c(x,[0,5]),[0,1390208809]),S=c(S,U),S=l(S,33),S=c(S,_),v=f(v,S),v=l(v,31),v=a(v,x),v=a(c(v,[0,5]),[0,944331445]);switch(A=[0,0],S=[0,0],g){case 15:S=f(S,u([0,d[k+14]],48));case 14:S=f(S,u([0,d[k+13]],40));case 13:S=f(S,u([0,d[k+12]],32));case 12:S=f(S,u([0,d[k+11]],24));case 11:S=f(S,u([0,d[k+10]],16));case 10:S=f(S,u([0,d[k+9]],8));case 9:S=f(S,[0,d[k+8]]),S=c(S,U),S=l(S,33),S=c(S,_),v=f(v,S);case 8:A=f(A,u([0,d[k+7]],56));case 7:A=f(A,u([0,d[k+6]],48));case 6:A=f(A,u([0,d[k+5]],40));case 5:A=f(A,u([0,d[k+4]],32));case 4:A=f(A,u([0,d[k+3]],24));case 3:A=f(A,u([0,d[k+2]],16));case 2:A=f(A,u([0,d[k+1]],8));case 1:A=f(A,[0,d[k]]),A=c(A,_),A=l(A,31),A=c(A,U),x=f(x,A)}return x=f(x,[0,d.length]),v=f(v,[0,d.length]),x=a(x,v),v=a(v,x),x=h(x),v=h(v),x=a(x,v),v=a(v,x),("00000000"+(x[0]>>>0).toString(16)).slice(-8)+("00000000"+(x[1]>>>0).toString(16)).slice(-8)+("00000000"+(v[0]>>>0).toString(16)).slice(-8)+("00000000"+(v[1]>>>0).toString(16)).slice(-8)},typeof i0<"u"?(typeof j5<"u"&&j5.exports&&(i0=j5.exports=t),i0.murmurHash3=t):typeof define=="function"&&define.amd?define([],function(){return t}):(t._murmurHash3=r.murmurHash3,t.noConflict=function(){return r.murmurHash3=t._murmurHash3,t._murmurHash3=e,t.noConflict=e,t},r.murmurHash3=t)})(i0)});var tM=ht((mZe,eM)=>{eM.exports=JB()});var G5=ht((AZe,nM)=>{"use strict";nM.exports=class{constructor(){this._bitArrays=[],this._data=[],this._length=0,this._changedLength=!1,this._changedData=!1}set(e,t){let n=this._internalPositionFor(e,!1);if(t===void 0)n!==-1&&(this._unsetInternalPos(n),this._unsetBit(e),this._changedLength=!0,this._changedData=!0);else{let o=!1;n===-1?(n=this._data.length,this._setBit(e),this._changedData=!0):o=!0,this._setInternalPos(n,e,t,o),this._changedLength=!0}}unset(e){this.set(e,void 0)}get(e){this._sortData();let t=this._internalPositionFor(e,!0);if(t!==-1)return this._data[t][1]}push(e){return this.set(this.length,e),this.length}get length(){if(this._sortData(),this._changedLength){let e=this._data[this._data.length-1];this._length=e?e[0]+1:0,this._changedLength=!1}return this._length}forEach(e){let t=0;for(;t<this.length;)e(this.get(t),t,this),t++}map(e){let t=0,n=new Array(this.length);for(;t<this.length;)n[t]=e(this.get(t),t,this),t++;return n}reduce(e,t){let n=0,o=t;for(;n<this.length;){let i=this.get(n);o=e(o,i,n),n++}return o}find(e){let t=0,n,o;for(;t<this.length&&!n;)o=this.get(t),n=e(o),t++;return n?o:void 0}_internalPositionFor(e,t){let n=this._bytePosFor(e,t);if(n>=this._bitArrays.length)return-1;let o=this._bitArrays[n],i=e-n*7;if(!((o&1<<i)>0))return-1;let a=this._bitArrays.slice(0,n).reduce(CZ,0),c=~(4294967295<<i+1),l=rM(o&c);return a+l-1}_bytePosFor(e,t){let n=Math.floor(e/7),o=n+1;for(;!t&&this._bitArrays.length<o;)this._bitArrays.push(0);return n}_setBit(e){let t=this._bytePosFor(e,!1);this._bitArrays[t]|=1<<e-t*7}_unsetBit(e){let t=this._bytePosFor(e,!1);this._bitArrays[t]&=~(1<<e-t*7)}_setInternalPos(e,t,n,o){let i=this._data,s=[t,n];if(o)this._sortData(),i[e]=s;else{if(i.length)if(i[i.length-1][0]>=t)i.push(s);else if(i[0][0]<=t)i.unshift(s);else{let a=Math.round(i.length/2);this._data=i.slice(0,a).concat(s).concat(i.slice(a))}else this._data.push(s);this._changedData=!0,this._changedLength=!0}}_unsetInternalPos(e){this._data.splice(e,1)}_sortData(){this._changedData&&this._data.sort(IZ),this._changedData=!1}bitField(){let e=[],t=8,n=0,o=0,i,s=this._bitArrays.slice();for(;s.length||n;){n===0&&(i=s.shift(),n=7);let c=Math.min(n,t),l=~(255<<c),u=i&l;o|=u<<8-t,i=i>>>c,n-=c,t-=c,(!t||!n&&!s.length)&&(e.push(o),o=0,t=8)}for(var a=e.length-1;a>0&&e[a]===0;a--)e.pop();return e}compactArray(){return this._sortData(),this._data.map(TZ)}};function CZ(r,e){return r+rM(e)}function rM(r){let e=r;return e=e-(e>>1&1431655765),e=(e&858993459)+(e>>2&858993459),(e+(e>>4)&252645135)*16843009>>24}function IZ(r,e){return r[0]-e[0]}function TZ(r){return r[1]}});var rU=ht(ZA=>{ZA.read=function(r,e,t,n,o){var i,s,a=o*8-n-1,c=(1<<a)-1,l=c>>1,u=-7,f=t?o-1:0,h=t?-1:1,d=r[e+f];for(f+=h,i=d&(1<<-u)-1,d>>=-u,u+=a;u>0;i=i*256+r[e+f],f+=h,u-=8);for(s=i&(1<<-u)-1,i>>=-u,u+=n;u>0;s=s*256+r[e+f],f+=h,u-=8);if(i===0)i=1-l;else{if(i===c)return s?NaN:(d?-1:1)*(1/0);s=s+Math.pow(2,n),i=i-l}return(d?-1:1)*s*Math.pow(2,i-n)};ZA.write=function(r,e,t,n,o,i){var s,a,c,l=i*8-o-1,u=(1<<l)-1,f=u>>1,h=o===23?Math.pow(2,-24)-Math.pow(2,-77):0,d=n?0:i-1,m=n?1:-1,g=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,s=u):(s=Math.floor(Math.log(e)/Math.LN2),e*(c=Math.pow(2,-s))<1&&(s--,c*=2),s+f>=1?e+=h/c:e+=h*Math.pow(2,1-f),e*c>=2&&(s++,c/=2),s+f>=u?(a=0,s=u):s+f>=1?(a=(e*c-1)*Math.pow(2,o),s=s+f):(a=e*Math.pow(2,f-1)*Math.pow(2,o),s=0));o>=8;r[t+d]=a&255,d+=m,a/=256,o-=8);for(s=s<<o|a,l+=o;l>0;r[t+d]=s&255,d+=m,s/=256,l-=8);r[t+d-m]|=g*128}});var xU=ht((Uot,wU)=>{function xee(r){t.debug=t,t.default=t,t.coerce=c,t.disable=s,t.enable=o,t.enabled=a,t.humanize=Ig(),t.destroy=l,Object.keys(r).forEach(u=>{t[u]=r[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let f=0;for(let h=0;h<u.length;h++)f=(f<<5)-f+u.charCodeAt(h),f|=0;return t.colors[Math.abs(f)%t.colors.length]}t.selectColor=e;function t(u){let f,h=null,d,m;function g(...w){if(!g.enabled)return;let x=g,v=Number(new Date),A=v-(f||v);x.diff=A,x.prev=f,x.curr=v,f=v,w[0]=t.coerce(w[0]),typeof w[0]!="string"&&w.unshift("%O");let S=0;w[0]=w[0].replace(/%([a-zA-Z%])/g,(U,k)=>{if(U==="%%")return"%";S++;let P=t.formatters[k];if(typeof P=="function"){let E=w[S];U=P.call(x,E),w.splice(S,1),S--}return U}),t.formatArgs.call(x,w),(x.log||t.log).apply(x,w)}return g.namespace=u,g.useColors=t.useColors(),g.color=t.selectColor(u),g.extend=n,g.destroy=t.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(d!==t.namespaces&&(d=t.namespaces,m=t.enabled(u)),m),set:w=>{h=w}}),typeof t.init=="function"&&t.init(g),g}function n(u,f){let h=t(this.namespace+(typeof f>"u"?":":f)+u);return h.log=this.log,h}function o(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let f=(typeof u=="string"?u:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(let h of f)h[0]==="-"?t.skips.push(h.slice(1)):t.names.push(h)}function i(u,f){let h=0,d=0,m=-1,g=0;for(;h<u.length;)if(d<f.length&&(f[d]===u[h]||f[d]==="*"))f[d]==="*"?(m=d,g=h,d++):(h++,d++);else if(m!==-1)d=m+1,g++,h=g;else return!1;for(;d<f.length&&f[d]==="*";)d++;return d===f.length}function s(){let u=[...t.names,...t.skips.map(f=>"-"+f)].join(",");return t.enable(""),u}function a(u){for(let f of t.skips)if(i(u,f))return!1;for(let f of t.names)if(i(u,f))return!0;return!1}function c(u){return u instanceof Error?u.stack||u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}wU.exports=xee});var bU=ht((Xn,y8)=>{Xn.formatArgs=vee;Xn.save=Aee;Xn.load=Eee;Xn.useColors=bee;Xn.storage=See();Xn.destroy=(()=>{let r=!1;return()=>{r||(r=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();Xn.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function bee(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let r;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(r=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(r[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function vee(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+y8.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,o=>{o!=="%%"&&(t++,o==="%c"&&(n=t))}),r.splice(n,0,e)}Xn.log=console.debug||console.log||(()=>{});function Aee(r){try{r?Xn.storage.setItem("debug",r):Xn.storage.removeItem("debug")}catch{}}function Eee(){let r;try{r=Xn.storage.getItem("debug")||Xn.storage.getItem("DEBUG")}catch{}return!r&&typeof __Process$<"u"&&"env"in __Process$&&(r=__Process$.env.DEBUG),r}function See(){try{return localStorage}catch{}}y8.exports=xU()(Xn);var{formatters:_ee}=y8.exports;_ee.j=function(r){try{return JSON.stringify(r)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var BU=ht((Est,LU)=>{"use strict";LU.exports={RTLD_LAZY:1,RTLD_NOW:2,RTLD_GLOBAL:8,RTLD_LOCAL:4,E2BIG:7,EACCES:13,EADDRINUSE:48,EADDRNOTAVAIL:49,EAFNOSUPPORT:47,EAGAIN:35,EALREADY:37,EBADF:9,EBADMSG:94,EBUSY:16,ECANCELED:89,ECHILD:10,ECONNABORTED:53,ECONNREFUSED:61,ECONNRESET:54,EDEADLK:11,EDESTADDRREQ:39,EDOM:33,EDQUOT:69,EEXIST:17,EFAULT:14,EFBIG:27,EHOSTUNREACH:65,EIDRM:90,EILSEQ:92,EINPROGRESS:36,EINTR:4,EINVAL:22,EIO:5,EISCONN:56,EISDIR:21,ELOOP:62,EMFILE:24,EMLINK:31,EMSGSIZE:40,EMULTIHOP:95,ENAMETOOLONG:63,ENETDOWN:50,ENETRESET:52,ENETUNREACH:51,ENFILE:23,ENOBUFS:55,ENODATA:96,ENODEV:19,ENOENT:2,ENOEXEC:8,ENOLCK:77,ENOLINK:97,ENOMEM:12,ENOMSG:91,ENOPROTOOPT:42,ENOSPC:28,ENOSR:98,ENOSTR:99,ENOSYS:78,ENOTCONN:57,ENOTDIR:20,ENOTEMPTY:66,ENOTSOCK:38,ENOTSUP:45,ENOTTY:25,ENXIO:6,EOPNOTSUPP:102,EOVERFLOW:84,EPERM:1,EPIPE:32,EPROTO:100,EPROTONOSUPPORT:43,EPROTOTYPE:41,ERANGE:34,EROFS:30,ESPIPE:29,ESRCH:3,ESTALE:70,ETIME:101,ETIMEDOUT:60,ETXTBSY:26,EWOULDBLOCK:35,EXDEV:18,PRIORITY_LOW:19,PRIORITY_BELOW_NORMAL:10,PRIORITY_NORMAL:0,PRIORITY_ABOVE_NORMAL:-7,PRIORITY_HIGH:-14,PRIORITY_HIGHEST:-20,SIGHUP:1,SIGINT:2,SIGQUIT:3,SIGILL:4,SIGTRAP:5,SIGABRT:6,SIGIOT:6,SIGBUS:10,SIGFPE:8,SIGKILL:9,SIGUSR1:30,SIGSEGV:11,SIGUSR2:31,SIGPIPE:13,SIGALRM:14,SIGTERM:15,SIGCHLD:20,SIGCONT:19,SIGSTOP:17,SIGTSTP:18,SIGTTIN:21,SIGTTOU:22,SIGURG:16,SIGXCPU:24,SIGXFSZ:25,SIGVTALRM:26,SIGPROF:27,SIGWINCH:28,SIGIO:23,SIGINFO:29,SIGSYS:12,UV_FS_SYMLINK_DIR:1,UV_FS_SYMLINK_JUNCTION:2,O_RDONLY:0,O_WRONLY:1,O_RDWR:2,UV_DIRENT_UNKNOWN:0,UV_DIRENT_FILE:1,UV_DIRENT_DIR:2,UV_DIRENT_LINK:3,UV_DIRENT_FIFO:4,UV_DIRENT_SOCKET:5,UV_DIRENT_CHAR:6,UV_DIRENT_BLOCK:7,S_IFMT:61440,S_IFREG:32768,S_IFDIR:16384,S_IFCHR:8192,S_IFBLK:24576,S_IFIFO:4096,S_IFLNK:40960,S_IFSOCK:49152,O_CREAT:512,O_EXCL:2048,UV_FS_O_FILEMAP:0,O_NOCTTY:131072,O_TRUNC:1024,O_APPEND:8,O_DIRECTORY:1048576,O_NOFOLLOW:256,O_SYNC:128,O_DSYNC:4194304,O_SYMLINK:2097152,O_NONBLOCK:4,S_IRWXU:448,S_IRUSR:256,S_IWUSR:128,S_IXUSR:64,S_IRWXG:56,S_IRGRP:32,S_IWGRP:16,S_IXGRP:8,S_IRWXO:7,S_IROTH:4,S_IWOTH:2,S_IXOTH:1,F_OK:0,R_OK:4,W_OK:2,X_OK:1,UV_FS_COPYFILE_EXCL:1,COPYFILE_EXCL:1,UV_FS_COPYFILE_FICLONE:2,COPYFILE_FICLONE:2,UV_FS_COPYFILE_FICLONE_FORCE:4,COPYFILE_FICLONE_FORCE:4,OPENSSL_VERSION_NUMBER:269488207,SSL_OP_ALL:2147485780,SSL_OP_ALLOW_UNSAFE_LEGACY_RENEGOTIATION:262144,SSL_OP_CIPHER_SERVER_PREFERENCE:4194304,SSL_OP_CISCO_ANYCONNECT:32768,SSL_OP_COOKIE_EXCHANGE:8192,SSL_OP_CRYPTOPRO_TLSEXT_BUG:2147483648,SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS:2048,SSL_OP_EPHEMERAL_RSA:0,SSL_OP_LEGACY_SERVER_CONNECT:4,SSL_OP_MICROSOFT_BIG_SSLV3_BUFFER:0,SSL_OP_MICROSOFT_SESS_ID_BUG:0,SSL_OP_MSIE_SSLV2_RSA_PADDING:0,SSL_OP_NETSCAPE_CA_DN_BUG:0,SSL_OP_NETSCAPE_CHALLENGE_BUG:0,SSL_OP_NETSCAPE_DEMO_CIPHER_CHANGE_BUG:0,SSL_OP_NETSCAPE_REUSE_CIPHER_CHANGE_BUG:0,SSL_OP_NO_COMPRESSION:131072,SSL_OP_NO_QUERY_MTU:4096,SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION:65536,SSL_OP_NO_SSLv2:0,SSL_OP_NO_SSLv3:33554432,SSL_OP_NO_TICKET:16384,SSL_OP_NO_TLSv1:67108864,SSL_OP_NO_TLSv1_1:268435456,SSL_OP_NO_TLSv1_2:134217728,SSL_OP_PKCS1_CHECK_1:0,SSL_OP_PKCS1_CHECK_2:0,SSL_OP_SINGLE_DH_USE:0,SSL_OP_SINGLE_ECDH_USE:0,SSL_OP_SSLEAY_080_CLIENT_DH_BUG:0,SSL_OP_SSLREF2_REUSE_CERT_TYPE_BUG:0,SSL_OP_TLS_BLOCK_PADDING_BUG:0,SSL_OP_TLS_D5_BUG:0,SSL_OP_TLS_ROLLBACK_BUG:8388608,ENGINE_METHOD_RSA:1,ENGINE_METHOD_DSA:2,ENGINE_METHOD_DH:4,ENGINE_METHOD_RAND:8,ENGINE_METHOD_EC:2048,ENGINE_METHOD_CIPHERS:64,ENGINE_METHOD_DIGESTS:128,ENGINE_METHOD_PKEY_METHS:512,ENGINE_METHOD_PKEY_ASN1_METHS:1024,ENGINE_METHOD_ALL:65535,ENGINE_METHOD_NONE:0,DH_CHECK_P_NOT_SAFE_PRIME:2,DH_CHECK_P_NOT_PRIME:1,DH_UNABLE_TO_CHECK_GENERATOR:4,DH_NOT_SUITABLE_GENERATOR:8,ALPN_ENABLED:1,RSA_PKCS1_PADDING:1,RSA_SSLV23_PADDING:2,RSA_NO_PADDING:3,RSA_PKCS1_OAEP_PADDING:4,RSA_X931_PADDING:5,RSA_PKCS1_PSS_PADDING:6,RSA_PSS_SALTLEN_DIGEST:-1,RSA_PSS_SALTLEN_MAX_SIGN:-2,RSA_PSS_SALTLEN_AUTO:-2,defaultCoreCipherList:"TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA256:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!SRP:!CAMELLIA",TLS1_VERSION:769,TLS1_1_VERSION:770,TLS1_2_VERSION:771,TLS1_3_VERSION:772,POINT_CONVERSION_COMPRESSED:2,POINT_CONVERSION_UNCOMPRESSED:4,POINT_CONVERSION_HYBRID:6,defaultCipherList:"TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA256:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!SRP:!CAMELLIA"}});var EE=Symbol.for("@libp2p/connection");var Ni=Symbol.for("@libp2p/content-routing");function SE(r){return r==null?!1:(r.type==="RSA"||r.type==="Ed25519"||r.type==="secp256k1"||r.type==="ECDSA")&&r.raw instanceof Uint8Array&&typeof r.equals=="function"&&typeof r.toMultihash=="function"&&typeof r.toCID=="function"&&typeof r.verify=="function"}var Rc=Symbol.for("@libp2p/peer-discovery");var v0=Symbol.for("@libp2p/peer-id");function vo(r){return!!r?.[v0]}var Oi=Symbol.for("@libp2p/peer-routing");var pa="keep-alive";var ma=Symbol.for("@libp2p/transport");var Dc;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(Dc||(Dc={}));var Xe=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}},A0=class extends Error{static name="UnexpectedPeerError";constructor(e="Unexpected Peer"){super(e),this.name="UnexpectedPeerError"}},E0=class extends Error{static name="InvalidCryptoExchangeError";constructor(e="Invalid crypto exchange"){super(e),this.name="InvalidCryptoExchangeError"}},$=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}},ys=class extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}},Oh=class extends Error{static name="InvalidPrivateKeyError";constructor(e="Invalid private key"){super(e),this.name="InvalidPrivateKeyError"}};var S0=class extends Error{static name="ConnectionClosingError";constructor(e="The connection is closing"){super(e),this.name="ConnectionClosingError"}},Wu=class extends Error{static name="ConnectionClosedError";constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}},Gu=class extends Error{static name="ConnectionFailedError";constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}},Li=class extends Error{static name="MuxerClosedError";constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}},_0=class extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}},Nc=class extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}},$e=class extends Error{static name="NotFoundError";constructor(e="Not found"){super(e),this.name="NotFoundError"}},Xu=class extends Error{static name="InvalidPeerIdError";constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}},ga=class extends Error{static name="InvalidMultiaddrError";constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}},C0=class extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}},ya=class extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}},ws=class extends Error{static name="UnsupportedProtocolError";constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}},Oe=class extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}},I0=class extends Error{static name="ProtocolError";constructor(e="Protocol error"){super(e),this.name="ProtocolError"}},Ao=class extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}},Yn=class extends Error{static name="NotStartedError";constructor(e="Not started"){super(e),this.name="NotStartedError"}};var xs=class extends Error{static name="DialError";constructor(e="Dial error"){super(e),this.name="DialError"}},Oc=class extends Error{static name="ListenError";constructor(e="Listen error"){super(e),this.name="ListenError"}},Yu=class extends Error{static name="LimitedConnectionError";constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}},T0=class extends Error{static name="TooManyInboundProtocolStreamsError";constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}},wa=class extends Error{static name="TooManyOutboundProtocolStreamsError";constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}},Xo=class extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}};var Re=class extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){let t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let o=this.#e.get(e);o==null&&(o=[],this.#e.set(e,o)),o.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let o=this.#e.get(e);o!=null&&(o=o.filter(({callback:i})=>i!==t),this.#e.set(e,o))}dispatchEvent(e){let t=super.dispatchEvent(e),n=this.#e.get(e.type);return n==null||(n=n.filter(({once:o})=>!o),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}};function k0(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function Sr(...r){let e=[];for(let t of r)k0(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function Wr(...r){let e=[];for(let t of r)k0(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}var Ye=Symbol.for("@libp2p/service-capabilities"),Qn=Symbol.for("@libp2p/service-dependencies");function ke(r){let e=new globalThis.AbortController;function t(){e.abort();for(let i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}for(let i of r){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function n(){for(let i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}let o=e.signal;return o.clear=n,o}function ve(){let r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}var P0=class{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},Qu=class{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new P0(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new P0(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};var H8=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function nr(r={}){return vF(t=>{let n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function vF(r,e){e=e??{};let t=e.onEnd,n=new Qu,o,i,s,a=ve(),c=async()=>{try{return n.isEmpty()?s?{done:!0}:await new Promise((w,x)=>{i=v=>{i=null,n.push(v);try{w(r(n))}catch(A){x(A)}return o}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=ve()})}},l=w=>i!=null?i(w):(n.push(w),o),u=w=>(n=new Qu,i!=null?i({error:w}):(n.push({error:w}),o)),f=w=>{if(s)return o;if(e?.objectMode!==!0&&w?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:w})},h=w=>s?o:(s=!0,w!=null?u(w):l({done:!0})),d=()=>(n=new Qu,h(),{done:!0}),m=w=>(h(w),{done:!0});if(o={[Symbol.asyncIterator](){return this},next:c,return:d,throw:m,push:f,end:h,get readableLength(){return n.size},onEmpty:async w=>{let x=w?.signal;if(x?.throwIfAborted(),n.isEmpty())return;let v,A;x!=null&&(v=new Promise((S,_)=>{A=()=>{_(new H8)},x.addEventListener("abort",A)}));try{await Promise.race([a.promise,v])}finally{A!=null&&x!=null&&x?.removeEventListener("abort",A)}}},t==null)return o;let g=o;return o={[Symbol.asyncIterator](){return this},next(){return g.next()},throw(w){return g.throw(w),t!=null&&(t(w),t=void 0),{done:!0}},return(){return g.return(),t!=null&&(t(),t=void 0),{done:!0}},push:f,end(w){return g.end(w),t!=null&&(t(w),t=void 0),o},get readableLength(){return g.readableLength},onEmpty:w=>g.onEmpty(w)},o}var $8=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.name="AbortError",this.code=t??"ABORT_ERR"}};async function Ft(r,e,t,n){let o=new $8(n?.errorMessage,n?.errorCode);return t?.aborted===!0?Promise.reject(o):new Promise((i,s)=>{function a(){t?.removeEventListener("abort",u),r.removeEventListener(e,c),n?.errorEvent!=null&&r.removeEventListener(n.errorEvent,l)}let c=f=>{try{if(n?.filter?.(f)===!1)return}catch(h){a(),s(h);return}a(),i(f)},l=f=>{a(),s(f.detail)},u=()=>{a(),s(o)};t?.addEventListener("abort",u),r.addEventListener(e,c),n?.errorEvent!=null&&r.addEventListener(n.errorEvent,l)})}function Lh(r,e){let t,n=function(){let o=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(o,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}var R0=class extends Error{remainingPoints;msBeforeNext;consumedPoints;isFirstInDuration;constructor(e="Rate limit exceeded",t){super(e),this.name="RateLimitError",this.remainingPoints=t.remainingPoints,this.msBeforeNext=t.msBeforeNext,this.consumedPoints=t.consumedPoints,this.isFirstInDuration=t.isFirstInDuration}},D0=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};var N0=class extends Error{type;code;constructor(e,t,n){super(e??"The operation was aborted"),this.type="aborted",this.name=n??"AbortError",this.code=t??"ABORT_ERR"}};async function ut(r,e,t){if(e==null)return r;if(e.aborted)return r.catch(()=>{}),Promise.reject(new N0(t?.errorMessage,t?.errorCode,t?.errorName));let n,o=new N0(t?.errorMessage,t?.errorCode,t?.errorName);try{return await Promise.race([r,new Promise((i,s)=>{n=()=>{s(o)},e.addEventListener("abort",n)})])}finally{n!=null&&e.removeEventListener("abort",n)}}var O0=class{deferred;signal;constructor(e){this.signal=e,this.deferred=ve(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Xe)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function AF(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var L0=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=AF(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new Xe),this.cleanup())}async join(e={}){let t=new O0(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await ut(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};var _r=class extends Re{concurrency;maxSize;queue;pending;sort;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[],this.emitEmpty=Lh(this.emitEmpty.bind(this),1),this.emitIdle=Lh(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(let t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new D0;let n=new L0(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),n.join(t).then(o=>(this.safeDispatchEvent("completed",{detail:o}),this.safeDispatchEvent("success",{detail:{job:n,result:o}}),o)).catch(o=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("error",{detail:o}),this.safeDispatchEvent("failure",{detail:{job:n,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new Xe)}),this.clear()}async onEmpty(e){this.size!==0&&await Ft(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Ft(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await Ft(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();let t=nr({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},o=c=>{c.detail!=null&&t.push(c.detail)},i=c=>{n(c.detail)},s=()=>{n()},a=()=>{n(new Xe("Queue aborted"))};this.addEventListener("completed",o),this.addEventListener("error",i),this.addEventListener("idle",s),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("completed",o),this.removeEventListener("error",i),this.removeEventListener("idle",s),e?.signal?.removeEventListener("abort",a),n()}}};var Cr=class extends _r{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}};function EF(r){return r[Symbol.asyncIterator]!=null}function SF(r){if(EF(r))return(async()=>{for await(let e of r);})();for(let e of r);}var Gr=SF;function Ie(r=0){return new Uint8Array(r)}function Ot(r=0){return new Uint8Array(r)}var _F=Math.pow(2,7),CF=Math.pow(2,14),IF=Math.pow(2,21),V8=Math.pow(2,28),K8=Math.pow(2,35),z8=Math.pow(2,42),q8=Math.pow(2,49),at=128,Xr=127;function Ke(r){if(r<_F)return 1;if(r<CF)return 2;if(r<IF)return 3;if(r<V8)return 4;if(r<K8)return 5;if(r<z8)return 6;if(r<q8)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function Zu(r,e,t=0){switch(Ke(r)){case 8:e[t++]=r&255|at,r/=128;case 7:e[t++]=r&255|at,r/=128;case 6:e[t++]=r&255|at,r/=128;case 5:e[t++]=r&255|at,r/=128;case 4:e[t++]=r&255|at,r>>>=7;case 3:e[t++]=r&255|at,r>>>=7;case 2:e[t++]=r&255|at,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function TF(r,e,t=0){switch(Ke(r)){case 8:e.set(t++,r&255|at),r/=128;case 7:e.set(t++,r&255|at),r/=128;case 6:e.set(t++,r&255|at),r/=128;case 5:e.set(t++,r&255|at),r/=128;case 4:e.set(t++,r&255|at),r>>>=7;case 3:e.set(t++,r&255|at),r>>>=7;case 2:e.set(t++,r&255|at),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function j8(r,e){let t=r[e],n=0;if(n+=t&Xr,t<at||(t=r[e+1],n+=(t&Xr)<<7,t<at)||(t=r[e+2],n+=(t&Xr)<<14,t<at)||(t=r[e+3],n+=(t&Xr)<<21,t<at)||(t=r[e+4],n+=(t&Xr)*V8,t<at)||(t=r[e+5],n+=(t&Xr)*K8,t<at)||(t=r[e+6],n+=(t&Xr)*z8,t<at)||(t=r[e+7],n+=(t&Xr)*q8,t<at))return n;throw new RangeError("Could not decode varint")}function kF(r,e){let t=r.get(e),n=0;if(n+=t&Xr,t<at||(t=r.get(e+1),n+=(t&Xr)<<7,t<at)||(t=r.get(e+2),n+=(t&Xr)<<14,t<at)||(t=r.get(e+3),n+=(t&Xr)<<21,t<at)||(t=r.get(e+4),n+=(t&Xr)*V8,t<at)||(t=r.get(e+5),n+=(t&Xr)*K8,t<at)||(t=r.get(e+6),n+=(t&Xr)*z8,t<at)||(t=r.get(e+7),n+=(t&Xr)*q8,t<at))return n;throw new RangeError("Could not decode varint")}function br(r,e,t=0){return e==null&&(e=Ot(Ke(r))),e instanceof Uint8Array?Zu(r,e,t):TF(r,e,t)}function Yo(r,e=0){return r instanceof Uint8Array?j8(r,e):kF(r,e)}function je(r,e){e==null&&(e=r.reduce((o,i)=>o+i.length,0));let t=Ot(e),n=0;for(let o of r)t.set(o,n),n+=o.length;return t}function de(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}var CE=Symbol.for("@achingbrain/uint8arraylist");function _E(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(let n of r){let o=t+n.byteLength;if(e<o)return{buf:n,index:e-t};t=o}throw new RangeError("index is out of bounds")}function Eo(r){return!!r?.[CE]}var pe=class r{bufs;length;[CE]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(let n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(Eo(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(let n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(Eo(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){let t=_E(this.bufs,e);return t.buf[t.index]}set(e,t){let n=_E(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(Eo(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){let{bufs:n,length:o}=this._subList(e,t);return je(n,o)}subarray(e,t){let{bufs:n,length:o}=this._subList(e,t);return n.length===1?n[0]:je(n,o)}sublist(e,t){let{bufs:n,length:o}=this._subList(e,t),i=new r;return i.length=o,i.bufs=[...n],i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};let n=[],o=0;for(let i=0;i<this.bufs.length;i++){let s=this.bufs[i],a=o,c=a+s.byteLength;if(o=c,e>=c)continue;let l=e>=a&&e<c,u=t>a&&t<=c;if(l&&u){if(e===a&&t===c){n.push(s);break}let f=e-a;n.push(s.subarray(f,f+(t-e)));break}if(l){if(e===0){n.push(s);continue}n.push(s.subarray(e-a));continue}if(u){if(t===c){n.push(s);break}n.push(s.subarray(0,t-a));break}n.push(s)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!Eo(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;let o=n.byteLength;if(o===0)throw new TypeError("search must be at least 1 byte long");let i=256,s=new Int32Array(i);for(let f=0;f<i;f++)s[f]=-1;for(let f=0;f<o;f++)s[n[f]]=f;let a=s,c=this.byteLength-n.byteLength,l=n.byteLength-1,u;for(let f=t;f<=c;f+=u){u=0;for(let h=l;h>=0;h--){let d=this.get(f+h);if(n[h]!==d){u=Math.max(1,h-a[d]);break}}if(u===0)return f}return-1}getInt8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){let n=Ot(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){let o=Ie(2);new DataView(o.buffer,o.byteOffset,o.byteLength).setInt16(0,t,n),this.write(o,e)}getInt32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){let o=Ie(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setInt32(0,t,n),this.write(o,e)}getBigInt64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){let o=Ie(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setBigInt64(0,t,n),this.write(o,e)}getUint8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){let n=Ot(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){let o=Ie(2);new DataView(o.buffer,o.byteOffset,o.byteLength).setUint16(0,t,n),this.write(o,e)}getUint32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){let o=Ie(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setUint32(0,t,n),this.write(o,e)}getBigUint64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){let o=Ie(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setBigUint64(0,t,n),this.write(o,e)}getFloat32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){let o=Ie(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setFloat32(0,t,n),this.write(o,e)}getFloat64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){let o=Ie(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setFloat64(0,t,n),this.write(o,e)}equals(e){if(e==null||!(e instanceof r)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!de(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){let n=new r;return n.bufs=e,t==null&&(t=e.reduce((o,i)=>o+i.byteLength,0)),n.length=t,n}};var B0=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},Ju=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},M0=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},Bh=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function U0(r){return r[Symbol.asyncIterator]!=null}function IE(r,e){if(r.byteLength>e)throw new Ju("Message length too long")}var H0=r=>{let e=Ke(r),t=Ot(e);return br(r,t),H0.bytes=e,t};H0.bytes=0;function vs(r,e){e=e??{};let t=e.lengthEncoder??H0,n=e?.maxDataLength??4194304;function*o(i){IE(i,n);let s=t(i.byteLength);s instanceof Uint8Array?yield s:yield*s,i instanceof Uint8Array?yield i:yield*i}return U0(r)?async function*(){for await(let i of r)yield*o(i)}():function*(){for(let i of r)yield*o(i)}()}vs.single=(r,e)=>{e=e??{};let t=e.lengthEncoder??H0,n=e?.maxDataLength??4194304;return IE(r,n),new pe(t(r.byteLength),r)};var Lc;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(Lc||(Lc={}));var W8=r=>{let e=Yo(r);return W8.bytes=Ke(e),e};W8.bytes=0;function As(r,e){let t=new pe,n=Lc.LENGTH,o=-1,i=e?.lengthDecoder??W8,s=e?.maxLengthLength??8,a=e?.maxDataLength??4194304;function*c(){for(;t.byteLength>0;){if(n===Lc.LENGTH)try{if(o=i(t),o<0)throw new B0("Invalid message length");if(o>a)throw new Ju("Message length too long");let l=i.bytes;t.consume(l),e?.onLength!=null&&e.onLength(o),n=Lc.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>s)throw new M0("Message length length too long");break}throw l}if(n===Lc.DATA){if(t.byteLength<o)break;let l=t.sublist(0,o);t.consume(o),e?.onData!=null&&e.onData(l),yield l,n=Lc.LENGTH}}}return U0(r)?async function*(){for await(let l of r)t.append(l),yield*c();if(t.byteLength>0)throw new Bh("Unexpected end of input")}():function*(){for(let l of r)t.append(l),yield*c();if(t.byteLength>0)throw new Bh("Unexpected end of input")}()}As.fromReader=(r,e)=>{let t=1,n=async function*(){for(;;)try{let{done:i,value:s}=await r.next(t);if(i===!0)return;s!=null&&(yield s)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return As(n,{...e??{},onLength:i=>{t=i}})};function DF(r){let[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:o=>{n.push(o)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}var ef=DF;function NF(r){return r[Symbol.asyncIterator]!=null}function OF(r,e){let t=0;if(NF(r))return async function*(){for await(let c of r)yield e(c,t++)}();let n=ef(r),{value:o,done:i}=n.next();if(i===!0)return function*(){}();let s=e(o,t++);if(typeof s.then=="function")return async function*(){yield await s;for(let c of n)yield e(c,t++)}();let a=e;return function*(){yield s;for(let c of n)yield a(c,t++)}()}var Ht=OF;var G8=class{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=ve(),this.haveNext=ve()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");let e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=ve(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){let e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=ve(),await ut(this.readNext.promise,t?.signal,t)}};function $0(){return new G8}function LF(r){return r[Symbol.asyncIterator]!=null}async function BF(r,e,t){try{await Promise.all(r.map(async n=>{for await(let o of n)await e.push(o,{signal:t}),t.throwIfAborted()})),await e.end(void 0,{signal:t})}catch(n){await e.end(n,{signal:t}).catch(()=>{})}}async function*MF(r){let e=new AbortController,t=$0();BF(r,t,e.signal).catch(()=>{});try{yield*t}finally{e.abort()}}function*UF(r){for(let e of r)yield*e}function FF(...r){let e=[];for(let t of r)LF(t)||e.push(t);return e.length===r.length?UF(e):MF(r)}var fn=FF;function pt(r,...e){if(r==null)throw new Error("Empty pipeline");if(X8(r)){let n=r;r=()=>n.source}else if(PE(r)||kE(r)){let n=r;r=()=>n}let t=[r,...e];if(t.length>1&&X8(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)X8(t[n])&&(t[n]=$F(t[n]));return HF(...t)}var HF=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},kE=r=>r?.[Symbol.asyncIterator]!=null,PE=r=>r?.[Symbol.iterator]!=null,X8=r=>r==null?!1:r.sink!=null&&r.source!=null,$F=r=>e=>{let t=r.sink(e);if(t?.then!=null){let n=nr({objectMode:!0});t.then(()=>{n.end()},s=>{n.end(s)});let o,i=r.source;if(kE(i))o=async function*(){yield*i,n.end()};else if(PE(i))o=function*(){yield*i,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return fn(n,o())}return r.source};function VF(r){return r[Symbol.asyncIterator]!=null}function KF(r,e){return VF(r)?async function*(){let t=0;if(!(e<1)){for await(let n of r)if(yield n,t++,t===e)return}}():function*(){let t=0;if(!(e<1)){for(let n of r)if(yield n,t++,t===e)return}}()}var xa=KF;var j=class extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}};var Mh="/ipfs/bitswap/1.2.0";var Y8=new Float32Array([-0]),ba=new Uint8Array(Y8.buffer);function RE(r,e,t){Y8[0]=r,e[t]=ba[0],e[t+1]=ba[1],e[t+2]=ba[2],e[t+3]=ba[3]}function DE(r,e){return ba[0]=r[e],ba[1]=r[e+1],ba[2]=r[e+2],ba[3]=r[e+3],Y8[0]}var Q8=new Float64Array([-0]),Yr=new Uint8Array(Q8.buffer);function NE(r,e,t){Q8[0]=r,e[t]=Yr[0],e[t+1]=Yr[1],e[t+2]=Yr[2],e[t+3]=Yr[3],e[t+4]=Yr[4],e[t+5]=Yr[5],e[t+6]=Yr[6],e[t+7]=Yr[7]}function OE(r,e){return Yr[0]=r[e],Yr[1]=r[e+1],Yr[2]=r[e+2],Yr[3]=r[e+3],Yr[4]=r[e+4],Yr[5]=r[e+5],Yr[6]=r[e+6],Yr[7]=r[e+7],Q8[0]}var zF=BigInt(Number.MAX_SAFE_INTEGER),qF=BigInt(Number.MIN_SAFE_INTEGER),Zn=class r{lo;hi;constructor(e,t){this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){let e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){let e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){let e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return Bc;if(e<zF&&e>qF)return this.fromNumber(Number(e));let t=e<0n;t&&(e=-e);let n=e>>32n,o=e-(n<<32n);return t&&(n=~n|0n,o=~o|0n,++o>LE&&(o=0n,++n>LE&&(n=0n))),new r(Number(o),Number(n))}static fromNumber(e){if(e===0)return Bc;let t=e<0;t&&(e=-e);let n=e>>>0,o=(e-n)/4294967296>>>0;return t&&(o=~o>>>0,n=~n>>>0,++n>4294967295&&(n=0,++o>4294967295&&(o=0))),new r(n,o)}static from(e){return typeof e=="number"?r.fromNumber(e):typeof e=="bigint"?r.fromBigInt(e):typeof e=="string"?r.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new r(e.low>>>0,e.high>>>0):Bc}},Bc=new Zn(0,0);Bc.toBigInt=function(){return 0n};Bc.zzEncode=Bc.zzDecode=function(){return this};Bc.length=function(){return 1};var LE=4294967296n;function BE(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function ME(r,e,t){if(t-e<1)return"";let o,i=[],s=0,a;for(;e<t;)a=r[e++],a<128?i[s++]=a:a>191&&a<224?i[s++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,i[s++]=55296+(a>>10),i[s++]=56320+(a&1023)):i[s++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,s>8191&&((o??(o=[])).push(String.fromCharCode.apply(String,i)),s=0);return o!=null?(s>0&&o.push(String.fromCharCode.apply(String,i.slice(0,s))),o.join("")):String.fromCharCode.apply(String,i.slice(0,s))}function Z8(r,e,t){let n=t,o,i;for(let s=0;s<r.length;++s)o=r.charCodeAt(s),o<128?e[t++]=o:o<2048?(e[t++]=o>>6|192,e[t++]=o&63|128):(o&64512)===55296&&((i=r.charCodeAt(s+1))&64512)===56320?(o=65536+((o&1023)<<10)+(i&1023),++s,e[t++]=o>>18|240,e[t++]=o>>12&63|128,e[t++]=o>>6&63|128,e[t++]=o&63|128):(e[t++]=o>>12|224,e[t++]=o>>6&63|128,e[t++]=o&63|128);return t-n}function Qo(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function V0(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}var J8=class{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,Qo(this,10);return e}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw Qo(this,4);return V0(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw Qo(this,4);return V0(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw Qo(this,4);let e=DE(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw Qo(this,4);let e=OE(this.buf,this.pos);return this.pos+=8,e}bytes(){let e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw Qo(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){let e=this.bytes();return ME(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw Qo(this,e);this.pos+=e}else do if(this.pos>=this.len)throw Qo(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){let e=new Zn(0,0),t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw Qo(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw Qo(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw Qo(this,8);let e=V0(this.buf,this.pos+=4),t=V0(this.buf,this.pos+=4);return new Zn(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){let e=j8(this.buf,this.pos);return this.pos+=Ke(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}};function ew(r){return new J8(r instanceof Uint8Array?r:r.subarray())}function we(r,e,t){let n=ew(r);return e.decode(n,void 0,t)}var cw={};Ut(cw,{base10:()=>tH});var Mc={};Ut(Mc,{coerce:()=>So,empty:()=>FE,equals:()=>tw,fromHex:()=>WF,fromString:()=>rw,isBinary:()=>GF,toHex:()=>jF,toString:()=>nw});var FE=new Uint8Array(0);function jF(r){return r.reduce((e,t)=>e+t.toString(16).padStart(2,"0"),"")}function WF(r){let e=r.match(/../g);return e!=null?new Uint8Array(e.map(t=>parseInt(t,16))):FE}function tw(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function So(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function GF(r){return r instanceof ArrayBuffer||ArrayBuffer.isView(r)}function rw(r){return new TextEncoder().encode(r)}function nw(r){return new TextDecoder().decode(r)}function XF(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var o=0;o<r.length;o++){var i=r.charAt(o),s=i.charCodeAt(0);if(t[s]!==255)throw new TypeError(i+" is ambiguous");t[s]=o}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function f(m){if(m instanceof Uint8Array||(ArrayBuffer.isView(m)?m=new Uint8Array(m.buffer,m.byteOffset,m.byteLength):Array.isArray(m)&&(m=Uint8Array.from(m))),!(m instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(m.length===0)return"";for(var g=0,w=0,x=0,v=m.length;x!==v&&m[x]===0;)x++,g++;for(var A=(v-x)*u+1>>>0,S=new Uint8Array(A);x!==v;){for(var _=m[x],U=0,k=A-1;(_!==0||U<w)&&k!==-1;k--,U++)_+=256*S[k]>>>0,S[k]=_%a>>>0,_=_/a>>>0;if(_!==0)throw new Error("Non-zero carry");w=U,x++}for(var P=A-w;P!==A&&S[P]===0;)P++;for(var E=c.repeat(g);P<A;++P)E+=r.charAt(S[P]);return E}function h(m){if(typeof m!="string")throw new TypeError("Expected String");if(m.length===0)return new Uint8Array;var g=0;if(m[g]!==" "){for(var w=0,x=0;m[g]===c;)w++,g++;for(var v=(m.length-g)*l+1>>>0,A=new Uint8Array(v);m[g];){var S=t[m.charCodeAt(g)];if(S===255)return;for(var _=0,U=v-1;(S!==0||_<x)&&U!==-1;U--,_++)S+=a*A[U]>>>0,A[U]=S%256>>>0,S=S/256>>>0;if(S!==0)throw new Error("Non-zero carry");x=_,g++}if(m[g]!==" "){for(var k=v-x;k!==v&&A[k]===0;)k++;for(var P=new Uint8Array(w+(v-k)),E=w;k!==v;)P[E++]=A[k++];return P}}}function d(m){var g=h(m);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:f,decodeUnsafe:h,decode:d}}var YF=XF,QF=YF,HE=QF;var ow=class{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},iw=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){this.name=e,this.prefix=t;let o=t.codePointAt(0);if(o===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=o,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return $E(this,e)}},sw=class{decoders;constructor(e){this.decoders=e}or(e){return $E(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function $E(r,e){return new sw({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}var aw=class{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,o){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=o,this.encoder=new ow(e,t,n),this.decoder=new iw(e,t,o)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function tf({name:r,prefix:e,encode:t,decode:n}){return new aw(r,e,t,n)}function va({name:r,prefix:e,alphabet:t}){let{encode:n,decode:o}=HE(t,r);return tf({prefix:e,name:r,encode:n,decode:i=>So(o(i))})}function ZF(r,e,t,n){let o=r.length;for(;r[o-1]==="=";)--o;let i=new Uint8Array(o*t/8|0),s=0,a=0,c=0;for(let l=0;l<o;++l){let u=e[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);a=a<<t|u,s+=t,s>=8&&(s-=8,i[c++]=255&a>>s)}if(s>=t||(255&a<<8-s)!==0)throw new SyntaxError("Unexpected end of data");return i}function JF(r,e,t){let n=e[e.length-1]==="=",o=(1<<t)-1,i="",s=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],s+=8;s>t;)s-=t,i+=e[o&a>>s];if(s!==0&&(i+=e[o&a<<t-s]),n)for(;(i.length*t&7)!==0;)i+="=";return i}function eH(r){let e={};for(let t=0;t<r.length;++t)e[r[t]]=t;return e}function $t({name:r,prefix:e,bitsPerChar:t,alphabet:n}){let o=eH(n);return tf({prefix:e,name:r,encode(i){return JF(i,n,t)},decode(i){return ZF(i,o,t,r)}})}var tH=va({prefix:"9",name:"base10",alphabet:"0123456789"});var lw={};Ut(lw,{base16:()=>rH,base16upper:()=>nH});var rH=$t({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),nH=$t({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var uw={};Ut(uw,{base2:()=>oH});var oH=$t({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var fw={};Ut(fw,{base256emoji:()=>lH});var VE=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),iH=VE.reduce((r,e,t)=>(r[t]=e,r),[]),sH=VE.reduce((r,e,t)=>{let n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function aH(r){return r.reduce((e,t)=>(e+=iH[t],e),"")}function cH(r){let e=[];for(let t of r){let n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);let o=sH[n];if(o==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(o)}return new Uint8Array(e)}var lH=tf({prefix:"\u{1F680}",name:"base256emoji",encode:aH,decode:cH});var dw={};Ut(dw,{base32:()=>Vt,base32hex:()=>hH,base32hexpad:()=>mH,base32hexpadupper:()=>gH,base32hexupper:()=>pH,base32pad:()=>fH,base32padupper:()=>dH,base32upper:()=>uH,base32z:()=>yH});var Vt=$t({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),uH=$t({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),fH=$t({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),dH=$t({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),hH=$t({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),pH=$t({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),mH=$t({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),gH=$t({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),yH=$t({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var hw={};Ut(hw,{base36:()=>dn,base36upper:()=>wH});var dn=va({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),wH=va({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var pw={};Ut(pw,{base58btc:()=>Ve,base58flickr:()=>xH});var Ve=va({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),xH=va({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var mw={};Ut(mw,{base64:()=>or,base64pad:()=>bH,base64url:()=>Es,base64urlpad:()=>vH});var or=$t({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),bH=$t({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Es=$t({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),vH=$t({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var gw={};Ut(gw,{base8:()=>AH});var AH=$t({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var yw={};Ut(yw,{identity:()=>EH});var EH=tf({prefix:"\0",name:"identity",encode:r=>nw(r),decode:r=>rw(r)});var rf={};Ut(rf,{code:()=>Bi,decode:()=>ww,encode:()=>IH,name:()=>CH});var SH=new TextEncoder,_H=new TextDecoder,CH="json",Bi=512;function IH(r){return SH.encode(JSON.stringify(r))}function ww(r){return JSON.parse(_H.decode(r))}var Cn={};Ut(Cn,{code:()=>mt,decode:()=>PH,encode:()=>kH,name:()=>TH});var TH="raw",mt=85;function kH(r){return So(r)}function PH(r){return So(r)}var vw={};Ut(vw,{identity:()=>ir});var yt={};Ut(yt,{Digest:()=>Uc,create:()=>Qr,decode:()=>ze,equals:()=>bw,hasCode:()=>XH});var RH=qE,KE=128,DH=127,NH=~DH,OH=Math.pow(2,31);function qE(r,e,t){e=e||[],t=t||0;for(var n=t;r>=OH;)e[t++]=r&255|KE,r/=128;for(;r&NH;)e[t++]=r&255|KE,r>>>=7;return e[t]=r|0,qE.bytes=t-n+1,e}var LH=xw,BH=128,zE=127;function xw(r,n){var t=0,n=n||0,o=0,i=n,s,a=r.length;do{if(i>=a)throw xw.bytes=0,new RangeError("Could not decode varint");s=r[i++],t+=o<28?(s&zE)<<o:(s&zE)*Math.pow(2,o),o+=7}while(s>=BH);return xw.bytes=i-n,t}var MH=Math.pow(2,7),UH=Math.pow(2,14),FH=Math.pow(2,21),HH=Math.pow(2,28),$H=Math.pow(2,35),VH=Math.pow(2,42),KH=Math.pow(2,49),zH=Math.pow(2,56),qH=Math.pow(2,63),jH=function(r){return r<MH?1:r<UH?2:r<FH?3:r<HH?4:r<$H?5:r<VH?6:r<KH?7:r<zH?8:r<qH?9:10},WH={encode:RH,decode:LH,encodingLength:jH},GH=WH,Uh=GH;function Fh(r,e=0){return[Uh.decode(r,e),Uh.decode.bytes]}function nf(r,e,t=0){return Uh.encode(r,e,t),e}function of(r){return Uh.encodingLength(r)}function Qr(r,e){let t=e.byteLength,n=of(r),o=n+of(t),i=new Uint8Array(o+t);return nf(r,i,0),nf(t,i,n),i.set(e,o),new Uc(r,t,e,i)}function ze(r){let e=So(r),[t,n]=Fh(e),[o,i]=Fh(e.subarray(n)),s=e.subarray(n+i);if(s.byteLength!==o)throw new Error("Incorrect length");return new Uc(t,o,s,e)}function bw(r,e){if(r===e)return!0;{let t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&tw(r.bytes,t.bytes)}}var Uc=class{code;size;digest;bytes;constructor(e,t,n,o){this.code=e,this.size=t,this.digest=n,this.bytes=o}};function XH(r,e){return r.code===e}var jE=0,YH="identity",WE=So;function QH(r){return Qr(jE,WE(r))}var ir={code:jE,name:YH,encode:WE,digest:QH};var Ew={};Ut(Ew,{sha256:()=>De,sha512:()=>z0});function Fc({name:r,code:e,encode:t}){return new Aw(r,e,t)}var Aw=class{name;code;encode;constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?Qr(this.code,t):t.then(n=>Qr(this.code,n))}else throw Error("Unknown type, must be binary type")}};function XE(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}var De=Fc({name:"sha2-256",code:18,encode:XE("SHA-256")}),z0=Fc({name:"sha2-512",code:19,encode:XE("SHA-512")});function Sw(r,e){let{bytes:t,version:n}=r;switch(n){case 0:return JH(t,_w(r),e??Ve.encoder);default:return e$(t,_w(r),e??Vt.encoder)}}var YE=new WeakMap;function _w(r){let e=YE.get(r);if(e==null){let t=new Map;return YE.set(r,t),t}return e}var q=class r{code;version;multihash;bytes;"/";constructor(e,t,n,o){this.code=t,this.version=e,this.multihash=n,this.bytes=o,this["/"]=o}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:e,multihash:t}=this;if(e!==Hh)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==t$)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=Qr(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return r.equals(this,e)}static equals(e,t){let n=t;return n!=null&&e.code===n.code&&e.version===n.version&&bw(e.multihash,n.multihash)}toString(e){return Sw(this,e)}toJSON(){return{"/":Sw(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;let t=e;if(t instanceof r)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){let{version:n,code:o,multihash:i,bytes:s}=t;return new r(n,o,i,s??QE(n,o,i.bytes))}else if(t[r$]===!0){let{version:n,multihash:o,code:i}=t,s=ze(o);return r.create(n,i,s)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Hh)throw new Error(`Version 0 CID must use dag-pb (code: ${Hh}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let o=QE(e,t,n.bytes);return new r(e,t,n,o)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,Hh,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,o=So(e.subarray(n,n+t.multihashSize));if(o.byteLength!==t.multihashSize)throw new Error("Incorrect length");let i=o.subarray(t.multihashSize-t.digestSize),s=new Uc(t.multihashCode,t.digestSize,i,o);return[t.version===0?r.createV0(s):r.createV1(t.codec,s),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[f,h]=Fh(e.subarray(t));return t+=h,f},o=n(),i=Hh;if(o===18?(o=0,t=0):i=n(),o!==0&&o!==1)throw new RangeError(`Invalid CID version ${o}`);let s=t,a=n(),c=n(),l=t+c,u=l-s;return{version:o,codec:i,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){let[n,o]=ZH(e,t),i=r.decode(o);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return _w(i).set(n,e),i}};function ZH(r,e){switch(r[0]){case"Q":{let t=e??Ve;return[Ve.prefix,t.decode(`${Ve.prefix}${r}`)]}case Ve.prefix:{let t=e??Ve;return[Ve.prefix,t.decode(r)]}case Vt.prefix:{let t=e??Vt;return[Vt.prefix,t.decode(r)]}case dn.prefix:{let t=e??dn;return[dn.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function JH(r,e,t){let{prefix:n}=t;if(n!==Ve.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let o=e.get(n);if(o==null){let i=t.encode(r).slice(1);return e.set(n,i),i}else return o}function e$(r,e,t){let{prefix:n}=t,o=e.get(n);if(o==null){let i=t.encode(r);return e.set(n,i),i}else return o}var Hh=112,t$=18;function QE(r,e,t){let n=of(r),o=n+of(e),i=new Uint8Array(o+t.byteLength);return nf(r,i,0),nf(e,i,n),i.set(t,o),i}var r$=Symbol.for("@ipld/js-cid/CID");var Hc={...yw,...uw,...gw,...cw,...lw,...dw,...hw,...pw,...mw,...fw},_oe={...Ew,...vw};function JE(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var ZE=JE("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),Cw=JE("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=Ot(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),n$={utf8:ZE,"utf-8":ZE,hex:Hc.base16,latin1:Cw,ascii:Cw,binary:Cw,...Hc},q0=n$;function L(r,e="utf8"){let t=q0[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${r}`)}function Iw(r){let e=r??8192,t=e>>>1,n,o=e;return function(s){if(s<1||s>t)return Ot(s);o+s>e&&(n=Ot(e),o=0);let a=n.subarray(o,o+=s);return(o&7)!==0&&(o=(o|7)+1),a}}var $c=class{fn;len;next;val;constructor(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}};function Tw(){}var Pw=class{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}},o$=Iw();function i$(r){return __Buffer$!=null?Ot(r):o$(r)}var Vh=class{len;head;tail;states;constructor(){this.len=0,this.head=new $c(Tw,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new $c(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new Rw((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(j0,10,Zn.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){let t=Zn.fromBigInt(e);return this._push(j0,t.length(),t)}uint64Number(e){return this._push(Zu,Ke(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){let t=Zn.fromBigInt(e).zzEncode();return this._push(j0,t.length(),t)}sint64Number(e){let t=Zn.fromNumber(e).zzEncode();return this._push(j0,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(kw,1,e?1:0)}fixed32(e){return this._push($h,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){let t=Zn.fromBigInt(e);return this._push($h,4,t.lo)._push($h,4,t.hi)}fixed64Number(e){let t=Zn.fromNumber(e);return this._push($h,4,t.lo)._push($h,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(RE,4,e)}double(e){return this._push(NE,8,e)}bytes(e){let t=e.length>>>0;return t===0?this._push(kw,1,0):this.uint32(t)._push(a$,t,e)}string(e){let t=BE(e);return t!==0?this.uint32(t)._push(Z8,t,e):this._push(kw,1,0)}fork(){return this.states=new Pw(this),this.head=this.tail=new $c(Tw,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new $c(Tw,0,0),this.len=0),this}ldelim(){let e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next,t=i$(this.len),n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}};function kw(r,e,t){e[t]=r&255}function s$(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}var Rw=class extends $c{next;constructor(e,t){super(s$,e,t),this.next=void 0}};function j0(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function $h(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function a$(r,e,t){e.set(r,t)}__Buffer$!=null&&(Vh.prototype.bytes=function(r){let e=r.length>>>0;return this.uint32(e),e>0&&this._push(c$,e,r),this},Vh.prototype.string=function(r){let e=__Buffer$.byteLength(r);return this.uint32(e),e>0&&this._push(l$,e,r),this});function c$(r,e,t){e.set(r,t)}function l$(r,e,t){r.length<40?Z8(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(L(r),t)}function Dw(){return new Vh}function xe(r,e){let t=Dw();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var sf;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(sf||(sf={}));function W0(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function wt(r){function e(o){if(r[o.toString()]==null)throw new Error("Invalid enum value");return r[o]}let t=function(i,s){let a=e(i);s.int32(a)},n=function(i){let s=i.int32();return e(s)};return W0("enum",sf.VARINT,t,n)}function be(r,e){return W0("message",sf.LENGTH_DELIMITED,r,e)}var ft=class extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"},Kh=class extends Error{code="ERR_MAX_SIZE";name="MaxSizeError"};var Yt;(function(r){r.WantBlock="WantBlock",r.WantHave="WantHave"})(Yt||(Yt={}));var Nw;(function(r){r[r.WantBlock=0]="WantBlock",r[r.WantHave=1]="WantHave"})(Nw||(Nw={}));(function(r){r.codec=()=>wt(Nw)})(Yt||(Yt={}));var af;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.priority!=null&&t.priority!==0&&(n.uint32(16),n.int32(t.priority)),t.cancel!=null&&(n.uint32(24),n.bool(t.cancel)),t.wantType!=null&&(n.uint32(32),Yt.codec().encode(t.wantType,n)),t.sendDontHave!=null&&(n.uint32(40),n.bool(t.sendDontHave)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={cid:Ie(0),priority:0},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.cid=t.bytes();break}case 2:{i.priority=t.int32();break}case 3:{i.cancel=t.bool();break}case 4:{i.wantType=Yt.codec().decode(t);break}case 5:{i.sendDontHave=t.bool();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(af||(af={}));var G0;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.entries!=null)for(let i of t.entries)n.uint32(10),af.codec().encode(i,n);t.full!=null&&(n.uint32(16),n.bool(t.full)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={entries:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{if(o.limits?.entries!=null&&i.entries.length===o.limits.entries)throw new ft('Decode error - map field "entries" had too many elements');i.entries.push(af.codec().decode(t,t.uint32(),{limits:o.limits?.entries$}));break}case 2:{i.full=t.bool();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(G0||(G0={}));var cf;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.prefix!=null&&t.prefix.byteLength>0&&(n.uint32(10),n.bytes(t.prefix)),t.data!=null&&t.data.byteLength>0&&(n.uint32(18),n.bytes(t.data)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={prefix:Ie(0),data:Ie(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.prefix=t.bytes();break}case 2:{i.data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(cf||(cf={}));var _o;(function(r){r.HaveBlock="HaveBlock",r.DoNotHaveBlock="DoNotHaveBlock"})(_o||(_o={}));var X0;(function(r){r[r.HaveBlock=0]="HaveBlock",r[r.DoNotHaveBlock=1]="DoNotHaveBlock"})(X0||(X0={}));(function(r){r.codec=()=>wt(X0)})(_o||(_o={}));var lf;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.type!=null&&X0[t.type]!==0&&(n.uint32(16),_o.codec().encode(t.type,n)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={cid:Ie(0),type:_o.HaveBlock},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.cid=t.bytes();break}case 2:{i.type=_o.codec().decode(t);break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(lf||(lf={}));var Vc;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.wantlist!=null&&(n.uint32(10),G0.codec().encode(t.wantlist,n)),t.blocks!=null)for(let i of t.blocks)n.uint32(26),cf.codec().encode(i,n);if(t.blockPresences!=null)for(let i of t.blockPresences)n.uint32(34),lf.codec().encode(i,n);t.pendingBytes!=null&&t.pendingBytes!==0&&(n.uint32(40),n.int32(t.pendingBytes)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={blocks:[],blockPresences:[],pendingBytes:0},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.wantlist=G0.codec().decode(t,t.uint32(),{limits:o.limits?.wantlist});break}case 3:{if(o.limits?.blocks!=null&&i.blocks.length===o.limits.blocks)throw new ft('Decode error - map field "blocks" had too many elements');i.blocks.push(cf.codec().decode(t,t.uint32(),{limits:o.limits?.blocks$}));break}case 4:{if(o.limits?.blockPresences!=null&&i.blockPresences.length===o.limits.blockPresences)throw new ft('Decode error - map field "blockPresences" had too many elements');i.blockPresences.push(lf.codec().decode(t,t.uint32(),{limits:o.limits?.blockPresences$}));break}case 5:{i.pendingBytes=t.int32();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(Vc||(Vc={}));function eS(r,e){for(let[t,n]of e.wantlist.entries()){let o=r.wantlist.get(t);o!=null&&(o.priority>n.priority&&(n.priority=o.priority),n.cancel=n.cancel??o.cancel,n.wantType=n.wantType??o.wantType,n.sendDontHave=n.sendDontHave??o.sendDontHave),r.wantlist.set(t,n)}for(let[t,n]of e.blockPresences.entries())r.blockPresences.set(t,n);for(let[t,n]of e.blocks.entries())r.blocks.set(t,n);return e.full&&!r.full&&(r.full=!0),r}var Y0=class extends Error{static name="BlockTooLargeError";constructor(e="Block too large"){super(e),this.name="BlockTooLargeError"}};var u$=4193648,f$=u$+16;function*tS(r,e){let t=[...r.wantlist.values()],n=[...r.blockPresences.values()],o=[...r.blocks.values()],i=0,s=0,a=0,c=!1;for(;;){let l={wantlist:{full:r.full??!1,entries:[]},blockPresences:[],blocks:[],pendingBytes:0},u=Vc.encode(l).byteLength,{added:f,hasMore:h,newSize:d}=Ow(o,l.blocks,a,e,u,d$);a+=f,u=d;let m=h;({added:f,hasMore:h,newSize:d}=Ow(n,l.blockPresences,s,e,u,h$)),s+=f,u=d;let g=h;if({added:f,hasMore:h,newSize:d}=Ow(t,l.wantlist.entries,i,e,u,p$),i+=f,u=d,c=!m&&!g&&!h,c||(l.wantlist.full=!1),yield Vc.encode(l),c)break}}function Ow(r,e,t,n,o,i){let s=0,a=!1;for(let c=t;c<r.length;c++){let l=r[c],u=i(l);if(u>f$)throw new Y0("Cannot send block as after encoding it is over the max message size");let f=o+u;if(f>n){a=!0;break}e.push(l),s++,o=f}return{hasMore:a,added:s,newSize:o}}function d$(r){return Lw(3,cf.encode(r))}function h$(r){return Lw(4,lf.encode(r))}function p$(r){return Lw(1,af.encode(r))}function Lw(r,e){let t=Ke(r),n=Ke(e.byteLength);return t+n+e.byteLength}var Q0=class extends Re{log;libp2p;routing;protocols;running;maxInboundStreams;maxOutboundStreams;messageReceiveTimeout;registrarIds;metrics;sendQueue;runOnLimitedConnections;maxOutgoingMessageSize;maxIncomingMessageSize;constructor(e,t={}){super(),this.log=e.logger.forComponent("helia:bitswap:network"),this.libp2p=e.libp2p,this.routing=e.routing,this.protocols=t.protocols??[Mh],this.registrarIds=[],this.running=!1,this._onStream=this._onStream.bind(this),this.maxInboundStreams=t.maxInboundStreams??1024,this.maxOutboundStreams=t.maxOutboundStreams??1024,this.messageReceiveTimeout=t.messageReceiveTimeout??5e3,this.runOnLimitedConnections=t.runOnLimitedConnections??!1,this.maxIncomingMessageSize=t.maxIncomingMessageSize??4194304,this.maxOutgoingMessageSize=t.maxOutgoingMessageSize??t.maxIncomingMessageSize??4194304,this.metrics={blocksSent:e.metrics?.registerCounter("helia_bitswap_sent_blocks_total"),dataSent:e.metrics?.registerCounter("helia_bitswap_sent_data_bytes_total")},this.sendQueue=new Cr({concurrency:t.messageSendConcurrency??50,metrics:e.metrics,metricName:"helia_bitswap_message_send_queue"}),this.sendQueue.addEventListener("error",n=>{this.log.error("error sending wantlist to peer",n.detail)})}async start(){if(this.running)return;this.running=!0,await this.libp2p.handle(this.protocols,this._onStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnections});let e={onConnect:t=>{this.safeDispatchEvent("peer:connected",{detail:t})},onDisconnect:t=>{this.safeDispatchEvent("peer:disconnected",{detail:t})}};this.registrarIds=[];for(let t of this.protocols)this.registrarIds.push(await this.libp2p.register(t,e));this.libp2p.getConnections().forEach(t=>{this.safeDispatchEvent("peer:connected",{detail:t.remotePeer})})}async stop(){if(this.running=!1,await this.libp2p.unhandle(this.protocols),this.registrarIds!=null){for(let e of this.registrarIds)this.libp2p.unregister(e);this.registrarIds=[]}}_onStream(e){if(!this.running)return;let{stream:t,connection:n}=e;Promise.resolve().then(async()=>{this.log("incoming new bitswap %s stream from %p",t.protocol,n.remotePeer);let o=()=>{t.status==="open"?t.abort(new Ao(`Incoming Bitswap stream timed out after ${this.messageReceiveTimeout}ms`)):this.log("stream aborted with status %s",t.status)},i=AbortSignal.timeout(this.messageReceiveTimeout);i.addEventListener("abort",o),await t.closeWrite(),await pt(t,s=>As(s,{maxDataLength:this.maxIncomingMessageSize}),async s=>{for await(let a of s)try{let c=Vc.decode(a);this.log("incoming new bitswap %s message from %p on stream",t.protocol,n.remotePeer,t.id),this.safeDispatchEvent("bitswap:message",{detail:{peer:n.remotePeer,message:c}}),i.removeEventListener("abort",o),i=AbortSignal.timeout(this.messageReceiveTimeout),i.addEventListener("abort",o)}catch(c){this.log.error("error reading incoming bitswap message from %p on stream",n.remotePeer,t.id,c),t.abort(c);break}})}).catch(o=>{this.log.error("error handling incoming stream from %p",n.remotePeer,o),t.abort(o)})}async*findProviders(e,t){t?.onProgress?.(new j("bitswap:network:find-providers",e));for await(let n of this.routing.findProviders(e,t))await this.libp2p.isDialable(n.multiaddrs,{runOnLimitedConnection:this.runOnLimitedConnections})&&(yield n)}async findAndConnect(e,t){t?.providers!=null&&await Promise.all(t.providers.map(async n=>this.connectTo(n).catch(o=>{this.log.error("could not connect to supplied provider - %e",o)}))),await Gr(Ht(xa(this.findProviders(e,t),t?.maxProviders??3),async n=>this.connectTo(n.id,t))).catch(n=>{this.log.error(n)})}async sendMessage(e,t,n){if(!this.running)throw new Error("network isn't running");let o=this.sendQueue.queue.find(i=>e.equals(i.options.peerId)&&i.status==="queued");if(o!=null){o.options.message=eS(o.options.message,t),await o.join({signal:n?.signal});return}await this.sendQueue.add(async i=>{let s=i?.message;if(s==null)throw new $("No message to send");this.log("sendMessage to %p",e),i?.onProgress?.(new j("bitswap:network:send-wantlist",e));let a=await this.libp2p.dialProtocol(e,Mh,i);await a.closeRead();try{await pt(tS(s,this.maxOutgoingMessageSize),c=>vs(c),a),await a.close(i)}catch(c){i?.onProgress?.(new j("bitswap:network:send-wantlist:error",{peer:e,error:c})),this.log.error("error sending message to %p",e,c),a.abort(c)}this._updateSentStats(s.blocks)},{peerId:e,signal:n?.signal,message:t})}async connectTo(e,t){if(!this.running)throw new Yn("Network isn't running");t?.onProgress?.(new j("bitswap:network:dial",e));let[n]=await Promise.all([this.libp2p.dial(e,t),Ft(this.libp2p,"peer:identify",t?.signal,{filter:o=>{if(!o.detail.peerId.equals(e))return!1;if(o.detail.protocols.includes(Mh))return!0;throw new ws(`${e} did not support ${Mh}`)}})]);return n}_updateSentStats(e){let t=0;for(let n of e.values())t+=n.data.byteLength;this.metrics.dataSent?.increment(t),this.metrics.blocksSent?.increment(e.size)}};function K(r,e="utf8"){let t=q0[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(r).substring(1)}var E$=parseInt("11111",2),Bw=parseInt("10000000",2),S$=parseInt("01111111",2),rS={0:zh,1:zh,2:_$,3:T$,4:k$,5:I$,6:C$,16:zh,22:zh,48:zh};function Co(r,e={offset:0}){let t=r[e.offset]&E$;if(e.offset++,rS[t]!=null)return rS[t](r,e);throw new Error("No decoder for tag "+t)}function qh(r,e){let t=0;if((r[e.offset]&Bw)===Bw){let n=r[e.offset]&S$,o="0x";e.offset++;for(let i=0;i<n;i++,e.offset++)o+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(o,16)}else t=r[e.offset],e.offset++;return t}function zh(r,e){qh(r,e);let t=[];for(;!(e.offset>=r.byteLength);){let n=Co(r,e);if(n===null)break;t.push(n)}return t}function _$(r,e){let t=qh(r,e),n=e.offset,o=e.offset+t,i=[];for(let s=n;s<o;s++)s===n&&r[s]===0||i.push(r[s]);return e.offset+=t,Uint8Array.from(i)}function C$(r,e){let t=qh(r,e),n=e.offset+t,o=r[e.offset];e.offset++;let i=0,s=0;o<40?(i=0,s=o):o<80?(i=1,s=o-40):(i=2,s=o-80);let a=`${i}.${s}`,c=[];for(;e.offset<n;){let l=r[e.offset];if(e.offset++,c.push(l&127),l<128){c.reverse();let u=0;for(let f=0;f<c.length;f++)u+=c[f]<<f*7;a+=`.${u}`,c=[]}}return a}function I$(r,e){return e.offset++,null}function T$(r,e){let t=qh(r,e),n=r[e.offset];e.offset++;let o=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return o}function k$(r,e){let t=qh(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function P$(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);let t=new pe;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function Z0(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);let e=P$(r.byteLength);return new pe(Uint8Array.from([e.byteLength|Bw]),e)}function hn(r){let e=new pe,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new pe(Uint8Array.from([2]),Z0(e),e)}function jh(r){let e=Uint8Array.from([0]),t=new pe(e,r);return new pe(Uint8Array.from([3]),Z0(t),t)}function nS(r){return new pe(Uint8Array.from([4]),Z0(r),r)}function Zo(r,e=48){let t=new pe;for(let n of r)t.append(n);return new pe(Uint8Array.from([e]),Z0(t),t)}var oS="1.2.840.10045.3.1.7",iS="1.3.132.0.34",sS="1.3.132.0.35";async function aS(r="P-256"){let e=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:r},!0,["sign","verify"]);return{publicKey:await crypto.subtle.exportKey("jwk",e.publicKey),privateKey:await crypto.subtle.exportKey("jwk",e.privateKey)}}async function cS(r,e,t){let n=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["sign"]);t?.signal?.throwIfAborted();let o=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},n,e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(o,0,o.byteLength)}async function lS(r,e,t,n){let o=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();let i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},o,e,t.subarray());return n?.signal?.throwIfAborted(),i}var R$=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),D$=Uint8Array.from([6,5,43,129,4,0,34]),N$=Uint8Array.from([6,5,43,129,4,0,35]),uS={ext:!0,kty:"EC",crv:"P-256"},fS={ext:!0,kty:"EC",crv:"P-384"},dS={ext:!0,kty:"EC",crv:"P-521"},uf=32,ff=48,df=66;function hS(r){let e=Co(r);return Mw(e)}function Mw(r){let e=r[1],t=K(e,"base64url"),n=r[2][1][0],o=1,i,s;if(e.byteLength===uf)return i=K(n.subarray(o,o+uf),"base64url"),s=K(n.subarray(o+uf),"base64url"),new zc({...uS,key_ops:["sign"],d:t,x:i,y:s});if(e.byteLength===ff)return i=K(n.subarray(o,o+ff),"base64url"),s=K(n.subarray(o+ff),"base64url"),new zc({...fS,key_ops:["sign"],d:t,x:i,y:s});if(e.byteLength===df)return i=K(n.subarray(o,o+df),"base64url"),s=K(n.subarray(o+df),"base64url"),new zc({...dS,key_ops:["sign"],d:t,x:i,y:s});throw new $(`Private key length was wrong length, got ${e.byteLength}, expected 32, 48 or 66`)}function Uw(r){let e=Co(r);return pS(e)}function pS(r){let e=r[1][1][0],t=1,n,o;if(e.byteLength===uf*2+1)return n=K(e.subarray(t,t+uf),"base64url"),o=K(e.subarray(t+uf),"base64url"),new Kc({...uS,key_ops:["verify"],x:n,y:o});if(e.byteLength===ff*2+1)return n=K(e.subarray(t,t+ff),"base64url"),o=K(e.subarray(t+ff),"base64url"),new Kc({...fS,key_ops:["verify"],x:n,y:o});if(e.byteLength===df*2+1)return n=K(e.subarray(t,t+df),"base64url"),o=K(e.subarray(t+df),"base64url"),new Kc({...dS,key_ops:["verify"],x:n,y:o});throw new $(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function mS(r){return Zo([hn(Uint8Array.from([1])),nS(L(r.d??"","base64url")),Zo([yS(r.crv)],160),Zo([jh(new pe(Uint8Array.from([4]),L(r.x??"","base64url"),L(r.y??"","base64url")))],161)]).subarray()}function gS(r){return Zo([hn(Uint8Array.from([1])),Zo([yS(r.crv)],160),Zo([jh(new pe(Uint8Array.from([4]),L(r.x??"","base64url"),L(r.y??"","base64url")))],161)]).subarray()}function yS(r){if(r==="P-256")return R$;if(r==="P-384")return D$;if(r==="P-521")return N$;throw new $(`Invalid curve ${r}`)}async function wS(r="P-256"){let e=await aS(r);return new zc(e.privateKey)}var Kc=class{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=gS(this.jwk)),this._raw}toMultihash(){return ir.digest(sr(this))}toCID(){return q.createV1(114,this.toMultihash())}toString(){return Ve.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:de(this.raw,e.raw)}async verify(e,t,n){return lS(this.jwk,t,e,n)}},zc=class{type="ECDSA";jwk;publicKey;_raw;constructor(e){this.jwk=e,this.publicKey=new Kc({crv:e.crv,ext:e.ext,key_ops:["verify"],kty:"EC",x:e.x,y:e.y})}get raw(){return this._raw==null&&(this._raw=mS(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:de(this.raw,e.raw)}async sign(e,t){return cS(this.jwk,e,t)}};var qc=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;function pf(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Jo(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function Ir(r,...e){if(!pf(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function jc(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");Jo(r.outputLen),Jo(r.blockLen)}function mf(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function bS(r,e){Ir(r);let t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function Zr(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function Wc(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function ei(r,e){return r<<32-e|r>>>e}function J0(r,e){return r<<e|r>>>32-e>>>0}var vS=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",O$=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function Mi(r){if(Ir(r),vS)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=O$[r[t]];return e}var Ss={_0:48,_9:57,A:65,F:70,a:97,f:102};function xS(r){if(r>=Ss._0&&r<=Ss._9)return r-Ss._0;if(r>=Ss.A&&r<=Ss.F)return r-(Ss.A-10);if(r>=Ss.a&&r<=Ss.f)return r-(Ss.a-10)}function gf(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(vS)return Uint8Array.fromHex(r);let e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);let n=new Uint8Array(t);for(let o=0,i=0;o<t;o++,i+=2){let s=xS(r.charCodeAt(i)),a=xS(r.charCodeAt(i+1));if(s===void 0||a===void 0){let c=r[i]+r[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}n[o]=s*16+a}return n}var L$=async()=>{};async function AS(r,e,t){let n=Date.now();for(let o=0;o<r;o++){t(o);let i=Date.now()-n;i>=0&&i<e||(await L$(),n+=i)}}function Fw(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function Aa(r){return typeof r=="string"&&(r=Fw(r)),Ir(r),r}function Hw(r){return typeof r=="string"&&(r=Fw(r)),Ir(r),r}function eo(...r){let e=0;for(let n=0;n<r.length;n++){let o=r[n];Ir(o),e+=o.length}let t=new Uint8Array(e);for(let n=0,o=0;n<r.length;n++){let i=r[n];t.set(i,o),o+=i.length}return t}function ES(r,e){if(e!==void 0&&{}.toString.call(e)!=="[object Object]")throw new Error("options should be object or undefined");return Object.assign(r,e)}var hf=class{};function Wh(r){let e=n=>r().update(Aa(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function _s(r=32){if(qc&&typeof qc.getRandomValues=="function")return qc.getRandomValues(new Uint8Array(r));if(qc&&typeof qc.randomBytes=="function")return Uint8Array.from(qc.randomBytes(r));throw new Error("crypto.getRandomValues must be defined")}function B$(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let o=BigInt(32),i=BigInt(4294967295),s=Number(t>>o&i),a=Number(t&i),c=n?4:0,l=n?0:4;r.setUint32(e+c,s,n),r.setUint32(e+l,a,n)}function eg(r,e,t){return r&e^~r&t}function tg(r,e,t){return r&e^r&t^e&t}var Gc=class extends hf{constructor(e,t,n,o){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=o,this.buffer=new Uint8Array(e),this.view=Wc(this.buffer)}update(e){mf(this),e=Aa(e),Ir(e);let{view:t,buffer:n,blockLen:o}=this,i=e.length;for(let s=0;s<i;){let a=Math.min(o-this.pos,i-s);if(a===o){let c=Wc(e);for(;o<=i-s;s+=o)this.process(c,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===o&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){mf(this),bS(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:o,isLE:i}=this,{pos:s}=this;t[s++]=128,Zr(this.buffer.subarray(s)),this.padOffset>o-s&&(this.process(n,0),s=0);for(let f=s;f<o;f++)t[f]=0;B$(n,o-8,BigInt(this.length*8),i),this.process(n,0);let a=Wc(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let l=c/4,u=this.get();if(l>u.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<l;f++)a.setUint32(4*f,u[f],i)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:o,finished:i,destroyed:s,pos:a}=this;return e.destroyed=s,e.finished=i,e.length=o,e.pos=a,o%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}},Cs=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);var Tr=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]);var rg=BigInt(4294967295),SS=BigInt(32);function M$(r,e=!1){return e?{h:Number(r&rg),l:Number(r>>SS&rg)}:{h:Number(r>>SS&rg)|0,l:Number(r&rg)|0}}function _S(r,e=!1){let t=r.length,n=new Uint32Array(t),o=new Uint32Array(t);for(let i=0;i<t;i++){let{h:s,l:a}=M$(r[i],e);[n[i],o[i]]=[s,a]}return[n,o]}var $w=(r,e,t)=>r>>>t,Vw=(r,e,t)=>r<<32-t|e>>>t,Xc=(r,e,t)=>r>>>t|e<<32-t,Yc=(r,e,t)=>r<<32-t|e>>>t,Gh=(r,e,t)=>r<<64-t|e>>>t-32,Xh=(r,e,t)=>r>>>t-32|e<<64-t;function Ui(r,e,t,n){let o=(e>>>0)+(n>>>0);return{h:r+t+(o/2**32|0)|0,l:o|0}}var CS=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),IS=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,TS=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),kS=(r,e,t,n,o)=>e+t+n+o+(r/2**32|0)|0,PS=(r,e,t,n,o)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(o>>>0),RS=(r,e,t,n,o,i)=>e+t+n+o+i+(r/2**32|0)|0;var F$=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Ea=new Uint32Array(64),ng=class extends Gc{constructor(e=32){super(64,e,8,!1),this.A=Cs[0]|0,this.B=Cs[1]|0,this.C=Cs[2]|0,this.D=Cs[3]|0,this.E=Cs[4]|0,this.F=Cs[5]|0,this.G=Cs[6]|0,this.H=Cs[7]|0}get(){let{A:e,B:t,C:n,D:o,E:i,F:s,G:a,H:c}=this;return[e,t,n,o,i,s,a,c]}set(e,t,n,o,i,s,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=o|0,this.E=i|0,this.F=s|0,this.G=a|0,this.H=c|0}process(e,t){for(let f=0;f<16;f++,t+=4)Ea[f]=e.getUint32(t,!1);for(let f=16;f<64;f++){let h=Ea[f-15],d=Ea[f-2],m=ei(h,7)^ei(h,18)^h>>>3,g=ei(d,17)^ei(d,19)^d>>>10;Ea[f]=g+Ea[f-7]+m+Ea[f-16]|0}let{A:n,B:o,C:i,D:s,E:a,F:c,G:l,H:u}=this;for(let f=0;f<64;f++){let h=ei(a,6)^ei(a,11)^ei(a,25),d=u+h+eg(a,c,l)+F$[f]+Ea[f]|0,g=(ei(n,2)^ei(n,13)^ei(n,22))+tg(n,o,i)|0;u=l,l=c,c=a,a=s+d|0,s=i,i=o,o=n,n=d+g|0}n=n+this.A|0,o=o+this.B|0,i=i+this.C|0,s=s+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,u=u+this.H|0,this.set(n,o,i,s,a,c,l,u)}roundClean(){Zr(Ea)}destroy(){this.set(0,0,0,0,0,0,0,0),Zr(this.buffer)}};var DS=_S(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),H$=DS[0],$$=DS[1],Sa=new Uint32Array(80),_a=new Uint32Array(80),og=class extends Gc{constructor(e=64){super(128,e,16,!1),this.Ah=Tr[0]|0,this.Al=Tr[1]|0,this.Bh=Tr[2]|0,this.Bl=Tr[3]|0,this.Ch=Tr[4]|0,this.Cl=Tr[5]|0,this.Dh=Tr[6]|0,this.Dl=Tr[7]|0,this.Eh=Tr[8]|0,this.El=Tr[9]|0,this.Fh=Tr[10]|0,this.Fl=Tr[11]|0,this.Gh=Tr[12]|0,this.Gl=Tr[13]|0,this.Hh=Tr[14]|0,this.Hl=Tr[15]|0}get(){let{Ah:e,Al:t,Bh:n,Bl:o,Ch:i,Cl:s,Dh:a,Dl:c,Eh:l,El:u,Fh:f,Fl:h,Gh:d,Gl:m,Hh:g,Hl:w}=this;return[e,t,n,o,i,s,a,c,l,u,f,h,d,m,g,w]}set(e,t,n,o,i,s,a,c,l,u,f,h,d,m,g,w){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=o|0,this.Ch=i|0,this.Cl=s|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=u|0,this.Fh=f|0,this.Fl=h|0,this.Gh=d|0,this.Gl=m|0,this.Hh=g|0,this.Hl=w|0}process(e,t){for(let A=0;A<16;A++,t+=4)Sa[A]=e.getUint32(t),_a[A]=e.getUint32(t+=4);for(let A=16;A<80;A++){let S=Sa[A-15]|0,_=_a[A-15]|0,U=Xc(S,_,1)^Xc(S,_,8)^$w(S,_,7),k=Yc(S,_,1)^Yc(S,_,8)^Vw(S,_,7),P=Sa[A-2]|0,E=_a[A-2]|0,D=Xc(P,E,19)^Gh(P,E,61)^$w(P,E,6),C=Yc(P,E,19)^Xh(P,E,61)^Vw(P,E,6),R=TS(k,C,_a[A-7],_a[A-16]),T=kS(R,U,D,Sa[A-7],Sa[A-16]);Sa[A]=T|0,_a[A]=R|0}let{Ah:n,Al:o,Bh:i,Bl:s,Ch:a,Cl:c,Dh:l,Dl:u,Eh:f,El:h,Fh:d,Fl:m,Gh:g,Gl:w,Hh:x,Hl:v}=this;for(let A=0;A<80;A++){let S=Xc(f,h,14)^Xc(f,h,18)^Gh(f,h,41),_=Yc(f,h,14)^Yc(f,h,18)^Xh(f,h,41),U=f&d^~f&g,k=h&m^~h&w,P=PS(v,_,k,$$[A],_a[A]),E=RS(P,x,S,U,H$[A],Sa[A]),D=P|0,C=Xc(n,o,28)^Gh(n,o,34)^Gh(n,o,39),R=Yc(n,o,28)^Xh(n,o,34)^Xh(n,o,39),T=n&i^n&a^i&a,V=o&s^o&c^s&c;x=g|0,v=w|0,g=d|0,w=m|0,d=f|0,m=h|0,{h:f,l:h}=Ui(l|0,u|0,E|0,D|0),l=a|0,u=c|0,a=i|0,c=s|0,i=n|0,s=o|0;let F=CS(D,R,V);n=IS(F,E,C,T),o=F|0}({h:n,l:o}=Ui(this.Ah|0,this.Al|0,n|0,o|0)),{h:i,l:s}=Ui(this.Bh|0,this.Bl|0,i|0,s|0),{h:a,l:c}=Ui(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:u}=Ui(this.Dh|0,this.Dl|0,l|0,u|0),{h:f,l:h}=Ui(this.Eh|0,this.El|0,f|0,h|0),{h:d,l:m}=Ui(this.Fh|0,this.Fl|0,d|0,m|0),{h:g,l:w}=Ui(this.Gh|0,this.Gl|0,g|0,w|0),{h:x,l:v}=Ui(this.Hh|0,this.Hl|0,x|0,v|0),this.set(n,o,i,s,a,c,l,u,f,h,d,m,g,w,x,v)}roundClean(){Zr(Sa,_a)}destroy(){Zr(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}};var ig=Wh(()=>new ng);var sg=Wh(()=>new og);var qw=BigInt(0),zw=BigInt(1);function Is(r,e){if(typeof e!="boolean")throw new Error(r+" boolean expected, got "+e)}function Yh(r){let e=r.toString(16);return e.length&1?"0"+e:e}function NS(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?qw:BigInt("0x"+r)}function yf(r){return NS(Mi(r))}function Fi(r){return Ir(r),NS(Mi(Uint8Array.from(r).reverse()))}function ag(r,e){return gf(r.toString(16).padStart(e*2,"0"))}function Ca(r,e){return ag(r,e).reverse()}function gt(r,e,t){let n;if(typeof e=="string")try{n=gf(e)}catch(i){throw new Error(r+" must be hex string or Uint8Array, cause: "+i)}else if(pf(e))n=Uint8Array.from(e);else throw new Error(r+" must be hex string or Uint8Array");let o=n.length;if(typeof t=="number"&&o!==t)throw new Error(r+" of length "+t+" expected, got "+o);return n}var Kw=r=>typeof r=="bigint"&&qw<=r;function OS(r,e,t){return Kw(r)&&Kw(e)&&Kw(t)&&e<=r&&r<t}function ti(r,e,t,n){if(!OS(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function LS(r){let e;for(e=0;r>qw;r>>=zw,e+=1);return e}var Qc=r=>(zw<<BigInt(r))-zw;function BS(r,e,t){if(typeof r!="number"||r<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");let n=d=>new Uint8Array(d),o=d=>Uint8Array.of(d),i=n(r),s=n(r),a=0,c=()=>{i.fill(1),s.fill(0),a=0},l=(...d)=>t(s,i,...d),u=(d=n(0))=>{s=l(o(0),d),i=l(),d.length!==0&&(s=l(o(1),d),i=l())},f=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let d=0,m=[];for(;d<e;){i=l();let g=i.slice();m.push(g),d+=i.length}return eo(...m)};return(d,m)=>{c(),u(d);let g;for(;!(g=m(f()));)u();return c(),g}}function Hi(r,e,t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(o,i,s){let a=r[o];if(s&&a===void 0)return;let c=typeof a;if(c!==i||a===null)throw new Error(`param "${o}" is invalid: expected ${i}, got ${c}`)}Object.entries(e).forEach(([o,i])=>n(o,i,!1)),Object.entries(t).forEach(([o,i])=>n(o,i,!0))}function wf(r){let e=new WeakMap;return(t,...n)=>{let o=e.get(t);if(o!==void 0)return o;let i=r(t,...n);return e.set(t,i),i}}var pn=BigInt(0),vr=BigInt(1),Zc=BigInt(2),V$=BigInt(3),FS=BigInt(4),HS=BigInt(5),$S=BigInt(8);function xt(r,e){let t=r%e;return t>=pn?t:e+t}function St(r,e,t){let n=r;for(;e-- >pn;)n*=n,n%=t;return n}function MS(r,e){if(r===pn)throw new Error("invert: expected non-zero number");if(e<=pn)throw new Error("invert: expected positive modulus, got "+e);let t=xt(r,e),n=e,o=pn,i=vr,s=vr,a=pn;for(;t!==pn;){let l=n/t,u=n%t,f=o-s*l,h=i-a*l;n=t,t=u,o=s,i=a,s=f,a=h}if(n!==vr)throw new Error("invert: does not exist");return xt(o,e)}function VS(r,e){let t=(r.ORDER+vr)/FS,n=r.pow(e,t);if(!r.eql(r.sqr(n),e))throw new Error("Cannot find square root");return n}function K$(r,e){let t=(r.ORDER-HS)/$S,n=r.mul(e,Zc),o=r.pow(n,t),i=r.mul(e,o),s=r.mul(r.mul(i,Zc),o),a=r.mul(i,r.sub(s,r.ONE));if(!r.eql(r.sqr(a),e))throw new Error("Cannot find square root");return a}function z$(r){if(r<BigInt(3))throw new Error("sqrt is not defined for small field");let e=r-vr,t=0;for(;e%Zc===pn;)e/=Zc,t++;let n=Zc,o=ri(r);for(;US(o,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return VS;let i=o.pow(n,e),s=(e+vr)/Zc;return function(c,l){if(c.is0(l))return l;if(US(c,l)!==1)throw new Error("Cannot find square root");let u=t,f=c.mul(c.ONE,i),h=c.pow(l,e),d=c.pow(l,s);for(;!c.eql(h,c.ONE);){if(c.is0(h))return c.ZERO;let m=1,g=c.sqr(h);for(;!c.eql(g,c.ONE);)if(m++,g=c.sqr(g),m===u)throw new Error("Cannot find square root");let w=vr<<BigInt(u-m-1),x=c.pow(f,w);u=m,f=c.sqr(x),h=c.mul(h,f),d=c.mul(d,x)}return d}}function q$(r){return r%FS===V$?VS:r%$S===HS?K$:z$(r)}var KS=(r,e)=>(xt(r,e)&vr)===vr,j$=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function jw(r){let e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},t=j$.reduce((n,o)=>(n[o]="function",n),e);return Hi(r,t),r}function W$(r,e,t){if(t<pn)throw new Error("invalid exponent, negatives unsupported");if(t===pn)return r.ONE;if(t===vr)return e;let n=r.ONE,o=e;for(;t>pn;)t&vr&&(n=r.mul(n,o)),o=r.sqr(o),t>>=vr;return n}function Qh(r,e,t=!1){let n=new Array(e.length).fill(t?r.ZERO:void 0),o=e.reduce((s,a,c)=>r.is0(a)?s:(n[c]=s,r.mul(s,a)),r.ONE),i=r.inv(o);return e.reduceRight((s,a,c)=>r.is0(a)?s:(n[c]=r.mul(s,n[c]),r.mul(s,a)),i),n}function US(r,e){let t=(r.ORDER-vr)/Zc,n=r.pow(e,t),o=r.eql(n,r.ONE),i=r.eql(n,r.ZERO),s=r.eql(n,r.neg(r.ONE));if(!o&&!i&&!s)throw new Error("invalid Legendre symbol result");return o?1:i?0:-1}function zS(r,e){e!==void 0&&Jo(e);let t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}function ri(r,e,t=!1,n={}){if(r<=pn)throw new Error("invalid field: expected ORDER > 0, got "+r);let o,i;if(typeof e=="object"&&e!=null){if(n.sqrt||t)throw new Error("cannot specify opts in two arguments");let u=e;u.BITS&&(o=u.BITS),u.sqrt&&(i=u.sqrt),typeof u.isLE=="boolean"&&(t=u.isLE)}else typeof e=="number"&&(o=e),n.sqrt&&(i=n.sqrt);let{nBitLength:s,nByteLength:a}=zS(r,o);if(a>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let c,l=Object.freeze({ORDER:r,isLE:t,BITS:s,BYTES:a,MASK:Qc(s),ZERO:pn,ONE:vr,create:u=>xt(u,r),isValid:u=>{if(typeof u!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof u);return pn<=u&&u<r},is0:u=>u===pn,isValidNot0:u=>!l.is0(u)&&l.isValid(u),isOdd:u=>(u&vr)===vr,neg:u=>xt(-u,r),eql:(u,f)=>u===f,sqr:u=>xt(u*u,r),add:(u,f)=>xt(u+f,r),sub:(u,f)=>xt(u-f,r),mul:(u,f)=>xt(u*f,r),pow:(u,f)=>W$(l,u,f),div:(u,f)=>xt(u*MS(f,r),r),sqrN:u=>u*u,addN:(u,f)=>u+f,subN:(u,f)=>u-f,mulN:(u,f)=>u*f,inv:u=>MS(u,r),sqrt:i||(u=>(c||(c=q$(r)),c(l,u))),toBytes:u=>t?Ca(u,a):ag(u,a),fromBytes:u=>{if(u.length!==a)throw new Error("Field.fromBytes: expected "+a+" bytes, got "+u.length);return t?Fi(u):yf(u)},invertBatch:u=>Qh(l,u),cmov:(u,f,h)=>h?f:u});return Object.freeze(l)}function qS(r){if(typeof r!="bigint")throw new Error("field order must be bigint");let e=r.toString(2).length;return Math.ceil(e/8)}function Ww(r){let e=qS(r);return e+Math.ceil(e/2)}function jS(r,e,t=!1){let n=r.length,o=qS(e),i=Ww(e);if(n<16||n<i||n>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+n);let s=t?Fi(r):yf(r),a=xt(s,e-vr)+vr;return t?Ca(a,o):ag(a,o)}var bf=BigInt(0),Jc=BigInt(1);function xf(r,e){let t=e.negate();return r?t:e}function cg(r,e,t){let n=e==="pz"?s=>s.pz:s=>s.ez,o=Qh(r.Fp,t.map(n));return t.map((s,a)=>s.toAffine(o[a])).map(r.fromAffine)}function YS(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function Gw(r,e){YS(r,e);let t=Math.ceil(e/r)+1,n=2**(r-1),o=2**r,i=Qc(r),s=BigInt(r);return{windows:t,windowSize:n,mask:i,maxNumber:o,shiftBy:s}}function WS(r,e,t){let{windowSize:n,mask:o,maxNumber:i,shiftBy:s}=t,a=Number(r&o),c=r>>s;a>n&&(a-=i,c+=Jc);let l=e*n,u=l+Math.abs(a)-1,f=a===0,h=a<0,d=e%2!==0;return{nextN:c,offset:u,isZero:f,isNeg:h,isNegF:d,offsetF:l}}function G$(r,e){if(!Array.isArray(r))throw new Error("array expected");r.forEach((t,n)=>{if(!(t instanceof e))throw new Error("invalid point at index "+n)})}function X$(r,e){if(!Array.isArray(r))throw new Error("array of scalars expected");r.forEach((t,n)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+n)})}var Xw=new WeakMap,QS=new WeakMap;function Yw(r){return QS.get(r)||1}function GS(r){if(r!==bf)throw new Error("invalid wNAF")}function lg(r,e){return{constTimeNegate:xf,hasPrecomputes(t){return Yw(t)!==1},unsafeLadder(t,n,o=r.ZERO){let i=t;for(;n>bf;)n&Jc&&(o=o.add(i)),i=i.double(),n>>=Jc;return o},precomputeWindow(t,n){let{windows:o,windowSize:i}=Gw(n,e),s=[],a=t,c=a;for(let l=0;l<o;l++){c=a,s.push(c);for(let u=1;u<i;u++)c=c.add(a),s.push(c);a=c.double()}return s},wNAF(t,n,o){let i=r.ZERO,s=r.BASE,a=Gw(t,e);for(let c=0;c<a.windows;c++){let{nextN:l,offset:u,isZero:f,isNeg:h,isNegF:d,offsetF:m}=WS(o,c,a);o=l,f?s=s.add(xf(d,n[m])):i=i.add(xf(h,n[u]))}return GS(o),{p:i,f:s}},wNAFUnsafe(t,n,o,i=r.ZERO){let s=Gw(t,e);for(let a=0;a<s.windows&&o!==bf;a++){let{nextN:c,offset:l,isZero:u,isNeg:f}=WS(o,a,s);if(o=c,!u){let h=n[l];i=i.add(f?h.negate():h)}}return GS(o),i},getPrecomputes(t,n,o){let i=Xw.get(n);return i||(i=this.precomputeWindow(n,t),t!==1&&(typeof o=="function"&&(i=o(i)),Xw.set(n,i))),i},wNAFCached(t,n,o){let i=Yw(t);return this.wNAF(i,this.getPrecomputes(i,t,o),n)},wNAFCachedUnsafe(t,n,o,i){let s=Yw(t);return s===1?this.unsafeLadder(t,n,i):this.wNAFUnsafe(s,this.getPrecomputes(s,t,o),n,i)},setWindowSize(t,n){YS(n,e),QS.set(t,n),Xw.delete(t)}}}function ZS(r,e,t,n){let o=e,i=r.ZERO,s=r.ZERO;for(;t>bf||n>bf;)t&Jc&&(i=i.add(o)),n&Jc&&(s=s.add(o)),o=o.double(),t>>=Jc,n>>=Jc;return{p1:i,p2:s}}function ug(r,e,t,n){G$(t,r),X$(n,e);let o=t.length,i=n.length;if(o!==i)throw new Error("arrays of points and scalars must have equal length");let s=r.ZERO,a=LS(BigInt(o)),c=1;a>12?c=a-3:a>4?c=a-2:a>0&&(c=2);let l=Qc(c),u=new Array(Number(l)+1).fill(s),f=Math.floor((e.BITS-1)/c)*c,h=s;for(let d=f;d>=0;d-=c){u.fill(s);for(let g=0;g<i;g++){let w=n[g],x=Number(w>>BigInt(d)&l);u[x]=u[x].add(t[g])}let m=s;for(let g=u.length-1,w=s;g>0;g--)w=w.add(u[g]),m=m.add(w);if(h=h.add(m),d!==0)for(let g=0;g<c;g++)h=h.double()}return h}function XS(r,e){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return jw(e),e}else return ri(r)}function fg(r,e,t={}){if(!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(let a of["p","n","h"]){let c=e[a];if(!(typeof c=="bigint"&&c>bf))throw new Error(`CURVE.${a} must be positive bigint`)}let n=XS(e.p,t.Fp),o=XS(e.n,t.Fn),s=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(let a of s)if(!n.isValid(e[a]))throw new Error(`CURVE.${a} must be valid field element of CURVE.Fp`);return{Fp:n,Fn:o}}var $i=BigInt(0),mn=BigInt(1),Qw=BigInt(2),Y$=BigInt(8),Q$={zip215:!0};function Z$(r,e,t,n){let o=r.sqr(t),i=r.sqr(n),s=r.add(r.mul(e.a,o),i),a=r.add(r.ONE,r.mul(e.d,r.mul(o,i)));return r.eql(s,a)}function J$(r,e={}){let{Fp:t,Fn:n}=fg("edwards",r,e),{h:o,n:i}=r;Hi(e,{},{uvRatio:"function"});let s=Qw<<BigInt(n.BYTES*8)-mn,a=g=>t.create(g),c=e.uvRatio||((g,w)=>{try{return{isValid:!0,value:t.sqrt(t.div(g,w))}}catch{return{isValid:!1,value:$i}}});if(!Z$(t,r,r.Gx,r.Gy))throw new Error("bad curve params: generator point");function l(g,w,x=!1){let v=x?mn:$i;return ti("coordinate "+g,w,v,s),w}function u(g){if(!(g instanceof d))throw new Error("ExtendedPoint expected")}let f=wf((g,w)=>{let{ex:x,ey:v,ez:A}=g,S=g.is0();w==null&&(w=S?Y$:t.inv(A));let _=a(x*w),U=a(v*w),k=a(A*w);if(S)return{x:$i,y:mn};if(k!==mn)throw new Error("invZ was invalid");return{x:_,y:U}}),h=wf(g=>{let{a:w,d:x}=r;if(g.is0())throw new Error("bad point: ZERO");let{ex:v,ey:A,ez:S,et:_}=g,U=a(v*v),k=a(A*A),P=a(S*S),E=a(P*P),D=a(U*w),C=a(P*a(D+k)),R=a(E+a(x*a(U*k)));if(C!==R)throw new Error("bad point: equation left != right (1)");let T=a(v*A),V=a(S*_);if(T!==V)throw new Error("bad point: equation left != right (2)");return!0});class d{constructor(w,x,v,A){this.ex=l("x",w),this.ey=l("y",x),this.ez=l("z",v,!0),this.et=l("t",A),Object.freeze(this)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static fromAffine(w){if(w instanceof d)throw new Error("extended point not allowed");let{x,y:v}=w||{};return l("x",x),l("y",v),new d(x,v,mn,a(x*v))}static normalizeZ(w){return cg(d,"ez",w)}static msm(w,x){return ug(d,n,w,x)}_setWindowSize(w){this.precompute(w)}precompute(w=8,x=!0){return m.setWindowSize(this,w),x||this.multiply(Qw),this}assertValidity(){h(this)}equals(w){u(w);let{ex:x,ey:v,ez:A}=this,{ex:S,ey:_,ez:U}=w,k=a(x*U),P=a(S*A),E=a(v*U),D=a(_*A);return k===P&&E===D}is0(){return this.equals(d.ZERO)}negate(){return new d(a(-this.ex),this.ey,this.ez,a(-this.et))}double(){let{a:w}=r,{ex:x,ey:v,ez:A}=this,S=a(x*x),_=a(v*v),U=a(Qw*a(A*A)),k=a(w*S),P=x+v,E=a(a(P*P)-S-_),D=k+_,C=D-U,R=k-_,T=a(E*C),V=a(D*R),F=a(E*R),H=a(C*D);return new d(T,V,H,F)}add(w){u(w);let{a:x,d:v}=r,{ex:A,ey:S,ez:_,et:U}=this,{ex:k,ey:P,ez:E,et:D}=w,C=a(A*k),R=a(S*P),T=a(U*v*D),V=a(_*E),F=a((A+S)*(k+P)-C-R),H=V-T,Y=V+T,Q=a(R-x*C),X=a(F*H),me=a(Y*Q),oe=a(F*Q),G=a(H*Y);return new d(X,me,G,oe)}subtract(w){return this.add(w.negate())}multiply(w){let x=w;ti("scalar",x,mn,i);let{p:v,f:A}=m.wNAFCached(this,x,d.normalizeZ);return d.normalizeZ([v,A])[0]}multiplyUnsafe(w,x=d.ZERO){let v=w;return ti("scalar",v,$i,i),v===$i?d.ZERO:this.is0()||v===mn?this:m.wNAFCachedUnsafe(this,v,d.normalizeZ,x)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}isTorsionFree(){return m.wNAFCachedUnsafe(this,i).is0()}toAffine(w){return f(this,w)}clearCofactor(){return o===mn?this:this.multiplyUnsafe(o)}static fromBytes(w,x=!1){return Ir(w),this.fromHex(w,x)}static fromHex(w,x=!1){let{d:v,a:A}=r,S=t.BYTES;w=gt("pointHex",w,S),Is("zip215",x);let _=w.slice(),U=w[S-1];_[S-1]=U&-129;let k=Fi(_),P=x?s:t.ORDER;ti("pointHex.y",k,$i,P);let E=a(k*k),D=a(E-mn),C=a(v*E-A),{isValid:R,value:T}=c(D,C);if(!R)throw new Error("Point.fromHex: invalid y coordinate");let V=(T&mn)===mn,F=(U&128)!==0;if(!x&&T===$i&&F)throw new Error("Point.fromHex: x=0 and x_0=1");return F!==V&&(T=a(-T)),d.fromAffine({x:T,y:k})}static fromPrivateScalar(w){return d.BASE.multiply(w)}toBytes(){let{x:w,y:x}=this.toAffine(),v=Ca(x,t.BYTES);return v[v.length-1]|=w&mn?128:0,v}toRawBytes(){return this.toBytes()}toHex(){return Mi(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}d.BASE=new d(r.Gx,r.Gy,mn,a(r.Gx*r.Gy)),d.ZERO=new d($i,mn,mn,$i),d.Fp=t,d.Fn=n;let m=lg(d,n.BYTES*8);return d}function eV(r,e){Hi(e,{hash:"function"},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});let{prehash:t,hash:n}=e,{BASE:o,Fp:i,Fn:s}=r,a=s.ORDER,c=e.randomBytes||_s,l=e.adjustScalarBytes||(_=>_),u=e.domain||((_,U,k)=>{if(Is("phflag",k),U.length||k)throw new Error("Contexts/pre-hash are not supported");return _});function f(_){return s.create(_)}function h(_){return f(Fi(_))}function d(_){let U=i.BYTES;_=gt("private key",_,U);let k=gt("hashed private key",n(_),2*U),P=l(k.slice(0,U)),E=k.slice(U,2*U),D=h(P);return{head:P,prefix:E,scalar:D}}function m(_){let{head:U,prefix:k,scalar:P}=d(_),E=o.multiply(P),D=E.toBytes();return{head:U,prefix:k,scalar:P,point:E,pointBytes:D}}function g(_){return m(_).pointBytes}function w(_=Uint8Array.of(),...U){let k=eo(...U);return h(n(u(k,gt("context",_),!!t)))}function x(_,U,k={}){_=gt("message",_),t&&(_=t(_));let{prefix:P,scalar:E,pointBytes:D}=m(U),C=w(k.context,P,_),R=o.multiply(C).toBytes(),T=w(k.context,R,D,_),V=f(C+T*E);ti("signature.s",V,$i,a);let F=i.BYTES,H=eo(R,Ca(V,F));return gt("result",H,F*2)}let v=Q$;function A(_,U,k,P=v){let{context:E,zip215:D}=P,C=i.BYTES;_=gt("signature",_,2*C),U=gt("message",U),k=gt("publicKey",k,C),D!==void 0&&Is("zip215",D),t&&(U=t(U));let R=Fi(_.slice(C,2*C)),T,V,F;try{T=r.fromHex(k,D),V=r.fromHex(_.slice(0,C),D),F=o.multiplyUnsafe(R)}catch{return!1}if(!D&&T.isSmallOrder())return!1;let H=w(E,V.toBytes(),T.toBytes(),U);return V.add(T.multiplyUnsafe(H)).subtract(F).clearCofactor().is0()}return o.precompute(8),{getPublicKey:g,sign:x,verify:A,utils:{getExtendedPublicKey:m,randomPrivateKey:()=>c(i.BYTES),precompute(_=8,U=r.BASE){return U.precompute(_,!1)}},Point:r}}function tV(r){let e={a:r.a,d:r.d,p:r.Fp.ORDER,n:r.n,h:r.h,Gx:r.Gx,Gy:r.Gy},t=r.Fp,n=ri(e.n,r.nBitLength,!0),o={Fp:t,Fn:n,uvRatio:r.uvRatio},i={hash:r.hash,randomBytes:r.randomBytes,adjustScalarBytes:r.adjustScalarBytes,domain:r.domain,prehash:r.prehash,mapToCurve:r.mapToCurve};return{CURVE:e,curveOpts:o,eddsaOpts:i}}function rV(r,e){return Object.assign({},e,{ExtendedPoint:e.Point,CURVE:r})}function JS(r){let{CURVE:e,curveOpts:t,eddsaOpts:n}=tV(r),o=J$(e,t),i=eV(o,n);return rV(r,i)}var Zh=BigInt(0),vf=BigInt(1),dg=BigInt(2);function nV(r){return Hi(r,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...r})}function e_(r){let e=nV(r),{P:t,type:n,adjustScalarBytes:o,powPminus2:i,randomBytes:s}=e,a=n==="x25519";if(!a&&n!=="x448")throw new Error("invalid type");let c=s||_s,l=a?255:448,u=a?32:56,f=BigInt(a?9:5),h=BigInt(a?121665:39081),d=a?dg**BigInt(254):dg**BigInt(447),m=a?BigInt(8)*dg**BigInt(251)-vf:BigInt(4)*dg**BigInt(445)-vf,g=d+m+vf,w=E=>xt(E,t),x=v(f);function v(E){return Ca(w(E),u)}function A(E){let D=gt("u coordinate",E,u);return a&&(D[31]&=127),w(Fi(D))}function S(E){return Fi(o(gt("scalar",E,u)))}function _(E,D){let C=P(A(D),S(E));if(C===Zh)throw new Error("invalid private or public key received");return v(C)}function U(E){return _(E,x)}function k(E,D,C){let R=w(E*(D-C));return D=w(D-R),C=w(C+R),{x_2:D,x_3:C}}function P(E,D){ti("u",E,Zh,t),ti("scalar",D,d,g);let C=D,R=E,T=vf,V=Zh,F=E,H=vf,Y=Zh;for(let X=BigInt(l-1);X>=Zh;X--){let me=C>>X&vf;Y^=me,{x_2:T,x_3:F}=k(Y,T,F),{x_2:V,x_3:H}=k(Y,V,H),Y=me;let oe=T+V,G=w(oe*oe),Te=T-V,et=w(Te*Te),ue=G-et,it=F+H,rr=F-H,Bt=w(rr*oe),Mt=w(it*Te),pr=Bt+Mt,un=Bt-Mt;F=w(pr*pr),H=w(R*w(un*un)),T=w(G*et),V=w(ue*(G+w(h*ue)))}({x_2:T,x_3:F}=k(Y,T,F)),{x_2:V,x_3:H}=k(Y,V,H);let Q=i(V);return w(T*Q)}return{scalarMult:_,scalarMultBase:U,getSharedSecret:(E,D)=>_(E,D),getPublicKey:E=>U(E),utils:{randomPrivateKey:()=>c(u)},GuBytes:x.slice()}}var Ase=BigInt(0),oV=BigInt(1),t_=BigInt(2),iV=BigInt(3),sV=BigInt(5),aV=BigInt(8),Jh={p:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:aV,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function n_(r){let e=BigInt(10),t=BigInt(20),n=BigInt(40),o=BigInt(80),i=Jh.p,a=r*r%i*r%i,c=St(a,t_,i)*a%i,l=St(c,oV,i)*r%i,u=St(l,sV,i)*l%i,f=St(u,e,i)*u%i,h=St(f,t,i)*f%i,d=St(h,n,i)*h%i,m=St(d,o,i)*d%i,g=St(m,o,i)*d%i,w=St(g,e,i)*u%i;return{pow_p_5_8:St(w,t_,i)*r%i,b2:a}}function o_(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}var r_=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function cV(r,e){let t=Jh.p,n=xt(e*e*e,t),o=xt(n*n*e,t),i=n_(r*o).pow_p_5_8,s=xt(r*n*i,t),a=xt(e*s*s,t),c=s,l=xt(s*r_,t),u=a===r,f=a===xt(-r,t),h=a===xt(-r*r_,t);return u&&(s=c),(f||h)&&(s=l),KS(s,t)&&(s=xt(-s,t)),{isValid:u||f,value:s}}var lV=ri(Jh.p,void 0,!0),uV={...Jh,Fp:lV,hash:sg,adjustScalarBytes:o_,uvRatio:cV},ep=JS(uV);var tp=(()=>{let r=Jh.p;return e_({P:r,type:"x25519",powPminus2:e=>{let{pow_p_5_8:t,b2:n}=n_(e);return xt(St(t,iV,r)*n,r)},adjustScalarBytes:o_})})();var rp=class extends Error{constructor(e="An error occurred while signing a message"){super(e),this.name="SigningError"}},np=class extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}},hg=class extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}};var i_={get(r=globalThis){let e=r.crypto;if(e?.subtle==null)throw new hg("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};var ar=i_;var el=32,to=64,Zw=32;var Af,s_=(async()=>{try{return await ar.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();function a_(){let r=ep.utils.randomPrivateKey(),e=ep.getPublicKey(r);return{privateKey:mV(r,e),publicKey:e}}async function fV(r,e){let t;r.length===to?t=r.subarray(0,32):t=r;let n={crv:"Ed25519",kty:"OKP",x:K(r.subarray(32),"base64url"),d:K(t,"base64url"),ext:!0,key_ops:["sign"]},o=await ar.get().subtle.importKey("jwk",n,{name:"Ed25519"},!0,["sign"]),i=await ar.get().subtle.sign({name:"Ed25519"},o,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(i,0,i.byteLength)}function dV(r,e){let t=r.subarray(0,Zw);return ep.sign(e instanceof Uint8Array?e:e.subarray(),t)}async function c_(r,e){return Af==null&&(Af=await s_),Af?fV(r,e):dV(r,e)}async function hV(r,e,t){if(r.buffer instanceof ArrayBuffer){let n=await ar.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await ar.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function pV(r,e,t){return ep.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function l_(r,e,t){return Af==null&&(Af=await s_),Af?hV(r,e,t):pV(r,e,t)}function mV(r,e){let t=new Uint8Array(to);for(let n=0;n<Zw;n++)t[n]=r[n],t[Zw+n]=e[n];return t}function Ef(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var op=class{type="Ed25519";raw;constructor(e){this.raw=_f(e,el)}toMultihash(){return ir.digest(sr(this))}toCID(){return q.createV1(114,this.toMultihash())}toString(){return Ve.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:de(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();let o=l_(this.raw,t,e);return Ef(o)?o.then(i=>(n?.signal?.throwIfAborted(),i)):o}},Sf=class{type="Ed25519";raw;publicKey;constructor(e,t){this.raw=_f(e,to),this.publicKey=new op(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:de(this.raw,e.raw)}sign(e,t){t?.signal?.throwIfAborted();let n=c_(this.raw,e);return Ef(n)?n.then(o=>(t?.signal?.throwIfAborted(),o)):(t?.signal?.throwIfAborted(),n)}};function Jw(r){if(r.length>to){r=_f(r,to+el);let n=r.subarray(0,to),o=r.subarray(to,r.length);return new Sf(n,o)}r=_f(r,to);let e=r.subarray(0,to),t=r.subarray(el);return new Sf(e,t)}function e7(r){return r=_f(r,el),new op(r)}async function f_(){let{privateKey:r,publicKey:e}=a_();return new Sf(r,e)}function _f(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new $(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}var bt;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(bt||(bt={}));var t7;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(t7||(t7={}));(function(r){r.codec=()=>wt(t7)})(bt||(bt={}));var Vi;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),bt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.Type=bt.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(Vi||(Vi={}));var ip;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),bt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.Type=bt.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(ip||(ip={}));function gn(r){if(isNaN(r)||r<=0)throw new $("random bytes length must be a Number bigger than 0");return _s(r)}var ap={};Ut(ap,{MAX_RSA_KEY_SIZE:()=>r7,generateRSAKeyPair:()=>f7,jwkToJWKKeyPair:()=>m_,jwkToPkcs1:()=>xV,jwkToPkix:()=>s7,jwkToRSAPrivateKey:()=>u7,pkcs1MessageToJwk:()=>o7,pkcs1MessageToRSAPrivateKey:()=>pg,pkcs1ToJwk:()=>wV,pkcs1ToRSAPrivateKey:()=>a7,pkixMessageToJwk:()=>i7,pkixMessageToRSAPublicKey:()=>l7,pkixToJwk:()=>bV,pkixToRSAPublicKey:()=>c7});var Ki=ig;var Cf=class{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=ap.jwkToPkix(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return q.createV1(114,this._multihash)}toString(){return Ve.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:de(this.raw,e.raw)}verify(e,t,n){return p_(this.jwk,t,e,n)}},sp=class{type="RSA";jwk;_raw;publicKey;constructor(e,t){this.jwk=e,this.publicKey=t}get raw(){return this._raw==null&&(this._raw=ap.jwkToPkcs1(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:de(this.raw,e.raw)}sign(e,t){return h_(this.jwk,e,t)}};var r7=8192,n7=18,gV=1062,yV=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function wV(r){let e=Co(r);return o7(e)}function o7(r){return{n:K(r[1],"base64url"),e:K(r[2],"base64url"),d:K(r[3],"base64url"),p:K(r[4],"base64url"),q:K(r[5],"base64url"),dp:K(r[6],"base64url"),dq:K(r[7],"base64url"),qi:K(r[8],"base64url"),kty:"RSA"}}function xV(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new $("JWK was missing components");return Zo([hn(Uint8Array.from([0])),hn(L(r.n,"base64url")),hn(L(r.e,"base64url")),hn(L(r.d,"base64url")),hn(L(r.p,"base64url")),hn(L(r.q,"base64url")),hn(L(r.dp,"base64url")),hn(L(r.dq,"base64url")),hn(L(r.qi,"base64url"))]).subarray()}function bV(r){let e=Co(r,{offset:0});return i7(e)}function i7(r){let e=Co(r[1],{offset:0});return{kty:"RSA",n:K(e[0],"base64url"),e:K(e[1],"base64url")}}function s7(r){if(r.n==null||r.e==null)throw new $("JWK was missing components");return Zo([yV,jh(Zo([hn(L(r.n,"base64url")),hn(L(r.e,"base64url"))]))]).subarray()}function a7(r){let e=Co(r);return pg(e)}function pg(r){let e=o7(r);return u7(e)}function c7(r,e){if(r.byteLength>=gV)throw new ys("Key size is too large");let t=Co(r,{offset:0});return l7(t,r,e)}function l7(r,e,t){let n=i7(r);if(t==null){let o=Ki(Vi.encode({Type:bt.RSA,Data:e}));t=Qr(n7,o)}return new Cf(n,t)}function u7(r){if(y_(r)>r7)throw new $("Key size is too large");let e=m_(r),t=Ki(Vi.encode({Type:bt.RSA,Data:s7(e.publicKey)})),n=Qr(n7,t);return new sp(e.privateKey,new Cf(e.publicKey,n))}async function f7(r){if(r>r7)throw new $("Key size is too large");let e=await g_(r),t=Ki(Vi.encode({Type:bt.RSA,Data:s7(e.publicKey)})),n=Qr(n7,t);return new sp(e.privateKey,new Cf(e.publicKey,n))}function m_(r){if(r==null)throw new $("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}async function g_(r,e){let t=await ar.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]);e?.signal?.throwIfAborted();let n=await vV(t,e);return{privateKey:n[0],publicKey:n[1]}}async function h_(r,e,t){let n=await ar.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]);t?.signal?.throwIfAborted();let o=await ar.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,e instanceof Uint8Array?e:e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(o,0,o.byteLength)}async function p_(r,e,t,n){let o=await ar.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();let i=await ar.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},o,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),i}async function vV(r,e){if(r.privateKey==null||r.publicKey==null)throw new $("Private and public key are required");let t=await Promise.all([ar.get().subtle.exportKey("jwk",r.privateKey),ar.get().subtle.exportKey("jwk",r.publicKey)]);return e?.signal?.throwIfAborted(),t}function y_(r){if(r.kty!=="RSA")throw new $("invalid key type");if(r.n==null)throw new $("invalid key modulus");return L(r.n,"base64url").length*8}var mg=class extends hf{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,jc(e);let n=Aa(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let o=this.blockLen,i=new Uint8Array(o);i.set(n.length>o?e.create().update(n).digest():n);for(let s=0;s<i.length;s++)i[s]^=54;this.iHash.update(i),this.oHash=e.create();for(let s=0;s<i.length;s++)i[s]^=106;this.oHash.update(i),Zr(i)}update(e){return mf(this),this.iHash.update(e),this}digestInto(e){mf(this),Ir(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));let{oHash:t,iHash:n,finished:o,destroyed:i,blockLen:s,outputLen:a}=this;return e=e,e.finished=o,e.destroyed=i,e.blockLen=s,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},Ia=(r,e,t)=>new mg(r,e).update(t).digest();Ia.create=(r,e)=>new mg(r,e);function w_(r){r.lowS!==void 0&&Is("lowS",r.lowS),r.prehash!==void 0&&Is("prehash",r.prehash)}var d7=class extends Error{constructor(e=""){super(e)}},Ts={Err:d7,_tlv:{encode:(r,e)=>{let{Err:t}=Ts;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");let n=e.length/2,o=Yh(n);if(o.length/2&128)throw new t("tlv.encode: long form length too big");let i=n>127?Yh(o.length/2|128):"";return Yh(r)+i+o+e},decode(r,e){let{Err:t}=Ts,n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");let o=e[n++],i=!!(o&128),s=0;if(!i)s=o;else{let c=o&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");let l=e.subarray(n,n+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(let u of l)s=s<<8|u;if(n+=c,s<128)throw new t("tlv.decode(long): not minimal encoding")}let a=e.subarray(n,n+s);if(a.length!==s)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+s)}}},_int:{encode(r){let{Err:e}=Ts;if(r<cp)throw new e("integer: negative integers are not allowed");let t=Yh(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){let{Err:e}=Ts;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return yf(r)}},toSig(r){let{Err:e,_int:t,_tlv:n}=Ts,o=gt("signature",r),{v:i,l:s}=n.decode(48,o);if(s.length)throw new e("invalid signature: left bytes after parsing");let{v:a,l:c}=n.decode(2,i),{v:l,l:u}=n.decode(2,c);if(u.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(r){let{_tlv:e,_int:t}=Ts,n=e.encode(2,t.encode(r.r)),o=e.encode(2,t.encode(r.s)),i=n+o;return e.encode(48,i)}},cp=BigInt(0),lp=BigInt(1),AV=BigInt(2),gg=BigInt(3),EV=BigInt(4);function SV(r,e,t){function n(o){let i=r.sqr(o),s=r.mul(i,o);return r.add(r.add(s,r.mul(o,e)),t)}return n}function x_(r,e,t){let{BYTES:n}=r;function o(i){let s;if(typeof i=="bigint")s=i;else{let a=gt("private key",i);if(e){if(!e.includes(a.length*2))throw new Error("invalid private key");let c=new Uint8Array(n);c.set(a,c.length-a.length),a=c}try{s=r.fromBytes(a)}catch{throw new Error(`invalid private key: expected ui8a of size ${n}, got ${typeof i}`)}}if(t&&(s=r.create(s)),!r.isValidNot0(s))throw new Error("invalid private key: out of range [1..N-1]");return s}return o}function _V(r,e={}){let{Fp:t,Fn:n}=fg("weierstrass",r,e),{h:o,n:i}=r;Hi(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});let{endo:s}=e;if(s&&(!t.is0(r.a)||typeof s.beta!="bigint"||typeof s.splitScalar!="function"))throw new Error('invalid endo: expected "beta": bigint and "splitScalar": function');function a(){if(!t.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function c(P,E,D){let{x:C,y:R}=E.toAffine(),T=t.toBytes(C);if(Is("isCompressed",D),D){a();let V=!t.isOdd(R);return eo(b_(V),T)}else return eo(Uint8Array.of(4),T,t.toBytes(R))}function l(P){Ir(P);let E=t.BYTES,D=E+1,C=2*E+1,R=P.length,T=P[0],V=P.subarray(1);if(R===D&&(T===2||T===3)){let F=t.fromBytes(V);if(!t.isValid(F))throw new Error("bad point: is not on curve, wrong x");let H=h(F),Y;try{Y=t.sqrt(H)}catch(me){let oe=me instanceof Error?": "+me.message:"";throw new Error("bad point: is not on curve, sqrt error"+oe)}a();let Q=t.isOdd(Y);return(T&1)===1!==Q&&(Y=t.neg(Y)),{x:F,y:Y}}else if(R===C&&T===4){let F=t.fromBytes(V.subarray(E*0,E*1)),H=t.fromBytes(V.subarray(E*1,E*2));if(!d(F,H))throw new Error("bad point: is not on curve");return{x:F,y:H}}else throw new Error(`bad point: got length ${R}, expected compressed=${D} or uncompressed=${C}`)}let u=e.toBytes||c,f=e.fromBytes||l,h=SV(t,r.a,r.b);function d(P,E){let D=t.sqr(E),C=h(P);return t.eql(D,C)}if(!d(r.Gx,r.Gy))throw new Error("bad curve params: generator point");let m=t.mul(t.pow(r.a,gg),EV),g=t.mul(t.sqr(r.b),BigInt(27));if(t.is0(t.add(m,g)))throw new Error("bad curve params: a or b");function w(P,E,D=!1){if(!t.isValid(E)||D&&t.is0(E))throw new Error(`bad point coordinate ${P}`);return E}function x(P){if(!(P instanceof _))throw new Error("ProjectivePoint expected")}let v=wf((P,E)=>{let{px:D,py:C,pz:R}=P;if(t.eql(R,t.ONE))return{x:D,y:C};let T=P.is0();E==null&&(E=T?t.ONE:t.inv(R));let V=t.mul(D,E),F=t.mul(C,E),H=t.mul(R,E);if(T)return{x:t.ZERO,y:t.ZERO};if(!t.eql(H,t.ONE))throw new Error("invZ was invalid");return{x:V,y:F}}),A=wf(P=>{if(P.is0()){if(e.allowInfinityPoint&&!t.is0(P.py))return;throw new Error("bad point: ZERO")}let{x:E,y:D}=P.toAffine();if(!t.isValid(E)||!t.isValid(D))throw new Error("bad point: x or y not field elements");if(!d(E,D))throw new Error("bad point: equation left != right");if(!P.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function S(P,E,D,C,R){return D=new _(t.mul(D.px,P),D.py,D.pz),E=xf(C,E),D=xf(R,D),E.add(D)}class _{constructor(E,D,C){this.px=w("x",E),this.py=w("y",D,!0),this.pz=w("z",C),Object.freeze(this)}static fromAffine(E){let{x:D,y:C}=E||{};if(!E||!t.isValid(D)||!t.isValid(C))throw new Error("invalid affine point");if(E instanceof _)throw new Error("projective point not allowed");return t.is0(D)&&t.is0(C)?_.ZERO:new _(D,C,t.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(E){return cg(_,"pz",E)}static fromBytes(E){return Ir(E),_.fromHex(E)}static fromHex(E){let D=_.fromAffine(f(gt("pointHex",E)));return D.assertValidity(),D}static fromPrivateKey(E){let D=x_(n,e.allowedPrivateKeyLengths,e.wrapPrivateKey);return _.BASE.multiply(D(E))}static msm(E,D){return ug(_,n,E,D)}precompute(E=8,D=!0){return k.setWindowSize(this,E),D||this.multiply(gg),this}_setWindowSize(E){this.precompute(E)}assertValidity(){A(this)}hasEvenY(){let{y:E}=this.toAffine();if(!t.isOdd)throw new Error("Field doesn't support isOdd");return!t.isOdd(E)}equals(E){x(E);let{px:D,py:C,pz:R}=this,{px:T,py:V,pz:F}=E,H=t.eql(t.mul(D,F),t.mul(T,R)),Y=t.eql(t.mul(C,F),t.mul(V,R));return H&&Y}negate(){return new _(this.px,t.neg(this.py),this.pz)}double(){let{a:E,b:D}=r,C=t.mul(D,gg),{px:R,py:T,pz:V}=this,F=t.ZERO,H=t.ZERO,Y=t.ZERO,Q=t.mul(R,R),X=t.mul(T,T),me=t.mul(V,V),oe=t.mul(R,T);return oe=t.add(oe,oe),Y=t.mul(R,V),Y=t.add(Y,Y),F=t.mul(E,Y),H=t.mul(C,me),H=t.add(F,H),F=t.sub(X,H),H=t.add(X,H),H=t.mul(F,H),F=t.mul(oe,F),Y=t.mul(C,Y),me=t.mul(E,me),oe=t.sub(Q,me),oe=t.mul(E,oe),oe=t.add(oe,Y),Y=t.add(Q,Q),Q=t.add(Y,Q),Q=t.add(Q,me),Q=t.mul(Q,oe),H=t.add(H,Q),me=t.mul(T,V),me=t.add(me,me),Q=t.mul(me,oe),F=t.sub(F,Q),Y=t.mul(me,X),Y=t.add(Y,Y),Y=t.add(Y,Y),new _(F,H,Y)}add(E){x(E);let{px:D,py:C,pz:R}=this,{px:T,py:V,pz:F}=E,H=t.ZERO,Y=t.ZERO,Q=t.ZERO,X=r.a,me=t.mul(r.b,gg),oe=t.mul(D,T),G=t.mul(C,V),Te=t.mul(R,F),et=t.add(D,C),ue=t.add(T,V);et=t.mul(et,ue),ue=t.add(oe,G),et=t.sub(et,ue),ue=t.add(D,R);let it=t.add(T,F);return ue=t.mul(ue,it),it=t.add(oe,Te),ue=t.sub(ue,it),it=t.add(C,R),H=t.add(V,F),it=t.mul(it,H),H=t.add(G,Te),it=t.sub(it,H),Q=t.mul(X,ue),H=t.mul(me,Te),Q=t.add(H,Q),H=t.sub(G,Q),Q=t.add(G,Q),Y=t.mul(H,Q),G=t.add(oe,oe),G=t.add(G,oe),Te=t.mul(X,Te),ue=t.mul(me,ue),G=t.add(G,Te),Te=t.sub(oe,Te),Te=t.mul(X,Te),ue=t.add(ue,Te),oe=t.mul(G,ue),Y=t.add(Y,oe),oe=t.mul(it,ue),H=t.mul(et,H),H=t.sub(H,oe),oe=t.mul(et,G),Q=t.mul(it,Q),Q=t.add(Q,oe),new _(H,Y,Q)}subtract(E){return this.add(E.negate())}is0(){return this.equals(_.ZERO)}multiply(E){let{endo:D}=e;if(!n.isValidNot0(E))throw new Error("invalid scalar: out of range");let C,R,T=V=>k.wNAFCached(this,V,_.normalizeZ);if(D){let{k1neg:V,k1:F,k2neg:H,k2:Y}=D.splitScalar(E),{p:Q,f:X}=T(F),{p:me,f:oe}=T(Y);R=X.add(oe),C=S(D.beta,Q,me,V,H)}else{let{p:V,f:F}=T(E);C=V,R=F}return _.normalizeZ([C,R])[0]}multiplyUnsafe(E){let{endo:D}=e,C=this;if(!n.isValid(E))throw new Error("invalid scalar: out of range");if(E===cp||C.is0())return _.ZERO;if(E===lp)return C;if(k.hasPrecomputes(this))return this.multiply(E);if(D){let{k1neg:R,k1:T,k2neg:V,k2:F}=D.splitScalar(E),{p1:H,p2:Y}=ZS(_,C,T,F);return S(D.beta,H,Y,R,V)}else return k.wNAFCachedUnsafe(C,E)}multiplyAndAddUnsafe(E,D,C){let R=this.multiplyUnsafe(D).add(E.multiplyUnsafe(C));return R.is0()?void 0:R}toAffine(E){return v(this,E)}isTorsionFree(){let{isTorsionFree:E}=e;return o===lp?!0:E?E(_,this):k.wNAFCachedUnsafe(this,i).is0()}clearCofactor(){let{clearCofactor:E}=e;return o===lp?this:E?E(_,this):this.multiplyUnsafe(o)}toBytes(E=!0){return Is("isCompressed",E),this.assertValidity(),u(_,this,E)}toRawBytes(E=!0){return this.toBytes(E)}toHex(E=!0){return Mi(this.toBytes(E))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}_.BASE=new _(r.Gx,r.Gy,t.ONE),_.ZERO=new _(t.ZERO,t.ONE,t.ZERO),_.Fp=t,_.Fn=n;let U=n.BITS,k=lg(_,e.endo?Math.ceil(U/2):U);return _}function b_(r){return Uint8Array.of(r?2:3)}function CV(r,e,t={}){Hi(e,{hash:"function"},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});let n=e.randomBytes||_s,o=e.hmac||((C,...R)=>Ia(e.hash,C,eo(...R))),{Fp:i,Fn:s}=r,{ORDER:a,BITS:c}=s;function l(C){let R=a>>lp;return C>R}function u(C){return l(C)?s.neg(C):C}function f(C,R){if(!s.isValidNot0(R))throw new Error(`invalid signature ${C}: out of range 1..CURVE.n`)}class h{constructor(R,T,V){f("r",R),f("s",T),this.r=R,this.s=T,V!=null&&(this.recovery=V),Object.freeze(this)}static fromCompact(R){let T=s.BYTES,V=gt("compactSignature",R,T*2);return new h(s.fromBytes(V.subarray(0,T)),s.fromBytes(V.subarray(T,T*2)))}static fromDER(R){let{r:T,s:V}=Ts.toSig(gt("DER",R));return new h(T,V)}assertValidity(){}addRecoveryBit(R){return new h(this.r,this.s,R)}recoverPublicKey(R){let T=i.ORDER,{r:V,s:F,recovery:H}=this;if(H==null||![0,1,2,3].includes(H))throw new Error("recovery id invalid");if(a*AV<T&&H>1)throw new Error("recovery id is ambiguous for h>1 curve");let Q=H===2||H===3?V+a:V;if(!i.isValid(Q))throw new Error("recovery id 2 or 3 invalid");let X=i.toBytes(Q),me=r.fromHex(eo(b_((H&1)===0),X)),oe=s.inv(Q),G=A(gt("msgHash",R)),Te=s.create(-G*oe),et=s.create(F*oe),ue=r.BASE.multiplyUnsafe(Te).add(me.multiplyUnsafe(et));if(ue.is0())throw new Error("point at infinify");return ue.assertValidity(),ue}hasHighS(){return l(this.s)}normalizeS(){return this.hasHighS()?new h(this.r,s.neg(this.s),this.recovery):this}toBytes(R){if(R==="compact")return eo(s.toBytes(this.r),s.toBytes(this.s));if(R==="der")return gf(Ts.hexFromSig(this));throw new Error("invalid format")}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return Mi(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return Mi(this.toBytes("compact"))}}let d=x_(s,t.allowedPrivateKeyLengths,t.wrapPrivateKey),m={isValidPrivateKey(C){try{return d(C),!0}catch{return!1}},normPrivateKeyToScalar:d,randomPrivateKey:()=>{let C=a;return jS(n(Ww(C)),C)},precompute(C=8,R=r.BASE){return R.precompute(C,!1)}};function g(C,R=!0){return r.fromPrivateKey(C).toBytes(R)}function w(C){if(typeof C=="bigint")return!1;if(C instanceof r)return!0;let T=gt("key",C).length,V=i.BYTES,F=V+1,H=2*V+1;if(!(t.allowedPrivateKeyLengths||s.BYTES===F))return T===F||T===H}function x(C,R,T=!0){if(w(C)===!0)throw new Error("first arg must be private key");if(w(R)===!1)throw new Error("second arg must be public key");return r.fromHex(R).multiply(d(C)).toBytes(T)}let v=e.bits2int||function(C){if(C.length>8192)throw new Error("input is too large");let R=yf(C),T=C.length*8-c;return T>0?R>>BigInt(T):R},A=e.bits2int_modN||function(C){return s.create(v(C))},S=Qc(c);function _(C){return ti("num < 2^"+c,C,cp,S),s.toBytes(C)}function U(C,R,T=k){if(["recovered","canonical"].some(et=>et in T))throw new Error("sign() legacy options not supported");let{hash:V}=e,{lowS:F,prehash:H,extraEntropy:Y}=T;F==null&&(F=!0),C=gt("msgHash",C),w_(T),H&&(C=gt("prehashed msgHash",V(C)));let Q=A(C),X=d(R),me=[_(X),_(Q)];if(Y!=null&&Y!==!1){let et=Y===!0?n(i.BYTES):Y;me.push(gt("extraEntropy",et))}let oe=eo(...me),G=Q;function Te(et){let ue=v(et);if(!s.isValidNot0(ue))return;let it=s.inv(ue),rr=r.BASE.multiply(ue).toAffine(),Bt=s.create(rr.x);if(Bt===cp)return;let Mt=s.create(it*s.create(G+Bt*X));if(Mt===cp)return;let pr=(rr.x===Bt?0:2)|Number(rr.y&lp),un=Mt;return F&&l(Mt)&&(un=u(Mt),pr^=1),new h(Bt,un,pr)}return{seed:oe,k2sig:Te}}let k={lowS:e.lowS,prehash:!1},P={lowS:e.lowS,prehash:!1};function E(C,R,T=k){let{seed:V,k2sig:F}=U(C,R,T);return BS(e.hash.outputLen,s.BYTES,o)(V,F)}r.BASE.precompute(8);function D(C,R,T,V=P){let F=C;R=gt("msgHash",R),T=gt("publicKey",T),w_(V);let{lowS:H,prehash:Y,format:Q}=V;if("strict"in V)throw new Error("options.strict was renamed to lowS");if(Q!==void 0&&!["compact","der","js"].includes(Q))throw new Error('format must be "compact", "der" or "js"');let X=typeof F=="string"||pf(F),me=!X&&!Q&&typeof F=="object"&&F!==null&&typeof F.r=="bigint"&&typeof F.s=="bigint";if(!X&&!me)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");let oe,G;try{if(me)if(Q===void 0||Q==="js")oe=new h(F.r,F.s);else throw new Error("invalid format");if(X){try{Q!=="compact"&&(oe=h.fromDER(F))}catch(un){if(!(un instanceof Ts.Err))throw un}!oe&&Q!=="der"&&(oe=h.fromCompact(F))}G=r.fromHex(T)}catch{return!1}if(!oe||H&&oe.hasHighS())return!1;Y&&(R=e.hash(R));let{r:Te,s:et}=oe,ue=A(R),it=s.inv(et),rr=s.create(ue*it),Bt=s.create(Te*it),Mt=r.BASE.multiplyUnsafe(rr).add(G.multiplyUnsafe(Bt));return Mt.is0()?!1:s.create(Mt.x)===Te}return Object.freeze({getPublicKey:g,getSharedSecret:x,sign:E,verify:D,utils:m,Point:r,Signature:h})}function IV(r){let e={a:r.a,b:r.b,p:r.Fp.ORDER,n:r.n,h:r.h,Gx:r.Gx,Gy:r.Gy},t=r.Fp,n=ri(e.n,r.nBitLength),o={Fp:t,Fn:n,allowedPrivateKeyLengths:r.allowedPrivateKeyLengths,allowInfinityPoint:r.allowInfinityPoint,endo:r.endo,wrapPrivateKey:r.wrapPrivateKey,isTorsionFree:r.isTorsionFree,clearCofactor:r.clearCofactor,fromBytes:r.fromBytes,toBytes:r.toBytes};return{CURVE:e,curveOpts:o}}function TV(r){let{CURVE:e,curveOpts:t}=IV(r),n={hash:r.hash,hmac:r.hmac,randomBytes:r.randomBytes,lowS:r.lowS,bits2int:r.bits2int,bits2int_modN:r.bits2int_modN};return{CURVE:e,curveOpts:t,ecdsaOpts:n}}function kV(r,e){return Object.assign({},e,{ProjectivePoint:e.Point,CURVE:r})}function v_(r){let{CURVE:e,curveOpts:t,ecdsaOpts:n}=TV(r),o=_V(e,t),i=CV(o,n,t);return kV(r,i)}function A_(r,e){let t=n=>v_({...r,hash:n});return{...t(e),create:t}}var yg={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},Pae=BigInt(0),PV=BigInt(1),h7=BigInt(2),E_=(r,e)=>(r+e/h7)/e;function RV(r){let e=yg.p,t=BigInt(3),n=BigInt(6),o=BigInt(11),i=BigInt(22),s=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,u=l*l*r%e,f=St(u,t,e)*u%e,h=St(f,t,e)*u%e,d=St(h,h7,e)*l%e,m=St(d,o,e)*d%e,g=St(m,i,e)*m%e,w=St(g,a,e)*g%e,x=St(w,c,e)*w%e,v=St(x,a,e)*g%e,A=St(v,t,e)*u%e,S=St(A,s,e)*m%e,_=St(S,n,e)*l%e,U=St(_,h7,e);if(!p7.eql(p7.sqr(U),r))throw new Error("Cannot find square root");return U}var p7=ri(yg.p,void 0,void 0,{sqrt:RV}),ni=A_({...yg,Fp:p7,lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:r=>{let e=yg.n,t=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),n=-PV*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),o=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),i=t,s=BigInt("0x100000000000000000000000000000000"),a=E_(i*r,e),c=E_(-n*r,e),l=xt(r-a*t-c*o,e),u=xt(-a*n-c*i,e),f=l>s,h=u>s;if(f&&(l=e-l),h&&(u=e-u),l>s||u>s)throw new Error("splitScalar: Endomorphism failed, k="+r);return{k1neg:f,k1:l,k2neg:h,k2:u}}}},ig);var S_=32;function __(r,e,t){let n=De.digest(e instanceof Uint8Array?e:e.subarray());if(Ef(n))return n.then(({digest:o})=>(t?.signal?.throwIfAborted(),ni.sign(o,r).toDERRawBytes())).catch(o=>{throw o.name==="AbortError"?o:new rp(String(o))});try{return ni.sign(n.digest,r).toDERRawBytes()}catch(o){throw new rp(String(o))}}function C_(r,e,t,n){let o=De.digest(t instanceof Uint8Array?t:t.subarray());if(Ef(o))return o.then(({digest:i})=>(n?.signal?.throwIfAborted(),ni.verify(e,i,r))).catch(i=>{throw i.name==="AbortError"?i:new np(String(i))});try{return n?.signal?.throwIfAborted(),ni.verify(e,o.digest,r)}catch(i){throw new np(String(i))}}var up=class{type="secp256k1";raw;_key;constructor(e){this._key=k_(e),this.raw=I_(this._key)}toMultihash(){return ir.digest(sr(this))}toCID(){return q.createV1(114,this.toMultihash())}toString(){return Ve.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:de(this.raw,e.raw)}verify(e,t,n){return C_(this._key,t,e,n)}},fp=class{type="secp256k1";raw;publicKey;constructor(e,t){this.raw=T_(e),this.publicKey=new up(t??P_(e))}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:de(this.raw,e.raw)}sign(e,t){return __(this.raw,e,t)}};function m7(r){return new fp(r)}function g7(r){return new up(r)}async function R_(){let r=DV();return new fp(r)}function I_(r){return ni.ProjectivePoint.fromHex(r).toRawBytes(!0)}function T_(r){try{return ni.getPublicKey(r,!0),r}catch(e){throw new Oh(String(e))}}function k_(r){try{return ni.ProjectivePoint.fromHex(r),r}catch(e){throw new ys(String(e))}}function P_(r){try{return ni.getPublicKey(r,!0)}catch(e){throw new Oh(String(e))}}function DV(){return ni.utils.randomPrivateKey()}async function If(r,e){if(r==="Ed25519")return f_();if(r==="secp256k1")return R_();if(r==="RSA")return f7(NV(e));if(r==="ECDSA")return wS(OV(e));throw new Xo}function Qt(r,e){let{Type:t,Data:n}=Vi.decode(r),o=n??new Uint8Array;switch(t){case bt.RSA:return c7(o,e);case bt.Ed25519:return e7(o);case bt.secp256k1:return g7(o);case bt.ECDSA:return Uw(o);default:throw new Xo}}function wg(r){let{Type:e,Data:t}=Vi.decode(r.digest),n=t??new Uint8Array;switch(e){case bt.Ed25519:return e7(n);case bt.secp256k1:return g7(n);case bt.ECDSA:return Uw(n);default:throw new Xo}}function sr(r){return Vi.encode({Type:bt[r.type],Data:r.raw})}function D_(r){let e=ip.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case bt.RSA:return a7(t);case bt.Ed25519:return Jw(t);case bt.secp256k1:return m7(t);case bt.ECDSA:return hS(t);default:throw new Xo}}function N_(r){if(r.byteLength===to)return Jw(r);if(r.byteLength===S_)return m7(r);let e=Co(r),t=e[2]?.[0];if(t===oS||t===iS||t===sS)return Mw(e);if(e.length>8)return pg(e);throw new $("Could not extract private key from raw bytes")}function tl(r){return ip.encode({Type:bt[r.type],Data:r.raw})}function NV(r){return r==null?2048:parseInt(r,10)}function OV(r){if(r==="P-256"||r==null)return"P-256";if(r==="P-384")return"P-384";if(r==="P-521")return"P-521";throw new $("Unsupported curve, should be P-256, P-384 or P-521")}async function xg(r){if(r.type==="RSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])};if(r.type==="ECDSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"ECDSA",namedCurve:r.jwk.crv??"P-256"},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"ECDSA",namedCurve:r.publicKey.jwk.crv??"P-256"},!0,["verify"])};throw new $("Only RSA and ECDSA keys are supported")}var O_=Symbol.for("nodejs.util.inspect.custom"),LV=114,dp=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[v0]=!0;toString(){return this.string==null&&(this.string=Ve.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return q.createV1(LV,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return de(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return de(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[O_](){return`PeerId(${this.toString()})`}},hp=class extends dp{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},pp=class extends dp{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},mp=class extends dp{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}},BV=2336,gp=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=ir.digest(L(this.url))}[O_](){return`PeerId(${this.url})`}[v0]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return q.createV1(BV,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=K(e)),e.toString()===this.toString())}};var MV=114,L_=2336;function tt(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=ze(Ve.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return yn(q.parse(r));if(e==null)throw new $('Please pass a multibase decoder for strings that do not start with "1" or "Q"');t=ze(e.decode(r))}return cr(t)}function zi(r){if(r.type==="Ed25519")return new pp({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new mp({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new hp({multihash:r.toCID().multihash,publicKey:r});throw new Xo}function B_(r){return zi(r.publicKey)}function cr(r){if(FV(r))return new hp({multihash:r});if(UV(r))try{let e=wg(r);if(e.type==="Ed25519")return new pp({multihash:r,publicKey:e});if(e.type==="secp256k1")return new mp({multihash:r,publicKey:e})}catch{let t=K(r.digest);return new gp(new URL(t))}throw new ya("Supplied PeerID Multihash is invalid")}function yn(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==MV&&r.code!==L_)throw new C0("Supplied PeerID CID is invalid");if(r.code===L_){let e=K(r.multihash.digest);return new gp(new URL(e))}return cr(r.multihash)}function UV(r){return r.code===ir.code}function FV(r){return r.code===De.code}function rl(r,e){let t={[Symbol.iterator]:()=>t,next:()=>{let n=r.next(),o=n.value;return n.done===!0||o==null?{done:!0,value:void 0}:{done:!1,value:e(o)}}};return t}function bg(r){let e=ze(Ve.decode(`z${r}`));return cr(e)}var Jr=class{map;constructor(e){if(this.map=new Map,e!=null)for(let[t,n]of e.entries())this.map.set(t.toString(),{key:t,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return rl(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,n)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return rl(this.map.values(),e=>e.key)}values(){return rl(this.map.values(),e=>e.value)}get size(){return this.map.size}};var ro=class r{set;constructor(e){if(this.set=new Set,e!=null)for(let t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return rl(this.set.entries(),e=>{let t=bg(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{let n=bg(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return rl(this.set.values(),e=>bg(e))}intersection(e){let t=new r;for(let n of e)this.has(n)&&t.add(n);return t}difference(e){let t=new r;for(let n of this)e.has(n)||t.add(n);return t}union(e){let t=new r;for(let n of e)t.add(n);for(let n of this)t.add(n);return t}};function y7(){return new ro}function M_(r,e,t,n){jc(r);let o=ES({dkLen:32,asyncTick:10},n),{c:i,dkLen:s,asyncTick:a}=o;if(Jo(i),Jo(s),Jo(a),i<1)throw new Error("iterations (c) should be >= 1");let c=Hw(e),l=Hw(t),u=new Uint8Array(s),f=Ia.create(r,c),h=f._cloneInto().update(l);return{c:i,dkLen:s,asyncTick:a,DK:u,PRF:f,PRFSalt:h}}function U_(r,e,t,n,o){return r.destroy(),e.destroy(),n&&n.destroy(),Zr(o),t}function F_(r,e,t,n){let{c:o,dkLen:i,DK:s,PRF:a,PRFSalt:c}=M_(r,e,t,n),l,u=new Uint8Array(4),f=Wc(u),h=new Uint8Array(a.outputLen);for(let d=1,m=0;m<i;d++,m+=a.outputLen){let g=s.subarray(m,m+a.outputLen);f.setInt32(0,d,!1),(l=c._cloneInto(l)).update(u).digestInto(h),g.set(h.subarray(0,g.length));for(let w=1;w<o;w++){a._cloneInto(l).update(h).digestInto(h);for(let x=0;x<g.length;x++)g[x]^=h[x]}}return U_(a,c,s,l,h)}async function vg(r,e,t,n){let{c:o,dkLen:i,asyncTick:s,DK:a,PRF:c,PRFSalt:l}=M_(r,e,t,n),u,f=new Uint8Array(4),h=Wc(f),d=new Uint8Array(c.outputLen);for(let m=1,g=0;g<i;m++,g+=c.outputLen){let w=a.subarray(g,g+c.outputLen);h.setInt32(0,m,!1),(u=l._cloneInto(u)).update(f).digestInto(d),w.set(d.subarray(0,w.length)),await AS(o-1,s,()=>{c._cloneInto(u).update(d).digestInto(d);for(let x=0;x<w.length;x++)w[x]^=d[x]})}return U_(c,l,a,u,d)}var yp=Uint32Array.from([1732584193,4023233417,2562383102,271733878,3285377520]),Ta=new Uint32Array(80),Ag=class extends Gc{constructor(){super(64,20,8,!1),this.A=yp[0]|0,this.B=yp[1]|0,this.C=yp[2]|0,this.D=yp[3]|0,this.E=yp[4]|0}get(){let{A:e,B:t,C:n,D:o,E:i}=this;return[e,t,n,o,i]}set(e,t,n,o,i){this.A=e|0,this.B=t|0,this.C=n|0,this.D=o|0,this.E=i|0}process(e,t){for(let c=0;c<16;c++,t+=4)Ta[c]=e.getUint32(t,!1);for(let c=16;c<80;c++)Ta[c]=J0(Ta[c-3]^Ta[c-8]^Ta[c-14]^Ta[c-16],1);let{A:n,B:o,C:i,D:s,E:a}=this;for(let c=0;c<80;c++){let l,u;c<20?(l=eg(o,i,s),u=1518500249):c<40?(l=o^i^s,u=1859775393):c<60?(l=tg(o,i,s),u=2400959708):(l=o^i^s,u=3395469782);let f=J0(n,5)+l+a+u+Ta[c]|0;a=s,s=i,i=J0(o,30),o=n,n=f}n=n+this.A|0,o=o+this.B|0,i=i+this.C|0,s=s+this.D|0,a=a+this.E|0,this.set(n,o,i,s,a)}roundClean(){Zr(Ta)}destroy(){this.set(0,0,0,0,0),Zr(this.buffer)}},H_=Wh(()=>new Ag);var $_=H_;var Tf=sg;var V_={sha1:$_,"sha2-256":Ki,"sha2-512":Tf};function wp(r,e,t,n,o){if(o!=="sha1"&&o!=="sha2-256"&&o!=="sha2-512"){let a=Object.keys(V_).join(" / ");throw new $(`Hash '${o}' is unknown or not supported. Must be ${a}`)}let i=V_[o],s=F_(i,r,e,{c:t,dkLen:n});return or.encode(s).substring(1)}var w7={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},K_={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},z_=new globalThis.TextEncoder;function HV(r,e){let t=w7[e],n=K_[e];for(let o=0;o<r.length;o++)n^=BigInt(r[o]),n=BigInt.asUintN(e,n*t);return n}function $V(r,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");let n=w7[e],o=K_[e],i=r;for(;i.length>0;){let s=z_.encodeInto(i,t);i=i.slice(s.read);for(let a=0;a<s.written;a++)o^=BigInt(t[a]),o=BigInt.asUintN(e,o*n)}return o}function x7(r,{size:e=32,utf8Buffer:t}={}){if(!w7[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof r=="string"){if(t)return $V(r,e,t);r=z_.encode(r)}return HV(r,e)}var xp={hash:r=>Number(x7(r,{size:32})),hashV:(r,e)=>VV(xp.hash(r,e))};function VV(r){let e=r.toString(16);return e.length%2===1&&(e=`0${e}`),L(e,"base16")}var b7=64,oi=class{fp;h;seed;constructor(e,t,n,o=2){if(o>b7)throw new TypeError("Invalid Fingerprint Size");let i=t.hashV(e,n),s=Ie(o);for(let a=0;a<s.length;a++)s[a]=i[a];s.length===0&&(s[0]=7),this.fp=s,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array?de(this.fp,e.fp):!1}};function nl(r,e){return Math.floor(Math.random()*(e-r))+r}var ol=class{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof oi))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof oi))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof oi))throw new TypeError("Invalid Fingerprint");let t=nl(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof oi))throw new TypeError("Invalid Fingerprint");let t=this.contents.findIndex(n=>e.equals(n));return t>-1?(this.contents[t]=null,!0):!1}};var KV=500,bp=class{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??xp,this.seed=e.seed??nl(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=L(e));let t=new oi(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,o=(n^t.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new ol(this.bucketSize)),this.buckets[o]==null&&(this.buckets[o]=new ol(this.bucketSize)),this.buckets[n].add(t)||this.buckets[o].add(t))return this.count++,!0;let i=[n,o],s=i[nl(0,i.length-1)];this.buckets[s]==null&&(this.buckets[s]=new ol(this.bucketSize));for(let a=0;a<KV;a++){let c=this.buckets[s].swap(t);if(c!=null&&(s=(s^c.hash())%this.filterSize,this.buckets[s]==null&&(this.buckets[s]=new ol(this.bucketSize)),this.buckets[s].add(c)))return this.count++,!0}return!1}has(e){typeof e=="string"&&(e=L(e));let t=new oi(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,o=this.buckets[n]?.has(t)??!1;if(o)return o;let i=(n^t.hash())%this.filterSize;return this.buckets[i]?.has(t)??!1}remove(e){typeof e=="string"&&(e=L(e));let t=new oi(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,o=this.buckets[n]?.remove(t)??!1;if(o)return this.count--,o;let i=(n^t.hash())%this.filterSize,s=this.buckets[i]?.remove(t)??!1;return s&&this.count--,s}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}},zV={1:.5,2:.84,4:.95,8:.98};function qV(r=.001){return r>.002?2:r>1e-5?4:8}function q_(r,e=.001){let t=qV(e),n=zV[t],o=Math.round(r/n),i=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),b7);return{filterSize:o,bucketSize:t,fingerprintSize:i}}var kf=class{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??xp,this.seed=e.seed??nl(0,Math.pow(2,10)),this.filterSeries=[new bp({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=L(e)),this.has(e))return!0;let t=this.filterSeries.find(n=>n.reliable);if(t==null){let n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new bp({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=L(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=L(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}};function en(r,e=.001,t){return new kf({...q_(r,e),...t??{}})}var Eg=class{filter;constructor(e,t){this.filter=en(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){this.filter.remove?.(e.toMultihash().bytes)}};function v7(r,e=.001){return new Eg(r,e)}var A7=class extends Jr{metric;constructor(e){super();let{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function ks(r){let{name:e,metrics:t}=r,n;return t!=null?n=new A7({name:e,metrics:t}):n=new Jr,n}var Ps=class{full;pendingBytes;wantlist;blocks;blockPresences;constructor(e=!1,t=0){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}addWantlistEntry(e,t){let n=or.encode(e.multihash.bytes);this.wantlist.set(n,t)}addBlockPresence(e,t){let n=or.encode(e.multihash.bytes);this.blockPresences.set(n,t)}addBlock(e,t){let n=or.encode(e.multihash.bytes);this.blocks.set(n,t)}};function jV(r){let e=new Uint8Array(r.reduce((n,o)=>n+Ke(o),0)),t=0;for(let n of r)e=br(n,e,t),t+=Ke(n);return e}var j_=jV;function E7(r){return j_([r.version,r.code,r.multihash.code,r.multihash.digest.byteLength])}var Sg=class{peerId;blockstore;network;wants;exchangeCount;bytesSent;bytesReceived;lastExchange;maxSizeReplaceHasWithBlock;log;constructor(e,t){this.peerId=e.peerId,this.blockstore=e.blockstore,this.network=e.network,this.wants=new Map,this.log=e.logger.forComponent(`helia:bitswap:ledger:${e.peerId}`),this.exchangeCount=0,this.bytesSent=0,this.bytesReceived=0,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock??1024}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesReceived+=e}debtRatio(){return this.bytesSent/(this.bytesReceived+1)}async sendBlocksToPeer(e){let t=new Ps,n=new Set;for(let[o,i]of this.wants.entries())try{let s=await this.blockstore.get(i.cid,e);i.wantType===Yt.WantHave?s.byteLength<this.maxSizeReplaceHasWithBlock?(this.log("sending have and block for %c",i.cid),n.add(o),t.addBlock(i.cid,{data:s,prefix:E7(i.cid)})):(this.log("sending have for %c",i.cid),t.addBlockPresence(i.cid,{cid:i.cid.bytes,type:_o.HaveBlock})):(this.log("sending block for %c",i.cid),n.add(o),t.addBlock(i.cid,{data:s,prefix:E7(i.cid)}))}catch(s){if(s.name!=="NotFoundError")throw s;if(this.log("do not have block for %c",i.cid),!i.sendDontHave||i.sentDoNotHave===!0)continue;i.sentDoNotHave=!0,t.addBlockPresence(i.cid,{cid:i.cid.bytes,type:_o.DoNotHaveBlock})}if(t.blocks.size>0||t.blockPresences.size>0){this.log("sending message"),await this.network.sendMessage(this.peerId,t,e),this.log("sent message"),this.sentBytes([...t.blocks.values()].reduce((o,i)=>o+i.data.byteLength,0));for(let o of n)this.wants.delete(o)}}};var _g=class{blockstore;network;ledgerMap;maxSizeReplaceHasWithBlock;log;logger;constructor(e,t={}){this.blockstore=e.blockstore,this.network=e.network,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock,this.log=e.logger.forComponent("helia:bitswap:peer-want-lists"),this.logger=e.logger,this.ledgerMap=ks({name:"helia_bitswap_ledger_map",metrics:e.metrics}),this.network.addEventListener("bitswap:message",n=>{this.receiveMessage(n.detail.peer,n.detail.message).catch(o=>{this.log.error("error receiving bitswap message from %p",n.detail.peer,o)})}),this.network.addEventListener("peer:disconnected",n=>{this.peerDisconnected(n.detail)})}ledgerForPeer(e){let t=this.ledgerMap.get(e);if(t!=null)return{peer:t.peerId,value:t.debtRatio(),sent:t.bytesSent,received:t.bytesReceived,exchanged:t.exchangeCount}}wantListForPeer(e){let t=this.ledgerMap.get(e);if(t!=null)return[...t.wants.values()]}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.peerId)}async receiveMessage(e,t){let n=this.ledgerMap.get(e);if(n==null&&(n=new Sg({peerId:e,blockstore:this.blockstore,network:this.network,logger:this.logger},{maxSizeReplaceHasWithBlock:this.maxSizeReplaceHasWithBlock}),this.ledgerMap.set(e,n)),n.receivedBytes(t.blocks?.reduce((o,i)=>o+i.data.byteLength,0)??0),t.wantlist!=null){t.wantlist.full===!0&&n.wants.clear();for(let o of t.wantlist.entries){let i=q.decode(o.cid),s=K(i.multihash.bytes,"base64");o.cancel===!0?(this.log("peer %p cancelled want of block for %c",e,i),n.wants.delete(s)):(o.wantType===Yt.WantHave?this.log("peer %p wanted block presence for %c",e,i):this.log("peer %p wanted block for %c",e,i),n.wants.set(s,{cid:i,priority:o.priority,wantType:o.wantType??Yt.WantBlock,sendDontHave:o.sendDontHave??!1}))}}this.log("send blocks to peer"),await n.sendBlocksToPeer()}async receivedBlock(e,t){let n=K(e.multihash.bytes,"base64"),o=[];for(let i of this.ledgerMap.values())i.wants.has(n)&&o.push(i);await Promise.all(o.map(async i=>i.sendBlocksToPeer(t)))}peerDisconnected(e){this.ledgerMap.delete(e)}};var X_=st(Ig(),1);var G_=st(Ig(),1);function S7(r){t.debug=t,t.default=t,t.coerce=c,t.disable=i,t.enable=o,t.enabled=s,t.humanize=G_.default,t.destroy=l,Object.keys(r).forEach(u=>{t[u]=r[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let f=0;for(let h=0;h<u.length;h++)f=(f<<5)-f+u.charCodeAt(h),f|=0;return t.colors[Math.abs(f)%t.colors.length]}t.selectColor=e;function t(u){let f,h=null,d,m;function g(...w){if(!g.enabled)return;let x=g,v=Number(new Date),A=v-(f||v);x.diff=A,x.prev=f,x.curr=v,f=v,w[0]=t.coerce(w[0]),typeof w[0]!="string"&&w.unshift("%O");let S=0;w[0]=w[0].replace(/%([a-zA-Z%])/g,(U,k)=>{if(U==="%%")return"%";S++;let P=t.formatters[k];if(typeof P=="function"){let E=w[S];U=P.call(x,E),w.splice(S,1),S--}return U}),t.formatArgs.call(x,w),(x.log||t.log).apply(x,w)}return g.namespace=u,g.useColors=t.useColors(),g.color=t.selectColor(u),g.extend=n,g.destroy=t.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(d!==t.namespaces&&(d=t.namespaces,m=t.enabled(u)),m),set:w=>{h=w}}),typeof t.init=="function"&&t.init(g),g}function n(u,f){let h=t(this.namespace+(typeof f>"u"?":":f)+u);return h.log=this.log,h}function o(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let f,h=(typeof u=="string"?u:"").split(/[\s,]+/),d=h.length;for(f=0;f<d;f++)h[f]&&(u=h[f].replace(/\*/g,".*?"),u[0]==="-"?t.skips.push(new RegExp("^"+u.substr(1)+"$")):t.names.push(new RegExp("^"+u+"$")))}function i(){let u=[...t.names.map(a),...t.skips.map(a).map(f=>"-"+f)].join(",");return t.enable(""),u}function s(u){if(u[u.length-1]==="*")return!0;let f,h;for(f=0,h=t.skips.length;f<h;f++)if(t.skips[f].test(u))return!1;for(f=0,h=t.names.length;f<h;f++)if(t.names[f].test(u))return!0;return!1}function a(u){return u.toString().substring(2,u.toString().length-2).replace(/\.\*\?$/,"*")}function c(u){return u instanceof Error?u.stack??u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var Tg=oK(),ZV=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function JV(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/)!=null?!1:typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/)}function eK(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+(0,X_.default)(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,o=>{o!=="%%"&&(t++,o==="%c"&&(n=t))}),r.splice(n,0,e)}var tK=console.debug??console.log??(()=>{});function rK(r){try{r?Tg?.setItem("debug",r):Tg?.removeItem("debug")}catch{}}function nK(){let r;try{r=Tg?.getItem("debug")}catch{}return!r&&typeof(0,__Process$)<"u"&&"env"in __Process$&&(r=__Process$.env.DEBUG),r}function oK(){try{return localStorage}catch{}}function iK(r){r.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}var Y_=S7({formatArgs:eK,save:rK,load:nK,useColors:JV,setupFormatters:iK,colors:ZV,storage:Tg,log:tK});var In=Y_;In.formatters.b=r=>r==null?"undefined":Ve.baseEncode(r);In.formatters.t=r=>r==null?"undefined":Vt.baseEncode(r);In.formatters.m=r=>r==null?"undefined":or.baseEncode(r);In.formatters.p=r=>r==null?"undefined":r.toString();In.formatters.c=r=>r==null?"undefined":r.toString();In.formatters.k=r=>r==null?"undefined":r.toString();In.formatters.a=r=>r==null?"undefined":r.toString();In.formatters.e=r=>r==null?"undefined":Q_(r.stack)??Q_(r.message)??r.toString();function sK(r){let e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function Z_(r){return{forComponent(e){return Be(`${r}:${e}`)}}}function ka(){return{forComponent(r){return Be(r)}}}function Be(r){let e=sK(`${r}:trace`);return In.enabled(`${r}:trace`)&&In.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=In(`${r}:trace`)),Object.assign(In(r),{error:In(`${r}:error`),trace:e})}function Q_(r){if(r!=null&&(r=r.trim(),r.length!==0))return r}var C7=st(eC(),1);var Ap=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},I7=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},tC=r=>globalThis.DOMException===void 0?new I7(r):new DOMException(r),rC=r=>{let e=r.reason===void 0?tC("This operation was aborted."):r.reason;return e instanceof Error?e:tC(e)};function Rs(r,e){let{milliseconds:t,fallback:n,message:o,customTimers:i={setTimeout,clearTimeout}}=e,s,a,l=new Promise((u,f)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){let{signal:d}=e;d.aborted&&f(rC(d)),a=()=>{f(rC(d))},d.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(u,f);return}let h=new Ap;s=i.setTimeout.call(void 0,()=>{if(n){try{u(n())}catch(d){f(d)}return}typeof r.cancel=="function"&&r.cancel(),o===!1?u():o instanceof Error?f(o):(h.message=o??`Promise timed out after ${t} milliseconds`,f(h))},t),(async()=>{try{u(await r)}catch(d){f(d)}})()}).finally(()=>{l.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return l.clear=()=>{i.clearTimeout.call(void 0,s),s=void 0},l}function T7(r,e,t){let n=0,o=r.length;for(;o>0;){let i=Math.trunc(o/2),s=n+i;t(r[s],e)<=0?(n=++s,o-=i+1):o=i}return n}var Ep=class{#e=[];enqueue(e,t){t={priority:0,...t};let n={priority:t.priority,id:t.id,run:e};if(this.size===0||this.#e[this.size-1].priority>=t.priority){this.#e.push(n);return}let o=T7(this.#e,n,(i,s)=>s.priority-i.priority);this.#e.splice(o,0,n)}setPriority(e,t){let n=this.#e.findIndex(i=>i.id===e);if(n===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);let[o]=this.#e.splice(n,1);this.enqueue(o.run,{priority:t,id:e})}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}};var ii=class extends C7.default{#e;#t;#r=0;#i;#c;#l=0;#s;#n;#o;#d;#a=0;#f;#u;#h;#x=1n;timeout;constructor(e){if(super(),e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:Ep,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);this.#e=e.carryoverConcurrencyCount,this.#t=e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,this.#i=e.intervalCap,this.#c=e.interval,this.#o=new e.queueClass,this.#d=e.queueClass,this.concurrency=e.concurrency,this.timeout=e.timeout,this.#h=e.throwOnTimeout===!0,this.#u=e.autoStart===!1}get#b(){return this.#t||this.#r<this.#i}get#v(){return this.#a<this.#f}#A(){this.#a--,this.#p(),this.emit("next")}#E(){this.#w(),this.#y(),this.#n=void 0}get#S(){let e=Date.now();if(this.#s===void 0){let t=this.#l-e;if(t<0)this.#r=this.#e?this.#a:0;else return this.#n===void 0&&(this.#n=setTimeout(()=>{this.#E()},t)),!0}return!1}#p(){if(this.#o.size===0)return this.#s&&clearInterval(this.#s),this.#s=void 0,this.emit("empty"),this.#a===0&&this.emit("idle"),!1;if(!this.#u){let e=!this.#S;if(this.#b&&this.#v){let t=this.#o.dequeue();return t?(this.emit("active"),t(),e&&this.#y(),!0):!1}}return!1}#y(){this.#t||this.#s!==void 0||(this.#s=setInterval(()=>{this.#w()},this.#c),this.#l=Date.now()+this.#c)}#w(){this.#r===0&&this.#a===0&&this.#s&&(clearInterval(this.#s),this.#s=void 0),this.#r=this.#e?this.#a:0,this.#m()}#m(){for(;this.#p(););}get concurrency(){return this.#f}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#f=e,this.#m()}async#_(e){return new Promise((t,n)=>{e.addEventListener("abort",()=>{n(e.reason)},{once:!0})})}setPriority(e,t){this.#o.setPriority(e,t)}async add(e,t={}){return t.id??=(this.#x++).toString(),t={timeout:this.timeout,throwOnTimeout:this.#h,...t},new Promise((n,o)=>{this.#o.enqueue(async()=>{this.#a++,this.#r++;try{t.signal?.throwIfAborted();let i=e({signal:t.signal});t.timeout&&(i=Rs(Promise.resolve(i),{milliseconds:t.timeout})),t.signal&&(i=Promise.race([i,this.#_(t.signal)]));let s=await i;n(s),this.emit("completed",s)}catch(i){if(i instanceof Ap&&!t.throwOnTimeout){n();return}o(i),this.emit("error",i)}finally{this.#A()}},t),this.emit("add"),this.#p()})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return this.#u?(this.#u=!1,this.#m(),this):this}pause(){this.#u=!0}clear(){this.#o=new this.#d}async onEmpty(){this.#o.size!==0&&await this.#g("empty")}async onSizeLessThan(e){this.#o.size<e||await this.#g("next",()=>this.#o.size<e)}async onIdle(){this.#a===0&&this.#o.size===0||await this.#g("idle")}async#g(e,t){return new Promise(n=>{let o=()=>{t&&!t()||(this.off(e,o),n())};this.on(e,o)})}get size(){return this.#o.size}sizeBy(e){return this.#o.filter(e).length}get pending(){return this.#a}get isPaused(){return this.#u}};function Pg(r){let e=[rn.A];return r==null?e:Array.isArray(r)?r.length===0?e:r:[r]}var k7=60;function Rg(r){return{Status:r.Status??0,TC:r.TC??r.flag_tc??!1,RD:r.RD??r.flag_rd??!1,RA:r.RA??r.flag_ra??!1,AD:r.AD??r.flag_ad??!1,CD:r.CD??r.flag_cd??!1,Question:(r.Question??r.questions??[]).map(e=>({name:e.name,type:rn[e.type]})),Answer:(r.Answer??r.answers??[]).map(e=>({name:e.name,type:rn[e.type],TTL:e.TTL??e.ttl??k7,data:e.data instanceof Uint8Array?K(e.data):e.data}))}}var lK=4;function P7(r,e={}){let t=new ii({concurrency:e.queryConcurrency??lK});return async(n,o={})=>{let i=new URLSearchParams;i.set("name",n),Pg(o.types).forEach(a=>{i.append("type",rn[a])}),o.onProgress?.(new j("dns:query",{detail:n}));let s=await t.add(async()=>{let a=await fetch(`${r}?${i}`,{headers:{accept:"application/dns-json"},signal:o?.signal});if(a.status!==200)throw new Error(`Unexpected HTTP status: ${a.status} - ${a.statusText}`);let c=Rg(await a.json());return o.onProgress?.(new j("dns:response",{detail:c})),c},{signal:o.signal});if(s==null)throw new Error("No DNS response received");return s}}function nC(){return[P7("https://cloudflare-dns.com/dns-query"),P7("https://dns.google/resolve")]}var sC=st(iC(),1);var R7=class{lru;constructor(e){this.lru=(0,sC.default)(e)}get(e,t){let n=!0,o=[];for(let i of t){let s=this.getAnswers(e,i);if(s.length===0){n=!1;break}o.push(...s)}if(n)return Rg({answers:o})}getAnswers(e,t){let n=`${e.toLowerCase()}-${t}`,o=this.lru.get(n);if(o!=null){let i=o.filter(s=>s.expires>Date.now()).map(({expires:s,value:a})=>({...a,TTL:Math.round((s-Date.now())/1e3),type:rn[a.type]}));return i.length===0&&this.lru.remove(n),i}return[]}add(e,t){let n=`${e.toLowerCase()}-${t.type}`,o=this.lru.get(n)??[];o.push({expires:Date.now()+(t.TTL??k7)*1e3,value:t}),this.lru.set(n,o)}remove(e,t){let n=`${e.toLowerCase()}-${t}`;this.lru.remove(n)}clear(){this.lru.clear()}};function aC(r){return new R7(r)}var uK=1e3,Dg=class{resolvers;cache;constructor(e){this.resolvers={},this.cache=aC(e.cacheSize??uK),Object.entries(e.resolvers??{}).forEach(([t,n])=>{Array.isArray(n)||(n=[n]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=n}),this.resolvers["."]==null&&(this.resolvers["."]=nC())}async query(e,t={}){let n=Pg(t.types),o=t.cached!==!1?this.cache.get(e,n):void 0;if(o!=null)return t.onProgress?.(new j("dns:cache",{detail:o})),o;let i=`${e.split(".").pop()}.`,s=(this.resolvers[i]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(let c of s){if(t.signal?.aborted===!0)break;try{let l=await c(e,{...t,types:n});for(let u of l.Answer)this.cache.add(e,u);return l}catch(l){a.push(l),t.onProgress?.(new j("dns:error",{detail:l}))}}throw a.length===1?a[0]:new AggregateError(a,`DNS lookup of ${e} ${n} failed`)}};var rn;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA"})(rn||(rn={}));function sl(r={}){return new Dg(r)}var fK=["string","number","bigint","symbol"],dK=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];function cC(r){if(r===null)return"null";if(r===void 0)return"undefined";if(r===!0||r===!1)return"boolean";let e=typeof r;if(fK.includes(e))return e;if(e==="function")return"Function";if(Array.isArray(r))return"Array";if(hK(r))return"Buffer";let t=pK(r);return t||"Object"}function hK(r){return r&&r.constructor&&r.constructor.isBuffer&&r.constructor.isBuffer.call(null,r)}function pK(r){let e=Object.prototype.toString.call(r).slice(8,-1);if(dK.includes(e))return e}var I=class{constructor(e,t,n){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=n}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}};I.uint=new I(0,"uint",!0);I.negint=new I(1,"negint",!0);I.bytes=new I(2,"bytes",!0);I.string=new I(3,"string",!0);I.array=new I(4,"array",!1);I.map=new I(5,"map",!1);I.tag=new I(6,"tag",!1);I.float=new I(7,"float",!0);I.false=new I(7,"false",!0);I.true=new I(7,"true",!0);I.null=new I(7,"null",!0);I.undefined=new I(7,"undefined",!0);I.break=new I(7,"break",!0);var W=class{constructor(e,t,n){this.type=e,this.value=t,this.encodedLength=n,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}};var Nf=__Process$&&!__Process$.browser&&__Buffer$&&typeof __Buffer$.isBuffer=="function",mK=new TextDecoder,gK=new TextEncoder;function Ng(r){return Nf&&__Buffer$.isBuffer(r)}function Sp(r){return r instanceof Uint8Array?Ng(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r:Uint8Array.from(r)}var dC=Nf?(r,e,t)=>t-e>64?__Buffer$.from(r.subarray(e,t)).toString("utf8"):uC(r,e,t):(r,e,t)=>t-e>64?mK.decode(r.subarray(e,t)):uC(r,e,t),Og=Nf?r=>r.length>64?__Buffer$.from(r):lC(r):r=>r.length>64?gK.encode(r):lC(r),qi=r=>Uint8Array.from(r),Of=Nf?(r,e,t)=>Ng(r)?new Uint8Array(r.subarray(e,t)):r.slice(e,t):(r,e,t)=>r.slice(e,t),hC=Nf?(r,e)=>(r=r.map(t=>t instanceof Uint8Array?t:__Buffer$.from(t)),Sp(__Buffer$.concat(r,e))):(r,e)=>{let t=new Uint8Array(e),n=0;for(let o of r)n+o.length>t.length&&(o=o.subarray(0,t.length-n)),t.set(o,n),n+=o.length;return t},pC=Nf?r=>__Buffer$.allocUnsafe(r):r=>new Uint8Array(r);function mC(r,e){if(Ng(r)&&Ng(e))return r.compare(e);for(let t=0;t<r.length;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}function lC(r){let e=[],t=0;for(let n=0;n<r.length;n++){let o=r.charCodeAt(n);o<128?e[t++]=o:o<2048?(e[t++]=o>>6|192,e[t++]=o&63|128):(o&64512)===55296&&n+1<r.length&&(r.charCodeAt(n+1)&64512)===56320?(o=65536+((o&1023)<<10)+(r.charCodeAt(++n)&1023),e[t++]=o>>18|240,e[t++]=o>>12&63|128,e[t++]=o>>6&63|128,e[t++]=o&63|128):(e[t++]=o>>12|224,e[t++]=o>>6&63|128,e[t++]=o&63|128)}return e}function uC(r,e,t){let n=[];for(;e<t;){let o=r[e],i=null,s=o>239?4:o>223?3:o>191?2:1;if(e+s<=t){let a,c,l,u;switch(s){case 1:o<128&&(i=o);break;case 2:a=r[e+1],(a&192)===128&&(u=(o&31)<<6|a&63,u>127&&(i=u));break;case 3:a=r[e+1],c=r[e+2],(a&192)===128&&(c&192)===128&&(u=(o&15)<<12|(a&63)<<6|c&63,u>2047&&(u<55296||u>57343)&&(i=u));break;case 4:a=r[e+1],c=r[e+2],l=r[e+3],(a&192)===128&&(c&192)===128&&(l&192)===128&&(u=(o&15)<<18|(a&63)<<12|(c&63)<<6|l&63,u>65535&&u<1114112&&(i=u))}}i===null?(i=65533,s=1):i>65535&&(i-=65536,n.push(i>>>10&1023|55296),i=56320|i&1023),n.push(i),e+=s}return D7(n)}var fC=4096;function D7(r){let e=r.length;if(e<=fC)return String.fromCharCode.apply(String,r);let t="",n=0;for(;n<e;)t+=String.fromCharCode.apply(String,r.slice(n,n+=fC));return t}var yK=256,_p=class{constructor(e=yK){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),this._initReuseChunk!==null&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){let o=t.length-(this.maxCursor-this.cursor)-1;t.set(e,o)}else{if(t){let o=t.length-(this.maxCursor-this.cursor)-1;o<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,o),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=pC(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,this._initReuseChunk===null&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(this.chunks.length===1){let n=this.chunks[0];e&&this.cursor>n.length/2?(t=this.cursor===n.length?n:n.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=Of(n,0,this.cursor)}else t=hC(this.chunks,this.cursor);return e&&this.reset(),t}};var he="CBOR decode error:",Ds="CBOR encode error:",Cp=[];Cp[23]=1;Cp[24]=2;Cp[25]=3;Cp[26]=5;Cp[27]=9;function Ns(r,e,t){if(r.length-e<t)throw new Error(`${he} not enough data for type`)}var Ar=[24,256,65536,4294967296,BigInt("18446744073709551616")];function no(r,e,t){Ns(r,e,1);let n=r[e];if(t.strict===!0&&n<Ar[0])throw new Error(`${he} integer encoded in more bytes than necessary (strict decode)`);return n}function oo(r,e,t){Ns(r,e,2);let n=r[e]<<8|r[e+1];if(t.strict===!0&&n<Ar[1])throw new Error(`${he} integer encoded in more bytes than necessary (strict decode)`);return n}function io(r,e,t){Ns(r,e,4);let n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3];if(t.strict===!0&&n<Ar[2])throw new Error(`${he} integer encoded in more bytes than necessary (strict decode)`);return n}function so(r,e,t){Ns(r,e,8);let n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3],o=r[e+4]*16777216+(r[e+5]<<16)+(r[e+6]<<8)+r[e+7],i=(BigInt(n)<<BigInt(32))+BigInt(o);if(t.strict===!0&&i<Ar[3])throw new Error(`${he} integer encoded in more bytes than necessary (strict decode)`);if(i<=Number.MAX_SAFE_INTEGER)return Number(i);if(t.allowBigInt===!0)return i;throw new Error(`${he} integers outside of the safe integer range are not supported`)}function gC(r,e,t,n){return new W(I.uint,no(r,e+1,n),2)}function yC(r,e,t,n){return new W(I.uint,oo(r,e+1,n),3)}function wC(r,e,t,n){return new W(I.uint,io(r,e+1,n),5)}function xC(r,e,t,n){return new W(I.uint,so(r,e+1,n),9)}function Io(r,e){return kr(r,0,e.value)}function kr(r,e,t){if(t<Ar[0]){let n=Number(t);r.push([e|n])}else if(t<Ar[1]){let n=Number(t);r.push([e|24,n])}else if(t<Ar[2]){let n=Number(t);r.push([e|25,n>>>8,n&255])}else if(t<Ar[3]){let n=Number(t);r.push([e|26,n>>>24&255,n>>>16&255,n>>>8&255,n&255])}else{let n=BigInt(t);if(n<Ar[4]){let o=[e|27,0,0,0,0,0,0,0],i=Number(n&BigInt(4294967295)),s=Number(n>>BigInt(32)&BigInt(4294967295));o[8]=i&255,i=i>>8,o[7]=i&255,i=i>>8,o[6]=i&255,i=i>>8,o[5]=i&255,o[4]=s&255,s=s>>8,o[3]=s&255,s=s>>8,o[2]=s&255,s=s>>8,o[1]=s&255,r.push(o)}else throw new Error(`${he} encountered BigInt larger than allowable range`)}}Io.encodedSize=function(e){return kr.encodedSize(e.value)};kr.encodedSize=function(e){return e<Ar[0]?1:e<Ar[1]?2:e<Ar[2]?3:e<Ar[3]?5:9};Io.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};function bC(r,e,t,n){return new W(I.negint,-1-no(r,e+1,n),2)}function vC(r,e,t,n){return new W(I.negint,-1-oo(r,e+1,n),3)}function AC(r,e,t,n){return new W(I.negint,-1-io(r,e+1,n),5)}var N7=BigInt(-1),EC=BigInt(1);function SC(r,e,t,n){let o=so(r,e+1,n);if(typeof o!="bigint"){let i=-1-o;if(i>=Number.MIN_SAFE_INTEGER)return new W(I.negint,i,9)}if(n.allowBigInt!==!0)throw new Error(`${he} integers outside of the safe integer range are not supported`);return new W(I.negint,N7-BigInt(o),9)}function Lg(r,e){let t=e.value,n=typeof t=="bigint"?t*N7-EC:t*-1-1;kr(r,e.type.majorEncoded,n)}Lg.encodedSize=function(e){let t=e.value,n=typeof t=="bigint"?t*N7-EC:t*-1-1;return n<Ar[0]?1:n<Ar[1]?2:n<Ar[2]?3:n<Ar[3]?5:9};Lg.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0};function Ip(r,e,t,n){Ns(r,e,t+n);let o=Of(r,e+t,e+t+n);return new W(I.bytes,o,t+n)}function _C(r,e,t,n){return Ip(r,e,1,t)}function CC(r,e,t,n){return Ip(r,e,2,no(r,e+1,n))}function IC(r,e,t,n){return Ip(r,e,3,oo(r,e+1,n))}function TC(r,e,t,n){return Ip(r,e,5,io(r,e+1,n))}function kC(r,e,t,n){let o=so(r,e+1,n);if(typeof o=="bigint")throw new Error(`${he} 64-bit integer bytes lengths not supported`);return Ip(r,e,9,o)}function Bg(r){return r.encodedBytes===void 0&&(r.encodedBytes=r.type===I.string?Og(r.value):r.value),r.encodedBytes}function Lf(r,e){let t=Bg(e);kr(r,e.type.majorEncoded,t.length),r.push(t)}Lf.encodedSize=function(e){let t=Bg(e);return kr.encodedSize(t.length)+t.length};Lf.compareTokens=function(e,t){return xK(Bg(e),Bg(t))};function xK(r,e){return r.length<e.length?-1:r.length>e.length?1:mC(r,e)}function Tp(r,e,t,n,o){let i=t+n;Ns(r,e,i);let s=new W(I.string,dC(r,e+t,e+i),i);return o.retainStringBytes===!0&&(s.byteValue=Of(r,e+t,e+i)),s}function PC(r,e,t,n){return Tp(r,e,1,t,n)}function RC(r,e,t,n){return Tp(r,e,2,no(r,e+1,n),n)}function DC(r,e,t,n){return Tp(r,e,3,oo(r,e+1,n),n)}function NC(r,e,t,n){return Tp(r,e,5,io(r,e+1,n),n)}function OC(r,e,t,n){let o=so(r,e+1,n);if(typeof o=="bigint")throw new Error(`${he} 64-bit integer string lengths not supported`);return Tp(r,e,9,o,n)}var LC=Lf;function Bf(r,e,t,n){return new W(I.array,n,t)}function BC(r,e,t,n){return Bf(r,e,1,t)}function MC(r,e,t,n){return Bf(r,e,2,no(r,e+1,n))}function UC(r,e,t,n){return Bf(r,e,3,oo(r,e+1,n))}function FC(r,e,t,n){return Bf(r,e,5,io(r,e+1,n))}function HC(r,e,t,n){let o=so(r,e+1,n);if(typeof o=="bigint")throw new Error(`${he} 64-bit integer array lengths not supported`);return Bf(r,e,9,o)}function $C(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${he} indefinite length items not allowed`);return Bf(r,e,1,1/0)}function Mg(r,e){kr(r,I.array.majorEncoded,e.value)}Mg.compareTokens=Io.compareTokens;Mg.encodedSize=function(e){return kr.encodedSize(e.value)};function Mf(r,e,t,n){return new W(I.map,n,t)}function VC(r,e,t,n){return Mf(r,e,1,t)}function KC(r,e,t,n){return Mf(r,e,2,no(r,e+1,n))}function zC(r,e,t,n){return Mf(r,e,3,oo(r,e+1,n))}function qC(r,e,t,n){return Mf(r,e,5,io(r,e+1,n))}function jC(r,e,t,n){let o=so(r,e+1,n);if(typeof o=="bigint")throw new Error(`${he} 64-bit integer map lengths not supported`);return Mf(r,e,9,o)}function WC(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${he} indefinite length items not allowed`);return Mf(r,e,1,1/0)}function Ug(r,e){kr(r,I.map.majorEncoded,e.value)}Ug.compareTokens=Io.compareTokens;Ug.encodedSize=function(e){return kr.encodedSize(e.value)};function GC(r,e,t,n){return new W(I.tag,t,1)}function XC(r,e,t,n){return new W(I.tag,no(r,e+1,n),2)}function YC(r,e,t,n){return new W(I.tag,oo(r,e+1,n),3)}function QC(r,e,t,n){return new W(I.tag,io(r,e+1,n),5)}function ZC(r,e,t,n){return new W(I.tag,so(r,e+1,n),9)}function Fg(r,e){kr(r,I.tag.majorEncoded,e.value)}Fg.compareTokens=Io.compareTokens;Fg.encodedSize=function(e){return kr.encodedSize(e.value)};var _K=20,CK=21,IK=22,TK=23;function JC(r,e,t,n){if(n.allowUndefined===!1)throw new Error(`${he} undefined values are not supported`);return n.coerceUndefinedToNull===!0?new W(I.null,null,1):new W(I.undefined,void 0,1)}function eI(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${he} indefinite length items not allowed`);return new W(I.break,void 0,1)}function O7(r,e,t){if(t){if(t.allowNaN===!1&&Number.isNaN(r))throw new Error(`${he} NaN values are not supported`);if(t.allowInfinity===!1&&(r===1/0||r===-1/0))throw new Error(`${he} Infinity values are not supported`)}return new W(I.float,r,e)}function tI(r,e,t,n){return O7(L7(r,e+1),3,n)}function rI(r,e,t,n){return O7(B7(r,e+1),5,n)}function nI(r,e,t,n){return O7(aI(r,e+1),9,n)}function Hg(r,e,t){let n=e.value;if(n===!1)r.push([I.float.majorEncoded|_K]);else if(n===!0)r.push([I.float.majorEncoded|CK]);else if(n===null)r.push([I.float.majorEncoded|IK]);else if(n===void 0)r.push([I.float.majorEncoded|TK]);else{let o,i=!1;(!t||t.float64!==!0)&&(iI(n),o=L7(si,1),n===o||Number.isNaN(n)?(si[0]=249,r.push(si.slice(0,3)),i=!0):(sI(n),o=B7(si,1),n===o&&(si[0]=250,r.push(si.slice(0,5)),i=!0))),i||(kK(n),o=aI(si,1),si[0]=251,r.push(si.slice(0,9)))}}Hg.encodedSize=function(e,t){let n=e.value;if(n===!1||n===!0||n===null||n===void 0)return 1;if(!t||t.float64!==!0){iI(n);let o=L7(si,1);if(n===o||Number.isNaN(n))return 3;if(sI(n),o=B7(si,1),n===o)return 5}return 9};var oI=new ArrayBuffer(9),To=new DataView(oI,1),si=new Uint8Array(oI,0);function iI(r){if(r===1/0)To.setUint16(0,31744,!1);else if(r===-1/0)To.setUint16(0,64512,!1);else if(Number.isNaN(r))To.setUint16(0,32256,!1);else{To.setFloat32(0,r);let e=To.getUint32(0),t=(e&2139095040)>>23,n=e&8388607;if(t===255)To.setUint16(0,31744,!1);else if(t===0)To.setUint16(0,(r&2147483648)>>16|n>>13,!1);else{let o=t-127;o<-24?To.setUint16(0,0):o<-14?To.setUint16(0,(e&2147483648)>>16|1<<24+o,!1):To.setUint16(0,(e&2147483648)>>16|o+15<<10|n>>13,!1)}}}function L7(r,e){if(r.length-e<2)throw new Error(`${he} not enough data for float16`);let t=(r[e]<<8)+r[e+1];if(t===31744)return 1/0;if(t===64512)return-1/0;if(t===32256)return NaN;let n=t>>10&31,o=t&1023,i;return n===0?i=o*2**-24:n!==31?i=(o+1024)*2**(n-25):i=o===0?1/0:NaN,t&32768?-i:i}function sI(r){To.setFloat32(0,r,!1)}function B7(r,e){if(r.length-e<4)throw new Error(`${he} not enough data for float32`);let t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,4).getFloat32(0,!1)}function kK(r){To.setFloat64(0,r,!1)}function aI(r,e){if(r.length-e<8)throw new Error(`${he} not enough data for float64`);let t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,8).getFloat64(0,!1)}Hg.compareTokens=Io.compareTokens;function Ze(r,e,t){throw new Error(`${he} encountered invalid minor (${t}) for major ${r[e]>>>5}`)}function $g(r){return()=>{throw new Error(`${he} ${r}`)}}var re=[];for(let r=0;r<=23;r++)re[r]=Ze;re[24]=gC;re[25]=yC;re[26]=wC;re[27]=xC;re[28]=Ze;re[29]=Ze;re[30]=Ze;re[31]=Ze;for(let r=32;r<=55;r++)re[r]=Ze;re[56]=bC;re[57]=vC;re[58]=AC;re[59]=SC;re[60]=Ze;re[61]=Ze;re[62]=Ze;re[63]=Ze;for(let r=64;r<=87;r++)re[r]=_C;re[88]=CC;re[89]=IC;re[90]=TC;re[91]=kC;re[92]=Ze;re[93]=Ze;re[94]=Ze;re[95]=$g("indefinite length bytes/strings are not supported");for(let r=96;r<=119;r++)re[r]=PC;re[120]=RC;re[121]=DC;re[122]=NC;re[123]=OC;re[124]=Ze;re[125]=Ze;re[126]=Ze;re[127]=$g("indefinite length bytes/strings are not supported");for(let r=128;r<=151;r++)re[r]=BC;re[152]=MC;re[153]=UC;re[154]=FC;re[155]=HC;re[156]=Ze;re[157]=Ze;re[158]=Ze;re[159]=$C;for(let r=160;r<=183;r++)re[r]=VC;re[184]=KC;re[185]=zC;re[186]=qC;re[187]=jC;re[188]=Ze;re[189]=Ze;re[190]=Ze;re[191]=WC;for(let r=192;r<=215;r++)re[r]=GC;re[216]=XC;re[217]=YC;re[218]=QC;re[219]=ZC;re[220]=Ze;re[221]=Ze;re[222]=Ze;re[223]=Ze;for(let r=224;r<=243;r++)re[r]=$g("simple values are not supported");re[244]=Ze;re[245]=Ze;re[246]=Ze;re[247]=JC;re[248]=$g("simple values are not supported");re[249]=tI;re[250]=rI;re[251]=nI;re[252]=Ze;re[253]=Ze;re[254]=Ze;re[255]=eI;var ai=[];for(let r=0;r<24;r++)ai[r]=new W(I.uint,r,1);for(let r=-1;r>=-24;r--)ai[31-r]=new W(I.negint,r,1);ai[64]=new W(I.bytes,new Uint8Array(0),1);ai[96]=new W(I.string,"",1);ai[128]=new W(I.array,0,1);ai[160]=new W(I.map,0,1);ai[244]=new W(I.false,!1,1);ai[245]=new W(I.true,!0,1);ai[246]=new W(I.null,null,1);function M7(r){switch(r.type){case I.false:return qi([244]);case I.true:return qi([245]);case I.null:return qi([246]);case I.bytes:return r.value.length?void 0:qi([64]);case I.string:return r.value===""?qi([96]):void 0;case I.array:return r.value===0?qi([128]):void 0;case I.map:return r.value===0?qi([160]):void 0;case I.uint:return r.value<24?qi([Number(r.value)]):void 0;case I.negint:if(r.value>=-24)return qi([31-Number(r.value)])}}var RK={float64:!1,mapSorter:NK,quickEncodeToken:M7};function F7(){let r=[];return r[I.uint.major]=Io,r[I.negint.major]=Lg,r[I.bytes.major]=Lf,r[I.string.major]=LC,r[I.array.major]=Mg,r[I.map.major]=Ug,r[I.tag.major]=Fg,r[I.float.major]=Hg,r}var cI=F7(),U7=new _p,Vg=class r{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do if(t.obj===e)return!0;while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${Ds} object contains circular references`);return new r(t,e)}},Pa={null:new W(I.null,null),undefined:new W(I.undefined,void 0),true:new W(I.true,!0),false:new W(I.false,!1),emptyArray:new W(I.array,0),emptyMap:new W(I.map,0)},Ra={number(r,e,t,n){return!Number.isInteger(r)||!Number.isSafeInteger(r)?new W(I.float,r):r>=0?new W(I.uint,r):new W(I.negint,r)},bigint(r,e,t,n){return r>=BigInt(0)?new W(I.uint,r):new W(I.negint,r)},Uint8Array(r,e,t,n){return new W(I.bytes,r)},string(r,e,t,n){return new W(I.string,r)},boolean(r,e,t,n){return r?Pa.true:Pa.false},null(r,e,t,n){return Pa.null},undefined(r,e,t,n){return Pa.undefined},ArrayBuffer(r,e,t,n){return new W(I.bytes,new Uint8Array(r))},DataView(r,e,t,n){return new W(I.bytes,new Uint8Array(r.buffer,r.byteOffset,r.byteLength))},Array(r,e,t,n){if(!r.length)return t.addBreakTokens===!0?[Pa.emptyArray,new W(I.break)]:Pa.emptyArray;n=Vg.createCheck(n,r);let o=[],i=0;for(let s of r)o[i++]=kp(s,t,n);return t.addBreakTokens?[new W(I.array,r.length),o,new W(I.break)]:[new W(I.array,r.length),o]},Object(r,e,t,n){let o=e!=="Object",i=o?r.keys():Object.keys(r),s=o?r.size:i.length;if(!s)return t.addBreakTokens===!0?[Pa.emptyMap,new W(I.break)]:Pa.emptyMap;n=Vg.createCheck(n,r);let a=[],c=0;for(let l of i)a[c++]=[kp(l,t,n),kp(o?r.get(l):r[l],t,n)];return DK(a,t),t.addBreakTokens?[new W(I.map,s),a,new W(I.break)]:[new W(I.map,s),a]}};Ra.Map=Ra.Object;Ra.Buffer=Ra.Uint8Array;for(let r of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))Ra[`${r}Array`]=Ra.DataView;function kp(r,e={},t){let n=cC(r),o=e&&e.typeEncoders&&e.typeEncoders[n]||Ra[n];if(typeof o=="function"){let s=o(r,n,e,t);if(s!=null)return s}let i=Ra[n];if(!i)throw new Error(`${Ds} unsupported type: ${n}`);return i(r,n,e,t)}function DK(r,e){e.mapSorter&&r.sort(e.mapSorter)}function NK(r,e){let t=Array.isArray(r[0])?r[0][0]:r[0],n=Array.isArray(e[0])?e[0][0]:e[0];if(t.type!==n.type)return t.type.compare(n.type);let o=t.type.major,i=cI[o].compareTokens(t,n);return i===0&&console.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),i}function lI(r,e,t,n){if(Array.isArray(e))for(let o of e)lI(r,o,t,n);else t[e.type.major](r,e,n)}function H7(r,e,t){let n=kp(r,t);if(!Array.isArray(n)&&t.quickEncodeToken){let o=t.quickEncodeToken(n);if(o)return o;let i=e[n.type.major];if(i.encodedSize){let s=i.encodedSize(n,t),a=new _p(s);if(i(a,n,t),a.chunks.length!==1)throw new Error(`Unexpected error: pre-calculated length for ${n} was wrong`);return Sp(a.chunks[0])}}return U7.reset(),lI(U7,n,e,t),U7.toBytes(!0)}function Os(r,e){return e=Object.assign({},RK,e),H7(r,cI,e)}var OK={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0},Kg=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){let e=this.data[this._pos],t=ai[e];if(t===void 0){let n=re[e];if(!n)throw new Error(`${he} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);let o=e&31;t=n(this.data,this._pos,o,this.options)}return this._pos+=t.encodedLength,t}},Pp=Symbol.for("DONE"),zg=Symbol.for("BREAK");function LK(r,e,t){let n=[];for(let o=0;o<r.value;o++){let i=Uf(e,t);if(i===zg){if(r.value===1/0)break;throw new Error(`${he} got unexpected break to lengthed array`)}if(i===Pp)throw new Error(`${he} found array but not enough entries (got ${o}, expected ${r.value})`);n[o]=i}return n}function BK(r,e,t){let n=t.useMaps===!0,o=n?void 0:{},i=n?new Map:void 0;for(let s=0;s<r.value;s++){let a=Uf(e,t);if(a===zg){if(r.value===1/0)break;throw new Error(`${he} got unexpected break to lengthed map`)}if(a===Pp)throw new Error(`${he} found map but not enough entries (got ${s} [no key], expected ${r.value})`);if(n!==!0&&typeof a!="string")throw new Error(`${he} non-string keys not supported (got ${typeof a})`);if(t.rejectDuplicateMapKeys===!0&&(n&&i.has(a)||!n&&a in o))throw new Error(`${he} found repeat map key "${a}"`);let c=Uf(e,t);if(c===Pp)throw new Error(`${he} found map but not enough entries (got ${s} [no value], expected ${r.value})`);n?i.set(a,c):o[a]=c}return n?i:o}function Uf(r,e){if(r.done())return Pp;let t=r.next();if(t.type===I.break)return zg;if(t.type.terminal)return t.value;if(t.type===I.array)return LK(t,r,e);if(t.type===I.map)return BK(t,r,e);if(t.type===I.tag){if(e.tags&&typeof e.tags[t.value]=="function"){let n=Uf(r,e);return e.tags[t.value](n)}throw new Error(`${he} tag not supported (${t.value})`)}throw new Error("unsupported")}function $7(r,e){if(!(r instanceof Uint8Array))throw new Error(`${he} data to decode must be a Uint8Array`);e=Object.assign({},OK,e);let t=e.tokenizer||new Kg(r,e),n=Uf(t,e);if(n===Pp)throw new Error(`${he} did not find any content to decode`);if(n===zg)throw new Error(`${he} got unexpected break`);return[n,r.subarray(t.pos())]}function xn(r,e){let[t,n]=$7(r,e);if(n.length>0)throw new Error(`${he} too many terminals, data makes no sense`);return t}var Ls="/",uI=new TextEncoder().encode(Ls),qg=uI[0],Je=class r{_buf;constructor(e,t){if(typeof e=="string")this._buf=L(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==qg)throw new Error("Invalid key")}toString(e="utf8"){return K(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new r(e.join(Ls))}static random(){return new r(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new r(e):typeof e.uint8Array=="function"?new r(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=uI),this._buf[0]!==qg){let e=new Uint8Array(this._buf.byteLength+1);e.fill(qg,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===qg;)this._buf=this._buf.subarray(0,-1)}less(e){let t=this.list(),n=e.list();for(let o=0;o<t.length;o++){if(n.length<o+1)return!1;let i=t[o],s=n[o];if(i<s)return!0;if(i>s)return!1}return t.length<n.length}reverse(){return r.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){let e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(Ls).slice(1)}type(){return MK(this.baseNamespace())}name(){return UK(this.baseNamespace())}instance(e){return new r(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(Ls)||(e+=Ls),e+=this.type(),new r(e)}parent(){let e=this.list();return e.length===1?new r(Ls):new r(e.slice(0,-1).join(Ls))}child(e){return this.toString()===Ls?e:e.toString()===Ls?this:new r(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return r.withNamespaces([...this.namespaces(),...FK(e.map(t=>t.namespaces()))])}};function MK(r){let e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function UK(r){let e=r.split(":");return e[e.length-1]}function FK(r){return[].concat(...r)}function jg({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*HK(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(let[t,n]of e.entries()){let o=[...r,t],i=q.asCID(n);i!=null?yield[o.join("/"),i]:typeof n=="object"&&(yield*K7(n,o))}else{let t=q.asCID(e);t!=null?yield[r.join("/"),t]:yield*K7(e,r)}}function*K7(r,e){if(r==null||r instanceof Uint8Array)return;let t=q.asCID(r);t!=null&&(yield[e.join("/"),t]);for(let[n,o]of Object.entries(r)){let i=[...e,n];yield*HK(i,o)}}function*$K(r,e){if(Array.isArray(e))for(let[t,n]of e.entries()){let o=[...r,t];yield o.join("/"),typeof n=="object"&&q.asCID(n)==null&&(yield*z7(n,o))}else yield*z7(e,r)}function*z7(r,e){if(!(r==null||typeof r!="object"))for(let[t,n]of Object.entries(r)){let o=[...e,t];yield o.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&q.asCID(n)==null&&(yield*$K(o,n))}}function VK(r,e){let t=r;for(let[n,o]of e.entries()){if(t=t[o],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(s=>`[${JSON.stringify(s)}]`).join("")}`);let i=q.asCID(t);if(i!=null)return{value:i,remaining:e.slice(n+1).join("/")}}return{value:t}}var q7=class{cid;bytes;value;asBlock;constructor({cid:e,bytes:t,value:n}){if(e==null||t==null||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:jg(),bytes:jg(),value:jg(),asBlock:jg()})}links(){return K7(this.value,[])}tree(){return z7(this.value,[])}get(e="/"){return VK(this.value,e.split("/").filter(Boolean))}};function Rp({bytes:r,cid:e,value:t,codec:n}){let o=t!==void 0?t:n?.decode(r);if(o===void 0)throw new Error('Missing required argument, must either provide "value" or "codec"');return new q7({cid:e,bytes:r,value:o})}var hI="/pin/",fI="/pinned-block/",j7=dn,dI=1;function Wg(r){return r.version===0&&(r=r.toV1()),new Je(`${hI}${r.toString(j7)}`)}var Gg=class{datastore;blockstore;getCodec;constructor(e,t,n){this.datastore=e,this.blockstore=t,this.getCodec=n}async*add(e,t={}){let n=Wg(e);if(await this.datastore.has(n))throw new Error("Already pinned");let o=Math.round(t.depth??1/0);if(o<0)throw new Error("Depth must be greater than or equal to 0");let i=new _r({concurrency:dI});for await(let a of this.#e(e,i,{...t,depth:o}))await this.#t(a,c=>c.pinnedBy.find(l=>de(l,e.bytes))!=null?!1:(c.pinCount++,c.pinnedBy.push(e.bytes),!0),t),yield a;let s={depth:o,metadata:t.metadata??{}};await this.datastore.put(n,Os(s),t)}async*#e(e,t,n){if(n.depth===-1)return;let o=await this.getCodec(e.code),i=await this.blockstore.get(e,n),s=Rp({bytes:i,cid:e,codec:o});yield e;for(let[,a]of s.links())yield*await t.add(async()=>this.#e(a,t,{...n,depth:n.depth-1}))}async#t(e,t,n){let o=new Je(`${fI}${j7.encode(e.multihash.bytes)}`),i={pinCount:0,pinnedBy:[]};try{i=xn(await this.datastore.get(o,n))}catch(a){if(a.name!=="NotFoundError")throw a}if(t(i)){if(i.pinCount===0&&await this.datastore.has(o)){await this.datastore.delete(o);return}await this.datastore.put(o,Os(i),n),n.onProgress?.(new j("helia:pin:add",e))}}async*rm(e,t={}){let n=Wg(e),o=await this.datastore.get(n,t),i=xn(o);await this.datastore.delete(n,t);let s=new _r({concurrency:dI});for await(let a of this.#e(e,s,{...t,depth:i.depth}))await this.#t(a,c=>(c.pinCount--,c.pinnedBy=c.pinnedBy.filter(l=>de(l,e.bytes)),!0),{...t,depth:i.depth}),yield a}async*ls(e={}){for await(let{key:t,value:n}of this.datastore.query({prefix:hI+(e.cid!=null?`${e.cid.toString(dn)}`:"")},e)){let o=q.parse(t.toString().substring(5),dn),i=xn(n);yield{cid:o,...i}}}async isPinned(e,t={}){let n=new Je(`${fI}${j7.encode(e.multihash.bytes)}`);return this.datastore.has(n,t)}async get(e,t){let n=Wg(e),o=await this.datastore.get(n,t);return xn(o)}async setMetadata(e,t,n){let o=Wg(e),i=await this.datastore.get(o,n),s=xn(i);s.metadata=t??{},await this.datastore.put(o,Os(s),n)}};var Xg=class extends Error{static name="InsufficientProvidersError";constructor(e="Insufficient providers found"){super(e),this.name="InsufficientProvidersError"}},cl=class extends Error{static name="NoRoutersAvailableError";constructor(e="No routers available"){super(e),this.name="NoRoutersAvailableError"}},Yg=class extends Error{static name="UnknownHashAlgorithmError";constructor(e="Unknown hash algorithm"){super(e),this.name="UnknownHashAlgorithmError"}},Qg=class extends Error{static name="UnknownCodecError";constructor(e="Unknown codec"){super(e),this.name="UnknownCodecError"}};var KK=5,Zg=class{log;routers;providerLookupConcurrency;constructor(e,t){this.log=e.logger.forComponent("helia:routing"),this.routers=t.routers??[],this.providerLookupConcurrency=t.providerLookupConcurrency??KK,this.findProviders=e.metrics?.traceFunction("helia.routing.findProviders",this.findProviders.bind(this),{optionsIndex:1})??this.findProviders,this.provide=e.metrics?.traceFunction("helia.routing.provide",this.provide.bind(this),{optionsIndex:1})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("helia.routing.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1})??this.cancelReprovide,this.put=e.metrics?.traceFunction("helia.routing.put",this.put.bind(this),{optionsIndex:2})??this.put,this.get=e.metrics?.traceFunction("helia.routing.get",this.get.bind(this),{optionsIndex:1})??this.get,this.findPeer=e.metrics?.traceFunction("helia.routing.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("helia.routing.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async start(){await Sr(...this.routers)}async stop(){await Wr(...this.routers)}async*findProviders(e,t={}){if(this.routers.length===0)throw new cl("No content routers available");let n=new Cr({concurrency:this.providerLookupConcurrency});n.addEventListener("error",()=>{});for await(let o of fn(n.toGenerator(),...ll(this.routers,"findProviders").map(i=>i.findProviders(e,t))))if(o!=null){if(o.multiaddrs.length===0){if(n.find(o.id)!=null)continue;n.add(async()=>{try{let i=await this.findPeer(o.id,t);return i.multiaddrs.length===0?null:i}catch(i){return this.log.error("could not load multiaddrs for peer %p",o.id,i),null}},{peerId:o.id,signal:t.signal}).catch(i=>{this.log.error("could not load multiaddrs for peer %p",o.id,i)})}yield o}}async provide(e,t={}){if(this.routers.length===0)throw new cl("No content routers available");await Promise.all(ll(this.routers,"provide").map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){await Promise.all(ll(this.routers,"cancelReprovide").map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){await Promise.all(ll(this.routers,"put").map(async o=>{await o.put(e,t,n)}))}async get(e,t){return Promise.any(ll(this.routers,"get").map(async n=>n.get(e,t)))}async findPeer(e,t){if(this.routers.length===0)throw new cl("No peer routers available");let n=this,o=fn(...ll(this.routers,"findPeer").map(i=>async function*(){try{yield await i.findPeer(e,t)}catch(s){n.log.error(s)}}()));for await(let i of o)if(i!=null)return i;throw new $e("Could not find peer in routing")}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new cl("No peer routers available");for await(let n of fn(...ll(this.routers,"getClosestPeers").map(o=>o.getClosestPeers(e,t))))n!=null&&(yield n)}};function ll(r,e){return r.filter(t=>t[e]!=null)}var ci=class extends Error{static name="AbortError";name="AbortError";constructor(e="The operation was aborted",...t){super(e,...t)}};var Jg=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};var e2=class{deferred;signal;constructor(e){this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new ci)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function zK(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var t2=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=zK(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new ci),this.cleanup())}async join(e={}){let t=new e2(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await ut(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};function W7(r,e){let t,n=function(){let o=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(o,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}var Dp=class extends Re{concurrency;maxSize;queue;pending;sort;autoStart;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=e.autoStart??!0,this.sort=e.sort,this.queue=[],this.emitEmpty=W7(this.emitEmpty.bind(this),1),this.emitIdle=W7(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(let t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new Jg;let n=new t2(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),n.join(t).then(o=>(this.safeDispatchEvent("success",{detail:{job:n,result:o}}),o)).catch(o=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new ci)}),this.clear()}async onEmpty(e){this.size!==0&&await Ft(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Ft(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await Ft(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();let t=nr({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},o=c=>{c.detail!=null&&t.push(c.detail.result)},i=c=>{n(c.detail.error)},s=()=>{n()},a=()=>{n(new ci("Queue aborted"))};this.addEventListener("success",o),this.addEventListener("failure",i),this.addEventListener("idle",s),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("success",o),this.removeEventListener("failure",i),this.removeEventListener("idle",s),e?.signal?.removeEventListener("abort",a),n()}}};var r2="lock:worker:request-read",n2="lock:worker:abort-read-request",o2="lock:worker:release-read",i2="lock:master:grant-read",s2="lock:master:error-read",a2="lock:worker:request-write",c2="lock:worker:abort-write-request",l2="lock:worker:release-write",u2="lock:master:grant-write",f2="lock:master:error-write",d2="lock:worker:finalize",h2="mortice",pI={singleProcess:!1};var G7=(r,e,t,n,o,i,s,a,c)=>l=>{if(l.data==null)return;let u={type:l.data.type,name:l.data.name,identifier:l.data.identifier};u.type===o&&r.safeDispatchEvent(t,{detail:{name:u.name,identifier:u.identifier,handler:async()=>{e.postMessage({type:c,name:u.name,identifier:u.identifier}),await new Promise(f=>{let h=d=>{if(d?.data==null)return;let m={type:d.data.type,name:d.data.name,identifier:d.data.identifier};m.type===a&&m.identifier===u.identifier&&(e.removeEventListener("message",h),f())};e.addEventListener("message",h)})},onError:f=>{e.postMessage({type:s,name:u.name,identifier:u.identifier,error:{message:f.message,name:f.name,stack:f.stack}})}}}),u.type===i&&r.safeDispatchEvent(n,{detail:{name:u.name,identifier:u.identifier}}),u.type===d2&&r.safeDispatchEvent("finalizeRequest",{detail:{name:u.name}})};var mI=(r=10)=>Math.random().toString().substring(2,r+2);var p2=class{name;channel;constructor(e){this.name=e,this.channel=new BroadcastChannel(h2)}readLock(e){return this.sendRequest(r2,n2,i2,s2,o2,e)}writeLock(e){return this.sendRequest(a2,c2,u2,f2,l2,e)}finalize(){this.channel.postMessage({type:d2,name:this.name}),this.channel.close()}async sendRequest(e,t,n,o,i,s){s?.signal?.throwIfAborted();let a=mI();return this.channel.postMessage({type:e,identifier:a,name:this.name}),new Promise((c,l)=>{let u=()=>{this.channel.postMessage({type:t,identifier:a,name:this.name})};s?.signal?.addEventListener("abort",u,{once:!0});let f=h=>{if(h.data?.identifier===a&&(h.data?.type===n&&(this.channel.removeEventListener("message",f),s?.signal?.removeEventListener("abort",u),c(()=>{this.channel.postMessage({type:i,identifier:a,name:this.name})})),h.data.type===o)){this.channel.removeEventListener("message",f),s?.signal?.removeEventListener("abort",u);let d=new Error;h.data.error!=null&&(d.message=h.data.error.message,d.name=h.data.error.name,d.stack=h.data.error.stack),l(d)}};this.channel.addEventListener("message",f)})}};var gI=r=>{if(r=Object.assign({},pI,r),!!globalThis.document||r.singleProcess){let t=new BroadcastChannel(h2),n=new Re;return t.addEventListener("message",G7(n,t,"requestReadLock","abortReadLockRequest",r2,n2,s2,o2,i2)),t.addEventListener("message",G7(n,t,"requestWriteLock","abortWriteLockRequest",a2,c2,f2,l2,u2)),n}return new p2(r.name)};var ul=new Map,Np;function yI(r){return typeof r?.readLock=="function"&&typeof r?.writeLock=="function"}function qK(r){if(Np==null&&(Np=gI(r),!yI(Np))){let e=Np;e.addEventListener("requestReadLock",t=>{let n=t.detail.name,o=t.detail.identifier,i=ul.get(n);if(i==null)return;let s=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==o||s.abort()};e.addEventListener("abortReadLockRequest",a),i.readLock({signal:s.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortReadLockRequest",a)})}),e.addEventListener("requestWriteLock",t=>{let n=t.detail.name,o=t.detail.identifier,i=ul.get(n);if(i==null)return;let s=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==o||s.abort()};e.addEventListener("abortWriteLockRequest",a),i.writeLock({signal:s.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",a)})}),e.addEventListener("finalizeRequest",t=>{let n=t.detail.name,o=ul.get(n);o?.finalize()})}return Np}async function X7(r,e){let t,n,o=new Promise((s,a)=>{t=s,n=a}),i=()=>{n(new ci)};return e?.signal?.addEventListener("abort",i,{once:!0}),r.add(async()=>{await new Promise(s=>{t(()=>{e?.signal?.removeEventListener("abort",i),s()})})},{signal:e?.signal}).catch(s=>{n(s)}),o}var wI=(r,e)=>{let t=ul.get(r);if(t!=null)return t;let n=qK(e);if(yI(n))return t=n,ul.set(r,t),t;let o=new Dp({concurrency:1}),i;return t={async readLock(s){if(i!=null)return X7(i,s);i=new Dp({concurrency:e.concurrency,autoStart:!1});let a=i,c=X7(i,s);return o.add(async()=>{a.start(),await a.onIdle().then(()=>{i===a&&(i=null)})}),c},async writeLock(s){return i=null,X7(o,s)},finalize:()=>{ul.delete(r)},queue:o},ul.set(r,t),e.autoFinalize===!0&&o.addEventListener("idle",()=>{t.finalize()},{once:!0}),t};var jK={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function Op(r){let e=Object.assign({},jK,r);return wI(e.name,e)}var m2=class{lock;child;pins;started;constructor(e,t,n={}){this.child=e,this.pins=t,this.lock=Op({singleProcess:n.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await Sr(this.child),this.started=!0}async stop(){await Wr(this.child),this.started=!1}unwrap(){return this.child}async put(e,t,n={}){n?.signal?.throwIfAborted();let o=await this.lock.readLock();try{return await this.child.put(e,t,n)}finally{o()}}async*putMany(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{n()}}async get(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{return await this.child.get(e,t)}finally{n()}}async*getMany(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{n()}}async delete(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new Error("CID was pinned");await this.child.delete(e,t)}finally{n()}}async*deleteMany(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.writeLock();try{let o=this;yield*this.child.deleteMany(async function*(){for await(let i of e){if(await o.pins.isPinned(i))throw new Error("CID was pinned");yield i}}(),t)}finally{n()}}async has(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{return await this.child.has(e,t)}finally{n()}}async*getAll(e={}){e?.signal?.throwIfAborted();let t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}createSession(e,t){return t?.signal?.throwIfAborted(),this.child.createSession(e,t)}};var Y7=new Je("/version"),xI=1;async function bI(r){if(!await r.has(Y7)){await r.put(Y7,L(`${xI}`));return}let e=await r.get(Y7),t=K(e);if(parseInt(t,10)!==xI)throw new Error("Unknown datastore version, a datastore migration may be required")}var Bs={};Ut(Bs,{code:()=>Pr,decode:()=>ji,decodeOptions:()=>ZK,encode:()=>Ff,encodeOptions:()=>YK,name:()=>JK,toByteView:()=>AI});var vI=42;function AI(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function WK(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;let e=q.asCID(r);if(!e)return null;let t=new Uint8Array(e.bytes.byteLength+1);return t.set(e.bytes,1),[new W(I.tag,vI),new W(I.bytes,t)]}function GK(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function XK(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}var Q7={float64:!0,typeEncoders:{Object:WK,undefined:GK,number:XK}},YK={...Q7,typeEncoders:{...Q7.typeEncoders}};function QK(r){if(r[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return q.decode(r.subarray(1))}var g2={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};g2.tags[vI]=QK;var ZK={...g2,tags:g2.tags.slice()},JK="dag-cbor",Pr=113,Ff=r=>Os(r,Q7),ji=r=>xn(AI(r),g2);var fl={};Ut(fl,{code:()=>ui,decode:()=>$f,encode:()=>w2,format:()=>uz,name:()=>lz,parse:()=>dz,stringify:()=>uz});var Z7=class extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){let t=this.inRecursive[this.inRecursive.length-1];t&&(t.type===I.array&&(t.elements++,t.elements!==1&&e.push([44])),t.type===I.map&&(t.elements++,t.elements!==1&&(t.elements%2===1?e.push([44]):e.push([58]))))}[I.uint.major](e,t){this.prefix(e);let n=String(t.value),o=[];for(let i=0;i<n.length;i++)o[i]=n.charCodeAt(i);e.push(o)}[I.negint.major](e,t){this[I.uint.major](e,t)}[I.bytes.major](e,t){throw new Error(`${Ds} unsupported type: Uint8Array`)}[I.string.major](e,t){this.prefix(e);let n=Og(JSON.stringify(t.value));e.push(n.length>32?Sp(n):n)}[I.array.major](e,t){this.prefix(e),this.inRecursive.push({type:I.array,elements:0}),e.push([91])}[I.map.major](e,t){this.prefix(e),this.inRecursive.push({type:I.map,elements:0}),e.push([123])}[I.tag.major](e,t){}[I.float.major](e,t){if(t.type.name==="break"){let s=this.inRecursive.pop();if(s){if(s.type===I.array)e.push([93]);else if(s.type===I.map)e.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(t.value===void 0)throw new Error(`${Ds} unsupported type: undefined`);if(this.prefix(e),t.type.name==="true"){e.push([116,114,117,101]);return}else if(t.type.name==="false"){e.push([102,97,108,115,101]);return}else if(t.type.name==="null"){e.push([110,117,108,108]);return}let n=String(t.value),o=[],i=!1;for(let s=0;s<n.length;s++)o[s]=n.charCodeAt(s),!i&&(o[s]===46||o[s]===101||o[s]===69)&&(i=!0);i||(o.push(46),o.push(48)),e.push(o)}};function ez(r,e){if(Array.isArray(r[0])||Array.isArray(e[0]))throw new Error(`${Ds} complex map keys are not supported`);let t=r[0],n=e[0];if(t.type!==I.string||n.type!==I.string)throw new Error(`${Ds} non-string map keys are not supported`);if(t<n)return-1;if(t>n)return 1;throw new Error(`${Ds} unexpected duplicate map keys, this is not supported`)}var tz={addBreakTokens:!0,mapSorter:ez};function Lp(r,e){return e=Object.assign({},tz,e),H7(r,new Z7,e)}var Hf=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;e===32||e===9||e===13||e===10;)e=this.data[++this._pos]}expect(e){if(this.data.length-this._pos<e.length)throw new Error(`${he} unexpected end of input at position ${this._pos}`);for(let t=0;t<e.length;t++)if(this.data[this._pos++]!==e[t])throw new Error(`${he} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){let e=this._pos,t=!1,n=!1,o=a=>{for(;!this.done();){let c=this.ch();if(a.includes(c))this._pos++;else break}};if(this.ch()===45&&(t=!0,this._pos++),this.ch()===48)if(this._pos++,this.ch()===46)this._pos++,n=!0;else return new W(I.uint,0,this._pos-e);if(o([48,49,50,51,52,53,54,55,56,57]),t&&this._pos===e+1)throw new Error(`${he} unexpected token at position ${this._pos}`);if(!this.done()&&this.ch()===46){if(n)throw new Error(`${he} unexpected token at position ${this._pos}`);n=!0,this._pos++,o([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(n=!0,this._pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this._pos++,o([48,49,50,51,52,53,54,55,56,57]));let i=String.fromCharCode.apply(null,this.data.subarray(e,this._pos)),s=parseFloat(i);return n?new W(I.float,s,this._pos-e):this.options.allowBigInt!==!0||Number.isSafeInteger(s)?new W(s>=0?I.uint:I.negint,s,this._pos-e):new W(s>=0?I.uint:I.negint,BigInt(i),this._pos-e)}parseString(){if(this.ch()!==34)throw new Error(`${he} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let i=this._pos,s=0;i<this.data.length&&s<65536;i++,s++){let a=this.data[i];if(a===92||a<32||a>=128)break;if(a===34){let c=String.fromCharCode.apply(null,this.data.subarray(this._pos,i));return this._pos=i+1,new W(I.string,c,s)}}let e=this._pos,t=[],n=()=>{if(this._pos+4>=this.data.length)throw new Error(`${he} unexpected end of unicode escape sequence at position ${this._pos}`);let i=0;for(let s=0;s<4;s++){let a=this.ch();if(a>=48&&a<=57)a-=48;else if(a>=97&&a<=102)a=a-97+10;else if(a>=65&&a<=70)a=a-65+10;else throw new Error(`${he} unexpected unicode escape character at position ${this._pos}`);i=i*16+a,this._pos++}return i},o=()=>{let i=this.ch(),s=null,a=i>239?4:i>223?3:i>191?2:1;if(this._pos+a>this.data.length)throw new Error(`${he} unexpected unicode sequence at position ${this._pos}`);let c,l,u,f;switch(a){case 1:i<128&&(s=i);break;case 2:c=this.data[this._pos+1],(c&192)===128&&(f=(i&31)<<6|c&63,f>127&&(s=f));break;case 3:c=this.data[this._pos+1],l=this.data[this._pos+2],(c&192)===128&&(l&192)===128&&(f=(i&15)<<12|(c&63)<<6|l&63,f>2047&&(f<55296||f>57343)&&(s=f));break;case 4:c=this.data[this._pos+1],l=this.data[this._pos+2],u=this.data[this._pos+3],(c&192)===128&&(l&192)===128&&(u&192)===128&&(f=(i&15)<<18|(c&63)<<12|(l&63)<<6|u&63,f>65535&&f<1114112&&(s=f))}s===null?(s=65533,a=1):s>65535&&(s-=65536,t.push(s>>>10&1023|55296),s=56320|s&1023),t.push(s),this._pos+=a};for(;!this.done();){let i=this.ch(),s;switch(i){case 92:if(this._pos++,this.done())throw new Error(`${he} unexpected string termination at position ${this._pos}`);switch(s=this.ch(),this._pos++,s){case 34:case 39:case 92:case 47:t.push(s);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(n());break;default:throw new Error(`${he} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new W(I.string,D7(t),this._pos-e);default:if(i<32)throw new Error(`${he} invalid control character at position ${this._pos}`);i<128?(t.push(i),this._pos++):o()}}throw new Error(`${he} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new W(I.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new W(I.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new W(I.null,null,4);case 102:return this.expect([102,97,108,115,101]),new W(I.false,!1,5);case 116:return this.expect([116,114,117,101]),new W(I.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${he} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this._pos++,this.skipWhitespace(),new W(I.break,void 0,1);if(this.ch()!==44)throw new Error(`${he} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this._pos++,this.skipWhitespace(),new W(I.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new W(I.break,void 0,1);if(this.ch()!==44)throw new Error(`${he} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this._pos++,this.skipWhitespace(),new W(I.break,void 0,1);let e=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${he} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${he} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}};function J7(r,e){return e=Object.assign({tokenizer:new Hf(r,e)},e),xn(r,e)}function nz(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function oz(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;let e=q.asCID(r);if(!e)return null;let t=e.toString();return[new W(I.map,1/0,1),new W(I.string,"/",1),new W(I.string,t,t.length),new W(I.break,void 0,1)]}function y2(r){let e=or.encode(r).slice(1);return[new W(I.map,1/0,1),new W(I.string,"/",1),new W(I.map,1/0,1),new W(I.string,"bytes",5),new W(I.string,e,e.length),new W(I.break,void 0,1),new W(I.break,void 0,1)]}function li(r){return y2(new Uint8Array(r.buffer,r.byteOffset,r.byteLength))}function iz(r){return y2(new Uint8Array(r))}function sz(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function az(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}var cz={typeEncoders:{Object:oz,Buffer:y2,Uint8Array:y2,Int8Array:li,Uint16Array:li,Int16Array:li,Uint32Array:li,Int32Array:li,Float32Array:li,Float64Array:li,Uint8ClampedArray:li,BigInt64Array:li,BigUint64Array:li,DataView:li,ArrayBuffer:iz,undefined:sz,number:az}},ex=class extends Hf{constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){let e=this._next();if(e.type===I.map){let t=this._next();if(t.type===I.string&&t.value==="/"){let n=this._next();if(n.type===I.string){if(this._next().type!==I.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(n),new W(I.tag,42,0)}if(n.type===I.map){let o=this._next();if(o.type===I.string&&o.value==="bytes"){let i=this._next();if(i.type===I.string){for(let a=0;a<2;a++)if(this._next().type!==I.break)throw new Error("Invalid encoded Bytes form");let s=or.decode(`m${i.value}`);return new W(I.bytes,s,i.value.length)}this.tokenBuffer.push(i)}this.tokenBuffer.push(o)}this.tokenBuffer.push(n)}this.tokenBuffer.push(t)}return e}},tx={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};tx.tags[42]=q.parse;var lz="dag-json",ui=297,w2=r=>Lp(r,cz),$f=r=>{let e=nz(r),t=Object.assign(tx,{tokenizer:new ex(e,tx)});return J7(e,t)},uz=r=>fz.decode(w2(r));var fz=new TextDecoder,dz=r=>$f(hz.encode(r)),hz=new TextEncoder;var Jt={};Ut(Jt,{code:()=>Qe,createLink:()=>DI,createNode:()=>RI,decode:()=>Zt,encode:()=>We,name:()=>Sz,prepare:()=>Kt,validate:()=>ox});var pz=new TextDecoder;function rx(r,e){let t=0;for(let n=0;;n+=7){if(n>=64)throw new Error("protobuf: varint overflow");if(e>=r.length)throw new Error("protobuf: unexpected end of data");let o=r[e++];if(t+=n<28?(o&127)<<n:(o&127)*2**n,o<128)break}return[t,e]}function x2(r,e){let t;[t,e]=rx(r,e);let n=e+t;if(t<0||n<0)throw new Error("protobuf: invalid length");if(n>r.length)throw new Error("protobuf: unexpected end of data");return[r.subarray(e,n),n]}function EI(r,e){let t;return[t,e]=rx(r,e),[t&7,t>>3,e]}function mz(r){let e={},t=r.length,n=0;for(;n<t;){let o,i;if([o,i,n]=EI(r,n),i===1){if(e.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(o!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${o}) for Hash`);if(e.Name!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[e.Hash,n]=x2(r,n)}else if(i===2){if(e.Name!==void 0)throw new Error("protobuf: (PBLink) duplicate Name section");if(o!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${o}) for Name`);if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let s;[s,n]=x2(r,n),e.Name=pz.decode(s)}else if(i===3){if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(o!==0)throw new Error(`protobuf: (PBLink) wrong wireType (${o}) for Tsize`);[e.Tsize,n]=rx(r,n)}else throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${i}`)}if(n>t)throw new Error("protobuf: (PBLink) unexpected end of data");return e}function SI(r){let e=r.length,t=0,n,o=!1,i;for(;t<e;){let a,c;if([a,c,t]=EI(r,t),a!==2)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${a}`);if(c===1){if(i)throw new Error("protobuf: (PBNode) duplicate Data section");[i,t]=x2(r,t),n&&(o=!0)}else if(c===2){if(o)throw new Error("protobuf: (PBNode) duplicate Links section");n||(n=[]);let l;[l,t]=x2(r,t),n.push(mz(l))}else throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${c}`)}if(t>e)throw new Error("protobuf: (PBNode) unexpected end of data");let s={};return i&&(s.Data=i),s.Links=n||[],s}var CI=new TextEncoder,_I=2**32,gz=2**31;function yz(r,e){let t=e.length;if(typeof r.Tsize=="number"){if(r.Tsize<0)throw new Error("Tsize cannot be negative");if(!Number.isSafeInteger(r.Tsize))throw new Error("Tsize too large for encoding");t=Bp(e,t,r.Tsize)-1,e[t]=24}if(typeof r.Name=="string"){let n=CI.encode(r.Name);t-=n.length,e.set(n,t),t=Bp(e,t,n.length)-1,e[t]=18}return r.Hash&&(t-=r.Hash.length,e.set(r.Hash,t),t=Bp(e,t,r.Hash.length)-1,e[t]=10),e.length-t}function II(r){let e=xz(r),t=new Uint8Array(e),n=e;if(r.Data&&(n-=r.Data.length,t.set(r.Data,n),n=Bp(t,n,r.Data.length)-1,t[n]=10),r.Links)for(let o=r.Links.length-1;o>=0;o--){let i=yz(r.Links[o],t.subarray(0,n));n-=i,n=Bp(t,n,i)-1,t[n]=18}return t}function wz(r){let e=0;if(r.Hash){let t=r.Hash.length;e+=1+t+Vf(t)}if(typeof r.Name=="string"){let t=CI.encode(r.Name).length;e+=1+t+Vf(t)}return typeof r.Tsize=="number"&&(e+=1+Vf(r.Tsize)),e}function xz(r){let e=0;if(r.Data){let t=r.Data.length;e+=1+t+Vf(t)}if(r.Links)for(let t of r.Links){let n=wz(t);e+=1+n+Vf(n)}return e}function Bp(r,e,t){e-=Vf(t);let n=e;for(;t>=gz;)r[e++]=t&127|128,t/=128;for(;t>=128;)r[e++]=t&127|128,t>>>=7;return r[e]=t,n}function Vf(r){return r%2===0&&r++,Math.floor((bz(r)+6)/7)}function bz(r){let e=0;return r>=_I&&(r=Math.floor(r/_I),e=32),r>=65536&&(r>>>=16,e+=16),r>=256&&(r>>>=8,e+=8),e+vz[r]}var vz=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8];var Az=["Data","Links"],Ez=["Hash","Name","Tsize"],nx=new TextEncoder;function kI(r,e){if(r===e)return 0;let t=r.Name?nx.encode(r.Name):[],n=e.Name?nx.encode(e.Name):[],o=t.length,i=n.length;for(let s=0,a=Math.min(o,i);s<a;++s)if(t[s]!==n[s]){o=t[s],i=n[s];break}return o<i?-1:i<o?1:0}function TI(r,e){return!Object.keys(r).some(t=>!e.includes(t))}function PI(r){if(typeof r.asCID=="object"){let t=q.asCID(r);if(!t)throw new TypeError("Invalid DAG-PB form");return{Hash:t}}if(typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");let e={};if(r.Hash){let t=q.asCID(r.Hash);try{t||(typeof r.Hash=="string"?t=q.parse(r.Hash):r.Hash instanceof Uint8Array&&(t=q.decode(r.Hash)))}catch(n){throw new TypeError(`Invalid DAG-PB form: ${n.message}`)}t&&(e.Hash=t)}if(!e.Hash)throw new TypeError("Invalid DAG-PB form");return typeof r.Name=="string"&&(e.Name=r.Name),typeof r.Tsize=="number"&&(e.Tsize=r.Tsize),e}function Kt(r){if((r instanceof Uint8Array||typeof r=="string")&&(r={Data:r}),typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");let e={};if(r.Data!==void 0)if(typeof r.Data=="string")e.Data=nx.encode(r.Data);else if(r.Data instanceof Uint8Array)e.Data=r.Data;else throw new TypeError("Invalid DAG-PB form");if(r.Links!==void 0)if(Array.isArray(r.Links))e.Links=r.Links.map(PI),e.Links.sort(kI);else throw new TypeError("Invalid DAG-PB form");else e.Links=[];return e}function ox(r){if(!r||typeof r!="object"||Array.isArray(r)||r instanceof Uint8Array||r["/"]&&r["/"]===r.bytes)throw new TypeError("Invalid DAG-PB form");if(!TI(r,Az))throw new TypeError("Invalid DAG-PB form (extraneous properties)");if(r.Data!==void 0&&!(r.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form (Data must be bytes)");if(!Array.isArray(r.Links))throw new TypeError("Invalid DAG-PB form (Links must be a list)");for(let e=0;e<r.Links.length;e++){let t=r.Links[e];if(!t||typeof t!="object"||Array.isArray(t)||t instanceof Uint8Array||t["/"]&&t["/"]===t.bytes)throw new TypeError("Invalid DAG-PB form (bad link)");if(!TI(t,Ez))throw new TypeError("Invalid DAG-PB form (extraneous properties on link)");if(t.Hash===void 0)throw new TypeError("Invalid DAG-PB form (link must have a Hash)");if(t.Hash==null||!t.Hash["/"]||t.Hash["/"]!==t.Hash.bytes)throw new TypeError("Invalid DAG-PB form (link Hash must be a CID)");if(t.Name!==void 0&&typeof t.Name!="string")throw new TypeError("Invalid DAG-PB form (link Name must be a string)");if(t.Tsize!==void 0){if(typeof t.Tsize!="number"||t.Tsize%1!==0)throw new TypeError("Invalid DAG-PB form (link Tsize must be an integer)");if(t.Tsize<0)throw new TypeError("Invalid DAG-PB form (link Tsize cannot be negative)")}if(e>0&&kI(t,r.Links[e-1])===-1)throw new TypeError("Invalid DAG-PB form (links must be sorted by Name bytes)")}}function RI(r,e=[]){return Kt({Data:r,Links:e})}function DI(r,e,t){return PI({Hash:t,Name:r,Tsize:e})}function NI(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}var Sz="dag-pb",Qe=112;function We(r){ox(r);let e={};return r.Links&&(e.Links=r.Links.map(t=>{let n={};return t.Hash&&(n.Hash=t.Hash.bytes),t.Name!==void 0&&(n.Name=t.Name),t.Tsize!==void 0&&(n.Tsize=t.Tsize),n})),r.Data&&(e.Data=r.Data),II(e)}function Zt(r){let e=NI(r),t=SI(e),n={};return t.Data&&(n.Data=t.Data),t.Links&&(n.Links=t.Links.map(o=>{let i={};try{i.Hash=q.decode(o.Hash)}catch{}if(!i.Hash)throw new Error("Invalid Hash field found in link, expected CID");return o.Name!==void 0&&(i.Name=o.Name),o.Tsize!==void 0&&(i.Tsize=o.Tsize),i})),n}function Kf(r){return r?.then!=null}function OI(r=[],e){let t={[Qe]:Jt,[mt]:Cn,[Pr]:Bs,[ui]:fl,[Bi]:rf};return r.forEach(n=>{t[n.code]=n}),async n=>{let o=t[n];if(o==null&&e!=null){let i=e(n);Kf(i)?o=await i:o=i,t[o.code]=o}if(o!=null)return o;throw new Qg(`Could not load codec for ${n}`)}}function LI(r=[],e){let t={[De.code]:De,[z0.code]:z0,[ir.code]:ir};return r.forEach(n=>{t[n.code]=n}),async n=>{let o=t[n];if(o==null&&e!=null){let i=e(n);Kf(i)?o=await i:o=i,t[o.code]=o}if(o!=null)return o;throw new Yg(`No hasher configured for multihash code 0x${n.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`)}}var ko=class r extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=r.name;code=r.code;constructor(e="Not Found"){super(e)}};var Ms=class{has(e,t){return Promise.reject(new Error(".has is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}async*putMany(e,t){for await(let{cid:n,block:o}of e)await this.put(n,o,t),yield n}get(e,t){return Promise.reject(new Error(".get is not implemented"))}async*getMany(e,t){for await(let n of e)yield{cid:n,block:await this.get(n,t)}}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(e,t){for await(let n of e)await this.delete(n,t),yield n}async*getAll(e){throw new Error(".getAll is not implemented")}};var b2=0,v2=class extends Ms{child;constructor(e){super(),this.child=e}put(e,t,n){return e.multihash.code===b2||this.child==null?(n?.signal?.throwIfAborted(),e):this.child.put(e,t,n)}get(e,t){if(e.multihash.code===b2)return t?.signal?.throwIfAborted(),e.multihash.digest;if(this.child==null)throw t?.signal?.throwIfAborted(),new ko;return this.child.get(e,t)}has(e,t){return e.multihash.code===b2?(t?.signal?.throwIfAborted(),!0):this.child==null?(t?.signal?.throwIfAborted(),!1):this.child.has(e,t)}delete(e,t){if(e.code===b2){t?.signal?.throwIfAborted();return}if(this.child!=null)return this.child.delete(e,t)}getAll(e){return this.child!=null?this.child.getAll(e):(e?.signal?.throwIfAborted(),[])}};function _z(r){return r[Symbol.asyncIterator]!=null}function Cz(r,e){let t=0;if(_z(r))return async function*(){for await(let c of r)await e(c,t++)&&(yield c)}();let n=ef(r),{value:o,done:i}=n.next();if(i===!0)return function*(){}();let s=e(o,t++);if(typeof s.then=="function")return async function*(){await s&&(yield o);for(let c of n)await e(c,t++)&&(yield c)}();let a=e;return function*(){s===!0&&(yield o);for(let c of n)a(c,t++)&&(yield c)}()}var ao=Cz;function Iz(r){return r[Symbol.asyncIterator]!=null}function BI(r){return r?.then!=null}function Tz(r,e){let t=0;if(Iz(r))return async function*(){for await(let c of r){let l=e(c,t++);BI(l)&&await l,yield c}}();let n=ef(r),{value:o,done:i}=n.next();if(i===!0)return function*(){}();if(typeof e(o,t++)?.then=="function")return async function*(){yield o;for(let c of n){let l=e(c,t++);BI(l)&&await l,yield c}}();let a=e;return function*(){yield o;for(let c of n)a(c,t++),yield c}()}var dl=Tz;var A2=class{child;getHasher;log;logger;components;constructor(e){this.log=e.logger.forComponent("helia:networked-storage"),this.logger=e.logger,this.components=e,this.child=new v2(e.blockstore),this.getHasher=e.getHasher}async put(e,t,n={}){return await this.child.has(e,n)?(n.onProgress?.(new j("blocks:put:duplicate",e)),e):(n.onProgress?.(new j("blocks:put:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async o=>o.announce?.(e,t,n))),n.onProgress?.(new j("blocks:put:blockstore:put",e)),this.child.put(e,t,n))}async*putMany(e,t={}){let n=ao(e,async({cid:i})=>{let s=await this.child.has(i,t);return s&&t.onProgress?.(new j("blocks:put-many:duplicate",i)),!s}),o=dl(n,async({cid:i,block:s})=>{t.onProgress?.(new j("blocks:put-many:providers:notify",i)),await Promise.all(this.components.blockBrokers.map(async a=>a.announce?.(i,s,t)))});t.onProgress?.(new j("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(o,t)}async get(e,t={}){if(t.offline!==!0&&!await this.child.has(e,t)){let n=await this.getHasher(e.multihash.code);t.onProgress?.(new j("blocks:get:providers:get",e));let o=await MI(e,this.components.blockBrokers,n,{...t,log:this.log});return t.onProgress?.(new j("blocks:get:blockstore:put",e)),await this.child.put(e,o,t),t.onProgress?.(new j("blocks:get:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async i=>i.announce?.(e,o,t))),o}return t.onProgress?.(new j("blocks:get:blockstore:get",e)),this.child.get(e,t)}async*getMany(e,t={}){t.onProgress?.(new j("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(dl(e,async n=>{if(t.offline!==!0&&!await this.child.has(n,t)){let o=await this.getHasher(n.multihash.code);t.onProgress?.(new j("blocks:get-many:providers:get",n));let i=await MI(n,this.components.blockBrokers,o,{...t,log:this.log});t.onProgress?.(new j("blocks:get-many:blockstore:put",n)),await this.child.put(n,i,t),t.onProgress?.(new j("blocks:get-many:providers:notify",n)),await Promise.all(this.components.blockBrokers.map(async s=>s.announce?.(n,i,t)))}}))}async delete(e,t={}){t.onProgress?.(new j("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){t.onProgress?.(new j("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany(async function*(){for await(let n of e)yield n}(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){e.onProgress?.(new j("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}},E2=class extends A2{started;constructor(e){super(e),this.started=!1}isStarted(){return this.started}async start(){await Sr(this.child,...this.components.blockBrokers),this.started=!0}async stop(){await Wr(this.child,...this.components.blockBrokers),this.started=!1}unwrap(){return this.child}createSession(e,t){let n=this.components.blockBrokers.map(o=>o.createSession==null?o:o.createSession(t));return new ix({blockstore:this.child,blockBrokers:n,getHasher:this.getHasher,logger:this.logger},{root:e})}},ix=class extends A2{closeController;constructor(e,t){super(e),this.closeController=new AbortController,this.closeController.signal,this.log=e.logger.forComponent(`helia:session-storage:${t.root}`)}close(){this.closeController.abort()}async put(e,t,n={}){let o=ke([this.closeController.signal,n.signal]);try{return await super.put(e,t,{...n,signal:o})}finally{o.clear()}}async*putMany(e,t={}){let n=ke([this.closeController.signal,t.signal]);try{yield*super.putMany(e,{...t,signal:n})}finally{n.clear()}}async get(e,t={}){let n=ke([this.closeController.signal,t.signal]);try{return await super.get(e,{...t,signal:n})}finally{n.clear()}}async*getMany(e,t={}){let n=ke([this.closeController.signal,t.signal]);try{yield*super.getMany(e,{...t,signal:n})}finally{n.clear()}}async delete(e,t={}){let n=ke([this.closeController.signal,t.signal]);try{await super.delete(e,{...t,signal:n})}finally{n.clear()}}async*deleteMany(e,t={}){let n=ke([this.closeController.signal,t.signal]);try{yield*super.deleteMany(e,{...t,signal:n})}finally{n.clear()}}async has(e,t={}){let n=ke([this.closeController.signal,t.signal]);try{return await super.has(e,{...t,signal:n})}finally{n.clear()}}async*getAll(e={}){let t=ke([this.closeController.signal,e.signal]);try{yield*super.getAll({...e,signal:t})}finally{t.clear()}}};function kz(r){return typeof r.retrieve=="function"}var Pz=(r,e)=>{if(e==null)throw new $(`No hasher configured for multihash code 0x${r.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`);return async t=>{let n,o=e.digest(t);if(Kf(o)?n=await o:n=o,!de(n.digest,r.multihash.digest))throw new ya("Hash of downloaded block did not match multihash from passed CID")}};async function MI(r,e,t,n){let o=Pz(r,t),i=new AbortController,s=ke([i.signal,n.signal]);i.signal;let a=[];for(let c of e)kz(c)&&a.push(c);try{return await Promise.any(a.map(async c=>{try{let l=!1,u=await c.retrieve(r,{...n,signal:s,validateFn:async f=>{await o(f),l=!0}});return l||await o(u),u}catch(l){throw n.log.error("could not retrieve verified block for %c",r,l),l}}))}finally{i.abort(),s.clear()}}var hl=class extends Re{initialPeerSearchComplete;requests;name;log;logger;minProviders;maxProviders;providers;evictionFilter;initialProviders;constructor(e,t){super(),this.name=t.name,this.logger=e.logger,this.log=e.logger.forComponent(this.name),this.requests=new Map,this.minProviders=t.minProviders??1,this.maxProviders=t.maxProviders??5,this.providers=[],this.evictionFilter=en(this.maxProviders),this.initialProviders=t.providers??[]}async retrieve(e,t={}){let n=or.encode(e.multihash.bytes),o=this.requests.get(n);if(o!=null)return this.log("join existing request for %c",e),o;let i=ve();if(this.requests.set(n,i.promise),this.providers.length===0){let u=!1;this.initialPeerSearchComplete==null&&(u=!0,this.log=this.logger.forComponent(`${this.name}:${e}`),this.initialPeerSearchComplete=this.findProviders(e,this.minProviders,t)),await this.initialPeerSearchComplete,u&&this.log("found initial session peers for %c",e)}let s=!1,a=new _r({concurrency:this.maxProviders});a.addEventListener("error",()=>{}),a.addEventListener("failure",u=>{this.log.error("error querying provider %o, evicting from session",u.detail.job.options.provider,u.detail.error),this.evict(u.detail.job.options.provider)}),a.addEventListener("success",u=>{s=!0,i.resolve(u.detail.result)}),a.addEventListener("idle",()=>{if(s||t.signal?.aborted===!0){this.log.trace("session idle, found block");return}Promise.resolve().then(async()=>{this.log("no session peers had block for for %c, finding new providers",e);for(let u=0;u<this.minProviders&&this.providers.length!==0;u++){let f=this.providers[Math.floor(Math.random()*this.providers.length)];this.evict(f)}await this.findProviders(e,this.minProviders,t),this.log("found new providers re-retrieving %c",e),this.requests.delete(n),i.resolve(await this.retrieve(e,t))}).catch(u=>{this.log.error("could not find new providers for %c",e,u),i.reject(u)})});let c=u=>{a.add(async()=>this.queryProvider(e,u.detail,t),{provider:u.detail}).catch(f=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c",e,f)})};this.addEventListener("provider",c),Promise.all([...this.providers].map(async u=>a.add(async()=>this.queryProvider(e,u,t),{provider:u}))).catch(u=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c",e,u)});let l=()=>{i.reject(new Xe(t.signal?.reason??"Session aborted")),a.abort()};t.signal?.addEventListener("abort",l);try{return await i.promise}finally{this.removeEventListener("provider",c),t.signal?.removeEventListener("abort",l),a.clear(),this.requests.delete(n)}}evict(e){this.evictionFilter.add(this.toEvictionKey(e));let t=this.providers.findIndex(n=>this.equals(n,e));t!==-1&&this.providers.splice(t,1)}isEvicted(e){return this.evictionFilter.has(this.toEvictionKey(e))}hasProvider(e){return!!(this.providers.find(t=>this.equals(t,e))!=null||this.isEvicted(e))}async findProviders(e,t,n){let o=ve(),i=0;return Promise.resolve().then(async()=>{if(this.log("finding %d-%d new provider(s) for %c",t,this.maxProviders,e),this.initialProviders.length>0)for(;i<t&&this.initialProviders.length>0;){let s=this.initialProviders.pop();if(s==null)break;let a=await this.convertToProvider(s,n);if(n.signal?.aborted===!0)break;if(a!=null&&!this.hasProvider(a)&&(this.log("found %d/%d new providers",i,this.maxProviders),this.providers.push(a),this.safeDispatchEvent("provider",{detail:a}),i++,i===t&&(this.log("session is ready"),o.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",i);break}}if(i<this.maxProviders)for await(let s of this.findNewProviders(e,n)){if(i===this.maxProviders||n.signal?.aborted===!0)break;if(!this.hasProvider(s)&&(this.log("found %d/%d new providers",i,this.maxProviders),this.providers.push(s),this.safeDispatchEvent("provider",{detail:s}),i++,i===t&&(this.log("session is ready"),o.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",i);break}}if(this.log("found %d/%d new session peers",i,this.maxProviders),i<t)throw new Xg(`Found ${i} of ${t} ${this.name} providers for ${e}`)}).catch(s=>{this.log.error("error searching routing for potential session peers for %c",e,s.errors??s),o.reject(s)}),o.promise}};var S2=class{blockstore;datastore;pins;logger;routing;getCodec;getHasher;dns;metrics;log;constructor(e){this.logger=e.logger??ka(),this.log=this.logger.forComponent("helia"),this.getHasher=LI(e.hashers,e.loadHasher),this.getCodec=OI(e.codecs,e.loadCodec),this.dns=e.dns??sl(),this.metrics=e.metrics;let t={blockstore:e.blockstore,datastore:e.datastore,logger:this.logger,blockBrokers:[],getHasher:this.getHasher,getCodec:this.getCodec,dns:this.dns,metrics:this.metrics,...e.components??{}};this.routing=t.routing=new Zg(t,{routers:(e.routers??[]).flatMap(o=>{let i=[o];return o[Ni]!=null&&i.push(o[Ni]),o[Oi]!=null&&i.push(o[Oi]),i}),providerLookupConcurrency:e.providerLookupConcurrency});let n=new E2(t);this.pins=new Gg(e.datastore,n,this.getCodec),this.blockstore=new m2(n,this.pins,{holdGcLock:e.holdGcLock??!0}),this.datastore=e.datastore,t.blockBrokers=e.blockBrokers.map(o=>o(t))}async start(){await bI(this.datastore),await Sr(this.blockstore,this.datastore,this.routing)}async stop(){await Wr(this.blockstore,this.datastore,this.routing)}async gc(e={}){let t=await this.blockstore.lock.writeLock();try{let n=this,o=this.blockstore.unwrap();this.log("gc start"),await Gr(o.deleteMany(async function*(){for await(let{cid:i}of o.getAll())try{if(await n.pins.isPinned(i,e))continue;yield i,e.onProgress?.(new j("helia:gc:deleted",i))}catch(s){n.log.error("Error during gc",s),e.onProgress?.(new j("helia:gc:error",s))}}()))}finally{t()}this.log("gc finished")}};var sx=class extends hl{wantList;network;libp2p;constructor(e,t){super(e,{...t,name:"helia:bitswap:session"}),this.wantList=e.wantList,this.network=e.network,this.libp2p=e.libp2p}async queryProvider(e,t,n){this.log("sending WANT-BLOCK for %c to %p",e,t);let o=await this.wantList.wantSessionBlock(e,t,n);if(this.log("%p %s %c",t,o.has?"has":"does not have",e),o.has&&o.block!=null)return o.block;throw new Error("Provider did not have block")}async*findNewProviders(e,t={}){for await(let n of this.network.findProviders(e,t))yield n.id}toEvictionKey(e){return e.toMultihash().bytes}equals(e,t){return e.equals(t)}async convertToProvider(e,t){return vo(e)?e:(await this.libp2p.dial(e,t)).remotePeer}};function UI(r,e){return new sx(r,e)}var _2=class{blocksReceived;duplicateBlocksReceived;dataReceived;duplicateDataReceived;constructor(e){this.blocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_received_blocks"),this.duplicateBlocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_received_blocks"),this.dataReceived=e.metrics?.registerMetricGroup("helia_bitswap_data_received_bytes"),this.duplicateDataReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_data_received_bytes")}updateBlocksReceived(e=1,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.blocksReceived?.increment(n)}updateDuplicateBlocksReceived(e=1,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.duplicateBlocksReceived?.increment(n)}updateDataReceived(e,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.dataReceived?.increment(n)}updateDuplicateDataReceived(e,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.duplicateDataReceived?.increment(n)}};var ax=class extends Map{metric;constructor(e){super();let{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function lr(r){let{name:e,metrics:t}=r,n;return t!=null?n=new ax({name:e,metrics:t}):n=new Map,n}function Nz(r){if(!(r instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");let e=[];for(;r.length>0;){let t=Yo(r);e.push(t),r=r.slice(Ke(t))}return e}var FI=Nz;var C2=class extends Re{peers;wants;network;log;sendMessagesDelay;sendMessagesTimeout;hashLoader;sendingMessages;constructor(e,t={}){super(),this.peers=ks({name:"helia_bitswap_peers",metrics:e.metrics}),this.wants=lr({name:"helia_bitswap_wantlist",metrics:e.metrics}),this.network=e.network,this.sendMessagesDelay=t.sendMessagesDelay??10,this.log=e.logger.forComponent("helia:bitswap:wantlist"),this.hashLoader=t.hashLoader,this.network.addEventListener("bitswap:message",n=>{this.receiveMessage(n.detail.peer,n.detail.message).catch(o=>{this.log.error("error receiving bitswap message from %p",n.detail.peer,o)})}),this.network.addEventListener("peer:connected",n=>{this.peerConnected(n.detail).catch(o=>{this.log.error("error processing newly connected bitswap peer %p",n.detail,o)})}),this.network.addEventListener("peer:disconnected",n=>{this.peerDisconnected(n.detail)})}async addEntry(e,t){let n=K(e.multihash.bytes,"base64"),o=this.wants.get(n);o==null&&(o={cid:e,priority:t.priority??1,wantType:t.wantType??Yt.WantBlock,cancel:!1,sendDontHave:!0},this.wants.set(n,o)),o.wantType===Yt.WantHave&&t.wantType===Yt.WantBlock&&(o.wantType=Yt.WantBlock),await this.sendMessagesDebounced();try{return t.wantType===Yt.WantBlock?(await Ft(this,"block",t?.signal,{filter:a=>de(e.multihash.digest,a.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail:(await Ft(this,"presence",t?.signal,{filter:s=>de(e.multihash.digest,s.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail}finally{t.signal?.aborted===!0&&(this.log("want for %c was aborted, cancelling want",e),o.cancel=!0,await this.sendMessagesDebounced())}}async sendMessagesDebounced(){await this.sendingMessages?.promise,clearTimeout(this.sendMessagesTimeout),this.sendMessagesTimeout=setTimeout(()=>{this.sendMessages().catch(e=>{this.log("error sending messages to peers",e)})},this.sendMessagesDelay)}async sendMessages(){this.sendingMessages=ve(),await Promise.all([...this.peers.entries()].map(async([e,t])=>{let n=new Set,o=new Ps;for(let[i,s]of this.wants.entries())t.has(i)||s.cancel||(n.add(i),o.addWantlistEntry(s.cid,{cid:s.cid.bytes,priority:s.priority,wantType:s.wantType,cancel:s.cancel,sendDontHave:s.sendDontHave}));if(o.wantlist.size!==0)try{await this.network.sendMessage(e,o);for(let i of n)t.add(i)}catch(i){this.log.error("error sending full wantlist to new peer",i)}})).catch(e=>{this.log.error("error sending messages",e)});for(let[e,t]of this.wants)if(t.cancel){this.wants.delete(e);for(let n of this.peers.values())n.delete(e)}this.sendingMessages.resolve()}has(e){let t=K(e.multihash.bytes,"base64");return this.wants.has(t)}async wantSessionPresence(e,t,n={}){let o=new Ps;return o.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:Yt.WantHave,priority:1}),await this.network.sendMessage(t,o),(await Ft(this,"presence",n.signal,{filter:s=>t.equals(s.detail.sender)&&de(e.multihash.digest,s.detail.cid.multihash.digest)})).detail}async wantBlock(e,t={}){return this.addEntry(e,{...t,wantType:Yt.WantBlock})}async wantSessionBlock(e,t,n={}){let o=new Ps;return o.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:Yt.WantBlock,priority:1}),await this.network.sendMessage(t,o),(await Ft(this,"presence",n.signal,{filter:s=>t.equals(s.detail.sender)&&de(e.multihash.digest,s.detail.cid.multihash.digest)})).detail}async receivedBlock(e,t){let n=K(e.multihash.bytes,"base64"),o=this.wants.get(n);o!=null&&(o.cancel=!0,await this.sendMessagesDebounced())}async receiveMessage(e,t){this.log("received message from %p with %d blocks",e,t.blocks.length);let n=!1;for(let o of t.blocks){if(o.prefix==null||o.data==null)continue;let i=FI(o.prefix),s=i[0],a=i[1],c=i[2],l=c===De.code?De:await this.hashLoader?.getHasher(c);if(l==null){this.log.error("unknown hash algorithm",c);continue}let u=l.digest(o.data);u.then!=null&&(u=await u);let f=q.create(s===0?0:1,a,u);this.log("received block from %p for %c",e,f),this.safeDispatchEvent("block",{detail:{sender:e,cid:f,block:o.data}}),this.safeDispatchEvent("presence",{detail:{sender:e,cid:f,has:!0,block:o.data}});let h=K(f.multihash.bytes,"base64"),d=this.wants.get(h);d!=null&&(d.cancel=!0,n=!0)}for(let{cid:o,type:i}of t.blockPresences){let s=q.decode(o);this.log("received %s from %p for %c",i,e,s),this.safeDispatchEvent("presence",{detail:{sender:e,cid:s,has:i===_o.HaveBlock}})}n&&await this.sendMessagesDebounced()}async peerConnected(e){let t=new Set,n=new Ps(!0);for(let[o,i]of this.wants.entries())i.cancel||(t.add(o),n.addWantlistEntry(i.cid,{cid:i.cid.bytes,priority:1,wantType:Yt.WantBlock,cancel:!1,sendDontHave:!1}));if(n.wantlist.size===0){this.peers.set(e,t);return}try{await this.network.sendMessage(e,n),this.peers.set(e,t)}catch(o){this.log.error("error sending full wantlist to new peer %p",e,o)}}peerDisconnected(e){this.peers.delete(e)}start(){}stop(){this.peers.clear(),clearTimeout(this.sendMessagesTimeout)}};var I2=class{log;logger;stats;network;blockstore;peerWantLists;wantList;libp2p;constructor(e,t={}){this.logger=e.logger,this.log=e.logger.forComponent("helia:bitswap"),this.blockstore=e.blockstore,this.libp2p=e.libp2p,this.stats=new _2(e),this.network=new Q0(e,t),this.peerWantLists=new _g({...e,network:this.network},t),this.wantList=new C2({...e,network:this.network},t)}createSession(e={}){return UI({wantList:this.wantList,network:this.network,logger:this.logger,libp2p:this.libp2p},e)}async want(e,t={}){let n=new AbortController,o=ke([n.signal,t.signal]);n.signal,this.network.findAndConnect(e,{...t,signal:o}).catch(i=>{n.signal.aborted||this.log.error("error during finding and connect for cid %c",e,i)});try{return(await this.wantList.wantBlock(e,{...t,signal:o})).block}finally{n.abort(),o.clear()}}async notify(e,t,n={}){await Promise.all([this.peerWantLists.receivedBlock(e,n),this.wantList.receivedBlock(e,n)])}getWantlist(){return[...this.wantList.wants.values()].filter(e=>!e.cancel).map(e=>({cid:e.cid,priority:e.priority,wantType:e.wantType}))}getPeerWantlist(e){return this.peerWantLists.wantListForPeer(e)}async start(){this.wantList.start(),await this.network.start()}async stop(){this.wantList.stop(),await this.network.stop()}};var HI=(r,e={})=>new I2(r,e);var cx=class{bitswap;started;constructor(e,t={}){let{getHasher:n}=e;this.bitswap=HI(e,{hashLoader:{getHasher:async o=>n(o)},...t}),this.started=!1}isStarted(){return this.started}async start(){await this.bitswap.start(),this.started=!0}async stop(){await this.bitswap.stop(),this.started=!1}async announce(e,t,n){await this.bitswap.notify(e,t,n)}async retrieve(e,t={}){return this.bitswap.want(e,t)}createSession(e){let t=this.bitswap.createSession(e);return{announce:async(n,o,i)=>{await this.bitswap.notify(n,o,i)},retrieve:async(n,o)=>t.retrieve(n,o)}}};function Mp(r={}){return e=>new cx(e,r)}var Rr=class extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"},Us=class extends Error{static name="ValidationError";name="ValidationError"},Up=class extends Error{static name="InvalidParametersError";name="InvalidParametersError"},T2=class extends Error{static name="InvalidProtocolError";name="InvalidProtocolError"};var k2=class{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){let t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){let t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{let t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,o){return this.readAtomically(()=>{let i=0,s=0,a=this.peekChar();if(a===void 0)return;let c=a==="0",l=2**(8*o)-1;for(;;){let u=this.readAtomically(()=>{let f=this.readChar();if(f===void 0)return;let h=Number.parseInt(f,e);if(!Number.isNaN(h))return h});if(u===void 0)break;if(i*=e,i+=u,i>l||(s+=1,t!==void 0&&s>t))return}if(s!==0)return!n&&c&&s>1?void 0:i})}readIPv4Addr(){return this.readAtomically(()=>{let e=new Uint8Array(4);for(let t=0;t<e.length;t++){let n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){let e=t=>{for(let n=0;n<t.length/2;n++){let o=n*2;if(n<t.length-3){let s=this.readSeparator(":",n,()=>this.readIPv4Addr());if(s!==void 0)return t[o]=s[0],t[o+1]=s[1],t[o+2]=s[2],t[o+3]=s[3],[o+4,!0]}let i=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(i===void 0)return[o,!1];t[o]=i>>8,t[o+1]=i&255}return[t.length,!1]};return this.readAtomically(()=>{let t=new Uint8Array(16),[n,o]=e(t);if(n===16)return t;if(o||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;let i=new Uint8Array(14),s=16-(n+2),[a]=e(i.subarray(0,s));return t.set(i.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}};var $I=45,Oz=15,zf=new k2;function P2(r){if(!(r.length>Oz))return zf.new(r).parseWith(()=>zf.readIPv4Addr())}function R2(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>$I))return zf.new(r).parseWith(()=>zf.readIPv6Addr())}function qf(r,e=!1){if(r.includes("%")&&(r=r.split("%")[0]),r.length>$I)return;let t=zf.new(r).parseWith(()=>zf.readIPAddr());if(t)return e&&t.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,t[0],t[1],t[2],t[3]]):t}function co(r){return!!P2(r)}function jf(r){return!!R2(r)}function ux(r){return e=>K(e,r)}function fx(r){return e=>L(e,r)}function Wf(r){return new DataView(r.buffer).getUint16(r.byteOffset).toString()}function pl(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,typeof r=="string"?parseInt(r):r),new Uint8Array(e)}function VI(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);let t=L(e[0],"base32"),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let o=pl(n);return je([t,o],t.length+o.length)}function KI(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);let t=Vt.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let o=pl(n);return je([t,o],t.length+o.length)}function dx(r){let e=r.subarray(0,r.length-2),t=r.subarray(r.length-2),n=K(e,"base32"),o=Wf(t);return`${n}:${o}`}var hx=function(r){r=r.toString().trim();let e=new Uint8Array(4);return r.split(/\./g).forEach((t,n)=>{let o=parseInt(t,10);if(isNaN(o)||o<0||o>255)throw new Rr("Invalid byte value in IP address");e[n]=o}),e},zI=function(r){let e=0;r=r.toString().trim();let t=r.split(":",8),n;for(n=0;n<t.length;n++){let i=co(t[n]),s;i&&(s=hx(t[n]),t[n]=K(s.subarray(0,2),"base16")),s!=null&&++n<8&&t.splice(n,0,K(s.subarray(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);let i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}let o=new Uint8Array(e+16);for(n=0;n<t.length;n++){t[n]===""&&(t[n]="0");let i=parseInt(t[n],16);if(isNaN(i)||i<0||i>65535)throw new Rr("Invalid byte value in IP address");o[e++]=i>>8&255,o[e++]=i&255}return o},qI=function(r){if(r.byteLength!==4)throw new Rr("IPv4 address was incorrect length");let e=[];for(let t=0;t<r.byteLength;t++)e.push(r[t]);return e.join(".")},jI=function(r){if(r.byteLength!==16)throw new Rr("IPv6 address was incorrect length");let e=[];for(let n=0;n<r.byteLength;n+=2){let o=r[n],i=r[n+1],s=`${o.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`;e.push(s)}let t=e.join(":");try{let n=new URL(`http://[${t}]`);return n.hostname.substring(1,n.hostname.length-1)}catch{throw new Rr(`Invalid IPv6 address "${t}"`)}};function WI(r){try{let e=new URL(`http://[${r}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new Rr(`Invalid IPv6 address "${r}"`)}}var lx=Object.values(Hc).map(r=>r.decoder),Lz=function(){let r=lx[0].or(lx[1]);return lx.slice(2).forEach(e=>r=r.or(e)),r}();function GI(r){return Lz.decode(r)}function XI(r){return e=>r.encoder.encode(e)}function Bz(r){if(parseInt(r).toString()!==r)throw new Us("Value must be an integer")}function Mz(r){if(r<0)throw new Us("Value must be a positive integer, or zero")}function Uz(r){return e=>{if(e>r)throw new Us(`Value must be smaller than or equal to ${r}`)}}function Fz(...r){return e=>{for(let t of r)t(e)}}var Fp=Fz(Bz,Mz,Uz(65535));var Dr=-1,px=class{protocolsByCode=new Map;protocolsByName=new Map;getCodec(e){let t;if(typeof e=="string"?t=this.protocolsByName.get(e):t=this.protocolsByCode.get(e),t==null)throw new T2(`Protocol ${e} was unknown`);return t}addCodec(e,t,n){this.protocolsByCode.set(e,t),this.protocolsByName.set(t.name,t),n?.forEach(o=>{this.protocolsByName.set(o,t)})}deleteCodec(e){let t=this.getCodec(e);t!=null&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(n=>{this.protocolsByName.delete(n)}))}},Tn=new px,mq=[{code:4,name:"ip4",size:32,valueToBytes:hx,bytesToValue:qI,validate:r=>{if(!co(r))throw new Us(`Invalid IPv4 address "${r}"`)}},{code:6,name:"tcp",size:16,valueToBytes:pl,bytesToValue:Wf,validate:Fp},{code:273,name:"udp",size:16,valueToBytes:pl,bytesToValue:Wf,validate:Fp},{code:33,name:"dccp",size:16,valueToBytes:pl,bytesToValue:Wf,validate:Fp},{code:41,name:"ip6",size:128,valueToBytes:zI,bytesToValue:jI,stringToValue:WI,validate:r=>{if(!jf(r))throw new Us(`Invalid IPv6 address "${r}"`)}},{code:42,name:"ip6zone",size:Dr},{code:43,name:"ipcidr",size:8,bytesToValue:ux("base10"),valueToBytes:fx("base10")},{code:53,name:"dns",size:Dr,resolvable:!0},{code:54,name:"dns4",size:Dr,resolvable:!0},{code:55,name:"dns6",size:Dr,resolvable:!0},{code:56,name:"dnsaddr",size:Dr,resolvable:!0},{code:132,name:"sctp",size:16,valueToBytes:pl,bytesToValue:Wf,validate:Fp},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:Dr,path:!0,stringToValue:r=>decodeURIComponent(r),valueToString:r=>encodeURIComponent(r)},{code:421,name:"p2p",aliases:["ipfs"],size:Dr,bytesToValue:ux("base58btc"),valueToBytes:r=>r.startsWith("Q")||r.startsWith("1")?fx("base58btc")(r):q.parse(r).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:dx,valueToBytes:VI},{code:445,name:"onion3",size:296,bytesToValue:dx,valueToBytes:KI},{code:446,name:"garlic64",size:Dr},{code:447,name:"garlic32",size:Dr},{code:448,name:"tls"},{code:449,name:"sni",size:Dr},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:Dr,bytesToValue:XI(Es),valueToBytes:GI},{code:480,name:"http"},{code:481,name:"http-path",size:Dr,stringToValue:r=>`/${decodeURIComponent(r)}`,valueToString:r=>encodeURIComponent(r.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:Dr}];mq.forEach(r=>{Tn.addCodec(r.code,r,r.aliases)});function YI(r){let e=[],t=0;for(;t<r.length;){let n=Yo(r,t),o=Tn.getCodec(n),i=Ke(n),s=gq(o,r,t+i),a=0;s>0&&o.size===Dr&&(a=Ke(s));let c=i+a+s,l={code:n,name:o.name,bytes:r.subarray(t,t+c)};if(s>0){let u=t+i+a,f=r.subarray(u,u+s);l.value=o.bytesToValue?.(f)??K(f)}e.push(l),t+=c}return e}function QI(r){let e=0,t=[];for(let n of r){if(n.bytes==null){let o=Tn.getCodec(n.code),i=Ke(n.code),s,a=0,c=0;n.value!=null&&(s=o.valueToBytes?.(n.value)??L(n.value),a=s.byteLength,o.size===Dr&&(c=Ke(a)));let l=new Uint8Array(i+c+a),u=0;Zu(n.code,l,u),u+=i,s!=null&&(o.size===Dr&&(Zu(a,l,u),u+=c),l.set(s,u)),n.bytes=l}t.push(n.bytes),e+=n.bytes.byteLength}return je(t,e)}function ZI(r){if(r.charAt(0)!=="/")throw new Rr('String multiaddr must start with "/"');let e=[],t="protocol",n="",o="";for(let i=1;i<r.length;i++){let s=r.charAt(i);s!=="/"&&(t==="protocol"?o+=r.charAt(i):n+=r.charAt(i));let a=i===r.length-1;if(s==="/"||a){let c=Tn.getCodec(o);if(t==="protocol"){if(c.size==null||c.size===0){e.push({code:c.code,name:c.name}),n="",o="",t="protocol";continue}else if(a)throw new Rr(`Component ${o} was missing value`);t="value"}else if(t==="value"){let l={code:c.code,name:c.name};if(c.size!=null&&c.size!==0){if(n==="")throw new Rr(`Component ${o} was missing value`);l.value=c.stringToValue?.(n)??n}e.push(l),n="",o="",t="protocol"}}}if(o!==""&&n!=="")throw new Rr("Incomplete multiaddr");return e}function JI(r){return`/${r.flatMap(e=>{if(e.value==null)return e.name;let t=Tn.getCodec(e.code);if(t==null)throw new Rr(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`}function gq(r,e,t){return r.size==null||r.size===0?0:r.size>0?r.size/8:Yo(e,t)}var yq=Symbol.for("nodejs.util.inspect.custom"),wx=Symbol.for("@multiformats/multiaddr"),wq=[53,54,55,56],yx=class extends Error{constructor(e="No available resolver"){super(e),this.name="NoAvailableResolverError"}};function xq(r){if(r==null&&(r="/"),Da(r))return r.getComponents();if(r instanceof Uint8Array)return YI(r);if(typeof r=="string")return r=r.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),r===""&&(r="/"),ZI(r);if(Array.isArray(r))return r;throw new Rr("Must be a string, Uint8Array, Component[], or another Multiaddr")}var O2=class r{[wx]=!0;#e;#t;#r;constructor(e="/",t={}){this.#e=xq(e),t.validate!==!1&&bq(this)}get bytes(){return this.#r==null&&(this.#r=QI(this.#e)),this.#r}toString(){return this.#t==null&&(this.#t=JI(this.#e)),this.#t}toJSON(){return this.toString()}toOptions(){let e,t,n,o,i="";for(let{code:a,name:c,value:l}of this.#e)a===42&&(i=`%${l??""}`),wq.includes(a)&&(t="tcp",o=443,n=`${l??""}${i}`,e=a===55?6:4),(a===6||a===273)&&(t=c==="tcp"?"tcp":"udp",o=parseInt(l??"")),(a===4||a===41)&&(t="tcp",n=`${l??""}${i}`,e=a===41?6:4);if(e==null||t==null||n==null||o==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:o}}getComponents(){return[...this.#e]}protos(){return this.#e.map(({code:e,value:t})=>{let n=Tn.getCodec(e);return{code:e,size:n.size??0,name:n.name,resolvable:!!n.resolvable,path:!!n.path}})}protoCodes(){return this.#e.map(({code:e})=>e)}protoNames(){return this.#e.map(({name:e})=>e)}tuples(){return this.#e.map(({code:e,value:t})=>{if(t==null)return[e];let n=Tn.getCodec(e),o=[e];return t!=null&&o.push(n.valueToBytes?.(t)??L(t)),o})}stringTuples(){return this.#e.map(({code:e,value:t})=>t==null?[e]:[e,t])}encapsulate(e){let t=new r(e);return new r([...this.#e,...t.getComponents()],{validate:!1})}decapsulate(e){let t=e.toString(),n=this.toString(),o=n.lastIndexOf(t);if(o<0)throw new Up(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new r(n.slice(0,o),{validate:!1})}decapsulateCode(e){let t;for(let n=this.#e.length-1;n>-1;n--)if(this.#e[n].code===e){t=n;break}return new r(this.#e.slice(0,t),{validate:!1})}getPeerId(){try{let e=[];this.#e.forEach(({code:n,value:o})=>{n===421&&e.push([n,o]),n===290&&(e=[])});let t=e.pop();if(t?.[1]!=null){let n=t[1];return n[0]==="Q"||n[0]==="1"?K(Ve.decode(`z${n}`),"base58btc"):K(q.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){for(let e of this.#e)if(Tn.getCodec(e.code).path)return e.value??null;return null}equals(e){return de(this.bytes,e.bytes)}async resolve(e){let t=this.protos().find(i=>i.resolvable);if(t==null)return[this];let n=Xf.get(t.name);if(n==null)throw new yx(`no available resolver for ${t.name}`);return(await n(this,e)).map(i=>ne(i))}nodeAddress(){let e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(){return!(this.#e.length!==2||this.#e[0].code!==4&&this.#e[0].code!==41||this.#e[1].code!==6&&this.#e[1].code!==273)}[yq](){return`Multiaddr(${this.toString()})`}};function bq(r){r.getComponents().forEach(e=>{let t=Tn.getCodec(e.code);e.value!=null&&t.validate?.(e.value)})}function eT(r,e,t){let n=0;for(let o of r)if(!(n<e)){if(n>t)break;if(o!==255)return!1;n++}return!0}function tT(r,e,t,n){let o=0;for(let i of r)if(!(o<t)){if(o>n)break;if(i!==e[o])return!1;o++}return!0}function xx(r){switch(r.length){case ml:return r.join(".");case gl:{let e=[];for(let t=0;t<r.length;t++)t%2===0&&e.push(r[t].toString(16).padStart(2,"0")+r[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function rT(r){let e=0;for(let[t,n]of r.entries()){if(n===255){e+=8;continue}for(;(n&128)!=0;)e++,n=n<<1;if((n&128)!=0)return-1;for(let o=t+1;o<r.length;o++)if(r[o]!=0)return-1;break}return e}function nT(r){let e="0x";for(let t of r)e+=(t>>4).toString(16)+(t&15).toString(16);return e}var ml=4,gl=16,qme=parseInt("0xFFFF",16),vq=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function Kp(r,e){e.length===gl&&r.length===ml&&eT(e,0,11)&&(e=e.slice(12)),e.length===ml&&r.length===gl&&tT(r,vq,0,11)&&(r=r.slice(12));let t=r.length;if(t!=e.length)throw new Error("Failed to mask ip");let n=new Uint8Array(t);for(let o=0;o<t;o++)n[o]=r[o]&e[o];return n}function oT(r,e){if(typeof e=="string"&&(e=qf(e)),e==null)throw new Error("Invalid ip");if(e.length!==r.network.length)return!1;for(let t=0;t<e.length;t++)if((r.network[t]&r.mask[t])!==(e[t]&r.mask[t]))return!1;return!0}function bx(r){let[e,t]=r.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+r);let n=ml,o=P2(e);if(o==null&&(n=gl,o=R2(e),o==null))throw new Error("Failed to parse given CIDR: "+r);let i=parseInt(t,10);if(Number.isNaN(i)||String(i).length!==t.length||i<0||i>n*8)throw new Error("Failed to parse given CIDR: "+r);let s=vx(i,8*n);return{network:Kp(o,s),mask:s}}function vx(r,e){if(e!==8*ml&&e!==8*gl)throw new Error("Invalid CIDR mask");if(r<0||r>e)throw new Error("Invalid CIDR mask");let t=e/8,n=new Uint8Array(t);for(let o=0;o<t;o++){if(r>=8){n[o]=255,r-=8;continue}n[o]=255-(255>>r),r=0}return n}var yl=class{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=bx(e));else{let n=qf(e);if(n==null)throw new Error("Failed to parse network");t=String(t);let o=parseInt(t,10);if(Number.isNaN(o)||String(o).length!==t.length||o<0||o>n.length*8){let i=qf(t);if(i==null)throw new Error("Failed to parse mask");this.mask=i}else this.mask=vx(o,8*n.length);this.network=Kp(n,this.mask)}}contains(e){return oT({network:this.network,mask:this.mask},e)}toString(){let e=rT(this.mask),t=e!==-1?String(e):nT(this.mask);return xx(this.network)+"/"+t}};function iT(r,e){return new yl(r).contains(e)}function Ax(r){let e,t;if(r.getComponents().forEach(n=>{(n.name==="ip4"||n.name==="ip6")&&(t=n.value),n.name==="ipcidr"&&(e=n.value)}),e==null||t==null)throw new Error("Invalid multiaddr");return new yl(t,e)}var Xf=new Map;function Da(r){return!!r?.[wx]}function ne(r){return new O2(r)}function It(r){let e=Tn.getCodec(r);return{code:e.code,size:e.size??0,name:e.name,resolvable:!!e.resolvable,path:!!e.path}}var Aq=[It("tcp").code,It("dns").code,It("dnsaddr").code,It("dns4").code,It("dns6").code];function sT(r){return lT("sni",r)?.[1]}function aT(r){let e=lT("tcp",r)?.[1];return e==null?"":`:${e}`}function lT(r,e){let t;try{t=It(r).code}catch{return}for(let[n,o]of e)if(n===t&&o!=null)return[n,o]}function cT(r){return r.some(([e,t])=>e===It("tls").code)}function di(r,e,t){let n=uT[It(r).name];if(n==null)throw new Error(`Can't interpret protocol ${It(r).name}`);let o=n(e,t);return r===It("ip6").code?`[${o}]`:o}var uT={ip4:(r,e)=>r,ip6:(r,e)=>e.length===0?r:`[${r}]`,tcp:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`tcp://${di(t[0],t[1]??"",e)}:${r}`},udp:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`udp://${di(t[0],t[1]??"",e)}:${r}`},dnsaddr:(r,e)=>r,dns4:(r,e)=>r,dns6:(r,e)=>r,dns:(r,e)=>r,ipfs:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${di(t[0],t[1]??"",e)}`},p2p:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${di(t[0],t[1]??"",e)}`},http:(r,e)=>{let t=cT(e),n=sT(e),o=aT(e);if(t&&n!=null)return`https://${n}${o}`;let i=t?"https://":"http://",s=e.pop();if(s==null)throw new Error("Unexpected end of multiaddr");let a=di(s[0],s[1]??"",e);return a=a.replace("tcp://",""),`${i}${a}`},"http-path":(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=di(t[0],t[1]??"",e),o=decodeURIComponent(r);return`${n}/${o}`},tls:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return di(t[0],t[1]??"",e)},sni:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return di(t[0],t[1]??"",e)},https:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=di(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{let t=cT(e),n=sT(e),o=aT(e);if(t&&n!=null)return`wss://${n}${o}`;let i=t?"wss://":"ws://",s=e.pop();if(s==null)throw new Error("Unexpected end of multiaddr");let a=di(s[0],s[1]??"",e);return a=a.replace("tcp://",""),`${i}${a}`},wss:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=di(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`wss://${n}`}};function Yf(r,e){let n=ne(r).stringTuples(),o=n.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let i=It(o[0]),s=uT[i.name];if(s==null)throw new Error(`No interpreter found for ${i.name}`);let a=s(o[1]??"",n);return e?.assumeHttp!==!1&&Aq.includes(o[0])&&(a=a.replace(/^.*:\/\//,""),o[1]==="443"?a=`https://${a}`:a=`http://${a}`),(a.startsWith("http://")||a.startsWith("https://")||a.startsWith("ws://")||a.startsWith("wss://"))&&(a=new URL(a).toString(),a.endsWith("/")&&(a=a.substring(0,a.length-1))),a}var Qf=class{url;#e=0;#t=0;#r=0;#i=0;#c=new Map;log;transformRequestInit;constructor(e,{logger:t,transformRequestInit:n}){this.url=e instanceof URL?e:new URL(e),this.transformRequestInit=n,this.log=t.forComponent(`helia:trustless-gateway-block-broker:${this.url.hostname}`)}#l(e){let t=e.multihash.bytes;return or.encode(t)}async getRawBlock(e,t){let n=new URL(this.url.toString());if(n.pathname=`/ipfs/${e.toString()}`,n.search="?format=raw",t?.aborted===!0)throw new Error(`Signal to fetch raw block for CID ${e} from gateway ${this.url} was aborted prior to fetch`);let o=this.#l(e),i=new AbortController,s=()=>{i.abort()};t?.addEventListener("abort",s);try{let a=this.#c.get(o);if(a==null){this.#e++;let c={signal:i.signal,headers:{Accept:"application/vnd.ipld.raw"},cache:"force-cache"},l=this.transformRequestInit!=null?await this.transformRequestInit(c):c;a=fetch(n.toString(),l).then(async u=>{if(this.log("GET %s %d",n,u.status),!u.ok)throw this.#t++,new Error(`unable to fetch raw block for CID ${e} from gateway ${this.url}`);return this.#i++,new Uint8Array(await u.arrayBuffer())}),this.#c.set(o,a)}return await a}catch{throw t?.aborted===!0?new Error(`fetching raw block for CID ${e} from gateway ${this.url} was aborted`):(this.#t++,new Error(`unable to fetch raw block for CID ${e}`))}finally{t?.removeEventListener("abort",s),this.#c.delete(o)}}reliability(){return this.#e===0?1:this.#r>0?-1/0:this.#i/(this.#e+this.#t*3)}incrementInvalidBlocks(){this.#r++}getStats(){return{attempts:this.#e,errors:this.#t,invalidBlocks:this.#r,successes:this.#i,pendingResponses:this.#c.size}}};var dT=st(fT(),1),Eq=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],Sq=Eq.map(r=>new dT.Netmask(r));function Ex(r){for(let e of Sq)if(e.contains(r))return!0;return!1}function _q(r){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(r)}function Cq(r){let e=r.split(":");if(e.length<2)return!1;let t=e[e.length-1].padStart(4,"0"),n=e[e.length-2].padStart(4,"0"),o=`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return Ex(o)}function Iq(r){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)}function Tq(r){let e=r.split(":"),t=e[e.length-1];return Ex(t)}function kq(r){return/^::$/.test(r)||/^::1$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}function bn(r){if(co(r))return Ex(r);if(_q(r))return Cq(r);if(Iq(r))return Tq(r);if(jf(r))return kq(r)}var Pq=r=>r.toString().split("/").slice(1),Zf=r=>({match:e=>e.length<1?!1:r(e[0])?e.slice(1):!1,pattern:"fn"}),Ne=r=>({match:e=>Zf(t=>t===r).match(e),pattern:r}),wl=()=>({match:r=>Zf(e=>typeof e=="string").match(r),pattern:"{string}"}),Jf=()=>({match:r=>Zf(e=>!isNaN(parseInt(e))).match(r),pattern:"{number}"}),ct=()=>({match:r=>{if(r.length<2||r[0]!=="p2p"&&r[0]!=="ipfs")return!1;if(r[1].startsWith("Q")||r[1].startsWith("1"))try{Ve.decode(`z${r[1]}`)}catch{return!1}else return!1;return r.slice(2)},pattern:"/p2p/{peerid}"}),qp=()=>({match:r=>{if(r.length<2||r[0]!=="certhash")return!1;try{Es.decode(r[1])}catch{return!1}return r.slice(2)},pattern:"/certhash/{certhash}"}),rt=r=>({match:e=>{let t=r.match(e);return t===!1?e:t},pattern:`optional(${r.pattern})`}),on=(...r)=>({match:e=>{let t;for(let n of r){let o=n.match(e);o!==!1&&(t==null||o.length<t.length)&&(t=o)}return t??!1},pattern:`or(${r.map(e=>e.pattern).join(", ")})`}),Fe=(...r)=>({match:e=>{for(let t of r){let n=t.match(e);if(n===!1)return!1;e=n}return e},pattern:`and(${r.map(e=>e.pattern).join(", ")})`});function lt(...r){function e(o){let i=Pq(o);for(let s of r){let a=s.match(i);if(a===!1)return!1;i=a}return i}function t(o){return e(o)!==!1}function n(o){let i=e(o);return i===!1?!1:i.length===0}return{matchers:r,matches:t,exactMatch:n}}var Rq=ct(),hT=lt(Rq),B2=Fe(Ne("dns4"),wl()),M2=Fe(Ne("dns6"),wl()),U2=Fe(Ne("dnsaddr"),wl()),_x=Fe(Ne("dns"),wl()),M1e=lt(B2,rt(ct())),U1e=lt(M2,rt(ct())),F1e=lt(U2,rt(ct())),jp=lt(on(_x,U2,B2,M2),rt(ct())),pT=Fe(Ne("ip4"),Zf(co)),mT=Fe(Ne("ip6"),Zf(jf)),Cx=on(pT,mT),Fs=on(Cx,_x,B2,M2,U2),gT=lt(on(Cx,Fe(on(_x,U2,B2,M2),rt(ct())))),Ix=lt(pT),Tx=lt(mT),yT=lt(Cx),kx=Fe(Fs,Ne("tcp"),Jf()),Wp=Fe(Fs,Ne("udp"),Jf()),xl=lt(Fe(kx,rt(ct()))),H1e=lt(Wp),Px=Fe(Wp,Ne("quic"),rt(ct())),F2=Fe(Wp,Ne("quic-v1"),rt(ct())),Dq=on(Px,F2),$1e=lt(Px),wT=lt(F2),Sx=on(Fs,kx,Wp,Px,F2),xT=on(Fe(Sx,Ne("ws"),rt(ct()))),Hs=lt(xT),bT=on(Fe(Sx,Ne("wss"),rt(ct())),Fe(Sx,Ne("tls"),rt(Fe(Ne("sni"),wl())),Ne("ws"),rt(ct()))),bl=lt(bT),vT=Fe(Wp,Ne("webrtc-direct"),rt(qp()),rt(qp()),rt(ct())),Gp=lt(vT),AT=Fe(F2,Ne("webtransport"),rt(qp()),rt(qp()),rt(ct())),Rx=lt(AT),L2=on(xT,bT,Fe(kx,rt(ct())),Fe(Dq,rt(ct())),Fe(Fs,rt(ct())),vT,AT,ct()),H2=lt(L2),Nq=Fe(L2,Ne("p2p-circuit"),ct()),kn=lt(Nq),Oq=on(Fe(L2,Ne("p2p-circuit"),Ne("webrtc"),rt(ct())),Fe(L2,Ne("webrtc"),rt(ct())),Fe(Ne("webrtc"),rt(ct()))),Xp=lt(Oq),Lq=on(Fe(Fs,Ne("tcp"),Jf(),Ne("http"),rt(ct())),Fe(Fs,Ne("http"),rt(ct()))),ET=lt(Lq),Bq=on(Fe(Fs,Ne("tcp"),on(Fe(Ne("443"),Ne("http")),Fe(Jf(),Ne("https")),Fe(Jf(),Ne("tls"),Ne("http"))),rt(ct())),Fe(Fs,Ne("tls"),Ne("http"),rt(ct())),Fe(Fs,Ne("https"),rt(ct()))),ST=lt(Bq),Mq=on(Fe(Ne("memory"),wl(),rt(ct()))),V1e=lt(Mq);function Dx(r,e,t){return r.filter(n=>{if(ST.matches(n)||e&&ET.matches(n))return t||jp.matches(n)?!0:bn(n.toOptions().host)===!1;if(!e&&t){let{host:o}=n.toOptions();if(o==="127.0.0.1"||o==="localhost"||o.endsWith(".localhost"))return!0}return!1})}async function*$2(r,e,t,n,o,i={}){for await(let s of e.findProviders(r,i)){let a=Dx(s.multiaddrs,n,o);if(a.length===0)continue;let c=Yf(a[0]);yield new Qf(c,{logger:t,transformRequestInit:i.transformRequestInit})}}var Nx=class extends hl{routing;allowInsecure;allowLocal;transformRequestInit;constructor(e,t){super(e,{...t,name:"helia:trustless-gateway:session"}),this.routing=e.routing,this.allowInsecure=t.allowInsecure??V2,this.allowLocal=t.allowLocal??K2,this.transformRequestInit=t.transformRequestInit}async queryProvider(e,t,n){this.log("fetching BLOCK for %c from %s",e,t.url);let o=await t.getRawBlock(e,n.signal);return this.log.trace("got block for %c from %s",e,t.url),await n.validateFn?.(o),o}async*findNewProviders(e,t={}){yield*$2(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})}toEvictionKey(e){return e.url.toString()}equals(e,t){return e.url.toString()===t.url.toString()}async convertToProvider(e,t){if(vo(e))return;let n=Dx(Array.isArray(e)?e:[e],this.allowInsecure,this.allowLocal);if(n.length===0)return;let o=Yf(n[0]);return new Qf(o,{logger:this.logger,transformRequestInit:this.transformRequestInit})}};function _T(r,e){return new Nx(r,e)}var z2=class{allowInsecure;allowLocal;transformRequestInit;routing;log;logger;constructor(e,t={}){this.log=e.logger.forComponent("helia:trustless-gateway-block-broker"),this.logger=e.logger,this.routing=e.routing,this.allowInsecure=t.allowInsecure??V2,this.allowLocal=t.allowLocal??K2,this.transformRequestInit=t.transformRequestInit}async retrieve(e,t={}){let n=[];for await(let o of $2(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})){this.log("getting block for %c from %s",e,o.url);try{let i=await o.getRawBlock(e,t.signal);this.log.trace("got block for %c from %s",e,o.url);try{await t.validateFn?.(i)}catch(s){this.log.error("failed to validate block for %c from %s",e,o.url,s);continue}return i}catch(i){if(this.log.error("failed to get block for %c from %s",e,o.url,i),i instanceof Error?n.push(i):n.push(new Error(`Unable to fetch raw block for CID ${e} from gateway ${o.url}`)),t.signal?.aborted===!0){this.log.trace("request aborted while fetching raw block for CID %c from gateway %s",e,o.url);break}}}throw n.length>0?new AggregateError(n,`Unable to fetch raw block for CID ${e} from any gateway`):new Error(`Unable to fetch raw block for CID ${e} from any gateway`)}createSession(e={}){return _T({logger:this.logger,routing:this.routing},{...e,allowLocal:this.allowLocal,allowInsecure:this.allowInsecure,transformRequestInit:this.transformRequestInit})}};var V2=!1,K2=!1;function Yp(r={}){return e=>new z2(e,r)}async function*q2(r,e={}){let t=r.getReader();try{for(;;){let n=await t.read();if(n.done)return;yield n.value}}finally{e.preventCancel!==!0&&await t.cancel(),t.releaseLock()}}var RT=st(j2(),1);var W2=class extends Error{static name="SignatureCreationError";constructor(e="Record signature creation failed"){super(e),this.name="SignatureCreationError"}},hi=class extends Error{static name="SignatureVerificationError";constructor(e="Record signature verification failed"){super(e),this.name="SignatureVerificationError"}},G2=class extends Error{static name="RecordExpiredError";constructor(e="Record has expired"){super(e),this.name="RecordExpiredError"}},vl=class extends Error{static name="UnsupportedValidityError";constructor(e="The validity type is unsupported"){super(e),this.name="UnsupportedValidityError"}},X2=class extends Error{static name="RecordTooLargeError";constructor(e="The record is too large"){super(e),this.name="RecordTooLargeError"}},Qp=class extends Error{static name="InvalidValueError";constructor(e="Value must be a valid content path starting with /"){super(e),this.name="InvalidValueError"}},Y2=class extends Error{static name="InvalidRecordDataError";constructor(e="Invalid record data"){super(e),this.name="InvalidRecordDataError"}},Zp=class extends Error{static name="InvalidEmbeddedPublicKeyError";constructor(e="Invalid embedded public key"){super(e),this.name="InvalidEmbeddedPublicKeyError"}};var Nr;(function(r){let e;(function(o){o.EOL="EOL"})(e=r.ValidityType||(r.ValidityType={}));let t;(function(o){o[o.EOL=0]="EOL"})(t||(t={})),function(o){o.codec=()=>wt(t)}(e=r.ValidityType||(r.ValidityType={}));let n;r.codec=()=>(n==null&&(n=be((o,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),o.value!=null&&(i.uint32(10),i.bytes(o.value)),o.signatureV1!=null&&(i.uint32(18),i.bytes(o.signatureV1)),o.validityType!=null&&(i.uint32(24),r.ValidityType.codec().encode(o.validityType,i)),o.validity!=null&&(i.uint32(34),i.bytes(o.validity)),o.sequence!=null&&(i.uint32(40),i.uint64(o.sequence)),o.ttl!=null&&(i.uint32(48),i.uint64(o.ttl)),o.pubKey!=null&&(i.uint32(58),i.bytes(o.pubKey)),o.signatureV2!=null&&(i.uint32(66),i.bytes(o.signatureV2)),o.data!=null&&(i.uint32(74),i.bytes(o.data)),s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{a.value=o.bytes();break}case 2:{a.signatureV1=o.bytes();break}case 3:{a.validityType=r.ValidityType.codec().decode(o);break}case 4:{a.validity=o.bytes();break}case 5:{a.sequence=o.uint64();break}case 6:{a.ttl=o.uint64();break}case 7:{a.pubKey=o.bytes();break}case 8:{a.signatureV2=o.bytes();break}case 9:{a.data=o.bytes();break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>xe(o,r.codec()),r.decode=(o,i)=>we(o,r.codec(),i)})(Nr||(Nr={}));var Uq=Be("ipns:utils"),CT=L("/ipns/"),Fq=114,Hq=0,$q=18;function Jp(r){let e;if(r.pubKey!=null)try{e=Qt(r.pubKey)}catch(t){throw Uq.error(t),t}if(e!=null)return e}function IT(r,e,t){let n=L(e);return je([r,t,n])}function Z2(r){let e=L("ipns-signature:");return je([e,r])}function Na(r){return"signatureV1"in r?Nr.encode({value:L(r.value),signatureV1:r.signatureV1,validityType:r.validityType,validity:L(r.validity),sequence:r.sequence,ttl:r.ttl,pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data}):Nr.encode({pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data})}function Pn(r){let e=Nr.decode(r);if(e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),e.signatureV2==null||e.data==null)throw new hi("Missing data or signatureV2");let t=kT(e.data),n=Vq(t.Value),o=K(t.Validity);if(e.value!=null&&e.signatureV1!=null)return Kq(e),{value:n,validityType:Nr.ValidityType.EOL,validity:o,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV1:e.signatureV1,signatureV2:e.signatureV2,data:e.data};if(e.signatureV2!=null)return{value:n,validityType:Nr.ValidityType.EOL,validity:o,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}function $s(r){return je([CT,r.bytes])}function ed(r){let e=ze(r.slice(CT.length));if(!Q2(e,Hq)&&!Q2(e,$q))throw new ya("Multihash in IPNS key was not identity or sha2-256");return e}function TT(r,e,t,n,o){let i;if(e===Nr.ValidityType.EOL)i=0;else throw new vl("The validity type is unsupported");return Os({Value:r,Validity:t,ValidityType:i,Sequence:n,TTL:o})}function kT(r){let e=xn(r);if(e.ValidityType===0)e.ValidityType=Nr.ValidityType.EOL;else throw new vl("The validity type is unsupported");return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e}function Vq(r){let e=K(r).trim();if(e.startsWith("/"))return e;try{return`/ipfs/${q.decode(r).toV1().toString()}`}catch{}try{return`/ipfs/${q.parse(e).toV1().toString()}`}catch{}throw new Qp("Value must be a valid content path starting with /")}function PT(r){if(r!=null){let e=jq(r);if(e!=null)return e.code===Fq?`/ipns/${e.toString(dn)}`:`/ipfs/${e.toV1().toString()}`;if(zq(r))return`/ipns/${dn.encode(r.bytes)}`;let t=r.toString().trim();if(t.startsWith("/")&&t.length>1)return t}throw new Qp("Value must be a valid content path starting with /")}function Kq(r){if(r.data==null)throw new Y2("Record data is missing");let e=kT(r.data);if(!de(e.Value,r.value??new Uint8Array(0)))throw new hi('Field "value" did not match between protobuf and CBOR');if(!de(e.Validity,r.validity??new Uint8Array(0)))throw new hi('Field "validity" did not match between protobuf and CBOR');if(e.ValidityType!==r.validityType)throw new hi('Field "validityType" did not match between protobuf and CBOR');if(e.Sequence!==r.sequence)throw new hi('Field "sequence" did not match between protobuf and CBOR');if(e.TTL!==r.ttl)throw new hi('Field "ttl" did not match between protobuf and CBOR')}function zq(r){return r.bytes instanceof Uint8Array}function qq(r){return typeof r?.toCID=="function"}function jq(r){if(qq(r))return r.toCID();try{return q.parse(r)}catch{}return q.asCID(r)}function Q2(r,e){return r.code===e}var Wq=Be("ipns"),DT=5*60*1e9,Gq="/ipns/",B0e=Gq.length,NT={v1Compatible:!0,ttlNs:DT};async function OT(r,e,t,n,o=NT){let i=new RT.default(Date.now()+Number(n)),s=Nr.ValidityType.EOL,a=BigInt(o.ttlNs??DT);return Xq(r,e,t,s,i.toString(),a,o)}var Xq=async(r,e,t,n,o,i,s=NT)=>{t=BigInt(t);let a=L(o),c=PT(e),l=L(c),u=TT(l,n,a,t,i),f=Z2(u),h=await r.sign(f),d;if(r.type==="RSA"&&(d=sr(r.publicKey)),s.v1Compatible===!0){let m=await Yq(r,l,n,a),g={value:c,signatureV1:m,validity:o,validityType:n,sequence:t,ttl:i,signatureV2:h,data:u};return d!=null&&(g.pubKey=d),g}else{let m={value:c,validity:o,validityType:n,sequence:t,ttl:i,signatureV2:h,data:u};return d!=null&&(m.pubKey=d),m}},Yq=async(r,e,t,n)=>{try{let o=IT(e,t,n);return await r.sign(o)}catch(o){throw Wq.error("record signature creation failed",o),new W2("Record signature creation failed")}};var LT=st(j2(),1);var J2=Be("ipns:validator"),Qq=1024*10,Zq=async(r,e)=>{let t=Pn(e),n;try{let o=Z2(t.data);n=await r.verify(o,t.signatureV2)}catch{n=!1}if(!n)throw J2.error("record signature verification failed"),new hi("Record signature verification failed");if(t.validityType===Nr.ValidityType.EOL){if(LT.default.fromString(t.validity).toDate().getTime()<Date.now())throw J2.error("record has expired"),new G2("record has expired")}else if(t.validityType!=null)throw J2.error("the validity type is unsupported"),new vl("The validity type is unsupported");J2("ipns record for %s is valid",t.value)};async function Oa(r,e){if(e.byteLength>Qq)throw new X2("The record is too large");let t=ed(r),n;Q2(t,0)&&(n=wg(t));let o=Pn(e),i=Jp(o)??n;if(i==null)throw new Zp("Could not extract public key from IPNS record or routing key");let s=$s(i.toMultihash());if(!de(s,r))throw new Zp("Embedded public key did not match routing key");await Zq(i,e)}var ey=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MESSAGE_LENGTH"};async function*em(r,e={}){let t=/\r?\n/,n=new TextDecoder("utf8"),o="";for await(let i of r){if(typeof i=="string"&&(i=new TextEncoder().encode(i)),Eo(i)&&(i=i.subarray()),o+=n.decode(i,{stream:!0}),o.length>(e?.maxMessageLength??o.length))throw new ey("Incoming message too long");let s=o.split(t);o=s.pop()??"";for(let a=0;a<s.length;a++)yield JSON.parse(s[a])}o+=n.decode(),o!==""&&(yield JSON.parse(o))}var td=class extends Error{static name="InvalidRequestError";constructor(e="Invalid request"){super(e),this.name="InvalidRequestError"}},pi=class extends Error{static name="BadResponseError";constructor(e="Bad response"){super(e),this.name="BadResponseError"}};function Jq(r){return r[Symbol.asyncIterator]!=null}function ej(r){if(Jq(r))return(async()=>{for await(let e of r)return e})();for(let e of r)return e}var rd=ej;var BT=L("/ipns/");function MT(r){return de(r.subarray(0,BT.byteLength),BT)}var ty=class{client;constructor(e){this.client=e}async*findProviders(e,t={}){yield*Ht(this.client.getProviders(e,t),n=>({id:n.ID,multiaddrs:n.Addrs??[]}))}async provide(){}async cancelReprovide(){}async put(e,t,n){if(!MT(e))return;let o=ed(e),i=q.createV1(114,o),s=Pn(t);await this.client.putIPNS(i,s,n)}async get(e,t){if(!MT(e))throw new $e("Not found");let n=ed(e),o=q.createV1(114,n);try{let i=await this.client.getIPNS(o,t);return Na(i)}catch(i){throw i.name==="BadResponseError"?new $e("Not found"):i}}},ry=class{client;constructor(e){this.client=e}async findPeer(e,t={}){let n=await rd(this.client.getPeers(e,t));if(n!=null)return{id:n.ID,multiaddrs:n.Addrs??[]};throw new $e("Not found")}async*getClosestPeers(e,t={}){}};var Or=Be("delegated-routing-v1-http-api-client"),ny={concurrentRequests:4,timeout:3e4,cacheTTL:5*60*1e3,cacheName:"delegated-routing-v1-cache"},oy=class{started;httpQueue;shutDownController;clientUrl;timeout;contentRouting;peerRouting;filterAddrs;filterProtocols;inFlightRequests;cacheName;cache;cacheTTL;constructor(e,t={}){this.started=!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.httpQueue=new ii({concurrency:t.concurrentRequests??ny.concurrentRequests}),this.inFlightRequests=new Map,this.clientUrl=e instanceof URL?e:new URL(e),this.timeout=t.timeout??ny.timeout,this.filterAddrs=t.filterAddrs,this.filterProtocols=t.filterProtocols,this.contentRouting=new ty(this),this.peerRouting=new ry(this),this.cacheName=t.cacheName??ny.cacheName,this.cacheTTL=t.cacheTTL??ny.cacheTTL}get[Ni](){return this.contentRouting}get[Oi](){return this.peerRouting}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cacheTTL>0&&(this.cache=await globalThis.caches?.open(this.cacheName),this.cache!=null&&Or("cache enabled with ttl %d",this.cacheTTL)))}async stop(){this.httpQueue.clear(),this.shutDownController.abort(),await globalThis.caches?.delete(this.cacheName),this.started=!1}async*getProviders(e,t={}){Or("getProviders starts: %c",e);let n=AbortSignal.timeout(this.timeout),o=ke([this.shutDownController.signal,n,t.signal]);let i=ve(),s=ve();this.httpQueue.add(async()=>(i.resolve(),s.promise));try{await i.promise;let a=new URL(`${this.clientUrl}routing/v1/providers/${e.toString()}`);this.#t(a,t.filterAddrs,t.filterProtocols);let c={headers:{Accept:"application/x-ndjson"},signal:o},l=await this.#r(a.toString(),c);if(l==null)throw new pi("No response received");if(!l.ok)throw l.status===404?new $e("No matching records found"):l.status===422?new td("Request does not conform to schema or semantic constraints"):new pi(`Unexpected status code: ${l.status}`);if(l.body==null)throw new pi("Routing response had no body");let u=l.headers.get("Content-Type");if(u==null)throw new pi("No Content-Type header received");if(u?.startsWith("application/json")){let f=await l.json();for(let h of f.Providers){let d=this.#e(h);d!=null&&(yield d)}}else if(u.includes("application/x-ndjson"))for await(let f of em(q2(l.body))){let h=this.#e(f);h!=null&&(yield h)}else throw new pi(`Unsupported Content-Type: ${u}`)}finally{o.clear(),s.resolve(),Or("getProviders finished: %c",e)}}async*getPeers(e,t={}){Or("getPeers starts: %c",e);let n=AbortSignal.timeout(this.timeout),o=ke([this.shutDownController.signal,n,t.signal]);let i=ve(),s=ve();this.httpQueue.add(async()=>(i.resolve(),s.promise));try{await i.promise;let a=new URL(`${this.clientUrl}routing/v1/peers/${e.toCID().toString()}`);this.#t(a,t.filterAddrs,t.filterProtocols);let c={headers:{Accept:"application/x-ndjson"},signal:o},l=await this.#r(a.toString(),c);if(l.status===404)throw new $e("No matching records found");if(l.status===422)throw new td("Request does not conform to schema or semantic constraints");if(l.body==null)throw new pi("Routing response had no body");if(l.headers.get("Content-Type")==="application/json"){let f=await l.json();for(let h of f.Peers){let d=this.#e(h);d!=null&&(yield d)}}else for await(let f of em(q2(l.body))){let h=this.#e(f);h!=null&&(yield h)}}catch(a){Or.error("getPeers errored:",a)}finally{o.clear(),s.resolve(),Or("getPeers finished: %c",e)}}async getIPNS(e,t={}){Or("getIPNS starts: %s",e);let n=AbortSignal.timeout(this.timeout),o=ke([this.shutDownController.signal,n,t.signal]);let i=ve(),s=ve();this.httpQueue.add(async()=>(i.resolve(),s.promise));let a=`${this.clientUrl}routing/v1/ipns/${e}`;try{await i.promise;let c={headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:o},l=await this.#r(a,c);if(Or("getIPNS GET %s %d",a,l.status),l.status===404)throw new $e("No matching records found");if(l.status===422)throw new td("Request does not conform to schema or semantic constraints");if(l.body==null)throw new pi("GET ipns response had no body");let u=await l.arrayBuffer(),f=new Uint8Array(u,0,u.byteLength);return t.validate!==!1&&await Oa($s(e.multihash),f),Pn(f)}catch(c){throw Or.error("getIPNS GET %s error:",a,c),c}finally{o.clear(),s.resolve(),Or("getIPNS finished: %s",e)}}async putIPNS(e,t,n={}){Or("putIPNS starts: %c",e);let o=AbortSignal.timeout(this.timeout),i=ke([this.shutDownController.signal,o,n.signal]);let s=ve(),a=ve();this.httpQueue.add(async()=>(s.resolve(),a.promise));let c=`${this.clientUrl}routing/v1/ipns/${e}`;try{await s.promise;let l=Na(t),u={method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:l,signal:i},f=await this.#r(c,u);if(Or("putIPNS PUT %s %d",c,f.status),f.status!==200)throw new pi("PUT ipns response had status other than 200")}catch(l){throw Or.error("putIPNS PUT %s error:",c,l.stack),l}finally{i.clear(),a.resolve(),Or("putIPNS finished: %c",e)}}#e(e){try{let t=[],n=e.Addrs?.map(ne)??[];return e.Protocols!=null&&t.push(...e.Protocols),e.Protocol!=null&&(t.push(e.Protocol),delete e.Protocol),{...e,Schema:"peer",ID:tt(e.ID),Addrs:n,Protocols:t}}catch(t){Or.error("could not conform record to peer schema",t)}}#t(e,t,n){if(t!=null||this.filterAddrs!=null){let o=t?.join(",")??this.filterAddrs?.join(",")??"";o!==""&&e.searchParams.set("filter-addrs",o)}if(n!=null||this.filterProtocols!=null){let o=n?.join(",")??this.filterProtocols?.join(",")??"";o!==""&&e.searchParams.set("filter-protocols",o)}}async#r(e,t){let n=t.method??"GET",o=`${n}-${e}`;if(n==="GET"){let c=await this.cache?.match(e);if(c!=null){if(parseInt(c.headers.get("x-cache-expires")??"0",10)>Date.now())return Or("returning cached response for %s",o),c;await this.cache?.delete(e)}}let i=this.inFlightRequests.get(o);if(i!=null){let c=await i;return Or("deduplicating outgoing request for %s",o),c.clone()}let s=fetch(e,t).then(async c=>{if(this.cache!=null&&c.ok&&n==="GET"){let l=Date.now()+this.cacheTTL,u=new Headers(c.headers);u.set("x-cache-expires",l.toString());let f=new Response(c.clone().body,{status:c.status,statusText:c.statusText,headers:u});await this.cache.put(e,f)}return c}).finally(()=>{this.inFlightRequests.delete(o)});return this.inFlightRequests.set(o,s),await s}};function iy(r,e={}){return new oy(new URL(r),e)}function Lx(){return{filterProtocols:["unknown","transport-bitswap","transport-ipfs-gateway-http"],filterAddrs:["https","webtransport","webrtc","webrtc-direct","wss","tls"]}}var UT="[a-fA-F\\d:]",La=r=>r&&r.includeBoundaries?`(?:(?<=\\s|^)(?=${UT})|(?<=${UT})(?=\\s|$))`:"",mi="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",ur="[a-fA-F\\d]{1,4}",sy=`
(?:
(?:${ur}:){7}(?:${ur}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${ur}:){6}(?:${mi}|:${ur}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${ur}:){5}(?::${mi}|(?::${ur}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${ur}:){4}(?:(?::${ur}){0,1}:${mi}|(?::${ur}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${ur}:){3}(?:(?::${ur}){0,2}:${mi}|(?::${ur}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${ur}:){2}(?:(?::${ur}){0,3}:${mi}|(?::${ur}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${ur}:){1}(?:(?::${ur}){0,4}:${mi}|(?::${ur}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${ur}){0,5}:${mi}|(?::${ur}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),tj=new RegExp(`(?:^${mi}$)|(?:^${sy}$)`),rj=new RegExp(`^${mi}$`),nj=new RegExp(`^${sy}$`),Bx=r=>r&&r.exact?tj:new RegExp(`(?:${La(r)}${mi}${La(r)})|(?:${La(r)}${sy}${La(r)})`,"g");Bx.v4=r=>r&&r.exact?rj:new RegExp(`${La(r)}${mi}${La(r)}`,"g");Bx.v6=r=>r&&r.exact?nj:new RegExp(`${La(r)}${sy}${La(r)}`,"g");var Mx=Bx;function Ux(r){let e=(...t)=>r(...t);return Object.defineProperty(e,"name",{value:`functionTimeout(${r.name||"<anonymous>"})`,configurable:!0}),e}function FT(){return!1}var{toString:oj}=Object.prototype;function Fx(r){return oj.call(r)==="[object RegExp]"}var HT={global:"g",ignoreCase:"i",multiline:"m",dotAll:"s",sticky:"y",unicode:"u"};function Hx(r,e={}){if(!Fx(r))throw new TypeError("Expected a RegExp instance");let t=Object.keys(HT).map(o=>(typeof e[o]=="boolean"?e[o]:r[o])?HT[o]:"").join(""),n=new RegExp(e.source||r.source,t);return n.lastIndex=typeof e.lastIndex=="number"?e.lastIndex:r.lastIndex,n}function $x(r,e,{timeout:t}={}){try{return Ux(()=>Hx(r).test(e),{timeout:t})()}catch(n){if(FT(n))return!1;throw n}}var ij=15,sj=45,$T={timeout:400};function Vx(r){return r.length>sj?!1:$x(Mx.v6({exact:!0}),r,$T)}function VT(r){return r.length>ij?!1:$x(Mx.v4({exact:!0}),r,$T)}var KT={http:"80",https:"443",ws:"80",wss:"443"},aj=["http","https","ws","wss"];function zT(r,e){e=e??{};let t=e.defaultDnsType??"dns",{scheme:n,hostname:o,port:i,path:s}=cj(r),a=[lj(o,t),uj(i,n),fj(n)];s!=null&&a.push(dj(s));let c="/"+a.filter(l=>!!l).reduce((l,u)=>l.concat(u),[]).join("/");return ne(c)}function cj(r){let[e]=r.split(":");aj.includes(e)||(r="http"+r.substring(e.length));let{protocol:t,hostname:n,port:o,pathname:i,search:s}=new URL(r);if(o==null||o===""){let c=hj(e);c!=null&&(o=c),c==null&&t==="http:"&&(o="80")}let a;return i!=null&&i!==""&&i!=="/"&&(i.startsWith("/")&&(i=i.substring(1)),a=i),s!=null&&s!==""&&(a=a??"",a+=s),{scheme:e,hostname:n,port:o,path:a}}function lj(r,e){if(!(r==null||r==="")){if(VT(r))return["ip4",r];if(Vx(r))return["ip6",r];if(r[0]==="["){let t=r.substring(1,r.length-1);if(Vx(t))return["ip6",t]}return[e,r]}}function uj(r,e){if(!(r==null||r===""))return e==="udp"?["udp",r]:["tcp",r]}function fj(r){if(r.match(/^tcp$|^udp$/)==null)return r==="https"?["/tls/http"]:r==="wss"?["/tls/ws"]:[r]}function dj(r){if(!(r==null||r===""))return["http-path",encodeURIComponent(r)]}function hj(r){if(!(r==null||r===""||KT[r]==null))return KT[r]}var pj=["https://trustless-gateway.link","https://4everland.io"],mj=2336;function gj(r){return r=r.toString(),{id:yn(q.createV1(mj,ir.digest(L(r)))),multiaddrs:[zT(r)]}}var Kx=class{gateways;shuffle;constructor(e={}){this.gateways=(e.gateways??pj).map(t=>gj(t)),this.shuffle=e.shuffle??!0}async*findProviders(e,t){yield*(this.shuffle?this.gateways.toSorted(()=>Math.random()>.5?1:-1):this.gateways).map(n=>({...n,protocols:["transport-ipfs-gateway-http"]}))}};function tm(r={}){return new Kx(r)}var zx=class{libp2p;constructor(e){this.libp2p=e}async provide(e,t){await this.libp2p.contentRouting.provide(e,t)}async cancelReprovide(e,t){await this.libp2p.contentRouting.cancelReprovide(e,t)}async*findProviders(e,t){yield*this.libp2p.contentRouting.findProviders(e,t)}async put(e,t,n){await this.libp2p.contentRouting.put(e,t,n)}async get(e,t){return this.libp2p.contentRouting.get(e,t)}async findPeer(e,t){return this.libp2p.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t){yield*this.libp2p.peerRouting.getClosestPeers(e,t)}};function rm(r){return new zx(r)}var ay=class extends S2{libp2p;constructor(e){super({...e,components:{libp2p:e.libp2p}}),this.libp2p=e.libp2p}async start(){await super.start(),await this.libp2p.start()}async stop(){await super.stop(),await this.libp2p.stop()}};var nm=class extends Ms{data;constructor(){super(),this.data=new Map}put(e,t,n){return n?.signal?.throwIfAborted(),this.data.set(Vt.encode(e.multihash.bytes),t),e}get(e,t){t?.signal?.throwIfAborted();let n=this.data.get(Vt.encode(e.multihash.bytes));if(n==null)throw new ko;return n}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(Vt.encode(e.multihash.bytes))}async delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(Vt.encode(e.multihash.bytes))}async*getAll(e){e?.signal?.throwIfAborted();for(let[t,n]of this.data.entries())yield{cid:q.createV1(mt,ze(Vt.decode(t))),block:n},e?.signal?.throwIfAborted()}};var v2e=Be("blockstore:core:tiered");var qT="SHARDING";function wj(r){return r[Symbol.asyncIterator]!=null}function xj(r){if(wj(r))return(async()=>{let t=[];for await(let n of r)t.push(n);return t})();let e=[];for(let t of r)e.push(t);return e}var Vs=xj;function bj(r){return r[Symbol.asyncIterator]!=null}function vj(r,e){return bj(r)?async function*(){yield*(await Vs(r)).sort(e)}():function*(){yield*Vs(r).sort(e)}()}var cy=vj;var Ks=class{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(let{key:n,value:o}of e)await this.put(n,o,t),yield n}async*getMany(e,t={}){for await(let n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(let n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,o){e.push({key:n,value:o})},delete(n){t.push(n)},commit:async n=>{await Gr(this.putMany(e,n)),e=[],await Gr(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){let o=e.prefix;n=ao(n,i=>i.key.toString().startsWith(o))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((o,i)=>ao(o,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((o,i)=>cy(o,i),n)),e.offset!=null){let o=0,i=e.offset;n=ao(n,()=>o++>=i)}return e.limit!=null&&(n=xa(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){let o=e.prefix;n=ao(n,i=>i.toString().startsWith(o))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((o,i)=>ao(o,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((o,i)=>cy(o,i),n)),e.offset!=null){let o=e.offset,i=0;n=ao(n,()=>i++>=o)}return e.limit!=null&&(n=xa(n,e.limit)),n}};var Al=class extends Ks{data;constructor(){super(),this.data=new Map}put(e,t,n){return n?.signal?.throwIfAborted(),this.data.set(e.toString(),t),e}get(e,t){t?.signal?.throwIfAborted();let n=this.data.get(e.toString());if(n==null)throw new ko;return n}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(e.toString())}delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(e.toString())}*_all(e,t){t?.signal?.throwIfAborted();for(let[n,o]of this.data.entries())yield{key:new Je(n),value:o},t?.signal?.throwIfAborted()}*_allKeys(e,t){t?.signal?.throwIfAborted();for(let n of this.data.keys())yield new Je(n),t?.signal?.throwIfAborted()}};var eye=new Je(qT);var pye=Be("datastore:core:tiered");function nd(r){if(typeof r!="object"||r===null)return!1;let e=Object.getPrototypeOf(r);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)}var{hasOwnProperty:GT}=Object.prototype,{propertyIsEnumerable:Aj}=Object,od=(r,e,t)=>{Object.defineProperty(r,e,{value:t,writable:!0,enumerable:!0,configurable:!0})},Ej=void 0,WT={concatArrays:!1,ignoreUndefined:!1},ly=r=>{let e=[];for(let t in r)GT.call(r,t)&&e.push(t);if(Object.getOwnPropertySymbols){let t=Object.getOwnPropertySymbols(r);for(let n of t)Aj.call(r,n)&&e.push(n)}return e};function id(r){return Array.isArray(r)?Sj(r):nd(r)?_j(r):r}function Sj(r){let e=r.slice(0,0);return ly(r).forEach(t=>{od(e,t,id(r[t]))}),e}function _j(r){let e=Object.getPrototypeOf(r)===null?Object.create(null):{};return ly(r).forEach(t=>{od(e,t,id(r[t]))}),e}var XT=(r,e,t,n)=>(t.forEach(o=>{typeof e[o]>"u"&&n.ignoreUndefined||(o in r&&r[o]!==Object.getPrototypeOf(r)?od(r,o,qx(r[o],e[o],n)):od(r,o,id(e[o])))}),r),Cj=(r,e,t)=>{let n=r.slice(0,0),o=0;return[r,e].forEach(i=>{let s=[];for(let a=0;a<i.length;a++)GT.call(i,a)&&(s.push(String(a)),i===r?od(n,o++,i[a]):od(n,o++,id(i[a])));n=XT(n,i,ly(i).filter(a=>!s.includes(a)),t)}),n};function qx(r,e,t){return t.concatArrays&&Array.isArray(r)&&Array.isArray(e)?Cj(r,e,t):!nd(e)||!nd(r)?id(e):XT(r,e,ly(e),t)}function zt(...r){let e=qx(id(WT),this!==Ej&&this||{},WT),t={_:{}};for(let n of r)if(n!==void 0){if(!nd(n))throw new TypeError("`"+n+"` is not an Option Object");t=qx(t,{_:n},e)}return t._}var Wk=st(ok(),1);var sd={};Ut(sd,{create:()=>Fj,derivedEmptyPasswordKey:()=>uy});var uy={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function Fj(r){let e=r?.algorithm??"AES-GCM",t=r?.keyLength??16,n=r?.nonceLength??12,o=r?.digest??"SHA-256",i=r?.saltLength??16,s=r?.iterations??32767,a=ar.get();t*=8;async function c(f,h){let d=a.getRandomValues(new Uint8Array(i)),m=a.getRandomValues(new Uint8Array(n)),g={name:e,iv:m};typeof h=="string"&&(h=L(h));let w;if(h.length===0){w=await a.subtle.importKey("jwk",uy,{name:"AES-GCM"},!0,["encrypt"]);try{let v={name:"PBKDF2",salt:d,iterations:s,hash:{name:o}},A=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);w=await a.subtle.deriveKey(v,A,{name:e,length:t},!0,["encrypt"])}catch{w=await a.subtle.importKey("jwk",uy,{name:"AES-GCM"},!0,["encrypt"])}}else{let v={name:"PBKDF2",salt:d,iterations:s,hash:{name:o}},A=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);w=await a.subtle.deriveKey(v,A,{name:e,length:t},!0,["encrypt"])}let x=await a.subtle.encrypt(g,w,f);return je([d,g.iv,new Uint8Array(x)])}async function l(f,h){let d=f.subarray(0,i),m=f.subarray(i,i+n),g=f.subarray(i+n),w={name:e,iv:m};typeof h=="string"&&(h=L(h));let x;if(h.length===0)try{let A={name:"PBKDF2",salt:d,iterations:s,hash:{name:o}},S=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);x=await a.subtle.deriveKey(A,S,{name:e,length:t},!0,["decrypt"])}catch{x=await a.subtle.importKey("jwk",uy,{name:"AES-GCM"},!0,["decrypt"])}else{let A={name:"PBKDF2",salt:d,iterations:s,hash:{name:o}},S=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);x=await a.subtle.deriveKey(A,S,{name:e,length:t},!0,["decrypt"])}let v=await a.subtle.decrypt(w,x,g);return new Uint8Array(v)}return{encrypt:c,decrypt:l}}var Do={};Ut(Do,{Any:()=>Xi,BaseBlock:()=>fr,BaseStringBlock:()=>am,BitString:()=>gi,BmpString:()=>Cl,Boolean:()=>Sl,CharacterString:()=>Ll,Choice:()=>ld,Constructed:()=>gr,DATE:()=>hm,DateTime:()=>mm,Duration:()=>gm,EndOfContent:()=>cm,Enumerated:()=>_l,GeneralString:()=>Ol,GeneralizedTime:()=>Bl,GraphicString:()=>Nl,HexBlock:()=>Yi,IA5String:()=>Dl,Integer:()=>lo,Null:()=>Nn,NumericString:()=>Tl,ObjectIdentifier:()=>uo,OctetString:()=>sn,Primitive:()=>Ws,PrintableString:()=>kl,RawData:()=>Xx,RelativeObjectIdentifier:()=>dm,Repeated:()=>Ml,Sequence:()=>Tt,Set:()=>On,TIME:()=>ym,TeletexString:()=>Pl,TimeOfDay:()=>pm,UTCTime:()=>Fa,UniversalString:()=>Il,Utf8String:()=>Ro,ValueBlock:()=>Lr,VideotexString:()=>Rl,ViewWriter:()=>cd,VisibleString:()=>Ua,compareSchema:()=>Ma,fromBER:()=>fo,verifySchema:()=>sW});var Le=st(qs());function El(r,e){let t=0;if(r.length===1)return r[0];for(let n=r.length-1;n>=0;n--)t+=r[r.length-1-n]*Math.pow(2,e*n);return t}function Ba(r,e,t=-1){let n=t,o=r,i=0,s=Math.pow(2,e);for(let a=1;a<8;a++){if(r<s){let c;if(n<0)c=new ArrayBuffer(a),i=a;else{if(n<a)return new ArrayBuffer(0);c=new ArrayBuffer(n),i=n}let l=new Uint8Array(c);for(let u=a-1;u>=0;u--){let f=Math.pow(2,u*e);l[i-u-1]=Math.floor(o/f),o-=l[i-u-1]*f}return c}s*=Math.pow(2,e)}return new ArrayBuffer(0)}function hy(...r){let e=0,t=0;for(let i of r)e+=i.length;let n=new ArrayBuffer(e),o=new Uint8Array(n);for(let i of r)o.set(i,t),t+=i.length;return o}function Wx(){let r=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){let a=r[0]===255&&r[1]&128,c=r[0]===0&&(r[1]&128)===0;(a||c)&&this.warnings.push("Needlessly long format")}let e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let a=0;a<this.valueHex.byteLength;a++)t[a]=0;t[0]=r[0]&128;let n=El(t,8),o=new ArrayBuffer(this.valueHex.byteLength),i=new Uint8Array(o);for(let a=0;a<this.valueHex.byteLength;a++)i[a]=r[a];return i[0]&=127,El(i,8)-n}function ik(r){let e=r<0?r*-1:r,t=128;for(let n=1;n<8;n++){if(e<=t){if(r<0){let s=t-e,a=Ba(s,8,n),c=new Uint8Array(a);return c[0]|=128,a}let o=Ba(e,8,n),i=new Uint8Array(o);if(i[0]&128){let s=o.slice(0),a=new Uint8Array(s);o=new ArrayBuffer(o.byteLength+1),i=new Uint8Array(o);for(let c=0;c<s.byteLength;c++)i[c+1]=a[c];i[0]=0}return o}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function sk(r,e){if(r.byteLength!==e.byteLength)return!1;let t=new Uint8Array(r),n=new Uint8Array(e);for(let o=0;o<t.length;o++)if(t[o]!==n[o])return!1;return!0}function Rn(r,e){let t=r.toString(10);if(e<t.length)return"";let n=e-t.length,o=new Array(n);for(let s=0;s<n;s++)o[s]="0";return o.join("").concat(t)}var zye=Math.log(2);function py(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function Yx(r){let e=0,t=0;for(let o=0;o<r.length;o++){let i=r[o];e+=i.byteLength}let n=new Uint8Array(e);for(let o=0;o<r.length;o++){let i=r[o];n.set(new Uint8Array(i),t),t+=i.byteLength}return n.buffer}function Gs(r,e,t,n){return e instanceof Uint8Array?e.byteLength?t<0?(r.error="Wrong parameter: inputOffset less than zero",!1):n<0?(r.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-n<0?(r.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(r.error="Wrong parameter: inputBuffer has zero length",!1):(r.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}var cd=class{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return Yx(this.items)}},om=[new Uint8Array([1])],ak="0123456789",Gx="name",ck="valueHexView",Gj="isHexOnly",Xj="idBlock",Yj="tagClass",Qj="tagNumber",Zj="isConstructed",Jj="fromBER",eW="toBER",tW="local",Dn="",yi=new ArrayBuffer(0),ky=new Uint8Array(0),sm="EndOfContent",uk="OCTET STRING",fk="BIT STRING";function Yi(r){var e;return e=class extends r{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(n){this.valueHexView=new Uint8Array(n)}constructor(...n){var o;super(...n);let i=n[0]||{};this.isHexOnly=(o=i.isHexOnly)!==null&&o!==void 0?o:!1,this.valueHexView=i.valueHex?Le.BufferSourceConverter.toUint8Array(i.valueHex):ky}fromBER(n,o,i){let s=n instanceof ArrayBuffer?new Uint8Array(n):n;if(!Gs(this,s,o,i))return-1;let a=o+i;return this.valueHexView=s.subarray(o,a),this.valueHexView.length?(this.blockLength=i,a):(this.warnings.push("Zero buffer length"),o)}toBER(n=!1){return this.isHexOnly?n?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",yi)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:Le.Convert.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}var js=class{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=Dn,warnings:n=[],valueBeforeDecode:o=ky}={}){this.blockLength=e,this.error=t,this.warnings=n,this.valueBeforeDecodeView=Le.BufferSourceConverter.toUint8Array(o)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:Le.Convert.ToHex(this.valueBeforeDecodeView)}}};js.NAME="baseBlock";var Lr=class extends js{fromBER(e,t,n){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}};Lr.NAME="valueBlock";var my=class extends Yi(js){constructor({idBlock:e={}}={}){var t,n,o,i;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?Le.BufferSourceConverter.toUint8Array(e.valueHex):ky,this.tagClass=(n=e.tagClass)!==null&&n!==void 0?n:-1,this.tagNumber=(o=e.tagNumber)!==null&&o!==void 0?o:-1,this.isConstructed=(i=e.isConstructed)!==null&&i!==void 0?i:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",yi}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){let o=new Uint8Array(1);if(!e){let i=this.tagNumber;i&=31,t|=i,o[0]=t}return o.buffer}if(!this.isHexOnly){let o=Ba(this.tagNumber,7),i=new Uint8Array(o),s=o.byteLength,a=new Uint8Array(s+1);if(a[0]=t|31,!e){for(let c=0;c<s-1;c++)a[c+1]=i[c]|128;a[s]=i[s-1]}return a.buffer}let n=new Uint8Array(this.valueHexView.byteLength+1);if(n[0]=t|31,!e){let o=this.valueHexView;for(let i=0;i<o.length-1;i++)n[i+1]=o[i]|128;n[this.valueHexView.byteLength]=o[o.length-1]}return n.buffer}fromBER(e,t,n){let o=Le.BufferSourceConverter.toUint8Array(e);if(!Gs(this,o,t,n))return-1;let i=o.subarray(t,t+n);if(i.length===0)return this.error="Zero buffer length",-1;switch(i[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(i[0]&32)===32,this.isHexOnly=!1;let a=i[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let c=1,l=this.valueHexView=new Uint8Array(255),u=255;for(;i[c]&128;){if(l[c-1]=i[c]&127,c++,c>=i.length)return this.error="End of input reached before message was fully decoded",-1;if(c===u){u+=255;let h=new Uint8Array(u);for(let d=0;d<l.length;d++)h[d]=l[d];l=this.valueHexView=new Uint8Array(u)}}this.blockLength=c+1,l[c-1]=i[c]&127;let f=new Uint8Array(c);for(let h=0;h<c;h++)f[h]=l[h];l=this.valueHexView=new Uint8Array(c),l.set(f),this.blockLength<=9?this.tagNumber=El(l,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}};my.NAME="identificationBlock";var gy=class extends js{constructor({lenBlock:e={}}={}){var t,n,o;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(n=e.longFormUsed)!==null&&n!==void 0?n:!1,this.length=(o=e.length)!==null&&o!==void 0?o:0}fromBER(e,t,n){let o=Le.BufferSourceConverter.toUint8Array(e);if(!Gs(this,o,t,n))return-1;let i=o.subarray(t,t+n);if(i.length===0)return this.error="Zero buffer length",-1;if(i[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=i[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(i[0]&128),this.longFormUsed===!1)return this.length=i[0],this.blockLength=1,t+this.blockLength;let s=i[0]&127;if(s>8)return this.error="Too big integer",-1;if(s+1>i.length)return this.error="End of input reached before message was fully decoded",-1;let a=t+1,c=o.subarray(a,a+s);return c[s-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=El(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=s+1,t+this.blockLength}toBER(e=!1){let t,n;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=128),t;if(this.longFormUsed){let o=Ba(this.length,8);if(o.byteLength>127)return this.error="Too big length",yi;if(t=new ArrayBuffer(o.byteLength+1),e)return t;let i=new Uint8Array(o);n=new Uint8Array(t),n[0]=o.byteLength|128;for(let s=0;s<o.byteLength;s++)n[s+1]=i[s];return t}return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}};gy.NAME="lengthBlock";var ae={},fr=class extends js{constructor({name:e=Dn,optional:t=!1,primitiveSchema:n,...o}={},i){super(o),this.name=e,this.optional=t,n&&(this.primitiveSchema=n),this.idBlock=new my(o),this.lenBlock=new gy(o),this.valueBlock=i?new i(o):new Lr(o)}fromBER(e,t,n){let o=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return o===-1?(this.error=this.valueBlock.error,o):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),o)}toBER(e,t){let n=t||new cd;t||dk(this);let o=this.idBlock.toBER(e);if(n.write(o),this.lenBlock.isIndefiniteForm)n.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,n),n.write(new ArrayBuffer(2));else{let i=this.valueBlock.toBER(e);this.lenBlock.length=i.byteLength;let s=this.lenBlock.toBER(e);n.write(s),n.write(i)}return t?yi:n.final()}toJSON(){let e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():Le.Convert.ToHex(this.toBER())}onAsciiEncoding(){let e=this.constructor.NAME,t=Le.Convert.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;let t=this.toBER(),n=e.toBER();return sk(t,n)}};fr.NAME="BaseBlock";function dk(r){var e;if(r instanceof ae.Constructed)for(let t of r.valueBlock.value)dk(t)&&(r.lenBlock.isIndefiniteForm=!0);return!!(!((e=r.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}var am=class extends fr{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=Dn,...t}={},n){super(t,n),e&&this.fromString(e)}fromBER(e,t,n){let o=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return o===-1?(this.error=this.valueBlock.error,o):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),o)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}};am.NAME="BaseStringBlock";var yy=class extends Yi(Lr){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}};yy.NAME="PrimitiveValueBlock";var hk,Ws=class extends fr{constructor(e={}){super(e,yy),this.idBlock.isConstructed=!1}};hk=Ws;ae.Primitive=hk;Ws.NAME="PRIMITIVE";function rW(r,e){if(r instanceof e)return r;let t=new e;return t.idBlock=r.idBlock,t.lenBlock=r.lenBlock,t.warnings=r.warnings,t.valueBeforeDecodeView=r.valueBeforeDecodeView,t}function ud(r,e=0,t=r.length){let n=e,o=new fr({},Lr),i=new js;if(!Gs(i,r,e,t))return o.error=i.error,{offset:-1,result:o};if(!r.subarray(e,e+t).length)return o.error="Zero buffer length",{offset:-1,result:o};let a=o.idBlock.fromBER(r,e,t);if(o.idBlock.warnings.length&&o.warnings.concat(o.idBlock.warnings),a===-1)return o.error=o.idBlock.error,{offset:-1,result:o};if(e=a,t-=o.idBlock.blockLength,a=o.lenBlock.fromBER(r,e,t),o.lenBlock.warnings.length&&o.warnings.concat(o.lenBlock.warnings),a===-1)return o.error=o.lenBlock.error,{offset:-1,result:o};if(e=a,t-=o.lenBlock.blockLength,!o.idBlock.isConstructed&&o.lenBlock.isIndefiniteForm)return o.error="Indefinite length form used for primitive encoding form",{offset:-1,result:o};let c=fr;switch(o.idBlock.tagClass){case 1:if(o.idBlock.tagNumber>=37&&o.idBlock.isHexOnly===!1)return o.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:o};switch(o.idBlock.tagNumber){case 0:if(o.idBlock.isConstructed&&o.lenBlock.length>0)return o.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:o};c=ae.EndOfContent;break;case 1:c=ae.Boolean;break;case 2:c=ae.Integer;break;case 3:c=ae.BitString;break;case 4:c=ae.OctetString;break;case 5:c=ae.Null;break;case 6:c=ae.ObjectIdentifier;break;case 10:c=ae.Enumerated;break;case 12:c=ae.Utf8String;break;case 13:c=ae.RelativeObjectIdentifier;break;case 14:c=ae.TIME;break;case 15:return o.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:o};case 16:c=ae.Sequence;break;case 17:c=ae.Set;break;case 18:c=ae.NumericString;break;case 19:c=ae.PrintableString;break;case 20:c=ae.TeletexString;break;case 21:c=ae.VideotexString;break;case 22:c=ae.IA5String;break;case 23:c=ae.UTCTime;break;case 24:c=ae.GeneralizedTime;break;case 25:c=ae.GraphicString;break;case 26:c=ae.VisibleString;break;case 27:c=ae.GeneralString;break;case 28:c=ae.UniversalString;break;case 29:c=ae.CharacterString;break;case 30:c=ae.BmpString;break;case 31:c=ae.DATE;break;case 32:c=ae.TimeOfDay;break;case 33:c=ae.DateTime;break;case 34:c=ae.Duration;break;default:{let l=o.idBlock.isConstructed?new ae.Constructed:new ae.Primitive;l.idBlock=o.idBlock,l.lenBlock=o.lenBlock,l.warnings=o.warnings,o=l}}break;case 2:case 3:case 4:default:c=o.idBlock.isConstructed?ae.Constructed:ae.Primitive}return o=rW(o,c),a=o.fromBER(r,e,o.lenBlock.isIndefiniteForm?t:o.lenBlock.length),o.valueBeforeDecodeView=r.subarray(n,n+o.blockLength),{offset:a,result:o}}function fo(r){if(!r.byteLength){let e=new fr({},Lr);return e.error="Input buffer has zero length",{offset:-1,result:e}}return ud(Le.BufferSourceConverter.toUint8Array(r).slice(),0,r.byteLength)}function nW(r,e){return r?1:e}var Gi=class extends Lr{constructor({value:e=[],isIndefiniteForm:t=!1,...n}={}){super(n),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,n){let o=Le.BufferSourceConverter.toUint8Array(e);if(!Gs(this,o,t,n))return-1;if(this.valueBeforeDecodeView=o.subarray(t,t+n),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let i=t;for(;nW(this.isIndefiniteForm,n)>0;){let s=ud(o,i,n);if(s.offset===-1)return this.error=s.result.error,this.warnings.concat(s.result.warnings),-1;if(i=s.offset,this.blockLength+=s.result.blockLength,n-=s.result.blockLength,this.value.push(s.result),this.isIndefiniteForm&&s.result.constructor.NAME===sm)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===sm?this.value.pop():this.warnings.push("No EndOfContent block encoded")),i}toBER(e,t){let n=t||new cd;for(let o=0;o<this.value.length;o++)this.value[o].toBER(e,n);return t?yi:n.final()}toJSON(){let e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(let t of this.value)e.value.push(t.toJSON());return e}};Gi.NAME="ConstructedValueBlock";var pk,gr=class extends fr{constructor(e={}){super(e,Gi),this.idBlock.isConstructed=!0}fromBER(e,t,n){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;let o=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return o===-1?(this.error=this.valueBlock.error,o):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),o)}onAsciiEncoding(){let e=[];for(let n of this.valueBlock.value)e.push(n.toString("ascii").split(`
`).map(o=>`  ${o}`).join(`
`));let t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}};pk=gr;ae.Constructed=pk;gr.NAME="CONSTRUCTED";var wy=class extends Lr{fromBER(e,t,n){return t}toBER(e){return yi}};wy.override="EndOfContentValueBlock";var mk,cm=class extends fr{constructor(e={}){super(e,wy),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}};mk=cm;ae.EndOfContent=mk;cm.NAME=sm;var gk,Nn=class extends fr{constructor(e={}){super(e,Lr),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,n){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=n,t+n>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+n}toBER(e,t){let n=new ArrayBuffer(2);if(!e){let o=new Uint8Array(n);o[0]=5,o[1]=0}return t&&t.write(n),n}onAsciiEncoding(){return`${this.constructor.NAME}`}};gk=Nn;ae.Null=gk;Nn.NAME="NULL";var xy=class extends Yi(Lr){get value(){for(let e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=Le.BufferSourceConverter.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,n){let o=Le.BufferSourceConverter.toUint8Array(e);return Gs(this,o,t,n)?(this.valueHexView=o.subarray(t,t+n),n>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,Wx.call(this),this.blockLength=n,t+n):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}};xy.NAME="BooleanValueBlock";var yk,Sl=class extends fr{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,xy),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};yk=Sl;ae.Boolean=yk;Sl.NAME="BOOLEAN";var by=class extends Yi(Gi){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,n){let o=0;if(this.isConstructed){if(this.isHexOnly=!1,o=Gi.prototype.fromBER.call(this,e,t,n),o===-1)return o;for(let i=0;i<this.value.length;i++){let s=this.value[i].constructor.NAME;if(s===sm){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(s!==uk)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,o=super.fromBER(e,t,n),this.blockLength=n;return o}toBER(e,t){return this.isConstructed?Gi.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}};by.NAME="OctetStringValueBlock";var Qx,sn=class extends fr{constructor({idBlock:e={},lenBlock:t={},...n}={}){var o,i;(o=n.isConstructed)!==null&&o!==void 0||(n.isConstructed=!!(!((i=n.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},by),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,n){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,n===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){let i=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+n);try{if(i.byteLength){let s=ud(i,0,i.byteLength);s.offset!==-1&&s.offset===n&&(this.valueBlock.value=[s.result])}}catch{}}return super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return gr.prototype.onAsciiEncoding.call(this);let e=this.constructor.NAME,t=Le.Convert.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;let e=[];for(let t of this.valueBlock.value)t instanceof Qx&&e.push(t.valueBlock.valueHexView);return Le.BufferSourceConverter.concat(e)}};Qx=sn;ae.OctetString=Qx;sn.NAME=uk;var vy=class extends Yi(Gi){constructor({unusedBits:e=0,isConstructed:t=!1,...n}={}){super(n),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,n){if(!n)return t;let o=-1;if(this.isConstructed){if(o=Gi.prototype.fromBER.call(this,e,t,n),o===-1)return o;for(let a of this.value){let c=a.constructor.NAME;if(c===sm){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==fk)return this.error="BIT STRING may consists of BIT STRINGs only",-1;let l=a.valueBlock;if(this.unusedBits>0&&l.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=l.unusedBits}return o}let i=Le.BufferSourceConverter.toUint8Array(e);if(!Gs(this,i,t,n))return-1;let s=i.subarray(t,t+n);if(this.unusedBits=s[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){let a=s.subarray(1);try{if(a.byteLength){let c=ud(a,0,a.byteLength);c.offset!==-1&&c.offset===n-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=s.subarray(1),this.blockLength=s.length,t+n}toBER(e,t){if(this.isConstructed)return Gi.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return yi;let n=new Uint8Array(this.valueHexView.length+1);return n[0]=this.unusedBits,n.set(this.valueHexView,1),n.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}};vy.NAME="BitStringValueBlock";var wk,gi=class extends fr{constructor({idBlock:e={},lenBlock:t={},...n}={}){var o,i;(o=n.isConstructed)!==null&&o!==void 0||(n.isConstructed=!!(!((i=n.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},vy),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,n){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return gr.prototype.onAsciiEncoding.call(this);{let e=[],t=this.valueBlock.valueHexView;for(let s of t)e.push(s.toString(2).padStart(8,"0"));let n=e.join(""),o=this.constructor.NAME,i=n.substring(0,n.length-this.valueBlock.unusedBits);return`${o} : ${i}`}}};wk=gi;ae.BitString=wk;gi.NAME=fk;var xk;function oW(r,e){let t=new Uint8Array([0]),n=new Uint8Array(r),o=new Uint8Array(e),i=n.slice(0),s=i.length-1,a=o.slice(0),c=a.length-1,l=0,u=c<s?s:c,f=0;for(let h=u;h>=0;h--,f++){switch(!0){case f<a.length:l=i[s-f]+a[c-f]+t[0];break;default:l=i[s-f]+t[0]}switch(t[0]=l/10,!0){case f>=i.length:i=hy(new Uint8Array([l%10]),i);break;default:i[s-f]=l%10}}return t[0]>0&&(i=hy(t,i)),i}function lk(r){if(r>=om.length)for(let e=om.length;e<=r;e++){let t=new Uint8Array([0]),n=om[e-1].slice(0);for(let o=n.length-1;o>=0;o--){let i=new Uint8Array([(n[o]<<1)+t[0]]);t[0]=i[0]/10,n[o]=i[0]%10}t[0]>0&&(n=hy(t,n)),om.push(n)}return om[r]}function iW(r,e){let t=0,n=new Uint8Array(r),o=new Uint8Array(e),i=n.slice(0),s=i.length-1,a=o.slice(0),c=a.length-1,l,u=0;for(let f=c;f>=0;f--,u++)switch(l=i[s-u]-a[c-u]-t,!0){case l<0:t=1,i[s-u]=l+10;break;default:t=0,i[s-u]=l}if(t>0)for(let f=s-c+1;f>=0;f--,u++)if(l=i[s-u]-t,l<0)t=1,i[s-u]=l+10;else{t=0,i[s-u]=l;break}return i.slice()}var lm=class extends Yi(Lr){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=Wx.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(ik(e))}get valueDec(){return this._valueDec}fromDER(e,t,n,o=0){let i=this.fromBER(e,t,n);if(i===-1)return i;let s=this.valueHexView;return s[0]===0&&(s[1]&128)!==0?this.valueHexView=s.subarray(1):o!==0&&s.length<o&&(o-s.length>1&&(o=s.length+1),this.valueHexView=s.subarray(o-s.length)),i}toDER(e=!1){let t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{let n=new Uint8Array(this.valueHexView.length+1);n[0]=0,n.set(t,1),this.valueHexView=n}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,n){let o=super.fromBER(e,t,n);return o===-1||this.setValueHex(),o}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){let e=this.valueHexView.length*8-1,t=new Uint8Array(this.valueHexView.length*8/3),n=0,o,i=this.valueHexView,s="",a=!1;for(let c=i.byteLength-1;c>=0;c--){o=i[c];for(let l=0;l<8;l++){if((o&1)===1)switch(n){case e:t=iW(lk(n),t),s="-";break;default:t=oW(t,lk(n))}n++,o>>=1}}for(let c=0;c<t.length;c++)t[c]&&(a=!0),a&&(s+=ak.charAt(t[c]));return a===!1&&(s+=ak.charAt(0)),s}};xk=lm;lm.NAME="IntegerValueBlock";Object.defineProperty(xk.prototype,"valueHex",{set:function(r){this.valueHexView=new Uint8Array(r),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var im,lo=class extends fr{constructor(e={}){super(e,lm),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return py(),BigInt(this.valueBlock.toString())}static fromBigInt(e){py();let t=BigInt(e),n=new cd,o=t.toString(16).replace(/^-/,""),i=new Uint8Array(Le.Convert.FromHex(o));if(t<0){let a=new Uint8Array(i.length+(i[0]&128?1:0));a[0]|=128;let l=BigInt(`0x${Le.Convert.ToHex(a)}`)+t,u=Le.BufferSourceConverter.toUint8Array(Le.Convert.FromHex(l.toString(16)));u[0]|=128,n.write(u)}else i[0]&128&&n.write(new Uint8Array([0])),n.write(i);return new im({valueHex:n.final()})}convertToDER(){let e=new im({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new im({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}};im=lo;ae.Integer=im;lo.NAME="INTEGER";var bk,_l=class extends lo{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}};bk=_l;ae.Enumerated=bk;_l.NAME="ENUMERATED";var um=class extends Yi(Lr){constructor({valueDec:e=-1,isFirstSid:t=!1,...n}={}){super(n),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,n){if(!n)return t;let o=Le.BufferSourceConverter.toUint8Array(e);if(!Gs(this,o,t,n))return-1;let i=o.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=i[a]&127,this.blockLength++,(i[a]&128)!==0);a++);let s=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)s[a]=this.valueHexView[a];return this.valueHexView=s,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=El(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){py();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;let n=new Uint8Array(t.length/7);for(let o=0;o<n.length;o++)n[o]=parseInt(t.slice(o*7,o*7+7),2)+(o+1<n.length?128:0);this.fromBER(n.buffer,0,n.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);let o=this.valueHexView,i=new Uint8Array(this.blockLength);for(let s=0;s<this.blockLength-1;s++)i[s]=o[s]|128;return i[this.blockLength-1]=o[this.blockLength-1],i.buffer}let t=Ba(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",yi;let n=new Uint8Array(t.byteLength);if(!e){let o=new Uint8Array(t),i=t.byteLength-1;for(let s=0;s<i;s++)n[s]=o[s]|128;n[i]=o[i]}return n}toString(){let e="";if(this.isHexOnly)e=Le.Convert.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}};um.NAME="sidBlock";var Ay=class extends Lr{constructor({value:e=Dn,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let o=t;for(;n>0;){let i=new um;if(o=i.fromBER(e,o,n),o===-1)return this.blockLength=0,this.error=i.error,o;this.value.length===0&&(i.isFirstSid=!0),this.blockLength+=i.blockLength,n-=i.blockLength,this.value.push(i)}return o}toBER(e){let t=[];for(let n=0;n<this.value.length;n++){let o=this.value[n].toBER(e);if(o.byteLength===0)return this.error=this.value[n].error,yi;t.push(o)}return Yx(t)}fromString(e){this.value=[];let t=0,n=0,o="",i=!1;do if(n=e.indexOf(".",t),n===-1?o=e.substring(t):o=e.substring(t,n),t=n+1,i){let s=this.value[0],a=0;switch(s.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}let c=parseInt(o,10);if(isNaN(c))return;s.valueDec=c+a,i=!1}else{let s=new um;if(o>Number.MAX_SAFE_INTEGER){py();let a=BigInt(o);s.valueBigInt=a}else if(s.valueDec=parseInt(o,10),isNaN(s.valueDec))return;this.value.length||(s.isFirstSid=!0,i=!0),this.value.push(s)}while(n!==-1)}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let o=this.value[n].toString();n!==0&&(e=`${e}.`),t?(o=`{${o}}`,this.value[n].isFirstSid?e=`2.{${o} - 80}`:e+=o):e+=o}return e}toJSON(){let e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}};Ay.NAME="ObjectIdentifierValueBlock";var vk,uo=class extends fr{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,Ay),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}};vk=uo;ae.ObjectIdentifier=vk;uo.NAME="OBJECT IDENTIFIER";var fm=class extends Yi(js){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,n){if(n===0)return t;let o=Le.BufferSourceConverter.toUint8Array(e);if(!Gs(this,o,t,n))return-1;let i=o.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=i[a]&127,this.blockLength++,(i[a]&128)!==0);a++);let s=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)s[a]=this.valueHexView[a];return this.valueHexView=s,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=El(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);let o=this.valueHexView,i=new Uint8Array(this.blockLength);for(let s=0;s<this.blockLength-1;s++)i[s]=o[s]|128;return i[this.blockLength-1]=o[this.blockLength-1],i.buffer}let t=Ba(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",yi;let n=new Uint8Array(t.byteLength);if(!e){let o=new Uint8Array(t),i=t.byteLength-1;for(let s=0;s<i;s++)n[s]=o[s]|128;n[i]=o[i]}return n.buffer}toString(){let e="";return this.isHexOnly?e=Le.Convert.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}};fm.NAME="relativeSidBlock";var Ey=class extends Lr{constructor({value:e=Dn,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let o=t;for(;n>0;){let i=new fm;if(o=i.fromBER(e,o,n),o===-1)return this.blockLength=0,this.error=i.error,o;this.blockLength+=i.blockLength,n-=i.blockLength,this.value.push(i)}return o}toBER(e,t){let n=[];for(let o=0;o<this.value.length;o++){let i=this.value[o].toBER(e);if(i.byteLength===0)return this.error=this.value[o].error,yi;n.push(i)}return Yx(n)}fromString(e){this.value=[];let t=0,n=0,o="";do{n=e.indexOf(".",t),n===-1?o=e.substring(t):o=e.substring(t,n),t=n+1;let i=new fm;if(i.valueDec=parseInt(o,10),isNaN(i.valueDec))return!0;this.value.push(i)}while(n!==-1);return!0}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let o=this.value[n].toString();n!==0&&(e=`${e}.`),t&&(o=`{${o}}`),e+=o}return e}toJSON(){let e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}};Ey.NAME="RelativeObjectIdentifierValueBlock";var Ak,dm=class extends fr{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,Ey),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}};Ak=dm;ae.RelativeObjectIdentifier=Ak;dm.NAME="RelativeObjectIdentifier";var Ek,Tt=class extends gr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}};Ek=Tt;ae.Sequence=Ek;Tt.NAME="SEQUENCE";var Sk,On=class extends gr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};Sk=On;ae.Set=Sk;On.NAME="SET";var Sy=class extends Yi(Lr){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=Dn}toJSON(){return{...super.toJSON(),value:this.value}}};Sy.NAME="StringValueBlock";var _y=class extends Sy{};_y.NAME="SimpleStringValueBlock";var vn=class extends am{constructor({...e}={}){super(e,_y)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,Le.BufferSourceConverter.toUint8Array(e))}fromString(e){let t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t);for(let o=0;o<t;o++)n[o]=e.charCodeAt(o);this.valueBlock.value=e}};vn.NAME="SIMPLE STRING";var Cy=class extends vn{fromBuffer(e){this.valueBlock.valueHexView=Le.BufferSourceConverter.toUint8Array(e);try{this.valueBlock.value=Le.Convert.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=Le.Convert.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(Le.Convert.FromUtf8String(e)),this.valueBlock.value=e}};Cy.NAME="Utf8StringValueBlock";var _k,Ro=class extends Cy{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}};_k=Ro;ae.Utf8String=_k;Ro.NAME="UTF8String";var Iy=class extends vn{fromBuffer(e){this.valueBlock.value=Le.Convert.ToUtf16String(e),this.valueBlock.valueHexView=Le.BufferSourceConverter.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(Le.Convert.FromUtf16String(e))}};Iy.NAME="BmpStringValueBlock";var Ck,Cl=class extends Iy{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}};Ck=Cl;ae.BmpString=Ck;Cl.NAME="BMPString";var Ty=class extends vn{fromBuffer(e){let t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),n=new Uint8Array(t);for(let o=0;o<n.length;o+=4)n[o]=n[o+3],n[o+1]=n[o+2],n[o+2]=0,n[o+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){let t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let o=0;o<t;o++){let i=Ba(e.charCodeAt(o),8),s=new Uint8Array(i);if(s.length>4)continue;let a=4-s.length;for(let c=s.length-1;c>=0;c--)n[o*4+c+a]=s[c]}this.valueBlock.value=e}};Ty.NAME="UniversalStringValueBlock";var Ik,Il=class extends Ty{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}};Ik=Il;ae.UniversalString=Ik;Il.NAME="UniversalString";var Tk,Tl=class extends vn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}};Tk=Tl;ae.NumericString=Tk;Tl.NAME="NumericString";var kk,kl=class extends vn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}};kk=kl;ae.PrintableString=kk;kl.NAME="PrintableString";var Pk,Pl=class extends vn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}};Pk=Pl;ae.TeletexString=Pk;Pl.NAME="TeletexString";var Rk,Rl=class extends vn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}};Rk=Rl;ae.VideotexString=Rk;Rl.NAME="VideotexString";var Dk,Dl=class extends vn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}};Dk=Dl;ae.IA5String=Dk;Dl.NAME="IA5String";var Nk,Nl=class extends vn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}};Nk=Nl;ae.GraphicString=Nk;Nl.NAME="GraphicString";var Ok,Ua=class extends vn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}};Ok=Ua;ae.VisibleString=Ok;Ua.NAME="VisibleString";var Lk,Ol=class extends vn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}};Lk=Ol;ae.GeneralString=Lk;Ol.NAME="GeneralString";var Bk,Ll=class extends vn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}};Bk=Ll;ae.CharacterString=Bk;Ll.NAME="CharacterString";var Mk,Fa=class extends Ua{constructor({value:e,valueDate:t,...n}={}){if(super(n),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let o=0;o<e.length;o++)this.valueBlock.valueHexView[o]=e.charCodeAt(o)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,Le.BufferSourceConverter.toUint8Array(e)))}toBuffer(){let e=this.toString(),t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let o=0;o<e.length;o++)n[o]=e.charCodeAt(o);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){let n=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(n===null){this.error="Wrong input string for conversion";return}let o=parseInt(n[1],10);o>=50?this.year=1900+o:this.year=2e3+o,this.month=parseInt(n[2],10),this.day=parseInt(n[3],10),this.hour=parseInt(n[4],10),this.minute=parseInt(n[5],10),this.second=parseInt(n[6],10)}toString(e="iso"){if(e==="iso"){let t=new Array(7);return t[0]=Rn(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=Rn(this.month,2),t[2]=Rn(this.day,2),t[3]=Rn(this.hour,2),t[4]=Rn(this.minute,2),t[5]=Rn(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}};Mk=Fa;ae.UTCTime=Mk;Fa.NAME="UTCTime";var Uk,Bl=class extends Fa{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){let e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,n="",o="",i=0,s,a=0,c=0;if(e[e.length-1]==="Z")n=e.substring(0,e.length-1),t=!0;else{let f=new Number(e[e.length-1]);if(isNaN(f.valueOf()))throw new Error("Wrong input string for conversion");n=e}if(t){if(n.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(n.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let f=1,h=n.indexOf("+"),d="";if(h===-1&&(h=n.indexOf("-"),f=-1),h!==-1){if(d=n.substring(h+1),n=n.substring(0,h),d.length!==2&&d.length!==4)throw new Error("Wrong input string for conversion");let m=parseInt(d.substring(0,2),10);if(isNaN(m.valueOf()))throw new Error("Wrong input string for conversion");if(a=f*m,d.length===4){if(m=parseInt(d.substring(2,4),10),isNaN(m.valueOf()))throw new Error("Wrong input string for conversion");c=f*m}}}let l=n.indexOf(".");if(l===-1&&(l=n.indexOf(",")),l!==-1){let f=new Number(`0${n.substring(l)}`);if(isNaN(f.valueOf()))throw new Error("Wrong input string for conversion");i=f.valueOf(),o=n.substring(0,l)}else o=n;switch(!0){case o.length===8:if(s=/(\d{4})(\d{2})(\d{2})/ig,l!==-1)throw new Error("Wrong input string for conversion");break;case o.length===10:if(s=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let f=60*i;this.minute=Math.floor(f),f=60*(f-this.minute),this.second=Math.floor(f),f=1e3*(f-this.second),this.millisecond=Math.floor(f)}break;case o.length===12:if(s=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let f=60*i;this.second=Math.floor(f),f=1e3*(f-this.second),this.millisecond=Math.floor(f)}break;case o.length===14:if(s=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let f=1e3*i;this.millisecond=Math.floor(f)}break;default:throw new Error("Wrong input string for conversion")}let u=s.exec(o);if(u===null)throw new Error("Wrong input string for conversion");for(let f=1;f<u.length;f++)switch(f){case 1:this.year=parseInt(u[f],10);break;case 2:this.month=parseInt(u[f],10);break;case 3:this.day=parseInt(u[f],10);break;case 4:this.hour=parseInt(u[f],10)+a;break;case 5:this.minute=parseInt(u[f],10)+c;break;case 6:this.second=parseInt(u[f],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){let f=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=f.getUTCFullYear(),this.month=f.getUTCMonth(),this.day=f.getUTCDay(),this.hour=f.getUTCHours(),this.minute=f.getUTCMinutes(),this.second=f.getUTCSeconds(),this.millisecond=f.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){let t=[];return t.push(Rn(this.year,4)),t.push(Rn(this.month,2)),t.push(Rn(this.day,2)),t.push(Rn(this.hour,2)),t.push(Rn(this.minute,2)),t.push(Rn(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(Rn(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}};Uk=Bl;ae.GeneralizedTime=Uk;Bl.NAME="GeneralizedTime";var Fk,hm=class extends Ro{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}};Fk=hm;ae.DATE=Fk;hm.NAME="DATE";var Hk,pm=class extends Ro{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}};Hk=pm;ae.TimeOfDay=Hk;pm.NAME="TimeOfDay";var $k,mm=class extends Ro{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}};$k=mm;ae.DateTime=$k;mm.NAME="DateTime";var Vk,gm=class extends Ro{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}};Vk=gm;ae.Duration=Vk;gm.NAME="Duration";var Kk,ym=class extends Ro{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}};Kk=ym;ae.TIME=Kk;ym.NAME="TIME";var Xi=class{constructor({name:e=Dn,optional:t=!1}={}){this.name=e,this.optional=t}},ld=class extends Xi{constructor({value:e=[],...t}={}){super(t),this.value=e}},Ml=class extends Xi{constructor({value:e=new Xi,local:t=!1,...n}={}){super(n),this.value=e,this.local=t}},Xx=class{get data(){return this.dataView.slice().buffer}set data(e){this.dataView=Le.BufferSourceConverter.toUint8Array(e)}constructor({data:e=ky}={}){this.dataView=Le.BufferSourceConverter.toUint8Array(e)}fromBER(e,t,n){let o=t+n;return this.dataView=Le.BufferSourceConverter.toUint8Array(e).subarray(t,o),o}toBER(e){return this.dataView.slice().buffer}};function Ma(r,e,t){if(t instanceof ld){for(let i of t.value)if(Ma(r,e,i).verified)return{verified:!0,result:r};{let i={verified:!1,result:{error:"Wrong values for Choice type"}};return t.hasOwnProperty(Gx)&&(i.name=t.name),i}}if(t instanceof Xi)return t.hasOwnProperty(Gx)&&(r[t.name]=e),{verified:!0,result:r};if(!(r instanceof Object))return{verified:!1,result:{error:"Wrong root object"}};if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 data"}};if(!(t instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(Xj in t))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(Jj in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(eW in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};let n=t.idBlock.toBER(!1);if(n.byteLength===0)return{verified:!1,result:{error:"Error encoding idBlock for ASN.1 schema"}};if(t.idBlock.fromBER(n,0,n.byteLength)===-1)return{verified:!1,result:{error:"Error decoding idBlock for ASN.1 schema"}};if(t.idBlock.hasOwnProperty(Yj)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagClass!==e.idBlock.tagClass)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(Qj)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagNumber!==e.idBlock.tagNumber)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(Zj)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isConstructed!==e.idBlock.isConstructed)return{verified:!1,result:r};if(!(Gj in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isHexOnly!==e.idBlock.isHexOnly)return{verified:!1,result:r};if(t.idBlock.isHexOnly){if(!(ck in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};let i=t.idBlock.valueHexView,s=e.idBlock.valueHexView;if(i.length!==s.length)return{verified:!1,result:r};for(let a=0;a<i.length;a++)if(i[a]!==s[1])return{verified:!1,result:r}}if(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Dn),t.name&&(r[t.name]=e)),t instanceof ae.Constructed){let i=0,s={verified:!1,result:{error:"Unknown error"}},a=t.valueBlock.value.length;if(a>0&&t.valueBlock.value[0]instanceof Ml&&(a=e.valueBlock.value.length),a===0)return{verified:!0,result:r};if(e.valueBlock.value.length===0&&t.valueBlock.value.length!==0){let c=!0;for(let l=0;l<t.valueBlock.value.length;l++)c=c&&(t.valueBlock.value[l].optional||!1);return c?{verified:!0,result:r}:(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Dn),t.name&&delete r[t.name]),r.error="Inconsistent object length",{verified:!1,result:r})}for(let c=0;c<a;c++)if(c-i>=e.valueBlock.value.length){if(t.valueBlock.value[c].optional===!1){let l={verified:!1,result:r};return r.error="Inconsistent length between ASN.1 data and schema",t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Dn),t.name&&(delete r[t.name],l.name=t.name)),l}}else if(t.valueBlock.value[0]instanceof Ml){if(s=Ma(r,e.valueBlock.value[c],t.valueBlock.value[0].value),s.verified===!1)if(t.valueBlock.value[0].optional)i++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Dn),t.name&&delete r[t.name]),s;if(Gx in t.valueBlock.value[0]&&t.valueBlock.value[0].name.length>0){let l={};tW in t.valueBlock.value[0]&&t.valueBlock.value[0].local?l=e:l=r,typeof l[t.valueBlock.value[0].name]>"u"&&(l[t.valueBlock.value[0].name]=[]),l[t.valueBlock.value[0].name].push(e.valueBlock.value[c])}}else if(s=Ma(r,e.valueBlock.value[c-i],t.valueBlock.value[c]),s.verified===!1)if(t.valueBlock.value[c].optional)i++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Dn),t.name&&delete r[t.name]),s;if(s.verified===!1){let c={verified:!1,result:r};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Dn),t.name&&(delete r[t.name],c.name=t.name)),c}return{verified:!0,result:r}}if(t.primitiveSchema&&ck in e.valueBlock){let i=ud(e.valueBlock.valueHexView);if(i.offset===-1){let s={verified:!1,result:i.result};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,Dn),t.name&&(delete r[t.name],s.name=t.name)),s}return Ma(r,i.result,t.primitiveSchema)}return{verified:!0,result:r}}function sW(r,e){if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema type"}};let t=ud(Le.BufferSourceConverter.toUint8Array(r));return t.offset===-1?{verified:!1,result:t.result}:Ma(t.result,t.result,e)}async function Py(r,e){let n=await sd.create().encrypt(r,e);return or.encode(n)}async function Zx(r,e,t){if(r.type==="RSA")return uW(r,e,t);if(r.type==="Ed25519")return aW(r,e,t);if(r.type==="secp256k1")return cW(r,e,t);if(r.type==="ECDSA")return lW(r,e,t);throw new Xo}async function aW(r,e,t="libp2p-key"){if(t==="libp2p-key")return Py(tl(r),e);throw new $(`export format '${t}' is not supported`)}async function cW(r,e,t="libp2p-key"){if(t==="libp2p-key")return Py(tl(r),e);throw new $("Export format is not supported")}async function lW(r,e,t="libp2p-key"){if(t==="libp2p-key")return Py(tl(r),e);throw new $(`export format '${t}' is not supported`)}async function uW(r,e,t="pkcs-8"){if(t==="pkcs-8")return fW(r,e);if(t==="libp2p-key")return Py(tl(r),e);throw new $("Export format is not supported")}async function fW(r,e){let t=ar.get(),o=new Tt({value:[new lo({value:0}),new Tt({value:[new uo({value:"1.2.840.113549.1.1.1"}),new Nn]}),new sn({valueHex:r.raw})]}).toBER(),i=new Uint8Array(o,0,o.byteLength),s=gn(16),a=await vg(Tf,e,s,{c:1e4,dkLen:32}),c=gn(16),l=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),u=await t.subtle.encrypt({name:"AES-CBC",iv:c},l,i),f=new Tt({value:[new sn({valueHex:s}),new lo({value:1e4}),new lo({value:32}),new Tt({value:[new uo({value:"1.2.840.113549.2.11"}),new Nn]})]}),h=new Tt({value:[new uo({value:"1.2.840.113549.1.5.13"}),new Tt({value:[new Tt({value:[new uo({value:"1.2.840.113549.1.5.12"}),f]}),new Tt({value:[new uo({value:"2.16.840.1.101.3.4.1.42"}),new sn({valueHex:c})]})]})]}),m=new Tt({value:[h,new sn({valueHex:u})]}).toBER(),g=new Uint8Array(m,0,m.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...K(g,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function Jx(r,e){try{let t=await dW(r,e);return D_(t)}catch{}if(!r.includes("BEGIN"))throw new $("Encrypted key was not a libp2p-key or a PEM file");return hW(r,e)}async function dW(r,e){let t=or.decode(r);return sd.create().decrypt(t,e)}async function hW(r,e){let t=ar.get(),n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){let i=L(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:s}=fo(i),{iv:a,salt:c,iterations:l,keySize:u,cipherText:f}=pW(s),h=await vg(Tf,e,c,{c:l,dkLen:u}),d=await t.subtle.importKey("raw",h,"AES-CBC",!1,["decrypt"]),m=wm(await t.subtle.decrypt({name:"AES-CBC",iv:a},d,f)),{result:g}=fo(m);n=jk(g)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){let i=L(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:s}=fo(i);n=jk(s)}else throw new $("Could not parse private key from PEM data");let o=N_(n);if(o.type!=="RSA")throw new $("Could not parse RSA private key from PEM data");return o}function pW(r){let e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new $("Only pkcs5PBES2 encrypted private keys are supported");let n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new $("Only pkcs5PBKDF2 key derivation functions are supported");let i=n.valueBlock.value[1],s=wm(i.valueBlock.value[0].getValue()),a=1e4,c=32;if(i.valueBlock.value.length===3)a=Number(i.valueBlock.value[1].toBigInt()),c=Number(i.valueBlock.value[2].toBigInt());else if(i.valueBlock.value.length===2)throw new $("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key");let l=e.valueBlock.value[1].valueBlock.value[1],u=l.valueBlock.value[0].toString();if(u!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(u!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new $("Only AES-CBC encryption schemes are supported")}}}}let f=wm(l.valueBlock.value[1].getValue());return{cipherText:wm(r.valueBlock.value[1].getValue()),salt:s,iterations:a,keySize:c,iv:f}}function jk(r){return wm(r.valueBlock.value[2].getValue())}function wm(r){return new Uint8Array(r,0,r.byteLength)}var mW="/pkcs8/",t9="/info/",xm=new WeakMap,Ul={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},e9={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function fd(r){return r==null||typeof r!="string"?!1:r===(0,Wk.default)(r.trim())&&r.length>0}async function Br(){let t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function Fl(r){return new Je(mW+r)}function dd(r){return new Je(t9+r)}async function gW(r){let e=tl(r),t=await De.digest(e);return Ve.encode(t.bytes).substring(1)}var Ry=class{components;init;log;self;constructor(e,t){if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init=zt(e9,t),this.self=t.selfKey??"self",this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<Ul.minKeyLength)throw new Error(`dek.keyLength must be least ${Ul.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<Ul.minSaltLength)throw new Error(`dek.saltLength must be least ${Ul.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<Ul.minIterationCount)throw new Error(`dek.iterationCount must be least ${Ul.minIterationCount}`);let n=this.init.pass!=null&&this.init.dek?.salt!=null?wp(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";xm.set(this,{dek:n})}[Symbol.toStringTag]="@libp2p/keychain";[Ye]=["@libp2p/keychain"];static generateOptions(){let e=Object.assign({},e9),t=Math.ceil(Ul.minSaltLength/3)*3;return e.dek.salt=K(gn(t),"base64"),e}static get options(){return e9}async findKeyByName(e){if(!fd(e))throw await Br(),new $(`Invalid key name '${e}'`);let t=dd(e);try{let n=await this.components.datastore.get(t);return JSON.parse(K(n))}catch(n){throw await Br(),this.log.error(n),new $e(`Key '${e}' does not exist.`)}}async findKeyById(e){try{let t={prefix:t9};for await(let n of this.components.datastore.query(t)){let o=JSON.parse(K(n.value));if(o.id===e)return o}throw new $(`Key with id '${e}' does not exist.`)}catch(t){throw await Br(),t}}async importKey(e,t){if(!fd(e))throw await Br(),new $(`Invalid key name '${e}'`);if(t==null)throw await Br(),new $("Key is required");let n=Fl(e);if(await this.components.datastore.has(n))throw await Br(),new $(`Key '${e}' already exists`);let i,s;try{i=await gW(t);let l=xm.get(this);if(l==null)throw new $("dek missing");let u=l.dek;s=await Zx(t,u,t.type==="RSA"?"pkcs-8":"libp2p-key")}catch(l){throw await Br(),l}let a={name:e,id:i},c=this.components.datastore.batch();return c.put(n,L(s)),c.put(dd(e),L(JSON.stringify(a))),await c.commit(),a}async exportKey(e){if(!fd(e))throw await Br(),new $(`Invalid key name '${e}'`);let t=Fl(e);try{let n=await this.components.datastore.get(t),o=K(n),i=xm.get(this);if(i==null)throw new $("dek missing");let s=i.dek;return await Jx(o,s)}catch(n){throw await Br(),n}}async removeKey(e){if(!fd(e)||e===this.self)throw await Br(),new $(`Invalid key name '${e}'`);let t=Fl(e),n=await this.findKeyByName(e),o=this.components.datastore.batch();return o.delete(t),o.delete(dd(e)),await o.commit(),n}async listKeys(){let e={prefix:t9},t=[];for await(let n of this.components.datastore.query(e))t.push(JSON.parse(K(n.value)));return t}async renameKey(e,t){if(!fd(e)||e===this.self)throw await Br(),new $(`Invalid old key name '${e}'`);if(!fd(t)||t===this.self)throw await Br(),new $(`Invalid new key name '${t}'`);let n=Fl(e),o=Fl(t),i=dd(e),s=dd(t);if(await this.components.datastore.has(o))throw await Br(),new $(`Key '${t}' already exists`);try{let c=await this.components.datastore.get(n),l=await this.components.datastore.get(i),u=JSON.parse(K(l));u.name=t;let f=this.components.datastore.batch();return f.put(o,c),f.put(s,L(JSON.stringify(u))),f.delete(n),f.delete(i),await f.commit(),u}catch(c){throw await Br(),c}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await Br(),new $(`Invalid old pass type '${typeof e}'`);if(typeof t!="string")throw await Br(),new $(`Invalid new pass type '${typeof t}'`);if(t.length<20)throw await Br(),new $(`Invalid pass length ${t.length}`);this.log("recreating keychain");let n=xm.get(this);if(n==null)throw new $("dek missing");let o=n.dek;this.init.pass=t;let i=t!=null&&this.init.dek?.salt!=null?wp(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";xm.set(this,{dek:i});let s=await this.listKeys();for(let a of s){let c=await this.components.datastore.get(Fl(a.name)),l=K(c),u=await Jx(l,o),f=i.toString(),h=await Zx(u,f,u.type==="RSA"?"pkcs-8":"libp2p-key"),d=this.components.datastore.batch(),m={name:a.name,id:a.id};d.put(Fl(a.name),L(h)),d.put(dd(a.name),L(JSON.stringify(m))),await d.commit()}this.log("keychain reconstructed")}};function Dy(r={}){return e=>new Ry(e,r)}async function r9(r,e={}){let t=e.selfKey??"self",n=Dy(e)({datastore:r,logger:ka()}),o;return await r.has(new Je(`/pkcs8/${t}`))?o=await n.exportKey(t):(o=await If(e.keyType??"Ed25519"),await n.importKey(t,o)),o}var n9={},o9={},yW=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,-1,"ip6zone"],[43,8,"ipcidr"],[53,-1,"dns",!0],[54,-1,"dns4",!0],[55,-1,"dns6",!0],[56,-1,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,-1,"unix",!1,!0],[421,-1,"ipfs"],[421,-1,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,-1,"garlic64"],[448,0,"tls"],[449,-1,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,-1,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[481,-1,"http-path"],[777,-1,"memory"]];yW.forEach(r=>{let e=wW(...r);o9[e.code]=e,n9[e.name]=e});function wW(r,e,t,n,o){return{code:r,size:e,name:t,resolvable:!!n,path:!!o}}function Gk(r){if(typeof r=="number"){if(o9[r]!=null)return o9[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(n9[r]!=null)return n9[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}var xW=32,{code:bW}=Gk("dnsaddr"),i9=class extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}},Hl=async function(e,t={}){let n=t.maxRecursiveDepth??xW;if(n===0)throw new i9("Max recursive depth reached");let[,o]=e.stringTuples().find(([l])=>l===bW)??[],s=await(t?.dns??sl()).query(`_dnsaddr.${o}`,{signal:t?.signal,types:[rn.TXT]}),a=e.getPeerId(),c=[];for(let l of s.Answer){let u=l.data.replace(/["']/g,"").trim().split("=")[1];if(u==null||a!=null&&!u.includes(a))continue;let f=ne(u);if(u.startsWith("/dnsaddr")){let h=await f.resolve({...t,maxRecursiveDepth:n-1});c.push(...h.map(d=>d.toString()))}else c.push(f.toString())}return c};var vW={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:r=>r},connectionManager:{resolvers:{dnsaddr:Hl}},transportManager:{faultTolerance:Dc.FATAL_ALL}};async function Xk(r){let e=zt(vW,r);if(e.connectionProtector===null&&__Process$?.env?.LIBP2P_FORCE_PNET!=null)throw new $("Private network is enforced, but no protector was provided");return e}var bm;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={publicKey:Ie(0),payloadType:Ie(0),payload:Ie(0),signature:Ie(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=t.bytes();break}case 5:{i.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(bm||(bm={}));var Ny=class extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}};var ho=class r{static createFromProtobuf=e=>{let t=bm.decode(e),n=Qt(t.publicKey);return new r({publicKey:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t,n)=>{if(t==null)throw new Error("Missing private key");let o=e.domain,i=e.codec,s=e.marshal(),a=Yk(o,i,s),c=await t.sign(a.subarray(),n);return new r({publicKey:t.publicKey,payloadType:i,payload:s,signature:c})};static openAndCertify=async(e,t,n)=>{let o=r.createFromProtobuf(e);if(!await o.validate(t,n))throw new Ny("Envelope signature is not valid for the given domain");return o};publicKey;payloadType;payload;signature;marshaled;constructor(e){let{publicKey:t,payloadType:n,payload:o,signature:i}=e;this.publicKey=t,this.payloadType=n,this.payload=o,this.signature=i}marshal(){return this.marshaled==null&&(this.marshaled=bm.encode({publicKey:sr(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return e==null?!1:de(this.marshal(),e.marshal())}async validate(e,t){let n=Yk(e,this.payloadType,this.payload);return this.publicKey.verify(n.subarray(),this.signature,t)}},Yk=(r,e,t)=>{let n=L(r),o=br(n.byteLength),i=br(e.length),s=br(t.length);return new pe(o,n,i,e,s,t)};function Qk(r,e){let t=(n,o)=>n.toString().localeCompare(o.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,o)=>e[o].equals(n)))}var Zk="libp2p-peer-record",Jk=Uint8Array.from([3,1]);var vm;(function(r){let e;(function(n){let o;n.codec=()=>(o==null&&(o=be((i,s,a={})=>{a.lengthDelimited!==!1&&s.fork(),i.multiaddr!=null&&i.multiaddr.byteLength>0&&(s.uint32(10),s.bytes(i.multiaddr)),a.lengthDelimited!==!1&&s.ldelim()},(i,s,a={})=>{let c={multiaddr:Ie(0)},l=s==null?i.len:i.pos+s;for(;i.pos<l;){let u=i.uint32();switch(u>>>3){case 1:{c.multiaddr=i.bytes();break}default:{i.skipType(u&7);break}}}return c})),o),n.encode=i=>xe(i,n.codec()),n.decode=(i,s)=>we(i,n.codec(),s)})(e=r.AddressInfo||(r.AddressInfo={}));let t;r.codec=()=>(t==null&&(t=be((n,o,i={})=>{if(i.lengthDelimited!==!1&&o.fork(),n.peerId!=null&&n.peerId.byteLength>0&&(o.uint32(10),o.bytes(n.peerId)),n.seq!=null&&n.seq!==0n&&(o.uint32(16),o.uint64(n.seq)),n.addresses!=null)for(let s of n.addresses)o.uint32(26),r.AddressInfo.codec().encode(s,o);i.lengthDelimited!==!1&&o.ldelim()},(n,o,i={})=>{let s={peerId:Ie(0),seq:0n,addresses:[]},a=o==null?n.len:n.pos+o;for(;n.pos<a;){let c=n.uint32();switch(c>>>3){case 1:{s.peerId=n.bytes();break}case 2:{s.seq=n.uint64();break}case 3:{if(i.limits?.addresses!=null&&s.addresses.length===i.limits.addresses)throw new ft('Decode error - map field "addresses" had too many elements');s.addresses.push(r.AddressInfo.codec().decode(n,n.uint32(),{limits:i.limits?.addresses$}));break}default:{n.skipType(c&7);break}}}return s})),t),r.encode=n=>xe(n,r.codec()),r.decode=(n,o)=>we(n,r.codec(),o)})(vm||(vm={}));var An=class r{static createFromProtobuf=e=>{let t=vm.decode(e),n=cr(ze(t.peerId)),o=(t.addresses??[]).map(s=>ne(s.multiaddr)),i=t.seq;return new r({peerId:n,multiaddrs:o,seqNumber:i})};static DOMAIN=Zk;static CODEC=Jk;peerId;multiaddrs;seqNumber;domain=r.DOMAIN;codec=r.CODEC;marshaled;constructor(e){let{peerId:t,multiaddrs:n,seqNumber:o}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=o??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=vm.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof r)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!Qk(this.multiaddrs,e.multiaddrs))}};var Xs;(function(r){let e;(function(o){let i;o.codec=()=>(i==null&&(i=be((s,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),s.key!=null&&s.key!==""&&(a.uint32(10),a.string(s.key)),s.value!=null&&s.value.byteLength>0&&(a.uint32(18),a.bytes(s.value)),c.lengthDelimited!==!1&&a.ldelim()},(s,a,c={})=>{let l={key:"",value:Ie(0)},u=a==null?s.len:s.pos+a;for(;s.pos<u;){let f=s.uint32();switch(f>>>3){case 1:{l.key=s.string();break}case 2:{l.value=s.bytes();break}default:{s.skipType(f&7);break}}}return l})),i),o.encode=s=>xe(s,o.codec()),o.decode=(s,a)=>we(s,o.codec(),a)})(e=r.Peer$metadataEntry||(r.Peer$metadataEntry={}));let t;(function(o){let i;o.codec=()=>(i==null&&(i=be((s,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),s.key!=null&&s.key!==""&&(a.uint32(10),a.string(s.key)),s.value!=null&&(a.uint32(18),Ly.codec().encode(s.value,a)),c.lengthDelimited!==!1&&a.ldelim()},(s,a,c={})=>{let l={key:""},u=a==null?s.len:s.pos+a;for(;s.pos<u;){let f=s.uint32();switch(f>>>3){case 1:{l.key=s.string();break}case 2:{l.value=Ly.codec().decode(s,s.uint32(),{limits:c.limits?.value});break}default:{s.skipType(f&7);break}}}return l})),i),o.encode=s=>xe(s,o.codec()),o.decode=(s,a)=>we(s,o.codec(),a)})(t=r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let n;r.codec=()=>(n==null&&(n=be((o,i,s={})=>{if(s.lengthDelimited!==!1&&i.fork(),o.addresses!=null)for(let a of o.addresses)i.uint32(10),Oy.codec().encode(a,i);if(o.protocols!=null)for(let a of o.protocols)i.uint32(18),i.string(a);if(o.publicKey!=null&&(i.uint32(34),i.bytes(o.publicKey)),o.peerRecordEnvelope!=null&&(i.uint32(42),i.bytes(o.peerRecordEnvelope)),o.metadata!=null&&o.metadata.size!==0)for(let[a,c]of o.metadata.entries())i.uint32(50),r.Peer$metadataEntry.codec().encode({key:a,value:c},i);if(o.tags!=null&&o.tags.size!==0)for(let[a,c]of o.tags.entries())i.uint32(58),r.Peer$tagsEntry.codec().encode({key:a,value:c},i);o.updated!=null&&(i.uint32(64),i.uint64Number(o.updated)),s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={addresses:[],protocols:[],metadata:new Map,tags:new Map},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{if(s.limits?.addresses!=null&&a.addresses.length===s.limits.addresses)throw new ft('Decode error - map field "addresses" had too many elements');a.addresses.push(Oy.codec().decode(o,o.uint32(),{limits:s.limits?.addresses$}));break}case 2:{if(s.limits?.protocols!=null&&a.protocols.length===s.limits.protocols)throw new ft('Decode error - map field "protocols" had too many elements');a.protocols.push(o.string());break}case 4:{a.publicKey=o.bytes();break}case 5:{a.peerRecordEnvelope=o.bytes();break}case 6:{if(s.limits?.metadata!=null&&a.metadata.size===s.limits.metadata)throw new Kh('Decode error - map field "metadata" had too many elements');let u=r.Peer$metadataEntry.codec().decode(o,o.uint32());a.metadata.set(u.key,u.value);break}case 7:{if(s.limits?.tags!=null&&a.tags.size===s.limits.tags)throw new Kh('Decode error - map field "tags" had too many elements');let u=r.Peer$tagsEntry.codec().decode(o,o.uint32(),{limits:{value:s.limits?.tags$value}});a.tags.set(u.key,u.value);break}case 8:{a.updated=o.uint64Number();break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>xe(o,r.codec()),r.decode=(o,i)=>we(o,r.codec(),i)})(Xs||(Xs={}));var Oy;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),t.observed!=null&&(n.uint32(24),n.uint64Number(t.observed)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={multiaddr:Ie(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.multiaddr=t.bytes();break}case 2:{i.isCertified=t.bool();break}case 3:{i.observed=t.uint64Number();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(Oy||(Oy={}));var Ly;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={value:0},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.value=t.uint32();break}case 2:{i.expiry=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(Ly||(Ly={}));function AW(r,e){if(r.publicKey!=null||e.publicKey==null)return r;let t;r.type==="RSA"&&(t=r.toMultihash());let n=Qt(e.publicKey,t);return zi(n)}function eP(r,e,t){let n=Xs.decode(e);return hd(r,n,t)}function hd(r,e,t){let n=new Map,o=BigInt(Date.now());for(let[i,s]of e.tags.entries())s.expiry!=null&&s.expiry<o||n.set(i,s);return{...e,id:AW(r,e),addresses:e.addresses.filter(({observed:i})=>i!=null&&i>Date.now()-t).map(({multiaddr:i,isCertified:s})=>({multiaddr:ne(i),isCertified:s??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:n}}function tP(r,e){return EW(r.addresses,e.addresses)&&SW(r.protocols,e.protocols)&&_W(r.publicKey,e.publicKey)&&CW(r.peerRecordEnvelope,e.peerRecordEnvelope)&&IW(r.metadata,e.metadata)&&TW(r.tags,e.tags)}function EW(r,e){return nP(r,e,(t,n)=>!(t.isCertified!==n.isCertified||!de(t.multiaddr,n.multiaddr)))}function SW(r,e){return nP(r,e,(t,n)=>t===n)}function _W(r,e){return rP(r,e)}function CW(r,e){return rP(r,e)}function IW(r,e){return oP(r,e,(t,n)=>de(t,n))}function TW(r,e){return oP(r,e,(t,n)=>t.value===n.value&&t.expiry===n.expiry)}function rP(r,e){return r==null&&e==null?!0:r!=null&&e!=null?de(r,e):!1}function nP(r,e,t){if(r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(!t(r[n],e[n]))return!1;return!0}function oP(r,e,t){if(r.size!==e.size)return!1;for(let[n,o]of r.entries()){let i=e.get(n);if(i==null||!t(o,i))return!1}return!0}var s9="/peers/";function Am(r){if(!vo(r)||r.type==null)throw new $("Invalid PeerId");let e=r.toCID().toString();return new Je(`${s9}${e}`)}async function iP(r,e,t,n,o){let i=new Map;for(let s of t){if(s==null)continue;if(s.multiaddr instanceof Uint8Array&&(s.multiaddr=ne(s.multiaddr)),!Da(s.multiaddr))throw new $("Multiaddr was invalid");if(!await e(r,s.multiaddr,o))continue;let a=s.isCertified??!1,c=s.multiaddr.toString(),l=i.get(c);l!=null?s.isCertified=l.isCertified||a:i.set(c,{multiaddr:s.multiaddr,isCertified:a})}return[...i.values()].sort((s,a)=>s.multiaddr.toString().localeCompare(a.multiaddr.toString())).map(({isCertified:s,multiaddr:a})=>{let c=a.getPeerId();return r.equals(c)&&(a=a.decapsulate(ne(`/p2p/${r}`))),{isCertified:s,multiaddr:a.bytes}})}async function My(r,e,t,n){if(e==null)throw new $("Invalid PeerData");if(e.publicKey!=null&&r.publicKey!=null&&!e.publicKey.equals(r.publicKey))throw new $("publicKey bytes do not match peer id publicKey bytes");let o=n.existingPeer?.peer;if(o!=null&&!r.equals(o.id))throw new $("peer id did not match existing peer id");let i=o?.addresses??[],s=new Set(o?.protocols??[]),a=o?.metadata??new Map,c=o?.tags??new Map,l=o?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(i=[],e.multiaddrs!=null&&i.push(...e.multiaddrs.map(h=>({isCertified:!1,multiaddr:h}))),e.addresses!=null&&i.push(...e.addresses)),e.protocols!=null&&(s=new Set(e.protocols)),e.metadata!=null){let h=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=By(h,{validate:sP})}if(e.tags!=null){let h=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=By(h,{validate:aP,map:cP})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&i.push(...e.multiaddrs.map(h=>({isCertified:!1,multiaddr:h}))),e.addresses!=null&&i.push(...e.addresses),e.protocols!=null&&(s=new Set([...s,...e.protocols])),e.metadata!=null){let h=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(let[d,m]of h)m==null?a.delete(d):a.set(d,m);a=By([...a.entries()],{validate:sP})}if(e.tags!=null){let h=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),d=new Map(c);for(let[m,g]of h)g==null?d.delete(m):d.set(m,g);c=By([...d.entries()],{validate:aP,map:cP})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}let u;o?.id.publicKey!=null?u=sr(o.id.publicKey):e.publicKey!=null?u=sr(e.publicKey):r.publicKey!=null&&(u=sr(r.publicKey));let f={addresses:await iP(r,n.addressFilter??(async()=>!0),i,n.existingPeer?.peerPB.addresses,n),protocols:[...s.values()].sort((h,d)=>h.localeCompare(d)),metadata:a,tags:c,publicKey:u,peerRecordEnvelope:l};return f.addresses.forEach(h=>{h.observed=n.existingPeer?.peerPB.addresses?.find(d=>de(d.multiaddr,d.multiaddr))?.observed??Date.now()}),r.type!=="RSA"&&delete f.publicKey,f}function By(r,e){let t=new Map;for(let[n,o]of r)o!=null&&e.validate(n,o);for(let[n,o]of r.sort(([i],[s])=>i.localeCompare(s)))o!=null&&t.set(n,e.map?.(n,o)??o);return t}function sP(r,e){if(typeof r!="string")throw new $("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new $("Metadata value must be a Uint8Array")}function aP(r,e){if(typeof r!="string")throw new $("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new $("Tag value must be an integer");if(e.value<0||e.value>100)throw new $("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new $("Tag ttl must be an integer");if(e.ttl<0)throw new $("Tag ttl must be between greater than 0")}}function cP(r,e){let t;e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl)));let n={value:e.value??0};return t!=null&&(n.expiry=t),n}function lP(r){let e=r.toString().split("/")[2],t=q.parse(e,Vt);return yn(t)}function a9(r,e,t){let n=lP(r);return eP(n,e,t)}function kW(r,e){return{prefix:s9,filters:(r.filters??[]).map(t=>({key:n,value:o})=>t(a9(n,o,e))),orders:(r.orders??[]).map(t=>(n,o)=>t(a9(n.key,n.value,e),a9(o.key,o.value,e)))}}var Uy=class{peerId;datastore;locks;addressFilter;log;maxAddressAge;maxPeerAge;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.locks=ks({name:"libp2p_peer_store_locks",metrics:e.metrics}),this.maxAddressAge=t.maxAddressAge??36e5,this.maxPeerAge=t.maxPeerAge??216e5}getLock(e){let t=this.locks.get(e);return t==null&&(t={refs:0,lock:Op({name:e.toString(),singleProcess:!0})},this.locks.set(e,t)),t.refs++,t}maybeRemoveLock(e,t){t.refs--,t.refs===0&&(t.lock.finalize(),this.locks.delete(e))}async getReadLock(e,t){let n=this.getLock(e);try{let o=await n.lock.readLock(t);return()=>{o(),this.maybeRemoveLock(e,n)}}catch(o){throw this.maybeRemoveLock(e,n),o}}async getWriteLock(e,t){let n=this.getLock(e);try{let o=await n.lock.writeLock(t);return()=>{o(),this.maybeRemoveLock(e,n)}}catch(o){throw this.maybeRemoveLock(e,n),o}}async has(e,t){try{return await this.load(e,t),!0}catch(n){if(n.name!=="NotFoundError")throw n}return!1}async delete(e,t){this.peerId.equals(e)||await this.datastore.delete(Am(e),t)}async load(e,t){let n=Am(e),o=await this.datastore.get(n,t),i=Xs.decode(o);if(this.#r(e,i))throw await this.datastore.delete(n,t),new $e;return hd(e,i,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t,n){let o=await this.#e(e,n),i=await My(e,t,"patch",{...n,addressFilter:this.addressFilter});return this.#t(e,i,o)}async patch(e,t,n){let o=await this.#e(e,n),i=await My(e,t,"patch",{...n,addressFilter:this.addressFilter,existingPeer:o});return this.#t(e,i,o)}async merge(e,t,n){let o=await this.#e(e,n),i=await My(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:o});return this.#t(e,i,o)}async*all(e){for await(let{key:t,value:n}of this.datastore.query(kW(e??{},this.maxAddressAge),e)){let o=lP(t);if(o.equals(this.peerId))continue;let i=Xs.decode(n);if(this.#r(o,i)){await this.datastore.delete(t,e);continue}yield hd(o,i,this.peerId.equals(o)?1/0:this.maxAddressAge)}}async#e(e,t){try{let n=Am(e),o=await this.datastore.get(n,t),i=Xs.decode(o);if(this.#r(e,i))throw await this.datastore.delete(n,t),new $e;return{peerPB:i,peer:hd(e,i,this.maxAddressAge)}}catch(n){n.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",n)}}async#t(e,t,n,o){t.updated=Date.now();let i=Xs.encode(t);return await this.datastore.put(Am(e),i,o),{peer:hd(e,t,this.maxAddressAge),previous:n?.peer,updated:n==null||!tP(t,n.peerPB)}}#r(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;let n=t.updated<Date.now()-this.maxPeerAge,o=Date.now()-this.maxAddressAge,i=t.addresses.filter(s=>s.observed!=null&&s.observed>o);return n&&i.length===0}};var c9=class{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new Uy(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){for await(let n of this.store.all(t))e(n)}async all(e){return Vs(this.store.all(e))}async delete(e,t){let n=await this.store.getReadLock(e,t);try{await this.store.delete(e,t)}finally{n()}}async has(e,t){let n=await this.store.getReadLock(e,t);try{return await this.store.has(e,t)}finally{this.log.trace("has release read lock"),n?.()}}async get(e,t){let n=await this.store.getReadLock(e,t);try{return await this.store.load(e,t)}finally{n?.()}}async getInfo(e,t){let n=await this.get(e,t);return{id:n.id,multiaddrs:n.addresses.map(({multiaddr:o})=>o)}}async save(e,t,n){let o=await this.store.getWriteLock(e,n);try{let i=await this.store.save(e,t,n);return this.#e(e,i),i.peer}finally{o?.()}}async patch(e,t,n){let o=await this.store.getWriteLock(e,n);try{let i=await this.store.patch(e,t,n);return this.#e(e,i),i.peer}finally{o?.()}}async merge(e,t,n){let o=await this.store.getWriteLock(e,n);try{let i=await this.store.merge(e,t,n);return this.#e(e,i),i.peer}finally{o?.()}}async consumePeerRecord(e,t,n){let o=vo(t)?t:vo(t?.expectedPeer)?t.expectedPeer:void 0,i=vo(t)||t===void 0?n:t,s=await ho.openAndCertify(e,An.DOMAIN,i),a=yn(s.publicKey.toCID());if(o?.equals(a)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",o,a),!1;let c=An.createFromProtobuf(s.payload),l;try{l=await this.get(a,i)}catch(u){if(u.name!=="NotFoundError")throw u}if(l?.peerRecordEnvelope!=null){let u=ho.createFromProtobuf(l.peerRecordEnvelope),f=An.createFromProtobuf(u.payload);if(f.seqNumber>=c.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",f.seqNumber,c.seqNumber),!1}return await this.patch(c.peerId,{peerRecordEnvelope:e,addresses:c.multiaddrs.map(u=>({isCertified:!0,multiaddr:u}))},i),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}};function uP(r,e={}){return new c9(r,e)}var fP=864e13;var PW=448,l9=449,RW=53,DW=54,NW=55,OW=56,Fy=class{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=lr({name:"libp2p_address_manager_dns_mappings",metrics:e.metrics})}has(e){let t=this.findHost(e);for(let n of this.mappings.values())if(n.domain===t)return!0;return!1}add(e,t){t.forEach(n=>{this.log("add DNS mapping %s to %s",n,e);let o=bn(n)===!0;this.mappings.set(n,{domain:e,verified:o,expires:o?fP-Date.now():0,lastVerified:o?fP-Date.now():void 0})})}remove(e){let t=this.findHost(e),n=!1;for(let[o,i]of this.mappings.entries())i.domain===t&&(this.log("removing %s to %s DNS mapping %e",o,i.domain,new Error("where")),this.mappings.delete(o),n=n||i.verified);return n}getAll(e){let t=[];for(let n=0;n<e.length;n++){let i=e[n].multiaddr.stringTuples(),s=i[0][1];if(s!=null)for(let[a,c]of this.mappings.entries()){if(s!==a)continue;this.maybeAddSNITuple(i,c.domain)&&(e.splice(n,1),n--,t.push({multiaddr:ne(`/${i.map(u=>[It(u[0]).name,u[1]].join("/")).join("/")}`),verified:c.verified,type:"dns-mapping",expires:c.expires,lastVerified:c.lastVerified}))}}return t}maybeAddSNITuple(e,t){for(let n=0;n<e.length;n++)if(e[n][0]===PW&&e[n+1]?.[0]!==l9)return e.splice(n+1,0,[l9,t]),!0;return!1}confirm(e,t){let n=this.findHost(e),o=!1;for(let[i,s]of this.mappings.entries())s.domain===n&&(this.log("marking %s to %s DNS mapping as verified",i,s.domain),o=s.verified,s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now());return o}unconfirm(e,t){let n=this.findHost(e),o=!1;for(let[i,s]of this.mappings.entries())s.domain===n&&(this.log("removing verification of %s to %s DNS mapping",i,s.domain),o=o||s.verified,s.verified=!1,s.expires=Date.now()+t);return o}findHost(e){for(let t of e.stringTuples())if(t[0]===l9||t[0]===RW||t[0]===DW||t[0]===NW||t[0]===OW)return t[1]}};var u9=4,f9=41,d9=6,LW=273,Hy=class{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=lr({name:"libp2p_address_manager_ip_mappings",metrics:e.metrics})}has(e){let t=e.stringTuples();for(let n of this.mappings.values())for(let o of n)if(o.externalIp===t[0][1])return!0;return!1}add(e,t,n,o=t,i="tcp"){let s=`${e}-${t}-${i}`,a=this.mappings.get(s)??[],c={internalIp:e,internalPort:t,externalIp:n,externalPort:o,externalFamily:co(n)?4:6,protocol:i,verified:!1,expires:0};a.push(c),this.mappings.set(s,a)}remove(e){let t=e.stringTuples(),n=t[0][1]??"",o=t[1][0]===d9?"tcp":"udp",i=parseInt(t[1][1]??"0"),s=!1;for(let[a,c]of this.mappings.entries()){for(let l=0;l<c.length;l++){let u=c[l];u.externalIp===n&&u.externalPort===i&&u.protocol===o&&(this.log("removing %s:%s to %s:%s %s IP mapping",u.externalIp,u.externalPort,n,i,o),s=s||u.verified,c.splice(l,1),l--)}c.length===0&&this.mappings.delete(a)}return s}getAll(e){let t=[];for(let{multiaddr:n}of e){let o=n.stringTuples(),i;if((o[0][0]===u9||o[0][0]===f9)&&o[1][0]===d9?i=`${o[0][1]}-${o[1][1]}-tcp`:(o[0][0]===u9||o[0][0]===f9)&&o[1][0]===LW&&(i=`${o[0][1]}-${o[1][1]}-udp`),i==null)continue;let s=this.mappings.get(i);if(s!=null)for(let a of s)o[0][0]=a.externalFamily===4?u9:f9,o[0][1]=a.externalIp,o[1][1]=`${a.externalPort}`,t.push({multiaddr:ne(`/${o.map(c=>[It(c[0]).name,c[1]].join("/")).join("/")}`),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return t}confirm(e,t){let o=e.stringTuples()[0][1],i=!1;for(let s of this.mappings.values())for(let a of s)a.externalIp===o&&(this.log("marking %s to %s IP mapping as verified",a.internalIp,a.externalIp),i=a.verified,a.verified=!0,a.expires=Date.now()+t,a.lastVerified=Date.now());return i}unconfirm(e,t){let n=e.stringTuples(),o=n[0][1]??"",i=n[1][0]===d9?"tcp":"udp",s=parseInt(n[1][1]??"0"),a=!1;for(let c of this.mappings.values())for(let l=0;l<c.length;l++){let u=c[l];u.externalIp===o&&u.externalPort===s&&u.protocol===i&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",u.externalIp,u.externalPort,o,s,i),a=a||u.verified,u.verified=!1,u.expires=Date.now()+t)}return a}};function dP(r){try{for(let{code:e,value:t}of r.getComponents())if(e!==42&&t!=null){if(e===4)return t.startsWith("169.254.");if(e===41)return t.toLowerCase().startsWith("fe80")}}catch{}return!1}function $y(r){try{for(let{code:e}of r.getComponents())if(e!==42)return e===4||e===41}catch{}return!1}function No(r){try{if(!$y(r))return!1;let[[,e]]=r.stringTuples();return e==null?!1:bn(e)??!1}catch{}return!0}var BW={maxObservedAddresses:10},Vy=class{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=lr({name:"libp2p_address_manager_observed_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??BW.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(let t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(No(e)||dP(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:ne(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){let t=this.addresses.get(e.toString())?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){let n=e.toString(),o=this.addresses.get(n)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},i=o.verified;return o.verified=!0,o.expires=Date.now()+t,o.lastVerified=Date.now(),this.log("marking observed address %a as verified",n),this.addresses.set(n,o),i}};var MW=[4,41,53,54,55,56];function h9(r){try{for(let{code:e}of r.getComponents())if(e!==42)return MW.includes(e)}catch{}return!1}var UW={maxObservedAddresses:10},Ky=class{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=lr({name:"libp2p_address_manager_transport_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??UW.maxObservedAddresses}get(e,t){if(No(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};let n=this.toKey(e),o=this.addresses.get(n);return o==null&&(o={verified:!h9(e),expires:0},this.addresses.set(n,o)),{multiaddr:e,verified:o.verified,type:"transport",expires:o.expires,lastVerified:o.lastVerified}}has(e){let t=this.toKey(e);return this.addresses.has(t)}remove(e){let t=this.toKey(e),n=this.addresses.get(t)?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),n}confirm(e,t){let n=this.toKey(e),o=this.addresses.get(n)??{verified:!1,expires:0,lastVerified:0},i=o.verified;return o.verified=!0,o.expires=Date.now()+t,o.lastVerified=Date.now(),this.addresses.set(n,o),i}unconfirm(e,t){let n=this.toKey(e),o=this.addresses.get(n)??{verified:!1,expires:0},i=o.verified;return o.verified=!1,o.expires=Date.now()+t,this.addresses.set(n,o),i}toKey(e){if(h9(e)){let t=e.toOptions();return`${t.host}-${t.port}-${t.transport}`}return e.toString()}};var hP=6e4,pP={maxObservedAddresses:10,addressVerificationTTL:hP*10,addressVerificationRetry:hP*5},FW=r=>r;function p9(r,e){let t=r.getPeerId();return t!=null&&tt(t).equals(e)&&(r=r.decapsulate(ne(`/p2p/${e.toString()}`))),r}var zy=class{log;components;listen;announce;appendAnnounce;announceFilter;observed;dnsMappings;ipMappings;transportAddresses;observedAddressFilter;addressVerificationTTL;addressVerificationRetry;constructor(e,t={}){let{listen:n=[],announce:o=[],appendAnnounce:i=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=n.map(s=>s.toString()),this.announce=new Set(o.map(s=>s.toString())),this.appendAnnounce=new Set(i.map(s=>s.toString())),this.observed=new Vy(e,t),this.dnsMappings=new Fy(e,t),this.ipMappings=new Hy(e,t),this.transportAddresses=new Ky(e,t),this.announceFilter=t.announceFilter??FW,this.observedAddressFilter=en(1024),this.addressVerificationTTL=t.addressVerificationTTL??pP.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??pP.addressVerificationRetry,this._updatePeerStoreAddresses=Lh(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){let e=this.getAddresses().map(t=>t.getPeerId()===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>ne(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>ne(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>ne(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){let t=e.stringTuples(),n=`${t[0][1]}:${t[1][1]}`;this.observedAddressFilter.has(n)||(this.observedAddressFilter.add(n),e=p9(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=p9(e,this.components.peerId);let n=!0;(t?.type==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL),n=!1):!this.observed.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1)),n||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=p9(e,this.components.peerId);let n=!1;this.observed.has(e)&&!this.observed.remove(e)&&n&&(n=!1),this.transportAddresses.has(e)&&!this.transportAddresses.unconfirm(e,t?.ttl??this.addressVerificationRetry)&&n&&(n=!1),this.dnsMappings.has(e)&&!this.dnsMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)&&n&&(n=!1),this.ipMappings.has(e)&&!this.ipMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)&&n&&(n=!1),n&&this._updatePeerStoreAddresses()}getAddresses(){let e=new Set,t=this.getAddressesWithMetadata().filter(n=>{if(!n.verified)return!1;let o=n.multiaddr.toString();return e.has(o)?!1:(e.add(o),!0)}).map(n=>n.multiaddr);return this.announceFilter(t.map(n=>{let o=ne(n);return o.getComponents().pop()?.value===this.components.peerId.toString()?o:o.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){let e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(o=>{o.updateAnnounceAddrs(e)}),e.map(o=>({multiaddr:o,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(o=>this.transportAddresses.get(o,this.addressVerificationTTL)));let n=this.getAppendAnnounceAddrs();return n.length>0&&(this.components.transportManager.getListeners().forEach(o=>{o.updateAnnounceAddrs(n)}),t=t.concat(n.map(o=>({multiaddr:o,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(ne(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,n,o=t,i="tcp"){this.ipMappings.add(e,t,n,o,i),this.observed.removePrefixed(`/ip${co(n)?4:6}/${n}/${i}/${o}`)}removePublicAddressMapping(e,t,n,o=t,i="tcp"){this.ipMappings.remove(ne(`/ip${co(n)?4:6}/${n}/${i}/${o}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e))return!1;let t=e.toOptions();if(t.family===6||t.host==="127.0.0.1"||bn(t.host)===!0)return!1;let n=this.components.transportManager.getListeners(),o=[i=>Hs.exactMatch(i)||bl.exactMatch(i),i=>xl.exactMatch(i),i=>wT.exactMatch(i)];for(let i of o){if(!i(e))continue;let s=n.filter(l=>l.getAddrs().filter(u=>u.toOptions().family===4&&i(u)).length>0);if(s.length!==1)continue;let a=s[0].getAddrs().filter(l=>l.toOptions().host!=="127.0.0.1").pop();if(a==null)continue;let c=a.toOptions();return this.observed.remove(e),this.ipMappings.add(c.host,c.port,t.host,t.port,t.transport),!0}return!1}};var mP;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.NOT_FOUND="Not found"})(mP||(mP={}));var qy=class extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}},jy=class extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}},pd=class extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}},Em=class extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}},Wy=class extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}},Gy=class extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}},Xy=class extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}},Sm=class extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}},Yy=class extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}},Qy=class extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}},Zy=class extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}},Jy=class extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}},e3=class extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}},$l=class extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}},Vl=class extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}},t3=class extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}};var m9=class{components={};_started=!1;constructor(e={}){this.components={};for(let[t,n]of Object.entries(e))this.components[t]=n;this.components.logger==null&&(this.components.logger=ka())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>k0(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}},$W=["metrics","connectionProtector","dns"],VW=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function gP(r={}){let e=new m9(r);return new Proxy(e,{get(n,o,i){if(typeof o=="string"&&!VW.includes(o)){let s=e.components[o];if(s==null&&!$W.includes(o))throw new qy(`${o} not set`);return s}return Reflect.get(n,o,i)},set(n,o,i){return typeof o=="string"?e.components[o]=i:Reflect.set(n,o,i),!0}})}function yP(r){let e={};for(let t of Object.values(r.components))for(let n of KW(t))e[n]=!0;for(let t of Object.values(r.components))for(let n of zW(t))if(e[n]!==!0)throw new jy(`Service "${qW(t)}" required capability "${n}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function KW(r){return Array.isArray(r?.[Ye])?r[Ye]:[]}function zW(r){return Array.isArray(r?.[Qn])?r[Qn]:[]}function qW(r){return r?.[Symbol.toStringTag]??r?.toString()??"unknown"}var jW=4,WW=41;function wP(r={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{if(Hs.matches(e))return!1;let t=e.stringTuples();return t[0][0]===jW||t[0][0]===WW?!!bn(`${t[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...r}}var xP=()=>{let r=new Error("Delay aborted");return r.name="AbortError",r},GW=new WeakMap;function XW({clearTimeout:r,setTimeout:e}={}){return(t,{value:n,signal:o}={})=>{if(o?.aborted)return Promise.reject(xP());let i,s,a,c=r??clearTimeout,l=()=>{c(i),a(xP())},u=()=>{o&&o.removeEventListener("abort",l)},f=new Promise((h,d)=>{s=()=>{u(),h(n)},a=d,i=(e??setTimeout)(s,t)});return o&&o.addEventListener("abort",l,{once:!0}),GW.set(f,()=>{c(i),i=null,s()}),f}}var YW=XW(),r3=YW;var md=class{memoryStorage;points;duration;blockDuration;execEvenly;execEvenlyMinDelayMs;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new g9}async consume(e,t=1,n={}){let o=this.getKey(e),i=this._getKeySecDuration(n),s=this.memoryStorage.incrby(o,t,i);if(s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.consumedPoints>this.points)throw this.blockDuration>0&&s.consumedPoints<=this.points+t&&(s=this.memoryStorage.set(o,s.consumedPoints,this.blockDuration)),new R0("Rate limit exceeded",s);if(this.execEvenly&&s.msBeforeNext>0&&!s.isFirstInDuration){let a=Math.ceil(s.msBeforeNext/(s.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=s.consumedPoints*this.execEvenlyMinDelayMs),await r3(a)}return s}penalty(e,t=1,n={}){let o=this.getKey(e),i=this._getKeySecDuration(n),s=this.memoryStorage.incrby(o,t,i);return s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s}reward(e,t=1,n={}){let o=this.getKey(e),i=this._getKeySecDuration(n),s=this.memoryStorage.incrby(o,-t,i);return s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s}block(e,t){let n=t*1e3,o=this.points+1;return this.memoryStorage.set(this.getKey(e),o,t),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:o,isFirstInDuration:!1}}set(e,t,n=0){let o=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:o===0?-1:o,consumedPoints:t,isFirstInDuration:!1}}get(e){let t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return e?.customDuration!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}},g9=class{storage;constructor(){this.storage=new Map}incrby(e,t,n){let o=this.storage.get(e);if(o!=null){let i=o.expiresAt!=null?o.expiresAt.getTime()-new Date().getTime():-1;return o.expiresAt==null||i>0?(o.value+=t,{remainingPoints:0,msBeforeNext:i,consumedPoints:o.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){let o=n*1e3,i=this.storage.get(e);i!=null&&clearTimeout(i.timeoutId);let s={value:t,expiresAt:o>0?new Date(Date.now()+o):void 0};return this.storage.set(e,s),o>0&&(s.timeoutId=setTimeout(()=>{this.storage.delete(e)},o),s.timeoutId.unref!=null&&s.timeoutId.unref()),{remainingPoints:0,msBeforeNext:o===0?-1:o,consumedPoints:s.value,isFirstInDuration:!0}}get(e){let t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){let t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}};function n3(r){if(vo(r))return{peerId:r,multiaddrs:[]};let e=Array.isArray(r)?r:[r],t;if(e.length>0){let n=e[0].getPeerId();t=n==null?void 0:tt(n),e.forEach(o=>{if(!Da(o))throw new ga("Invalid multiaddr");let i=o.getPeerId();if(i==null){if(t!=null)throw new $("Multiaddrs must all have the same peer id or have no peer id")}else{let s=tt(i);if(t?.equals(s)!==!0)throw new $("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(n=>!hT.exactMatch(n)),{peerId:t,multiaddrs:e}}var QW=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function bP(r,e){let t=r?.streams?.map(o=>o.protocol)??[],n=e?.closableProtocols??QW;if(!(t.filter(o=>o!=null&&!n.includes(o)).length>0))try{await r?.close(e)}catch(o){r?.abort(o)}}async function vP(r,e){let t=!1;for(let o of Xf.keys())if(t=r.protoNames().includes(o),t)break;if(!t)return[r];let n=await r.resolve(e);return e.log("resolved %s to",r,n.map(o=>o.toString())),n}function _m(r){try{let e;if(typeof r=="string"?e=ne(r):e=r,!e.protoNames().includes("ipcidr")){let n=e.protoNames().includes("ip6")?"/ipcidr/128":"/ipcidr/32";e=e.encapsulate(n)}return Ax(e)}catch{throw new Error(`Can't convert to IpNet, Invalid multiaddr format: ${r}`)}}var o3=class{connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.allow=(t.allow??[]).map(n=>_m(n)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections %e",e)})}async _maybePruneConnections(){let e=this.connectionManager.getConnections(),t=e.length,n=this.connectionManager.getMaxConnections();if(this.log("checking max connections limit %d/%d",t,n),t<=n)return;let o=new Jr;for(let c of e){let l=c.remotePeer;if(!o.has(l)){o.set(l,0);try{let u=await this.peerStore.get(l);o.set(l,[...u.tags.values()].reduce((f,h)=>f+h.value,0))}catch(u){u.name!=="NotFoundError"&&this.log.error("error loading peer tags",u)}}}let i=this.sortConnections(e,o),s=Math.max(t-n,0),a=[];for(let c of i)if(this.log("too many connections open - closing a connection to %p",c.remotePeer),this.allow.some(u=>u.contains(c.remoteAddr.nodeAddress().address))||a.push(c),a.length===s)break;await Promise.all(a.map(async c=>{await bP(c,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:a})}sortConnections(e,t){return e.sort((n,o)=>{let i=n.timeline.open,s=o.timeline.open;return i<s?1:i>s?-1:0}).sort((n,o)=>n.direction==="outbound"&&o.direction==="inbound"?1:n.direction==="inbound"&&o.direction==="outbound"?-1:0).sort((n,o)=>n.streams.length>o.streams.length?1:n.streams.length<o.streams.length?-1:0).sort((n,o)=>{let i=t.get(n.remotePeer)??0,s=t.get(o.remotePeer)??0;return i>s?1:i<s?-1:0})}};var AP="last-dial-failure",EP="last-dial-success";var SP=100,i3=50;var s3=class extends _r{constructor(e={}){super({...e,sort:(t,n)=>t.options.priority>n.options.priority?-1:t.options.priority<n.options.priority?1:0})}};function _P(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function y9(r){if(!$y(r))return!1;let{address:e}=r.nodeAddress();return _P(e)}function ZW(r,e){let t=xl.exactMatch(r.multiaddr),n=xl.exactMatch(e.multiaddr);if(t&&!n)return-1;if(!t&&n)return 1;let o=bl.exactMatch(r.multiaddr),i=bl.exactMatch(e.multiaddr);if(o&&!i)return-1;if(!o&&i)return 1;let s=Hs.exactMatch(r.multiaddr),a=Hs.exactMatch(e.multiaddr);if(s&&!a)return-1;if(!s&&a)return 1;let c=Xp.exactMatch(r.multiaddr),l=Xp.exactMatch(e.multiaddr);if(c&&!l)return-1;if(!c&&l)return 1;let u=Gp.exactMatch(r.multiaddr),f=Gp.exactMatch(e.multiaddr);if(u&&!f)return-1;if(!u&&f)return 1;let h=Rx.exactMatch(r.multiaddr),d=Rx.exactMatch(e.multiaddr);return h&&!d?-1:!h&&d?1:0}function JW(r,e){let t=y9(r.multiaddr),n=y9(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function eG(r,e){let t=No(r.multiaddr),n=No(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function tG(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function rG(r,e){let t=kn.exactMatch(r.multiaddr),n=kn.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function CP(r){return r.sort(ZW).sort(tG).sort(rG).sort(eG).sort(JW)}var a3={maxParallelDials:i3,maxDialQueueLength:500,maxPeerAddrsToDial:25,dialTimeout:1e4,resolvers:{dnsaddr:Hl}},c3=class{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;constructor(e,t={}){this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??a3.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??a3.maxDialQueueLength,this.dialTimeout=t.dialTimeout??a3.dialTimeout,this.connections=t.connections??new Jr,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.shutDownController=new AbortController,this.shutDownController.signal;for(let[n,o]of Object.entries(t.resolvers??{}))Xf.set(n,o);this.queue=new s3({concurrency:t.maxParallelDials??a3.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("error",n=>{n.detail?.name!==Xe.name&&this.log.error("error in dial queue - %e",n.detail)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){let{peerId:n,multiaddrs:o}=n3(e),i=Array.from(this.connections.values()).flat().find(a=>t.force===!0?!1:a.remotePeer.equals(n)?!0:o.find(c=>c.equals(a.remoteAddr)));if(i?.status==="open")return this.log("already connected to %a",i.remoteAddr),t.onProgress?.(new j("dial-queue:already-connected")),i;let s=this.queue.queue.find(a=>{if(n?.equals(a.options.peerId)===!0)return!0;let c=a.options.multiaddrs;if(c==null)return!1;for(let l of o)if(c.has(l.toString()))return!0;return!1});if(s!=null){this.log("joining existing dial target for %p",n);for(let a of o)s.options.multiaddrs.add(a.toString());return t.onProgress?.(new j("dial-queue:already-in-dial-queue")),s.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new xs("Dial queue is full");return this.log("creating dial target for %p",n,o.map(a=>a.toString())),t.onProgress?.(new j("dial-queue:add-to-dial-queue")),this.queue.add(async a=>{a.onProgress?.(new j("dial-queue:start-dial"));let c=ke([this.shutDownController.signal,a.signal]);try{return await this.dialPeer(a,c)}finally{c.clear()}},{peerId:n,priority:t.priority??v9,multiaddrs:new Set(o.map(a=>a.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){let n=e.peerId,o=e.multiaddrs,i=new Set,s=e.multiaddrs.size===0,a=0,c=0,l=[];for(this.log("starting dial to %p",n);s||o.size>0;){c++,s=!1;let u=[],f=new Set(e.multiaddrs);o.clear(),this.log("calculating addrs to dial %p from %s",n,[...f]);let h=await this.calculateMultiaddrs(n,f,{...e,signal:t});for(let d of h){if(i.has(d.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",d.multiaddr,n);continue}u.push(d)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",n,u.map(d=>d.multiaddr.toString())),e?.onProgress?.(new j("dial-queue:calculated-addresses",u));for(let d of u){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,e.peerId),new xs("Peer had more than maxPeerAddrsToDial");a++;try{let m=await this.components.transportManager.dial(d.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",d.multiaddr);try{await this.components.peerStore.merge(m.remotePeer,{multiaddrs:[m.remoteAddr],metadata:{[EP]:L(Date.now().toString())}})}catch(g){this.log.error("could not update last dial failure key for %p",n,g)}return m}catch(m){if(this.log.error("dial failed to %a",d.multiaddr,m),i.add(d.multiaddr.toString()),n!=null)try{await this.components.peerStore.merge(n,{metadata:{[AP]:L(Date.now().toString())}})}catch(g){this.log.error("could not update last dial failure key for %p",n,g)}if(t.aborted)throw new Ao(m.message);l.push(m)}}}throw l.length===1?l[0]:new AggregateError(l,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,n={}){let o=[...t].map(f=>({multiaddr:ne(f),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new xs("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(e)===!0)throw new Sm("The dial request is blocked by gater.allowDialPeer");if(o.length===0){this.log("loading multiaddrs for %p",e);try{let f=await this.components.peerStore.get(e);o.push(...f.addresses),this.log("loaded multiaddrs for %p",e,o.map(({multiaddr:h})=>h.toString()))}catch(f){if(f.name!=="NotFoundError")throw f}}if(o.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{let f=await this.components.peerRouting.findPeer(e,n);this.log("found multiaddrs for %p in the peer routing",e,o.map(({multiaddr:h})=>h.toString())),o.push(...f.multiaddrs.map(h=>({multiaddr:h,isCertified:!1})))}catch(f){f.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,f)}}}let i=(await Promise.all(o.map(async f=>{let h=await vP(f.multiaddr,{dns:this.components.dns,...n,log:this.log});return h.length===1&&h[0].equals(f.multiaddr)?f:h.map(d=>({multiaddr:d,isCertified:!1}))}))).flat();if(e!=null){let f=`/p2p/${e.toString()}`;i=i.map(h=>h.multiaddr.getComponents().pop()?.name!=="p2p"?{multiaddr:h.multiaddr.encapsulate(f),isCertified:h.isCertified}:h)}let s=i.filter(f=>{if(this.components.transportManager.dialTransportForMultiaddr(f.multiaddr)==null)return!1;let h=f.multiaddr.getPeerId();return e!=null&&h!=null?e.equals(h):!0}),a=new Map;for(let f of s){let h=f.multiaddr.toString(),d=a.get(h);if(d!=null){d.isCertified=d.isCertified||f.isCertified||!1;continue}a.set(h,f)}let c=[...a.values()];if(c.length===0)throw new Zy("The dial request has no valid addresses");let l=[];for(let f of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(f.multiaddr)||l.push(f);let u=this.addressSorter==null?CP(l):l.sort(this.addressSorter);if(u.length===0)throw new Sm("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",i.map(({multiaddr:f})=>f.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",u.map(({multiaddr:f})=>f.toString())),u}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{let n=await this.calculateMultiaddrs(void 0,new Set(e.map(o=>o.toString())),t);return t.runOnLimitedConnection===!1?n.find(o=>!kn.matches(o.multiaddr))!=null:!0}catch(n){this.log.trace("error calculating if multiaddr(s) were dialable",n)}return!1}};var NP=st(RP(),1);var oG=Object.prototype.toString,iG=r=>oG.call(r)==="[object Error]",sG=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Load failed","Network request failed","fetch failed","terminated"]);function A9(r){return r&&iG(r)&&r.name==="TypeError"&&typeof r.message=="string"?r.message==="Load failed"?r.stack===void 0:sG.has(r.message):!1}var E9=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}},DP=(r,e,t)=>{let n=t.retries-(e-1);return r.attemptNumber=e,r.retriesLeft=n,r};async function S9(r,e){return new Promise((t,n)=>{e={...e},e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.retries??=10;let o=NP.default.operation(e),i=()=>{o.stop(),n(e.signal?.reason)};e.signal&&!e.signal.aborted&&e.signal.addEventListener("abort",i,{once:!0});let s=()=>{e.signal?.removeEventListener("abort",i),o.stop()};o.attempt(async a=>{try{let c=await r(a);s(),t(c)}catch(c){try{if(!(c instanceof Error))throw new TypeError(`Non-error was thrown: "${c}". You should only throw errors.`);if(c instanceof E9)throw c.originalError;if(c instanceof TypeError&&!A9(c))throw c;if(DP(c,a,e),await e.shouldRetry(c)||(o.stop(),n(c)),await e.onFailedAttempt(c),!o.retry(c))throw o.mainError()}catch(l){DP(l,a,e),s(),n(l)}}})})}var l3=class{log;queue;started;peerStore;retries;retryInterval;backoffFactor;connectionManager;events;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new Cr({concurrency:t.maxParallelReconnects??5,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",n=>{this.maybeReconnect(n.detail).catch(o=>{this.log.error("failed to maybe reconnect to %p - %e",n.detail,o)})})}async maybeReconnect(e){if(!this.started)return;let t=await this.peerStore.get(e);OP(t)&&(this.queue.has(e)||this.queue.add(async n=>{await S9(async o=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:n?.signal})}catch(i){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,o,this.retries,i),i}},{signal:n?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async n=>{this.log.error("failed to reconnect to %p - %e",e,n);let o={};[...t.tags.keys()].forEach(i=>{i.startsWith(pa)&&(o[i]=void 0)}),await this.peerStore.merge(e,{tags:o}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async n=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,n)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{let e=await this.peerStore.all({filters:[t=>OP(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(n=>{this.log.error(n)})}))}).catch(e=>{this.log.error(e)})}stop(){this.started=!1,this.queue.abort()}};function OP(r){for(let e of r.tags.keys())if(e.startsWith(pa))return!0;return!1}var v9=50,_9={maxConnections:SP,inboundConnectionThreshold:5,maxIncomingPendingConnections:10},u3=class{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;outboundPendingConnections;maxConnections;dialQueue;reconnectQueue;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;peerId;constructor(e,t={}){if(this.maxConnections=t.maxConnections??_9.maxConnections,this.maxConnections<1)throw new $("Connection Manager maxConnections must be greater than 0");this.connections=new Jr,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(n=>_m(n)),this.deny=(t.deny??[]).map(n=>_m(n)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??_9.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new md({points:t.inboundConnectionThreshold??_9.inboundConnectionThreshold,duration:1}),this.connectionPruner=new o3({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{allow:t.allow?.map(n=>ne(n))}),this.dialQueue=new c3(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??i3,maxDialQueueLength:t.maxDialQueueLength??500,maxPeerAddrsToDial:t.maxPeerAddrsToDial??25,dialTimeout:t.dialTimeout??1e4,resolvers:t.resolvers??{dnsaddr:Hl},connections:this.connections}),this.reconnectQueue=new l3({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}[Symbol.toStringTag]="@libp2p/connection-manager";async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{let e={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(let t of this.connections.values())for(let n of t)e[n.direction]++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{let e={};for(let t of this.connections.values())for(let n of t)for(let o of n.streams){let i=`${o.direction} ${o.protocol??"unnegotiated"}`;e[i]=(e[i]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{let e={};for(let n of this.connections.values())for(let o of n){let i={};for(let s of o.streams){let a=`${s.direction} ${s.protocol??"unnegotiated"}`;i[a]=(i[a]??0)+1}for(let[s,a]of Object.entries(i))e[s]=e[s]??[],e[s].push(a)}let t={};for(let[n,o]of Object.entries(e)){o=o.sort((s,a)=>s-a);let i=Math.floor(o.length*.9);t[n]=o[i]}return t}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await Sr(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await Wr(this.reconnectQueue,this.dialQueue,this.connectionPruner);let e=[];for(let t of this.connections.values())for(let n of t)e.push((async()=>{try{await n.close()}catch(o){this.log.error(o)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}setMaxConnections(e){if(this.maxConnections<1)throw new $("Connection Manager maxConnections must be greater than 0");let t=!1;e<this.maxConnections&&(t=!0),this.maxConnections=e,t&&this.connectionPruner.maybePruneConnections()}onConnect(e){this._onConnect(e).catch(t=>{this.log.error(t)})}async _onConnect(e){let{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;let n=t.remotePeer,o=!this.connections.has(n),i=this.connections.get(n)??[];i.push(t),this.connections.set(n,i),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),o&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){let{detail:t}=e,n=t.remotePeer,i=(this.connections.get(n)??[]).filter(s=>s.id!==t.id);this.connections.set(n,i),i.length===0&&(this.log("onDisconnect remove all connections for peer %p",n),this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(let n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.started)throw new Yn("Not started");this.outboundPendingConnections++;try{t.signal?.throwIfAborted();let{peerId:n}=n3(e);if(this.peerId.equals(n))throw new Xu("Can not dial self");if(n!=null&&t.force!==!0){this.log("dial %p",n);let a=this.getConnections(n).find(c=>c.limits==null);if(a!=null)return this.log("had an existing non-limited connection to %p",n),t.onProgress?.(new j("dial-queue:already-connected")),a}let o=await this.dialQueue.dial(e,{...t,priority:t.priority??v9});if(o.status!=="open")throw new Wu("Remote closed connection during opening");let i=this.connections.get(o.remotePeer);i==null&&(i=[],this.connections.set(o.remotePeer,i));let s=!1;for(let a of i)if(a.id===o.id&&(s=!0),t.force!==!0&&a.id!==o.id&&a.remoteAddr.equals(o.remoteAddr))return o.abort(new ga("Duplicate multiaddr connection")),a;return s||i.push(o),o}finally{this.outboundPendingConnections--}}async closeConnections(e,t={}){let n=this.connections.get(e)??[];await Promise.all(n.map(async o=>{try{await o.close(t)}catch(i){o.abort(i)}}))}async acceptIncomingConnection(e){if(this.deny.some(o=>o.contains(e.remoteAddr.nodeAddress().address)))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(o=>o.contains(e.remoteAddr.nodeAddress().address)))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){let o=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(o,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,o),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){let e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(n=>ne(n))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}};var gd=class{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(e){this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){let n=this.alpha(t,this.previousTime),o=e-this.movingAverage,i=n*o;this.movingAverage=n*e+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+o*i),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*o}else this.movingAverage=e;this.previousTime=t}};var lG=1.2,uG=2,fG=5e3,dG=6e4,hG=5e3,wi=class{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;maxTimeout;constructor(e={}){let t=e.interval??hG;this.success=new gd(t),this.failure=new gd(t),this.next=new gd(t),this.failureMultiplier=e.failureMultiplier??uG,this.timeoutMultiplier=e.timeoutMultiplier??lG,this.minTimeout=e.minTimeout??fG,this.maxTimeout=e.maxTimeout??dG,e.metricName!=null&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier));t<this.minTimeout&&(t=this.minTimeout),t>this.maxTimeout&&(t=this.maxTimeout);let n=AbortSignal.timeout(t),o=ke([e.signal,n]);return o.start=Date.now(),o.timeout=t,o}cleanUp(e){let t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}};var f3=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function zl(r,e){let t=$0();r.sink(t).catch(async s=>{await t.end(s)}),r.sink=async s=>{for await(let a of s)await t.push(a);await t.end()};let n=r.source;r.source[Symbol.iterator]!=null?n=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(n=r.source[Symbol.asyncIterator]());let o=new pe;return{read:async s=>{if(s?.signal?.throwIfAborted(),s?.bytes==null){let{done:c,value:l}=await ut(n.next(),s?.signal);return c===!0?null:l}for(;o.byteLength<s.bytes;){let{value:c,done:l}=await ut(n.next(),s?.signal);if(l===!0)throw new f3("unexpected end of input");o.append(c)}let a=o.sublist(0,s.bytes);return o.consume(s.bytes),a},write:async(s,a)=>{a?.signal?.throwIfAborted(),s instanceof Uint8Array?await t.push(s,a):await t.push(s.subarray(),a)},unwrap:()=>{if(o.byteLength>0){let s=r.source;r.source=async function*(){e?.yieldBytes===!1?yield o:yield*o,yield*s}()}return r}}}var pG=1e4,mG="1.0.0",gG="ping",yG="ipfs",LP=32,wG=!0,d3=class{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;abortConnectionOnPingFailure;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??yG}/${gG}/${mG}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??pG,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??wG,this.timeout=new wi({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[Ye]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{let t=Date.now();try{let n=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),o=await e.newStream(this.protocol,{signal:n,runOnLimitedConnection:!0}),i=zl(o);t=Date.now(),await Promise.all([i.write(gn(LP),{signal:n}),i.read({bytes:LP,signal:n})]),e.rtt=Date.now()-t,await i.unwrap().close({signal:n})}catch(n){if(n.name!=="UnsupportedProtocolError")throw n;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}};var h3=class{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=e.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,cid:n.toString()}),getAttributesFromYieldedValue:(n,o)=>({...o,providers:[...Array.isArray(o.providers)?o.providers:[],n.id.toString()]})})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,cid:n.toString()})})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,cid:n.toString()})})??this.cancelReprovide,this.put=e.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([n])=>({key:K(n,"base36")})})??this.put,this.get=e.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([n])=>({key:K(n,"base36")})})??this.get}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new pd("No content routers available");let n=this,o=new ro;for await(let i of fn(...n.routers.filter(s=>s.findProviders instanceof Function).map(s=>s.findProviders(e,t))))i!=null&&(i.multiaddrs.length>0&&await this.components.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!o.has(i.id)&&(o.add(i.id),yield i))}async provide(e,t={}){if(this.routers.length===0)throw new pd("No content routers available");await Promise.all(this.routers.filter(n=>n.provide instanceof Function).map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new pd("No content routers available");await Promise.all(this.routers.filter(n=>n.cancelReprovide instanceof Function).map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new Yn;await Promise.all(this.routers.filter(o=>o.put instanceof Function).map(async o=>{await o.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new Yn;return Promise.any(this.routers.filter(n=>n.get instanceof Function).map(async n=>n.get(e,t)))}};var p3=globalThis.CustomEvent??Event;async function*En(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);let n=e.ordered??!1,o=new EventTarget,i=[],s=ve(),a=ve(),c=!1,l,u=!1;o.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(let m of r){if(i.length===t&&(s=ve(),await s.promise),u)break;let g={done:!1};i.push(g),m().then(w=>{g.done=!0,g.ok=!0,g.value=w,o.dispatchEvent(new p3("task-complete"))},w=>{g.done=!0,g.err=w,o.dispatchEvent(new p3("task-complete"))})}c=!0,o.dispatchEvent(new p3("task-complete"))}catch(m){l=m,o.dispatchEvent(new p3("task-complete"))}});function f(){return n?i[0]?.done:!!i.find(m=>m.done)}function*h(){for(;i.length>0&&i[0].done;){let m=i[0];if(i.shift(),m.ok)yield m.value;else throw u=!0,s.resolve(),m.err;s.resolve()}}function*d(){for(;f();)for(let m=0;m<i.length;m++)if(i[m].done){let g=i[m];if(i.splice(m,1),m--,g.ok)yield g.value;else throw u=!0,s.resolve(),g.err;s.resolve()}}for(;;){if(f()||(a=ve(),await a.promise),l!=null||(n?yield*h():yield*d(),l!=null))throw l;if(c&&i.length===0)break}}var m3=class{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=e.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,peer:n.toString()})})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,key:K(n,"base36")}),getAttributesFromYieldedValue:(n,o)=>({...o,peers:[...Array.isArray(o.peers)?o.peers:[],n.id.toString()]})})??this.getClosestPeers}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(this.routers.length===0)throw new Em("No peer routers available");if(e.toString()===this.peerId.toString())throw new Wy("Should not try to find self");let n=this,o=fn(...this.routers.filter(i=>i.findPeer instanceof Function).map(i=>async function*(){try{yield await i.findPeer(e,t)}catch(s){n.log.error(s)}}()));for await(let i of o)if(i!=null)return i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),i;throw new $e}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new Em("No peer routers available");let n=this,o=en(1024);for await(let i of En(async function*(){let s=fn(...n.routers.filter(a=>a.getClosestPeers instanceof Function).map(a=>a.getClosestPeers(e,t)));for await(let a of s)yield async()=>{if(a.multiaddrs.length===0)try{a=await n.findPeer(a.id,{...t,useCache:!1})}catch(c){n.log.error("could not find peer multiaddrs",c);return}return a}}()))i!=null&&(i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!o.has(i.id.toMultihash().bytes)&&(o.add(i.id.toMultihash().bytes),yield i))}};var g3=class extends Re{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;let t=ke([this.shutdownController.signal,e?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=ve(),yield(await Ft(this,"walk:peer",t,{errorEvent:"walk:error"})).detail}finally{t.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;let e=ke([this.walkController.signal,this.shutdownController.signal]);let t=Date.now(),n=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{let o=gn(32),i=Date.now();for await(let s of this.peerRouting.getClosestPeers(o,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",s.id,Date.now()-i,this.walkers),n++,this.safeDispatchEvent("walk:peer",{detail:s}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await ut(this.needNext.promise,e)),i=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",o,this.walkers,n)}catch(o){this.log.error("random walk errored",o),this.safeDispatchEvent("walk:error",{detail:o})}this.log("no walkers left, ended walk")}).catch(o=>{this.log.error("random walk errored",o)}).finally(()=>{this.log("finished walk, found %d peers after %dms",n,Date.now()-t),this.walking=!1})}};var C9=32,I9=64,y3=class{log;topologies;handlers;components;constructor(e){this.components=e,this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,e.metrics?.registerMetricGroup("libp2p_registrar_topologies",{calculate:()=>{let t={};for(let[n,o]of this.topologies)t[n]=o.size;return t}}),this.handlers=lr({name:"libp2p_registrar_protocol_handlers",metrics:e.metrics}),this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){let t=this.handlers.get(e);if(t==null)throw new Gy(`No handler registered for protocol ${e}`);return t}getTopologies(e){let t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e)&&n?.force!==!0)throw new Xy(`Handler already registered for protocol ${e}`);let o=zt.bind({ignoreUndefined:!0})({maxInboundStreams:C9,maxOutboundStreams:I9},n);this.handlers.set(e,{handler:t,options:o}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]},n)}async unhandle(e,t){(Array.isArray(e)?e:[e]).forEach(o=>{this.handlers.delete(o)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()},t)}async register(e,t){if(t==null)throw new $("invalid topology");let n=`${(Math.random()*1e9).toString(36)}${Date.now()}`,o=this.topologies.get(e);return o==null&&(o=new Map,this.topologies.set(e,o)),o.set(n,t),n}unregister(e){for(let[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}_onDisconnect(e){let t=e.detail,n={signal:AbortSignal.timeout(5e3)};this.components.peerStore.get(t,n).then(o=>{for(let i of o.protocols){let s=this.topologies.get(i);if(s!=null)for(let a of s.values())a.filter?.has(t)!==!1&&(a.filter?.remove(t),a.onDisconnect?.(t))}}).catch(o=>{o.name!=="NotFoundError"&&this.log.error("could not inform topologies of disconnecting peer %p",t,o)})}_onPeerUpdate(e){let{peer:t,previous:n}=e.detail,o=(n?.protocols??[]).filter(i=>!t.protocols.includes(i));for(let i of o){let s=this.topologies.get(i);if(s!=null)for(let a of s.values())a.filter?.has(t.id)!==!1&&(a.filter?.remove(t.id),a.onDisconnect?.(t.id))}}_onPeerIdentify(e){let t=e.detail.protocols,n=e.detail.connection,o=e.detail.peerId;for(let i of t){let s=this.topologies.get(i);if(s!=null)for(let a of s.values())n.limits!=null&&a.notifyOnLimitedConnection!==!0||a.filter?.has(o)!==!0&&(a.filter?.add(o),a.onConnect?.(o,n))}}};var w3=class{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=lr({name:"libp2p_transport_manager_transports",metrics:this.components.metrics}),this.listeners=lr({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??Dc.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){let t=e[Symbol.toStringTag];if(t==null)throw new $("Transport must have a valid tag");if(this.transports.has(t))throw new $(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){let e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){let e=[];for(let[t,n]of this.listeners)for(this.log("closing listeners for %s",t);n.length>0;){let o=n.pop();o!=null&&e.push(o.close())}await Promise.all(e),this.log("all listeners closed");for(let t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){let n=this.dialTransportForMultiaddr(e);if(n==null)throw new t3(`No transport available for address ${String(e)}`);return t?.onProgress?.(new j("transport-manager:selected-transport",n[Symbol.toStringTag])),n.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(let t of this.listeners.values())for(let n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(let t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(let t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new Yn("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}let t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(i=>{t.errors.set(i.toString(),new Yy)});let n=[];for(let[i,s]of this.transports.entries()){let a=s.listenFilter(e);for(let c of a){this.log("creating listener for %s on %a",i,c);let l=s.createListener({upgrader:this.components.upgrader}),u=this.listeners.get(i)??[];u==null&&(u=[],this.listeners.set(i,u)),u.push(l),l.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:l})}),l.addEventListener("close",()=>{let f=u.findIndex(h=>h===l);u.splice(f,1),this.components.events.safeDispatchEvent("transport:close",{detail:l})}),Ix.matches(c)?t.ipv4.attempts++:Tx.matches(c)&&t.ipv6.attempts++,n.push(l.listen(c).then(()=>{t.errors.delete(c.toString()),Ix.matches(c)&&t.ipv4.success++,Tx.matches(c)&&t.ipv6.success++},f=>{throw this.log.error("transport %s could not listen on address %a - %e",i,c,f),t.errors.set(c.toString(),f),f}))}}let o=await Promise.allSettled(n);if(!(o.length>0&&o.every(i=>i.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===Dc.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new Qy(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([i,s])=>`
  ${i}: ${`${s.stack??s}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;let t=e.ipv4.attempts===e.ipv4.success,n=e.ipv6.success===0;return t&&n}async remove(e){let t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);let n=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){let o=t.pop();o!=null&&n.push(o.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){let e=[];for(let t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}};var Mr="/multistream/1.0.0";var x3=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},b3=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},v3=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function Qi(r,e={}){let t=zl(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=Ke(e.maxDataLength));let n=e?.lengthDecoder??Yo,o=e?.lengthEncoder??br;return{read:async s=>{let a=-1,c=new pe;for(;;){c.append(await t.read({...s,bytes:1}));try{a=n(c)}catch(l){if(l instanceof RangeError)continue;throw l}if(a<0)throw new x3("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new v3("message length length too long");if(a>-1)break}if(e?.maxDataLength!=null&&a>e.maxDataLength)throw new b3("message length too long");return t.read({...s,bytes:a})},write:async(s,a)=>{await t.write(new pe(o(s.byteLength),s),a)},writeV:async(s,a)=>{let c=new pe(...s.flatMap(l=>[o(l.byteLength),l]));await t.write(c,a)},unwrap:()=>t.unwrap()}}var xG=L(`
`);async function ql(r,e,t){await r.write(e,t)}async function BP(r,e,t){await r.writeV(e,t)}async function bG(r,e){let t=await r.read(e);if(t.byteLength===0||t.get(t.byteLength-1)!==xG[0])throw e.log.error("Invalid mss message - missing newline",t),new Oe("Missing newline");return t.sublist(0,-1)}async function Ha(r,e){let t=await bG(r,e);return K(t.subarray())}async function Cm(r,e,t){if(e=Array.isArray(e)?[...e]:[e],e.length===1&&t.negotiateFully===!1)return vG(r,e[0],t);let n=Qi(r,{...t,maxDataLength:1024}),o=e.shift();if(o==null)throw new Error("At least one protocol must be specified");t.log.trace('select: write ["%s", "%s"]',Mr,o);let i=L(`${Mr}
`),s=L(`${o}
`);await BP(n,[i,s],t),t.log.trace("select: reading multistream-select header");let a=await Ha(n,t);if(t.log.trace('select: read "%s"',a),a===Mr&&(t.log.trace("select: reading protocol response"),a=await Ha(n,t),t.log.trace('select: read "%s"',a)),a===o)return{stream:n.unwrap(),protocol:o};for(let c of e){t.log.trace('select: write "%s"',c),await ql(n,L(`${c}
`),t),t.log.trace("select: reading protocol response");let l=await Ha(n,t);if(t.log.trace('select: read "%s" for "%s"',l,c),l===c)return{stream:n.unwrap(),protocol:c}}throw new ws("protocol selection failed")}function vG(r,e,t){let n=r.sink.bind(r),o=r.source,i=!1,s=!1,a=ve(),c=!1,l=!1,u=ve(),f=!1,h=!1,d=ve(),m=Qi({sink:n,source:o},{...t,maxDataLength:1024});r.sink=async v=>{let{sink:A}=m.unwrap();await A(async function*(){let S=!1;for await(let _ of v){if(l&&await u.promise,c)yield _;else{l=!0,t.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',Mr,e,_.byteLength);let U=`${e}
`;yield new pe(Uint8Array.from([19]),L(`${Mr}
`),br(U.length),L(U),_).subarray(),t.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',Mr,e,_.byteLength),c=!0,l=!1,u.resolve(),g().catch(k=>{t.log.error("could not finish optimistic protocol negotiation of %s",e,k)})}S=!0}S||await g()}())};async function g(){if(s){t.log.trace("optimistic: already negotiating %s stream",e),await a.promise;return}s=!0;try{c||(t.log.trace("optimistic: doing send protocol for %s stream",e),await w()),f||(t.log.trace("optimistic: doing read protocol for %s stream",e),await x())}finally{s=!1,i=!0,a.resolve()}}async function w(){if(l){await u.promise;return}l=!0;try{t.log.trace('optimistic: write ["%s", "%s", data] in source',Mr,e),await m.writeV([L(`${Mr}
`),L(`${e}
`)]),t.log.trace('optimistic: wrote ["%s", "%s", data] in source',Mr,e)}finally{c=!0,l=!1,u.resolve()}}async function x(){if(h){await d.promise;return}h=!0;try{t.log.trace("optimistic: reading multistream select header");let v=await Ha(m,t);if(t.log.trace('optimistic: read multistream select header "%s"',v),v===Mr&&(v=await Ha(m,t)),t.log.trace('optimistic: read protocol "%s", expecting "%s"',v,e),v!==e)throw new ws("protocol selection failed")}finally{f=!0,h=!1,d.resolve()}}if(r.source=async function*(){await g(),t.log.trace('optimistic: reading data from "%s" stream',e),yield*m.unwrap().source}(),r.closeRead!=null){let v=r.closeRead.bind(r);r.closeRead=async A=>{i||await g().catch(S=>{t.log.error("could not negotiate protocol before close read",S)}),await v(A)}}if(r.closeWrite!=null){let v=r.closeWrite.bind(r);r.closeWrite=async A=>{i||await g().catch(S=>{t.log.error("could not negotiate protocol before close write",S)}),await v(A)}}if(r.close!=null){let v=r.close.bind(r);r.close=async A=>{let S=[];l&&S.push(u.promise),h&&S.push(d.promise),S.length>0?await ut(Promise.all(S),A?.signal):(i=!0,s=!1,a.resolve()),await v(A)}}return{stream:r,protocol:e}}async function Im(r,e,t){e=Array.isArray(e)?e:[e],t.log.trace("handle: available protocols %s",e);let n=Qi(r,{...t,maxDataLength:1024,maxLengthLength:2});for(;;){t.log.trace("handle: reading incoming string");let o=await Ha(n,t);if(t.log.trace('handle: read "%s"',o),o===Mr){t.log.trace('handle: respond with "%s" for "%s"',Mr,o),await ql(n,L(`${Mr}
`),t),t.log.trace('handle: responded with "%s" for "%s"',Mr,o);continue}if(e.includes(o))return t.log.trace('handle: respond with "%s" for "%s"',o,o),await ql(n,L(`${o}
`),t),t.log.trace('handle: responded with "%s" for "%s"',o,o),{stream:n.unwrap(),protocol:o};if(o==="ls"){let i=new pe(...e.map(s=>vs.single(L(`${s}
`))),L(`
`));t.log.trace('handle: respond with "%s" for %s',e,o),await ql(n,i,t),t.log.trace('handle: responded with "%s" for %s',e,o);continue}t.log.trace('handle: respond with "na" for "%s"',o),await ql(n,L(`na
`),t),t.log('handle: responded with "na" for "%s"',o)}}var EG=500,k9=class{id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;limits;log;tags;_newStream;_close;_abort;_getStreams;constructor(e){let{remoteAddr:t,remotePeer:n,newStream:o,close:i,abort:s,getStreams:a}=e;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=n,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.limits=e.limits,this.log=e.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=o,this._close=i,this._abort=s,this._getStreams=a,this.tags=[]}[Symbol.toStringTag]="Connection";[EE]=!0;get streams(){return this._getStreams()}async newStream(e,t){if(this.status==="closing")throw new S0("the connection is being closed");if(this.status==="closed")throw new Wu("the connection is closed");if(Array.isArray(e)||(e=[e]),this.limits!=null&&t?.runOnLimitedConnection!==!0)throw new Yu("Cannot open protocol stream on limited connection");let n=await this._newStream(e,t);return n.direction="outbound",n}async close(e={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",e.signal==null){let t=AbortSignal.timeout(EG);e={...e,signal:t}}try{this.log.trace("closing underlying transport"),await this._close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(t){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,t),this.abort(t)}}}abort(e){this.status!=="closed"&&(this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this._abort(e),this.status="closed",this.timeline.close=Date.now())}};function UP(r){return new k9(r)}function _G(r,e){try{let{options:t}=e.getHandler(r);return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return C9}function CG(r,e,t={}){try{let{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.name!=="UnhandledProtocolError")throw n}return t.maxOutboundStreams??I9}function FP(r,e,t){let n=0;return t.streams.forEach(o=>{o.direction===e&&o.protocol===r&&n++}),n}var A3=class{components;connectionEncrypters;streamMuxers;inboundUpgradeTimeout;inboundStreamProtocolNegotiationTimeout;outboundStreamProtocolNegotiationTimeout;events;metrics;constructor(e,t){this.components=e,this.connectionEncrypters=lr({name:"libp2p_upgrader_connection_encrypters",metrics:this.components.metrics}),t.connectionEncrypters.forEach(n=>{this.connectionEncrypters.set(n.protocol,n)}),this.streamMuxers=lr({name:"libp2p_upgrader_stream_multiplexers",metrics:this.components.metrics}),t.streamMuxers.forEach(n=>{this.streamMuxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??1e4,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??1e4,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??1e4,this.events=e.events,this.metrics={dials:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total"),inboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_inbound_errors_total"),outboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_outbound_errors_total")}}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,...t){let n=this.components.connectionGater[e];if(n==null)return;if(await n.apply(this.components.connectionGater,t)===!0)throw new Jy(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){let t=ke([AbortSignal.timeout(this.inboundUpgradeTimeout),e]);return t}async upgradeInbound(e,t){let n=!1,o=this.createInboundAbortSignal(t.signal);try{if(this.metrics.dials?.increment({inbound:!0}),n=await ut(this.components.connectionManager.acceptIncomingConnection(e),o),!n)throw new e3("Connection denied");await ut(this.shouldBlockConnection("denyInboundConnection",e),o),await this._performUpgrade(e,"inbound",{...t,signal:o})}catch(i){throw this.metrics.errors?.increment({inbound:!0}),this.metrics.inboundErrors?.increment({[i.name??"Error"]:!0}),i}finally{o.clear(),n&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){try{this.metrics.dials?.increment({outbound:!0});let n=e.remoteAddr.getPeerId(),o;n!=null&&(o=tt(n),await ut(this.shouldBlockConnection("denyOutboundConnection",o,e),t.signal));let i="outbound";return t.initiator===!1&&(i="inbound"),await this._performUpgrade(e,i,t)}catch(n){throw this.metrics.errors?.increment({outbound:!0}),this.metrics.outboundErrors?.increment({[n.name??"Error"]:!0}),n}}async _performUpgrade(e,t,n){let o,i,s,a,c;this.components.metrics?.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t);let l=e;if(n?.skipProtection!==!0){let u=this.components.connectionProtector;u!=null&&(e.log("protecting the %s connection",t),l=await u.protect(e,n))}try{if(o=l,n?.skipEncryption!==!0){n?.onProgress?.(new j(`upgrader:encrypt-${t}-connection`)),{conn:o,remotePeer:i,protocol:c,streamMuxer:a}=await(t==="inbound"?this._encryptInbound(l,n):this._encryptOutbound(l,n));let u={...l,...o};await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",i,u)}else{let u=e.remoteAddr.getPeerId();if(u==null)throw new ga(`${t} connection that skipped encryption must have a peer id`);let f=tt(u);c="native",i=f}if(i.equals(this.components.peerId)){let u=new Xu("Can not dial self");throw e.abort(u),u}if(s=o,n?.muxerFactory!=null)a=n.muxerFactory;else if(a==null&&this.streamMuxers.size>0){n?.onProgress?.(new j(`upgrader:multiplex-${t}-connection`));let u=await(t==="inbound"?this._multiplexInbound({...l,...o},this.streamMuxers,n):this._multiplexOutbound({...l,...o},this.streamMuxers,n));a=u.muxerFactory,s=u.stream}}catch(u){throw e.log.error("failed to upgrade inbound connection %s %a - %e",t==="inbound"?"from":"to",e.remoteAddr,u),u}return await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",i,e),e.log("successfully upgraded %s connection",t),this._createConnection({cryptoProtocol:c,direction:t,maConn:e,upgradedConn:s,muxerFactory:a,remotePeer:i,limits:n?.limits})}_createConnection(e){let{cryptoProtocol:t,direction:n,maConn:o,upgradedConn:i,remotePeer:s,muxerFactory:a,limits:c}=e,l,u,f;a!=null&&(l=a.createStreamMuxer({direction:n,onIncomingStream:m=>{if(f==null)return;let g=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);Promise.resolve().then(async()=>{let w=this.components.registrar.getProtocols(),{stream:x,protocol:v}=await Im(m,w,{signal:g,log:m.log,yieldBytes:!1});if(f==null)return;f.log("incoming stream opened on %s",v);let A=_G(v,this.components.registrar);if(FP(v,"inbound",f)===A){let _=new T0(`Too many inbound protocol streams for protocol "${v}" - limit ${A}`);throw m.abort(_),_}m.source=x.source,m.sink=x.sink,m.protocol=v,x.closeWrite!=null&&(m.closeWrite=x.closeWrite),x.closeRead!=null&&(m.closeRead=x.closeRead),x.close!=null&&(m.close=x.close),await this.components.peerStore.merge(s,{protocols:[v]},{signal:g}),this.components.metrics?.trackProtocolStream(m,f),this._onStream({connection:f,stream:m,protocol:v})}).catch(async w=>{f.log.error("error handling incoming stream id %s - %e",m.id,w),m.timeline.close==null&&await m.close({signal:g}).catch(x=>m.abort(x))})}}),u=async(m,g={})=>{if(l==null)throw new $l("Connection is not multiplexed");f.log.trace("starting new stream for protocols %s",m);let w=await l.newStream();f.log.trace("started new stream %s for protocols %s",w.id,m);try{if(g.signal==null){w.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",m);let _=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);g={...g,signal:_}}w.log.trace("selecting protocol from protocols %s",m);let{stream:x,protocol:v}=await Cm(w,m,{...g,log:w.log,yieldBytes:!0});w.log.trace("selected protocol %s",v);let A=CG(v,this.components.registrar,g),S=FP(v,"outbound",f);if(S>=A){let _=new wa(`Too many outbound protocol streams for protocol "${v}" - ${S}/${A}`);throw w.abort(_),_}return await this.components.peerStore.merge(s,{protocols:[v]}),w.source=x.source,w.sink=x.sink,w.protocol=v,x.closeWrite!=null&&(w.closeWrite=x.closeWrite),x.closeRead!=null&&(w.closeRead=x.closeRead),x.close!=null&&(w.close=x.close),this.components.metrics?.trackProtocolStream(w,f),w}catch(x){throw f.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",n==="inbound"?"from":"to",e.maConn.remoteAddr,m,x),w.timeline.close==null&&w.abort(x),x}},Promise.all([l.sink(i.source),i.sink(l.source)]).catch(m=>{f.log.error("error piping data through muxer - %e",m)}));let h=o.timeline;o.timeline=new Proxy(h,{set:(...m)=>(m[1]==="close"&&m[2]!=null&&h.close==null&&(async()=>{try{f.status==="open"&&await f.close()}catch(g){f.log.error("error closing connection after timeline close %e",g)}finally{this.events.safeDispatchEvent("connection:close",{detail:f})}})().catch(g=>{f.log.error("error thrown while dispatching connection:close event %e",g)}),Reflect.set(...m))}),o.timeline.upgraded=Date.now();let d=()=>{throw new $l("Connection is not multiplexed")};return f=UP({remoteAddr:o.remoteAddr,remotePeer:s,status:"open",direction:n,timeline:o.timeline,multiplexer:l?.protocol,encryption:t,limits:c,logger:this.components.logger,newStream:u??d,getStreams:()=>l?.streams??[],close:async m=>{await l?.close(m),await o.close(m)},abort:m=>{o.abort(m),l?.abort(m)}}),this.events.safeDispatchEvent("connection:open",{detail:f}),f.__maConnTimeline=h,f}_onStream(e){let{connection:t,stream:n,protocol:o}=e,{handler:i,options:s}=this.components.registrar.getHandler(o);if(t.limits!=null&&s.runOnLimitedConnection!==!0)throw new Yu("Cannot open protocol stream on limited connection");i({connection:t,stream:n})}async _encryptInbound(e,t){let n=Array.from(this.connectionEncrypters.keys());try{let{stream:o,protocol:i}=await Im(e,n,{...t,log:e.log}),s=this.connectionEncrypters.get(i);if(s==null)throw new Vl(`no crypto module found for ${i}`);return e.log("encrypting inbound connection to %a using %s",e.remoteAddr,i),{...await s.secureInbound(o,t),protocol:i}}catch(o){throw e.log.error("encrypting inbound connection from %a failed",e.remoteAddr,o),new Vl(o.message)}}async _encryptOutbound(e,t){let n=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",n);let{stream:o,protocol:i}=await Cm(e,n,{...t,log:e.log,yieldBytes:!0}),s=this.connectionEncrypters.get(i);if(s==null)throw new Vl(`no crypto module found for ${i}`);return e.log("encrypting outbound connection to %a using %s",e.remoteAddr,i),{...await s.secureOutbound(o,t),protocol:i}}catch(o){throw e.log.error("encrypting outbound connection to %a failed",e.remoteAddr,o),new Vl(o.message)}}async _multiplexOutbound(e,t,n){let o=Array.from(t.keys());e.log("outbound selecting muxer %s",o);try{e.log.trace("selecting stream muxer from %s",o);let{stream:i,protocol:s}=await Cm(e,o,{...n,log:e.log,yieldBytes:!0});e.log("selected %s as muxer protocol",s);let a=t.get(s);return{stream:i,muxerFactory:a}}catch(i){throw e.log.error("error multiplexing outbound connection",i),new $l(String(i))}}async _multiplexInbound(e,t,n){let o=Array.from(t.keys());e.log("inbound handling muxers %s",o);try{let{stream:i,protocol:s}=await Im(e,o,{...n,log:e.log}),a=t.get(s);return{stream:i,muxerFactory:a}}catch(i){throw e.log.error("error multiplexing inbound connection",i),new $l(String(i))}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}};var E3="2.8.10",S3="js-libp2p";function _3(r,e){return`${r??S3}/${e??E3} browser/${globalThis.navigator.userAgent}`}var C3=class extends Re{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";let t=new Re,n=t.dispatchEvent.bind(t);t.dispatchEvent=l=>{let u=n(l),f=this.dispatchEvent(new CustomEvent(l.type,{detail:l.detail}));return u||f},this.peerId=e.peerId,this.logger=e.logger??ka(),this.log=this.logger.forComponent("libp2p"),this.services={};let o=e.nodeInfo?.name??S3,i=e.nodeInfo?.version??E3,s=this.components=gP({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:{name:o,version:i,userAgent:e.nodeInfo?.userAgent??_3(o,i)},logger:this.logger,events:t,datastore:e.datastore??new Al,connectionGater:wP(e.connectionGater),dns:e.dns});e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),this.peerStore=this.configureComponent("peerStore",uP(s,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),s.events.addEventListener("peer:update",l=>{if(l.detail.previous==null){let u={id:l.detail.peer.id,multiaddrs:l.detail.peer.addresses.map(f=>f.multiaddr)};s.events.safeDispatchEvent("peer:discovery",{detail:u})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(s)),this.components.upgrader=new A3(this.components,{connectionEncrypters:(e.connectionEncrypters??[]).map((l,u)=>this.configureComponent(`connection-encryption-${u}`,l(this.components))),streamMuxers:(e.streamMuxers??[]).map((l,u)=>this.configureComponent(`stream-muxers-${u}`,l(this.components))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:e.connectionManager?.inboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:e.connectionManager?.outboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout}),this.configureComponent("transportManager",new w3(this.components,e.transportManager)),this.configureComponent("connectionManager",new u3(this.components,e.connectionManager)),e.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new d3(this.components,e.connectionMonitor)),this.configureComponent("registrar",new y3(this.components)),this.configureComponent("addressManager",new zy(this.components,e.addresses));let a=(e.peerRouters??[]).map((l,u)=>this.configureComponent(`peer-router-${u}`,l(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new m3(this.components,{routers:a}));let c=(e.contentRouters??[]).map((l,u)=>this.configureComponent(`content-router-${u}`,l(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new h3(this.components,{routers:c})),this.configureComponent("randomWalk",new g3(this.components)),(e.peerDiscovery??[]).forEach((l,u)=>{this.configureComponent(`peer-discovery-${u}`,l(this.components)).addEventListener("peer",h=>{this.#e(h)})}),e.transports?.forEach((l,u)=>{this.components.transportManager.add(this.configureComponent(`transport-${u}`,l(this.components)))}),e.services!=null)for(let l of Object.keys(e.services)){let u=e.services[l],f=u(this.components);if(f==null){this.log.error("service factory %s returned null or undefined instance",l);continue}this.services[l]=f,this.configureComponent(l,f),f[Ni]!=null&&(this.log("registering service %s for content routing",l),c.push(f[Ni])),f[Oi]!=null&&(this.log("registering service %s for peer routing",l),a.push(f[Oi])),f[Rc]!=null&&(this.log("registering service %s for peer discovery",l),f[Rc].addEventListener?.("peer",h=>{this.#e(h)}))}yP(s)}configureComponent(e,t){return t==null&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(e){throw this.log.error("An error occurred starting libp2p",e),this.status="started",await this.stop(),e}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){let e=new ro;for(let t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,n={}){if(t==null)throw new $("no protocols were provided to open a stream");if(t=Array.isArray(t)?t:[t],t.length===0)throw new $("no protocols were provided to open a stream");return(await this.dial(e,n)).newStream(t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){Da(e)&&(e=tt(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{let s=await this.peerStore.get(e,t);if(s.id.publicKey!=null)return s.id.publicKey}catch(s){if(s.name!=="NotFoundError")throw s}let n=je([L("/pk/"),e.toMultihash().bytes]),o=await this.contentRouting.get(n,t),i=Qt(o);return await this.peerStore.patch(e,{publicKey:i},t),i}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async o=>{await this.components.registrar.handle(o,t,n)}))}async unhandle(e,t){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async n=>{await this.components.registrar.unhandle(n,t)}))}async register(e,t,n){return this.components.registrar.register(e,t,n)}unregister(e){this.components.registrar.unregister(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#e(e){let{detail:t}=e;if(t.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch(n=>{this.log.error(n)})}};async function I3(r={}){r.privateKey??=await If("Ed25519");let e=new C3({...await Xk(r),peerId:B_(r.privateKey)});return r.start!==!1&&await e.start(),e}function P9(){let r=ve(),e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,r.resolve(t)},source:async function*(){yield*await r.promise}()}}function $P(){let r=P9(),e=P9();return[{source:r.source,sink:e.sink},{source:e.source,sink:r.sink}]}var yd=!!__Process$?.env?.DUMP_SESSION_KEYS;function KP(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function T3(r){if(typeof r!="boolean")throw new Error(`boolean expected, not ${r}`)}function k3(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function an(r,...e){if(!KP(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function R9(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function zP(r,e){an(r);let t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function Ys(r){return new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4))}function Qs(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function IG(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}var TG=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function kG(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function P3(r){if(typeof r=="string")r=kG(r);else if(KP(r))r=R3(r);else throw new Error("Uint8Array expected, got "+typeof r);return r}function qP(r,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(r,e)}function jP(r,e){if(r.length!==e.length)return!1;let t=0;for(let n=0;n<r.length;n++)t|=r[n]^e[n];return t===0}var D9=(r,e)=>{function t(n,...o){if(an(n),!TG)throw new Error("Non little-endian hardware is not yet supported");if(r.nonceLength!==void 0){let u=o[0];if(!u)throw new Error("nonce / iv required");r.varSizeNonce?an(u):an(u,r.nonceLength)}let i=r.tagLength;i&&o[1]!==void 0&&an(o[1]);let s=e(n,...o),a=(u,f)=>{if(f!==void 0){if(u!==2)throw new Error("cipher output not supported");an(f)}},c=!1;return{encrypt(u,f){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,an(u),a(s.encrypt.length,f),s.encrypt(u,f)},decrypt(u,f){if(an(u),i&&u.length<i)throw new Error("invalid ciphertext length: smaller than tagLength="+i);return a(s.decrypt.length,f),s.decrypt(u,f)}}}return Object.assign(t,r),t};function N9(r,e,t=!0){if(e===void 0)return new Uint8Array(r);if(e.length!==r)throw new Error("invalid output length, expected "+r+", got: "+e.length);if(t&&!PG(e))throw new Error("invalid output, must be aligned");return e}function VP(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let o=BigInt(32),i=BigInt(4294967295),s=Number(t>>o&i),a=Number(t&i),c=n?4:0,l=n?0:4;r.setUint32(e+c,s,n),r.setUint32(e+l,a,n)}function WP(r,e,t){T3(t);let n=new Uint8Array(16),o=IG(n);return VP(o,0,BigInt(e),t),VP(o,8,BigInt(r),t),n}function PG(r){return r.byteOffset%4===0}function R3(r){return Uint8Array.from(r)}var XP=r=>Uint8Array.from(r.split("").map(e=>e.charCodeAt(0))),RG=XP("expand 16-byte k"),DG=XP("expand 32-byte k"),NG=Ys(RG),OG=Ys(DG);function le(r,e){return r<<e|r>>>32-e}function O9(r){return r.byteOffset%4===0}var D3=64,LG=16,YP=2**32-1,GP=new Uint32Array;function BG(r,e,t,n,o,i,s,a){let c=o.length,l=new Uint8Array(D3),u=Ys(l),f=O9(o)&&O9(i),h=f?Ys(o):GP,d=f?Ys(i):GP;for(let m=0;m<c;s++){if(r(e,t,n,u,s,a),s>=YP)throw new Error("arx: counter overflow");let g=Math.min(D3,c-m);if(f&&g===D3){let w=m/4;if(m%4!==0)throw new Error("arx: invalid block position");for(let x=0,v;x<LG;x++)v=w+x,d[v]=h[v]^u[x];m+=D3;continue}for(let w=0,x;w<g;w++)x=m+w,i[x]=o[x]^l[w];m+=g}}function L9(r,e){let{allowShortKeys:t,extendNonceFn:n,counterLength:o,counterRight:i,rounds:s}=qP({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof r!="function")throw new Error("core must be a function");return k3(o),k3(s),T3(i),T3(t),(a,c,l,u,f=0)=>{an(a),an(c),an(l);let h=l.length;if(u===void 0&&(u=new Uint8Array(h)),an(u),k3(f),f<0||f>=YP)throw new Error("arx: counter overflow");if(u.length<h)throw new Error(`arx: output (${u.length}) is shorter than data (${h})`);let d=[],m=a.length,g,w;if(m===32)d.push(g=R3(a)),w=OG;else if(m===16&&t)g=new Uint8Array(32),g.set(a),g.set(a,16),w=NG,d.push(g);else throw new Error(`arx: invalid 32-byte key, got length=${m}`);O9(c)||d.push(c=R3(c));let x=Ys(g);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(w,x,Ys(c.subarray(0,16)),x),c=c.subarray(16)}let v=16-o;if(v!==c.length)throw new Error(`arx: nonce must be ${v} or 16 bytes`);if(v!==12){let S=new Uint8Array(12);S.set(c,i?0:12-c.length),c=S,d.push(c)}let A=Ys(c);return BG(r,w,x,A,l,u,f,s),Qs(...d),u}}var Ur=(r,e)=>r[e++]&255|(r[e++]&255)<<8,B9=class{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=P3(e),an(e,32);let t=Ur(e,0),n=Ur(e,2),o=Ur(e,4),i=Ur(e,6),s=Ur(e,8),a=Ur(e,10),c=Ur(e,12),l=Ur(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|n<<3)&8191,this.r[2]=(n>>>10|o<<6)&7939,this.r[3]=(o>>>7|i<<9)&8191,this.r[4]=(i>>>4|s<<12)&255,this.r[5]=s>>>1&8190,this.r[6]=(s>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let u=0;u<8;u++)this.pad[u]=Ur(e,16+2*u)}process(e,t,n=!1){let o=n?0:2048,{h:i,r:s}=this,a=s[0],c=s[1],l=s[2],u=s[3],f=s[4],h=s[5],d=s[6],m=s[7],g=s[8],w=s[9],x=Ur(e,t+0),v=Ur(e,t+2),A=Ur(e,t+4),S=Ur(e,t+6),_=Ur(e,t+8),U=Ur(e,t+10),k=Ur(e,t+12),P=Ur(e,t+14),E=i[0]+(x&8191),D=i[1]+((x>>>13|v<<3)&8191),C=i[2]+((v>>>10|A<<6)&8191),R=i[3]+((A>>>7|S<<9)&8191),T=i[4]+((S>>>4|_<<12)&8191),V=i[5]+(_>>>1&8191),F=i[6]+((_>>>14|U<<2)&8191),H=i[7]+((U>>>11|k<<5)&8191),Y=i[8]+((k>>>8|P<<8)&8191),Q=i[9]+(P>>>5|o),X=0,me=X+E*a+D*(5*w)+C*(5*g)+R*(5*m)+T*(5*d);X=me>>>13,me&=8191,me+=V*(5*h)+F*(5*f)+H*(5*u)+Y*(5*l)+Q*(5*c),X+=me>>>13,me&=8191;let oe=X+E*c+D*a+C*(5*w)+R*(5*g)+T*(5*m);X=oe>>>13,oe&=8191,oe+=V*(5*d)+F*(5*h)+H*(5*f)+Y*(5*u)+Q*(5*l),X+=oe>>>13,oe&=8191;let G=X+E*l+D*c+C*a+R*(5*w)+T*(5*g);X=G>>>13,G&=8191,G+=V*(5*m)+F*(5*d)+H*(5*h)+Y*(5*f)+Q*(5*u),X+=G>>>13,G&=8191;let Te=X+E*u+D*l+C*c+R*a+T*(5*w);X=Te>>>13,Te&=8191,Te+=V*(5*g)+F*(5*m)+H*(5*d)+Y*(5*h)+Q*(5*f),X+=Te>>>13,Te&=8191;let et=X+E*f+D*u+C*l+R*c+T*a;X=et>>>13,et&=8191,et+=V*(5*w)+F*(5*g)+H*(5*m)+Y*(5*d)+Q*(5*h),X+=et>>>13,et&=8191;let ue=X+E*h+D*f+C*u+R*l+T*c;X=ue>>>13,ue&=8191,ue+=V*a+F*(5*w)+H*(5*g)+Y*(5*m)+Q*(5*d),X+=ue>>>13,ue&=8191;let it=X+E*d+D*h+C*f+R*u+T*l;X=it>>>13,it&=8191,it+=V*c+F*a+H*(5*w)+Y*(5*g)+Q*(5*m),X+=it>>>13,it&=8191;let rr=X+E*m+D*d+C*h+R*f+T*u;X=rr>>>13,rr&=8191,rr+=V*l+F*c+H*a+Y*(5*w)+Q*(5*g),X+=rr>>>13,rr&=8191;let Bt=X+E*g+D*m+C*d+R*h+T*f;X=Bt>>>13,Bt&=8191,Bt+=V*u+F*l+H*c+Y*a+Q*(5*w),X+=Bt>>>13,Bt&=8191;let Mt=X+E*w+D*g+C*m+R*d+T*h;X=Mt>>>13,Mt&=8191,Mt+=V*f+F*u+H*l+Y*c+Q*a,X+=Mt>>>13,Mt&=8191,X=(X<<2)+X|0,X=X+me|0,me=X&8191,X=X>>>13,oe+=X,i[0]=me,i[1]=oe,i[2]=G,i[3]=Te,i[4]=et,i[5]=ue,i[6]=it,i[7]=rr,i[8]=Bt,i[9]=Mt}finalize(){let{h:e,pad:t}=this,n=new Uint16Array(10),o=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=o,o=e[a]>>>13,e[a]&=8191;e[0]+=o*5,o=e[0]>>>13,e[0]&=8191,e[1]+=o,o=e[1]>>>13,e[1]&=8191,e[2]+=o,n[0]=e[0]+5,o=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=e[a]+o,o=n[a]>>>13,n[a]&=8191;n[9]-=8192;let i=(o^1)-1;for(let a=0;a<10;a++)n[a]&=i;i=~i;for(let a=0;a<10;a++)e[a]=e[a]&i|n[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let s=e[0]+t[0];e[0]=s&65535;for(let a=1;a<8;a++)s=(e[a]+t[a]|0)+(s>>>16)|0,e[a]=s&65535;Qs(n)}update(e){R9(this),e=P3(e),an(e);let{buffer:t,blockLen:n}=this,o=e.length;for(let i=0;i<o;){let s=Math.min(n-this.pos,o-i);if(s===n){for(;n<=o-i;i+=n)this.process(e,i);continue}t.set(e.subarray(i,i+s),this.pos),this.pos+=s,i+=s,this.pos===n&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){Qs(this.h,this.r,this.buffer,this.pad)}digestInto(e){R9(this),zP(e,this),this.finished=!0;let{buffer:t,h:n}=this,{pos:o}=this;if(o){for(t[o++]=1;o<16;o++)t[o]=0;this.process(t,0,!0)}this.finalize();let i=0;for(let s=0;s<8;s++)e[i++]=n[s]>>>0,e[i++]=n[s]>>>8;return e}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}};function MG(r){let e=(n,o)=>r(o).update(P3(n)).digest(),t=r(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=n=>r(n),e}var QP=MG(r=>new B9(r));function eR(r,e,t,n,o,i=20){let s=r[0],a=r[1],c=r[2],l=r[3],u=e[0],f=e[1],h=e[2],d=e[3],m=e[4],g=e[5],w=e[6],x=e[7],v=o,A=t[0],S=t[1],_=t[2],U=s,k=a,P=c,E=l,D=u,C=f,R=h,T=d,V=m,F=g,H=w,Y=x,Q=v,X=A,me=S,oe=_;for(let Te=0;Te<i;Te+=2)U=U+D|0,Q=le(Q^U,16),V=V+Q|0,D=le(D^V,12),U=U+D|0,Q=le(Q^U,8),V=V+Q|0,D=le(D^V,7),k=k+C|0,X=le(X^k,16),F=F+X|0,C=le(C^F,12),k=k+C|0,X=le(X^k,8),F=F+X|0,C=le(C^F,7),P=P+R|0,me=le(me^P,16),H=H+me|0,R=le(R^H,12),P=P+R|0,me=le(me^P,8),H=H+me|0,R=le(R^H,7),E=E+T|0,oe=le(oe^E,16),Y=Y+oe|0,T=le(T^Y,12),E=E+T|0,oe=le(oe^E,8),Y=Y+oe|0,T=le(T^Y,7),U=U+C|0,oe=le(oe^U,16),H=H+oe|0,C=le(C^H,12),U=U+C|0,oe=le(oe^U,8),H=H+oe|0,C=le(C^H,7),k=k+R|0,Q=le(Q^k,16),Y=Y+Q|0,R=le(R^Y,12),k=k+R|0,Q=le(Q^k,8),Y=Y+Q|0,R=le(R^Y,7),P=P+T|0,X=le(X^P,16),V=V+X|0,T=le(T^V,12),P=P+T|0,X=le(X^P,8),V=V+X|0,T=le(T^V,7),E=E+D|0,me=le(me^E,16),F=F+me|0,D=le(D^F,12),E=E+D|0,me=le(me^E,8),F=F+me|0,D=le(D^F,7);let G=0;n[G++]=s+U|0,n[G++]=a+k|0,n[G++]=c+P|0,n[G++]=l+E|0,n[G++]=u+D|0,n[G++]=f+C|0,n[G++]=h+R|0,n[G++]=d+T|0,n[G++]=m+V|0,n[G++]=g+F|0,n[G++]=w+H|0,n[G++]=x+Y|0,n[G++]=v+Q|0,n[G++]=A+X|0,n[G++]=S+me|0,n[G++]=_+oe|0}function UG(r,e,t,n){let o=r[0],i=r[1],s=r[2],a=r[3],c=e[0],l=e[1],u=e[2],f=e[3],h=e[4],d=e[5],m=e[6],g=e[7],w=t[0],x=t[1],v=t[2],A=t[3];for(let _=0;_<20;_+=2)o=o+c|0,w=le(w^o,16),h=h+w|0,c=le(c^h,12),o=o+c|0,w=le(w^o,8),h=h+w|0,c=le(c^h,7),i=i+l|0,x=le(x^i,16),d=d+x|0,l=le(l^d,12),i=i+l|0,x=le(x^i,8),d=d+x|0,l=le(l^d,7),s=s+u|0,v=le(v^s,16),m=m+v|0,u=le(u^m,12),s=s+u|0,v=le(v^s,8),m=m+v|0,u=le(u^m,7),a=a+f|0,A=le(A^a,16),g=g+A|0,f=le(f^g,12),a=a+f|0,A=le(A^a,8),g=g+A|0,f=le(f^g,7),o=o+l|0,A=le(A^o,16),m=m+A|0,l=le(l^m,12),o=o+l|0,A=le(A^o,8),m=m+A|0,l=le(l^m,7),i=i+u|0,w=le(w^i,16),g=g+w|0,u=le(u^g,12),i=i+u|0,w=le(w^i,8),g=g+w|0,u=le(u^g,7),s=s+f|0,x=le(x^s,16),h=h+x|0,f=le(f^h,12),s=s+f|0,x=le(x^s,8),h=h+x|0,f=le(f^h,7),a=a+c|0,v=le(v^a,16),d=d+v|0,c=le(c^d,12),a=a+c|0,v=le(v^a,8),d=d+v|0,c=le(c^d,7);let S=0;n[S++]=o,n[S++]=i,n[S++]=s,n[S++]=a,n[S++]=w,n[S++]=x,n[S++]=v,n[S++]=A}var FG=L9(eR,{counterRight:!1,counterLength:4,allowShortKeys:!1}),HG=L9(eR,{counterRight:!1,counterLength:8,extendNonceFn:UG,allowShortKeys:!1});var $G=new Uint8Array(16),ZP=(r,e)=>{r.update(e);let t=e.length%16;t&&r.update($G.subarray(t))},VG=new Uint8Array(32);function JP(r,e,t,n,o){let i=r(e,t,VG),s=QP.create(i);o&&ZP(s,o),ZP(s,n);let a=WP(n.length,o?o.length:0,!0);s.update(a);let c=s.digest();return Qs(i,a),c}var tR=r=>(e,t,n)=>({encrypt(i,s){let a=i.length;s=N9(a+16,s,!1),s.set(i);let c=s.subarray(0,-16);r(e,t,c,c,1);let l=JP(r,e,t,c,n);return s.set(l,a),Qs(l),s},decrypt(i,s){s=N9(i.length-16,s,!1);let a=i.subarray(0,-16),c=i.subarray(-16),l=JP(r,e,t,a,n);if(!jP(c,l))throw new Error("invalid tag");return s.set(i.subarray(0,-16)),r(e,t,s,s,1),Qs(l),s}}),M9=D9({blockSize:64,nonceLength:12,tagLength:16},tR(FG)),D7e=D9({blockSize:64,nonceLength:24,tagLength:16},tR(HG));function nR(r,e,t){return jc(r),t===void 0&&(t=new Uint8Array(r.outputLen)),Ia(r,Aa(t),Aa(e))}var U9=Uint8Array.from([0]),rR=Uint8Array.of();function oR(r,e,t,n=32){jc(r),Jo(n);let o=r.outputLen;if(n>255*o)throw new Error("Length should be <= 255*HashLen");let i=Math.ceil(n/o);t===void 0&&(t=rR);let s=new Uint8Array(i*o),a=Ia.create(r,e),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let u=0;u<i;u++)U9[0]=u+1,c.update(u===0?rR:l).update(t).update(U9).digestInto(l),s.set(l,o*u),a._cloneInto(c);return a.destroy(),c.destroy(),Zr(l,U9),s.slice(0,n)}var F9={hashSHA256(r){return Ki(r.subarray())},getHKDF(r,e){let t=nR(Ki,e,r),o=oR(Ki,t,void 0,96),i=o.subarray(0,32),s=o.subarray(32,64),a=o.subarray(64,96);return[i,s,a]},generateX25519KeyPair(){let r=tp.utils.randomPrivateKey();return{publicKey:tp.getPublicKey(r),privateKey:r}},generateX25519KeyPairFromSeed(r){return{publicKey:tp.getPublicKey(r),privateKey:r}},generateX25519SharedKey(r,e){return tp.getSharedSecret(r.subarray(),e.subarray())},chaCha20Poly1305Encrypt(r,e,t,n){return M9(n,e,t).encrypt(r.subarray())},chaCha20Poly1305Decrypt(r,e,t,n,o){return M9(n,e,t).decrypt(r.subarray(),o)}};var iR=F9;function sR(r){return{generateKeypair:r.generateX25519KeyPair,dh:(e,t)=>r.generateX25519SharedKey(e.privateKey,t).subarray(0,32),encrypt:r.chaCha20Poly1305Encrypt,decrypt:r.chaCha20Poly1305Decrypt,hash:r.hashSHA256,hkdf:r.getHKDF}}var wd=r=>{let e=Ot(2);return e[0]=r>>8,e[1]=r,e};wd.bytes=2;var Tm=r=>{if(r.length<2)throw RangeError("Could not decode int16BE");if(r instanceof Uint8Array){let e=0;return e+=r[0]<<8,e+=r[1],e}return r.getUint16(0)};Tm.bytes=2;function aR(r){return{xxHandshakeSuccesses:r.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:r.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:r.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:r.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:r.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function H9(r,e){!e.enabled||!yd||(r?(e(`LOCAL_STATIC_PUBLIC_KEY ${K(r.publicKey,"hex")}`),e(`LOCAL_STATIC_PRIVATE_KEY ${K(r.privateKey,"hex")}`)):e("Missing local static keys."))}function $9(r,e){!e.enabled||!yd||(r?(e(`LOCAL_PUBLIC_EPHEMERAL_KEY ${K(r.publicKey,"hex")}`),e(`LOCAL_PRIVATE_EPHEMERAL_KEY ${K(r.privateKey,"hex")}`)):e("Missing local ephemeral keys."))}function cR(r,e){!e.enabled||!yd||e(r?`REMOTE_STATIC_PUBLIC_KEY ${K(r.subarray(),"hex")}`:"Missing remote static public key.")}function V9(r,e){!e.enabled||!yd||e(r?`REMOTE_EPHEMERAL_PUBLIC_KEY ${K(r.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function K9(r,e,t){!t.enabled||!yd||(t(`CIPHER_STATE_1 ${r.n.getUint64()} ${r.k&&K(r.k,"hex")}`),t(`CIPHER_STATE_2 ${e.n.getUint64()} ${e.k&&K(e.k,"hex")}`))}function xi(r,e){if(r.length!==e.length)throw new Error("Inputs should have the same length");let t=Ot(r.length);for(let n=0;n<r.length;n++)t[n]=r[n]^e[n];return t}var xd=class r extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=r.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"};var zG=0,qG=4294967295,jG="Cipherstate has reached maximum n, a new handshake must be performed",N3=class{n;bytes;view;constructor(e=zG){this.n=e,this.bytes=Ie(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>qG)throw new Error(jG)}};var jl=Ie(0),bd=class{k;n;crypto;constructor(e,t=void 0,n=0){this.crypto=e,this.k=t,this.n=new N3(n)}hasKey(){return!!this.k}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();let n=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),n}decryptWithAd(e,t,n){if(!this.hasKey())return t;this.n.assertValue();let o=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,n);return this.n.increment(),o}},z9=class{cs;ck;h;crypto;constructor(e,t){this.crypto=e;let n=L(t,"utf-8");this.h=WG(e,n),this.ck=this.h,this.cs=new bd(e)}mixKey(e){let[t,n]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new bd(this.crypto,n)}mixHash(e){this.h=this.crypto.hash(new pe(this.h,e))}encryptAndHash(e){let t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){let t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){let[e,t]=this.crypto.hkdf(this.ck,jl);return[new bd(this.crypto,e),new bd(this.crypto,t)]}},q9=class{ss;s;e;rs;re;initiator;crypto;constructor(e){let{crypto:t,protocolName:n,prologue:o,initiator:i,s,e:a,rs:c,re:l}=e;this.crypto=t,this.ss=new z9(t,n),this.ss.mixHash(o),this.initiator=i,this.s=s,this.e=a,this.rs=c,this.re=l}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");let e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");let n=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+n)throw new Error("message is not long enough");let o=e.sublist(t,t+n);return this.rs=this.ss.decryptAndHash(o),n}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}},km=class extends q9{writeMessageA(e){return new pe(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){let t=this.writeE();this.writeEE();let n=this.writeS();return this.writeES(),new pe(t,n,this.ss.encryptAndHash(e))}writeMessageC(e){let t=this.writeS();return this.writeSE(),new pe(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(t){throw new xd(`handshake stage 0 validation fail: ${t.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();let t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(t){throw new xd(`handshake stage 1 validation fail: ${t.message}`)}}readMessageC(e){try{let t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(t){throw new xd(`handshake stage 2 validation fail: ${t.message}`)}}};function WG(r,e){if(e.length<=32){let t=Ie(32);return t.set(e),t}else return r.hash(e)}var O3;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.webtransportCerthashes!=null)for(let i of t.webtransportCerthashes)n.uint32(10),n.bytes(i);if(t.streamMuxers!=null)for(let i of t.streamMuxers)n.uint32(18),n.string(i);o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={webtransportCerthashes:[],streamMuxers:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{if(o.limits?.webtransportCerthashes!=null&&i.webtransportCerthashes.length===o.limits.webtransportCerthashes)throw new ft('Decode error - map field "webtransportCerthashes" had too many elements');i.webtransportCerthashes.push(t.bytes());break}case 2:{if(o.limits?.streamMuxers!=null&&i.streamMuxers.length===o.limits.streamMuxers)throw new ft('Decode error - map field "streamMuxers" had too many elements');i.streamMuxers.push(t.string());break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(O3||(O3={}));var Pm;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.identityKey!=null&&t.identityKey.byteLength>0&&(n.uint32(10),n.bytes(t.identityKey)),t.identitySig!=null&&t.identitySig.byteLength>0&&(n.uint32(18),n.bytes(t.identitySig)),t.extensions!=null&&(n.uint32(34),O3.codec().encode(t.extensions,n)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={identityKey:Ie(0),identitySig:Ie(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.identityKey=t.bytes();break}case 2:{i.identitySig=t.bytes();break}case 4:{i.extensions=O3.codec().decode(t,t.uint32(),{limits:o.limits?.extensions});break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(Pm||(Pm={}));async function j9(r,e,t){let n=await r.sign(lR(e));return Pm.encode({identityKey:sr(r.publicKey),identitySig:n,extensions:t})}async function W9(r,e,t){try{let n=Pm.decode(r),o=Qt(n.identityKey);if(t?.equals(o)===!1)throw new Error(`Payload identity key ${o} does not match expected remote identity key ${t}`);if(!e)throw new Error("Remote static does not exist");let i=lR(e);if(!await o.verify(i,n.identitySig))throw new Error("Invalid payload signature");return n}catch(n){throw new A0(n.message)}}function lR(r){let e=L("noise-libp2p-static-key:");return r instanceof Uint8Array?je([e,r],e.length+r.length):(r.prepend(e),r)}async function uR(r,e){let{log:t,connection:n,crypto:o,privateKey:i,prologue:s,s:a,remoteIdentityKey:c,extensions:l}=r,u=await j9(i,a.publicKey,l),f=new km({crypto:o,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:s,s:a});H9(f.s,t),t.trace("Stage 0 - Initiator starting to send first message."),await n.write(f.writeMessageA(jl),e),t.trace("Stage 0 - Initiator finished sending first message."),$9(f.e,t),t.trace("Stage 1 - Initiator waiting to receive first message from responder...");let h=f.readMessageB(await n.read(e));t.trace("Stage 1 - Initiator received the message."),V9(f.re,t),cR(f.rs,t),t.trace("Initiator going to check remote's signature...");let d=await W9(h,f.rs,c);t.trace("All good with the signature!"),t.trace("Stage 2 - Initiator sending third handshake message."),await n.write(f.writeMessageC(u),e),t.trace("Stage 2 - Initiator sent message with signed payload.");let[m,g]=f.ss.split();return K9(m,g,t),{payload:d,encrypt:w=>m.encryptWithAd(jl,w),decrypt:(w,x)=>g.decryptWithAd(jl,w,x)}}async function fR(r,e){let{log:t,connection:n,crypto:o,privateKey:i,prologue:s,s:a,remoteIdentityKey:c,extensions:l}=r,u=await j9(i,a.publicKey,l),f=new km({crypto:o,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:s,s:a});H9(f.s,t),t.trace("Stage 0 - Responder waiting to receive first message."),f.readMessageA(await n.read(e)),t.trace("Stage 0 - Responder received first message."),V9(f.re,t),t.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await n.write(f.writeMessageB(u),e),t.trace("Stage 1 - Responder sent the second handshake message with signed payload."),$9(f.e,t),t.trace("Stage 2 - Responder waiting for third handshake message...");let h=f.readMessageC(await n.read(e));t.trace("Stage 2 - Responder received the message, finished handshake.");let d=await W9(h,f.rs,c),[m,g]=f.ss.split();return K9(m,g,t),{payload:d,encrypt:w=>g.encryptWithAd(jl,w),decrypt:(w,x)=>m.decryptWithAd(jl,w,x)}}var hR=16;function pR(r,e){return async function*(t){for await(let n of t)for(let o=0;o<n.length;o+=65519){let i=o+65519;i>n.length&&(i=n.length);let s;n instanceof Uint8Array?s=r.encrypt(n.subarray(o,i)):s=r.encrypt(n.sublist(o,i)),e?.encryptedPackets.increment(),yield new pe(wd(s.byteLength),s)}}}function mR(r,e){return async function*(t){for await(let n of t)for(let o=0;o<n.length;o+=65535){let i=o+65535;if(i>n.length&&(i=n.length),i-hR<o)throw new Error("Invalid chunk");let s=n.sublist(o,i),a=n.subarray(o,i-hR);try{let c=r.decrypt(s,a);e?.decryptedPackets.increment(),yield c}catch(c){throw e?.decryptErrors.increment(),c}}}}var L3=class{protocol="/noise";crypto;prologue;staticKey;extensions;metrics;components;constructor(e,t={}){let{staticNoiseKey:n,extensions:o,crypto:i,prologueBytes:s}=t,{metrics:a}=e;this.components=e;let c=i??iR;this.crypto=sR(c),this.extensions={webtransportCerthashes:[],...o},this.metrics=a?aR(a):void 0,n?this.staticKey=c.generateX25519KeyPairFromSeed(n):this.staticKey=c.generateX25519KeyPair(),this.prologue=s??Ie(0)}[Symbol.toStringTag]="@chainsafe/libp2p-noise";[Ye]=["@libp2p/connection-encryption","@chainsafe/libp2p-noise"];async secureOutbound(e,t){let n=Qi(e,{lengthEncoder:wd,lengthDecoder:Tm,maxDataLength:65535}),o=await this.performHandshakeInitiator(n,this.components.privateKey,t?.remotePeer?.publicKey,t),i=await this.createSecureConnection(n,o);e.source=i.source,e.sink=i.sink;let s=Qt(o.payload.identityKey);return{conn:e,remoteExtensions:o.payload.extensions,remotePeer:zi(s),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(o.payload.extensions?.streamMuxers)}}getStreamMuxer(e){if(e==null||e.length===0)return;let t=this.components.upgrader.getStreamMuxers();if(t!=null)for(let n of e){let o=t.get(n);if(o!=null)return o}if(e.length)throw new E0("Early muxer negotiation was requested but the initiator and responder had no common muxers")}async secureInbound(e,t){let n=Qi(e,{lengthEncoder:wd,lengthDecoder:Tm,maxDataLength:65535}),o=await this.performHandshakeResponder(n,this.components.privateKey,t?.remotePeer?.publicKey,t),i=await this.createSecureConnection(n,o);e.source=i.source,e.sink=i.sink;let s=Qt(o.payload.identityKey);return{conn:e,remoteExtensions:o.payload.extensions,remotePeer:zi(s),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(o.payload.extensions?.streamMuxers)}}async performHandshakeInitiator(e,t,n,o){let i,s=o?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{i=await uR({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:s,webtransportCerthashes:[],...this.extensions}},o),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){throw this.metrics?.xxHandshakeErrors.increment(),a}return i}async performHandshakeResponder(e,t,n,o){let i,s=o?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{i=await fR({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:s,webtransportCerthashes:[],...this.extensions}},o),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){throw this.metrics?.xxHandshakeErrors.increment(),a}return i}async createSecureConnection(e,t){let[n,o]=$P(),i=e.unwrap();return await pt(n,pR(t,this.metrics),i,s=>As(s,{lengthDecoder:Tm}),mR(t,this.metrics),n),o}};function B3(r={}){return e=>new L3(e,r)}function vd(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}var bi=class extends Error{static name="InvalidFrameError";constructor(e="The frame was invalid"){super(e),this.name="InvalidFrameError"}},Ad=class extends Error{static name="UnrequestedPingError";constructor(e="Unrequested ping error"){super(e),this.name="UnrequestedPingError"}},Ed=class extends Error{static name="NotMatchingPingError";constructor(e="Unrequested ping error"){super(e),this.name="NotMatchingPingError"}},M3=class extends Error{static name="InvalidStateError";constructor(e="Invalid state"){super(e),this.name="InvalidStateError"}},U3=class extends Error{static name="StreamAlreadyExistsError";constructor(e="Strean already exists"){super(e),this.name="StreamAlreadyExistsError"}},F3=class extends Error{static name="DecodeInvalidVersionError";constructor(e="Decode invalid version"){super(e),this.name="DecodeInvalidVersionError"}},H3=class extends Error{static name="BothClientsError";constructor(e="Both clients"){super(e),this.name="BothClientsError"}},Sd=class extends Error{static name="ReceiveWindowExceededError";constructor(e="Receive window exceeded"){super(e),this.name="ReceiveWindowExceededError"}};var gR=new Set([bi.name,Ad.name,Ed.name,U3.name,F3.name,H3.name,Sd.name]),Dm=256*1024,yR=16*1024*1024;var wR={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:Dm,maxStreamWindowSize:yR,maxMessageSize:64*1024};function xR(r){if(r.keepAliveInterval<=0)throw new $("keep-alive interval must be positive");if(r.maxInboundStreams<0)throw new $("max inbound streams must be larger or equal 0");if(r.maxOutboundStreams<0)throw new $("max outbound streams must be larger or equal 0");if(r.initialStreamWindowSize<Dm)throw new $("InitialStreamWindowSize must be larger or equal 256 kB");if(r.maxStreamWindowSize<r.initialStreamWindowSize)throw new $("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(r.maxStreamWindowSize>2**32-1)throw new $("MaxStreamWindowSize must be less than equal MAX_UINT32");if(r.maxMessageSize<1024)throw new $("MaxMessageSize must be greater than a kilobyte")}var qt;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(qt||(qt={}));var kt;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(kt||(kt={}));var c9e=Object.values(kt).filter(r=>typeof r!="string"),bR=0,Lo;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(Lo||(Lo={}));var $a=12;var vR=2**24;function GG(r){if(r[0]!==bR)throw new bi("Invalid frame version");return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*vR+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*vR+(r[9]<<16)+(r[10]<<8)+r[11]}}var $3=class{source;buffer;frameInProgress;constructor(e){this.source=XG(e),this.buffer=new pe,this.frameInProgress=!1}async*emitFrames(){for await(let e of this.source)for(this.buffer.append(e);;){let t=this.readHeader();if(t===void 0)break;let{type:n,length:o}=t;n===qt.Data?(this.frameInProgress=!0,yield{header:t,readData:this.readBytes.bind(this,o)}):yield{header:t}}}readHeader(){if(this.frameInProgress)throw new M3("decoding frame already in progress");if(this.buffer.length<$a)return;let e=GG(this.buffer.subarray(0,$a));return this.buffer.consume($a),e}async readBytes(e){if(this.buffer.length<e){for await(let n of this.source)if(this.buffer.append(n),this.buffer.length>=e)break}let t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}};function XG(r){if(r[Symbol.iterator]!==void 0){let e=r[Symbol.iterator]();return e.return=void 0,{[Symbol.iterator](){return e}}}else if(r[Symbol.asyncIterator]!==void 0){let e=r[Symbol.asyncIterator]();return e.return=void 0,{[Symbol.asyncIterator](){return e}}}else throw new Error("a source must be either an iterable or an async iterable")}function G9(r){let e=new Uint8Array($a);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}function AR(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}function V3(r,e){let t=vd(r).return?.();AR(t)&&t.catch(n=>{e.error("could not cause iterator to return",n)})}var YG=5e3;function X9(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var Va=class{id;direction;timeline;protocol;metadata;source;status;readStatus;writeStatus;log;sinkController;sinkEnd;closed;endErr;streamSource;onEnd;onCloseRead;onCloseWrite;onReset;onAbort;sendCloseWriteTimeout;sendingData;constructor(e){this.sinkController=new AbortController,this.sinkEnd=ve(),this.closed=ve(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??YG,this.onEnd=e.onEnd,this.onCloseRead=e.onCloseRead,this.onCloseWrite=e.onCloseWrite,this.onReset=e.onReset,this.onAbort=e.onAbort,this.source=this.streamSource=nr({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new Nc(`writable end state is "${this.writeStatus}" not "ready"`);try{this.writeStatus="writing";let t={signal:this.sinkController.signal};if(this.direction==="outbound"){let o=this.sendNewStream(t);X9(o)&&await o}let n=()=>{V3(e,this.log)};try{this.sinkController.signal.addEventListener("abort",n),this.log.trace("sink reading from source");for await(let o of e){o=o instanceof Uint8Array?new pe(o):o;let i=this.sendData(o,t);X9(i)&&(this.sendingData=ve(),await i,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",n)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseRead?.(),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseWrite?.(),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.status==="open"&&(this.log.trace("closing gracefully"),this.status="closing",await ut(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e?.signal),this.status="closed",this.log.trace("closed gracefully"))}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);let t=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),t==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await ut(this.sink([]),e.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await ut(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await ut(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");let t=this.sendReset();X9(t)&&t.catch(n=>{this.log.error("error sending reset message",n)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;let e=new _0("stream reset");this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}};var Bo;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished"})(Bo||(Bo={}));var K3=class extends Va{name;state;config;_id;sendWindowCapacity;sendWindowCapacityUpdate;recvWindow;recvWindowCapacity;epochStart;getRTT;sendFrame;constructor(e){super({...e,onEnd:t=>{this.state=Bo.Finished,e.onEnd?.(t)}}),this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=Dm,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=dl(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(e,t={}){for(e=e.sublist();e.byteLength!==0;){if(this.sendWindowCapacity===0&&(this.log?.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(t),this.status==="closed"||this.status==="aborted"||this.status==="reset")){this.log?.trace("%s while waiting for send window capacity",this.status);return}let n=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-$a,e.length),o=this.getSendFlags();this.sendFrame({type:qt.Data,flag:o,streamID:this._id,length:n},e.sublist(0,n)),this.sendWindowCapacity-=n,e.consume(n)}}async sendReset(){this.sendFrame({type:qt.WindowUpdate,flag:kt.RST,streamID:this._id,length:0})}async sendCloseWrite(){let e=this.getSendFlags()|kt.FIN;this.sendFrame({type:qt.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){if(this.sendWindowCapacity>0)return;let t,n,o=()=>{this.status==="open"||this.status==="closing"?n(new Xe("Stream aborted")):t()};e.signal?.addEventListener("abort",o);try{await new Promise((i,s)=>{this.sendWindowCapacityUpdate=()=>{i()},n=s,t=i})}finally{e.signal?.removeEventListener("abort",o)}}handleWindowUpdate(e){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);let t=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,t===0&&e.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(e,t){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new Sd("Receive window exceeded");let n=await t();this.recvWindowCapacity-=e.length,this.sourcePush(n)}processFlags(e){(e&kt.ACK)===kt.ACK&&this.state===Bo.SYNSent&&(this.state=Bo.Established),(e&kt.FIN)===kt.FIN&&this.remoteCloseWrite(),(e&kt.RST)===kt.RST&&this.reset()}getSendFlags(){switch(this.state){case Bo.Init:return this.state=Bo.SYNSent,kt.SYN;case Bo.SYNReceived:return this.state=Bo.Established,kt.ACK;default:return 0}}sendWindowUpdate(){let e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(e===0&&n>-1&&t-this.epochStart<n*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;let o=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:qt.WindowUpdate,flag:e,streamID:this._id,length:o})}};var ER="/yamux/1.0.0",QG=500,z3=class{protocol=ER;_components;_init;constructor(e,t={}){this._components=e,this._init=t}[Symbol.toStringTag]="@chainsafe/libp2p-yamux";[Ye]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new Y9(this._components,{...this._init,...e})}},Y9=class{protocol=ER;source;sink;config;log;logger;closeController;nextStreamID;_streams;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;onIncomingStream;onStreamEnd;constructor(e,t){this.client=t.direction==="outbound",this.config={...wR,...t},this.logger=e.logger,this.log=this.logger.forComponent("libp2p:yamux"),xR(this.config),this.closeController=new AbortController,this.closeController.signal,this.onIncomingStream=t.onIncomingStream,this.onStreamEnd=t.onStreamEnd,this._streams=new Map,this.source=nr({onEnd:()=>{this.log?.trace("muxer source ended"),this._streams.forEach(n=>{n.destroy()})}}),this.sink=async n=>{let o=()=>{let a=vd(n);if(a.return!=null){let c=a.return();ZG(c)&&c.catch(l=>{this.log?.("could not cause sink source to return",l)})}},i,s;try{let a=new $3(n);try{this.closeController.signal.addEventListener("abort",o);for await(let c of a.emitFrames())await this.handleFrame(c.header,c.readData)}finally{this.closeController.signal.removeEventListener("abort",o)}i=Lo.NormalTermination}catch(a){gR.has(a.name)?(this.log?.error("protocol error in sink",a),i=Lo.ProtocolError):(this.log?.error("internal error in sink",a),i=Lo.InternalError),s=a}this.log?.trace("muxer sink ended"),s!=null?this.abort(s,i):await this.close({reason:i})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(n=>this.log?.error("keepalive error: %s",n)),this.ping().catch(n=>this.log?.error("ping error: %s",n))}get streams(){return Array.from(this._streams.values())}newStream(e){if(this.remoteGoAway!==void 0)throw new Li("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Li("Muxer closed locally");let t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new wa("max outbound streams exceeded");this.log?.trace("new outgoing stream id=%s",t);let n=this._newStream(t,e,Bo.Init,"outbound");return this._streams.set(t,n),this.numOutboundStreams++,n.sendWindowUpdate(),n}async ping(){if(this.remoteGoAway!==void 0)throw new Li("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Li("Muxer closed locally");if(this.activePing===void 0){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((o,i)=>{let s=()=>{i(new Li("Muxer closed locally"))};this.closeController.signal.addEventListener("abort",s,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",s),o()}}),resolve:e};let t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}let n=Date.now();this.rtt=n-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.closeController.signal.aborted)return;let t=e?.reason??Lo.NormalTermination;if(this.log?.trace("muxer close reason=%s",t),e.signal==null){let n=AbortSignal.timeout(QG);e={...e,signal:n}}try{await Promise.all([...this._streams.values()].map(async n=>n.close(e))),this.sendGoAway(t),this._closeMuxer()}catch(n){this.abort(n)}}abort(e,t){if(!this.closeController.signal.aborted){t=t??Lo.InternalError,this.log?.error("muxer abort reason=%s error=%s",t,e);for(let n of this._streams.values())n.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,n,o){if(this._streams.get(e)!=null)throw new $("Stream already exists with that id");let i=new K3({id:e.toString(),name:t,state:n,direction:o,sendFrame:this.sendFrame.bind(this),onEnd:()=>{this.closeStream(e),this.onStreamEnd?.(i)},log:this.logger.forComponent(`libp2p:yamux:${o}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return i}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){let e=new Promise((t,n)=>{this.closeController.signal.addEventListener("abort",n,{once:!0})});for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let t;try{await Promise.race([e,new Promise(n=>{t=setTimeout(n,this.config.keepAliveInterval)})]),this.ping().catch(n=>this.log?.error("ping error: %s",n))}catch{clearInterval(t);return}}}async handleFrame(e,t){let{streamID:n,type:o,length:i}=e;if(this.log?.trace("received frame %o",e),n===0)switch(o){case qt.Ping:{this.handlePing(e);return}case qt.GoAway:{this.handleGoAway(i);return}default:throw new bi("Invalid frame type")}else switch(e.type){case qt.Data:case qt.WindowUpdate:{await this.handleStreamMessage(e,t);return}default:throw new bi("Invalid frame type")}}handlePing(e){if(e.flag===kt.SYN)this.log?.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,kt.ACK);else if(e.flag===kt.ACK)this.log?.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new bi("Invalid frame flag")}handlePingResponse(e){if(this.activePing===void 0)throw new Ad("ping not requested");if(this.activePing.id!==e)throw new Ed("ping doesn't match our id");this.activePing.resolve()}handleGoAway(e){this.log?.trace("received GoAway reason=%s",Lo[e]??"unknown"),this.remoteGoAway=e;for(let t of this._streams.values())t.reset();this._closeMuxer()}async handleStreamMessage(e,t){let{streamID:n,flag:o,type:i}=e;(o&kt.SYN)===kt.SYN&&this.incomingStream(n);let s=this._streams.get(n);if(s===void 0){if(i===qt.Data){if(this.log?.("discarding data for stream id=%s",n),t===void 0)throw new Error("unreachable");await t()}else this.log?.trace("frame for missing stream id=%s",n);return}switch(i){case qt.WindowUpdate:{s.handleWindowUpdate(e);return}case qt.Data:{if(t===void 0)throw new Error("unreachable");await s.handleData(e,t);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new $("Both endpoints are clients");if(this._streams.has(e))return;if(this.log?.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:qt.WindowUpdate,flag:kt.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){this.log?.("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:qt.WindowUpdate,flag:kt.RST,streamID:e,length:0});return}let t=this._newStream(e,void 0,Bo.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),this.onIncomingStream?.(t)}sendFrame(e,t){if(this.log?.trace("sending frame %o",e),e.type===qt.Data){if(t===void 0)throw new bi("Invalid frame");this.source.push(new pe(G9(e),t))}else this.source.push(G9(e))}sendPing(e,t=kt.SYN){t===kt.SYN?this.log?.trace("sending ping request pingId=%s",e):this.log?.trace("sending ping response pingId=%s",e),this.sendFrame({type:qt.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=Lo.NormalTermination){this.log?.("sending GoAway reason=%s",Lo[e]),this.localGoAway=e,this.sendFrame({type:qt.GoAway,flag:0,streamID:0,length:e})}};function ZG(r){return r!=null&&typeof r.then=="function"}function SR(r={}){return e=>new z3(e,r)}function q3(r){try{for(let{code:e,value:t}of r.getComponents())if(t!=null&&e===41)return iT("2000::/3",t)}catch{}return!1}function _R(r,e,t){let n,o;function i(){let a={signal:o.signal};if(t?.timeout!=null){let c=ke([o.signal,AbortSignal.timeout(t.timeout)]);a.signal=c}Promise.resolve().then(async()=>{await r(a)}).catch(()=>{}).finally(()=>{o.signal.aborted||(n=setTimeout(i,e))})}let s=!1;return{setInterval:a=>{e!==a&&(e=a,n!=null&&(clearTimeout(n),n=setTimeout(i,e)))},setTimeout:a=>{t??={},t.timeout=a},start:()=>{s||(s=!0,o=new AbortController,o.signal,t?.runImmediately===!0?queueMicrotask(()=>{i()}):n=setTimeout(i,e))},stop:()=>{clearTimeout(n),o?.abort(),s=!1}}}function vt(r,e){let t=Qi(r,e),n={read:async(o,i)=>{let s=await t.read(i);return o.decode(s)},write:async(o,i,s)=>{await t.write(i.encode(o),s)},writeV:async(o,i,s)=>{await t.writeV(o.map(a=>i.encode(a)),s)},pb:o=>({read:async i=>n.read(o,i),write:async(i,s)=>n.write(i,o,s),writeV:async(i,s)=>n.writeV(i,o,s),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}var CR="libp2p",IR="autonat",TR="1.0.0";var _t;(function(r){let e;(function(l){l.DIAL="DIAL",l.DIAL_RESPONSE="DIAL_RESPONSE"})(e=r.MessageType||(r.MessageType={}));let t;(function(l){l[l.DIAL=0]="DIAL",l[l.DIAL_RESPONSE=1]="DIAL_RESPONSE"})(t||(t={})),function(l){l.codec=()=>wt(t)}(e=r.MessageType||(r.MessageType={}));let n;(function(l){l.OK="OK",l.E_DIAL_ERROR="E_DIAL_ERROR",l.E_DIAL_REFUSED="E_DIAL_REFUSED",l.E_BAD_REQUEST="E_BAD_REQUEST",l.E_INTERNAL_ERROR="E_INTERNAL_ERROR"})(n=r.ResponseStatus||(r.ResponseStatus={}));let o;(function(l){l[l.OK=0]="OK",l[l.E_DIAL_ERROR=100]="E_DIAL_ERROR",l[l.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",l[l.E_BAD_REQUEST=200]="E_BAD_REQUEST",l[l.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"})(o||(o={})),function(l){l.codec=()=>wt(o)}(n=r.ResponseStatus||(r.ResponseStatus={}));let i;(function(l){let u;l.codec=()=>(u==null&&(u=be((f,h,d={})=>{if(d.lengthDelimited!==!1&&h.fork(),f.id!=null&&(h.uint32(10),h.bytes(f.id)),f.addrs!=null)for(let m of f.addrs)h.uint32(18),h.bytes(m);d.lengthDelimited!==!1&&h.ldelim()},(f,h,d={})=>{let m={addrs:[]},g=h==null?f.len:f.pos+h;for(;f.pos<g;){let w=f.uint32();switch(w>>>3){case 1:{m.id=f.bytes();break}case 2:{if(d.limits?.addrs!=null&&m.addrs.length===d.limits.addrs)throw new ft('Decode error - map field "addrs" had too many elements');m.addrs.push(f.bytes());break}default:{f.skipType(w&7);break}}}return m})),u),l.encode=f=>xe(f,l.codec()),l.decode=(f,h)=>we(f,l.codec(),h)})(i=r.PeerInfo||(r.PeerInfo={}));let s;(function(l){let u;l.codec=()=>(u==null&&(u=be((f,h,d={})=>{d.lengthDelimited!==!1&&h.fork(),f.peer!=null&&(h.uint32(10),r.PeerInfo.codec().encode(f.peer,h)),d.lengthDelimited!==!1&&h.ldelim()},(f,h,d={})=>{let m={},g=h==null?f.len:f.pos+h;for(;f.pos<g;){let w=f.uint32();switch(w>>>3){case 1:{m.peer=r.PeerInfo.codec().decode(f,f.uint32(),{limits:d.limits?.peer});break}default:{f.skipType(w&7);break}}}return m})),u),l.encode=f=>xe(f,l.codec()),l.decode=(f,h)=>we(f,l.codec(),h)})(s=r.Dial||(r.Dial={}));let a;(function(l){let u;l.codec=()=>(u==null&&(u=be((f,h,d={})=>{d.lengthDelimited!==!1&&h.fork(),f.status!=null&&(h.uint32(8),r.ResponseStatus.codec().encode(f.status,h)),f.statusText!=null&&(h.uint32(18),h.string(f.statusText)),f.addr!=null&&(h.uint32(26),h.bytes(f.addr)),d.lengthDelimited!==!1&&h.ldelim()},(f,h,d={})=>{let m={},g=h==null?f.len:f.pos+h;for(;f.pos<g;){let w=f.uint32();switch(w>>>3){case 1:{m.status=r.ResponseStatus.codec().decode(f);break}case 2:{m.statusText=f.string();break}case 3:{m.addr=f.bytes();break}default:{f.skipType(w&7);break}}}return m})),u),l.encode=f=>xe(f,l.codec()),l.decode=(f,h)=>we(f,l.codec(),h)})(a=r.DialResponse||(r.DialResponse={}));let c;r.codec=()=>(c==null&&(c=be((l,u,f={})=>{f.lengthDelimited!==!1&&u.fork(),l.type!=null&&(u.uint32(8),r.MessageType.codec().encode(l.type,u)),l.dial!=null&&(u.uint32(18),r.Dial.codec().encode(l.dial,u)),l.dialResponse!=null&&(u.uint32(26),r.DialResponse.codec().encode(l.dialResponse,u)),f.lengthDelimited!==!1&&u.ldelim()},(l,u,f={})=>{let h={},d=u==null?l.len:l.pos+u;for(;l.pos<d;){let m=l.uint32();switch(m>>>3){case 1:{h.type=r.MessageType.codec().decode(l);break}case 2:{h.dial=r.Dial.codec().decode(l,l.uint32(),{limits:f.limits?.dial});break}case 3:{h.dialResponse=r.DialResponse.codec().decode(l,l.uint32(),{limits:f.limits?.dialResponse});break}default:{l.skipType(m&7);break}}}return h})),c),r.encode=l=>xe(l,r.codec()),r.decode=(l,u)=>we(l,r.codec(),u)})(_t||(_t={}));var oX=4,iX=8,j3=class{components;protocol;timeout;maxInboundStreams;maxOutboundStreams;maxMessageSize;started;log;topologyId;dialResults;findPeers;addressFilter;connectionThreshold;constructor(e,t){this.components=e,this.log=e.logger.forComponent("libp2p:auto-nat"),this.started=!1,this.protocol=`/${t.protocolPrefix??CR}/${IR}/${TR}`,this.timeout=t.timeout??3e4,this.maxInboundStreams=t.maxInboundStreams??2,this.maxOutboundStreams=t.maxOutboundStreams??20,this.connectionThreshold=t.connectionThreshold??80,this.maxMessageSize=t.maxMessageSize??8192,this.dialResults=lr({name:"libp2p_autonat_dial_results",metrics:e.metrics}),this.findPeers=_R(this.findRandomPeers.bind(this),6e4),this.addressFilter=en(1024)}[Symbol.toStringTag]="@libp2p/autonat";[Ye]=["@libp2p/autonat"];get[Qn](){return["@libp2p/identify"]}isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,e=>{this.handleIncomingAutonatStream(e).catch(t=>{this.log.error("error handling incoming autonat stream - %e",t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.topologyId=await this.components.registrar.register(this.protocol,{onConnect:(e,t)=>{this.verifyExternalAddresses(t).catch(n=>{this.log.error("could not verify addresses - %e",n)})}}),this.findPeers.start(),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.topologyId!=null&&await this.components.registrar.unhandle(this.topologyId),this.dialResults.clear(),this.findPeers.stop(),this.started=!1}allAddressesAreVerified(){return this.components.addressManager.getAddressesWithMetadata().every(e=>e.expires>Date.now()?!0:e.verified)}async findRandomPeers(e){if(this.allAddressesAreVerified())return;let t=ke([AbortSignal.timeout(1e4),e?.signal]);try{this.log("starting random walk to find peers to run AutoNAT");for await(let n of this.components.randomWalk.walk({signal:t})){if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable %s",n.id,n.multiaddrs.map(o=>o.toString()).join(", "));continue}try{this.log.trace("dial random peer %p",n.id),await this.components.connectionManager.openConnection(n.multiaddrs,{signal:t})}catch{}if(this.allAddressesAreVerified()){this.log("stopping random walk, all addresses are verified");return}if(!this.hasConnectionCapacity()){this.log("stopping random walk, too close to max connections");return}}}catch{}}async handleIncomingAutonatStream(e){let t=AbortSignal.timeout(this.timeout);let n=vt(e.stream,{maxDataLength:this.maxMessageSize}).pb(_t);try{let o=await n.read({signal:t}),i=await this.handleAutonatMessage(o,e.connection,{signal:t});await n.write(i,{signal:t}),await n.unwrap().unwrap().close({signal:t})}catch(o){this.log.error("error handling incoming autonat stream - %e",o),e.stream.abort(o)}}async handleAutonatMessage(e,t,n){let o=this.components.addressManager.getAddresses().map(f=>f.toOptions().host),i=e.dial;if(i==null)return this.log.error("dial was missing from message"),{type:_t.MessageType.DIAL_RESPONSE,dialResponse:{status:_t.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}};let s,a=i.peer;if(a?.id==null)return this.log.error("PeerId missing from message"),{type:_t.MessageType.DIAL_RESPONSE,dialResponse:{status:_t.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}};try{let f=ze(a.id);s=cr(f)}catch(f){return this.log.error("invalid PeerId - %e",f),{type:_t.MessageType.DIAL_RESPONSE,dialResponse:{status:_t.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}}}if(this.log("incoming request from %p",s),!t.remotePeer.equals(s))return this.log("target peer %p did not equal sending peer %p",s,t.remotePeer),{type:_t.MessageType.DIAL_RESPONSE,dialResponse:{status:_t.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}};let c=a.addrs.map(f=>ne(f)).filter(f=>{let h=f.toOptions();return No(f)?!1:h.host!==t.remoteAddr.toOptions().host?(this.log.trace("not dialing %a - target host did not match remote host %a",f,t.remoteAddr),!1):o.includes(h.host)?!1:this.components.transportManager.dialTransportForMultiaddr(f)==null?(this.log.trace("not dialing %a - transport unsupported",f),!1):!0}).map(f=>(f.getPeerId()==null&&(f=f.encapsulate(`/p2p/${s.toString()}`)),f));if(c.length===0)return this.log("refused to dial all multiaddrs for %p from message",s),{type:_t.MessageType.DIAL_RESPONSE,dialResponse:{status:_t.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}};this.log("dial multiaddrs %s for peer %p",c.map(f=>f.toString()).join(", "),s);let l="",u=c[0];for(let f of c){let h;u=f;try{if(h=await this.components.connectionManager.openConnection(f,n),!h.remoteAddr.equals(f))throw this.log.error("tried to dial %a but dialed %a",f,h.remoteAddr),new Error("Unexpected remote address");return this.log("successfully dialed %p via %a",s,f),{type:_t.MessageType.DIAL_RESPONSE,dialResponse:{status:_t.ResponseStatus.OK,addr:h.remoteAddr.decapsulateCode(It("p2p").code).bytes}}}catch(d){this.log.error("could not dial %p - %e",s,d),l=d.message}finally{h!=null&&await h.close()}}return{type:_t.MessageType.DIAL_RESPONSE,dialResponse:{status:_t.ResponseStatus.E_DIAL_ERROR,statusText:l,addr:u.bytes}}}getFirstUnverifiedMultiaddr(e,t){let n=this.components.addressManager.getAddressesWithMetadata().sort((o,i)=>o.type==="observed"&&i.type!=="observed"?1:i.type==="observed"&&o.type!=="observed"?-1:0).filter(o=>!(!(o.expires<Date.now())||o.multiaddr.toOptions().family===6&&(!t||!q3(o.multiaddr))||No(o.multiaddr)));for(let o of n){let i=o.multiaddr.toString(),s=this.dialResults.get(i);if(s!=null){if(s.networkSegments.includes(e)){this.log.trace("%a already has a network segment result from %s",s.multiaddr,e);continue}if(s.queue.size>10){this.log.trace("%a already has enough peers queued",s.multiaddr);continue}}if(s==null){let a=o.expires<Date.now();if(a&&this.addressFilter.remove?.(i),this.addressFilter.has(i))continue;this.addressFilter.add(i),this.log.trace("creating dial result %s %s",a?"to revalidate":"for",i),s={multiaddr:o.multiaddr,success:0,failure:0,networkSegments:[],verifyingPeers:y7(),queue:new Cr({concurrency:3,maxSize:50}),type:o.type,lastVerified:o.lastVerified},this.dialResults.set(i,s)}return s}}removeOutdatedMultiaddrResults(){let e=new Set(this.components.addressManager.getAddressesWithMetadata().filter(({expires:t})=>t<Date.now()).map(({multiaddr:t})=>t.toString()));for(let t of this.dialResults.keys())e.has(t)||(this.log.trace("remove results for %a",t),this.dialResults.delete(t))}async verifyExternalAddresses(e){if(!this.isStarted())return;this.removeOutdatedMultiaddrResults();let n=(await this.components.peerStore.get(e.remotePeer)).addresses.some(({multiaddr:s})=>s.toOptions().family===6),o=this.getNetworkSegment(e.remoteAddr),i=this.getFirstUnverifiedMultiaddr(o,n);if(i==null){this.log.trace("no unverified public addresses found for peer %p to verify, not requesting verification",e.remotePeer);return}if(!this.hasConnectionCapacity()){i.lastVerified!=null?(this.log("automatically re-verifying %a because we are too close to the connection limit",i.multiaddr),this.confirmAddress(i)):this.log("skipping verifying %a because we are too close to the connection limit",i.multiaddr);return}i.queue.add(async s=>{await this.askPeerToVerify(e,o,s)},{peerId:e.remotePeer,multiaddr:i.multiaddr}).catch(s=>{i?.result==null&&this.log.error("error from %p verifying address %a - %e",e.remotePeer,i?.multiaddr,s)})}async askPeerToVerify(e,t,n){let o=this.dialResults.get(n.multiaddr.toString());if(o==null){this.log("%a was verified while %p was queued",n.multiaddr,e.remotePeer);return}let i=AbortSignal.timeout(this.timeout);this.log.trace("asking %p to verify multiaddr %s",e.remotePeer,n.multiaddr);let s=await e.newStream(this.protocol,{signal:i});try{let a=vt(s).pb(_t),[,c]=await Promise.all([a.write({type:_t.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toMultihash().bytes,addrs:[n.multiaddr.bytes]}}},{signal:i}),a.read({signal:i})]);if(c.type!==_t.MessageType.DIAL_RESPONSE||c.dialResponse==null){this.log("invalid autonat response from %p - %j",e.remotePeer,c);return}let l=c.dialResponse.status;if(this.log.trace("autonat response from %p for %a is %s",e.remotePeer,n.multiaddr,l),l!==_t.ResponseStatus.OK&&l!==_t.ResponseStatus.E_DIAL_ERROR)return;if(o=this.dialResults.get(n.multiaddr.toString()),o==null){this.log.trace("peer reported %a as %s but there is no result object",n.multiaddr,c.dialResponse.status);return}if(o.networkSegments.includes(t)){this.log.trace("%a results included network segment %s",n.multiaddr,t);return}if(o.result!=null){this.log.trace("already resolved result for %a, ignoring response from",n.multiaddr,e.remotePeer);return}if(o.verifyingPeers.has(e.remotePeer)){this.log.trace("peer %p has already verified %a, ignoring response",e.remotePeer,n.multiaddr);return}if(o.verifyingPeers.add(e.remotePeer),o.networkSegments.push(t),l===_t.ResponseStatus.OK){if(o.success++,o.type!=="observed"){this.confirmAddress(o);return}}else l===_t.ResponseStatus.E_DIAL_ERROR&&o.failure++;this.log("%a success %d failure %d",o.multiaddr,o.success,o.failure),o.success===oX&&this.confirmAddress(o),o.failure===iX&&this.unconfirmAddress(o)}finally{try{await s.close({signal:i})}catch(a){s.abort(a)}}}hasConnectionCapacity(){let t=this.components.connectionManager.getConnections().length,n=this.components.connectionManager.getMaxConnections();return t/n*100<this.connectionThreshold}confirmAddress(e){this.log("%s address %a is externally dialable",e.type,e.multiaddr),this.components.addressManager.confirmObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!0,e.queue.abort()}unconfirmAddress(e){this.log("%s address %a is not externally dialable",e.type,e.multiaddr),this.components.addressManager.removeObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!1,e.queue.abort()}getNetworkSegment(e){let t=e.toOptions();return t.family===4?t.host.split(".")[0].padStart(3,"0"):t.host.split(":")[0].padStart(4,"0")}};function kR(r={}){return e=>new j3(e,r)}var sX=se("dns4"),aX=se("dns6"),cX=se("dnsaddr"),Gl=er(se("dns"),cX,sX,aX),X3=er(se("ip4"),se("ip6")),_d=er(Ce(X3,se("tcp")),Ce(Gl,se("tcp"))),Y3=Ce(X3,se("udp")),lX=Ce(Y3,se("utp")),uX=Ce(Y3,se("quic")),fX=Ce(Y3,se("quic-v1")),Q9=er(Ce(_d,se("ws")),Ce(Gl,se("ws"))),W3=er(Ce(Q9,se("p2p")),Q9),Z9=er(Ce(_d,se("wss")),Ce(Gl,se("wss")),Ce(_d,se("tls"),se("ws")),Ce(Gl,se("tls"),se("ws"))),G3=er(Ce(Z9,se("p2p")),Z9),J9=er(Ce(_d,se("http")),Ce(X3,se("http")),Ce(Gl,se("http"))),eb=er(Ce(_d,se("https")),Ce(X3,se("https")),Ce(Gl,se("https"))),PR=Ce(Y3,se("webrtc-direct"),se("certhash")),NR=er(Ce(PR,se("p2p")),PR),RR=Ce(fX,se("webtransport"),se("certhash"),se("certhash")),OR=er(Ce(RR,se("p2p")),RR),LR=er(Ce(W3,se("p2p-webrtc-star"),se("p2p")),Ce(G3,se("p2p-webrtc-star"),se("p2p")),Ce(W3,se("p2p-webrtc-star")),Ce(G3,se("p2p-webrtc-star"))),Ebe=er(Ce(W3,se("p2p-websocket-star"),se("p2p")),Ce(G3,se("p2p-websocket-star"),se("p2p")),Ce(W3,se("p2p-websocket-star")),Ce(G3,se("p2p-websocket-star"))),BR=er(Ce(J9,se("p2p-webrtc-direct"),se("p2p")),Ce(eb,se("p2p-webrtc-direct"),se("p2p")),Ce(J9,se("p2p-webrtc-direct")),Ce(eb,se("p2p-webrtc-direct"))),Xl=er(Q9,Z9,J9,eb,LR,BR,_d,lX,uX,Gl,NR,OR),Sbe=er(Ce(Xl,se("p2p-stardust"),se("p2p")),Ce(Xl,se("p2p-stardust"))),Ka=er(Ce(Xl,se("p2p")),LR,BR,NR,OR,se("p2p")),DR=er(Ce(Ka,se("p2p-circuit"),Ka),Ce(Ka,se("p2p-circuit")),Ce(se("p2p-circuit"),Ka),Ce(Xl,se("p2p-circuit")),Ce(se("p2p-circuit"),Xl),se("p2p-circuit")),MR=()=>er(Ce(DR,MR),DR),Wl=MR(),UR=er(Ce(Wl,Ka,Wl),Ce(Ka,Wl),Ce(Wl,Ka),Wl,Ka);var _be=er(Ce(Wl,se("webrtc"),se("p2p")),Ce(Wl,se("webrtc")),Ce(Xl,se("webrtc"),se("p2p")),Ce(Xl,se("webrtc")),se("webrtc"));function FR(r){function e(t){let n;try{n=ne(t)}catch{return!1}let o=r(n.protoNames());return o===null?!1:o===!0||o===!1?o:o.length===0}return e}function Ce(...r){function e(t){if(t.length<r.length)return null;let n=t;return r.some(o=>(n=typeof o=="function"?o().partialMatch(t):o.partialMatch(t),Array.isArray(n)&&(t=n),n===null)),n}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:FR(e),partialMatch:e}}function er(...r){function e(n){let o=null;return r.some(i=>{let s=typeof i=="function"?i().partialMatch(n):i.partialMatch(n);return s!=null?(o=s,!0):!1}),o}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:FR(e),partialMatch:e}}function se(r){let e=r;function t(o){let i;try{i=ne(o)}catch{return!1}let s=i.protoNames();return s.length===1&&s[0]===e}function n(o){return o.length===0?null:o[0]===e?o.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:n}}var dX="bootstrap",hX=50,pX=1e3,tb=class extends Re{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??pX,this.list=[];for(let n of t.list){if(!UR.matches(n)){this.log.error("Invalid multiaddr");continue}let o=ne(n),i=o.getPeerId();if(i==null){this.log.error("Invalid bootstrap multiaddr without peer id");continue}let s={id:tt(i),multiaddrs:[o]};this.list.push(s)}this._init=t}[Rc]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[Ye]=["@libp2p/peer-discovery"];isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error(e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(let e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??dX]:{value:this._init.tagValue??hX,ttl:this._init.tagTTL}},multiaddrs:e.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e}),this.components.connectionManager.openConnection(e.id).catch(t=>{this.log.error("could not dial bootstrap peer %p",e.id,t)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}};function HR(r){return e=>new tb(e,r)}var rb=1e3,$R=60*rb,VR=290;var Obe=2*60*$R,KR=1,Q3=2e3,zR=100;var Nm=`${pa}-circuit-relay`,Lbe=`${pa}-circuit-relay-source`,Bbe=2*$R,Mbe=BigInt(1<<17),Yl="/libp2p/circuit/relay/0.2.0/hop",nb="/libp2p/circuit/relay/0.2.0/stop",Ube=30*rb,Fbe=30*rb,ob=300,qR=4096,jR=.001;var za;(function(r){let e;(function(o){o.RESERVE="RESERVE",o.CONNECT="CONNECT",o.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(o){o[o.RESERVE=0]="RESERVE",o[o.CONNECT=1]="CONNECT",o[o.STATUS=2]="STATUS"})(t||(t={})),function(o){o.codec=()=>wt(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=be((o,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),o.type!=null&&(i.uint32(8),r.Type.codec().encode(o.type,i)),o.peer!=null&&(i.uint32(18),Cd.codec().encode(o.peer,i)),o.reservation!=null&&(i.uint32(26),Z3.codec().encode(o.reservation,i)),o.limit!=null&&(i.uint32(34),Id.codec().encode(o.limit,i)),o.status!=null&&(i.uint32(40),Fr.codec().encode(o.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(o);break}case 2:{a.peer=Cd.codec().decode(o,o.uint32(),{limits:s.limits?.peer});break}case 3:{a.reservation=Z3.codec().decode(o,o.uint32(),{limits:s.limits?.reservation});break}case 4:{a.limit=Id.codec().decode(o,o.uint32(),{limits:s.limits?.limit});break}case 5:{a.status=Fr.codec().decode(o);break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>xe(o,r.codec()),r.decode=(o,i)=>we(o,r.codec(),i)})(za||(za={}));var Zi;(function(r){let e;(function(o){o.CONNECT="CONNECT",o.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(o){o[o.CONNECT=0]="CONNECT",o[o.STATUS=1]="STATUS"})(t||(t={})),function(o){o.codec=()=>wt(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=be((o,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),o.type!=null&&(i.uint32(8),r.Type.codec().encode(o.type,i)),o.peer!=null&&(i.uint32(18),Cd.codec().encode(o.peer,i)),o.limit!=null&&(i.uint32(26),Id.codec().encode(o.limit,i)),o.status!=null&&(i.uint32(32),Fr.codec().encode(o.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(o);break}case 2:{a.peer=Cd.codec().decode(o,o.uint32(),{limits:s.limits?.peer});break}case 3:{a.limit=Id.codec().decode(o,o.uint32(),{limits:s.limits?.limit});break}case 4:{a.status=Fr.codec().decode(o);break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>xe(o,r.codec()),r.decode=(o,i)=>we(o,r.codec(),i)})(Zi||(Zi={}));var Cd;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(let i of t.addrs)n.uint32(18),n.bytes(i);o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={id:Ie(0),addrs:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.id=t.bytes();break}case 2:{if(o.limits?.addrs!=null&&i.addrs.length===o.limits.addrs)throw new ft('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(Cd||(Cd={}));var Z3;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(let i of t.addrs)n.uint32(18),n.bytes(i);t.voucher!=null&&(n.uint32(26),e4.codec().encode(t.voucher,n)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={expire:0n,addrs:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.expire=t.uint64();break}case 2:{if(o.limits?.addrs!=null&&i.addrs.length===o.limits.addrs)throw new ft('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}case 3:{i.voucher=e4.codec().decode(t,t.uint32(),{limits:o.limits?.voucher});break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(Z3||(Z3={}));var Id;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.duration=t.uint32();break}case 2:{i.data=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(Id||(Id={}));var Fr;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(Fr||(Fr={}));var ib;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(ib||(ib={}));(function(r){r.codec=()=>wt(ib)})(Fr||(Fr={}));var J3;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={relay:Ie(0),peer:Ie(0),expiration:0n},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.relay=t.bytes();break}case 2:{i.peer=t.bytes();break}case 3:{i.expiration=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(J3||(J3={}));var e4;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&(n.uint32(26),J3.codec().encode(t.payload,n)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={publicKey:Ie(0),payloadType:Ie(0),signature:Ie(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=J3.codec().decode(t,t.uint32(),{limits:o.limits?.payload});break}case 5:{i.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(e4||(e4={}));var Om=class extends Error{static name="HadEnoughRelaysError";name="HadEnoughRelaysError"},t4=class extends Error{static name="DoubleRelayError";name="DoubleRelayError"},r4=class extends Error{static name="RelayQueueFullError";name="RelayQueueFullError"};function sb(r){let e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}var Lm=class{expires;bytes;constructor(e){e?.duration!=null&&e?.duration!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e?.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;let e={};if(this.bytes!=null){let t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){let t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}},n4=lt(Fe(H2.matchers[0],Ne("p2p-circuit"))),o4=lt(Ne("p2p-circuit"));function ab(r){let{stream:e,remoteAddr:t,logger:n,onDataRead:o,onDataWrite:i}=r,s=n.forComponent("libp2p:stream:converter"),a=!1,c=!1,l=e.close.bind(e);e.close=async m=>{await l(m),d(!0)};let u=e.abort.bind(e);e.abort=m=>{u(m),d(!0)};let f=e.sink.bind(e);e.sink=async m=>{try{await f(pt(m,g=>dl(g,w=>i?.(w))))}catch(g){g.type!=="aborted"&&s.error("%s error in sink",t,g)}finally{c=!0,d()}};let h={log:s,sink:e.sink,source:async function*(){try{for await(let m of e.source)o?.(m),yield m}finally{a=!0,d()}}(),remoteAddr:t,timeline:{open:Date.now(),close:void 0},close:e.close,abort:e.abort};function d(m){m===!0&&(a=!0,c=!0),a&&c&&h.timeline.close==null&&(h.timeline.close=Date.now())}return h}var i4=class extends Re{peerStore;registrar;connectionManager;randomWalk;started;running;topologyId;log;discoveryController;filter;queue;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.started=!1,this.running=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.connectionManager=e.connectionManager,this.randomWalk=e.randomWalk,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal}isStarted(){return this.started}async start(){this.topologyId=await this.registrar.register(Yl,{filter:this.filter,onConnect:e=>{this.log.trace("discovered relay %p queue (length: %d, active %d)",e,this.queue?.size,this.queue?.running),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.discoveryController?.abort(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,Promise.resolve().then(async()=>{this.log("searching peer store for relays");let e=await this.peerStore.all({filters:[n=>n.protocols.includes(Yl)],orders:[()=>Math.random()<.5?1:-1,(n,o)=>{let i=WR(n),s=WR(o);return i>s?-1:s>i?1:0}]});for(let n of e)this.log.trace("found relay peer %p in peer store",n.id),this.safeDispatchEvent("relay:discover",{detail:n.id});this.log("found %d relay peers in peer store",e.length);let t=this.queue=new Cr({concurrency:5});this.log("start random walk");for await(let n of this.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",n.id),t.has(n.id)){this.log.trace("random peer %p was already in queue",n.id);continue}if(this.connectionManager.getConnections(n.id)?.length>0){this.log.trace("random peer %p was already connected",n.id);continue}if(!await this.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable",n.id,n.multiaddrs.map(o=>o.toString()));continue}t.queued>10&&(this.log.trace("wait for space in queue for %p",n.id),await t.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",n.id,t.size,t.running),t.add(async()=>{let o=ke([this.discoveryController.signal,AbortSignal.timeout(5e3)]);try{await this.connectionManager.openConnection(n.id,{signal:o})}finally{o.clear()}},{peerId:n.id,signal:this.discoveryController.signal}).catch(o=>{this.log.error("error opening connection to random peer %p",n.id,o)})}this.log("stop random walk"),await t.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort()}};function WR(r){let e=r.metadata.get("last-dial-success");return e==null?0:new Date(K(e)).getTime()}var cb=class extends Re{connectionManager;addressManager;reservationStore;listeningAddrs;log;listenTimeout;reservationId;relay;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.addressManager=e.addressManager,this.reservationStore=e.reservationStore,this.listeningAddrs=[],this.listenTimeout=t.listenTimeout??Q3,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}_onRemoveRelayPeer=e=>{this.log("relay removed %p our relay %p",e.detail.relay,this.relay,this.relay?.equals(e.detail.relay)),this.relay?.equals(e.detail.relay)===!0&&(this.log("relay peer removed %p",e.detail.relay),this.listeningAddrs.forEach(t=>{this.addressManager.removeObservedAddr(t)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))};_onAddRelayPeer=e=>{let{details:t}=e.detail;t.type!=="configured"&&t.id===this.reservationId&&this.addedRelay(e.detail)};async listen(e){if(o4.exactMatch(e))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(n4.exactMatch(e)){this.log("listen on specific relay server %a",e);let t=AbortSignal.timeout(this.listenTimeout);let n=e.decapsulate("/p2p-circuit"),o=await this.connectionManager.openConnection(n,{signal:t});if(!this.reservationStore.hasReservation(o.remotePeer)){this.log("making reservation on peer %p",o.remotePeer);let i=await this.reservationStore.addRelay(o.remotePeer,"configured");this.addedRelay(i)}}else throw new Oc(`Could not listen on p2p-circuit address "${e}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(e){this.log("relay peer added %p",e.relay),this.relay=e.relay,this.listeningAddrs=e.details.reservation.addrs.map(t=>ne(t).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(t=>{this.addressManager.confirmObservedAddr(t,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}};function GR(r){return new cb(r)}var XR="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var YR=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r|=0));for(;r--;)e+=XR[t[r]&63];return e};var mX=60*1e3*10,gX=60*1e3*5,yX=30*1e3,s4=class extends Re{peerId;connectionManager;peerStore;events;reserveQueue;reservations;pendingReservations;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new Jr,this.pendingReservations=[],this.maxReservationQueueLength=t?.maxReservationQueueLength??zR,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??Q3,this.started=!1,this.relayFilter=en(100),this.reserveQueue=new Cr({concurrency:t?.reservationConcurrency??KR,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("connection:close",n=>{[...this.reservations.values()].find(i=>i.connection===n.detail.id)!=null&&this.#t(n.detail.remotePeer).catch(i=>{this.log("could not remove relay %p - %e",n.detail,i)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{let e=await this.peerStore.all({filters:[t=>t.tags.has(Nm)]});this.log("removing tag from %d old relays",e.length),await Promise.all(e.map(async t=>{await this.peerStore.merge(t.id,{tags:{[Nm]:void 0}})})),this.log("redialing %d old relays",e.length),await Promise.all(e.map(async t=>this.addRelay(t.id,"discovered"))),this.#r()}).catch(e=>{this.log.error(e)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}reserveRelay(){let e=YR();return this.pendingReservations.push(e),this.#r(),e}async addRelay(e,t){if(this.peerId.equals(e))throw this.log.trace("not trying to use self as relay"),new Oc("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new r4("The reservation queue is full");let n=this.reserveQueue.find(e);if(n!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",e),n.join();if(this.relayFilter.has(e.toMultihash().bytes))throw new Oc("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",e),this.reserveQueue.add(async()=>{let o=Date.now();try{let i=this.reservations.get(e);if(i!=null){let m=this.connectionManager.getConnections(e),g=!1;if(m.length===0&&this.log("already have relay reservation with %p but we are no longer connected",e),m.map(w=>w.id).includes(i.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",e),g=!0),g&&sb(i.reservation.expire)>mX)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",e),{relay:e,details:i};await this.#t(e)}if(t==="discovered"&&this.pendingReservations.length===0)throw new Om("Not making reservation on discovered relay because we do not need any more relays");let s=AbortSignal.timeout(this.reservationCompletionTimeout);let a=await this.connectionManager.openConnection(e,{signal:s});if(kn.matches(a.remoteAddr))throw new t4("not creating reservation over relayed connection");let c=await this.#e(a,{signal:s}),l=sb(c.expire);this.log("created reservation on relay peer %p, expiry date is %s",e,new Date(Date.now()+l).toString());let u=Math.min(Math.max(l-gX,yX),Math.pow(2,31)-1),f=setTimeout(()=>{this.log("refresh reservation to relay %p",e),this.addRelay(e,t).catch(async m=>{this.log.error("could not refresh reservation to relay %p - %e",e,m),await this.#t(e)}).catch(m=>{this.log.error("could not remove expired reservation to relay %p - %e",e,m)})},u),h;if(t==="discovered"){let m=this.pendingReservations.pop();if(m==null)throw new Om("Made reservation on relay but did not need any more discovered relays");h={timeout:f,reservation:c,type:t,connection:a.id,id:m}}else h={timeout:f,reservation:c,type:t,connection:a.id};this.reservations.set(e,h),await this.peerStore.merge(e,{tags:{[Nm]:{value:1,ttl:l}}}),this.#r();let d={relay:e,details:h};return this.safeDispatchEvent("relay:created-reservation",{detail:d}),d}catch(i){throw t==="discovered"&&i.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",e,Date.now()-o,i),(i.name==="DialError"||i.name==="UnsupportedProtocolError")&&this.relayFilter.add(e.toMultihash().bytes),this.#t(e).catch(s=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",e,s)}),i}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(e){return e==null?this.reservations.size:[...this.reservations.values()].reduce((t,n)=>(n.type===e&&t++,t),0)}cancelReservations(){[...this.reservations.values()].forEach(e=>{clearTimeout(e.timeout)}),this.reservations.clear()}async#e(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);let n=await e.newStream(Yl,t),i=vt(n).pb(za);this.log.trace("send RESERVE to %p",e.remotePeer),await i.write({type:za.Type.RESERVE},t);let s;try{this.log.trace("reading response from %p",e.remotePeer),s=await i.read(t)}catch(c){throw n.abort(c),c}finally{n.status!=="closed"&&await n.close(t)}if(this.log.trace("read response %o",s),s.status===Fr.OK&&s.reservation!=null){let c=new Set;c.add(e.remoteAddr.toString());for(let l of s.reservation.addrs){let u=ne(l);u.getPeerId()==null&&(u=u.encapsulate(`/p2p/${e.remotePeer}`)),u=ne(u.toString().replace(`/p2p/${e.remotePeer}/p2p/${e.remotePeer}`,`/p2p/${e.remotePeer}`)),c.add(u.toString())}return s.reservation.addrs=[...c].map(l=>ne(l).bytes),s.reservation}let a=`reservation failed with status ${s.status??"undefined"}`;throw this.log.error(a),new Error(a)}async#t(e){let t=this.reservations.get(e);t!=null&&(this.log("removing relay reservation with %p from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),t.type==="discovered"&&this.pendingReservations.push(t.id),await this.peerStore.merge(e,{tags:{[Nm]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:e,details:t}}),this.#r())}#r(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=en(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")}};var wX=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(ne)}catch{return!1}return!0},QR={maxInboundStopStreams:ob,maxOutboundStopStreams:ob,stopTimeout:3e4},a4=class{discovery;registrar;peerStore;connectionManager;transportManager;peerId;upgrader;addressManager;connectionGater;reservationStore;logger;maxInboundStopStreams;maxOutboundStopStreams;started;log;shutdownController;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??QR.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??QR.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new i4(e,{filter:t.discoveryFilter??v7(qR,jR)}),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(o=>{o.name!=="HadEnoughRelaysError"&&o.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p",n.detail,o)})}),this.reservationStore=new s4(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{this.discovery?.stopDiscovery()}),this.started=!1}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[Ye]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[Qn](){return this.discovery!=null?["@libp2p/identify"]:[]}[ma]=!0;isStarted(){return this.started}async start(){this.shutdownController=new AbortController,this.shutdownController.signal,await this.registrar.handle(nb,e=>{let t=this.upgrader.createInboundAbortSignal(this.shutdownController.signal);this.onStop(e,t).catch(n=>{this.log.error("error while handling STOP protocol",n),e.stream.abort(n)}).finally(()=>{t.clear()})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await Sr(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await Wr(this.discovery,this.reservationStore),await this.registrar.unhandle(nb),this.started=!1}async dial(e,t){if(e.protoCodes().filter(d=>d===VR).length!==1){let d="Invalid circuit relay address";throw this.log.error(d,e),new xs(d)}let n=e.toString().split("/p2p-circuit"),o=ne(n[0]),i=ne(n[n.length-1]),s=o.getPeerId(),a=i.getPeerId();if(s==null||a==null){let d=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${d}`),new xs(`C${d}`)}let c=tt(s),l=tt(a),f=this.connectionManager.getConnections(c)[0];f==null?(await this.peerStore.merge(c,{multiaddrs:[o]}),t.onProgress?.(new j("circuit-relay:open-connection")),f=await this.connectionManager.openConnection(c,t)):t.onProgress?.(new j("circuit-relay:reuse-connection"));let h;try{t.onProgress?.(new j("circuit-relay:open-hop-stream")),h=await f.newStream(Yl,t);let d=vt(h),m=d.pb(za);t.onProgress?.(new j("circuit-relay:write-connect-message")),await m.write({type:za.Type.CONNECT,peer:{id:l.toMultihash().bytes,addrs:[ne(i).bytes]}},t),t.onProgress?.(new j("circuit-relay:read-connect-response"));let g=await m.read(t);if(g.status!==Fr.OK)throw new Oe(`failed to connect via relay with status ${g?.status?.toString()??"undefined"}`);let w=new Lm(g.limit),x=ab({stream:d.unwrap(),remoteAddr:e,localAddr:o.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),logger:this.logger,onDataRead:w.onData,onDataWrite:w.onData});return this.log("new outbound relayed connection %a",x.remoteAddr),await this.upgrader.upgradeOutbound(x,{...t,limits:w.getLimits()})}catch(d){throw this.log.error("circuit relay dial to destination %p via relay %p failed",l,c,d),h?.abort(d),d}}createListener(e){return GR({peerId:this.peerId,connectionManager:this.connectionManager,addressManager:this.addressManager,reservationStore:this.reservationStore,logger:this.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>n4.exactMatch(t)||o4.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>kn.exactMatch(t))}async onStop({connection:e,stream:t},n){if(!this.reservationStore.hasReservation(e.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([e.remoteAddr.encapsulate("/p2p-circuit")])}catch(f){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",f)}let o=vt(t).pb(Zi),i=await o.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,i.type),i?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await o.write({type:Zi.Type.STATUS,status:Fr.MALFORMED_MESSAGE},{signal:n}),await t.close();return}if(i.type!==Zi.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await o.write({type:Zi.Type.STATUS,status:Fr.UNEXPECTED_MESSAGE},{signal:n}),await t.close();return}if(!wX(i)){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await o.write({type:Zi.Type.STATUS,status:Fr.MALFORMED_MESSAGE},{signal:n}),await t.close({signal:n});return}let s=cr(ze(i.peer.id));if(await this.connectionGater.denyInboundRelayedConnection?.(e.remotePeer,s)===!0){this.log.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await o.write({type:Zi.Type.STATUS,status:Fr.PERMISSION_DENIED},{signal:n}),await t.close({signal:n});return}this.log.trace("sending success response to %p",e.remotePeer),await o.write({type:Zi.Type.STATUS,status:Fr.OK},{signal:n});let a=new Lm(i.limit),c=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${s.toString()}`),l=this.addressManager.getAddresses()[0],u=ab({stream:o.unwrap().unwrap(),remoteAddr:c,localAddr:l,logger:this.logger,onDataRead:a.onData,onDataWrite:a.onData});this.log("new inbound relayed connection %a",u.remoteAddr),await this.upgrader.upgradeInbound(u,{limits:a.getLimits(),signal:n}),this.log("%s connection %a upgraded","inbound",u.remoteAddr)}};function lb(r={}){return e=>new a4(e,r)}var vi;(function(r){let e;(function(o){o.UNUSED="UNUSED",o.CONNECT="CONNECT",o.SYNC="SYNC"})(e=r.Type||(r.Type={}));let t;(function(o){o[o.UNUSED=0]="UNUSED",o[o.CONNECT=100]="CONNECT",o[o.SYNC=300]="SYNC"})(t||(t={})),function(o){o.codec=()=>wt(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=be((o,i,s={})=>{if(s.lengthDelimited!==!1&&i.fork(),o.type!=null&&(i.uint32(8),r.Type.codec().encode(o.type,i)),o.observedAddresses!=null)for(let a of o.observedAddresses)i.uint32(18),i.bytes(a);s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={observedAddresses:[]},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(o);break}case 2:{if(s.limits?.observedAddresses!=null&&a.observedAddresses.length===s.limits.observedAddresses)throw new ft('Decode error - map field "observedAddresses" had too many elements');a.observedAddresses.push(o.bytes());break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>xe(o,r.codec()),r.decode=(o,i)=>we(o,r.codec(),i)})(vi||(vi={}));function ub(r,e){return kn.matches(r)||e.dialTransportForMultiaddr(r)==null?!1:jp.matches(r)?!0:yT.matches(r)?bn(r.toOptions().host)===!1:!1}var ZR=1024*4,JR=100,c4={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1},l4=class{started;timeout;retries;maxInboundStreams;maxOutboundStreams;peerStore;registrar;connectionManager;addressManager;transportManager;topologyId;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??c4.timeout,this.retries=t.retries??c4.retries,this.maxInboundStreams=t.maxInboundStreams??c4.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??c4.maxOutboundStreams}[Symbol.toStringTag]="@libp2p/dcutr";[Qn]=["@libp2p/identify"];isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(Bm,{notifyOnLimitedConnection:!0,onConnect:(e,t)=>{kn.exactMatch(t.remoteAddr)&&t.direction==="inbound"&&this.upgradeInbound(t).catch(n=>{this.log.error("error during outgoing DCUtR attempt",n)})}}),await this.registrar.handle(Bm,e=>{this.handleIncomingUpgrade(e.stream,e.connection).catch(t=>{this.log.error("error during incoming DCUtR attempt",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(Bm),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let n=0;n<this.retries;n++){let o={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([Bm],{signal:o.signal,runOnLimitedConnection:!0});let i=vt(t,{maxDataLength:ZR}).pb(vi);this.log("B sending connect to %p",e.remotePeer);let s=Date.now();await i.write({type:vi.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(f=>f.bytes)},o),this.log("B receiving connect from %p",e.remotePeer);let a=await i.read(o);if(a.type!==vi.Type.CONNECT)throw this.log("A sent wrong message type"),new Oe("DCUtR message type was incorrect");let c=this.getDialableMultiaddrs(a.observedAddresses);if(c.length===0)throw this.log("A did not have any dialable multiaddrs"),new Oe("DCUtR connect message had no multiaddrs");let l=Date.now()-s;this.log("A sending sync, rtt %dms",l),await i.write({type:vi.Type.SYNC,observedAddresses:[]},o),this.log("A waiting for half RTT"),await r3(l/2),this.log("B dialing",c);let u=await this.connectionManager.openConnection(c,{signal:o.signal,priority:JR,force:!0,initiator:!1});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,u.remoteAddr),await e.close(o);break}catch(i){if(this.log.error("error while attempting DCUtR on attempt %d of %d",n+1,this.retries,i),t?.abort(i),n===this.retries)throw i}finally{t!=null&&await t.close(o)}}}async attemptUnilateralConnectionUpgrade(e){let n=(await this.peerStore.get(e.remotePeer)).addresses.map(o=>{let i=o.multiaddr;return i.getPeerId()==null?i.encapsulate(`/p2p/${e.remotePeer}`):i}).filter(o=>ub(o,this.transportManager));if(n.length>0){let o=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",n);let i=await this.connectionManager.openConnection(n,{signal:o,force:!0});if(kn.exactMatch(i.remoteAddr))throw new Error("Could not open a new, non-limited, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,i.remoteAddr),await e.close({signal:o}),!0}catch(i){this.log.error("unilateral connection upgrade to %p on addresses %a failed",e.remotePeer,n,i)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){let n={signal:AbortSignal.timeout(this.timeout)};try{let o=vt(e,{maxDataLength:ZR}).pb(vi);this.log("A receiving connect");let i=await o.read(n);if(i.type!==vi.Type.CONNECT)throw this.log("B sent wrong message type"),new Oe("DCUtR message type was incorrect");if(i.observedAddresses.length===0)throw this.log("B sent no multiaddrs"),new Oe("DCUtR connect message had no multiaddrs");let s=this.getDialableMultiaddrs(i.observedAddresses);if(s.length===0)throw this.log("B had no dialable multiaddrs"),new Oe("DCUtR connect message had no dialable multiaddrs");if(this.log("A sending connect"),await o.write({type:vi.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(l=>l.bytes)}),this.log("A receiving sync"),(await o.read(n)).type!==vi.Type.SYNC)throw new Oe("DCUtR message type was incorrect");this.log("A dialing",s);let c=await this.connectionManager.openConnection(s,{signal:n.signal,priority:JR,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,c.remoteAddr),await t.close(n)}catch(o){this.log.error("incoming DCUtR from %p failed",t.remotePeer,o),e.abort(o)}finally{await e.close(n)}}getDialableMultiaddrs(e){let t=[];for(let n of e)if(!(n==null||n.length===0))try{let o=ne(n);if(!ub(o,this.transportManager))continue;t.push(o)}catch{}return t}};var Bm="/libp2p/dcutr";function eD(r={}){return e=>new l4(e,r)}var tD="0.1.0",rD="id",nD="id/push",oD="1.0.0",iD="1.0.0";var qa;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(let i of t.listenAddrs)n.uint32(18),n.bytes(i);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(let i of t.protocols)n.uint32(26),n.string(i);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={listenAddrs:[],protocols:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 5:{i.protocolVersion=t.string();break}case 6:{i.agentVersion=t.string();break}case 1:{i.publicKey=t.bytes();break}case 2:{if(o.limits?.listenAddrs!=null&&i.listenAddrs.length===o.limits.listenAddrs)throw new ft('Decode error - map field "listenAddrs" had too many elements');i.listenAddrs.push(t.bytes());break}case 4:{i.observedAddr=t.bytes();break}case 3:{if(o.limits?.protocols!=null&&i.protocols.length===o.limits.protocols)throw new ft('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 8:{i.signedPeerRecord=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(qa||(qa={}));var Ln={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:8192,runOnConnectionOpen:!0,runOnSelfUpdate:!0,runOnLimitedConnection:!0,concurrency:32};function sD(r){if(r!=null&&r.length>0)try{return ne(r)}catch{}}function vX(r,e){return e??r.userAgent}async function u4(r,e,t,n,o){if(t("received identify from %p",n.remotePeer),o==null)throw new Oe("message was null or undefined");let i={};if(o.listenAddrs.length>0&&(i.addresses=o.listenAddrs.map(c=>({isCertified:!1,multiaddr:ne(c)}))),o.protocols.length>0&&(i.protocols=o.protocols),o.publicKey!=null){let c=Qt(o.publicKey);if(!zi(c).equals(n.remotePeer))throw new Oe("public key did not match remote PeerId");i.publicKey=c}let s;if(o.signedPeerRecord!=null){t.trace("received signedPeerRecord from %p",n.remotePeer);let c=o.signedPeerRecord,l=await ho.openAndCertify(c,An.DOMAIN),u=An.createFromProtobuf(l.payload),f=yn(l.publicKey.toCID());if(!u.peerId.equals(f))throw new Oe("signing key does not match PeerId in the PeerRecord");if(!n.remotePeer.equals(u.peerId))throw new Oe("signing key does not match remote PeerId");let h;try{h=await r.get(u.peerId)}catch(d){if(d.name!=="NotFoundError")throw d}if(h!=null&&(i.metadata=h.metadata,h.peerRecordEnvelope!=null)){let d=ho.createFromProtobuf(h.peerRecordEnvelope),m=An.createFromProtobuf(d.payload);m.seqNumber>=u.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",m.seqNumber,u.seqNumber),u=m,c=h.peerRecordEnvelope)}i.peerRecordEnvelope=c,i.addresses=u.multiaddrs.map(d=>({isCertified:!0,multiaddr:d})),s={seq:u.seqNumber,addresses:u.multiaddrs}}else t("%p did not send a signed peer record",n.remotePeer);if(t.trace("patching %p with",n.remotePeer,i),await r.patch(n.remotePeer,i),o.agentVersion!=null||o.protocolVersion!=null){let c={};o.agentVersion!=null&&(c.AgentVersion=L(o.agentVersion)),o.protocolVersion!=null&&(c.ProtocolVersion=L(o.protocolVersion)),t.trace("merging %p metadata",n.remotePeer,c),await r.merge(n.remotePeer,{metadata:c})}let a={peerId:n.remotePeer,protocolVersion:o.protocolVersion,agentVersion:o.agentVersion,publicKey:o.publicKey,listenAddrs:o.listenAddrs.map(c=>ne(c)),observedAddr:o.observedAddr==null?void 0:ne(o.observedAddr),protocols:o.protocols,signedPeerRecord:s,connection:n};return e.safeDispatchEvent("peer:identify",{detail:a}),a}var Td=class{host;protocol;started;timeout;peerId;privateKey;peerStore;registrar;addressManager;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;events;runOnLimitedConnection;log;constructor(e,t){this.protocol=t.protocol,this.started=!1,this.peerId=e.peerId,this.privateKey=e.privateKey,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.events=e.events,this.log=t.log,this.timeout=t.timeout??Ln.timeout,this.maxInboundStreams=t.maxInboundStreams??Ln.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??Ln.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??Ln.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??Ln.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??Ln.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??Ln.protocolPrefix}/${tD}`,agentVersion:vX(e.nodeInfo,t.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:L(this.host.agentVersion),ProtocolVersion:L(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,e=>{this.handleProtocol(e).catch(t=>{this.log.error(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}};var f4=class extends Td{connectionManager;concurrency;constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??Ln.protocolPrefix}/${nD}/${iD}`,log:e.logger.forComponent("libp2p:identify-push")}),this.connectionManager=e.connectionManager,this.concurrency=t.concurrency??Ln.concurrency,(t.runOnSelfUpdate??Ln.runOnSelfUpdate)&&e.events.addEventListener("self:peer:update",n=>{this.push().catch(o=>{this.log.error(o)})})}[Ye]=["@libp2p/identify-push"];async push(){if(!this.isStarted())return;let e=this.addressManager.getAddresses().map(u=>u.decapsulateCode(It("p2p").code)),t=new An({peerId:this.peerId,multiaddrs:e}),n=await ho.seal(t,this.privateKey),o=this.registrar.getProtocols(),i=await this.peerStore.get(this.peerId),s=K(i.metadata.get("AgentVersion")??L(this.host.agentVersion)),a=K(i.metadata.get("ProtocolVersion")??L(this.host.protocolVersion)),c=this;async function*l(){for(let u of c.connectionManager.getConnections())(await c.peerStore.get(u.remotePeer)).protocols.includes(c.protocol)&&(yield async()=>{let h,d=AbortSignal.timeout(c.timeout);try{h=await u.newStream(c.protocol,{signal:d,runOnLimitedConnection:c.runOnLimitedConnection}),await vt(h,{maxDataLength:c.maxMessageSize}).pb(qa).write({listenAddrs:e.map(g=>g.bytes),signedPeerRecord:n.marshal(),protocols:o,agentVersion:s,protocolVersion:a},{signal:d}),await h.close({signal:d})}catch(m){c.log.error("could not push identify update to peer",m),h?.abort(m)}})}await Gr(En(l(),{concurrency:this.concurrency}))}async handleProtocol(e){let{connection:t,stream:n}=e;try{if(this.peerId.equals(t.remotePeer))throw new Error("received push from ourselves?");let o={signal:AbortSignal.timeout(this.timeout)},s=await vt(n,{maxDataLength:this.maxMessageSize}).pb(qa).read(o);await n.close(o),await u4(this.peerStore,this.events,this.log,t,s)}catch(o){this.log.error("received invalid message",o),n.abort(o);return}this.log.trace("handled push from %p",t.remotePeer)}};var d4=class extends Td{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??Ln.protocolPrefix}/${rD}/${oD}`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??Ln.runOnConnectionOpen)&&e.events.addEventListener("connection:open",n=>{let o=n.detail;this.identify(o).catch(i=>{i.name!==ws.name&&this.log.error("error during identify trigged by connection:open",i)})})}[Ye]=["@libp2p/identify"];async _identify(e,t={}){let n;if(t.signal==null){let o=AbortSignal.timeout(this.timeout);t={...t,signal:o}}try{n=await e.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});let i=await vt(n,{maxDataLength:this.maxMessageSize}).pb(qa).read(t);return await n.close(t),i}catch(o){throw n?.abort(o),o}}async identify(e,t={}){let n=await this._identify(e,t),{publicKey:o,protocols:i,observedAddr:s}=n;if(o==null)throw new Oe("public key was missing from identify message");let a=Qt(o),c=yn(a.toCID());if(!e.remotePeer.equals(c))throw new Oe("identified peer does not match the expected peer");if(this.peerId.equals(c))throw new Oe("identified peer is our own peer id?");return this.maybeAddObservedAddress(s),this.log("identify completed for peer %p and protocols %o",c,i),u4(this.peerStore,this.events,this.log,e,n)}maybeAddObservedAddress(e){let t=sD(e);if(t==null)return;if(this.log.trace("our observed address was %a",t),No(t)){this.log.trace("our observed address was private");return}let n=t.getComponents();if((n[0].code===41||n[0].code===42&&n[1].code===41)&&!q3(t)){this.log.trace("our observed address was IPv6 but not a global unicast address");return}xl.exactMatch(t)||(this.log.trace("storing the observed address"),this.addressManager.addObservedAddr(t))}async handleProtocol(e){let{connection:t,stream:n}=e,o=AbortSignal.timeout(this.timeout);try{let i=await this.peerStore.get(this.peerId),s=this.addressManager.getAddresses().map(u=>u.decapsulateCode(It("p2p").code)),a=i.peerRecordEnvelope;if(s.length>0&&a==null){let u=new An({peerId:this.peerId,multiaddrs:s});a=(await ho.seal(u,this.privateKey)).marshal().subarray()}let c=t.remoteAddr.bytes;gT.matches(t.remoteAddr)||(c=void 0),await vt(n).pb(qa).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:sr(this.privateKey.publicKey),listenAddrs:s.map(u=>u.bytes),signedPeerRecord:a,observedAddr:c,protocols:i.protocols},{signal:o}),await n.close({signal:o})}catch(i){this.log.error("could not respond to identify request",i),n.abort(i)}}};function aD(r={}){return e=>new d4(e,r)}function cD(r={}){return e=>new f4(e,r)}var Ql=1e3,fb=60*Ql,Mm=60*fb,lD=36*Mm,uD="/ipfs/kad/1.0.0",fD=48*Mm;var dD=24*Mm,hD=10,pD=16384,mD=Mm,db=Mm,YAe=10*Ql,gD=10*Ql;var h4=20,ja=10,yD=5*fb,wD=Ql,xD=5*Ql,bD=5*fb,vD=30*Ql,AD=180*Ql,hb=`${pa}-kad-dht`;var Um;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.key!=null&&t.key.byteLength>0&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(n.uint32(18),n.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(n.uint32(42),n.string(t.timeReceived)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={key:Ie(0),value:Ie(0),timeReceived:""},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.key=t.bytes();break}case 2:{i.value=t.bytes();break}case 5:{i.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(Um||(Um={}));function ED(r){let e=r.getUTCFullYear(),t=String(r.getUTCMonth()+1).padStart(2,"0"),n=String(r.getUTCDate()).padStart(2,"0"),o=String(r.getUTCHours()).padStart(2,"0"),i=String(r.getUTCMinutes()).padStart(2,"0"),s=String(r.getUTCSeconds()).padStart(2,"0"),a=r.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${n}T${o}:${i}:${s}.${c}Z`}function SD(r){let e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");let n=parseInt(t[1],10),o=parseInt(t[2],10)-1,i=parseInt(t[3],10),s=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,o,i,s,a,c,l))}var Pt=class r{key;value;timeReceived;constructor(e,t,n){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return Um.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:ED(this.timeReceived)}}static deserialize(e){let t=Um.decode(e);return new r(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){let t=SD(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new r(e.key,e.value,t)}};var Wa=class extends Error{constructor(e="Query error"){super(e),this.name="QueryError"}},p4=class extends Error{constructor(e="Invalid record"){super(e),this.name="InvalidRecordError"}},m4=class extends Error{constructor(e="No selector function configured for prefix"){super(e),this.name="MissingSelectorError"}};var _D;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.key!=null&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&(n.uint32(18),n.bytes(t.value)),t.author!=null&&(n.uint32(26),n.bytes(t.author)),t.signature!=null&&(n.uint32(34),n.bytes(t.signature)),t.timeReceived!=null&&(n.uint32(42),n.string(t.timeReceived)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.key=t.bytes();break}case 2:{i.value=t.bytes();break}case 3:{i.author=t.bytes();break}case 4:{i.signature=t.bytes();break}case 5:{i.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(_D||(_D={}));var nt;(function(r){r.PUT_VALUE="PUT_VALUE",r.GET_VALUE="GET_VALUE",r.ADD_PROVIDER="ADD_PROVIDER",r.GET_PROVIDERS="GET_PROVIDERS",r.FIND_NODE="FIND_NODE",r.PING="PING"})(nt||(nt={}));var g4;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(g4||(g4={}));(function(r){r.codec=()=>wt(g4)})(nt||(nt={}));var Pd;(function(r){r.NOT_CONNECTED="NOT_CONNECTED",r.CONNECTED="CONNECTED",r.CAN_CONNECT="CAN_CONNECT",r.CANNOT_CONNECT="CANNOT_CONNECT"})(Pd||(Pd={}));var pb;(function(r){r[r.NOT_CONNECTED=0]="NOT_CONNECTED",r[r.CONNECTED=1]="CONNECTED",r[r.CAN_CONNECT=2]="CAN_CONNECT",r[r.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(pb||(pb={}));(function(r){r.codec=()=>wt(pb)})(Pd||(Pd={}));var kd;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.multiaddrs!=null)for(let i of t.multiaddrs)n.uint32(18),n.bytes(i);t.connection!=null&&(n.uint32(24),Pd.codec().encode(t.connection,n)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={id:Ie(0),multiaddrs:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.id=t.bytes();break}case 2:{if(o.limits?.multiaddrs!=null&&i.multiaddrs.length===o.limits.multiaddrs)throw new ft('Decode error - map field "multiaddrs" had too many elements');i.multiaddrs.push(t.bytes());break}case 3:{i.connection=Pd.codec().decode(t);break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(kd||(kd={}));var Ga;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.type!=null&&g4[t.type]!==0&&(n.uint32(8),nt.codec().encode(t.type,n)),t.clusterLevel!=null&&(n.uint32(80),n.int32(t.clusterLevel)),t.key!=null&&(n.uint32(18),n.bytes(t.key)),t.record!=null&&(n.uint32(26),n.bytes(t.record)),t.closer!=null)for(let i of t.closer)n.uint32(66),kd.codec().encode(i,n);if(t.providers!=null)for(let i of t.providers)n.uint32(74),kd.codec().encode(i,n);o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={type:nt.PUT_VALUE,closer:[],providers:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.type=nt.codec().decode(t);break}case 10:{i.clusterLevel=t.int32();break}case 2:{i.key=t.bytes();break}case 3:{i.record=t.bytes();break}case 8:{if(o.limits?.closer!=null&&i.closer.length===o.limits.closer)throw new ft('Decode error - map field "closer" had too many elements');i.closer.push(kd.codec().decode(t,t.uint32(),{limits:o.limits?.closer$}));break}case 9:{if(o.limits?.providers!=null&&i.providers.length===o.limits.providers)throw new ft('Decode error - map field "providers" had too many elements');i.providers.push(kd.codec().decode(t,t.uint32(),{limits:o.limits?.providers$}));break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>xe(t,r.codec()),r.decode=(t,n)=>we(t,r.codec(),n)})(Ga||(Ga={}));function mb(r,e={}){let t={...r,name:"SEND_QUERY",type:0,messageName:r.type,messageType:r.type};return e.onProgress?.(new CustomEvent("kad-dht:query:send-query",{detail:t})),t}function Fm(r,e={}){let t={...r,name:"PEER_RESPONSE",type:1,messageName:r.messageType,closer:r.closer??[],providers:r.providers??[]};return e.onProgress?.(new CustomEvent("kad-dht:query:peer-response",{detail:t})),t}function y4(r,e={}){let t={...r,name:"FINAL_PEER",type:2};return e.onProgress?.(new CustomEvent("kad-dht:query:final-peer",{detail:t})),t}function Ai(r,e={}){let t={...r,name:"QUERY_ERROR",type:3};return e.onProgress?.(new CustomEvent("kad-dht:query:query-error",{detail:t})),t}function gb(r,e={}){let t={...r,name:"PROVIDER",type:4};return e.onProgress?.(new CustomEvent("kad-dht:query:provider",{detail:t})),t}function Hm(r,e={}){let t={...r,name:"VALUE",type:5};return e.onProgress?.(new CustomEvent("kad-dht:query:value",{detail:t})),t}function yb(r,e={}){let t={...r,name:"DIAL_PEER",type:7};return e.onProgress?.(new CustomEvent("kad-dht:query:dial-peer",{detail:t})),t}function CD(r,e={}){let t={...r,name:"PATH_ENDED",type:8};return e.onProgress?.(new CustomEvent("kad-dht:query:path-ended",{detail:t})),t}function ID(r,e,t){if(t.length===0)throw new $("No records given");let o=K(e).split("/");if(o.length<3)throw new $("Record key does not have a selector function");let i=r[o[1].toString()];if(i==null)throw new m4(`No selector function configured for key type "${o[1]}"`);return t.length===1?0:i(e,t)}function EX(r,e){return 0}var TD={pk:EX};async function Rd(r,e,t){let n=e.key,i=K(n).split("/");if(i.length<3)return;let s=r[i[1].toString()];if(s==null)throw new $(`No validator available for key type "${i[1]}"`);await s(n,e.value,t)}var SX=async(r,e,t)=>{if(!(r instanceof Uint8Array))throw new $('"key" must be a Uint8Array');if(r.byteLength<5)throw new $("Invalid public key record");if(K(r.subarray(0,4))!=="/pk/")throw new $("key was not prefixed with /pk/");let o=Qt(e),i=r.slice(4);if(!de(i,o.toMultihash().bytes))throw new $("public key does not match passed in key")},kD={pk:SX};var _X=L("/pk/");function PD(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{let[[t,n]]=e.stringTuples();if(t===53||t===54||t===55)return n!=="localhost";if(t!==4&&t!==6||n==null)return!1;let o=bn(n);return o==null?!0:!o})}}async function Xa(r,e){let t=await De.digest(r);return e?.signal?.throwIfAborted(),t.digest}async function Bn(r,e){return Xa(r.toMultihash().bytes,e)}function Ya(r,e){return new Je(`${r}/${K(e,"base32")}`,!1)}function RD(r){return je([_X,r.toMultihash().bytes])}function DD(r){return K(r.subarray(0,4))==="/pk/"}function ND(r){let e=ze(r.subarray(4));return cr(e)}function wb(r,e){let t=new Date;return new Pt(r,e,t).serialize()}var CX=290,IX=54,TX=55,kX=56,PX=4,RX=41;function OD(r){let e=r.stringTuples();for(let t of e)if(t[0]===CX)return!1;if(e[0][0]===IX||e[0][0]===TX||e[0][0]===kX)return!0;if(e[0][0]===PX||e[0][0]===RX){let t=bn(`${e[0][1]}`);return t==null||!t}return!1}function w4(r){let e=r.toString().split("/"),t=e.pop(),n=e.pop();if(t==null||n==null)throw new Error(`incorrectly formatted provider entry key in datastore: ${r.toString()}`);return{cid:q.createV1(mt,ze(L(n,"base32"))),peerId:tt(t)}}function x4(r,e,t){let n=typeof e=="string"?e:K(e.multihash.bytes,"base32"),o=[r,n];return t!=null&&o.push(t.toString()),new Je(o.join("/"))}function b4(r){return new Date(Yo(r))}function Zl(r,e,t){return async function*(...n){let o=e.queryTime?.timer(t),i=e.errorTime?.timer(t),s=!1;try{e.queries?.increment({[t]:!0}),yield*r(...n)}catch(a){throw s=!0,i?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),s||o?.()}}}function v4(r,e,t){return async function(...n){let o=e?.queryTime?.timer(t),i=e?.errorTime?.timer(t),s=!1;try{return e.queries?.increment({[t]:!0}),await r(...n)}catch(a){throw s=!0,i?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),s||o?.()}}}var A4=class{log;components;validators;selectors;peerRouting;queryManager;network;datastorePrefix;constructor(e,t){let{validators:n,selectors:o,peerRouting:i,queryManager:s,network:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-fetching`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n,this.selectors=o,this.peerRouting=i,this.queryManager=s,this.network=a,this.get=e.metrics?.traceFunction("libp2p.kadDHT.get",this.get.bind(this),{optionsIndex:1})??this.get,this.put=e.metrics?.traceFunction("libp2p.kadDHT.put",this.put.bind(this),{optionsIndex:2})??this.put}async getLocal(e,t){this.log("getLocal %b",e);let n=Ya(this.datastorePrefix,e);this.log("fetching record for key %k",n);let o=await this.components.datastore.get(n,t);this.log("found %k in local datastore",n);let i=Pt.deserialize(o);return await Rd(this.validators,i,t),i}async*sendCorrectionRecord(e,t,n,o){this.log("sendCorrection for %b",e);let i=wb(e,n);for(let{value:s,from:a}of t){if(de(s,n)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{let u=Ya(this.datastorePrefix,e);this.log(`Storing corrected record for key ${u.toString()}`),await this.components.datastore.put(u,i.subarray(),o)}catch(u){this.log.error("Failed error correcting self",u)}continue}let c=!1,l={type:nt.PUT_VALUE,key:e,record:i};for await(let u of this.network.sendRequest(a,l,o))u.name==="PEER_RESPONSE"&&u.record!=null&&de(u.record.value,Pt.deserialize(i).value)&&(c=!0),yield u;if(!c)throw new Wa("Could not send correction");this.log.error("Failed error correcting entry")}}async*put(e,t,n){this.log("put key %b value %b",e,t);let o=wb(e,t),i=Ya(this.datastorePrefix,e);this.log(`storing record for key ${i.toString()}`),await this.components.datastore.put(i,o.subarray(),n),yield*pt(this.peerRouting.getClosestPeers(e,{...n,signal:n.signal}),s=>Ht(s,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];let c=[],l={type:nt.PUT_VALUE,key:e,record:o};this.log("send put to %p",a.peer.id);for await(let u of this.network.sendRequest(a.peer.id,l,{...n,path:a.path}))c.push(u),u.name==="PEER_RESPONSE"&&(u.record!=null&&de(u.record.value,Pt.deserialize(o).value)||c.push(Ai({from:a.peer.id,error:new Wa("Value not put correctly"),path:u.path},n)));return c}),s=>En(s,{ordered:!1,concurrency:ja}),async function*(s){for await(let a of s)yield*a})}async*get(e,t){this.log("get %b",e);let n=[];for await(let a of this.getMany(e,t)){if(a.name==="VALUE"){n.push(a);continue}yield a}if(n.length===0)return;let o=n.map(a=>a.value),i=0;try{i=ID(this.selectors,e,o)}catch(a){if(a.name!=="InvalidParametersError")throw a}let s=o[i];if(this.log("GetValue %b %b",e,s),s==null)throw new $e("Best value was not found");yield*this.sendCorrectionRecord(e,n,s,{...t,path:{index:-1,queued:0,running:0,total:0}}),yield n[i]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{let i=await this.getLocal(e,t);yield Hm({value:i.value,from:this.components.peerId,path:{index:-1,running:0,queued:0,total:0}},t)}catch(i){this.log("error getting local value for %b",e,i)}let n=this,o=async function*({peer:i,signal:s,path:a}){for await(let c of n.peerRouting.getValueOrPeers(i.id,e,{...t,signal:s,path:a}))yield c,c.name==="PEER_RESPONSE"&&c.record!=null&&(yield Hm({from:i.id,value:c.record.value,path:a},t))};yield*this.queryManager.run(e,o,t)}};function LD(r,e){return{id:r.id.toMultihash().bytes,multiaddrs:(r.multiaddrs??[]).map(n=>n.bytes),connection:e}}function $m(r){if(r.id==null)throw new Error("Invalid peer in message");let e=ze(r.id);return{id:cr(e),multiaddrs:(r.multiaddrs??[]).map(t=>ne(t))}}var E4=class{log;components;network;peerRouting;queryManager;routingTable;providers;constructor(e,t){let{network:n,peerRouting:o,queryManager:i,routingTable:s,providers:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-routing`),this.network=n,this.peerRouting=o,this.queryManager=i,this.routingTable=s,this.providers=a,this.findProviders=e.metrics?.traceFunction("libp2p.kadDHT.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,u)=>(l.name==="PROVIDER"&&(u.providers??=[],u.providers.push(...l.providers.map(f=>f.id.toString()))),u)})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.kadDHT.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,u)=>(l.name==="PEER_RESPONSE"&&l.messageName==="ADD_PROVIDER"&&(u.providers??=[],u.providers.push(l.from.toString())),u)})??this.provide}async*provide(e,t,n={}){this.log("provide %s",e);let o=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId,n);let i={type:nt.ADD_PROVIDER,key:o,providers:[LD({id:this.components.peerId,multiaddrs:t})]},s=0,a=this;async function*c(f){try{a.log("sending provider record for %s to %p",e,f.peer.id);for await(let h of a.network.sendMessage(f.peer.id,i,{...n,path:f.path}))h.name==="PEER_RESPONSE"&&(a.log("sent provider record for %s to %p",e,f.peer.id),s++),yield h}catch(h){a.log.error("error sending provide record to peer %p",f.peer.id,h),yield Ai({from:f.peer.id,error:h,path:f.path},n)}}let l=nr({objectMode:!0}),u=new _r({concurrency:ja});u.addEventListener("idle",()=>{l.end()}),u.addEventListener("error",f=>{this.log.error("error publishing provider record to peer - %e",f)}),u.add(async()=>{let f=[];for await(let h of this.peerRouting.getClosestPeers(o,n))l.push(h),h.name==="FINAL_PEER"&&f.push(h);f.forEach(h=>{u.add(async()=>{for await(let d of c(h))l.push(d)}).catch(d=>{this.log.error("error publishing provider record to peer - %e",d)})})}).catch(f=>{l.end(f)}),yield*l,this.log("sent provider records to %d peers",s)}async*findProviders(e,t){let n=this.routingTable.kBucketSize,o=0,i=e.multihash.bytes,s=this;this.log("findProviders %c",e);let a=await this.providers.getProviders(e,t);if(a.length>0){let u=[];for(let f of a.slice(0,n))try{let h=await this.components.peerStore.get(f,t);u.push({id:f,multiaddrs:h.addresses.map(({multiaddr:d})=>d)})}catch(h){if(h.name!=="NotFoundError")throw h;this.log("no peer store entry for %p",f)}if(yield Fm({from:this.components.peerId,messageType:nt.GET_PROVIDERS,providers:u,path:{index:-1,queued:0,running:0,total:0}},t),yield gb({from:this.components.peerId,providers:u,path:{index:-1,queued:0,running:0,total:0}},t),o+=u.length,o>=n)return}let c=async function*({peer:u,signal:f,path:h}){let d={type:nt.GET_PROVIDERS,key:i};yield*s.network.sendRequest(u.id,d,{...t,signal:f,path:h})},l=new ro(a);for await(let u of this.queryManager.run(i,c,t))if(yield u,u.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",u.providers.length,e,u.closer.length);let f=[];for(let h of u.providers)l.has(h.id)||(l.add(h.id),f.push(h));if(f.length>0&&(yield gb({from:u.from,providers:f,path:u.path},t),o+=f.length,o>=n))return}}};var S4=class extends Re{log;protocol;running;components;timeout;metrics;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:network`),this.running=!1,this.protocol=t.protocol,this.timeout=new wi({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_network_message_send_times_milliseconds`}),this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_errors_total`)},this.sendRequest=e.metrics?.traceFunction("libp2p.kadDHT.sendRequest",this.sendRequest.bind(this),{optionsIndex:2,getAttributesFromArgs([n,o],i){return{...i,to:n.toString(),"message type":`${o.type}`}},getAttributesFromYieldedValue:(n,o)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((i,s)=>{o[`providers-${s}`]=i.id.toString()}),n.closer.length>0&&n.closer.forEach((i,s)=>{o[`closer-${s}`]=i.id.toString()})),o)})??this.sendRequest,this.sendMessage=e.metrics?.traceFunction("libp2p.kadDHT.sendMessage",this.sendMessage.bind(this),{optionsIndex:2,getAttributesFromArgs([n,o],i){return{...i,to:n.toString(),"message type":`${o.type}`}},getAttributesFromYieldedValue:(n,o)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((i,s)=>{o[`providers-${s}`]=i.id.toString()}),n.closer.length>0&&n.closer.forEach((i,s)=>{o[`closer-${s}`]=i.id.toString()})),o)})??this.sendMessage}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,n){if(!this.running)return;let o=t.type;if(o==null)throw new $("Message type was missing");let i,s=this.timeout.getTimeoutSignal(n);n={...n,signal:s};try{this.metrics.operations?.increment({[o]:!0}),this.log("dialling %p",e),yield yb({peer:e,path:n.path},n),i=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n),this.log("sending %s to %p",t.type,e),yield mb({to:e,type:o,path:n.path},n);let c=await this._writeReadMessage(i,t,n);i.close(n).catch(l=>{this.log.error("error closing stream to %p",e,l),i?.abort(l)}),yield Fm({from:e,messageType:c.type,closer:c.closer.map($m),providers:c.providers.map($m),record:c.record==null?void 0:Pt.deserialize(c.record),path:n.path},n)}catch(a){this.metrics.errors?.increment({[o]:!0}),i?.abort(a),n.signal?.aborted!==!0&&this.log.error("could not send %s to %p - %e",t.type,e,a),yield Ai({from:e,error:a,path:n.path},n)}finally{this.timeout.cleanUp(s)}}async*sendMessage(e,t,n){if(!this.running)return;let o=t.type;if(o==null)throw new $("Message type was missing");let i,s=this.timeout.getTimeoutSignal(n);n={...n,signal:s};try{this.metrics.operations?.increment({[o]:!0}),this.log("dialling %p",e),yield yb({peer:e,path:n.path},n),i=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n),this.log("sending %s to %p",t.type,e),yield mb({to:e,type:o,path:n.path},n),await this._writeMessage(i,t,n),i.close(n).catch(c=>{this.log.error("error closing stream to %p",e,c),i?.abort(c)}),yield Fm({from:e,messageType:o,path:n.path},n)}catch(a){this.metrics.errors?.increment({[o]:!0}),i?.abort(a),yield Ai({from:e,error:a,path:n.path},n)}finally{this.timeout.cleanUp(s)}}async _writeMessage(e,t,n){await vt(e).write(t,Ga,n)}async _writeReadMessage(e,t,n){let o=vt(e);await o.write(t,Ga,n);let i=await o.read(Ga,n);return i.closer.forEach(s=>{this.safeDispatchEvent("peer",{detail:$m(s)})}),i.providers.forEach(s=>{this.safeDispatchEvent("peer",{detail:$m(s)})}),i}};function Jl(r,e){if(r.byteLength!==e.byteLength)throw new Error("Inputs should have the same length");for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}var Qa=class{originDhtKey;capacity;peerDistances;constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return[...this.peerDistances]}async add(e,t={index:-1,queued:0,running:0,total:0},n){let o=await Bn(e.id,n);this.addWithKadId(e,o,t)}addWithKadId(e,t,n={index:-1,queued:0,running:0,total:0}){if(this.peerDistances.find(s=>s.peer.id.equals(e.id))!=null)return;let o={peer:e,distance:xi(this.originDhtKey,t),path:n};if(this.peerDistances.length===this.capacity){let s=this.peerDistances[this.peerDistances.length-1];if(s!=null&&Jl(o.distance,s.distance)!==-1)return}let i=!1;for(let s=0;s<this.peerDistances.length;s++){let a=Jl(this.peerDistances[s].distance,o.distance);if(a===0||a===1){i=!0,this.peerDistances.splice(s,0,o);break}}i||this.peerDistances.push(o),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e,t){if(this.length===0)return!0;let n=await Bn(e,t),o=xi(n,this.originDhtKey),i=this.peerDistances[this.peerDistances.length-1].distance;return Jl(o,i)===-1}async anyCloser(e,t){return e.length===0?!1:Promise.any(e.map(async n=>this.isCloser(n,t)))}};var _4=class{log;routingTable;network;validators;queryManager;components;constructor(e,t){this.routingTable=t.routingTable,this.network=t.network,this.validators=t.validators,this.queryManager=t.queryManager,this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:peer-routing`),this.findPeer=e.metrics?.traceFunction("libp2p.kadDHT.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.kadDHT.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async findPeerLocal(e,t){let n,o=await this.routingTable.find(e,t);if(o!=null){this.log("findPeerLocal found %p in routing table",e);try{n=await this.components.peerStore.get(o,t)}catch(i){if(i.name!=="NotFoundError")throw i}}if(n==null)try{n=await this.components.peerStore.get(e,t)}catch(i){if(i.name!=="NotFoundError")throw i}if(n!=null)return this.log("findPeerLocal found %p in peer store",e),{id:n.id,multiaddrs:n.addresses.map(i=>i.multiaddr)}}async*_getValueSingle(e,t,n){let o={type:nt.GET_VALUE,key:t};yield*this.network.sendRequest(e,o,n)}async*getPublicKeyFromNode(e,t={}){let n=RD(e),o={index:-1,queued:0,running:0,total:0};for await(let i of this._getValueSingle(e,n,{...t,path:o}))if(yield i,i.name==="PEER_RESPONSE"&&i.record!=null){let s=Qt(i.record.value),a=zi(s);if(!a.equals(e))throw new ys("public key does not match id");if(a.publicKey==null)throw new ys("public key missing");yield Hm({from:e,value:i.record.value,path:o},t)}throw new Wa(`Node not responding with its public key: ${e.toString()}`)}async*findPeer(e,t={}){if(this.log("findPeer %p",e),t.useCache!==!1){let o=await this.findPeerLocal(e,t);if(o!=null){this.log("found local"),yield y4({from:this.components.peerId,peer:o,path:{index:-1,queued:0,running:0,total:0}},t);return}}let n=!1;if(t.useNetwork!==!1){let o=this,i=async function*({peer:s,signal:a,path:c}){let l={type:nt.FIND_NODE,key:e.toMultihash().bytes};for await(let u of o.network.sendRequest(s.id,l,{...t,signal:a,path:c}))if(yield u,u.name==="PEER_RESPONSE"){let f=u.closer.find(h=>h.id.equals(e));f!=null&&(yield y4({from:u.from,peer:f,path:u.path},t))}};for await(let s of this.queryManager.run(e.toMultihash().bytes,i,t))s.name==="FINAL_PEER"&&(n=!0),yield s}if(!n)throw new $e("Not found")}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);let n=await Xa(e,t),o=new Qa(n,this.routingTable.kBucketSize),i=this,s=async function*({peer:a,path:c,peerKadId:l,signal:u}){i.log("getClosestPeers asking %p",a.id);let f={type:nt.FIND_NODE,key:e};yield*i.network.sendRequest(a.id,f,{...t,signal:u,path:c}),o.addWithKadId(a,l,c)};yield*this.queryManager.run(e,s,t),this.log("found %d peers close to %b",o.length,e);for(let{peer:a,path:c}of o.peers)try{if(a.multiaddrs.length===0&&(a=await i.components.peerStore.getInfo(a.id,t)),a.multiaddrs.length===0)continue;yield y4({from:this.components.peerId,peer:await i.components.peerStore.getInfo(a.id,t),path:{index:c.index,queued:0,running:0,total:0}},t)}catch{continue}}async*getValueOrPeers(e,t,n){for await(let o of this._getValueSingle(e,t,n)){if(o.name==="PEER_RESPONSE"&&o.record!=null)try{await this._verifyRecordOnline(o.record,n)}catch{let s="invalid record received, discarded";this.log(s),yield Ai({from:o.from,error:new Wa(s),path:n.path},n);continue}yield o}}async _verifyRecordOnline(e,t){if(e.timeReceived==null)throw new p4("invalid record received");await Rd(this.validators,new Pt(e.key,e.value,e.timeReceived),t)}async getClosestPeersOffline(e,t){let n=[];try{let s=ze(e),a=cr(s),c=await this.components.peerStore.get(a,t);n.push({id:c.id,multiaddrs:c.addresses.map(({multiaddr:l})=>l)})}catch{}let o=await Xa(e,t),i=this.routingTable.closestPeers(o,t);for(let s of i)try{n.push(await this.components.peerStore.getInfo(s,t))}catch(a){if(a.name!=="NotFoundError")throw a}return n.length>0?this.log("getClosestPeersOffline returning the %d closest peer(s) %b we know",n.length,e):this.log("getClosestPeersOffline could not any peers close to %b with %d peers in the routing table",e,this.routingTable.size),n}};var C4=class{log;datastore;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:providers`),this.datastorePrefix=`${t.datastorePrefix}/provider`,this.datastore=e.datastore}async addProvider(e,t,n){this.log.trace("%p provides %s",t,e),await this.writeProviderEntry(e,t,n)}async removeProvider(e,t,n){let o=x4(this.datastorePrefix,e,t);this.log.trace("%p no longer provides %s",t,e),await this.datastore.delete(o,n)}async getProviders(e,t){this.log.trace("get providers for %c",e);let n=await this.loadProviders(e,t);return this.log.trace("got %d providers for %c",n.size,e),[...n.keys()]}async writeProviderEntry(e,t,n){let o=x4(this.datastorePrefix,e,t),i=br(n?.time?.getTime()??Date.now());await this.datastore.put(o,i,n)}async loadProviders(e,t){let n=new Jr,o=x4(this.datastorePrefix,e);for await(let i of this.datastore.query({prefix:o.toString()},t)){let{peerId:s}=w4(i.key);n.set(s,b4(i.value))}return n}};var NX=r=>{let e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function OX(r,e,t){let n,o=new Promise((i,s)=>{if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),c=[],{addListener:l,removeListener:u}=NX(r),f=(...d)=>{let m=t.multiArgs?d:d[0];t.filter&&!t.filter(m)||(c.push(m),t.count===c.length&&(n(),i(c)))},h=d=>{n(),s(d)};n=()=>{for(let d of a)u(d,f);for(let d of t.rejectionEvents)u(d,h)};for(let d of a)l(d,f);for(let d of t.rejectionEvents)l(d,h);t.signal&&t.signal.addEventListener("abort",()=>{h(t.signal.reason)},{once:!0}),t.resolveImmediately&&i(c)});if(o.cancel=n,typeof t.timeout=="number"){let i=Rs(o,{milliseconds:t.timeout});return i.cancel=n,i}return o}function BD(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=OX(r,e,t),o=n.then(i=>i[0]);return o.cancel=n.cancel,o}async function*MD(r){let{key:e,startingPeers:t,ourPeerId:n,query:o,alpha:i,path:s,numPaths:a,log:c,peersSeen:l,connectionManager:u,signal:f}=r,h=nr({objectMode:!0}),d=new _r({concurrency:i,sort:(w,x)=>Jl(w.options.distance,x.options.distance)});d.addEventListener("idle",()=>{h.push(CD({path:{index:s,queued:d.queued,running:d.running,total:d.size}},r)),h.end()}),d.addEventListener("error",w=>{c.error("error during query - %e",w.detail)}),f.addEventListener("abort",()=>{d.abort(),h.end(new Xe)});let m=await Xa(e,{signal:f});function g(w,x){if(w==null)return;l.add(w.id.toMultihash().bytes);let v=xi(x,m);d.add(async()=>{try{for await(let A of o({...r,key:e,peer:w,path:{index:s,queued:d.queued,running:d.running,total:d.size},numPaths:a,peerKadId:x,signal:f})){if(A.name==="PEER_RESPONSE")for(let S of A.closer){if(l.has(S.id.toMultihash().bytes)){c("already seen %p in query",S.id);continue}if(n.equals(S.id)){c("not querying ourselves");continue}if(!await u.isDialable(S.multiaddrs)){c("not querying undialable peer");continue}let _=await Bn(S.id,{signal:f}),U=xi(_,m);if(Jl(U,v)!==-1){c("skipping %p as they are not closer to %b than %p",S.id,e,w);continue}c("querying closer peer %p",S.id),g(S,_)}h.push({...A,path:{index:s,queued:d.queued,running:d.running,total:d.size}})}}catch(A){h.push(Ai({from:w.id,error:A,path:{index:s,queued:d.queued,running:d.running-1,total:d.size-1}},r))}},{distance:v}).catch(A=>{c.error("error during query - %e",A)})}await Promise.all(t.map(async w=>{g({id:w,multiaddrs:[]},await Bn(w,{signal:f}))})),yield*h}var I4=class{disjointPaths;alpha;shutDownController;running;logger;peerId;connectionManager;routingTable;initialQuerySelfHasRun;logPrefix;allowQueryWithZeroPeers;constructor(e,t){this.logPrefix=t.logPrefix,this.disjointPaths=t.disjointPaths??h4,this.alpha=t.alpha??ja,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.allowQueryWithZeroPeers=t.allowQueryWithZeroPeers??!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.running=!1}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal,void 0)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,n={}){if(!this.running)throw new Error("QueryManager not started");if(n.signal==null){let c=AbortSignal.timeout(AD);n={...n,signal:c}}let o=new AbortController,i=ke([this.shutDownController.signal,o.signal,n.signal]);o.signal;let s=this.logger.forComponent(`${this.logPrefix}:query:`+K(e,"base58btc")),a=!1;try{this.routingTable.size===0&&!this.allowQueryWithZeroPeers&&(s("routing table was empty, waiting for some peers before running%s query",n.isSelfQuery===!0?" self":""),await BD(this.routingTable,"peer:add",{signal:i,filter:d=>!this.peerId.equals(d.detail)}),s("routing table has peers, continuing with%s query",n.isSelfQuery===!0?" self":"")),n.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(s("waiting for initial self query before continuing"),await ut(this.initialQuerySelfHasRun.promise,i),this.initialQuerySelfHasRun=void 0),s("query:start");let c=await Xa(e,{signal:i}),l=this.routingTable.closestPeers(c,{count:this.routingTable.kBucketSize}),u=l.sort(()=>Math.random()>.5?1:-1).reduce((d,m,g)=>(d[g%this.disjointPaths].push(m),d),new Array(this.disjointPaths).fill(0).map(()=>[])).filter(d=>d.length>0);if(l.length===0){s.error("running query with no peers");return}let f=en(1024),h=u.map((d,m)=>MD({...n,key:e,startingPeers:d,ourPeerId:this.peerId,signal:i,query:t,path:m,numPaths:u.length,alpha:this.alpha,log:s,peersSeen:f,onProgress:n.onProgress,connectionManager:this.connectionManager}));for await(let d of fn(...h)){if(d.name==="QUERY_ERROR"&&s.error("query error",d.error),d.name==="PEER_RESPONSE")for(let m of[...d.closer,...d.providers])await this.connectionManager.isDialable(m.multiaddrs,{signal:i})&&await this.routingTable.add(m.id,{signal:i});i.throwIfAborted(),yield d}a=!0}catch(c){if(this.running)throw c}finally{a||(s("query exited early"),o.abort()),i.clear(),s("query finished")}}};function LX(r){return r[Symbol.asyncIterator]!=null}function BX(r){if(LX(r))return(async()=>{let e=0;for await(let t of r)e++;return e})();{let e=0;for(let t of r)e++;return e}}var T4=BX;var k4=class{log;peerId;peerRouting;events;count;interval;initialInterval;queryTimeout;running;timeoutId;controller;initialQuerySelfHasRun;querySelfPromise;constructor(e,t){this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:query-self`),this.events=e.events,this.running=!1,this.peerRouting=t.peerRouting,this.count=t.count??h4,this.interval=t.interval??yD,this.initialInterval=t.initialInterval??wD,this.queryTimeout=t.queryTimeout??xD,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.querySelf=v4(this.querySelf.bind(this),t.operationMetrics,"SELF_QUERY")}isStarted(){return this.running}start(){this.running||(this.running=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.initialInterval))}stop(){this.running=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.running){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=ve(),this.running){this.controller=new AbortController;let e=[this.controller.signal];if(this.initialQuerySelfHasRun==null){let n=AbortSignal.timeout(this.queryTimeout);e.push(n)}let t=ke(e);this.controller.signal;try{this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);let n=Date.now(),o=await pt(this.peerRouting.getClosestPeers(this.peerId.toMultihash().bytes,{signal:t,isSelfQuery:!0}),s=>xa(s,this.count),async s=>T4(s));t?.throwIfAborted();let i=Date.now()-n;this.log("self-query found %d peers in %dms",o,i),this.events.dispatchEvent(new CustomEvent("kad-dht:query:self",{detail:{peers:o,duration:i}}))}catch(n){this.log.error("self-query error",n)}finally{t.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.running&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.interval))}};var P4=class extends Re{log;reprovideQueue;maxQueueSize;datastore;timeout;reprovideTimeout;running;shutdownController;reprovideThreshold;contentRouting;datastorePrefix;addressManager;validity;interval;peerId;constructor(e,t){super(),this.log=e.logger.forComponent(`${t.logPrefix}:reprovider`),this.peerId=e.peerId,this.reprovideQueue=new _r({concurrency:t.concurrency??hD,metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_queue`}),this.reprovideTimeout=new wi({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_timeout_milliseconds`}),this.datastore=e.datastore,this.addressManager=e.addressManager,this.datastorePrefix=`${t.datastorePrefix}/provider`,this.reprovideThreshold=t.threshold??dD,this.maxQueueSize=t.maxQueueSize??pD,this.validity=t.validity??fD,this.interval=t.interval??mD,this.contentRouting=t.contentRouting,this.running=!1,this.reprovide=v4(this.reprovide.bind(this),t.operationMetrics,"PROVIDE")}start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,this.timeout=setTimeout(()=>{this.cleanUp({signal:AbortSignal.timeout(db)}).catch(e=>{this.log.error("error running reprovide/cleanup - %e",e)})},this.interval))}stop(){this.running=!1,this.reprovideQueue.clear(),clearTimeout(this.timeout),this.shutdownController?.abort()}async cleanUp(e){try{this.safeDispatchEvent("reprovide:start");for await(let t of this.datastore.query({prefix:this.datastorePrefix},e))try{let{cid:n,peerId:o}=w4(t.key),i=b4(t.value).getTime(),s=i+this.validity,a=Date.now(),c=a>s;this.log.trace("comparing: %d < %d = %s %s",i,a-this.validity,c,c?"(expired)":""),c&&await this.datastore.delete(t.key,e),this.peerId.equals(o)&&a-s<this.reprovideThreshold&&this.queueReprovide(n).catch(l=>{this.log.error("could not reprovide %c - %e",n,l)})}catch(n){this.log.error("error processing datastore key %s - %e",t.key,n.message)}this.log("reprovide/cleanup successful")}finally{this.safeDispatchEvent("reprovide:end"),this.running&&(this.timeout=setTimeout(()=>{this.cleanUp({signal:AbortSignal.timeout(db)}).catch(t=>{this.log.error("error running re-provide - %e",t)})},this.interval))}}async queueReprovide(e,t){if(!this.running)return;this.log.trace("waiting for queue capacity before adding %c to re-provide queue",e),await this.reprovideQueue.onSizeLessThan(this.maxQueueSize,t);let n=this.reprovideQueue.queue.find(o=>o.options.cid.equals(e));if(n!=null)return this.log.trace("not adding %c to re-provide queue - already in queue",e),n.join();this.log.trace("adding %c to re-provide queue",e),this.reprovideQueue.add(async o=>{if(o.signal?.throwIfAborted(),!this.running)return;this.log.trace("re-providing %c",e);let i=this.reprovideTimeout.getTimeoutSignal(o);try{await this.reprovide(o.cid,o)}finally{this.reprovideTimeout.cleanUp(i)}this.log.trace("re-provided %c",e)},{signal:this.shutdownController?.signal,cid:e}).catch(o=>{this.log.error("could not re-provide key %c - %e",e,o)})}async reprovide(e,t){await Gr(this.contentRouting.provide(e,this.addressManager.getAddresses(),t))}};var MX=20,UX=5e3,FX="kad-close",HX=50,R4=class{routingTable;components;closestPeers;newPeers;refreshInterval;peerSetSize;timeout;closeTagName;closeTagValue;log;running;constructor(e,t){this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.routingTable=t.routingTable,this.refreshInterval=t.refreshInterval??UX,this.peerSetSize=t.peerSetSize??MX,this.closeTagName=t.closeTagName??FX,this.closeTagValue=t.closeTagValue??HX,this.closestPeers=new ro,this.onPeerPing=this.onPeerPing.bind(this),this.running=!1}async start(){if(this.running)return;this.running=!0;let e=await Bn(this.components.peerId);this.newPeers=new Qa(e,this.peerSetSize),this.routingTable.addEventListener("peer:ping",this.onPeerPing),this.timeout=setInterval(()=>{this.updatePeerTags().catch(t=>{this.log.error("error updating peer tags - %e",t)})},this.refreshInterval)}stop(){this.running=!1,this.routingTable.removeEventListener("peer:ping",this.onPeerPing),clearTimeout(this.timeout)}onPeerPing(e){this.newPeers?.add({id:e.detail,multiaddrs:[]}).catch(t=>{this.log.error("error adding peer to distance list - %e",t)})}async updatePeerTags(){let e=new ro(this.newPeers?.peers.map(({peer:o})=>o.id)),t=e.difference(this.closestPeers),n=this.closestPeers.difference(e);this.closestPeers=e,await Promise.all([...[...t].map(async o=>{await this.components.peerStore.merge(o,{tags:{[this.closeTagName]:{value:this.closeTagValue},[hb]:{value:1}}})}),...[...n].map(async o=>{await this.components.peerStore.merge(o,{tags:{[this.closeTagName]:void 0,[hb]:void 0}})})])}};function Vm(r){return Array.isArray(r?.peers)}var D4=class{peerId;root;localPeer;prefixLength;splitThreshold;kBucketSize;numberOfNodesToPing;lastPingThreshold;ping;verify;onAdd;onRemove;onMove;addingPeerMap;constructor(e,t){this.peerId=e.peerId,this.prefixLength=t.prefixLength??UD,this.kBucketSize=t.kBucketSize??Km,this.splitThreshold=t.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=t.numberOfOldContactsToPing??FD,this.lastPingThreshold=t.lastPingThreshold??HD,this.ping=t.ping,this.verify=t.verify,this.onAdd=t.onAdd,this.onRemove=t.onRemove,this.addingPeerMap=ks({name:`${t.metricsPrefix}_adding_peer_map`,metrics:e.metrics}),this.root={prefix:"",depth:0,peers:[]}}async start(){await this.addSelfPeer(this.peerId)}stop(){this.addingPeerMap.clear(),this.root={prefix:"",depth:0,peers:[]}}async addSelfPeer(e,t){this.localPeer={peerId:e,kadId:await Bn(e,t),lastPing:Date.now()}}async add(e,t){let n={peerId:e,kadId:await Bn(e,t),lastPing:0},o=this.addingPeerMap.get(e);if(o!=null)return o;try{let i=this._add(n,t);this.addingPeerMap.set(e,i),await i}finally{this.addingPeerMap.delete(e)}}async _add(e,t){let n=this._determineBucket(e.kadId);if(this._indexOf(n,e.kadId)>-1)return;if(n.peers.length===this.splitThreshold&&n.depth<this.prefixLength){await this._split(n,t),await this._add(e,t);return}if(n.peers.length<this.kBucketSize){if(!VX(e,this.lastPingThreshold)){n.peers.push(e),await this.onAdd?.(e,n,t);return}await this.verify(e,t)&&(e.lastPing=Date.now(),await this._add(e,t));return}let o=n.peers.filter(s=>!(s.peerId.equals(this.localPeer?.peerId)||s.lastPing>Date.now()-this.lastPingThreshold)).sort((s,a)=>s.lastPing<a.lastPing?-1:s.lastPing>a.lastPing?1:0).slice(0,this.numberOfNodesToPing),i=!1;for await(let s of this.ping(o,t))i=!0,await this.remove(s.kadId,t);i&&await this._add(e,t)}*closest(e,t){let n=new Qa(e,t?.count??this.kBucketSize);for(let o of this.toIterable())t?.exclude?.some(i=>i.equals(o.peerId))!==!0&&n.addWithKadId({id:o.peerId,multiaddrs:[]},o.kadId);yield*Ht(n.peers,({peer:o})=>o.id)}count(){function e(t){if(Vm(t))return t.peers.length;let n=0;return t.left!=null&&(n+=e(t.left)),t.right!=null&&(n+=e(t.right)),n}return e(this.root)}get(e){let t=this._determineBucket(e),n=this._indexOf(t,e);return t.peers[n]}async remove(e,t){let n=this._determineBucket(e),o=this._indexOf(n,e);if(o>-1){let i=n.peers.splice(o,1)[0];await this.onRemove?.(i,n,t)}}*toIterable(){function*e(t){if(Vm(t)){yield*t.peers;return}yield*e(t.left),yield*e(t.right)}yield*e(this.root)}distance(e,t){return BigInt("0x"+K(xi(e,t),"base16"))}_determineBucket(e){let t=K(e,"base2");function n(o,i=0){return Vm(o)?o:t[i]==="0"?n(o.left,i+1):n(o.right,i+1)}return n(this.root)}_indexOf(e,t){return e.peers.findIndex(n=>de(n.kadId,t))}async _split(e,t){let n={prefix:"0",depth:e.depth+1,peers:[]},o={prefix:"1",depth:e.depth+1,peers:[]};for(let i of e.peers)K(i.kadId,"base2")[e.depth]==="0"?(n.peers.push(i),await this.onMove?.(i,e,n,t)):(o.peers.push(i),await this.onMove?.(i,e,o,t));$X(e,n,o)}};function $X(r,e,t){return delete r.peers,r.left=e,r.right=t,r.prefix===""&&(delete r.depth,delete r.prefix),!0}function VX(r,e){return r.lastPing<Date.now()-e}var Km=20,UD=6;var KX=20,zX=100,FD=3;var qX=20,jX=100,$D="kad-peer",WX=1,HD=6e5,GX=!0,XX=1e3,N4=class extends Re{kBucketSize;kb;network;closestPeerTagger;log;components;running;pingNewContactTimeout;pingNewContactQueue;pingOldContactTimeout;pingOldContactQueue;populateFromDatastoreOnStart;populateFromDatastoreLimit;protocol;peerTagName;peerTagValue;metrics;shutdownController;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.kBucketSize=t.kBucketSize??Km,this.running=!1,this.protocol=t.protocol,this.network=t.network,this.peerTagName=t.peerTagName??$D,this.peerTagValue=t.peerTagValue??WX,this.pingOldContacts=this.pingOldContacts.bind(this),this.verifyNewContact=this.verifyNewContact.bind(this),this.peerAdded=this.peerAdded.bind(this),this.peerRemoved=this.peerRemoved.bind(this),this.populateFromDatastoreOnStart=t.populateFromDatastoreOnStart??GX,this.populateFromDatastoreLimit=t.populateFromDatastoreLimit??XX,this.shutdownController=new AbortController,this.pingOldContactQueue=new Cr({concurrency:t.pingOldContactConcurrency??qX,metricName:`${t.metricsPrefix}_ping_old_contact_queue`,metrics:this.components.metrics,maxSize:t.pingOldContactMaxQueueSize??jX}),this.pingOldContactTimeout=new wi({...t.pingOldContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_old_contact_time_milliseconds`}),this.pingNewContactQueue=new Cr({concurrency:t.pingNewContactConcurrency??KX,metricName:`${t.metricsPrefix}_ping_new_contact_queue`,metrics:this.components.metrics,maxSize:t.pingNewContactMaxQueueSize??zX}),this.pingNewContactTimeout=new wi({...t.pingNewContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_new_contact_time_milliseconds`}),this.kb=new D4(e,{kBucketSize:t.kBucketSize,prefixLength:t.prefixLength,splitThreshold:t.splitThreshold,numberOfOldContactsToPing:t.numberOfOldContactsToPing,lastPingThreshold:t.lastPingThreshold,ping:this.pingOldContacts,verify:this.verifyNewContact,onAdd:this.peerAdded,onRemove:this.peerRemoved,metricsPrefix:t.metricsPrefix}),this.closestPeerTagger=new R4(this.components,{logPrefix:t.logPrefix,routingTable:this,peerSetSize:t.closestPeerSetSize,refreshInterval:t.closestPeerSetRefreshInterval,closeTagName:t.closeTagName,closeTagValue:t.closeTagValue}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMinOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_min_occupancy`),routingTableKadBucketMaxOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_depth`),kadBucketEvents:this.components.metrics.registerCounterGroup(`${t.metricsPrefix}_kad_bucket_events_total`)})}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutdownController=new AbortController,await Sr(this.closestPeerTagger,this.kb))}async afterStart(){let e=0;Promise.resolve().then(async()=>{if(!this.populateFromDatastoreOnStart)return;let t=ke([this.shutdownController.signal,AbortSignal.timeout(2e4)]);try{for(let n of await this.components.peerStore.all({filters:[o=>o.protocols.includes(this.protocol)&&o.tags.has($D)],limit:this.populateFromDatastoreLimit,signal:t})){if(!this.running)return;try{await this.add(n.id,{signal:t}),e++}catch{this.log("failed to add peer %p to routing table, removing kad-dht peer tags - %e"),await this.components.peerStore.merge(n.id,{tags:{[this.peerTagName]:void 0}})}}}finally{t.clear()}this.log("added %d peer store peers to the routing table",e)}).catch(t=>{this.log.error("error adding %d, peer store peers to the routing table - %e",e,t)})}async stop(){this.running=!1,await Wr(this.closestPeerTagger,this.kb),this.pingOldContactQueue.abort(),this.pingNewContactQueue.abort(),this.shutdownController.abort()}async peerAdded(e,t,n){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:{value:this.peerTagValue}}},n),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_added:!0}),this.safeDispatchEvent("peer:add",{detail:e.peerId})}async peerRemoved(e,t,n){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:void 0}},n),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_removed:!0}),this.safeDispatchEvent("peer:remove",{detail:e.peerId})}async*pingOldContacts(e,t){if(!this.running)return;let n=[];for(let o of e){if(this.kb.get(o.kadId)==null){this.log("asked to ping contact %p that was not in routing table",o.peerId);continue}this.metrics?.kadBucketEvents.increment({ping_old_contact:!0}),n.push(async()=>{let i=this.pingOldContactQueue.find(o.peerId);if(i!=null)return this.log("asked to ping contact %p was already being pinged",o.peerId),await i.join(t)?void 0:o;if(!await this.pingOldContactQueue.add(async a=>{let c=this.pingOldContactTimeout.getTimeoutSignal(),l=ke([c,this.shutdownController.signal,a?.signal]);try{return await this.pingContact(o,a)}catch{return this.metrics?.kadBucketEvents.increment({ping_old_contact_error:!0}),!0}finally{this.pingOldContactTimeout.cleanUp(c),l.clear()}},{peerId:o.peerId,signal:t?.signal}))return o})}for await(let o of En(n))o!=null&&(yield o)}async verifyNewContact(e,t){let n=this.pingNewContactTimeout.getTimeoutSignal(),o=ke([n,this.shutdownController.signal,t?.signal]);try{let i=this.pingNewContactQueue.find(e.peerId);return i!=null?(this.log("joining existing ping to add new peer %p to routing table",e.peerId),await i.join({signal:o})):await this.pingNewContactQueue.add(async s=>(this.metrics?.kadBucketEvents.increment({ping_new_contact:!0}),this.log("pinging new peer %p before adding to routing table",e.peerId),this.pingContact(e,s)),{peerId:e.peerId,signal:o})}catch{return this.log.trace("tried to add peer %p but they were not online",e.peerId),this.metrics?.kadBucketEvents.increment({ping_new_contact_error:!0}),!1}finally{this.pingNewContactTimeout.cleanUp(n),o.clear()}}async pingContact(e,t){let n;try{return this.log("pinging contact %p",e.peerId),await this.components.ping.ping(e.peerId,t),this.log("contact %p ping ok",e.peerId),this.safeDispatchEvent("peer:ping",{detail:e.peerId}),!0}catch(o){return this.log("error pinging old contact %p - %e",e.peerId,o),n?.abort(o),!1}}get size(){return this.kb==null?0:this.kb.count()}async find(e,t){let n=await Bn(e,t);return this.kb.get(n)?.peerId}closestPeer(e){let t=this.closestPeers(e,{count:1});if(t.length>0)return t[0]}closestPeers(e,t){return this.kb==null?[]:[...this.kb.closest(e,t)]}async add(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");await this.kb.add(e,t)}async remove(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");let n=await Bn(e,t);await this.kb.remove(n,t)}updateMetrics(){if(this.metrics==null||this.kb==null)return;let e=0,t=0,n=0,o=20,i=0;function s(a){if(Vm(a)){a.depth>n&&(n=a.depth),t++,e+=a.peers.length,a.peers.length<o&&(o=a.peers.length),a.peers.length>i&&(i=a.peers.length);return}s(a.left),s(a.right)}s(this.kb.root),this.metrics.routingTableSize.update(e),this.metrics.routingTableKadBucketTotal.update(t),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(e/t)),this.metrics.routingTableKadBucketMinOccupancy.update(o),this.metrics.routingTableKadBucketMaxOccupancy.update(i),this.metrics.routingTableKadBucketMaxDepth.update(n)}};var VD=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782];var O4=15,L4=class{log;peerRouting;routingTable;refreshInterval;refreshQueryTimeout;commonPrefixLengthRefreshedAt;refreshTimeoutId;constructor(e,t){let{peerRouting:n,routingTable:o,refreshInterval:i,refreshQueryTimeout:s,logPrefix:a}=t;this.log=e.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=n,this.routingTable=o,this.refreshInterval=i??bD,this.refreshQueryTimeout=s??vD,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1,t){this.log("refreshing routing table");let n=this._maxCommonPrefix(),o=this._getTrackedCommonPrefixLengthsForRefresh(n);this.log(`max common prefix length ${n}`),this.log(`tracked CPLs [ ${o.map(i=>i.toISOString()).join(", ")} ]`),Promise.all(o.map(async(i,s)=>{try{if(await this._refreshCommonPrefixLength(s,i,e,t),this._numPeersForCpl(n)===0){let a=Math.min(2*(s+1),o.length-1);for(let c=s+1;c<a+1;c++)try{await this._refreshCommonPrefixLength(c,i,e,t)}catch(l){this.log.error(l)}}}catch(a){this.log.error(a)}})).catch(i=>{this.log.error(i)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(i=>{this.log.error(i)})}async _refreshCommonPrefixLength(e,t,n,o){if(!n&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}let i=this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,i,this.routingTable.size);let s=ke([o?.signal,AbortSignal.timeout(this.refreshQueryTimeout)]);try{let a=await T4(this.peerRouting.getClosestPeers(i.toMultihash().bytes,{signal:s}));this.log(`found ${a} peers that were close to imaginary peer %p`,i),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,i,this.routingTable.size)}finally{s.clear()}}_getTrackedCommonPrefixLengthsForRefresh(e){e>O4&&(e=O4);let t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}_generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");if(this.routingTable.kb.localPeer==null)throw new Error("Local peer not set");let t=gn(2),n=(t[1]<<8)+t[0],o=this._makePeerId(this.routingTable.kb.localPeer.kadId,n,e),i=ze(o);return cr(i)}_makePeerId(e,t,n){if(n>O4)throw new Error(`Cannot generate peer ID for common prefix length greater than ${O4}`);let s=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>n,a=65535<<16-(n+1),c=s&a|t&~a,l=VD[c],u=new ArrayBuffer(34),f=new DataView(u,0,u.byteLength);return f.setUint8(0,De.code),f.setUint8(1,32),f.setUint32(2,l,!1),new Uint8Array(f.buffer,f.byteOffset,f.byteLength)}_maxCommonPrefix(){let e=0;for(let t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(let n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb?.localPeer!=null)for(let{kadId:e}of this.routingTable.kb.toIterable()){let t=xi(this.routingTable.kb.localPeer.kadId,e),n=0;for(let o of t)if(o===0)n++;else break;yield n}}};var B4=class{peerId;providers;peerStore;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.peerId=e.peerId,this.providers=t.providers,this.peerStore=e.peerStore}async handle(e,t){if(t.key==null||t.key.length===0)throw new Oe("Missing key");let n;try{n=q.decode(t.key)}catch{throw new Oe("Invalid CID")}(t.providers==null||t.providers.length===0)&&this.log.error("no providers found in message"),this.log("%p asked us, %p to store provider record for for %c",e,this.peerId,n),await Promise.all(t.providers.map(async o=>{let i=ze(o.id),s=cr(i),a=o.multiaddrs.map(c=>ne(c));if(!e.equals(s)){this.log("invalid provider peer %p from %p",o.id,e);return}if(o.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",e);return}this.log.trace("received provider %p for %s (addrs %s)",e,n,a),await this.providers.addProvider(n,s),await this.peerStore.merge(s,{multiaddrs:a})}))}};var M4=class{peerRouting;peerInfoMapper;peerId;addressManager;log;constructor(e,t){let{peerRouting:n,logPrefix:o}=t;this.log=e.logger.forComponent(`${o}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=n,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){this.log("incoming request from %p for peers close to %b",e,t.key);try{if(t.key==null)throw new Oe("Invalid FIND_NODE message received - key was missing");let n=await this.peerRouting.getClosestPeersOffline(t.key,{exclude:[e,this.peerId]});de(this.peerId.toMultihash().bytes,t.key)&&n.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(i=>i.decapsulateCode(It("p2p").code))});let o={type:nt.FIND_NODE,clusterLevel:t.clusterLevel,closer:n.map(this.peerInfoMapper).filter(({multiaddrs:i})=>i.length).map(i=>({id:i.id.toMultihash().bytes,multiaddrs:i.multiaddrs.map(s=>s.bytes)})),providers:[]};return o.closer.length===0?this.log("could not find any peers closer to %b for %p",t.key,e):this.log("found %d peers close to %b for %p",o.closer.length,t.key,e),o}catch(n){throw this.log("error during finding peers closer to %b for %p - %e",t.key,e,n),n}}};var U4=class{peerId;peerRouting;providers;peerStore;peerInfoMapper;log;constructor(e,t){let{peerRouting:n,providers:o,logPrefix:i}=t;this.log=e.logger.forComponent(`${i}:rpc:handlers:get-providers`),this.peerId=e.peerId,this.peerStore=e.peerStore,this.peerRouting=n,this.providers=o,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(t.key==null)throw new Oe("Invalid GET_PROVIDERS message received - key was missing");let n;try{n=q.decode(t.key)}catch{throw new Oe("Invalid CID")}this.log("%p asking for providers for %s",e,n);let[o,i]=await Promise.all([Vs(Ht(await this.providers.getProviders(n),async a=>{let c=await this.peerStore.get(a);return{id:c.id,multiaddrs:c.addresses.map(({multiaddr:u})=>u)}})),this.peerRouting.getClosestPeersOffline(t.key)]),s={type:nt.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:i.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)})),providers:o.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))};return this.log("got %s providers %s closerPeers",s.providers.length,s.closer.length),s}async _getAddresses(e){return[]}};var F4=class{peerStore;datastore;peerRouting;log;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){let n=t.key;if(this.log("%p asked for key %b",e,n),n==null||n.length===0)throw new Oe("Invalid key");let o={type:nt.GET_VALUE,key:n,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(DD(n)){this.log("is public key");let a=ND(n),c;try{let l=await this.peerStore.get(a);if(l.id.publicKey==null)throw new $e("No public key found in key book");c=sr(l.id.publicKey)}catch(l){if(l.name!=="NotFoundError")throw l}if(c!=null)return this.log("returning found public key"),o.record=new Pt(n,c,new Date).serialize(),o}let[i,s]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getClosestPeersOffline(n)]);return i!=null&&(this.log("had record for %b in local datastore",n),o.record=i.serialize()),s.length>0&&(this.log("had %s closer peers in routing table",s.length),o.closer=s.map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))),o}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);let t=Ya(this.datastorePrefix,e),n;try{n=await this.datastore.get(t)}catch(i){if(i.name==="NotFoundError")return;throw i}let o=Pt.deserialize(n);if(o.timeReceived==null||Date.now()-o.timeReceived.getTime()>lD){await this.datastore.delete(t);return}return o}};var H4=class{log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}};var $4=class{components;validators;log;datastorePrefix;constructor(e,t){let{validators:n}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n}async handle(e,t){let n=t.key;if(this.log("%p asked us to store value for key %b",e,n),t.record==null){let o=`Empty record from: ${e.toString()}`;throw this.log.error(o),new Oe(o)}try{let o=Pt.deserialize(t.record);await Rd(this.validators,o),o.timeReceived=new Date;let i=Ya(this.datastorePrefix,o.key);await this.components.datastore.put(i,o.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,i)}catch(o){this.log("did not put record for key %b into datastore %o",n,o)}return t}};var V4=class{handlers;log;metrics;incomingMessageTimeout;constructor(e,t){this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_errors_total`),rpcTime:e.metrics?.registerMetricGroup(`${t.metricsPrefix}_inbound_rpc_time_seconds`,{label:"operation"})},this.log=e.logger.forComponent(`${t.logPrefix}:rpc`),this.incomingMessageTimeout=t.incomingMessageTimeout??1e4,this.handlers={[nt.GET_VALUE.toString()]:new F4(e,t),[nt.PUT_VALUE.toString()]:new $4(e,t),[nt.FIND_NODE.toString()]:new M4(e,t),[nt.ADD_PROVIDER.toString()]:new B4(e,t),[nt.GET_PROVIDERS.toString()]:new U4(e,t),[nt.PING.toString()]:new H4(e,t)}}async handleMessage(e,t){let n=this.handlers[t.type];if(n==null){this.log.error(`no handler found for message type: ${t.type}`);return}try{return this.metrics.operations?.increment({[t.type]:!0}),await n.handle(e,t)}catch{this.metrics.errors?.increment({[t.type]:!0})}}onIncomingStream(e){let t="unknown";Promise.resolve().then(async()=>{let{stream:n,connection:o}=e,i=()=>{n.abort(new Ao)},s=AbortSignal.timeout(this.incomingMessageTimeout);s.addEventListener("abort",i);let a=vt(n).pb(Ga);try{for(;;){let c=await a.read({signal:s}),l=this.metrics?.rpcTime?.timer(c.type.toString()),u=this.metrics?.rpcTime?.timer(c.type.toString()),f=!1;try{this.log("incoming %s from %p",c.type,o.remotePeer);let h=await this.handleMessage(o.remotePeer,c);h!=null&&await a.write(h,{signal:s})}catch(h){throw f=!0,u?.(),h}finally{f||l?.()}s.removeEventListener("abort",i),s=AbortSignal.timeout(this.incomingMessageTimeout),s.addEventListener("abort",i)}}catch(c){n.abort(c)}}).catch(n=>{this.log.error("error handling %s RPC message from %p - %e",t,e.connection.remotePeer,n)})}};var K4=class extends Re{log;components;protocol;running;registrarId;constructor(e,t){super();let{protocol:n,logPrefix:o}=t;this.components=e,this.log=e.logger.forComponent(`${o}:topology-listener`),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new CustomEvent("peer",{detail:e}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}};var xb=class{dht;constructor(e){this.dht=e}async provide(e,t={}){await Gr(this.dht.provide(e,t))}async cancelReprovide(e){await this.dht.cancelReprovide(e)}async*findProviders(e,t={}){for await(let n of this.dht.findProviders(e,t))n.name==="PROVIDER"&&(yield*n.providers)}async put(e,t,n){await Gr(this.dht.put(e,t,n))}async get(e,t){for await(let n of this.dht.get(e,t))if(n.name==="VALUE")return n.value;throw new $e("Could not find value for key")}},bb=class{dht;constructor(e){this.dht=e}async findPeer(e,t={}){for await(let n of this.dht.findPeer(e,t))if(n.name==="FINAL_PEER")return n.peer;throw new $e("Peer not found")}async*getClosestPeers(e,t={}){for await(let n of this.dht.getClosestPeers(e,t))n.name==="FINAL_PEER"&&(yield n.peer)}},YX=32,QX=64,z4=class extends Re{k;a;d;protocol;routingTable;providers;network;peerRouting;components;log;running;clientMode;validators;selectors;queryManager;contentFetching;contentRouting;routingTableRefresh;rpc;topologyListener;querySelf;maxInboundStreams;maxOutboundStreams;dhtContentRouting;dhtPeerRouting;peerInfoMapper;reprovider;onPeerConnectTimeout;constructor(e,t={}){super();let n=t.logPrefix??"libp2p:kad-dht",o=t.datastorePrefix??"/dht",i=t.metricsPrefix??"libp2p_kad_dht",s={queries:e.metrics?.registerMetricGroup(`${i}_operations_total`,{label:"operation"}),errors:e.metrics?.registerCounterGroup(`${i}_operation_errors_total`,{label:"operation"}),queryTime:e.metrics?.registerMetricGroup(`${i}_operation_time_seconds`,{label:"operation"}),errorTime:e.metrics?.registerMetricGroup(`${i}_operation_error_time_seconds`,{label:"operation"})};this.running=!1,this.components=e,this.log=e.logger.forComponent(n),this.k=t.kBucketSize??Km,this.a=t.alpha??ja,this.d=t.disjointPaths??this.a,this.protocol=t.protocol??uD,this.clientMode=t.clientMode??!0,this.maxInboundStreams=t.maxInboundStreams??YX,this.maxOutboundStreams=t.maxOutboundStreams??QX,this.peerInfoMapper=t.peerInfoMapper??PD,this.onPeerConnectTimeout=t.onPeerConnectTimeout??gD,this.providers=new C4(e,{...t.providers,logPrefix:n,datastorePrefix:o}),this.validators={...kD,...t.validators},this.selectors={...TD,...t.selectors},this.network=new S4(e,{protocol:this.protocol,logPrefix:n,metricsPrefix:i}),this.routingTable=new N4(e,{kBucketSize:this.k,pingOldContactTimeout:t.pingOldContactTimeout,pingOldContactConcurrency:t.pingOldContactConcurrency,pingOldContactMaxQueueSize:t.pingOldContactMaxQueueSize,pingNewContactTimeout:t.pingNewContactTimeout,pingNewContactConcurrency:t.pingNewContactConcurrency,pingNewContactMaxQueueSize:t.pingNewContactMaxQueueSize,protocol:this.protocol,logPrefix:n,metricsPrefix:i,prefixLength:t.prefixLength,splitThreshold:t.kBucketSplitThreshold,network:this.network});let a=ve();t.allowQueryWithZeroPeers===!0&&a.resolve(),this.queryManager=new I4(e,{disjointPaths:this.d,alpha:this.a,logPrefix:n,metricsPrefix:i,initialQuerySelfHasRun:a,routingTable:this.routingTable,allowQueryWithZeroPeers:t.allowQueryWithZeroPeers}),this.peerRouting=new _4(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:n}),this.contentFetching=new A4(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:n,datastorePrefix:o}),this.contentRouting=new E4(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:n}),this.routingTableRefresh=new L4(e,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:n}),this.rpc=new V4(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:n,metricsPrefix:i,datastorePrefix:o,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new K4(e,{protocol:this.protocol,logPrefix:n}),this.querySelf=new k4(e,{peerRouting:this.peerRouting,interval:t.querySelfInterval,initialInterval:t.initialQuerySelfInterval,logPrefix:n,initialQuerySelfHasRun:a,operationMetrics:s}),this.reprovider=new P4(e,{...t.reprovide,logPrefix:n,metricsPrefix:i,datastorePrefix:o,contentRouting:this.contentRouting,operationMetrics:s}),this.network.addEventListener("peer",c=>{let l=c.detail;this.onPeerConnect(l).catch(u=>{this.log.error("could not add %p to routing table",l.id,u)}),this.dispatchEvent(new CustomEvent("peer",{detail:l}))}),this.topologyListener.addEventListener("peer",c=>{let l=c.detail;Promise.resolve().then(async()=>{let u=await this.components.peerStore.get(l),f={id:l,multiaddrs:u.addresses.map(({multiaddr:h})=>h),protocols:u.protocols};await this.onPeerConnect(f)}).catch(u=>{this.log.error("could not add %p to routing table - %e - %e",l,u)})}),this.dhtPeerRouting=new bb(this),this.dhtContentRouting=new xb(this),t.clientMode==null&&e.events.addEventListener("self:peer:update",c=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{let l=c.detail.peer.addresses.some(({multiaddr:f})=>OD(f)),u=this.getMode();l&&u==="client"?await this.setMode("server"):u==="server"&&!l&&await this.setMode("client")}).catch(l=>{this.log.error("error setting dht server mode",l)})}),this.get=Zl(this.get.bind(this),s,"GET_VALUE"),this.findProviders=Zl(this.findProviders.bind(this),s,"FIND_PROVIDERS"),this.findPeer=Zl(this.findPeer.bind(this),s,"FIND_PEER"),this.getClosestPeers=Zl(this.getClosestPeers.bind(this),s,"GET_CLOSEST_PEERS"),this.provide=Zl(this.provide.bind(this),s,"PROVIDE"),this.put=Zl(this.put.bind(this),s,"PUT_VALUE")}[Symbol.toStringTag]="@libp2p/kad-dht";[Ye]=["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery","@libp2p/kad-dht"];[Qn]=["@libp2p/identify","@libp2p/ping"];get[Ni](){return this.dhtContentRouting}get[Oi](){return this.dhtPeerRouting}get[Rc](){return this}async onPeerConnect(e){if(this.log.trace("peer %p connected",e.id),e=this.peerInfoMapper(e),e.multiaddrs.length===0){this.log.trace("ignoring %p as there were no valid addresses in %s after filtering",e.id,e.multiaddrs.map(n=>n.toString()));return}let t=AbortSignal.timeout(this.onPeerConnectTimeout);try{await this.routingTable.add(e.id,{signal:t})}catch(n){this.log.error("could not add %p to routing table",e.id,n)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(e,t){if(e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}if(await this.components.registrar.unhandle(this.protocol,t),e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}e==="client"?(this.log("enabling client mode while in %s mode",this.getMode()),this.clientMode=!0):(this.log("enabling server mode while in %s mode",this.getMode()),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{signal:t?.signal,maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running||(this.running=!0,await this.setMode(this.clientMode?"client":"server",{force:!0}),await Sr(this.routingTable,this.queryManager,this.network,this.topologyListener,this.routingTableRefresh,this.reprovider),await Sr(this.querySelf))}async stop(){this.running=!1,await Wr(this.querySelf,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener,this.reprovider)}async*put(e,t,n={}){yield*this.contentFetching.put(e,t,n)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async cancelReprovide(e,t){await this.providers.removeProvider(e,this.components.peerId,t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(e){this.routingTableRefresh.refreshTable(!0,e)}};var KD;(function(r){r[r.SEND_QUERY=0]="SEND_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADD_PEER=6]="ADD_PEER",r[r.DIAL_PEER=7]="DIAL_PEER",r[r.PATH_ENDED=8]="PATH_ENDED"})(KD||(KD={}));function zD(r={}){return e=>new z4(e,r)}var qe;(function(r){r[r.NEW_STREAM=0]="NEW_STREAM",r[r.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",r[r.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",r[r.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",r[r.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",r[r.RESET_RECEIVER=5]="RESET_RECEIVER",r[r.RESET_INITIATOR=6]="RESET_INITIATOR"})(qe||(qe={}));var zm=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),vb=Object.freeze({NEW_STREAM:qe.NEW_STREAM,MESSAGE:qe.MESSAGE_INITIATOR,CLOSE:qe.CLOSE_INITIATOR,RESET:qe.RESET_INITIATOR}),qD=Object.freeze({MESSAGE:qe.MESSAGE_RECEIVER,CLOSE:qe.CLOSE_RECEIVER,RESET:qe.RESET_RECEIVER});var Ab=1<<20,ZX=4<<20,q4=class{_buffer;_headerInfo;_maxMessageSize;_maxUnprocessedMessageQueueSize;constructor(e=Ab,t=ZX){this._buffer=new pe,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw new Oe("Unprocessed message queue size too large!");let t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(l){if(l.name==="InvalidMessageError")throw l;break}let{id:n,type:o,length:i,offset:s}=this._headerInfo;if(this._buffer.length-s<i)break;let c={id:n,type:o};(o===qe.NEW_STREAM||o===qe.MESSAGE_INITIATOR||o===qe.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(s,s+i)),t.push(c),this._buffer.consume(s+i),this._headerInfo=null}return t}_decodeHeader(e){let{value:t,offset:n}=WD(e),{value:o,offset:i}=WD(e,n),s=t&7;if(zm[s]==null)throw new Error(`Invalid type received: ${s}`);if(o>this._maxMessageSize)throw new Oe("Message size too large");return{id:t>>3,type:s,offset:n+i,length:o}}},JX=128,jD=127;function WD(r,e=0){let t=0,n=0,o=e,i,s=r.length;do{if(o>=s||n>49)throw e=0,new RangeError("Could not decode varint");i=r.get(o++),t+=n<28?(i&jD)<<n:(i&jD)*Math.pow(2,n),n+=7}while(i>=JX);return e=o-e,{value:t,offset:e}}var Eb=10*1024,Sb=class{_pool;_poolOffset;constructor(){this._pool=Ot(Eb),this._poolOffset=0}write(e,t){let n=this._pool,o=this._poolOffset;br(e.id<<3|e.type,n,o),o+=Ke(e.id<<3|e.type),(e.type===qe.NEW_STREAM||e.type===qe.MESSAGE_INITIATOR||e.type===qe.MESSAGE_RECEIVER)&&e.data!=null?(br(e.data.length,n,o),o+=Ke(e.data.length)):(br(0,n,o),o+=Ke(0));let i=n.subarray(this._poolOffset,o);Eb-o<100?(this._pool=Ot(Eb),this._poolOffset=0):this._poolOffset=o,t.append(i),(e.type===qe.NEW_STREAM||e.type===qe.MESSAGE_INITIATOR||e.type===qe.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}},eY=new Sb;async function*GD(r){for await(let e of r){let t=new pe;eY.write(e,t),yield t}}var j4=class extends Error{constructor(e="Stream input buffer error"){super(e),this.name="StreamInputBufferError"}};var _b=class extends Va{name;streamId;send;types;maxDataSize;constructor(e){super(e),this.types=e.direction==="outbound"?vb:qD,this.send=e.send,this.name=e.name,this.streamId=e.streamId,this.maxDataSize=e.maxDataSize}async sendNewStream(){await this.send({id:this.streamId,type:vb.NEW_STREAM,data:new pe(L(this.name))})}async sendData(e){for(e=e.sublist();e.byteLength>0;){let t=Math.min(e.byteLength,this.maxDataSize);await this.send({id:this.streamId,type:this.types.MESSAGE,data:e.sublist(0,t)}),e.consume(t)}}async sendReset(){await this.send({id:this.streamId,type:this.types.RESET})}async sendCloseWrite(){await this.send({id:this.streamId,type:this.types.CLOSE})}async sendCloseRead(){}};function XD(r){let{id:e,name:t,send:n,onEnd:o,type:i="initiator",maxMsgSize:s=Ab}=r;return new _b({id:i==="initiator"?`i${e}`:`r${e}`,streamId:e,name:`${t??e}`,direction:i==="initiator"?"outbound":"inbound",maxDataSize:s,onEnd:o,send:n,log:r.logger.forComponent(`libp2p:mplex:stream:${i}:${e}`)})}var tY=1024,rY=1024,nY=1024*1024*4,oY=5,iY=500;function YD(r){let e={...r,type:`${zm[r.type]} (${r.type})`};return r.type===qe.NEW_STREAM&&(e.data=K(r.data instanceof Uint8Array?r.data:r.data.subarray())),(r.type===qe.MESSAGE_INITIATOR||r.type===qe.MESSAGE_RECEIVER)&&(e.data=K(r.data instanceof Uint8Array?r.data:r.data.subarray(),"base16")),e}var W4=class{protocol="/mplex/6.7.0";sink;source;log;_streamId;_streams;_init;_source;closeController;rateLimiter;closeTimeout;logger;constructor(e,t){t=t??{},this.log=e.logger.forComponent("libp2p:mplex"),this.logger=e.logger,this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=t,this.closeTimeout=t.closeTimeout??iY,this.sink=this._createSink(),this._source=nr({objectMode:!0,onEnd:()=>{for(let n of this._streams.initiators.values())n.destroy();for(let n of this._streams.receivers.values())n.destroy()}}),this.source=pt(this._source,n=>GD(n)),this.closeController=new AbortController,this.rateLimiter=new md({points:t.disconnectThreshold??oY,duration:1})}get streams(){let e=[];for(let t of this._streams.initiators.values())e.push(t);for(let t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new Li("Muxer already closed");let t=this._streamId++;e=e==null?t.toString():e.toString();let n=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:n})}async close(e){if(this.closeController.signal.aborted)return;let t=e?.signal??AbortSignal.timeout(this.closeTimeout);try{await Promise.all(this.streams.map(async n=>n.close({signal:t}))),this._source.end(),await this._source.onEmpty({signal:t}),this.closeController.abort()}catch(n){this.abort(n)}}abort(e){this.closeController.signal.aborted||(this.streams.forEach(t=>{t.abort(e)}),this.closeController.abort(e))}_newReceiverStream(e){let{id:t,name:n}=e,o=this._streams.receivers;return this._newStream({id:t,name:n,type:"receiver",registry:o})}_newStream(e){let{id:t,name:n,type:o,registry:i}=e;if(this.log("new %s stream %s",o,t),o==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??rY))throw new wa("Too many outbound streams open");if(i.has(t))throw new Error(`${o} stream ${t} already exists!`);let c=XD({id:t,name:n,send:async l=>{this.log.enabled&&this.log.trace("%s stream %s send",o,t,YD(l)),this._source.push(l)},type:o,onEnd:()=>{this.log("%s stream with id %s and protocol %s ended",o,t,c.protocol),i.delete(t),this._init.onStreamEnd!=null&&this._init.onStreamEnd(c)},maxMsgSize:this._init.maxMsgSize,logger:this.logger});return i.set(t,c),c}_createSink(){return async t=>{let n=()=>{V3(t,this.log)};this.closeController.signal.addEventListener("abort",n);try{let o=new q4(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(let i of t)for(let s of o.write(i))await this._handleIncoming(s);this._source.end()}catch(o){this.log("error in sink",o),this._source.end(o)}finally{this.closeController.signal.removeEventListener("abort",n)}}}async _handleIncoming(e){let{id:t,type:n}=e;if(this.log.enabled&&this.log.trace("incoming message",YD(e)),e.type===qe.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??tY)){this.log("too many inbound streams open"),this._source.push({id:t,type:qe.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this.abort(new Error("Too many open streams"));return}return}let a=this._newReceiverStream({id:t,name:K(e.data instanceof Uint8Array?e.data:e.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}let i=((n&1)===1?this._streams.initiators:this._streams.receivers).get(t);if(i==null){this.log("missing stream %s for message type %s",t,zm[n]);try{await this.rateLimiter.consume("missing-stream",1)}catch{this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),this.abort(new Error("Too many messages for missing streams"));return}return}let s=this._init.maxStreamBufferSize??nY;try{switch(n){case qe.MESSAGE_INITIATOR:case qe.MESSAGE_RECEIVER:if(i.sourceReadableLength()>s)throw this._source.push({id:e.id,type:n===qe.MESSAGE_INITIATOR?qe.RESET_RECEIVER:qe.RESET_INITIATOR}),new j4("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers");i.sourcePush(e.data);break;case qe.CLOSE_INITIATOR:case qe.CLOSE_RECEIVER:i.remoteCloseWrite();break;case qe.RESET_INITIATOR:case qe.RESET_RECEIVER:i.reset();break;default:this.log("unknown message type %s",n)}}catch(a){this.log.error("error while processing message",a),i.abort(a)}}};var Cb=class{protocol="/mplex/6.7.0";_init;components;constructor(e,t={}){this.components=e,this._init=t}[Symbol.toStringTag]="@libp2p/mplex";[Ye]=["@libp2p/stream-multiplexing"];createStreamMuxer(e={}){return new W4(this.components,{...e,...this._init})}};function QD(r={}){return e=>new Cb(e,r)}var ZD="1.0.0",JD="ping",eN="ipfs";var G4=class{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnLimitedConnection;log;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:ping"),this.started=!1,this.protocol=`/${t.protocolPrefix??eN}/${JD}/${ZD}`,this.timeout=t.timeout??1e4,this.maxInboundStreams=t.maxInboundStreams??2,this.maxOutboundStreams=t.maxOutboundStreams??1,this.runOnLimitedConnection=t.runOnLimitedConnection??!0,this.handleMessage=this.handleMessage.bind(this)}[Symbol.toStringTag]="@libp2p/ping";[Ye]=["@libp2p/ping"];async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){this.log("incoming ping from %p",e.connection.remotePeer);let{stream:t}=e,n=Date.now(),o=zl(t),i=!1;Promise.resolve().then(async()=>{for(;;){let s=AbortSignal.timeout(this.timeout);s.addEventListener("abort",()=>{t?.abort(new Ao("ping timeout"))});let a=await o.read({bytes:32,signal:s});await o.write(a,{signal:s}),i=!0}}).catch(s=>{i&&s.name==="UnexpectedEOFError"&&t.readStatus!=="ready"||(this.log.error("incoming ping from %p failed with error - %e",e.connection.remotePeer,s),t?.abort(s))}).finally(()=>{let s=Date.now()-n;this.log("incoming ping from %p complete in %dms",e.connection.remotePeer,s);let a=AbortSignal.timeout(this.timeout);t.close({signal:a}).catch(c=>{this.log.error("error closing ping stream from %p - %e",e.connection.remotePeer,c),t?.abort(c)})})}async ping(e,t={}){this.log("pinging %p",e);let n=Date.now(),o=gn(32),i=await this.components.connectionManager.openConnection(e,t),s;if(t.signal==null){let a=AbortSignal.timeout(this.timeout);t={...t,signal:a}}try{s=await i.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});let a=zl(s),[,c]=await Promise.all([a.write(o,t),a.read({...t,bytes:32})]),l=Date.now()-n;if(!de(o,c.subarray()))throw new I0(`Received wrong ping ack after ${l}ms`);return this.log("ping %p complete in %dms",i.remotePeer,l),l}catch(a){throw this.log.error("error while pinging %p",i.remotePeer,a),s?.abort(a),a}finally{s!=null&&await s.close(t)}}};function tN(r={}){return e=>new G4(e,r)}var cn;(function(r){let e;(function(o){o.FIN="FIN",o.STOP_SENDING="STOP_SENDING",o.RESET="RESET",o.FIN_ACK="FIN_ACK"})(e=r.Flag||(r.Flag={}));let t;(function(o){o[o.FIN=0]="FIN",o[o.STOP_SENDING=1]="STOP_SENDING",o[o.RESET=2]="RESET",o[o.FIN_ACK=3]="FIN_ACK"})(t||(t={})),function(o){o.codec=()=>wt(t)}(e=r.Flag||(r.Flag={}));let n;r.codec=()=>(n==null&&(n=be((o,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),o.flag!=null&&(i.uint32(8),r.Flag.codec().encode(o.flag,i)),o.message!=null&&(i.uint32(18),i.bytes(o.message)),s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{a.flag=r.Flag.codec().decode(o);break}case 2:{a.message=o.bytes();break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>xe(o,r.codec()),r.decode=(o,i)=>we(o,r.codec(),i)})(cn||(cn={}));var rN=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"],Tb=Array.from("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890"),nN="libp2p+webrtc+v1/";var oN=466,iN=2*1024*1024,sN=30*1e3,Dd=16*1024;function lY(r=Dd){let e=Ke(r-Ke(r)),t=1+Ke(Object.keys(cn.Flag).length-1),n=1,o=r-e-t-n,i=Ke(o);return e+t+n+i}var aN=lY(),cN=5e3,lN=5e3,uN=3e4,kb="/webrtc",qm="/webrtc-signaling/0.0.1",fN="/libp2p/webrtc-direct/certificate",dN="webrtc-direct-certificate-private-key";var hN=12096e5,Pb=864e5;var pN=function(r,e,t){if(t||arguments.length===2)for(var n=0,o=e.length,i;n<o;n++)(i||!(n in e))&&(i||(i=Array.prototype.slice.call(e,0,n)),i[n]=e[n]);return r.concat(i||Array.prototype.slice.call(e))},uY=function(){function r(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"}return r}();var fY=function(){function r(e){this.version=e,this.type="node",this.name="node",this.os=__Process$.platform}return r}();var dY=function(){function r(e,t,n,o){this.name=e,this.version=t,this.os=n,this.bot=o,this.type="bot-device"}return r}();var hY=function(){function r(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return r}();var pY=function(){function r(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return r}();var mY=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,gY=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,mN=3,yY=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",mY]],gN=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function wN(r){return r?yN(r):typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new pY:typeof navigator<"u"?yN(navigator.userAgent):bY()}function wY(r){return r!==""&&yY.reduce(function(e,t){var n=t[0],o=t[1];if(e)return e;var i=o.exec(r);return!!i&&[n,i]},!1)}function yN(r){var e=wY(r);if(!e)return null;var t=e[0],n=e[1];if(t==="searchbot")return new hY;var o=n[1]&&n[1].split(".").join("_").split("_").slice(0,3);o?o.length<mN&&(o=pN(pN([],o,!0),vY(mN-o.length),!0)):o=[];var i=o.join("."),s=xY(r),a=gY.exec(r);return a&&a[1]?new dY(t,i,s,a[1]):new uY(t,i,s)}function xY(r){for(var e=0,t=gN.length;e<t;e++){var n=gN[e],o=n[0],i=n[1],s=i.exec(r);if(s)return o}return null}function bY(){var r=typeof __Process$<"u"&&__Process$.version;return r?new fY(__Process$.version.slice(1)):null}function vY(r){for(var e=[],t=0;t<r;t++)e.push("0");return e}var xN=wN(),jm=xN!=null&&xN.name==="firefox",X4=async function*(){},Y4=async r=>{};function bN(r,e,t=uN,n){r.readyState==="open"&&Promise.resolve().then(async()=>{if(r.bufferedAmount>0){n.log("%s drain channel with %d buffered bytes",e,r.bufferedAmount);let o=ve(),i=!1;r.bufferedAmountLowThreshold=0;let s=()=>{i||(n.log("%s drain channel closed before drain",e),o.resolve())};r.addEventListener("close",s,{once:!0}),r.addEventListener("bufferedamountlow",()=>{i=!0,r.removeEventListener("close",s),o.resolve()}),await Rs(o.promise,{milliseconds:t})}}).then(async()=>{r.readyState==="open"&&r.close()}).catch(o=>{n.log.error("error closing outbound stream",o)})}async function Rb(r){return r=r??{},typeof r=="function"&&(r=await r()),r.iceServers=r.iceServers??rN.map(e=>({urls:[e]})),r}var vN=(r=32)=>nN+[...Array(r)].map(()=>Tb.at(Math.floor(Math.random()*Tb.length))).join("");var eu=class{log;peerConnection;remoteAddr;timeline;metrics;source=X4();sink=Y4;constructor(e,t){this.log=e.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection;let n=this.peerConnection,o=n.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",n.connectionState,"initial state",o),(n.connectionState==="disconnected"||n.connectionState==="failed"||n.connectionState==="closed")&&(this.timeline.close=Date.now())}}async close(e){this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({close:!0})}abort(e){this.log.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({abort:!0})}};var Db=class extends Va{channel;incomingData;maxBufferedAmount;bufferedAmountLowEventTimeout;maxMessageSize;receiveFinAck;finAckTimeout;openTimeout;closeController;constructor(e){let t=e.onEnd;switch(e.onEnd=o=>{this.log.trace('readable and writeable ends closed with status "%s"',this.status),Promise.resolve(async()=>{if(!(this.timeline.abort!=null||this.timeline.reset!==null))try{await Rs(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(i){this.log.error("error receiving FIN_ACK",i)}}).then(()=>{this.incomingData.end(),t?.(o)}).catch(i=>{this.log.error("error ending stream",i)}).finally(()=>{this.channel.close()})},super(e),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=nr(),this.bufferedAmountLowEventTimeout=e.bufferedAmountLowEventTimeout??sN,this.maxBufferedAmount=e.maxBufferedAmount??iN,this.maxMessageSize=(e.maxMessageSize??Dd)-aN,this.receiveFinAck=ve(),this.finAckTimeout=e.closeTimeout??cN,this.openTimeout=e.openTimeout??lN,this.closeController=new AbortController,this.channel.readyState){case"open":this.timeline.open=new Date().getTime();break;case"closed":case"closing":(this.timeline.close===void 0||this.timeline.close===0)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new Nc("Unknown datachannel state")}this.channel.onopen=o=>{this.timeline.open=new Date().getTime()},this.channel.onclose=o=>{this.log.trace("received onclose event"),this.closeController.abort(),this.receiveFinAck.resolve(),this.close().catch(i=>{this.log.error("error closing stream after channel closed",i)})},this.channel.onerror=o=>{this.log.trace("received onerror event"),this.closeController.abort();let i=o.error;this.abort(i)},this.channel.onmessage=async o=>{let{data:i}=o;i===null||i.byteLength===0||this.incomingData.push(new Uint8Array(i,0,i.byteLength))};let n=this;Promise.resolve().then(async()=>{for await(let o of As(this.incomingData)){let i=n.processIncomingProtobuf(o);i!=null&&n.sourcePush(new pe(i))}}).catch(o=>{this.log.error("error processing incoming data channel messages",o)})}sendNewStream(){}async _sendMessage(e,t=!0){if(this.channel.readyState==="closed"||this.channel.readyState==="closing")throw new Nc(`Invalid datachannel state - ${this.channel.readyState}`);if(this.channel.readyState!=="open"){let n=AbortSignal.timeout(this.openTimeout),o=ke([this.closeController.signal,n]);try{this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await Ft(this.channel,"open",o)}finally{o.clear()}this.log('channel state is now "%s", sending data',this.channel.readyState)}if(t&&this.channel.bufferedAmount>this.maxBufferedAmount){let n=AbortSignal.timeout(this.bufferedAmountLowEventTimeout),o=ke([this.closeController.signal,n]);try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await Ft(this.channel,"bufferedamountlow",o)}catch(i){throw n.aborted?new Ao(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`):i}finally{o.clear()}}try{this.log.trace('sending message, channel state "%s"',this.channel.readyState),this.channel.send(e.subarray())}catch(n){this.log.error("error while sending message",n)}}async sendData(e){let t=e.byteLength;for(e=e.sublist();e.byteLength>0;){let n=Math.min(e.byteLength,this.maxMessageSize),o=e.subarray(0,n),i=cn.encode({message:o}),s=vs.single(i);this.log.trace("sending %d/%d bytes on channel",o.byteLength,t),await this._sendMessage(s),e.consume(n)}this.log.trace('finished sending data, channel state "%s"',this.channel.readyState)}async sendReset(){try{await this._sendFlag(cn.Flag.RESET)}catch(e){this.log.error("failed to send reset - %e",e)}finally{this.channel.close()}}async sendCloseWrite(e){if(this.channel.readyState!=="open"){this.receiveFinAck.resolve();return}if(await this._sendFlag(cn.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await ut(this.receiveFinAck.promise,e?.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorName:"FinAckNotReceivedError"})}catch(n){this.log.error("failed to await FIN_ACK",n)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){this.channel.readyState==="open"&&await this._sendFlag(cn.Flag.STOP_SENDING)}processIncomingProtobuf(e){let t=cn.decode(e);if(t.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===cn.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(cn.Flag.FIN_ACK).catch(n=>{this.log.error("error sending FIN_ACK immediately",n)})),t.flag===cn.Flag.RESET&&this.reset(),t.flag===cn.Flag.STOP_SENDING&&this.remoteCloseRead(),t.flag===cn.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),this.readStatus==="ready")return t.message}async _sendFlag(e){if(this.channel.readyState!=="open")return this.log.trace('not sending flag %s because channel is "%s" and not "open"',e.toString(),this.channel.readyState),!1;this.log.trace("sending flag %s",e.toString());let t=cn.encode({flag:e}),n=vs.single(t);try{return await this._sendMessage(n,!1),!0}catch(o){this.log.error("could not send flag %s - %e",e.toString(),o)}return!1}};function Nd(r){let{channel:e,direction:t,handshake:n}=r;return new Db({id:`${e.id}`,log:r.logger.forComponent(`libp2p:webrtc:stream:${n===!0?"handshake":t}:${e.id}`),...r})}var Za=class{protocol;peerConnection;bufferedStreams=[];metrics;dataChannelOptions;components;log;constructor(e,t){this.components=e,this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=t.protocol??kb,this.dataChannelOptions=t.dataChannelOptions??{},this.log=e.logger.forComponent("libp2p:webrtc:muxerfactory"),this.peerConnection.ondatachannel=({channel:n})=>{if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',n.id),n.label==="init"){this.log.trace("closing early init channel"),n.close();return}let o={},i=Nd({channel:n,direction:"inbound",onEnd:s=>{o.onEnd(s)},logger:e.logger,...this.dataChannelOptions});o.stream=i,o.channel=n,o.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter(s=>s.stream.id!==i.id)},this.bufferedStreams.push(o)}}createStreamMuxer(e){return new Nb(this.components,{...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}},Nb=class{init;streams;protocol;log;peerConnection;dataChannelOptions;metrics;logger;constructor(e,t){this.init=t,this.log=e.logger.forComponent("libp2p:webrtc:muxer"),this.logger=e.logger,this.streams=t.streams.map(n=>n.stream),this.peerConnection=t.peerConnection,this.protocol=t.protocol??kb,this.metrics=t.metrics,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:n})=>{if(this.log.trace("incoming datachannel with channel id %d",n.id),n.label==="init"){this.log.trace("closing init channel"),n.close();return}let o=n.id,i=Nd({channel:n,direction:"inbound",onEnd:()=>{this.#e(i,n),this.log("incoming channel %s ended",o)},logger:this.logger,...this.dataChannelOptions});this.streams.push(i),this.metrics?.increment({incoming_stream:!0}),t?.onIncomingStream?.(i)},this.init.streams.length>0&&queueMicrotask(()=>{this.init.streams.forEach(n=>{n.onEnd=()=>{this.log("incoming early channel %s ended with state %s",n.channel.id,n.channel.readyState),this.#e(n.stream,n.channel)},this.metrics?.increment({incoming_stream:!0}),this.init?.onIncomingStream?.(n.stream)})})}#e(e,t){this.log.trace("stream %s %s %s onEnd",e.direction,e.id,e.protocol),bN(t,`${e.direction} ${e.id} ${e.protocol}`,this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter(n=>n.id!==e.id),this.metrics?.increment({stream_end:!0}),this.init?.onStreamEnd?.(e)}async close(e){try{await Promise.all(this.streams.map(async t=>t.close(e)))}catch(t){this.abort(t)}}abort(e){for(let t of this.streams)t.abort(e)}source=X4();sink=Y4;newStream(){let e=this.peerConnection.createDataChannel(""),t=e.id;this.log.trace("opened outgoing datachannel with channel id %s",t);let n=Nd({channel:e,direction:"outbound",onEnd:()=>{this.#e(n,e),this.log("outgoing channel %s ended",t)},logger:this.logger,...this.dataChannelOptions});return this.streams.push(n),this.metrics?.increment({outgoing_stream:!0}),n}};var Q4=globalThis.RTCPeerConnection,Z4=globalThis.RTCSessionDescription,AN=globalThis.RTCIceCandidate;var Ja=class extends Error{constructor(e){super(`WebRTC transport error: ${e}`),this.name="WebRTCTransportError"}},Mo=class extends Ja{constructor(e="SDP handshake failed"){super(e),this.name="SDPHandshakeFailedError"}};var J4=class extends Ja{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`),this.name="WebRTC/InvalidFingerprintError"}};var e6=class extends Ja{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`),this.name="WebRTC/UnimplementedError"}},t6=class extends Ja{constructor(e){super(`unsupported hash algorithm code: ${e} please see the codes at https://github.com/multiformats/multicodec/blob/master/table.csv `),this.name="WebRTC/UnsupportedHashAlgorithmError"}};var Mn;(function(r){let e;(function(o){o.SDP_OFFER="SDP_OFFER",o.SDP_ANSWER="SDP_ANSWER",o.ICE_CANDIDATE="ICE_CANDIDATE"})(e=r.Type||(r.Type={}));let t;(function(o){o[o.SDP_OFFER=0]="SDP_OFFER",o[o.SDP_ANSWER=1]="SDP_ANSWER",o[o.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(t||(t={})),function(o){o.codec=()=>wt(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=be((o,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),o.type!=null&&(i.uint32(8),r.Type.codec().encode(o.type,i)),o.data!=null&&(i.uint32(18),i.string(o.data)),s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(o);break}case 2:{a.data=o.string();break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>xe(o,r.codec()),r.decode=(o,i)=>we(o,r.codec(),i)})(Mn||(Mn={}));var r6=async(r,e,t)=>{try{let n=ve();for(AY(r,n);;){let o=await Promise.race([n.promise,e.read({signal:t.signal}).catch(()=>{})]);if(o==null){t.signal?.throwIfAborted();break}if(o.type!==Mn.Type.ICE_CANDIDATE)throw new Oe("ICE candidate message expected");let i=JSON.parse(o.data??"null");if(i===""||i===null){t.onProgress?.(new j("webrtc:end-of-ice-candidates")),t.log.trace("end-of-candidates received");continue}let s=new AN(i);t.log.trace("%s received new ICE candidate %o",t.direction,i);try{t.onProgress?.(new j("webrtc:add-ice-candidate",s.candidate)),await r.addIceCandidate(s)}catch(a){t.log.error("%s bad candidate received",t.direction,i,a)}}}catch(n){if(t.log.error("%s error parsing ICE candidate",t.direction,n),t.signal?.aborted===!0&&n6(r)!=="connected")throw n}};function n6(r){return jm?r.iceConnectionState:r.connectionState}function AY(r,e){r[jm?"oniceconnectionstatechange":"onconnectionstatechange"]=t=>{switch(n6(r)){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new Gu("RTCPeerConnection was closed"));break;default:break}}}async function EN({rtcConfiguration:r,dataChannel:e,signal:t,metrics:n,multiaddr:o,connectionManager:i,transportManager:s,log:a,logger:c,onProgress:l}){let{baseAddr:u}=SN(o);n?.dialerEvents.increment({open:!0}),a.trace("dialing base address: %a",u);let f=u.getPeerId();if(f==null)throw new $("Relay peer was missing");let h=i.getConnections(tt(f)),d,m=!1;h.length===0?(l?.(new j("webrtc:dial-relay")),d=await s.dial(u,{signal:t,onProgress:l}),m=!0):(l?.(new j("webrtc:reuse-relay-connection")),d=h[0]);try{l?.(new j("webrtc:open-signaling-stream"));let g=await d.newStream(qm,{signal:t,runOnLimitedConnection:!0}),w=vt(g).pb(Mn),x=new Q4(r),v=new Za({logger:c},{peerConnection:x,dataChannelOptions:e});try{let A=x.createDataChannel("init");x.onicecandidate=({candidate:k})=>{let P=JSON.stringify(k?.toJSON()??null);a.trace("initiator sending ICE candidate %o",k),w.write({type:Mn.Type.ICE_CANDIDATE,data:P},{signal:t}).catch(E=>{a.error("error sending ICE candidate",E)})},x.onicecandidateerror=k=>{a.error("initiator ICE candidate error",k)};let S=await x.createOffer().catch(k=>{throw a.error("could not execute createOffer",k),new Mo("Failed to set createOffer")});a.trace("initiator send SDP offer %s",S.sdp),l?.(new j("webrtc:send-sdp-offer")),await w.write({type:Mn.Type.SDP_OFFER,data:S.sdp},{signal:t}),await x.setLocalDescription(S).catch(k=>{throw a.error("could not execute setLocalDescription",k),new Mo("Failed to set localDescription")}),l?.(new j("webrtc:read-sdp-answer")),a.trace("initiator read SDP answer");let _=await w.read({signal:t});if(_.type!==Mn.Type.SDP_ANSWER)throw new Mo("Remote should send an SDP answer");a.trace("initiator received SDP answer %s",_.data);let U=new Z4({type:"answer",sdp:_.data});return await x.setRemoteDescription(U).catch(k=>{throw a.error("could not execute setRemoteDescription",k),new Mo("Failed to set remoteDescription")}),a.trace("initiator read candidates until connected"),l?.(new j("webrtc:read-ice-candidates")),await r6(x,w,{direction:"initiator",signal:t,log:a,onProgress:l}),a.trace("initiator connected, closing init channel"),A.close(),l?.(new j("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await g.close({signal:t}),a.trace("initiator connected to remote address %s",o),{remoteAddress:o,peerConnection:x,muxerFactory:v}}catch(A){throw a.error("outgoing signaling error",A),x.close(),g.abort(A),A}finally{x.onicecandidate=null,x.onicecandidateerror=null}}finally{if(m)try{await d.close({signal:t})}catch(g){d.abort(g)}}}var _N=lt(H2.matchers[0],Ne("p2p-circuit")),o6=class r extends Re{transportManager;shutdownController;events;constructor(e,t){super(),this.transportManager=e.transportManager,this.events=e.events,this.shutdownController=t.shutdownController,this.onTransportListening=this.onTransportListening.bind(this)}async listen(){this.events.addEventListener("transport:listening",this.onTransportListening)}onTransportListening(e){e.detail.getAddrs().filter(n=>_N.exactMatch(n)).map(n=>n.encapsulate("/webrtc")).length>0&&this.safeDispatchEvent("listening")}getAddrs(){return this.transportManager.getListeners().filter(e=>!(e instanceof r)).map(e=>e.getAddrs().filter(t=>_N.exactMatch(t)).map(t=>t.encapsulate("/webrtc"))).flat()}updateAnnounceAddrs(){}async close(){this.events.removeEventListener("transport:listening",this.onTransportListening),this.shutdownController.abort(),queueMicrotask(()=>{this.safeDispatchEvent("close")})}};async function CN({peerConnection:r,stream:e,signal:t,connection:n,log:o}){o.trace("new inbound signaling stream");let i=vt(e).pb(Mn);try{r.onicecandidate=({candidate:u})=>{let f=JSON.stringify(u?.toJSON()??null);o.trace("recipient sending ICE candidate %s",f),i.write({type:Mn.Type.ICE_CANDIDATE,data:f},{signal:t}).catch(h=>{o.error("error sending ICE candidate",h)})},o.trace("recipient read SDP offer");let a=await i.read({signal:t});if(a.type!==Mn.Type.SDP_OFFER)throw new Mo(`expected message type SDP_OFFER, received: ${a.type??"undefined"} `);o.trace("recipient received SDP offer %s",a.data);let c=new Z4({type:"offer",sdp:a.data});await r.setRemoteDescription(c).catch(u=>{throw o.error("could not execute setRemoteDescription",u),new Mo("Failed to set remoteDescription")});let l=await r.createAnswer().catch(u=>{throw o.error("could not execute createAnswer",u),new Mo("Failed to create answer")});o.trace("recipient send SDP answer %s",l.sdp),await i.write({type:Mn.Type.SDP_ANSWER,data:l.sdp},{signal:t}),await r.setLocalDescription(l).catch(u=>{throw o.error("could not execute setLocalDescription",u),new Mo("Failed to set localDescription")}),o.trace("recipient read candidates until connected"),await r6(r,i,{direction:"recipient",signal:t,log:o})}catch(a){if(n6(r)!=="connected")throw o.error("error while handling signaling stream from peer %a",n.remoteAddr,a),r.close(),a;o("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",n.remoteAddr,a)}let s=ne(`/webrtc/p2p/${n.remoteAddr.getPeerId()}`);return o.trace("recipient connected to remote address %s",s),{remoteAddress:s}}var i6=class{components;init;log;_started=!1;metrics;shutdownController;constructor(e,t={}){this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,this.shutdownController.signal,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}[ma]=!0;[Symbol.toStringTag]="@libp2p/webrtc";[Ye]=["@libp2p/transport"];[Qn]=["@libp2p/identify","@libp2p/circuit-relay-v2-transport"];isStarted(){return this._started}async start(){await this.components.registrar.handle(qm,e=>{let t=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);this._onProtocol(e,t).catch(n=>{this.log.error("failed to handle incoming connect from %p",e.connection.remotePeer,n)}).finally(()=>{t.clear()})},{runOnLimitedConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(qm),this._started=!1}createListener(e){return new o6(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(Xp.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){this.log.trace("dialing address: %a",e);let{remoteAddress:n,peerConnection:o,muxerFactory:i}=await EN({rtcConfiguration:await Rb(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),s=new eu(this.components,{peerConnection:o,timeline:{open:Date.now()},remoteAddr:n,metrics:this.metrics?.dialerEvents}),a=await t.upgrader.upgradeOutbound(s,{skipProtection:!0,skipEncryption:!0,muxerFactory:i,onProgress:t.onProgress,signal:t.signal});return this._closeOnShutdown(o,s),a}async _onProtocol({connection:e,stream:t},n){let o=new Q4(await Rb(this.init.rtcConfiguration)),i=new Za(this.components,{peerConnection:o,dataChannelOptions:this.init.dataChannel});try{let{remoteAddress:s}=await CN({peerConnection:o,connection:e,stream:t,signal:n,log:this.log});await t.close({signal:n});let a=new eu(this.components,{peerConnection:o,timeline:{open:new Date().getTime()},remoteAddr:s,metrics:this.metrics?.listenerEvents});await this.components.upgrader.upgradeInbound(a,{skipEncryption:!0,skipProtection:!0,muxerFactory:i,signal:n}),this._closeOnShutdown(o,a)}catch(s){throw this.log.error("incoming signaling error",s),o.close(),t.abort(s),s}}_closeOnShutdown(e,t){let n=()=>{t.close().catch(o=>{this.log.error("could not close WebRTCMultiaddrConnection",o)})};this.shutdownController.signal.addEventListener("abort",n),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",n)})}};function SN(r){let e=r.toString().split("/webrtc/");if(e.length!==2)throw new $("webrtc protocol was not present in multiaddr");if(!e[0].includes("/p2p-circuit"))throw new $("p2p-circuit protocol was not present in multiaddr");let t=ne(e[0]),o=ne("/"+e[1]).getPeerId();if(o==null)throw new $("destination peer id was missing");let i=t.protos().pop();if(i===void 0)throw new $("invalid multiaddr");return i.name!=="p2p"&&(t=t.encapsulate(`/p2p/${o}`)),{baseAddr:t,peerId:tt(o)}}var Tje=st(TN());var O;(function(r){r[r.Sequence=0]="Sequence",r[r.Set=1]="Set",r[r.Choice=2]="Choice"})(O||(O={}));var b;(function(r){r[r.Any=1]="Any",r[r.Boolean=2]="Boolean",r[r.OctetString=3]="OctetString",r[r.BitString=4]="BitString",r[r.Integer=5]="Integer",r[r.Enumerated=6]="Enumerated",r[r.ObjectIdentifier=7]="ObjectIdentifier",r[r.Utf8String=8]="Utf8String",r[r.BmpString=9]="BmpString",r[r.UniversalString=10]="UniversalString",r[r.NumericString=11]="NumericString",r[r.PrintableString=12]="PrintableString",r[r.TeletexString=13]="TeletexString",r[r.VideotexString=14]="VideotexString",r[r.IA5String=15]="IA5String",r[r.GraphicString=16]="GraphicString",r[r.VisibleString=17]="VisibleString",r[r.GeneralString=18]="GeneralString",r[r.CharacterString=19]="CharacterString",r[r.UTCTime=20]="UTCTime",r[r.GeneralizedTime=21]="GeneralizedTime",r[r.DATE=22]="DATE",r[r.TimeOfDay=23]="TimeOfDay",r[r.DateTime=24]="DateTime",r[r.Duration=25]="Duration",r[r.TIME=26]="TIME",r[r.Null=27]="Null"})(b||(b={}));var Ob=st(qs()),Ji=class{constructor(e,t=0){if(this.unusedBits=0,this.value=new ArrayBuffer(0),e)if(typeof e=="number")this.fromNumber(e);else if(Ob.BufferSourceConverter.isBufferSource(e))this.unusedBits=t,this.value=Ob.BufferSourceConverter.toArrayBuffer(e);else throw TypeError("Unsupported type of 'params' argument for BitString")}fromASN(e){if(!(e instanceof gi))throw new TypeError("Argument 'asn' is not instance of ASN.1 BitString");return this.unusedBits=e.valueBlock.unusedBits,this.value=e.valueBlock.valueHex,this}toASN(){return new gi({unusedBits:this.unusedBits,valueHex:this.value})}toSchema(e){return new gi({name:e})}toNumber(){let e="",t=new Uint8Array(this.value);for(let n of t)e+=n.toString(2).padStart(8,"0");return e=e.split("").reverse().join(""),this.unusedBits&&(e=e.slice(this.unusedBits).padStart(this.unusedBits,"0")),parseInt(e,2)}fromNumber(e){let t=e.toString(2),n=t.length+7>>3;this.unusedBits=(n<<3)-t.length;let o=new Uint8Array(n);t=t.padStart(n<<3,"0").split("").reverse().join("");let i=0;for(;i<n;)o[i]=parseInt(t.slice(i<<3,(i<<3)+8),2),i++;this.value=o.buffer}};var Lb=st(qs()),Ae=class{get byteLength(){return this.buffer.byteLength}get byteOffset(){return 0}constructor(e){typeof e=="number"?this.buffer=new ArrayBuffer(e):Lb.BufferSourceConverter.isBufferSource(e)?this.buffer=Lb.BufferSourceConverter.toArrayBuffer(e):Array.isArray(e)?this.buffer=new Uint8Array(e):this.buffer=new ArrayBuffer(0)}fromASN(e){if(!(e instanceof sn))throw new TypeError("Argument 'asn' is not instance of ASN.1 OctetString");return this.buffer=e.valueBlock.valueHex,this}toASN(){return new sn({valueHex:this.buffer})}toSchema(e){return new sn({name:e})}};var EY={fromASN:r=>r instanceof Nn?null:r.valueBeforeDecodeView,toASN:r=>{if(r===null)return new Nn;let e=fo(r);if(e.result.error)throw new Error(e.result.error);return e.result}},SY={fromASN:r=>r.valueBlock.valueHexView.byteLength>=4?r.valueBlock.toString():r.valueBlock.valueDec,toASN:r=>new lo({value:+r})},_Y={fromASN:r=>r.valueBlock.valueDec,toASN:r=>new _l({value:r})},Me={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new lo({valueHex:r})};var CY={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new gi({valueHex:r})},IY={fromASN:r=>r.valueBlock.toString(),toASN:r=>new uo({value:r})},TY={fromASN:r=>r.valueBlock.value,toASN:r=>new Sl({value:r})},Od={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new sn({valueHex:r})},kN={fromASN:r=>new Ae(r.getValue()),toASN:r=>r.toASN()};function Uo(r){return{fromASN:e=>e.valueBlock.value,toASN:e=>new r({value:e})}}var Bb=Uo(Ro),kY=Uo(Cl),PY=Uo(Il),RY=Uo(Tl),DY=Uo(kl),NY=Uo(Pl),OY=Uo(Rl),LY=Uo(Dl),BY=Uo(Nl),MY=Uo(Ua),UY=Uo(Ol),FY=Uo(Ll),HY={fromASN:r=>r.toDate(),toASN:r=>new Fa({valueDate:r})},$Y={fromASN:r=>r.toDate(),toASN:r=>new Bl({valueDate:r})},VY={fromASN:()=>null,toASN:()=>new Nn};function Ld(r){switch(r){case b.Any:return EY;case b.BitString:return CY;case b.BmpString:return kY;case b.Boolean:return TY;case b.CharacterString:return FY;case b.Enumerated:return _Y;case b.GeneralString:return UY;case b.GeneralizedTime:return $Y;case b.GraphicString:return BY;case b.IA5String:return LY;case b.Integer:return SY;case b.Null:return VY;case b.NumericString:return RY;case b.ObjectIdentifier:return IY;case b.OctetString:return Od;case b.PrintableString:return DY;case b.TeletexString:return NY;case b.UTCTime:return HY;case b.UniversalString:return PY;case b.Utf8String:return Bb;case b.VideotexString:return OY;case b.VisibleString:return MY;default:return null}}function Fo(r){return typeof r=="function"&&r.prototype?r.prototype.toASN&&r.prototype.fromASN?!0:Fo(r.prototype):!!(r&&typeof r=="object"&&"toASN"in r&&"fromASN"in r)}function Ub(r){var e;if(r){let t=Object.getPrototypeOf(r);return((e=t?.prototype)===null||e===void 0?void 0:e.constructor)===Array?!0:Ub(t)}return!1}function PN(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;let t=new Uint8Array(r),n=new Uint8Array(e);for(let o=0;o<r.byteLength;o++)if(t[o]!==n[o])return!1;return!0}var s6=class{constructor(){this.items=new WeakMap}has(e){return this.items.has(e)}get(e,t=!1){let n=this.items.get(e);if(!n)throw new Error(`Cannot get schema for '${e.prototype.constructor.name}' target`);if(t&&!n.schema)throw new Error(`Schema '${e.prototype.constructor.name}' doesn't contain ASN.1 schema. Call 'AsnSchemaStorage.cache'.`);return n}cache(e){let t=this.get(e);t.schema||(t.schema=this.create(e,!0))}createDefault(e){let t={type:O.Sequence,items:{}},n=this.findParentSchema(e);return n&&(Object.assign(t,n),t.items=Object.assign({},t.items,n.items)),t}create(e,t){let n=this.items.get(e)||this.createDefault(e),o=[];for(let i in n.items){let s=n.items[i],a=t?i:"",c;if(typeof s.type=="number"){let u=b[s.type],f=Do[u];if(!f)throw new Error(`Cannot get ASN1 class by name '${u}'`);c=new f({name:a})}else Fo(s.type)?c=new s.type().toSchema(a):s.optional?this.get(s.type).type===O.Choice?c=new Xi({name:a}):(c=this.create(s.type,!1),c.name=a):c=new Xi({name:a});let l=!!s.optional||s.defaultValue!==void 0;if(s.repeated){c.name="";let u=s.repeated==="set"?On:Tt;c=new u({name:"",value:[new Ml({name:a,value:c})]})}if(s.context!==null&&s.context!==void 0)if(s.implicit)if(typeof s.type=="number"||Fo(s.type)){let u=s.repeated?gr:Ws;o.push(new u({name:a,optional:l,idBlock:{tagClass:3,tagNumber:s.context}}))}else{this.cache(s.type);let u=!!s.repeated,f=u?c:this.get(s.type,!0).schema;f="valueBlock"in f?f.valueBlock.value:f.value,o.push(new gr({name:u?"":a,optional:l,idBlock:{tagClass:3,tagNumber:s.context},value:f}))}else o.push(new gr({optional:l,idBlock:{tagClass:3,tagNumber:s.context},value:[c]}));else c.optional=l,o.push(c)}switch(n.type){case O.Sequence:return new Tt({value:o,name:""});case O.Set:return new On({value:o,name:""});case O.Choice:return new ld({value:o,name:""});default:throw new Error("Unsupported ASN1 type in use")}}set(e,t){return this.items.set(e,t),this}findParentSchema(e){let t=Object.getPrototypeOf(e);return t?this.items.get(t)||this.findParentSchema(t):null}};var Sn=new s6;var M=r=>e=>{let t;Sn.has(e)?t=Sn.get(e):(t=Sn.createDefault(e),Sn.set(e,t)),Object.assign(t,r)};var y=r=>(e,t)=>{let n;Sn.has(e.constructor)?n=Sn.get(e.constructor):(n=Sn.createDefault(e.constructor),Sn.set(e.constructor,n));let o=Object.assign({},r);if(typeof o.type=="number"&&!o.converter){let i=Ld(r.type);if(!i)throw new Error(`Cannot get default converter for property '${t}' of ${e.constructor.name}`);o.converter=i}n.items[t]=o};var Wm=class extends Error{constructor(){super(...arguments),this.schemas=[]}};var Gm=class{static parse(e,t){let n=fo(e);if(n.result.error)throw new Error(n.result.error);return this.fromASN(n.result,t)}static fromASN(e,t){var n;try{if(Fo(t))return new t().fromASN(e);let o=Sn.get(t);Sn.cache(t);let i=o.schema;if(e.constructor===gr&&o.type!==O.Choice){i=new gr({idBlock:{tagClass:3,tagNumber:e.idBlock.tagNumber},value:o.schema.valueBlock.value});for(let c in o.items)delete e[c]}let s=Ma({},e,i);if(!s.verified)throw new Wm(`Data does not match to ${t.name} ASN1 schema. ${s.result.error}`);let a=new t;if(Ub(t)){if(!("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");let c=o.itemType;if(typeof c=="number"){let l=Ld(c);if(!l)throw new Error(`Cannot get default converter for array item of ${t.name} ASN1 schema`);return t.from(e.valueBlock.value,u=>l.fromASN(u))}else return t.from(e.valueBlock.value,l=>this.fromASN(l,c))}for(let c in o.items){let l=s.result[c];if(!l)continue;let u=o.items[c],f=u.type;if(typeof f=="number"||Fo(f)){let h=(n=u.converter)!==null&&n!==void 0?n:Fo(f)?new f:null;if(!h)throw new Error("Converter is empty");if(u.repeated)if(u.implicit){let d=u.repeated==="sequence"?Tt:On,m=new d;m.valueBlock=l.valueBlock;let g=fo(m.toBER(!1));if(g.offset===-1)throw new Error(`Cannot parse the child item. ${g.result.error}`);if(!("value"in g.result.valueBlock&&Array.isArray(g.result.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");let w=g.result.valueBlock.value;a[c]=Array.from(w,x=>h.fromASN(x))}else a[c]=Array.from(l,d=>h.fromASN(d));else{let d=l;if(u.implicit){let m;if(Fo(f))m=new f().toSchema("");else{let g=b[f],w=Do[g];if(!w)throw new Error(`Cannot get '${g}' class from asn1js module`);m=new w}m.valueBlock=d.valueBlock,d=fo(m.toBER(!1)).result}a[c]=h.fromASN(d)}}else if(u.repeated){if(!Array.isArray(l))throw new Error("Cannot get list of items from the ASN.1 parsed value. ASN.1 value should be iterable.");a[c]=Array.from(l,h=>this.fromASN(h,f))}else a[c]=this.fromASN(l,f)}return a}catch(o){throw o instanceof Wm&&o.schemas.push(t.name),o}}};var Xm=class r{static serialize(e){return e instanceof fr?e.toBER(!1):this.toASN(e).toBER(!1)}static toASN(e){if(e&&typeof e=="object"&&Fo(e))return e.toASN();if(!(e&&typeof e=="object"))throw new TypeError("Parameter 1 should be type of Object.");let t=e.constructor,n=Sn.get(t);Sn.cache(t);let o=[];if(n.itemType){if(!Array.isArray(e))throw new TypeError("Parameter 1 should be type of Array.");if(typeof n.itemType=="number"){let s=Ld(n.itemType);if(!s)throw new Error(`Cannot get default converter for array item of ${t.name} ASN1 schema`);o=e.map(a=>s.toASN(a))}else o=e.map(s=>this.toAsnItem({type:n.itemType},"[]",t,s))}else for(let s in n.items){let a=n.items[s],c=e[s];if(c===void 0||a.defaultValue===c||typeof a.defaultValue=="object"&&typeof c=="object"&&PN(this.serialize(a.defaultValue),this.serialize(c)))continue;let l=r.toAsnItem(a,s,t,c);if(typeof a.context=="number")if(a.implicit)if(!a.repeated&&(typeof a.type=="number"||Fo(a.type))){let u={};u.valueHex=l instanceof Nn?l.valueBeforeDecodeView:l.valueBlock.toBER(),o.push(new Ws({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},...u}))}else o.push(new gr({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:l.valueBlock.value}));else o.push(new gr({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:[l]}));else a.repeated?o=o.concat(l):o.push(l)}let i;switch(n.type){case O.Sequence:i=new Tt({value:o});break;case O.Set:i=new On({value:o});break;case O.Choice:if(!o[0])throw new Error(`Schema '${t.name}' has wrong data. Choice cannot be empty.`);i=o[0];break}return i}static toAsnItem(e,t,n,o){let i;if(typeof e.type=="number"){let s=e.converter;if(!s)throw new Error(`Property '${t}' doesn't have converter for type ${b[e.type]} in schema '${n.name}'`);if(e.repeated){if(!Array.isArray(o))throw new TypeError("Parameter 'objProp' should be type of Array.");let a=Array.from(o,l=>s.toASN(l)),c=e.repeated==="sequence"?Tt:On;i=new c({value:a})}else i=s.toASN(o)}else if(e.repeated){if(!Array.isArray(o))throw new TypeError("Parameter 'objProp' should be type of Array.");let s=Array.from(o,c=>this.toASN(c)),a=e.repeated==="sequence"?Tt:On;i=new a({value:s})}else i=this.toASN(o);return i}};var ye=class extends Array{constructor(e=[]){if(typeof e=="number")super(e);else{super();for(let t of e)this.push(t)}}};var Fb=st(qs());var te=class r{static serialize(e){return Xm.serialize(e)}static parse(e,t){return Gm.parse(e,t)}static toString(e){let t=Fb.BufferSourceConverter.isBufferSource(e)?Fb.BufferSourceConverter.toArrayBuffer(e):r.serialize(e),n=fo(t);if(n.offset===-1)throw new Error(`Cannot decode ASN.1 data. ${n.result.error}`);return n.result.toString()}};var Hb=function(r,e){return Hb=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])},Hb(r,e)};function Ym(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");Hb(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function p(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}function RN(r,e,t,n){function o(i){return i instanceof t?i:new t(function(s){s(i)})}return new(t||(t=Promise))(function(i,s){function a(u){try{l(n.next(u))}catch(f){s(f)}}function c(u){try{l(n.throw(u))}catch(f){s(f)}}function l(u){u.done?i(u.value):o(u.value).then(a,c)}l((n=n.apply(r,e||[])).next())})}function DN(r,e){var t={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,s=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function a(l){return function(u){return c([l,u])}}function c(l){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,l[0]&&(t=0)),t;)try{if(n=1,o&&(i=l[0]&2?o.return:l[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,l[1])).done)return i;switch(o=0,i&&(l=[l[0]&2,i.value]),l[0]){case 0:case 1:i=l;break;case 4:return t.label++,{value:l[1],done:!1};case 5:t.label++,o=l[1],l=[0];continue;case 7:l=t.ops.pop(),t.trys.pop();continue;default:if(i=t.trys,!(i=i.length>0&&i[i.length-1])&&(l[0]===6||l[0]===2)){t=0;continue}if(l[0]===3&&(!i||l[1]>i[0]&&l[1]<i[3])){t.label=l[1];break}if(l[0]===6&&t.label<i[1]){t.label=i[1],i=l;break}if(i&&t.label<i[2]){t.label=i[2],t.ops.push(l);break}i[2]&&t.ops.pop(),t.trys.pop();continue}l=e.call(r,t)}catch(u){l=[6,u],o=0}finally{n=i=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function Qm(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],n=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&n>=r.length&&(r=void 0),{value:r&&r[n++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function Bd(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var n=t.call(r),o,i=[],s;try{for(;(e===void 0||e-- >0)&&!(o=n.next()).done;)i.push(o.value)}catch(a){s={error:a}}finally{try{o&&!o.done&&(t=n.return)&&t.call(n)}finally{if(s)throw s.error}}return i}function es(){for(var r=[],e=0;e<arguments.length;e++)r=r.concat(Bd(arguments[e]));return r}var NN=st(qs()),Zm=class{static isIPv4(e){return/^(\d{1,3}\.){3}\d{1,3}$/.test(e)}static parseIPv4(e){let t=e.split(".");if(t.length!==4)throw new Error("Invalid IPv4 address");return t.map(n=>{let o=parseInt(n,10);if(isNaN(o)||o<0||o>255)throw new Error("Invalid IPv4 address part");return o})}static parseIPv6(e){let n=this.expandIPv6(e).split(":");if(n.length!==8)throw new Error("Invalid IPv6 address");return n.reduce((o,i)=>{let s=parseInt(i,16);if(isNaN(s)||s<0||s>65535)throw new Error("Invalid IPv6 address part");return o.push(s>>8&255),o.push(s&255),o},[])}static expandIPv6(e){if(!e.includes("::"))return e;let t=e.split("::");if(t.length>2)throw new Error("Invalid IPv6 address");let n=t[0]?t[0].split(":"):[],o=t[1]?t[1].split(":"):[],i=8-(n.length+o.length);if(i<0)throw new Error("Invalid IPv6 address");return[...n,...Array(i).fill("0"),...o].join(":")}static formatIPv6(e){let t=[];for(let n=0;n<16;n+=2)t.push((e[n]<<8|e[n+1]).toString(16));return this.compressIPv6(t.join(":"))}static compressIPv6(e){let t=e.split(":"),n=-1,o=0,i=-1,s=0;for(let a=0;a<t.length;a++)t[a]==="0"?(i===-1&&(i=a),s++):(s>o&&(n=i,o=s),i=-1,s=0);if(s>o&&(n=i,o=s),o>1){let a=t.slice(0,n).join(":"),c=t.slice(n+o).join(":");return`${a}::${c}`}return e}static parseCIDR(e){let[t,n]=e.split("/"),o=parseInt(n,10);if(this.isIPv4(t)){if(o<0||o>32)throw new Error("Invalid IPv4 prefix length");return[this.parseIPv4(t),o]}else{if(o<0||o>128)throw new Error("Invalid IPv6 prefix length");return[this.parseIPv6(t),o]}}static decodeIP(e){if(e.length===64&&parseInt(e,16)===0)return"::/0";if(e.length!==16)return e;let t=parseInt(e.slice(8),16).toString(2).split("").reduce((o,i)=>o+ +i,0),n=e.slice(0,8).replace(/(.{2})/g,o=>`${parseInt(o,16)}.`);return n=n.slice(0,-1),`${n}/${t}`}static toString(e){let t=new Uint8Array(e);if(t.length===4)return Array.from(t).join(".");if(t.length===16)return this.formatIPv6(t);if(t.length===8||t.length===32){let n=t.length/2,o=t.slice(0,n),i=t.slice(n);if(t.every(c=>c===0))return t.length===8?"0.0.0.0/0":"::/0";let a=i.reduce((c,l)=>c+(l.toString(2).match(/1/g)||[]).length,0);return t.length===8?`${Array.from(o).join(".")}/${a}`:`${this.formatIPv6(o)}/${a}`}return this.decodeIP(NN.Convert.ToHex(e))}static fromString(e){if(e.includes("/")){let[n,o]=this.parseCIDR(e),i=new Uint8Array(n.length),s=o;for(let c=0;c<i.length;c++)s>=8?(i[c]=255,s-=8):s>0&&(i[c]=255<<8-s,s=0);let a=new Uint8Array(n.length*2);return a.set(n,0),a.set(i,n.length),a.buffer}let t=this.isIPv4(e)?this.parseIPv4(e):this.parseIPv6(e);return new Uint8Array(t).buffer}};var ON=st(qs()),$b,Vb,Kb,dr=class{constructor(e={}){Object.assign(this,e)}toString(){return this.bmpString||this.printableString||this.teletexString||this.universalString||this.utf8String||""}};p([y({type:b.TeletexString})],dr.prototype,"teletexString",void 0);p([y({type:b.PrintableString})],dr.prototype,"printableString",void 0);p([y({type:b.UniversalString})],dr.prototype,"universalString",void 0);p([y({type:b.Utf8String})],dr.prototype,"utf8String",void 0);p([y({type:b.BmpString})],dr.prototype,"bmpString",void 0);dr=p([M({type:O.Choice})],dr);var Md=class extends dr{constructor(e={}){super(e),Object.assign(this,e)}toString(){return this.ia5String||(this.anyValue?ON.Convert.ToHex(this.anyValue):super.toString())}};p([y({type:b.IA5String})],Md.prototype,"ia5String",void 0);p([y({type:b.Any})],Md.prototype,"anyValue",void 0);Md=p([M({type:O.Choice})],Md);var tu=class{constructor(e={}){this.type="",this.value=new Md,Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],tu.prototype,"type",void 0);p([y({type:Md})],tu.prototype,"value",void 0);var ec=$b=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,$b.prototype)}};ec=$b=p([M({type:O.Set,itemType:tu})],ec);var zb=Vb=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,Vb.prototype)}};zb=Vb=p([M({type:O.Sequence,itemType:ec})],zb);var dt=Kb=class extends zb{constructor(e){super(e),Object.setPrototypeOf(this,Kb.prototype)}};dt=Kb=p([M({type:O.Sequence})],dt);var KY={fromASN:r=>Zm.toString(Od.fromASN(r)),toASN:r=>Od.toASN(Zm.fromString(r))},tc=class{constructor(e={}){this.typeId="",this.value=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],tc.prototype,"typeId",void 0);p([y({type:b.Any,context:0})],tc.prototype,"value",void 0);var Jm=class{constructor(e={}){this.partyName=new dr,Object.assign(this,e)}};p([y({type:dr,optional:!0,context:0,implicit:!0})],Jm.prototype,"nameAssigner",void 0);p([y({type:dr,context:1,implicit:!0})],Jm.prototype,"partyName",void 0);var Se=class{constructor(e={}){Object.assign(this,e)}};p([y({type:tc,context:0,implicit:!0})],Se.prototype,"otherName",void 0);p([y({type:b.IA5String,context:1,implicit:!0})],Se.prototype,"rfc822Name",void 0);p([y({type:b.IA5String,context:2,implicit:!0})],Se.prototype,"dNSName",void 0);p([y({type:b.Any,context:3,implicit:!0})],Se.prototype,"x400Address",void 0);p([y({type:dt,context:4,implicit:!1})],Se.prototype,"directoryName",void 0);p([y({type:Jm,context:5})],Se.prototype,"ediPartyName",void 0);p([y({type:b.IA5String,context:6,implicit:!0})],Se.prototype,"uniformResourceIdentifier",void 0);p([y({type:b.OctetString,context:7,implicit:!0,converter:KY})],Se.prototype,"iPAddress",void 0);p([y({type:b.ObjectIdentifier,context:8,implicit:!0})],Se.prototype,"registeredID",void 0);Se=p([M({type:O.Choice})],Se);var rc="1.3.6.1.5.5.7",nc=`${rc}.1`,LN=`${rc}.2`,ru=`${rc}.3`,a6=`${rc}.48`,gPe=`${LN}.1`,yPe=`${LN}.2`,qb=`${a6}.1`,jb=`${a6}.2`,Wb=`${a6}.3`,Gb=`${a6}.5`,Pe="2.5.29";var Xb,c6=`${nc}.1`,Zs=class{constructor(e={}){this.accessMethod="",this.accessLocation=new Se,Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],Zs.prototype,"accessMethod",void 0);p([y({type:Se})],Zs.prototype,"accessLocation",void 0);var nu=Xb=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,Xb.prototype)}};nu=Xb=p([M({type:O.Sequence,itemType:Zs})],nu);var l6=`${Pe}.35`,ou=class extends Ae{},ts=class{constructor(e={}){e&&Object.assign(this,e)}};p([y({type:ou,context:0,optional:!0,implicit:!0})],ts.prototype,"keyIdentifier",void 0);p([y({type:Se,context:1,optional:!0,implicit:!0,repeated:"sequence"})],ts.prototype,"authorityCertIssuer",void 0);p([y({type:b.Integer,context:2,optional:!0,implicit:!0,converter:Me})],ts.prototype,"authorityCertSerialNumber",void 0);var u6=`${Pe}.19`,iu=class{constructor(e={}){this.cA=!1,Object.assign(this,e)}};p([y({type:b.Boolean,defaultValue:!1})],iu.prototype,"cA",void 0);p([y({type:b.Integer,optional:!0})],iu.prototype,"pathLenConstraint",void 0);var Yb,Rt=Yb=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,Yb.prototype)}};Rt=Yb=p([M({type:O.Sequence,itemType:Se})],Rt);var Qb,zY=`${Pe}.29`,BN=Qb=class extends Rt{constructor(e){super(e),Object.setPrototypeOf(this,Qb.prototype)}};BN=Qb=p([M({type:O.Sequence})],BN);var Zb,d6=`${Pe}.32`,XPe=`${d6}.0`,Js=class{constructor(e={}){Object.assign(this,e)}toString(){return this.ia5String||this.visibleString||this.bmpString||this.utf8String||""}};p([y({type:b.IA5String})],Js.prototype,"ia5String",void 0);p([y({type:b.VisibleString})],Js.prototype,"visibleString",void 0);p([y({type:b.BmpString})],Js.prototype,"bmpString",void 0);p([y({type:b.Utf8String})],Js.prototype,"utf8String",void 0);Js=p([M({type:O.Choice})],Js);var e1=class{constructor(e={}){this.organization=new Js,this.noticeNumbers=[],Object.assign(this,e)}};p([y({type:Js})],e1.prototype,"organization",void 0);p([y({type:b.Integer,repeated:"sequence"})],e1.prototype,"noticeNumbers",void 0);var t1=class{constructor(e={}){Object.assign(this,e)}};p([y({type:e1,optional:!0})],t1.prototype,"noticeRef",void 0);p([y({type:Js,optional:!0})],t1.prototype,"explicitText",void 0);var f6=class{constructor(e={}){Object.assign(this,e)}};p([y({type:b.IA5String})],f6.prototype,"cPSuri",void 0);p([y({type:t1})],f6.prototype,"userNotice",void 0);f6=p([M({type:O.Choice})],f6);var r1=class{constructor(e={}){this.policyQualifierId="",this.qualifier=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],r1.prototype,"policyQualifierId",void 0);p([y({type:b.Any})],r1.prototype,"qualifier",void 0);var su=class{constructor(e={}){this.policyIdentifier="",Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],su.prototype,"policyIdentifier",void 0);p([y({type:r1,repeated:"sequence",optional:!0})],su.prototype,"policyQualifiers",void 0);var n1=Zb=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,Zb.prototype)}};n1=Zb=p([M({type:O.Sequence,itemType:su})],n1);var nRe=`${Pe}.20`,o1=class{constructor(e=0){this.value=e}};p([y({type:b.Integer})],o1.prototype,"value",void 0);o1=p([M({type:O.Choice})],o1);var uRe=`${Pe}.27`,MN=class extends o1{};MN=p([M({type:O.Choice})],MN);var Jb,h6=`${Pe}.31`,Ei;(function(r){r[r.unused=1]="unused",r[r.keyCompromise=2]="keyCompromise",r[r.cACompromise=4]="cACompromise",r[r.affiliationChanged=8]="affiliationChanged",r[r.superseded=16]="superseded",r[r.cessationOfOperation=32]="cessationOfOperation",r[r.certificateHold=64]="certificateHold",r[r.privilegeWithdrawn=128]="privilegeWithdrawn",r[r.aACompromise=256]="aACompromise"})(Ei||(Ei={}));var i1=class extends Ji{toJSON(){let e=[],t=this.toNumber();return t&Ei.aACompromise&&e.push("aACompromise"),t&Ei.affiliationChanged&&e.push("affiliationChanged"),t&Ei.cACompromise&&e.push("cACompromise"),t&Ei.certificateHold&&e.push("certificateHold"),t&Ei.cessationOfOperation&&e.push("cessationOfOperation"),t&Ei.keyCompromise&&e.push("keyCompromise"),t&Ei.privilegeWithdrawn&&e.push("privilegeWithdrawn"),t&Ei.superseded&&e.push("superseded"),t&Ei.unused&&e.push("unused"),e}toString(){return`[${this.toJSON().join(", ")}]`}},ea=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Se,context:0,repeated:"sequence",implicit:!0})],ea.prototype,"fullName",void 0);p([y({type:ec,context:1,implicit:!0})],ea.prototype,"nameRelativeToCRLIssuer",void 0);ea=p([M({type:O.Choice})],ea);var rs=class{constructor(e={}){Object.assign(this,e)}};p([y({type:ea,context:0,optional:!0})],rs.prototype,"distributionPoint",void 0);p([y({type:i1,context:1,optional:!0,implicit:!0})],rs.prototype,"reasons",void 0);p([y({type:Se,context:2,optional:!0,repeated:"sequence",implicit:!0})],rs.prototype,"cRLIssuer",void 0);var oc=Jb=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,Jb.prototype)}};oc=Jb=p([M({type:O.Sequence,itemType:rs})],oc);var ev,_Re=`${Pe}.46`,UN=ev=class extends oc{constructor(e){super(e),Object.setPrototypeOf(this,ev.prototype)}};UN=ev=p([M({type:O.Sequence,itemType:rs})],UN);var NRe=`${Pe}.28`,po=class r{constructor(e={}){this.onlyContainsUserCerts=r.ONLY,this.onlyContainsCACerts=r.ONLY,this.indirectCRL=r.ONLY,this.onlyContainsAttributeCerts=r.ONLY,Object.assign(this,e)}};po.ONLY=!1;p([y({type:ea,context:0,optional:!0})],po.prototype,"distributionPoint",void 0);p([y({type:b.Boolean,context:1,defaultValue:po.ONLY,implicit:!0})],po.prototype,"onlyContainsUserCerts",void 0);p([y({type:b.Boolean,context:2,defaultValue:po.ONLY,implicit:!0})],po.prototype,"onlyContainsCACerts",void 0);p([y({type:i1,context:3,optional:!0,implicit:!0})],po.prototype,"onlySomeReasons",void 0);p([y({type:b.Boolean,context:4,defaultValue:po.ONLY,implicit:!0})],po.prototype,"indirectCRL",void 0);p([y({type:b.Boolean,context:5,defaultValue:po.ONLY,implicit:!0})],po.prototype,"onlyContainsAttributeCerts",void 0);var FN=`${Pe}.21`,s1;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})(s1||(s1={}));var a1=class{constructor(e=s1.unspecified){this.reason=s1.unspecified,this.reason=e}toJSON(){return s1[this.reason]}toString(){return this.toJSON()}};p([y({type:b.Enumerated})],a1.prototype,"reason",void 0);a1=p([M({type:O.Choice})],a1);var tv,p6=`${Pe}.37`,c1=tv=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,tv.prototype)}};c1=tv=p([M({type:O.Sequence,itemType:b.ObjectIdentifier})],c1);var zRe=`${p6}.0`,HN=`${ru}.1`,$N=`${ru}.2`,VN=`${ru}.3`,KN=`${ru}.4`,zN=`${ru}.8`,qN=`${ru}.9`;var XRe=`${Pe}.54`,rv=class{constructor(e=new ArrayBuffer(0)){this.value=e}};p([y({type:b.Integer,converter:Me})],rv.prototype,"value",void 0);rv=p([M({type:O.Choice})],rv);var jN=`${Pe}.24`,l1=class{constructor(e){this.value=new Date,e&&(this.value=e)}};p([y({type:b.GeneralizedTime})],l1.prototype,"value",void 0);l1=p([M({type:O.Choice})],l1);var nv,aDe=`${Pe}.18`,WN=nv=class extends Rt{constructor(e){super(e),Object.setPrototypeOf(this,nv.prototype)}};WN=nv=p([M({type:O.Sequence})],WN);var m6=`${Pe}.15`,Si;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})(Si||(Si={}));var Ud=class extends Ji{toJSON(){let e=this.toNumber(),t=[];return e&Si.cRLSign&&t.push("crlSign"),e&Si.dataEncipherment&&t.push("dataEncipherment"),e&Si.decipherOnly&&t.push("decipherOnly"),e&Si.digitalSignature&&t.push("digitalSignature"),e&Si.encipherOnly&&t.push("encipherOnly"),e&Si.keyAgreement&&t.push("keyAgreement"),e&Si.keyCertSign&&t.push("keyCertSign"),e&Si.keyEncipherment&&t.push("keyEncipherment"),e&Si.nonRepudiation&&t.push("nonRepudiation"),t}toString(){return`[${this.toJSON().join(", ")}]`}};var ov,yDe=`${Pe}.30`,Fd=class{constructor(e={}){this.base=new Se,this.minimum=0,Object.assign(this,e)}};p([y({type:Se})],Fd.prototype,"base",void 0);p([y({type:b.Integer,context:0,defaultValue:0,implicit:!0})],Fd.prototype,"minimum",void 0);p([y({type:b.Integer,context:1,optional:!0,implicit:!0})],Fd.prototype,"maximum",void 0);var g6=ov=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,ov.prototype)}};g6=ov=p([M({type:O.Sequence,itemType:Fd})],g6);var y6=class{constructor(e={}){Object.assign(this,e)}};p([y({type:g6,context:0,optional:!0,implicit:!0})],y6.prototype,"permittedSubtrees",void 0);p([y({type:g6,context:1,optional:!0,implicit:!0})],y6.prototype,"excludedSubtrees",void 0);var EDe=`${Pe}.36`,w6=class{constructor(e={}){Object.assign(this,e)}};p([y({type:b.Integer,context:0,implicit:!0,optional:!0,converter:Me})],w6.prototype,"requireExplicitPolicy",void 0);p([y({type:b.Integer,context:1,implicit:!0,optional:!0,converter:Me})],w6.prototype,"inhibitPolicyMapping",void 0);var iv,TDe=`${Pe}.33`,u1=class{constructor(e={}){this.issuerDomainPolicy="",this.subjectDomainPolicy="",Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],u1.prototype,"issuerDomainPolicy",void 0);p([y({type:b.ObjectIdentifier})],u1.prototype,"subjectDomainPolicy",void 0);var GN=iv=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,iv.prototype)}};GN=iv=p([M({type:O.Sequence,itemType:u1})],GN);var sv,av=`${Pe}.17`,x6=sv=class extends Rt{constructor(e){super(e),Object.setPrototypeOf(this,sv.prototype)}};x6=sv=p([M({type:O.Sequence})],x6);var Hr=class{constructor(e={}){this.type="",this.values=[],Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],Hr.prototype,"type",void 0);p([y({type:b.Any,repeated:"set"})],Hr.prototype,"values",void 0);var cv,zDe=`${Pe}.9`,XN=cv=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,cv.prototype)}};XN=cv=p([M({type:O.Sequence,itemType:Hr})],XN);var lv=`${Pe}.14`,Un=class extends ou{};var JDe=`${Pe}.16`,b6=class{constructor(e={}){Object.assign(this,e)}};p([y({type:b.GeneralizedTime,context:0,implicit:!0,optional:!0})],b6.prototype,"notBefore",void 0);p([y({type:b.GeneralizedTime,context:1,implicit:!0,optional:!0})],b6.prototype,"notAfter",void 0);var f1;(function(r){r[r.keyUpdateAllowed=1]="keyUpdateAllowed",r[r.newExtensions=2]="newExtensions",r[r.pKIXCertificate=4]="pKIXCertificate"})(f1||(f1={}));var v6=class extends Ji{toJSON(){let e=[],t=this.toNumber();return t&f1.pKIXCertificate&&e.push("pKIXCertificate"),t&f1.newExtensions&&e.push("newExtensions"),t&f1.keyUpdateAllowed&&e.push("keyUpdateAllowed"),e}toString(){return`[${this.toJSON().join(", ")}]`}},A6=class{constructor(e={}){this.entrustVers="",this.entrustInfoFlags=new v6,Object.assign(this,e)}};p([y({type:b.GeneralString})],A6.prototype,"entrustVers",void 0);p([y({type:v6})],A6.prototype,"entrustInfoFlags",void 0);var uv,cNe=`${nc}.11`,YN=uv=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,uv.prototype)}};YN=uv=p([M({type:O.Sequence,itemType:Zs})],YN);var QN=st(qs()),Z=class r{constructor(e={}){this.algorithm="",Object.assign(this,e)}isEqual(e){return e instanceof r&&e.algorithm==this.algorithm&&(e.parameters&&this.parameters&&QN.isEqual(e.parameters,this.parameters)||e.parameters===this.parameters)}};p([y({type:b.ObjectIdentifier})],Z.prototype,"algorithm",void 0);p([y({type:b.Any,optional:!0})],Z.prototype,"parameters",void 0);var $r=class{constructor(e={}){this.algorithm=new Z,this.subjectPublicKey=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:Z})],$r.prototype,"algorithm",void 0);p([y({type:b.BitString})],$r.prototype,"subjectPublicKey",void 0);var jt=class{constructor(e){if(e)if(typeof e=="string"||typeof e=="number"||e instanceof Date){let t=new Date(e);t.getUTCFullYear()>2049?this.generalTime=t:this.utcTime=t}else Object.assign(this,e)}getTime(){let e=this.utcTime||this.generalTime;if(!e)throw new Error("Cannot get time from CHOICE object");return e}};p([y({type:b.UTCTime})],jt.prototype,"utcTime",void 0);p([y({type:b.GeneralizedTime})],jt.prototype,"generalTime",void 0);jt=p([M({type:O.Choice})],jt);var ta=class{constructor(e){this.notBefore=new jt(new Date),this.notAfter=new jt(new Date),e&&(this.notBefore=new jt(e.notBefore),this.notAfter=new jt(e.notAfter))}};p([y({type:jt})],ta.prototype,"notBefore",void 0);p([y({type:jt})],ta.prototype,"notAfter",void 0);var fv,Vr=class r{constructor(e={}){this.extnID="",this.critical=r.CRITICAL,this.extnValue=new Ae,Object.assign(this,e)}};Vr.CRITICAL=!1;p([y({type:b.ObjectIdentifier})],Vr.prototype,"extnID",void 0);p([y({type:b.Boolean,defaultValue:Vr.CRITICAL})],Vr.prototype,"critical",void 0);p([y({type:Ae})],Vr.prototype,"extnValue",void 0);var mo=fv=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,fv.prototype)}};mo=fv=p([M({type:O.Sequence,itemType:Vr})],mo);var ns;(function(r){r[r.v1=0]="v1",r[r.v2=1]="v2",r[r.v3=2]="v3"})(ns||(ns={}));var Kr=class{constructor(e={}){this.version=ns.v1,this.serialNumber=new ArrayBuffer(0),this.signature=new Z,this.issuer=new dt,this.validity=new ta,this.subject=new dt,this.subjectPublicKeyInfo=new $r,Object.assign(this,e)}};p([y({type:b.Integer,context:0,defaultValue:ns.v1})],Kr.prototype,"version",void 0);p([y({type:b.Integer,converter:Me})],Kr.prototype,"serialNumber",void 0);p([y({type:Z})],Kr.prototype,"signature",void 0);p([y({type:dt})],Kr.prototype,"issuer",void 0);p([y({type:ta})],Kr.prototype,"validity",void 0);p([y({type:dt})],Kr.prototype,"subject",void 0);p([y({type:$r})],Kr.prototype,"subjectPublicKeyInfo",void 0);p([y({type:b.BitString,context:1,implicit:!0,optional:!0})],Kr.prototype,"issuerUniqueID",void 0);p([y({type:b.BitString,context:2,implicit:!0,optional:!0})],Kr.prototype,"subjectUniqueID",void 0);p([y({type:mo,context:3,optional:!0})],Kr.prototype,"extensions",void 0);var Ho=class{constructor(e={}){this.tbsCertificate=new Kr,this.signatureAlgorithm=new Z,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:Kr})],Ho.prototype,"tbsCertificate",void 0);p([y({type:Z})],Ho.prototype,"signatureAlgorithm",void 0);p([y({type:b.BitString})],Ho.prototype,"signatureValue",void 0);var au=class{constructor(e={}){this.userCertificate=new ArrayBuffer(0),this.revocationDate=new jt,Object.assign(this,e)}};p([y({type:b.Integer,converter:Me})],au.prototype,"userCertificate",void 0);p([y({type:jt})],au.prototype,"revocationDate",void 0);p([y({type:Vr,optional:!0,repeated:"sequence"})],au.prototype,"crlEntryExtensions",void 0);var go=class{constructor(e={}){this.signature=new Z,this.issuer=new dt,this.thisUpdate=new jt,Object.assign(this,e)}};p([y({type:b.Integer,optional:!0})],go.prototype,"version",void 0);p([y({type:Z})],go.prototype,"signature",void 0);p([y({type:dt})],go.prototype,"issuer",void 0);p([y({type:jt})],go.prototype,"thisUpdate",void 0);p([y({type:jt,optional:!0})],go.prototype,"nextUpdate",void 0);p([y({type:au,repeated:"sequence",optional:!0})],go.prototype,"revokedCertificates",void 0);p([y({type:Vr,optional:!0,context:0,repeated:"sequence"})],go.prototype,"crlExtensions",void 0);var cu=class{constructor(e={}){this.tbsCertList=new go,this.signatureAlgorithm=new Z,this.signature=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:go})],cu.prototype,"tbsCertList",void 0);p([y({type:Z})],cu.prototype,"signatureAlgorithm",void 0);p([y({type:b.BitString})],cu.prototype,"signature",void 0);var J=st(qs());var _i=class{constructor(e={}){this.issuer=new dt,this.serialNumber=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:dt})],_i.prototype,"issuer",void 0);p([y({type:b.Integer,converter:Me})],_i.prototype,"serialNumber",void 0);var lu=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Un,context:0,implicit:!0})],lu.prototype,"subjectKeyIdentifier",void 0);p([y({type:_i})],lu.prototype,"issuerAndSerialNumber",void 0);lu=p([M({type:O.Choice})],lu);var zr;(function(r){r[r.v0=0]="v0",r[r.v1=1]="v1",r[r.v2=2]="v2",r[r.v3=3]="v3",r[r.v4=4]="v4",r[r.v5=5]="v5"})(zr||(zr={}));var uu=class extends Z{};uu=p([M({type:O.Sequence})],uu);var d1=class extends Z{};d1=p([M({type:O.Sequence})],d1);var Fn=class extends Z{};Fn=p([M({type:O.Sequence})],Fn);var h1=class extends Z{};h1=p([M({type:O.Sequence})],h1);var JN=class extends Z{};JN=p([M({type:O.Sequence})],JN);var E6=class extends Z{};E6=p([M({type:O.Sequence})],E6);var Ci=class{constructor(e={}){this.attrType="",this.attrValues=[],Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],Ci.prototype,"attrType",void 0);p([y({type:b.Any,repeated:"set"})],Ci.prototype,"attrValues",void 0);var dv,Hn=class{constructor(e={}){this.version=zr.v0,this.sid=new lu,this.digestAlgorithm=new uu,this.signatureAlgorithm=new d1,this.signature=new Ae,Object.assign(this,e)}};p([y({type:b.Integer})],Hn.prototype,"version",void 0);p([y({type:lu})],Hn.prototype,"sid",void 0);p([y({type:uu})],Hn.prototype,"digestAlgorithm",void 0);p([y({type:Ci,repeated:"set",context:0,implicit:!0,optional:!0})],Hn.prototype,"signedAttrs",void 0);p([y({type:d1})],Hn.prototype,"signatureAlgorithm",void 0);p([y({type:Ae})],Hn.prototype,"signature",void 0);p([y({type:Ci,repeated:"set",context:1,implicit:!0,optional:!0})],Hn.prototype,"unsignedAttrs",void 0);var p1=dv=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,dv.prototype)}};p1=dv=p([M({type:O.Set,itemType:Hn})],p1);var eO=class extends jt{};eO=p([M({type:O.Choice})],eO);var tO=class extends Hn{};tO=p([M({type:O.Sequence})],tO);var m1=class{constructor(e={}){this.acIssuer=new Se,this.acSerial=0,this.attrs=[],Object.assign(this,e)}};p([y({type:Se})],m1.prototype,"acIssuer",void 0);p([y({type:b.Integer})],m1.prototype,"acSerial",void 0);p([y({type:Hr,repeated:"sequence"})],m1.prototype,"attrs",void 0);var hv,g1=hv=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,hv.prototype)}};g1=hv=p([M({type:O.Sequence,itemType:b.ObjectIdentifier})],g1);var Hd=class{constructor(e={}){this.permitUnSpecified=!0,Object.assign(this,e)}};p([y({type:b.Integer,optional:!0})],Hd.prototype,"pathLenConstraint",void 0);p([y({type:g1,implicit:!0,context:0,optional:!0})],Hd.prototype,"permittedAttrs",void 0);p([y({type:g1,implicit:!0,context:1,optional:!0})],Hd.prototype,"excludedAttrs",void 0);p([y({type:b.Boolean,defaultValue:!0})],Hd.prototype,"permitUnSpecified",void 0);var $o=class{constructor(e={}){this.issuer=new Rt,this.serial=new ArrayBuffer(0),this.issuerUID=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:Rt})],$o.prototype,"issuer",void 0);p([y({type:b.Integer,converter:Me})],$o.prototype,"serial",void 0);p([y({type:b.BitString,optional:!0})],$o.prototype,"issuerUID",void 0);var pv;(function(r){r[r.publicKey=0]="publicKey",r[r.publicKeyCert=1]="publicKeyCert",r[r.otherObjectTypes=2]="otherObjectTypes"})(pv||(pv={}));var Vo=class{constructor(e={}){this.digestedObjectType=pv.publicKey,this.digestAlgorithm=new Z,this.objectDigest=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:b.Enumerated})],Vo.prototype,"digestedObjectType",void 0);p([y({type:b.ObjectIdentifier,optional:!0})],Vo.prototype,"otherObjectTypeID",void 0);p([y({type:Z})],Vo.prototype,"digestAlgorithm",void 0);p([y({type:b.BitString})],Vo.prototype,"objectDigest",void 0);var fu=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Rt,optional:!0})],fu.prototype,"issuerName",void 0);p([y({type:$o,context:0,implicit:!0,optional:!0})],fu.prototype,"baseCertificateID",void 0);p([y({type:Vo,context:1,implicit:!0,optional:!0})],fu.prototype,"objectDigestInfo",void 0);var du=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Se,repeated:"sequence"})],du.prototype,"v1Form",void 0);p([y({type:fu,context:0,implicit:!0})],du.prototype,"v2Form",void 0);du=p([M({type:O.Choice})],du);var hu=class{constructor(e={}){this.notBeforeTime=new Date,this.notAfterTime=new Date,Object.assign(this,e)}};p([y({type:b.GeneralizedTime})],hu.prototype,"notBeforeTime",void 0);p([y({type:b.GeneralizedTime})],hu.prototype,"notAfterTime",void 0);var ic=class{constructor(e={}){Object.assign(this,e)}};p([y({type:$o,implicit:!0,context:0,optional:!0})],ic.prototype,"baseCertificateID",void 0);p([y({type:Rt,implicit:!0,context:1,optional:!0})],ic.prototype,"entityName",void 0);p([y({type:Vo,implicit:!0,context:2,optional:!0})],ic.prototype,"objectDigestInfo",void 0);var mv;(function(r){r[r.v2=1]="v2"})(mv||(mv={}));var $n=class{constructor(e={}){this.version=mv.v2,this.holder=new ic,this.issuer=new du,this.signature=new Z,this.serialNumber=new ArrayBuffer(0),this.attrCertValidityPeriod=new hu,this.attributes=[],Object.assign(this,e)}};p([y({type:b.Integer})],$n.prototype,"version",void 0);p([y({type:ic})],$n.prototype,"holder",void 0);p([y({type:du})],$n.prototype,"issuer",void 0);p([y({type:Z})],$n.prototype,"signature",void 0);p([y({type:b.Integer,converter:Me})],$n.prototype,"serialNumber",void 0);p([y({type:hu})],$n.prototype,"attrCertValidityPeriod",void 0);p([y({type:Hr,repeated:"sequence"})],$n.prototype,"attributes",void 0);p([y({type:b.BitString,optional:!0})],$n.prototype,"issuerUniqueID",void 0);p([y({type:mo,optional:!0})],$n.prototype,"extensions",void 0);var pu=class{constructor(e={}){this.acinfo=new $n,this.signatureAlgorithm=new Z,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:$n})],pu.prototype,"acinfo",void 0);p([y({type:Z})],pu.prototype,"signatureAlgorithm",void 0);p([y({type:b.BitString})],pu.prototype,"signatureValue",void 0);var y1;(function(r){r[r.unmarked=1]="unmarked",r[r.unclassified=2]="unclassified",r[r.restricted=4]="restricted",r[r.confidential=8]="confidential",r[r.secret=16]="secret",r[r.topSecret=32]="topSecret"})(y1||(y1={}));var $d=class extends Ji{};var Vd=class{constructor(e={}){this.type="",this.value=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:b.ObjectIdentifier,implicit:!0,context:0})],Vd.prototype,"type",void 0);p([y({type:b.Any,implicit:!0,context:1})],Vd.prototype,"value",void 0);var w1=class{constructor(e={}){this.policyId="",this.classList=new $d(y1.unclassified),Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],w1.prototype,"policyId",void 0);p([y({type:$d,defaultValue:new $d(y1.unclassified)})],w1.prototype,"classList",void 0);p([y({type:Vd,repeated:"set"})],w1.prototype,"securityCategories",void 0);var Kd=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Ae})],Kd.prototype,"cotets",void 0);p([y({type:b.ObjectIdentifier})],Kd.prototype,"oid",void 0);p([y({type:b.Utf8String})],Kd.prototype,"string",void 0);var S6=class{constructor(e={}){this.values=[],Object.assign(this,e)}};p([y({type:Rt,implicit:!0,context:0,optional:!0})],S6.prototype,"policyAuthority",void 0);p([y({type:Kd,repeated:"sequence"})],S6.prototype,"values",void 0);var VBe=`${nc}.4`,KBe=`${nc}.6`,zBe=`${nc}.10`,qBe=`${Pe}.55`,x1=`${rc}.10`,jBe=`${x1}.1`,WBe=`${x1}.2`,GBe=`${x1}.3`,XBe=`${x1}.4`,YBe=`${x1}.6`,gv="2.5.4",QBe=`${gv}.72`;var yv,zd=class{constructor(e={}){this.targetCertificate=new $o,Object.assign(this,e)}};p([y({type:$o})],zd.prototype,"targetCertificate",void 0);p([y({type:Se,optional:!0})],zd.prototype,"targetName",void 0);p([y({type:Vo,optional:!0})],zd.prototype,"certDigestInfo",void 0);var qd=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Se,context:0,implicit:!0})],qd.prototype,"targetName",void 0);p([y({type:Se,context:1,implicit:!0})],qd.prototype,"targetGroup",void 0);p([y({type:zd,context:2,implicit:!0})],qd.prototype,"targetCert",void 0);qd=p([M({type:O.Choice})],qd);var _6=yv=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,yv.prototype)}};_6=yv=p([M({type:O.Sequence,itemType:qd})],_6);var wv,rO=wv=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,wv.prototype)}};rO=wv=p([M({type:O.Sequence,itemType:_6})],rO);var C6=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Rt,implicit:!0,context:0,optional:!0})],C6.prototype,"roleAuthority",void 0);p([y({type:Se,implicit:!0,context:1})],C6.prototype,"roleName",void 0);var b1=class{constructor(e={}){this.service=new Se,this.ident=new Se,Object.assign(this,e)}};p([y({type:Se})],b1.prototype,"service",void 0);p([y({type:Se})],b1.prototype,"ident",void 0);p([y({type:Ae,optional:!0})],b1.prototype,"authInfo",void 0);var xv,v1=class{constructor(e={}){this.otherCertFormat="",this.otherCert=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],v1.prototype,"otherCertFormat",void 0);p([y({type:b.Any})],v1.prototype,"otherCert",void 0);var mu=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Ho})],mu.prototype,"certificate",void 0);p([y({type:pu,context:2,implicit:!0})],mu.prototype,"v2AttrCert",void 0);p([y({type:v1,context:3,implicit:!0})],mu.prototype,"other",void 0);mu=p([M({type:O.Choice})],mu);var gu=xv=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,xv.prototype)}};gu=xv=p([M({type:O.Set,itemType:mu})],gu);var Ko=class{constructor(e={}){this.contentType="",this.content=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],Ko.prototype,"contentType",void 0);p([y({type:b.Any,context:0})],Ko.prototype,"content",void 0);var jd=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Ae})],jd.prototype,"single",void 0);p([y({type:b.Any})],jd.prototype,"any",void 0);jd=p([M({type:O.Choice})],jd);var yu=class{constructor(e={}){this.eContentType="",Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],yu.prototype,"eContentType",void 0);p([y({type:jd,context:0,optional:!0})],yu.prototype,"eContent",void 0);var A1=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Ae,context:0,implicit:!0,optional:!0})],A1.prototype,"value",void 0);p([y({type:Ae,converter:kN,context:0,implicit:!0,optional:!0,repeated:"sequence"})],A1.prototype,"constructedValue",void 0);A1=p([M({type:O.Choice})],A1);var sc=class{constructor(e={}){this.contentType="",this.contentEncryptionAlgorithm=new h1,Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],sc.prototype,"contentType",void 0);p([y({type:h1})],sc.prototype,"contentEncryptionAlgorithm",void 0);p([y({type:A1,optional:!0})],sc.prototype,"encryptedContent",void 0);var ac=class{constructor(e={}){this.keyAttrId="",Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],ac.prototype,"keyAttrId",void 0);p([y({type:b.Any,optional:!0})],ac.prototype,"keyAttr",void 0);var bv,Wd=class{constructor(e={}){this.subjectKeyIdentifier=new Un,Object.assign(this,e)}};p([y({type:Un})],Wd.prototype,"subjectKeyIdentifier",void 0);p([y({type:b.GeneralizedTime,optional:!0})],Wd.prototype,"date",void 0);p([y({type:ac,optional:!0})],Wd.prototype,"other",void 0);var Gd=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Wd,context:0,implicit:!0,optional:!0})],Gd.prototype,"rKeyId",void 0);p([y({type:_i,optional:!0})],Gd.prototype,"issuerAndSerialNumber",void 0);Gd=p([M({type:O.Choice})],Gd);var E1=class{constructor(e={}){this.rid=new Gd,this.encryptedKey=new Ae,Object.assign(this,e)}};p([y({type:Gd})],E1.prototype,"rid",void 0);p([y({type:Ae})],E1.prototype,"encryptedKey",void 0);var I6=bv=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,bv.prototype)}};I6=bv=p([M({type:O.Sequence,itemType:E1})],I6);var S1=class{constructor(e={}){this.algorithm=new Z,this.publicKey=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:Z})],S1.prototype,"algorithm",void 0);p([y({type:b.BitString})],S1.prototype,"publicKey",void 0);var wu=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Un,context:0,implicit:!0,optional:!0})],wu.prototype,"subjectKeyIdentifier",void 0);p([y({type:S1,context:1,implicit:!0,optional:!0})],wu.prototype,"originatorKey",void 0);p([y({type:_i,optional:!0})],wu.prototype,"issuerAndSerialNumber",void 0);wu=p([M({type:O.Choice})],wu);var ra=class{constructor(e={}){this.version=zr.v3,this.originator=new wu,this.keyEncryptionAlgorithm=new Fn,this.recipientEncryptedKeys=new I6,Object.assign(this,e)}};p([y({type:b.Integer})],ra.prototype,"version",void 0);p([y({type:wu,context:0})],ra.prototype,"originator",void 0);p([y({type:Ae,context:1,optional:!0})],ra.prototype,"ukm",void 0);p([y({type:Fn})],ra.prototype,"keyEncryptionAlgorithm",void 0);p([y({type:I6})],ra.prototype,"recipientEncryptedKeys",void 0);var Xd=class{constructor(e={}){Object.assign(this,e)}};p([y({type:Un,context:0,implicit:!0})],Xd.prototype,"subjectKeyIdentifier",void 0);p([y({type:_i})],Xd.prototype,"issuerAndSerialNumber",void 0);Xd=p([M({type:O.Choice})],Xd);var cc=class{constructor(e={}){this.version=zr.v0,this.rid=new Xd,this.keyEncryptionAlgorithm=new Fn,this.encryptedKey=new Ae,Object.assign(this,e)}};p([y({type:b.Integer})],cc.prototype,"version",void 0);p([y({type:Xd})],cc.prototype,"rid",void 0);p([y({type:Fn})],cc.prototype,"keyEncryptionAlgorithm",void 0);p([y({type:Ae})],cc.prototype,"encryptedKey",void 0);var xu=class{constructor(e={}){this.keyIdentifier=new Ae,Object.assign(this,e)}};p([y({type:Ae})],xu.prototype,"keyIdentifier",void 0);p([y({type:b.GeneralizedTime,optional:!0})],xu.prototype,"date",void 0);p([y({type:ac,optional:!0})],xu.prototype,"other",void 0);var lc=class{constructor(e={}){this.version=zr.v4,this.kekid=new xu,this.keyEncryptionAlgorithm=new Fn,this.encryptedKey=new Ae,Object.assign(this,e)}};p([y({type:b.Integer})],lc.prototype,"version",void 0);p([y({type:xu})],lc.prototype,"kekid",void 0);p([y({type:Fn})],lc.prototype,"keyEncryptionAlgorithm",void 0);p([y({type:Ae})],lc.prototype,"encryptedKey",void 0);var uc=class{constructor(e={}){this.version=zr.v0,this.keyEncryptionAlgorithm=new Fn,this.encryptedKey=new Ae,Object.assign(this,e)}};p([y({type:b.Integer})],uc.prototype,"version",void 0);p([y({type:E6,context:0,optional:!0})],uc.prototype,"keyDerivationAlgorithm",void 0);p([y({type:Fn})],uc.prototype,"keyEncryptionAlgorithm",void 0);p([y({type:Ae})],uc.prototype,"encryptedKey",void 0);var _1=class{constructor(e={}){this.oriType="",this.oriValue=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],_1.prototype,"oriType",void 0);p([y({type:b.Any})],_1.prototype,"oriValue",void 0);var na=class{constructor(e={}){Object.assign(this,e)}};p([y({type:cc,optional:!0})],na.prototype,"ktri",void 0);p([y({type:ra,context:1,implicit:!0,optional:!0})],na.prototype,"kari",void 0);p([y({type:lc,context:2,implicit:!0,optional:!0})],na.prototype,"kekri",void 0);p([y({type:uc,context:3,implicit:!0,optional:!0})],na.prototype,"pwri",void 0);p([y({type:_1,context:4,implicit:!0,optional:!0})],na.prototype,"ori",void 0);na=p([M({type:O.Choice})],na);var vv,C1=vv=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,vv.prototype)}};C1=vv=p([M({type:O.Set,itemType:na})],C1);var Av,nO=`${rc}.16`,YUe=`${nO}.2`,QUe=`${nO}.4`,Yd=class{constructor(e={}){this.otherRevInfoFormat="",this.otherRevInfo=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],Yd.prototype,"otherRevInfoFormat",void 0);p([y({type:b.Any})],Yd.prototype,"otherRevInfo",void 0);var T6=class{constructor(e={}){this.other=new Yd,Object.assign(this,e)}};p([y({type:Yd,context:1,implicit:!0})],T6.prototype,"other",void 0);T6=p([M({type:O.Choice})],T6);var Qd=Av=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,Av.prototype)}};Qd=Av=p([M({type:O.Set,itemType:T6})],Qd);var Zd=class{constructor(e={}){Object.assign(this,e)}};p([y({type:gu,context:0,implicit:!0,optional:!0})],Zd.prototype,"certs",void 0);p([y({type:Qd,context:1,implicit:!0,optional:!0})],Zd.prototype,"crls",void 0);var Ev,Sv=Ev=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,Ev.prototype)}};Sv=Ev=p([M({type:O.Set,itemType:Ci})],Sv);var bu=class{constructor(e={}){this.version=zr.v0,this.recipientInfos=new C1,this.encryptedContentInfo=new sc,Object.assign(this,e)}};p([y({type:b.Integer})],bu.prototype,"version",void 0);p([y({type:Zd,context:0,implicit:!0,optional:!0})],bu.prototype,"originatorInfo",void 0);p([y({type:C1})],bu.prototype,"recipientInfos",void 0);p([y({type:sc})],bu.prototype,"encryptedContentInfo",void 0);p([y({type:Sv,context:1,implicit:!0,optional:!0})],bu.prototype,"unprotectedAttrs",void 0);var oO="1.2.840.113549.1.7.2";var _v,k6=_v=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,_v.prototype)}};k6=_v=p([M({type:O.Set,itemType:uu})],k6);var oa=class{constructor(e={}){this.version=zr.v0,this.digestAlgorithms=new k6,this.encapContentInfo=new yu,this.signerInfos=new p1,Object.assign(this,e)}};p([y({type:b.Integer})],oa.prototype,"version",void 0);p([y({type:k6})],oa.prototype,"digestAlgorithms",void 0);p([y({type:yu})],oa.prototype,"encapContentInfo",void 0);p([y({type:gu,context:0,implicit:!0,optional:!0})],oa.prototype,"certificates",void 0);p([y({type:Qd,context:1,implicit:!0,optional:!0})],oa.prototype,"crls",void 0);p([y({type:p1})],oa.prototype,"signerInfos",void 0);var vu="1.2.840.10045.2.1";var I1="1.2.840.10045.4.1",P6="1.2.840.10045.4.3.1",T1="1.2.840.10045.4.3.2",k1="1.2.840.10045.4.3.3",P1="1.2.840.10045.4.3.4";var Cv="1.2.840.10045.3.1.7";var Iv="1.3.132.0.34";var Tv="1.3.132.0.35";function R1(r){return new Z({algorithm:r})}var sO=R1(I1),WFe=R1(P6),aO=R1(T1),cO=R1(k1),lO=R1(P1);var D1=class{constructor(e={}){Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],D1.prototype,"fieldType",void 0);p([y({type:b.Any})],D1.prototype,"parameters",void 0);D1=p([M({type:O.Sequence})],D1);var kv=class extends Ae{};var Jd=class{constructor(e={}){Object.assign(this,e)}};p([y({type:b.OctetString})],Jd.prototype,"a",void 0);p([y({type:b.OctetString})],Jd.prototype,"b",void 0);p([y({type:b.BitString,optional:!0})],Jd.prototype,"seed",void 0);Jd=p([M({type:O.Sequence})],Jd);var Pv;(function(r){r[r.ecpVer1=1]="ecpVer1"})(Pv||(Pv={}));var os=class{constructor(e={}){this.version=Pv.ecpVer1,Object.assign(this,e)}};p([y({type:b.Integer})],os.prototype,"version",void 0);p([y({type:D1})],os.prototype,"fieldID",void 0);p([y({type:Jd})],os.prototype,"curve",void 0);p([y({type:kv})],os.prototype,"base",void 0);p([y({type:b.Integer,converter:Me})],os.prototype,"order",void 0);p([y({type:b.Integer,optional:!0})],os.prototype,"cofactor",void 0);os=p([M({type:O.Sequence})],os);var is=class{constructor(e={}){Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],is.prototype,"namedCurve",void 0);p([y({type:b.Null})],is.prototype,"implicitCurve",void 0);p([y({type:os})],is.prototype,"specifiedCurve",void 0);is=p([M({type:O.Choice})],is);var eh=class{constructor(e={}){this.version=1,this.privateKey=new Ae,Object.assign(this,e)}};p([y({type:b.Integer})],eh.prototype,"version",void 0);p([y({type:Ae})],eh.prototype,"privateKey",void 0);p([y({type:is,context:0,optional:!0})],eh.prototype,"parameters",void 0);p([y({type:b.BitString,context:1,optional:!0})],eh.prototype,"publicKey",void 0);var Au=class{constructor(e={}){this.r=new ArrayBuffer(0),this.s=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:b.Integer,converter:Me})],Au.prototype,"r",void 0);p([y({type:b.Integer,converter:Me})],Au.prototype,"s",void 0);var Vn="1.2.840.113549.1.1",ss=`${Vn}.1`,uO=`${Vn}.7`,fO=`${Vn}.9`,fc=`${Vn}.10`,dO=`${Vn}.2`,hO=`${Vn}.4`,th=`${Vn}.5`,pO=`${Vn}.14`;var R6=`${Vn}.11`,rh=`${Vn}.12`,nh=`${Vn}.13`,Rv=`${Vn}.15`,Dv=`${Vn}.16`,Eu="1.3.14.3.2.26",D6="2.16.840.1.101.3.4.2.4",Su="2.16.840.1.101.3.4.2.1",_u="2.16.840.1.101.3.4.2.2",Cu="2.16.840.1.101.3.4.2.3",mO="2.16.840.1.101.3.4.2.5",gO="2.16.840.1.101.3.4.2.6",yO="1.2.840.113549.2.2",wO="1.2.840.113549.2.5",dc=`${Vn}.8`;function yr(r){return new Z({algorithm:r,parameters:null})}var vHe=yr(yO),AHe=yr(wO),ia=yr(Eu),EHe=yr(D6),SHe=yr(Su),_He=yr(_u),CHe=yr(Cu),IHe=yr(mO),THe=yr(gO),N6=new Z({algorithm:dc,parameters:te.serialize(ia)}),Nv=new Z({algorithm:fO,parameters:te.serialize(Od.toASN(new Uint8Array([218,57,163,238,94,107,75,13,50,85,191,239,149,96,24,144,175,216,7,9]).buffer))}),kHe=yr(ss),PHe=yr(dO),RHe=yr(hO),DHe=yr(th),NHe=yr(Rv),OHe=yr(Dv),LHe=yr(rh),BHe=yr(nh),MHe=yr(Rv),UHe=yr(Dv);var oh=class{constructor(e={}){this.hashAlgorithm=new Z(ia),this.maskGenAlgorithm=new Z({algorithm:dc,parameters:te.serialize(ia)}),this.pSourceAlgorithm=new Z(Nv),Object.assign(this,e)}};p([y({type:Z,context:0,defaultValue:ia})],oh.prototype,"hashAlgorithm",void 0);p([y({type:Z,context:1,defaultValue:N6})],oh.prototype,"maskGenAlgorithm",void 0);p([y({type:Z,context:2,defaultValue:Nv})],oh.prototype,"pSourceAlgorithm",void 0);var qHe=new Z({algorithm:uO,parameters:te.serialize(new oh)});var as=class{constructor(e={}){this.hashAlgorithm=new Z(ia),this.maskGenAlgorithm=new Z({algorithm:dc,parameters:te.serialize(ia)}),this.saltLength=20,this.trailerField=1,Object.assign(this,e)}};p([y({type:Z,context:0,defaultValue:ia})],as.prototype,"hashAlgorithm",void 0);p([y({type:Z,context:1,defaultValue:N6})],as.prototype,"maskGenAlgorithm",void 0);p([y({type:b.Integer,context:2,defaultValue:20})],as.prototype,"saltLength",void 0);p([y({type:b.Integer,context:3,defaultValue:1})],as.prototype,"trailerField",void 0);var ZHe=new Z({algorithm:fc,parameters:te.serialize(new as)});var Iu=class{constructor(e={}){this.digestAlgorithm=new Z,this.digest=new Ae,Object.assign(this,e)}};p([y({type:Z})],Iu.prototype,"digestAlgorithm",void 0);p([y({type:Ae})],Iu.prototype,"digest",void 0);var Ov,ih=class{constructor(e={}){this.prime=new ArrayBuffer(0),this.exponent=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:b.Integer,converter:Me})],ih.prototype,"prime",void 0);p([y({type:b.Integer,converter:Me})],ih.prototype,"exponent",void 0);p([y({type:b.Integer,converter:Me})],ih.prototype,"coefficient",void 0);var O6=Ov=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,Ov.prototype)}};O6=Ov=p([M({type:O.Sequence,itemType:ih})],O6);var zo=class{constructor(e={}){this.version=0,this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),this.privateExponent=new ArrayBuffer(0),this.prime1=new ArrayBuffer(0),this.prime2=new ArrayBuffer(0),this.exponent1=new ArrayBuffer(0),this.exponent2=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:b.Integer})],zo.prototype,"version",void 0);p([y({type:b.Integer,converter:Me})],zo.prototype,"modulus",void 0);p([y({type:b.Integer,converter:Me})],zo.prototype,"publicExponent",void 0);p([y({type:b.Integer,converter:Me})],zo.prototype,"privateExponent",void 0);p([y({type:b.Integer,converter:Me})],zo.prototype,"prime1",void 0);p([y({type:b.Integer,converter:Me})],zo.prototype,"prime2",void 0);p([y({type:b.Integer,converter:Me})],zo.prototype,"exponent1",void 0);p([y({type:b.Integer,converter:Me})],zo.prototype,"exponent2",void 0);p([y({type:b.Integer,converter:Me})],zo.prototype,"coefficient",void 0);p([y({type:O6,optional:!0})],zo.prototype,"otherPrimeInfos",void 0);var sh=class{constructor(e={}){this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:b.Integer,converter:Me})],sh.prototype,"modulus",void 0);p([y({type:b.Integer,converter:Me})],sh.prototype,"publicExponent",void 0);var Lv;(function(r){r[r.Transient=0]="Transient",r[r.Singleton=1]="Singleton",r[r.ResolutionScoped=2]="ResolutionScoped",r[r.ContainerScoped=3]="ContainerScoped"})(Lv||(Lv={}));var qr=Lv;var YY="injectionTokens";function Bv(r){var e=Reflect.getMetadata("design:paramtypes",r)||[],t=Reflect.getOwnMetadata(YY,r)||{};return Object.keys(t).forEach(function(n){e[+n]=t[n]}),e}function N1(r){return!!r.useClass}function ah(r){return!!r.useFactory}var L6=function(){function r(e){this.wrap=e,this.reflectMethods=["get","getPrototypeOf","setPrototypeOf","getOwnPropertyDescriptor","defineProperty","has","set","deleteProperty","apply","construct","ownKeys"]}return r.prototype.createProxy=function(e){var t=this,n={},o=!1,i,s=function(){return o||(i=e(t.wrap()),o=!0),i};return new Proxy(n,this.createHandler(s))},r.prototype.createHandler=function(e){var t={},n=function(o){t[o]=function(){for(var i=[],s=0;s<arguments.length;s++)i[s]=arguments[s];i[0]=e();var a=Reflect[o];return a.apply(void 0,es(i))}};return this.reflectMethods.forEach(n),t},r}();function hc(r){return typeof r=="string"||typeof r=="symbol"}function Mv(r){return typeof r=="object"&&"token"in r&&"multiple"in r}function B6(r){return typeof r=="object"&&"token"in r&&"transform"in r}function xO(r){return typeof r=="function"||r instanceof L6}function Tu(r){return!!r.useToken}function ku(r){return r.useValue!=null}function bO(r){return N1(r)||ku(r)||Tu(r)||ah(r)}var QY=function(){function r(){this._registryMap=new Map}return r.prototype.entries=function(){return this._registryMap.entries()},r.prototype.getAll=function(e){return this.ensure(e),this._registryMap.get(e)},r.prototype.get=function(e){this.ensure(e);var t=this._registryMap.get(e);return t[t.length-1]||null},r.prototype.set=function(e,t){this.ensure(e),this._registryMap.get(e).push(t)},r.prototype.setAll=function(e,t){this._registryMap.set(e,t)},r.prototype.has=function(e){return this.ensure(e),this._registryMap.get(e).length>0},r.prototype.clear=function(){this._registryMap.clear()},r.prototype.ensure=function(e){this._registryMap.has(e)||this._registryMap.set(e,[])},r}(),O1=QY;var ZY=function(r){Ym(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(O1),vO=ZY;var JY=function(){function r(){this.scopedResolutions=new Map}return r}(),L1=JY;function eQ(r,e){if(r===null)return"at position #"+e;var t=r.split(",")[e].trim();return'"'+t+'" at position #'+e}function tQ(r,e,t){return t===void 0&&(t="    "),es([r],e.message.split(`
`).map(function(n){return t+n})).join(`
`)}function Uv(r,e,t){var n=Bd(r.toString().match(/constructor\(([\w, ]+)\)/)||[],2),o=n[1],i=o===void 0?null:o,s=eQ(i,e);return tQ("Cannot inject the dependency "+s+' of "'+r.name+'" constructor. Reason:',t)}function AO(r){if(typeof r.dispose!="function")return!1;var e=r.dispose;return!(e.length>0)}var rQ=function(r){Ym(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(O1);var nQ=function(r){Ym(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(O1);var oQ=function(){function r(){this.preResolution=new rQ,this.postResolution=new nQ}return r}(),EO=oQ;var Fv=new Map,iQ=function(){function r(e){this.parent=e,this._registry=new vO,this.interceptors=new EO,this.disposed=!1,this.disposables=new Set}return r.prototype.register=function(e,t,n){n===void 0&&(n={lifecycle:qr.Transient}),this.ensureNotDisposed();var o;if(bO(t)?o=t:o={useClass:t},Tu(o))for(var i=[e],s=o;s!=null;){var a=s.useToken;if(i.includes(a))throw new Error("Token registration cycle detected! "+es(i,[a]).join(" -> "));i.push(a);var c=this._registry.get(a);c&&Tu(c.provider)?s=c.provider:s=null}if((n.lifecycle===qr.Singleton||n.lifecycle==qr.ContainerScoped||n.lifecycle==qr.ResolutionScoped)&&(ku(o)||ah(o)))throw new Error('Cannot use lifecycle "'+qr[n.lifecycle]+'" with ValueProviders or FactoryProviders');return this._registry.set(e,{provider:o,options:n}),this},r.prototype.registerType=function(e,t){return this.ensureNotDisposed(),hc(t)?this.register(e,{useToken:t}):this.register(e,{useClass:t})},r.prototype.registerInstance=function(e,t){return this.ensureNotDisposed(),this.register(e,{useValue:t})},r.prototype.registerSingleton=function(e,t){if(this.ensureNotDisposed(),hc(e)){if(hc(t))return this.register(e,{useToken:t},{lifecycle:qr.Singleton});if(t)return this.register(e,{useClass:t},{lifecycle:qr.Singleton});throw new Error('Cannot register a type name as a singleton without a "to" token')}var n=e;return t&&!hc(t)&&(n=t),this.register(e,{useClass:n},{lifecycle:qr.Singleton})},r.prototype.resolve=function(e,t,n){t===void 0&&(t=new L1),n===void 0&&(n=!1),this.ensureNotDisposed();var o=this.getRegistration(e);if(!o&&hc(e)){if(n)return;throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"Single"),o){var i=this.resolveRegistration(o,t);return this.executePostResolutionInterceptor(e,i,"Single"),i}if(xO(e)){var i=this.construct(e,t);return this.executePostResolutionInterceptor(e,i,"Single"),i}throw new Error("Attempted to construct an undefined constructor. Could mean a circular dependency problem. Try using `delay` function.")},r.prototype.executePreResolutionInterceptor=function(e,t){var n,o;if(this.interceptors.preResolution.has(e)){var i=[];try{for(var s=Qm(this.interceptors.preResolution.getAll(e)),a=s.next();!a.done;a=s.next()){var c=a.value;c.options.frequency!="Once"&&i.push(c),c.callback(e,t)}}catch(l){n={error:l}}finally{try{a&&!a.done&&(o=s.return)&&o.call(s)}finally{if(n)throw n.error}}this.interceptors.preResolution.setAll(e,i)}},r.prototype.executePostResolutionInterceptor=function(e,t,n){var o,i;if(this.interceptors.postResolution.has(e)){var s=[];try{for(var a=Qm(this.interceptors.postResolution.getAll(e)),c=a.next();!c.done;c=a.next()){var l=c.value;l.options.frequency!="Once"&&s.push(l),l.callback(e,t,n)}}catch(u){o={error:u}}finally{try{c&&!c.done&&(i=a.return)&&i.call(a)}finally{if(o)throw o.error}}this.interceptors.postResolution.setAll(e,s)}},r.prototype.resolveRegistration=function(e,t){if(this.ensureNotDisposed(),e.options.lifecycle===qr.ResolutionScoped&&t.scopedResolutions.has(e))return t.scopedResolutions.get(e);var n=e.options.lifecycle===qr.Singleton,o=e.options.lifecycle===qr.ContainerScoped,i=n||o,s;return ku(e.provider)?s=e.provider.useValue:Tu(e.provider)?s=i?e.instance||(e.instance=this.resolve(e.provider.useToken,t)):this.resolve(e.provider.useToken,t):N1(e.provider)?s=i?e.instance||(e.instance=this.construct(e.provider.useClass,t)):this.construct(e.provider.useClass,t):ah(e.provider)?s=e.provider.useFactory(this):s=this.construct(e.provider,t),e.options.lifecycle===qr.ResolutionScoped&&t.scopedResolutions.set(e,s),s},r.prototype.resolveAll=function(e,t,n){var o=this;t===void 0&&(t=new L1),n===void 0&&(n=!1),this.ensureNotDisposed();var i=this.getAllRegistrations(e);if(!i&&hc(e)){if(n)return[];throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"All"),i){var s=i.map(function(c){return o.resolveRegistration(c,t)});return this.executePostResolutionInterceptor(e,s,"All"),s}var a=[this.construct(e,t)];return this.executePostResolutionInterceptor(e,a,"All"),a},r.prototype.isRegistered=function(e,t){return t===void 0&&(t=!1),this.ensureNotDisposed(),this._registry.has(e)||t&&(this.parent||!1)&&this.parent.isRegistered(e,!0)},r.prototype.reset=function(){this.ensureNotDisposed(),this._registry.clear(),this.interceptors.preResolution.clear(),this.interceptors.postResolution.clear()},r.prototype.clearInstances=function(){var e,t;this.ensureNotDisposed();try{for(var n=Qm(this._registry.entries()),o=n.next();!o.done;o=n.next()){var i=Bd(o.value,2),s=i[0],a=i[1];this._registry.setAll(s,a.filter(function(c){return!ku(c.provider)}).map(function(c){return c.instance=void 0,c}))}}catch(c){e={error:c}}finally{try{o&&!o.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}},r.prototype.createChildContainer=function(){var e,t;this.ensureNotDisposed();var n=new r(this);try{for(var o=Qm(this._registry.entries()),i=o.next();!i.done;i=o.next()){var s=Bd(i.value,2),a=s[0],c=s[1];c.some(function(l){var u=l.options;return u.lifecycle===qr.ContainerScoped})&&n._registry.setAll(a,c.map(function(l){return l.options.lifecycle===qr.ContainerScoped?{provider:l.provider,options:l.options}:l}))}}catch(l){e={error:l}}finally{try{i&&!i.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}}return n},r.prototype.beforeResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.preResolution.set(e,{callback:t,options:n})},r.prototype.afterResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.postResolution.set(e,{callback:t,options:n})},r.prototype.dispose=function(){return RN(this,void 0,void 0,function(){var e;return DN(this,function(t){switch(t.label){case 0:return this.disposed=!0,e=[],this.disposables.forEach(function(n){var o=n.dispose();o&&e.push(o)}),[4,Promise.all(e)];case 1:return t.sent(),[2]}})})},r.prototype.getRegistration=function(e){return this.isRegistered(e)?this._registry.get(e):this.parent?this.parent.getRegistration(e):null},r.prototype.getAllRegistrations=function(e){return this.isRegistered(e)?this._registry.getAll(e):this.parent?this.parent.getAllRegistrations(e):null},r.prototype.construct=function(e,t){var n=this;if(e instanceof L6)return e.createProxy(function(i){return n.resolve(i,t)});var o=function(){var i=Fv.get(e);if(!i||i.length===0){if(e.length===0)return new e;throw new Error('TypeInfo not known for "'+e.name+'"')}var s=i.map(n.resolveParams(t,e));return new(e.bind.apply(e,es([void 0],s)))}();return AO(o)&&this.disposables.add(o),o},r.prototype.resolveParams=function(e,t){var n=this;return function(o,i){var s,a,c;try{return Mv(o)?B6(o)?o.multiple?(s=n.resolve(o.transform)).transform.apply(s,es([n.resolveAll(o.token,new L1,o.isOptional)],o.transformArgs)):(a=n.resolve(o.transform)).transform.apply(a,es([n.resolve(o.token,e,o.isOptional)],o.transformArgs)):o.multiple?n.resolveAll(o.token,new L1,o.isOptional):n.resolve(o.token,e,o.isOptional):B6(o)?(c=n.resolve(o.transform,e)).transform.apply(c,es([n.resolve(o.token,e)],o.transformArgs)):n.resolve(o,e)}catch(l){throw new Error(Uv(t,i,l))}}},r.prototype.ensureNotDisposed=function(){if(this.disposed)throw new Error("This container has been disposed, you cannot interact with a disposed container")},r}(),At=new iQ;function sQ(r){return function(e){Fv.set(e,Bv(e)),r&&r.token&&(Array.isArray(r.token)?r.token.forEach(function(t){At.register(t,e)}):At.register(r.token,e))}}var pc=sQ;if(typeof Reflect>"u"||!Reflect.getMetadata)throw new Error(`tsyringe requires a reflect polyfill. Please add 'import "reflect-metadata"' to the top of your entry point.`);var $v,Pu=class{constructor(e={}){this.attrId="",this.attrValues=[],Object.assign(e)}};p([y({type:b.ObjectIdentifier})],Pu.prototype,"attrId",void 0);p([y({type:b.Any,repeated:"set"})],Pu.prototype,"attrValues",void 0);var SO=$v=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,$v.prototype)}};SO=$v=p([M({type:O.Sequence,itemType:Pu})],SO);var Vv,_O=Vv=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,Vv.prototype)}};_O=Vv=p([M({type:O.Sequence,itemType:Ko})],_O);var aQ="1.2.840.113549",cQ=`${aQ}.1`,CO=`${cQ}.12`,ch=`${CO}.1`,OKe=`${ch}.1`,LKe=`${ch}.2`,BKe=`${ch}.3`,MKe=`${ch}.4`,UKe=`${ch}.5`,FKe=`${ch}.6`,Ru=`${CO}.10.1`;var VKe=`${Ru}.1`,KKe=`${Ru}.2`,zKe=`${Ru}.3`,qKe=`${Ru}.4`,jKe=`${Ru}.5`,WKe=`${Ru}.6`,M6="1.2.840.113549.1.9";var U6=class{constructor(e={}){this.certId="",this.certValue=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],U6.prototype,"certId",void 0);p([y({type:b.Any,context:0})],U6.prototype,"certValue",void 0);var IO=`${M6}.22`,ZKe=`${IO}.1`,JKe=`${IO}.2`;var F6=class{constructor(e={}){this.crlId="",this.crltValue=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],F6.prototype,"crlId",void 0);p([y({type:b.Any,context:0})],F6.prototype,"crltValue",void 0);var lQ=`${M6}.23`,oze=`${lQ}.1`;var H6=class extends Ae{},mc=class{constructor(e={}){this.encryptionAlgorithm=new Z,this.encryptedData=new H6,Object.assign(this,e)}};p([y({type:Z})],mc.prototype,"encryptionAlgorithm",void 0);p([y({type:H6})],mc.prototype,"encryptedData",void 0);var Kv,zv;(function(r){r[r.v1=0]="v1"})(zv||(zv={}));var $6=class extends Ae{},qv=Kv=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,Kv.prototype)}};qv=Kv=p([M({type:O.Sequence,itemType:Hr})],qv);var gc=class{constructor(e={}){this.version=zv.v1,this.privateKeyAlgorithm=new Z,this.privateKey=new $6,Object.assign(this,e)}};p([y({type:b.Integer})],gc.prototype,"version",void 0);p([y({type:Z})],gc.prototype,"privateKeyAlgorithm",void 0);p([y({type:$6})],gc.prototype,"privateKey",void 0);p([y({type:qv,implicit:!0,context:0,optional:!0})],gc.prototype,"attributes",void 0);var TO=class extends gc{};TO=p([M({type:O.Sequence})],TO);var kO=class extends mc{};kO=p([M({type:O.Sequence})],kO);var V6=class{constructor(e={}){this.secretTypeId="",this.secretValue=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],V6.prototype,"secretTypeId",void 0);p([y({type:b.Any,context:0})],V6.prototype,"secretValue",void 0);var yc=class{constructor(e={}){this.mac=new Iu,this.macSalt=new Ae,this.iterations=1,Object.assign(this,e)}};p([y({type:Iu})],yc.prototype,"mac",void 0);p([y({type:Ae})],yc.prototype,"macSalt",void 0);p([y({type:b.Integer,defaultValue:1})],yc.prototype,"iterations",void 0);var Du=class{constructor(e={}){this.version=3,this.authSafe=new Ko,this.macData=new yc,Object.assign(this,e)}};p([y({type:b.Integer})],Du.prototype,"version",void 0);p([y({type:Ko})],Du.prototype,"authSafe",void 0);p([y({type:yc,optional:!0})],Du.prototype,"macData",void 0);var jv,lh=class{constructor(e={}){this.bagId="",this.bagValue=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:b.ObjectIdentifier})],lh.prototype,"bagId",void 0);p([y({type:b.Any,context:0})],lh.prototype,"bagValue",void 0);p([y({type:Pu,repeated:"set",optional:!0})],lh.prototype,"bagAttributes",void 0);var PO=jv=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,jv.prototype)}};PO=jv=p([M({type:O.Sequence,itemType:lh})],PO);var Wv,Gv,Xv,Wt="1.2.840.113549.1.9",sqe=`${Wt}.0`,zO=`${Wt}.24`,M1=`${Wt}.25`,qO=`${Wt}.26`,jO=`${Wt}.27`,aqe=`${zO}.1`,cqe=`${zO}.2`,lqe=`${Wt}.1`,uqe=`${Wt}.2`,fqe=`${Wt}.3`,dqe=`${Wt}.4`,hqe=`${Wt}.5`,pqe=`${Wt}.6`,nA=`${Wt}.7`,mqe=`${Wt}.8`,gqe=`${Wt}.9`,yqe=`${Wt}.13`,U1=`${Wt}.14`,wqe=`${Wt}.15`,xqe=`${Wt}.20`,bqe=`${Wt}.21`;var vqe=`${M1}.1`,Aqe=`${M1}.2`,Eqe=`${M1}.3`,Sqe=`${M1}.4`,_qe=`${M1}.5`,F1="1.3.6.1.5.5.7.9",Cqe=`${F1}.1`,Iqe=`${F1}.2`,Tqe=`${F1}.3`,kqe=`${F1}.4`,Pqe=`${F1}.5`,Rqe=`${qO}.1`,Dqe=`${qO}.2`,Nqe=`${jO}.1`,Oqe=`${jO}.2`,Lqe=`${Wt}.16`,Bqe=`${Wt}.22`,Mqe=`${Wt}.23`,Uqe=`${gv}.65`,K6=class extends dr{constructor(e={}){super(e)}toString(){return{}.toString(),this.ia5String||super.toString()}};p([y({type:b.IA5String})],K6.prototype,"ia5String",void 0);K6=p([M({type:O.Choice})],K6);var RO=class extends Ko{};RO=p([M({type:O.Sequence})],RO);var DO=class extends Du{};DO=p([M({type:O.Sequence})],DO);var NO=class extends mc{};NO=p([M({type:O.Sequence})],NO);var Yv=class{constructor(e=""){this.value=e}toString(){return this.value}};p([y({type:b.IA5String})],Yv.prototype,"value",void 0);Yv=p([M({type:O.Choice})],Yv);var OO=class extends K6{};OO=p([M({type:O.Choice})],OO);var LO=class extends dr{};LO=p([M({type:O.Choice})],LO);var Qv=class{constructor(e=new Date){this.value=e}};p([y({type:b.GeneralizedTime})],Qv.prototype,"value",void 0);Qv=p([M({type:O.Choice})],Qv);var BO=class extends dr{};BO=p([M({type:O.Choice})],BO);var Zv=class{constructor(e="M"){this.value=e}toString(){return this.value}};p([y({type:b.PrintableString})],Zv.prototype,"value",void 0);Zv=p([M({type:O.Choice})],Zv);var z6=class{constructor(e=""){this.value=e}toString(){return this.value}};p([y({type:b.PrintableString})],z6.prototype,"value",void 0);z6=p([M({type:O.Choice})],z6);var MO=class extends z6{};MO=p([M({type:O.Choice})],MO);var UO=class extends dr{};UO=p([M({type:O.Choice})],UO);var Jv=class{constructor(e=""){this.value=e}toString(){return this.value}};p([y({type:b.ObjectIdentifier})],Jv.prototype,"value",void 0);Jv=p([M({type:O.Choice})],Jv);var FO=class extends jt{};FO=p([M({type:O.Choice})],FO);var eA=class{constructor(e=0){this.value=e}toString(){return this.value.toString()}};p([y({type:b.Integer})],eA.prototype,"value",void 0);eA=p([M({type:O.Choice})],eA);var HO=class extends Hn{};HO=p([M({type:O.Sequence})],HO);var B1=class extends dr{};B1=p([M({type:O.Choice})],B1);var $O=Wv=class extends mo{constructor(e){super(e),Object.setPrototypeOf(this,Wv.prototype)}};$O=Wv=p([M({type:O.Sequence})],$O);var VO=Gv=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,Gv.prototype)}};VO=Gv=p([M({type:O.Set,itemType:Ci})],VO);var tA=class{constructor(e=""){this.value=e}toString(){return this.value}};p([y({type:b.BmpString})],tA.prototype,"value",void 0);tA=p([M({type:O.Choice})],tA);var rA=class extends Z{};rA=p([M({type:O.Sequence})],rA);var KO=Xv=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,Xv.prototype)}};KO=Xv=p([M({type:O.Sequence,itemType:rA})],KO);var oA,H1=oA=class extends ye{constructor(e){super(e),Object.setPrototypeOf(this,oA.prototype)}};H1=oA=p([M({type:O.Sequence,itemType:Hr})],H1);var cs=class{constructor(e={}){this.version=0,this.subject=new dt,this.subjectPKInfo=new $r,this.attributes=new H1,Object.assign(this,e)}};p([y({type:b.Integer})],cs.prototype,"version",void 0);p([y({type:dt})],cs.prototype,"subject",void 0);p([y({type:$r})],cs.prototype,"subjectPKInfo",void 0);p([y({type:H1,implicit:!0,context:0})],cs.prototype,"attributes",void 0);var wc=class{constructor(e={}){this.certificationRequestInfo=new cs,this.signatureAlgorithm=new Z,this.signature=new ArrayBuffer(0),Object.assign(this,e)}};p([y({type:cs})],wc.prototype,"certificationRequestInfo",void 0);p([y({type:Z})],wc.prototype,"signatureAlgorithm",void 0);p([y({type:b.BitString})],wc.prototype,"signature",void 0);var j1="crypto.algorithm",pA=class{getAlgorithms(){return At.resolveAll(j1)}toAsnAlgorithm(e){({...e});for(let t of this.getAlgorithms()){let n=t.toAsnAlgorithm(e);if(n)return n}if(/^[0-9.]+$/.test(e.name)){let t=new Z({algorithm:e.name});if("parameters"in e){let n=e;t.parameters=n.parameters}return t}throw new Error("Cannot convert WebCrypto algorithm to ASN.1 algorithm")}toWebAlgorithm(e){for(let n of this.getAlgorithms()){let o=n.toWebAlgorithm(e);if(o)return o}return{name:e.algorithm,parameters:e.parameters}}},Nu="crypto.algorithmProvider";At.registerSingleton(Nu,pA);var G6,qn="1.3.36.3.3.2.8.1.1",WO=`${qn}.1`,GO=`${qn}.2`,XO=`${qn}.3`,YO=`${qn}.4`,QO=`${qn}.5`,ZO=`${qn}.6`,JO=`${qn}.7`,eL=`${qn}.8`,tL=`${qn}.9`,rL=`${qn}.10`,nL=`${qn}.11`,oL=`${qn}.12`,iL=`${qn}.13`,sL=`${qn}.14`,aL="brainpoolP160r1",cL="brainpoolP160t1",lL="brainpoolP192r1",uL="brainpoolP192t1",fL="brainpoolP224r1",dL="brainpoolP224t1",hL="brainpoolP256r1",pL="brainpoolP256t1",mL="brainpoolP320r1",gL="brainpoolP320t1",yL="brainpoolP384r1",wL="brainpoolP384t1",xL="brainpoolP512r1",bL="brainpoolP512t1",Lt="ECDSA",V1=G6=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case Lt.toLowerCase():if("hash"in e)switch((typeof e.hash=="string"?e.hash:e.hash.name).toLowerCase()){case"sha-1":return sO;case"sha-256":return aO;case"sha-384":return cO;case"sha-512":return lO}else if("namedCurve"in e){let t="";switch(e.namedCurve){case"P-256":t=Cv;break;case"K-256":t=G6.SECP256K1;break;case"P-384":t=Iv;break;case"P-521":t=Tv;break;case aL:t=WO;break;case cL:t=GO;break;case lL:t=XO;break;case uL:t=YO;break;case fL:t=QO;break;case dL:t=ZO;break;case hL:t=JO;break;case pL:t=eL;break;case mL:t=tL;break;case gL:t=rL;break;case yL:t=nL;break;case wL:t=oL;break;case xL:t=iL;break;case bL:t=sL;break}if(t)return new Z({algorithm:vu,parameters:te.serialize(new is({namedCurve:t}))})}}return null}toWebAlgorithm(e){switch(e.algorithm){case I1:return{name:Lt,hash:{name:"SHA-1"}};case T1:return{name:Lt,hash:{name:"SHA-256"}};case k1:return{name:Lt,hash:{name:"SHA-384"}};case P1:return{name:Lt,hash:{name:"SHA-512"}};case vu:{if(!e.parameters)throw new TypeError("Cannot get required parameters from EC algorithm");switch(te.parse(e.parameters,is).namedCurve){case Cv:return{name:Lt,namedCurve:"P-256"};case G6.SECP256K1:return{name:Lt,namedCurve:"K-256"};case Iv:return{name:Lt,namedCurve:"P-384"};case Tv:return{name:Lt,namedCurve:"P-521"};case WO:return{name:Lt,namedCurve:aL};case GO:return{name:Lt,namedCurve:cL};case XO:return{name:Lt,namedCurve:lL};case YO:return{name:Lt,namedCurve:uL};case QO:return{name:Lt,namedCurve:fL};case ZO:return{name:Lt,namedCurve:dL};case JO:return{name:Lt,namedCurve:hL};case eL:return{name:Lt,namedCurve:pL};case tL:return{name:Lt,namedCurve:mL};case rL:return{name:Lt,namedCurve:gL};case nL:return{name:Lt,namedCurve:yL};case oL:return{name:Lt,namedCurve:wL};case iL:return{name:Lt,namedCurve:xL};case sL:return{name:Lt,namedCurve:bL}}}}return null}};V1.SECP256K1="1.3.132.0.10";V1=G6=p([pc()],V1);At.registerSingleton(j1,V1);var RL=Symbol("name"),DL=Symbol("value"),Ge=class{constructor(e,t={},n=""){this[RL]=e,this[DL]=n;for(let o in t)this[o]=t[o]}};Ge.NAME=RL;Ge.VALUE=DL;var mA=class{static toTextObject(e){let t=new Ge("Algorithm Identifier",{},us.toString(e.algorithm));if(e.parameters)switch(e.algorithm){case vu:{let n=new V1().toWebAlgorithm(e);n&&"namedCurve"in n?t["Named Curve"]=n.namedCurve:t.Parameters=e.parameters;break}default:t.Parameters=e.parameters}return t}},us=class{static toString(e){let t=this.items[e];return t||e}};us.items={[Eu]:"sha1",[D6]:"sha224",[Su]:"sha256",[_u]:"sha384",[Cu]:"sha512",[ss]:"rsaEncryption",[th]:"sha1WithRSAEncryption",[pO]:"sha224WithRSAEncryption",[R6]:"sha256WithRSAEncryption",[rh]:"sha384WithRSAEncryption",[nh]:"sha512WithRSAEncryption",[vu]:"ecPublicKey",[I1]:"ecdsaWithSHA1",[P6]:"ecdsaWithSHA224",[T1]:"ecdsaWithSHA256",[k1]:"ecdsaWithSHA384",[P1]:"ecdsaWithSHA512",[HN]:"TLS WWW server authentication",[$N]:"TLS WWW client authentication",[VN]:"Code Signing",[KN]:"E-mail Protection",[zN]:"Time Stamping",[qN]:"OCSP Signing",[oO]:"Signed Data"};var aa=class{static serialize(e){return this.serializeObj(e).join(`
`)}static pad(e=0){return"".padStart(2*e," ")}static serializeObj(e,t=0){let n=[],o=this.pad(t++),i="",s=e[Ge.VALUE];s&&(i=` ${s}`),n.push(`${o}${e[Ge.NAME]}:${i}`),o=this.pad(t);for(let a in e){if(typeof a=="symbol")continue;let c=e[a],l=a?`${a}: `:"";if(typeof c=="string"||typeof c=="number"||typeof c=="boolean")n.push(`${o}${l}${c}`);else if(c instanceof Date)n.push(`${o}${l}${c.toUTCString()}`);else if(Array.isArray(c))for(let u of c)u[Ge.NAME]=a,n.push(...this.serializeObj(u,t));else if(c instanceof Ge)c[Ge.NAME]=a,n.push(...this.serializeObj(c,t));else if(J.BufferSourceConverter.isBufferSource(c))a?(n.push(`${o}${l}`),n.push(...this.serializeBufferSource(c,t+1))):n.push(...this.serializeBufferSource(c,t));else if("toTextObject"in c){let u=c.toTextObject();u[Ge.NAME]=a,n.push(...this.serializeObj(u,t))}else throw new TypeError("Cannot serialize data in text format. Unsupported type.")}return n}static serializeBufferSource(e,t=0){let n=this.pad(t),o=J.BufferSourceConverter.toUint8Array(e),i=[];for(let s=0;s<o.length;){let a=[];for(let c=0;c<16&&s<o.length;c++){c===8&&a.push("");let l=o[s++].toString(16).padStart(2,"0");a.push(l)}i.push(`${n}${a.join(" ")}`)}return i}static serializeAlgorithm(e){return this.algorithmSerializer.toTextObject(e)}};aa.oidSerializer=us;aa.algorithmSerializer=mA;var xc=class r{constructor(...e){if(e.length===1){let t=e[0];this.rawData=te.serialize(t),this.onInit(t)}else{let t=te.parse(e[0],e[1]);this.rawData=J.BufferSourceConverter.toArrayBuffer(e[0]),this.onInit(t)}}equal(e){return e instanceof r?(0,J.isEqual)(e.rawData,this.rawData):!1}toString(e="text"){switch(e){case"asn":return te.toString(this.rawData);case"text":return aa.serialize(this.toTextObject());case"hex":return J.Convert.ToHex(this.rawData);case"base64":return J.Convert.ToBase64(this.rawData);case"base64url":return J.Convert.ToBase64Url(this.rawData);default:throw TypeError("Argument 'format' is unsupported value")}}getTextName(){return this.constructor.NAME}toTextObject(){let e=this.toTextObjectEmpty();return e[""]=this.rawData,e}toTextObjectEmpty(e){return new Ge(this.getTextName(),{},e)}};xc.NAME="ASN";var jo=class r extends xc{constructor(...e){let t;J.BufferSourceConverter.isBufferSource(e[0])?t=J.BufferSourceConverter.toArrayBuffer(e[0]):t=te.serialize(new Vr({extnID:e[0],critical:e[1],extnValue:new Ae(J.BufferSourceConverter.toArrayBuffer(e[2]))})),super(t,Vr)}onInit(e){this.type=e.extnID,this.critical=e.critical,this.value=e.extnValue.buffer}toTextObject(){let e=this.toTextObjectWithoutValue();return e[""]=this.value,e}toTextObjectWithoutValue(){let e=this.toTextObjectEmpty(this.critical?"critical":void 0);return e[Ge.NAME]===r.NAME&&(e[Ge.NAME]=us.toString(this.type)),e}},NL,K1=class r{static isCryptoKeyPair(e){return e&&e.privateKey&&e.publicKey}static isCryptoKey(e){return e&&e.usages&&e.type&&e.algorithm&&e.extractable!==void 0}constructor(){this.items=new Map,this[NL]="CryptoProvider",typeof self<"u"&&typeof crypto<"u"?this.set(r.DEFAULT,crypto):typeof globalThis<"u"&&globalThis.crypto&&globalThis.crypto.subtle&&this.set(r.DEFAULT,globalThis.crypto)}clear(){this.items.clear()}delete(e){return this.items.delete(e)}forEach(e,t){return this.items.forEach(e,t)}has(e){return this.items.has(e)}get size(){return this.items.size}entries(){return this.items.entries()}keys(){return this.items.keys()}values(){return this.items.values()}[Symbol.iterator](){return this.items[Symbol.iterator]()}get(e=r.DEFAULT){let t=this.items.get(e.toLowerCase());if(!t)throw new Error(`Cannot get Crypto by name '${e}'`);return t}set(e,t){if(typeof e=="string"){if(!t)throw new TypeError("Argument 'value' is required");this.items.set(e.toLowerCase(),t)}else this.items.set(r.DEFAULT,e);return this}};NL=Symbol.toStringTag;K1.DEFAULT="default";var jr=new K1,hQ=/^[0-2](?:\.[1-9][0-9]*)+$/;function pQ(r){return new RegExp(hQ).test(r)}var Y6=class{constructor(e={}){this.items={};for(let t in e)this.register(t,e[t])}get(e){return this.items[e]||null}findId(e){return pQ(e)?e:this.get(e)}register(e,t){this.items[e]=t,this.items[t]=e}},Kn=new Y6;Kn.register("CN","2.5.4.3");Kn.register("L","2.5.4.7");Kn.register("ST","2.5.4.8");Kn.register("O","2.5.4.10");Kn.register("OU","2.5.4.11");Kn.register("C","2.5.4.6");Kn.register("DC","0.9.2342.19200300.100.1.25");Kn.register("E","1.2.840.113549.1.9.1");Kn.register("G","2.5.4.42");Kn.register("I","2.5.4.43");Kn.register("SN","2.5.4.4");Kn.register("T","2.5.4.12");function mQ(r,e){return`\\${J.Convert.ToHex(J.Convert.FromUtf8String(e)).toUpperCase()}`}function gQ(r){return r.replace(/([,+"\\<>;])/g,"\\$1").replace(/^([ #])/,"\\$1").replace(/([ ]$)/,"\\$1").replace(/([\r\n\t])/,mQ)}var qo=class r{static isASCII(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!1;return!0}static isPrintableString(e){return/^[A-Za-z0-9 '()+,-./:=?]*$/g.test(e)}constructor(e,t={}){this.extraNames=new Y6,this.asn=new dt;for(let n in t)if(Object.prototype.hasOwnProperty.call(t,n)){let o=t[n];this.extraNames.register(n,o)}typeof e=="string"?this.asn=this.fromString(e):e instanceof dt?this.asn=e:J.BufferSourceConverter.isBufferSource(e)?this.asn=te.parse(e,dt):this.asn=this.fromJSON(e)}getField(e){let t=this.extraNames.findId(e)||Kn.findId(e),n=[];for(let o of this.asn)for(let i of o)i.type===t&&n.push(i.value.toString());return n}getName(e){return this.extraNames.get(e)||Kn.get(e)}toString(){return this.asn.map(e=>e.map(t=>{let n=this.getName(t.type)||t.type,o=t.value.anyValue?`#${J.Convert.ToHex(t.value.anyValue)}`:gQ(t.value.toString());return`${n}=${o}`}).join("+")).join(", ")}toJSON(){var e;let t=[];for(let n of this.asn){let o={};for(let i of n){let s=this.getName(i.type)||i.type;(e=o[s])!==null&&e!==void 0||(o[s]=[]),o[s].push(i.value.anyValue?`#${J.Convert.ToHex(i.value.anyValue)}`:i.value.toString())}t.push(o)}return t}fromString(e){let t=new dt,n=/(\d\.[\d.]*\d|[A-Za-z]+)=((?:"")|(?:".*?[^\\]")|(?:[^,+"\\](?=[,+]|$))|(?:[^,+].*?(?:[^\\][,+]))|(?:))([,+])?/g,o=null,i=",";for(;o=n.exec(`${e},`);){let[,s,a]=o,c=a[a.length-1];(c===","||c==="+")&&(a=a.slice(0,a.length-1),o[3]=c);let l=o[3];s=this.getTypeOid(s);let u=this.createAttribute(s,a);i==="+"?t[t.length-1].push(u):t.push(new ec([u])),i=l}return t}fromJSON(e){let t=new dt;for(let n of e){let o=new ec;for(let i in n){let s=this.getTypeOid(i),a=n[i];for(let c of a){let l=this.createAttribute(s,c);o.push(l)}}t.push(o)}return t}getTypeOid(e){if(/[\d.]+/.test(e)||(e=this.getName(e)||""),!e)throw new Error(`Cannot get OID for name type '${e}'`);return e}createAttribute(e,t){let n=new tu({type:e});if(typeof t=="object")for(let o in t)switch(o){case"ia5String":n.value.ia5String=t[o];break;case"utf8String":n.value.utf8String=t[o];break;case"universalString":n.value.universalString=t[o];break;case"bmpString":n.value.bmpString=t[o];break;case"printableString":n.value.printableString=t[o];break}else if(t[0]==="#")n.value.anyValue=J.Convert.FromHex(t.slice(1));else{let o=this.processStringValue(t);e===this.getName("E")||e===this.getName("DC")?n.value.ia5String=o:r.isPrintableString(o)?n.value.printableString=o:n.value.utf8String=o}return n}processStringValue(e){let t=/"(.*?[^\\])?"/.exec(e);return t&&(e=t[1]),e.replace(/\\0a/ig,`
`).replace(/\\0d/ig,"\r").replace(/\\0g/ig,"	").replace(/\\(.)/g,"$1")}toArrayBuffer(){return te.serialize(this.asn)}async getThumbprint(...e){var t;let n,o="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(o=e[0]||o,n=e[1]||jr.get()):n=e[0]||jr.get(),await n.subtle.digest(o,this.toArrayBuffer())}},OL="Cannot initialize GeneralName from ASN.1 data.",vL=`${OL} Unsupported string format in use.`,yQ=`${OL} Value doesn't match to GUID regular expression.`,AL=/^([0-9a-f]{8})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{12})$/i,EL="1.3.6.1.4.1.311.25.1",SL="1.3.6.1.4.1.311.20.2.3",iA="dns",sA="dn",aA="email",cA="ip",lA="url",uA="guid",fA="upn",q6="id",ls=class extends xc{constructor(...e){let t;if(e.length===2)switch(e[0]){case sA:{let n=new qo(e[1]).toArrayBuffer(),o=te.parse(n,dt);t=new Se({directoryName:o});break}case iA:t=new Se({dNSName:e[1]});break;case aA:t=new Se({rfc822Name:e[1]});break;case uA:{let n=new RegExp(AL,"i").exec(e[1]);if(!n)throw new Error("Cannot parse GUID value. Value doesn't match to regular expression");let o=n.slice(1).map((i,s)=>s<3?J.Convert.ToHex(new Uint8Array(J.Convert.FromHex(i)).reverse()):i).join("");t=new Se({otherName:new tc({typeId:EL,value:te.serialize(new Ae(J.Convert.FromHex(o)))})});break}case cA:t=new Se({iPAddress:e[1]});break;case q6:t=new Se({registeredID:e[1]});break;case fA:{t=new Se({otherName:new tc({typeId:SL,value:te.serialize(Bb.toASN(e[1]))})});break}case lA:t=new Se({uniformResourceIdentifier:e[1]});break;default:throw new Error("Cannot create GeneralName. Unsupported type of the name")}else J.BufferSourceConverter.isBufferSource(e[0])?t=te.parse(e[0],Se):t=e[0];super(t)}onInit(e){if(e.dNSName!=null)this.type=iA,this.value=e.dNSName;else if(e.rfc822Name!=null)this.type=aA,this.value=e.rfc822Name;else if(e.iPAddress!=null)this.type=cA,this.value=e.iPAddress;else if(e.uniformResourceIdentifier!=null)this.type=lA,this.value=e.uniformResourceIdentifier;else if(e.registeredID!=null)this.type=q6,this.value=e.registeredID;else if(e.directoryName!=null)this.type=sA,this.value=new qo(e.directoryName).toString();else if(e.otherName!=null)if(e.otherName.typeId===EL){this.type=uA;let t=te.parse(e.otherName.value,Ae),n=new RegExp(AL,"i").exec(J.Convert.ToHex(t));if(!n)throw new Error(yQ);this.value=n.slice(1).map((o,i)=>i<3?J.Convert.ToHex(new Uint8Array(J.Convert.FromHex(o)).reverse()):o).join("-")}else if(e.otherName.typeId===SL)this.type=fA,this.value=te.parse(e.otherName.value,dr).toString();else throw new Error(vL);else throw new Error(vL)}toJSON(){return{type:this.type,value:this.value}}toTextObject(){let e;switch(this.type){case sA:case iA:case uA:case cA:case q6:case fA:case lA:e=this.type.toUpperCase();break;case aA:e="Email";break;default:throw new Error("Unsupported GeneralName type")}let t=this.value;return this.type===q6&&(t=us.toString(t)),new Ge(e,void 0,t)}},Ou=class extends xc{constructor(e){let t;if(e instanceof Rt)t=e;else if(Array.isArray(e)){let n=[];for(let o of e)if(o instanceof Se)n.push(o);else{let i=te.parse(new ls(o.type,o.value).rawData,Se);n.push(i)}t=new Rt(n)}else if(J.BufferSourceConverter.isBufferSource(e))t=te.parse(e,Rt);else throw new Error("Cannot initialize GeneralNames. Incorrect incoming arguments");super(t)}onInit(e){let t=[];for(let n of e){let o=null;try{o=new ls(n)}catch{continue}t.push(o)}this.items=t}toJSON(){return this.items.map(e=>e.toJSON())}toTextObject(){let e=super.toTextObjectEmpty();for(let t of this.items){let n=t.toTextObject(),o=e[n[Ge.NAME]];Array.isArray(o)||(o=[],e[n[Ge.NAME]]=o),o.push(n)}return e}};Ou.NAME="GeneralNames";var $1="-{5}",z1="\\n",wQ=`[^${z1}]+`,xQ=`${$1}BEGIN (${wQ}(?=${$1}))${$1}`,bQ=`${$1}END \\1${$1}`,uh="\\n",vQ=`[^:${z1}]+`,AQ=`(?:[^${z1}]+${uh}(?: +[^${z1}]+${uh})*)`,EQ="[a-zA-Z0-9=+/]+",SQ=`(?:${EQ}${uh})+`,_L=`${xQ}${uh}(?:((?:${vQ}: ${AQ})+))?${uh}?(${SQ})${bQ}`,_n=class{static isPem(e){return typeof e=="string"&&new RegExp(_L,"g").test(e.replace(/\r/g,""))}static decodeWithHeaders(e){e=e.replace(/\r/g,"");let t=new RegExp(_L,"g"),n=[],o=null;for(;o=t.exec(e);){let i=o[3].replace(new RegExp(`[${z1}]+`,"g"),""),s={type:o[1],headers:[],rawData:J.Convert.FromBase64(i)},a=o[2];if(a){let c=a.split(new RegExp(uh,"g")),l=null;for(let u of c){let[f,h]=u.split(/:(.*)/);if(h===void 0){if(!l)throw new Error("Cannot parse PEM string. Incorrect header value");l.value+=f.trim()}else l&&s.headers.push(l),l={key:f,value:h.trim()}}l&&s.headers.push(l)}n.push(s)}return n}static decode(e){return this.decodeWithHeaders(e).map(n=>n.rawData)}static decodeFirst(e){let t=this.decode(e);if(!t.length)throw new RangeError("PEM string doesn't contain any objects");return t[0]}static encode(e,t){if(Array.isArray(e)){let n=new Array;return t?e.forEach(o=>{if(!J.BufferSourceConverter.isBufferSource(o))throw new TypeError("Cannot encode array of BufferSource in PEM format. Not all items of the array are BufferSource");n.push(this.encodeStruct({type:t,rawData:J.BufferSourceConverter.toArrayBuffer(o)}))}):e.forEach(o=>{if(!("type"in o))throw new TypeError("Cannot encode array of PemStruct in PEM format. Not all items of the array are PemStrut");n.push(this.encodeStruct(o))}),n.join(`
`)}else{if(!t)throw new Error("Required argument 'tag' is missed");return this.encodeStruct({type:t,rawData:J.BufferSourceConverter.toArrayBuffer(e)})}}static encodeStruct(e){var t;let n=e.type.toLocaleUpperCase(),o=[];if(o.push(`-----BEGIN ${n}-----`),!((t=e.headers)===null||t===void 0)&&t.length){for(let l of e.headers)o.push(`${l.key}: ${l.value}`);o.push("")}let i=J.Convert.ToBase64(e.rawData),s,a=0,c=Array();for(;a<i.length&&(i.length-a<64?s=i.substring(a):(s=i.substring(a,a+64),a+=64),s.length!==0);)if(c.push(s),s.length<64)break;return o.push(...c),o.push(`-----END ${n}-----`),o.join(`
`)}};_n.CertificateTag="CERTIFICATE";_n.CrlTag="CRL";_n.CertificateRequestTag="CERTIFICATE REQUEST";_n.PublicKeyTag="PUBLIC KEY";_n.PrivateKeyTag="PRIVATE KEY";var bc=class r extends xc{static isAsnEncoded(e){return J.BufferSourceConverter.isBufferSource(e)||typeof e=="string"}static toArrayBuffer(e){if(typeof e=="string"){if(_n.isPem(e))return _n.decode(e)[0];if(J.Convert.isHex(e))return J.Convert.FromHex(e);if(J.Convert.isBase64(e))return J.Convert.FromBase64(e);if(J.Convert.isBase64Url(e))return J.Convert.FromBase64Url(e);throw new TypeError("Unsupported format of 'raw' argument. Must be one of DER, PEM, HEX, Base64, or Base4Url")}else{let t=J.Convert.ToBinary(e);return _n.isPem(t)?_n.decode(t)[0]:J.Convert.isHex(t)?J.Convert.FromHex(t):J.Convert.isBase64(t)?J.Convert.FromBase64(t):J.Convert.isBase64Url(t)?J.Convert.FromBase64Url(t):J.BufferSourceConverter.toArrayBuffer(e)}}constructor(...e){r.isAsnEncoded(e[0])?super(r.toArrayBuffer(e[0]),e[1]):super(e[0])}toString(e="pem"){switch(e){case"pem":return _n.encode(this.rawData,this.tag);default:return super.toString(e)}}},sa=class r extends bc{static async create(e,t=jr.get()){if(e instanceof r)return e;if(K1.isCryptoKey(e)){if(e.type!=="public")throw new TypeError("Public key is required");let n=await t.subtle.exportKey("spki",e);return new r(n)}else{if(e.publicKey)return e.publicKey;if(J.BufferSourceConverter.isBufferSource(e))return new r(e);throw new TypeError("Unsupported PublicKeyType")}}constructor(e){bc.isAsnEncoded(e)?super(e,$r):super(e),this.tag=_n.PublicKeyTag}async export(...e){let t,n=["verify"],o={hash:"SHA-256",...this.algorithm};e.length>1?(o=e[0]||o,n=e[1]||n,t=e[2]||jr.get()):t=e[0]||jr.get();let i=this.rawData,s=te.parse(this.rawData,$r);return s.algorithm.algorithm===fc&&(i=_Q(s,i)),t.subtle.importKey("spki",i,o,!0,n)}onInit(e){let t=At.resolve(Nu),n=this.algorithm=t.toWebAlgorithm(e.algorithm);switch(e.algorithm.algorithm){case ss:{let o=te.parse(e.subjectPublicKey,sh),i=J.BufferSourceConverter.toUint8Array(o.modulus);n.publicExponent=J.BufferSourceConverter.toUint8Array(o.publicExponent),n.modulusLength=(i[0]?i:i.slice(1)).byteLength<<3;break}}}async getThumbprint(...e){var t;let n,o="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(o=e[0]||o,n=e[1]||jr.get()):n=e[0]||jr.get(),await n.subtle.digest(o,this.rawData)}async getKeyIdentifier(...e){let t,n="SHA-1";e.length===1?typeof e[0]=="string"?(n=e[0],t=jr.get()):t=e[0]:e.length===2?(n=e[0],t=e[1]):t=jr.get();let o=te.parse(this.rawData,$r);return await t.subtle.digest(n,o.subjectPublicKey)}toTextObject(){let e=this.toTextObjectEmpty(),t=te.parse(this.rawData,$r);switch(e.Algorithm=aa.serializeAlgorithm(t.algorithm),t.algorithm.algorithm){case vu:e["EC Point"]=t.subjectPublicKey;break;case ss:default:e["Raw Data"]=t.subjectPublicKey}return e}};function _Q(r,e){return r.algorithm=new Z({algorithm:ss,parameters:null}),e=te.serialize(r),e}var Q6=class r extends jo{static async create(e,t=!1,n=jr.get()){if("name"in e&&"serialNumber"in e)return new r(e,t);let i=await(await sa.create(e,n)).getKeyIdentifier(n);return new r(J.Convert.ToHex(i),t)}constructor(...e){if(J.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else if(typeof e[0]=="string"){let t=new ts({keyIdentifier:new ou(J.Convert.FromHex(e[0]))});super(l6,e[1],te.serialize(t))}else{let t=e[0],n=t.name instanceof Ou?te.parse(t.name.rawData,Rt):t.name,o=new ts({authorityCertIssuer:n,authorityCertSerialNumber:J.Convert.FromHex(t.serialNumber)});super(l6,e[1],te.serialize(o))}}onInit(e){super.onInit(e);let t=te.parse(e.extnValue,ts);t.keyIdentifier&&(this.keyId=J.Convert.ToHex(t.keyIdentifier)),(t.authorityCertIssuer||t.authorityCertSerialNumber)&&(this.certId={name:t.authorityCertIssuer||[],serialNumber:t.authorityCertSerialNumber?J.Convert.ToHex(t.authorityCertSerialNumber):""})}toTextObject(){let e=this.toTextObjectWithoutValue(),t=te.parse(this.value,ts);return t.authorityCertIssuer&&(e["Authority Issuer"]=new Ou(t.authorityCertIssuer).toTextObject()),t.authorityCertSerialNumber&&(e["Authority Serial Number"]=t.authorityCertSerialNumber),t.keyIdentifier&&(e[""]=t.keyIdentifier),e}};Q6.NAME="Authority Key Identifier";var fh=class extends jo{constructor(...e){if(J.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=te.parse(this.value,iu);this.ca=t.cA,this.pathLength=t.pathLenConstraint}else{let t=new iu({cA:e[0],pathLenConstraint:e[1]});super(u6,e[2],te.serialize(t)),this.ca=e[0],this.pathLength=e[1]}}toTextObject(){let e=this.toTextObjectWithoutValue();return this.ca&&(e.CA=this.ca),this.pathLength!==void 0&&(e["Path Length"]=this.pathLength),e}};fh.NAME="Basic Constraints";var CL;(function(r){r.serverAuth="1.3.6.1.5.5.7.3.1",r.clientAuth="1.3.6.1.5.5.7.3.2",r.codeSigning="1.3.6.1.5.5.7.3.3",r.emailProtection="1.3.6.1.5.5.7.3.4",r.timeStamping="1.3.6.1.5.5.7.3.8",r.ocspSigning="1.3.6.1.5.5.7.3.9"})(CL||(CL={}));var Z6=class extends jo{constructor(...e){if(J.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=te.parse(this.value,c1);this.usages=t.map(n=>n)}else{let t=new c1(e[0]);super(p6,e[1],te.serialize(t)),this.usages=e[0]}}toTextObject(){let e=this.toTextObjectWithoutValue();return e[""]=this.usages.map(t=>us.toString(t)).join(", "),e}};Z6.NAME="Extended Key Usages";var IL;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})(IL||(IL={}));var J6=class extends jo{constructor(...e){if(J.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=te.parse(this.value,Ud);this.usages=t.toNumber()}else{let t=new Ud(e[0]);super(m6,e[1],te.serialize(t)),this.usages=e[0]}}toTextObject(){let e=this.toTextObjectWithoutValue(),t=te.parse(this.value,Ud);return e[""]=t.toJSON().join(", "),e}};J6.NAME="Key Usages";var e5=class r extends jo{static async create(e,t=!1,n=jr.get()){let i=await(await sa.create(e,n)).getKeyIdentifier(n);return new r(J.Convert.ToHex(i),t)}constructor(...e){if(J.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=te.parse(this.value,Un);this.keyId=J.Convert.ToHex(t)}else{let t=typeof e[0]=="string"?J.Convert.FromHex(e[0]):e[0],n=new Un(t);super(lv,e[1],te.serialize(n)),this.keyId=J.Convert.ToHex(t)}}toTextObject(){let e=this.toTextObjectWithoutValue(),t=te.parse(this.value,Un);return e[""]=t,e}};e5.NAME="Subject Key Identifier";var t5=class extends jo{constructor(...e){J.BufferSourceConverter.isBufferSource(e[0])?super(e[0]):super(av,e[1],new Ou(e[0]||[]).rawData)}onInit(e){super.onInit(e);let t=te.parse(e.extnValue,x6);this.names=new Ou(t)}toTextObject(){let e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(let n in t)e[n]=t[n];return e}};t5.NAME="Subject Alternative Name";var zn=class{static register(e,t){this.items.set(e,t)}static create(e){let t=new jo(e),n=this.items.get(t.type);return n?new n(e):t}};zn.items=new Map;var r5=class extends jo{constructor(...e){var t;if(J.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let n=te.parse(this.value,n1);this.policies=n.map(o=>o.policyIdentifier)}else{let n=e[0],o=(t=e[1])!==null&&t!==void 0?t:!1,i=new n1(n.map(s=>new su({policyIdentifier:s})));super(d6,o,te.serialize(i)),this.policies=n}}toTextObject(){let e=this.toTextObjectWithoutValue();return e.Policy=this.policies.map(t=>new Ge("",{},us.toString(t))),e}};r5.NAME="Certificate Policies";zn.register(d6,r5);var n5=class extends jo{constructor(...e){var t;if(J.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else if(Array.isArray(e[0])&&typeof e[0][0]=="string"){let o=e[0].map(s=>new rs({distributionPoint:new ea({fullName:[new Se({uniformResourceIdentifier:s})]})})),i=new oc(o);super(h6,e[1],te.serialize(i))}else{let n=new oc(e[0]);super(h6,e[1],te.serialize(n))}(t=this.distributionPoints)!==null&&t!==void 0||(this.distributionPoints=[])}onInit(e){super.onInit(e);let t=te.parse(e.extnValue,oc);this.distributionPoints=t}toTextObject(){let e=this.toTextObjectWithoutValue();return e["Distribution Point"]=this.distributionPoints.map(t=>{var n;let o={};return t.distributionPoint&&(o[""]=(n=t.distributionPoint.fullName)===null||n===void 0?void 0:n.map(i=>new ls(i).toString()).join(", ")),t.reasons&&(o.Reasons=t.reasons.toString()),t.cRLIssuer&&(o["CRL Issuer"]=t.cRLIssuer.map(i=>i.toString()).join(", ")),o}),e}};n5.NAME="CRL Distribution Points";var o5=class extends jo{constructor(...e){var t,n,o,i;if(J.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else if(e[0]instanceof nu){let s=new nu(e[0]);super(c6,e[1],te.serialize(s))}else{let s=e[0],a=new nu;W6(a,s,qb,"ocsp"),W6(a,s,jb,"caIssuers"),W6(a,s,Wb,"timeStamping"),W6(a,s,Gb,"caRepository"),super(c6,e[1],te.serialize(a))}(t=this.ocsp)!==null&&t!==void 0||(this.ocsp=[]),(n=this.caIssuers)!==null&&n!==void 0||(this.caIssuers=[]),(o=this.timeStamping)!==null&&o!==void 0||(this.timeStamping=[]),(i=this.caRepository)!==null&&i!==void 0||(this.caRepository=[])}onInit(e){super.onInit(e),this.ocsp=[],this.caIssuers=[],this.timeStamping=[],this.caRepository=[],te.parse(e.extnValue,nu).forEach(n=>{switch(n.accessMethod){case qb:this.ocsp.push(new ls(n.accessLocation));break;case jb:this.caIssuers.push(new ls(n.accessLocation));break;case Wb:this.timeStamping.push(new ls(n.accessLocation));break;case Gb:this.caRepository.push(new ls(n.accessLocation));break}})}toTextObject(){let e=this.toTextObjectWithoutValue();return this.ocsp.length&&j6(e,"OCSP",this.ocsp),this.caIssuers.length&&j6(e,"CA Issuers",this.caIssuers),this.timeStamping.length&&j6(e,"Time Stamping",this.timeStamping),this.caRepository.length&&j6(e,"CA Repository",this.caRepository),e}};o5.NAME="Authority Info Access";function j6(r,e,t){if(t.length===1)r[e]=t[0].toTextObject();else{let n=new Ge("");t.forEach((o,i)=>{let s=o.toTextObject(),a=`${s[Ge.NAME]} ${i+1}`,c=n[a];Array.isArray(c)||(c=[],n[a]=c),c.push(s)}),r[e]=n}}function W6(r,e,t,n){let o=e[n];o&&(Array.isArray(o)?o:[o]).forEach(s=>{typeof s=="string"&&(s=new ls("url",s)),r.push(new Zs({accessMethod:t,accessLocation:te.parse(s.rawData,Se)}))})}var dh=class r extends xc{constructor(...e){let t;if(J.BufferSourceConverter.isBufferSource(e[0]))t=J.BufferSourceConverter.toArrayBuffer(e[0]);else{let n=e[0],o=Array.isArray(e[1])?e[1].map(i=>J.BufferSourceConverter.toArrayBuffer(i)):[];t=te.serialize(new Hr({type:n,values:o}))}super(t,Hr)}onInit(e){this.type=e.type,this.values=e.values}toTextObject(){let e=this.toTextObjectWithoutValue();return e.Value=this.values.map(t=>new Ge("",{"":t})),e}toTextObjectWithoutValue(){let e=this.toTextObjectEmpty();return e[Ge.NAME]===r.NAME&&(e[Ge.NAME]=us.toString(this.type)),e}};dh.NAME="Attribute";var i5=class extends dh{constructor(...e){var t;if(J.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else{let n=new B1({printableString:e[0]});super(nA,[te.serialize(n)])}(t=this.password)!==null&&t!==void 0||(this.password="")}onInit(e){if(super.onInit(e),this.values[0]){let t=te.parse(this.values[0],B1);this.password=t.toString()}}toTextObject(){let e=this.toTextObjectWithoutValue();return e[Ge.VALUE]=this.password,e}};i5.NAME="Challenge Password";var q1=class extends dh{constructor(...e){var t;if(J.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else{let n=e[0],o=new mo;for(let i of n)o.push(te.parse(i.rawData,Vr));super(U1,[te.serialize(o)])}(t=this.items)!==null&&t!==void 0||(this.items=[])}onInit(e){if(super.onInit(e),this.values[0]){let t=te.parse(this.values[0],mo);this.items=t.map(n=>zn.create(te.serialize(n)))}}toTextObject(){let e=this.toTextObjectWithoutValue(),t=this.items.map(n=>n.toTextObject());for(let n of t)e[n[Ge.NAME]]=n;return e}};q1.NAME="Extensions";var hh=class{static register(e,t){this.items.set(e,t)}static create(e){let t=new dh(e),n=this.items.get(t.type);return n?new n(e):t}};hh.items=new Map;var W1="crypto.signatureFormatter",gA=class{toAsnSignature(e,t){return J.BufferSourceConverter.toArrayBuffer(t)}toWebSignature(e,t){return J.BufferSourceConverter.toArrayBuffer(t)}},X6,yA=X6=class{static createPssParams(e,t){let n=X6.getHashAlgorithm(e);return n?new as({hashAlgorithm:n,maskGenAlgorithm:new Z({algorithm:dc,parameters:te.serialize(n)}),saltLength:t}):null}static getHashAlgorithm(e){let t=At.resolve(Nu);return typeof e=="string"?t.toAsnAlgorithm({name:e}):typeof e=="object"&&e&&"name"in e?t.toAsnAlgorithm(e):null}toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"rsassa-pkcs1-v1_5":if("hash"in e){let t;if(typeof e.hash=="string")t=e.hash;else if(e.hash&&typeof e.hash=="object"&&"name"in e.hash&&typeof e.hash.name=="string")t=e.hash.name.toUpperCase();else throw new Error("Cannot get hash algorithm name");switch(t.toLowerCase()){case"sha-1":return new Z({algorithm:th,parameters:null});case"sha-256":return new Z({algorithm:R6,parameters:null});case"sha-384":return new Z({algorithm:rh,parameters:null});case"sha-512":return new Z({algorithm:nh,parameters:null})}}else return new Z({algorithm:ss,parameters:null});break;case"rsa-pss":if("hash"in e){if(!("saltLength"in e&&typeof e.saltLength=="number"))throw new Error("Cannot get 'saltLength' from 'alg' argument");let t=X6.createPssParams(e.hash,e.saltLength);if(!t)throw new Error("Cannot create PSS parameters");return new Z({algorithm:fc,parameters:te.serialize(t)})}else return new Z({algorithm:fc,parameters:null})}return null}toWebAlgorithm(e){switch(e.algorithm){case ss:return{name:"RSASSA-PKCS1-v1_5"};case th:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}};case R6:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case rh:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}};case nh:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}};case fc:if(e.parameters){let t=te.parse(e.parameters,as);return{name:"RSA-PSS",hash:At.resolve(Nu).toWebAlgorithm(t.hashAlgorithm),saltLength:t.saltLength}}else return{name:"RSA-PSS"}}return null}};yA=X6=p([pc()],yA);At.registerSingleton(j1,yA);var wA=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"sha-1":return new Z({algorithm:Eu});case"sha-256":return new Z({algorithm:Su});case"sha-384":return new Z({algorithm:_u});case"sha-512":return new Z({algorithm:Cu})}return null}toWebAlgorithm(e){switch(e.algorithm){case Eu:return{name:"SHA-1"};case Su:return{name:"SHA-256"};case _u:return{name:"SHA-384"};case Cu:return{name:"SHA-512"}}return null}};wA=p([pc()],wA);At.registerSingleton(j1,wA);var ca=class r{addPadding(e,t){let n=J.BufferSourceConverter.toUint8Array(t),o=new Uint8Array(e);return o.set(n,e-n.length),o}removePadding(e,t=!1){let n=J.BufferSourceConverter.toUint8Array(e);for(let o=0;o<n.length;o++)if(n[o]){n=n.slice(o);break}if(t&&n[0]>127){let o=new Uint8Array(n.length+1);return o.set(n,1),o.buffer}return n.buffer}toAsnSignature(e,t){if(e.name==="ECDSA"){let n=e.namedCurve,o=r.namedCurveSize.get(n)||r.defaultNamedCurveSize,i=new Au,s=J.BufferSourceConverter.toUint8Array(t);return i.r=this.removePadding(s.slice(0,o),!0),i.s=this.removePadding(s.slice(o,o+o),!0),te.serialize(i)}return null}toWebSignature(e,t){if(e.name==="ECDSA"){let n=te.parse(t,Au),o=e.namedCurve,i=r.namedCurveSize.get(o)||r.defaultNamedCurveSize,s=this.addPadding(i,this.removePadding(n.r)),a=this.addPadding(i,this.removePadding(n.s));return(0,J.combine)(s,a)}return null}};ca.namedCurveSize=new Map;ca.defaultNamedCurveSize=32;var dA="1.3.101.110",TL="1.3.101.111",hA="1.3.101.112",kL="1.3.101.113",xA=class{toAsnAlgorithm(e){let t=null;switch(e.name.toLowerCase()){case"ed25519":t=hA;break;case"x25519":t=dA;break;case"eddsa":switch(e.namedCurve.toLowerCase()){case"ed25519":t=hA;break;case"ed448":t=kL;break}break;case"ecdh-es":switch(e.namedCurve.toLowerCase()){case"x25519":t=dA;break;case"x448":t=TL;break}}return t?new Z({algorithm:t}):null}toWebAlgorithm(e){switch(e.algorithm){case hA:return{name:"Ed25519"};case kL:return{name:"EdDSA",namedCurve:"Ed448"};case dA:return{name:"X25519"};case TL:return{name:"ECDH-ES",namedCurve:"X448"}}return null}};xA=p([pc()],xA);At.registerSingleton(j1,xA);var bA=class extends bc{constructor(e){bc.isAsnEncoded(e)?super(e,wc):super(e),this.tag=_n.CertificateRequestTag}onInit(e){this.tbs=te.serialize(e.certificationRequestInfo),this.publicKey=new sa(e.certificationRequestInfo.subjectPKInfo);let t=At.resolve(Nu);this.signatureAlgorithm=t.toWebAlgorithm(e.signatureAlgorithm),this.signature=e.signature,this.attributes=e.certificationRequestInfo.attributes.map(o=>hh.create(te.serialize(o)));let n=this.getAttribute(U1);this.extensions=[],n instanceof q1&&(this.extensions=n.items),this.subjectName=new qo(e.certificationRequestInfo.subject),this.subject=this.subjectName.toString()}getAttribute(e){for(let t of this.attributes)if(t.type===e)return t;return null}getAttributes(e){return this.attributes.filter(t=>t.type===e)}getExtension(e){for(let t of this.extensions)if(t.type===e)return t;return null}getExtensions(e){return this.extensions.filter(t=>t.type===e)}async verify(e=jr.get()){let t={...this.publicKey.algorithm,...this.signatureAlgorithm},n=await this.publicKey.export(t,["verify"],e),o=At.resolveAll(W1).reverse(),i=null;for(let a of o)if(i=a.toWebSignature(t,this.signature),i)break;if(!i)throw Error("Cannot convert WebCrypto signature value to ASN.1 format");return await e.subtle.verify(this.signatureAlgorithm,n,i,this.tbs)}toTextObject(){let e=this.toTextObjectEmpty(),t=te.parse(this.rawData,wc),n=t.certificationRequestInfo,o=new Ge("",{Version:`${ns[n.version]} (${n.version})`,Subject:this.subject,"Subject Public Key Info":this.publicKey});if(this.attributes.length){let i=new Ge("");for(let s of this.attributes){let a=s.toTextObject();i[a[Ge.NAME]]=a}o.Attributes=i}return e.Data=o,e.Signature=new Ge("",{Algorithm:aa.serializeAlgorithm(t.signatureAlgorithm),"":t.signature}),e}};bA.NAME="PKCS#10 Certificate Request";var ph=class extends bc{constructor(e){bc.isAsnEncoded(e)?super(e,Ho):super(e),this.tag=_n.CertificateTag}onInit(e){let t=e.tbsCertificate;this.tbs=te.serialize(t);let n=new Uint8Array(t.serialNumber);n.length>1&&n[0]===0&&n[1]>127&&(n=n.slice(1)),this.serialNumber=J.Convert.ToHex(n),this.subjectName=new qo(t.subject),this.subject=new qo(t.subject).toString(),this.issuerName=new qo(t.issuer),this.issuer=this.issuerName.toString();let o=At.resolve(Nu);this.signatureAlgorithm=o.toWebAlgorithm(e.signatureAlgorithm),this.signature=e.signatureValue;let i=t.validity.notBefore.utcTime||t.validity.notBefore.generalTime;if(!i)throw new Error("Cannot get 'notBefore' value");this.notBefore=i;let s=t.validity.notAfter.utcTime||t.validity.notAfter.generalTime;if(!s)throw new Error("Cannot get 'notAfter' value");this.notAfter=s,this.extensions=[],t.extensions&&(this.extensions=t.extensions.map(a=>zn.create(te.serialize(a)))),this.publicKey=new sa(t.subjectPublicKeyInfo)}getExtension(e){for(let t of this.extensions)if(typeof e=="string"){if(t.type===e)return t}else if(t instanceof e)return t;return null}getExtensions(e){return this.extensions.filter(t=>typeof e=="string"?t.type===e:t instanceof e)}async verify(e={},t=jr.get()){let n,o,i=e.publicKey;try{if(!i)n={...this.publicKey.algorithm,...this.signatureAlgorithm},o=await this.publicKey.export(n,["verify"],t);else if("publicKey"in i)n={...i.publicKey.algorithm,...this.signatureAlgorithm},o=await i.publicKey.export(n,["verify"],t);else if(i instanceof sa)n={...i.algorithm,...this.signatureAlgorithm},o=await i.export(n,["verify"],t);else if(J.BufferSourceConverter.isBufferSource(i)){let l=new sa(i);n={...l.algorithm,...this.signatureAlgorithm},o=await l.export(n,["verify"],t)}else n={...i.algorithm,...this.signatureAlgorithm},o=i}catch{return!1}let s=At.resolveAll(W1).reverse(),a=null;for(let l of s)if(a=l.toWebSignature(n,this.signature),a)break;if(!a)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");let c=await t.subtle.verify(this.signatureAlgorithm,o,a,this.tbs);if(e.signatureOnly)return c;{let u=(e.date||new Date).getTime();return c&&this.notBefore.getTime()<u&&u<this.notAfter.getTime()}}async getThumbprint(...e){let t,n="SHA-1";return e[0]&&(e[0].subtle?t=e[0]:(n=e[0]||n,t=e[1])),t??(t=jr.get()),await t.subtle.digest(n,this.rawData)}async isSelfSigned(e=jr.get()){return this.subject===this.issuer&&await this.verify({signatureOnly:!0},e)}toTextObject(){let e=this.toTextObjectEmpty(),t=te.parse(this.rawData,Ho),n=t.tbsCertificate,o=new Ge("",{Version:`${ns[n.version]} (${n.version})`,"Serial Number":n.serialNumber,"Signature Algorithm":aa.serializeAlgorithm(n.signature),Issuer:this.issuer,Validity:new Ge("",{"Not Before":n.validity.notBefore.getTime(),"Not After":n.validity.notAfter.getTime()}),Subject:this.subject,"Subject Public Key Info":this.publicKey});if(n.issuerUniqueID&&(o["Issuer Unique ID"]=n.issuerUniqueID),n.subjectUniqueID&&(o["Subject Unique ID"]=n.subjectUniqueID),this.extensions.length){let i=new Ge("");for(let s of this.extensions){let a=s.toTextObject();i[a[Ge.NAME]]=a}o.Extensions=i}return e.Data=o,e.Signature=new Ge("",{Algorithm:aa.serializeAlgorithm(t.signatureAlgorithm),"":t.signatureValue}),e}};ph.NAME="Certificate";var s5=class{static async createSelfSigned(e,t=jr.get()){if(!e.keys.privateKey)throw new Error("Bad field 'keys' in 'params' argument. 'privateKey' is empty");if(!e.keys.publicKey)throw new Error("Bad field 'keys' in 'params' argument. 'publicKey' is empty");return this.create({serialNumber:e.serialNumber,subject:e.name,issuer:e.name,notBefore:e.notBefore,notAfter:e.notAfter,publicKey:e.keys.publicKey,signingKey:e.keys.privateKey,signingAlgorithm:e.signingAlgorithm,extensions:e.extensions},t)}static async create(e,t=jr.get()){var n;let o;e.publicKey instanceof sa?o=e.publicKey.rawData:"publicKey"in e.publicKey?o=e.publicKey.publicKey.rawData:J.BufferSourceConverter.isBufferSource(e.publicKey)?o=e.publicKey:o=await t.subtle.exportKey("spki",e.publicKey);let i=e.serialNumber?J.BufferSourceConverter.toUint8Array(J.Convert.FromHex(e.serialNumber)):t.getRandomValues(new Uint8Array(16));if(i[0]>127){let w=new Uint8Array(i.length+1);w[0]=0,w.set(i,1),i=w}let s=e.notBefore||new Date,a=e.notAfter||new Date(s.getTime()+31536e6),c=new Ho({tbsCertificate:new Kr({version:ns.v3,serialNumber:i,validity:new ta({notBefore:s,notAfter:a}),extensions:new mo(((n=e.extensions)===null||n===void 0?void 0:n.map(w=>te.parse(w.rawData,Vr)))||[]),subjectPublicKeyInfo:te.parse(o,$r)})});if(e.subject){let w=e.subject instanceof qo?e.subject:new qo(e.subject);c.tbsCertificate.subject=te.parse(w.toArrayBuffer(),dt)}if(e.issuer){let w=e.issuer instanceof qo?e.issuer:new qo(e.issuer);c.tbsCertificate.issuer=te.parse(w.toArrayBuffer(),dt)}let l={hash:"SHA-256"},u="signingKey"in e?{...l,...e.signingAlgorithm,...e.signingKey.algorithm}:{...l,...e.signingAlgorithm},f=At.resolve(Nu);c.tbsCertificate.signature=c.signatureAlgorithm=f.toAsnAlgorithm(u);let h=te.serialize(c.tbsCertificate),d="signingKey"in e?await t.subtle.sign(u,e.signingKey,h):e.signature,m=At.resolveAll(W1).reverse(),g=null;for(let w of m)if(g=w.toAsnSignature(u,d),g)break;if(!g)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");return c.signatureValue=g,new ph(te.serialize(c))}},PL;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})(PL||(PL={}));zn.register(u6,fh);zn.register(p6,Z6);zn.register(m6,J6);zn.register(lv,e5);zn.register(l6,Q6);zn.register(av,t5);zn.register(h6,n5);zn.register(c6,o5);hh.register(nA,i5);hh.register(U1,q1);At.registerSingleton(W1,gA);At.registerSingleton(W1,ca);ca.namedCurveSize.set("P-256",32);ca.namedCurveSize.set("K-256",32);ca.namedCurveSize.set("P-384",48);ca.namedCurveSize.set("P-521",66);var a5=class extends Re{async listen(){throw new e6("WebRTCTransport.createListener")}getAddrs(){return[]}updateAnnounceAddrs(){}async close(){}};var vA=Object.values(Hc).map(r=>r.decoder).reduce((r,e)=>r.or(e)),CQ=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function LL(r){return r?.match(CQ)?.groups?.fingerprint}function AA(r){let t=r.stringTuples().filter(n=>n[0]===oN).map(n=>n[1])[0];if(t===void 0||t==="")throw new $(`Couldn't find a certhash component of multiaddr: ${r.toString()}`);return t}function IQ(r){return yt.decode(vA.decode(r))}function TQ(r){let e=IQ(AA(r)),t=kQ(e.code),n=e.digest.reduce((i,s)=>i+s.toString(16).padStart(2,"0"),""),o=n.match(/.{1,2}/g);if(o==null)throw new J4(n,r.toString());return`${t} ${o.join(":").toUpperCase()}`}function BL(r){let e=r.split(":").map(o=>parseInt(o,16)),t=Uint8Array.from(e),n=Qr(De.code,t);return ne(`/certhash/${Es.encode(n.bytes)}`)}function kQ(r){switch(r){case 17:return"sha-1";case 18:return"sha-256";case 19:return"sha-512";default:throw new t6(r)}}function ML(r,e){let{host:t,port:n,family:o}=r.toOptions(),i=TQ(r);return{type:"answer",sdp:`v=0
o=- 0 0 IN IP${o} ${t}
s=-
t=0 0
a=ice-lite
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
c=IN IP${o} ${t}
a=mid:0
a=ice-options:ice2
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:${i}
a=setup:passive
a=sctp-port:5000
a=max-message-size:${Dd}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function UL(r,e){let{host:t,port:n,family:o}=r.toOptions();return{type:"offer",sdp:`v=0
o=- 0 0 IN IP${o} ${t}
s=-
c=IN IP${o} ${t}
t=0 0
a=ice-options:ice2,trickle
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
a=mid:0
a=setup:active
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:sha-256 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
a=sctp-port:5000
a=max-message-size:${Dd}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function EA(r,e){if(r.sdp===void 0)throw new $("Can't munge a missing SDP");let t=r.sdp.includes(`\r
`)?`\r
`:`
`;return r.sdp=r.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,`
a=ice-ufrag:`+e+t).replace(/\na=ice-pwd:[^\n]*\n/,`
a=ice-pwd:`+e+t),r}var SA=L("libp2p-webrtc-noise:");function HL(r,e,t){let n=r.trim().toLowerCase().replaceAll(":",""),o=L(n,"hex"),i=Qr(De.code,o),s=vA.decode(AA(e)),a=SA.byteLength+i.bytes.byteLength+s.byteLength;return t==="server"?je([SA,s,i.bytes],a):je([SA,i.bytes,s],a)}var PQ=jm?"iceconnectionstatechange":"connectionstatechange";async function $L(r,e,t){let n=r.createDataChannel("",{negotiated:!0,id:0});try{if(t.role==="client"){t.log.trace("client creating local offer");let f=await r.createOffer();t.log.trace("client created local offer %s",f.sdp);let h=EA(f,e);t.log.trace("client setting local offer %s",h.sdp),await r.setLocalDescription(h);let d=ML(t.remoteAddr,e);t.log.trace("client setting server description %s",d.sdp),await r.setRemoteDescription(d)}else{let f=UL(t.remoteAddr,e);t.log.trace("server setting client %s %s",f.type,f.sdp),await r.setRemoteDescription(f),t.log.trace("server creating local answer");let h=await r.createAnswer();t.log.trace("server created local answer");let d=EA(h,e);t.log.trace("server setting local description %s",h.sdp),await r.setLocalDescription(d)}if(n.readyState!=="open"&&(t.log.trace("%s wait for handshake channel to open, starting status %s",t.role,n.readyState),await Ft(n,"open",t.signal)),t.log.trace("%s handshake channel opened",t.role),t.role==="server"){let f=r.remoteFingerprint()?.value??"";t.remoteAddr=t.remoteAddr.encapsulate(BL(f))}let o=LL(r.localDescription?.sdp);if(o==null)throw new Ja("Could not get fingerprint from local description sdp");t.log.trace("%s performing noise handshake",t.role);let i=HL(o,t.remoteAddr,t.role),s=B3({prologueBytes:i})(t),a=Nd({channel:n,direction:"outbound",handshake:!0,logger:t.logger,...t.dataChannel??{}}),c=new eu(t,{peerConnection:r,remoteAddr:t.remoteAddr,timeline:{open:Date.now()},metrics:t.events});r.addEventListener(PQ,()=>{switch(r.connectionState){case"failed":case"disconnected":case"closed":c.close().catch(f=>{t.log.error("error closing connection",f),c.abort(f)});break;default:break}}),t.events?.increment({peer_connection:!0});let l=new Za(t,{peerConnection:r,metrics:t.events,dataChannelOptions:t.dataChannel});if(t.role==="client")return t.log.trace("%s secure inbound",t.role),await s.secureInbound(a,{remotePeer:t.remotePeerId,signal:t.signal,skipStreamMuxerNegotiation:!0}),t.log.trace("%s upgrade outbound",t.role),await t.upgrader.upgradeOutbound(c,{skipProtection:!0,skipEncryption:!0,muxerFactory:l,signal:t.signal});t.log.trace("%s secure outbound",t.role);let u=await s.secureOutbound(a,{remotePeer:t.remotePeerId,signal:t.signal,skipStreamMuxerNegotiation:!0});c.remoteAddr=c.remoteAddr.encapsulate(`/p2p/${u.remotePeer}`),t.log.trace("%s upgrade inbound",t.role),await t.upgrader.upgradeInbound(c,{skipProtection:!0,skipEncryption:!0,muxerFactory:l,signal:t.signal})}catch(o){throw n.close(),o}}async function VL(r,e,t,n){n==null&&(n=await RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"}));let o=typeof t=="function"?await t():t;return new RTCPeerConnection({...o??{},certificates:[n]})}async function KL(r){let e=await xg(r),t=await crypto.subtle.exportKey("pkcs8",e.privateKey);return["-----BEGIN PRIVATE KEY-----",...K(new Uint8Array(t),"base64pad").split(/(.{64})/).filter(Boolean),"-----END PRIVATE KEY-----"].join(`
`)}var c5=class{log;metrics;components;init;certificate;privateKey;emitter;renewCertificateTask;constructor(e,t={}){if(this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,this.emitter=new Re,t.certificateLifespan!=null&&t.certificateRenewalThreshold!=null&&t.certificateRenewalThreshold>=t.certificateLifespan)throw new $("Certificate renewal threshold must be less than certificate lifespan");e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}[ma]=!0;[Symbol.toStringTag]="@libp2p/webrtc-direct";[Ye]=["@libp2p/transport"];async start(){this.certificate=await this.getCertificate()}async stop(){this.renewCertificateTask!=null&&clearTimeout(this.renewCertificateTask),this.certificate=void 0}async dial(e,t){this.log("dial %a",e),t.signal.throwIfAborted();let n,o=e.getPeerId();o!=null&&(n=tt(o));let i=vN(),s=await VL("client",i,typeof this.init.rtcConfiguration=="function"?await this.init.rtcConfiguration():this.init.rtcConfiguration??{});try{return await $L(s,i,{role:"client",log:this.log,logger:this.components.logger,metrics:this.components.metrics,events:this.metrics?.dialerEvents,signal:t.signal,remoteAddr:e,dataChannel:this.init.dataChannel,upgrader:t.upgrader,peerId:this.components.peerId,remotePeerId:n,privateKey:this.components.privateKey})}catch(a){throw s.close(),a}}createListener(e){if(this.certificate==null)throw new Yn;return new a5(this.components,{...this.init,...e,certificate:this.certificate,emitter:this.emitter})}listenFilter(e){return e.filter(Gp.exactMatch)}dialFilter(e){return this.listenFilter(e)}async getCertificate(e){if(RQ(this.init.certificate))return this.log("using provided TLS certificate"),this.init.certificate;let t=await this.loadOrCreatePrivateKey(),{pem:n,certhash:o}=await this.loadOrCreateCertificate(t,e);return{privateKey:await KL(t),pem:n,certhash:o}}async loadOrCreatePrivateKey(){if(this.privateKey!=null)return this.privateKey;let e=this.init.certificateKeychainName??dN,t=this.getKeychain();try{if(t==null)throw this.log("no keychain configured - not checking for stored private key"),new $e;this.log.trace("checking for stored private key"),this.privateKey=await t.exportKey(e)}catch(n){if(n.name!=="NotFoundError")throw n;this.log.trace("generating private key"),this.privateKey=await If("ECDSA","P-256"),t!=null?(this.log.trace("storing private key"),await t.importKey(e,this.privateKey)):this.log("no keychain configured - not storing private key")}return this.privateKey}async loadOrCreateCertificate(e,t){if(this.certificate!=null&&t!==!0)return this.certificate;let n,o=new Je(this.init.certificateDatastoreKey??fN),i=await xg(e);try{if(t===!0)throw this.log.trace("forcing renewal of TLS certificate"),new $e;this.log.trace("checking for stored TLS certificate"),n=await this.loadCertificate(o,i)}catch(a){if(a.name!=="NotFoundError")throw a;this.log.trace("generating new TLS certificate"),n=await this.createCertificate(o,i)}let s=n.notAfter.getTime()-(this.init.certificateRenewalThreshold??Pb)-Date.now();return s<0&&(s=100),this.log("will renew TLS certificate after %d ms",s),this.renewCertificateTask=setTimeout(()=>{this.log("renewing TLS certificate"),this.getCertificate(!0).then(a=>{this.certificate=a,this.emitter.safeDispatchEvent("certificate:renew",{detail:a})}).catch(a=>{this.log.error("could not renew certificate - %e",a)})},s),{pem:n.toString("pem"),certhash:Es.encode((await De.digest(new Uint8Array(n.rawData))).bytes)}}async loadCertificate(e,t){let n=await this.components.datastore.get(e),o=new ph(n),i=o.notAfter.getTime()-(this.init.certificateRenewalThreshold??Pb);if(Date.now()>i)throw this.log("stored TLS certificate has expired"),new $e;this.log("loaded certificate, expires in %d ms",i);let s=await o.publicKey.export(crypto),a=await crypto.subtle.exportKey("raw",s),c=await crypto.subtle.exportKey("raw",t.publicKey);if(!de(new Uint8Array(a,0,a.byteLength),new Uint8Array(c,0,c.byteLength)))throw this.log("stored TLS certificate public key did not match public key from private key"),new $e;return this.log("loaded certificate, expiry time is %o",i),o}async createCertificate(e,t){let n=new Date,o=new Date(Date.now()+(this.init.certificateLifespan??hN));n.setMilliseconds(0),o.setMilliseconds(0);let i=await s5.createSelfSigned({serialNumber:(BigInt(Math.random().toString().replace(".",""))*100000n).toString(16),name:"CN=example.com, C=US, L=CA, O=example, ST=CA",notBefore:n,notAfter:o,keys:t,extensions:[new fh(!1,void 0,!0)]},crypto);return this.getKeychain()!=null?(this.log.trace("storing TLS certificate"),await this.components.datastore.put(e,L(i.toString("pem")))):this.log("no keychain is configured so not storing TLS certificate since the private key will not be reused"),i}getKeychain(){try{return this.components.keychain}catch{}}};function RQ(r){return r==null?!1:typeof r.privateKey=="string"&&typeof r.pem=="string"&&typeof r.certhash=="string"}function l5(r){return e=>new c5(e,r)}function zL(r){return e=>new i6(e,r)}var qL=async r=>{if(r.readyState>=2)throw new Error("socket closed");r.readyState!==1&&await new Promise((e,t)=>{function n(){r.removeEventListener("open",o),r.removeEventListener("error",i)}function o(){n(),e()}function i(s){n(),t(s.error??new Error(`connect ECONNREFUSED ${r.url}`))}r.addEventListener("open",o),r.addEventListener("error",i)})};var jL=(r,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async n=>{for await(let o of n){try{await qL(r)}catch(i){if(i.message==="socket closed")break;throw i}if(r.readyState===r.CLOSING||r.readyState===r.CLOSED)break;r.send(o)}e.closeOnEnd!=null&&r.readyState<=1&&await new Promise((o,i)=>{r.addEventListener("close",s=>{if(s.wasClean||s.code===1006)o();else{let a=Object.assign(new Error("ws error"),{event:s});i(a)}}),setTimeout(()=>{r.close()})})});var YL=st(GL(),1);function XL(r){return r instanceof ArrayBuffer||r?.constructor?.name==="ArrayBuffer"&&typeof r?.byteLength=="number"}var QL=r=>{r.binaryType="arraybuffer";let e=async()=>{await new Promise((i,s)=>{if(n){i();return}if(o!=null){s(o);return}let a=u=>{r.removeEventListener("open",c),r.removeEventListener("error",l),u()},c=()=>{a(i)},l=u=>{a(()=>{s(u.error??new Error(`connect ECONNREFUSED ${r.url}`))})};r.addEventListener("open",c),r.addEventListener("error",l)})},t=async function*(){let i=new YL.EventIterator(({push:s,stop:a,fail:c})=>{let l=f=>{let h=null;typeof f.data=="string"&&(h=L(f.data)),XL(f.data)&&(h=new Uint8Array(f.data)),f.data instanceof Uint8Array&&(h=f.data),h!=null&&s(h)},u=f=>{c(f.error??new Error("Socket error"))};return r.addEventListener("message",l),r.addEventListener("error",u),r.addEventListener("close",a),()=>{r.removeEventListener("message",l),r.removeEventListener("error",u),r.removeEventListener("close",a)}},{highWaterMark:1/0});await e();for await(let s of i)yield XL(s)?new Uint8Array(s):s}(),n=r.readyState===1,o;return r.addEventListener("open",()=>{n=!0,o=null}),r.addEventListener("close",()=>{n=!1,o=null}),r.addEventListener("error",i=>{n||(o=i.error??new Error(`connect ECONNREFUSED ${r.url}`))}),Object.assign(t,{connected:e})};var ZL=(r,e)=>{e=e??{};let t=QL(r),n=e.remoteAddress,o=e.remotePort;if(r.url!=null)try{let s=new URL(r.url);n=s.hostname,o=parseInt(s.port,10)}catch{}if(n==null||o==null)throw new Error("Remote connection did not have address and/or port");return{sink:jL(r,e),source:t,connected:async()=>{await t.connected()},close:async()=>{(r.readyState===r.CONNECTING||r.readyState===r.OPEN)&&await new Promise(s=>{r.addEventListener("close",()=>{s()}),r.close()})},destroy:()=>{r.terminate!=null?r.terminate():r.close()},remoteAddress:n,remotePort:o,socket:r}};var JL=WebSocket;var NQ={"http:":"ws:","https:":"wss:"},eB="ws:",tB=(r,e)=>{if(r.startsWith("//")&&(r=`${e?.protocol??eB}${r}`),r.startsWith("/")&&e!=null){let n=e.protocol??eB,o=e.host,i=e.port!=null&&o?.endsWith(`:${e.port}`)!==!0?`:${e.port}`:"";r=`${n}//${o}${i}${r}`}let t=new URL(r);for(let[n,o]of Object.entries(NQ))t.protocol===n&&(t.protocol=o);return t};function rB(r,e){let t=typeof window>"u"?void 0:window.location;e=e??{};let n=tB(r,t),o=new JL(n.toString(),e.websocket);return ZL(o,e)}function nB(r){return r.filter(e=>bl.exactMatch(e)||Hs.exactMatch(e))}function oB(){throw new Error("WebSocket Servers can not be created in the browser!")}function iB(r,e,t){let n=t.logger.forComponent("libp2p:websockets:maconn"),o=t.metrics,i=t.metricPrefix??"",s={log:n,async sink(a){try{await r.sink(async function*(){for await(let c of a)c instanceof Uint8Array?yield c:yield c.subarray()}())}catch(c){c.type!=="aborted"&&n.error(c)}},source:r.source,remoteAddr:e,timeline:{open:Date.now()},async close(a={}){let c=Date.now();if(a.signal==null){let u=AbortSignal.timeout(500);a={...a,signal:u}}let l=()=>{let{host:u,port:f}=s.remoteAddr.toOptions();n("timeout closing stream to %s:%s after %dms, destroying it manually",u,f,Date.now()-c),this.abort(new Xe("Socket close timeout"))};a.signal?.addEventListener("abort",l);try{await r.close()}catch(u){n.error("error closing WebSocket gracefully",u),this.abort(u)}finally{a.signal?.removeEventListener("abort",l),s.timeline.close=Date.now()}},abort(a){let{host:c,port:l}=s.remoteAddr.toOptions();n("timeout closing stream to %s:%s due to error",c,l,a),r.destroy(),s.timeline.close=Date.now(),o?.increment({[`${i}error`]:!0})}};return r.socket.addEventListener("close",()=>{o?.increment({[`${i}close`]:!0}),s.timeline.close==null&&(s.timeline.close=Date.now())},{once:!0}),s}var IA=class{log;init;logger;metrics;components;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[ma]=!0;[Symbol.toStringTag]="@libp2p/websockets";[Ye]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};let n=await this._connect(e,t),o=iB(n,e,{logger:this.logger,metrics:this.metrics?.dialerEvents});this.log("new outbound connection %s",o.remoteAddr);let i=await t.upgrader.upgradeOutbound(o,t);return this.log("outbound connection %s upgraded",o.remoteAddr),i}async _connect(e,t){t?.signal?.throwIfAborted();let n=e.toOptions();this.log("dialing %s:%s",n.host,n.port);let o=ve(),i=rB(Yf(e),this.init);i.socket.addEventListener("error",()=>{let s=new Gu(`Could not connect to ${e.toString()}`);this.log.error("connection error:",s),this.metrics?.dialerEvents.increment({error:!0}),o.reject(s)});try{t.onProgress?.(new j("websockets:open-connection")),await ut(Promise.race([i.connected(),o.promise]),t.signal)}catch(s){throw t.signal?.aborted&&this.metrics?.dialerEvents.increment({abort:!0}),i.close().catch(a=>{this.log.error("error closing raw socket",a)}),s}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),i}createListener(e){return oB({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){return e=Array.isArray(e)?e:[e],this.init?.filter!=null?this.init?.filter(e):nB(e)}dialFilter(e){return this.listenFilter(e)}};function d5(r={}){return e=>new IA(e,r)}var TA=st(j2(),1);function h5(r,e){let t=e.map((n,o)=>({record:Pn(n),index:o}));return t.sort((n,o)=>{let i=n.record.sequence,s=o.record.sequence;if(i>s)return-1;if(i<s)return 1;if(n.record.validityType===Nr.ValidityType.EOL&&o.record.validityType===Nr.ValidityType.EOL){let a=TA.default.fromString(n.record.validity).toDate(),c=TA.default.fromString(o.record.validity).toDate();if(a.getTime()>c.getTime())return-1;if(a.getTime()<c.getTime())return 1}return 0}),t[0].index}var sB="5.4.2",aB="helia";var cB={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dnsaddr/va1.bootstrap.libp2p.io/p2p/12D3KooWKnDdG3iXw9eTFijk3EWSunZcFi54Zka4wmtqtt6rPxc8","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};function X1(r={}){let e=`${aB}/${sB} ${_3()}`;return{privateKey:r.privateKey,dns:r.dns,nodeInfo:{userAgent:e},addresses:{listen:["/p2p-circuit","/webrtc"]},transports:[lb(),zL(),l5(),d5()],connectionEncrypters:[B3()],streamMuxers:[SR(),QD()],peerDiscovery:[HR(cB)],services:{autoNAT:kR(),dcutr:eD(),delegatedRouting:()=>iy("https://delegated-ipfs.dev",Lx()),dht:zD({clientMode:!0,validators:{ipns:Oa},selectors:{ipns:h5}}),identify:aD(),identifyPush:cD(),keychain:Dy(r.keychain),ping:tN()}}}async function lB(r){let e=r.libp2p??{};e.privateKey==null&&r.datastore!=null&&(e.privateKey=await r9(r.datastore,r.keychain));let t=X1(e);return t.datastore=t.datastore??r.datastore,await I3({...t,...e,start:!1})}async function uB(r={}){let e=r.datastore??new Al,t=r.blockstore??new nm,n;return LQ(r.libp2p)?n=r.libp2p:n=await lB({...r,libp2p:{dns:r.dns,...r.libp2p,start:void 0},datastore:e}),{...r,libp2p:n,datastore:e,blockstore:t,blockBrokers:r.blockBrokers??[Yp(),Mp()],routers:r.routers??[rm(n),tm()],metrics:n.metrics,start:r.start??!0}}function LQ(r){return r==null?!1:["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"].every(t=>typeof r[t]=="function")}async function fB(r={}){let e=await uB(r),t=new ay(e);return r.start!==!1&&await t.start(),t}function dB(){let r=X1();r.start=!1,r.addresses={listen:[]},r.transports=[l5(),d5()],r.peerDiscovery=[];let e={dcutr:r.services.dcutr,identify:r.services.identify,keychain:r.services.keychain,ping:r.services.ping};return{...r,start:!1,services:e}}var p5=class extends Error{static name="DNSLinkNotFoundError";constructor(e="DNSLink not found"){super(e),this.name="DNSLinkNotFoundError"}},m5=class extends Error{static name="RecordsFailedValidationError";constructor(e="Records failed validation"){super(e),this.name="RecordsFailedValidationError"}},g5=class extends Error{static name="UnsupportedMultibasePrefixError";constructor(e="Unsupported multibase prefix"){super(e),this.name="UnsupportedMultibasePrefixError"}},y5=class extends Error{static name="UnsupportedMultihashCodecError";constructor(e="Unsupported multihash codec"){super(e),this.name="UnsupportedMultihashCodecError"}},w5=class extends Error{static name="InvalidValueError";constructor(e="Invalid value"){super(e),this.name="InvalidValueError"}};var BQ=32;async function hB(r,e,t,n,o={}){if(e===0)throw new Error("recursion limit exceeded");n("query %s for TXT and CNAME records",r);let s=((await t.query(r,{...o,types:[rn.TXT]}))?.Answer??[]).sort((l,u)=>l.data.localeCompare(u.data));n("found %d TXT records for %s",s.length,r);for(let l of s)try{let u=l.data;if(u.startsWith('"')&&u.endsWith('"')&&(u=u.substring(1,u.length-1)),!u.startsWith("dnslink="))continue;n("%s TXT %s",l.name,u),u=u.replace("dnslink=","");let[,f,h,...d]=u.split("/");if(f==="ipfs")try{return{value:`/ipfs/${q.parse(h)}${d.length>0?`/${d.join("/")}`:""}`,answer:l}}catch{}else if(f==="ipns"){try{let m;return h.charAt(0)==="1"||h.charAt(0)==="Q"?m=tt(h):m=yn(q.parse(h)),{value:`/ipns/${m}${d.length>0?`/${d.join("/")}`:""}`,answer:l}}catch{}return await x5(h,e-1,t,n,o)}else{if(f==="dnslink")return await x5(h,e-1,t,n,o);n('unknown protocol "%s" in DNSLink record for domain: %s',f,r);continue}}catch(u){n.error("could not parse DNS link record for domain %s, %s",r,l.data,u)}n("no DNSLink records found for %s, falling back to CNAME",r);let c=((await t.query(r,{...o,types:[rn.CNAME]}))?.Answer??[]).sort((l,u)=>l.data.localeCompare(u.data));n("found %d CNAME records for %s",c.length,r);for(let l of c)try{return await x5(l.data,e-1,t,n,o)}catch(u){n.error("domain %s cname %s had no DNSLink records",r,l.data,u)}throw new p5(`No DNSLink records found for domain: ${r}`)}async function x5(r,e,t,n,o={}){if(e===0)throw new Error("recursion limit exceeded");r.startsWith("_dnslink.")||(r=`_dnslink.${r}`);try{return await hB(r,e,t,n,o)}catch(i){if(i.code!=="ENOTFOUND"&&i.code!=="ENODATA"&&i.name!=="DNSLinkNotFoundError"&&i.name!=="NotFoundError")throw i;return r.startsWith("_dnslink.")?r=r.replace("_dnslink.",""):r=`_dnslink.${r}`,hB(r,e,t,n,o)}}async function pB(r,e,t,n={}){return x5(r,n.maxRecursiveDepth??BQ,e,t,n)}var kA=class{routing;constructor(e){this.routing=e}async put(e,t,n={}){try{await this.routing.put(e,t,n)}catch(o){throw n.onProgress?.(new j("ipns:routing:helia:error",o)),o}}async get(e,t={}){try{return await this.routing.get(e,t)}catch(n){throw t.onProgress?.(new j("ipns:routing:helia:error",n)),n}}};function mB(r){return new kA(r)}function b5(r){return new Je("/dht/record/"+K(r,"base32"),!1)}function gB(r){return{async put(e,t,n={}){try{let o=b5(e);try{let s=await r.get(o),a=Pt.deserialize(s);if(de(a.value,t))return}catch(s){if(s.name!=="NotFoundError")throw s}let i=new Pt(e,t,new Date);n.onProgress?.(new j("ipns:routing:datastore:put")),await r.put(o,i.serialize(),n)}catch(o){throw n.onProgress?.(new j("ipns:routing:datastore:error",o)),o}},async get(e,t={}){try{let n=b5(e);t.onProgress?.(new j("ipns:routing:datastore:get"));let o=await r.get(n,t),i=Pt.deserialize(o);return{record:i.value,created:i.timeReceived}}catch(n){throw t.onProgress?.(new j("ipns:routing:datastore:error",n)),n}},async has(e,t={}){let n=b5(e);return r.has(n,t)},async delete(e,t){let n=b5(e);return r.delete(n,t)}}}var PA="/ipns/";function RA(r,e){return r.code===e}var la=Be("helia:ipns"),xB=60*1e3,bB=60*xB,FQ=48*bB,DA=23*bB,yB=BigInt(xB)*5000000n,wB={[dn.prefix]:dn,[Ve.prefix]:Ve},NA=class{routers;localStore;timeout;dns;log;constructor(e,t=[]){this.routers=[mB(e.routing),...t],this.localStore=gB(e.datastore),this.dns=e.dns,this.log=e.logger.forComponent("helia:ipns")}async publish(e,t,n={}){try{let o=1n,i=$s(e.publicKey.toMultihash());if(await this.localStore.has(i,n)){let{record:l}=await this.localStore.get(i,n);o=Pn(l).sequence+1n}let s=n.ttl!=null?BigInt(n.ttl)*1000000n:yB,a=await OT(e,t,o,n.lifetime??FQ,{...n,ttlNs:s}),c=Na(a);return await this.localStore.put(i,c,n),n.offline!==!0&&await Promise.all(this.routers.map(async l=>{await l.put(i,c,n)})),a}catch(o){throw n.onProgress?.(new j("ipns:publish:error",o)),o}}async resolve(e,t={}){let n=SE(e)?e.toMultihash():e,o=$s(n),i=await this.#t(o,t);return{...await this.#e(i.value,t),record:i}}async resolveDNSLink(e,t={}){let n=await pB(e,this.dns,this.log,t);return{...await this.#e(n.value,t),answer:n.answer}}republish(e={}){if(this.timeout!=null)throw new Error("Republish is already running");e.signal?.addEventListener("abort",()=>{clearTimeout(this.timeout)});async function t(){let n=Date.now();e.onProgress?.(new j("ipns:republish:start"));let i=Date.now()-n,s=DA-i;s<0&&(s=e.interval??DA),setTimeout(()=>{t().catch(a=>{la.error("error republishing",a)})},s)}this.timeout=setTimeout(()=>{t().catch(n=>{la.error("error republishing",n)})},e.interval??DA)}async#e(e,t={}){let n=e.split("/");try{let o=n[1];if(o==="ipns"){let i=n[2],s=i.substring(0,1),a;if(s==="1"||s==="Q")a=Ve.decode(`z${i}`);else if(wB[s]!=null)a=wB[s].decode(i);else throw new g5(`Unsupported multibase prefix "${s}"`);let c;try{c=ze(a)}catch{c=q.decode(a).multihash}if(!RA(c,0)&&!RA(c,18))throw new y5(`Unsupported multihash codec "${c.code}"`);let{cid:l}=await this.resolve(c,t),u=n.slice(3).join("/");return{cid:l,path:u}}else if(o==="ipfs"){let i=q.parse(n[2]),s=n.slice(3).join("/");return{cid:i,path:s}}}catch(o){la.error("error parsing ipfs path",o)}throw la.error("invalid ipfs path %s",e),new w5("Invalid value")}async#t(e,t={}){let n=[];if(await this.localStore.has(e,t))if(la("record is present in the cache"),t.nocache!==!0)try{let{record:a,created:c}=await this.localStore.get(e,t);this.log("record retrieved from cache"),await Oa(e,a),this.log("record was valid");let l=Pn(a),u=Number((l.ttl??yB)/1000000n);if(c.getTime()+u>Date.now())return this.log("record TTL was valid"),l;if(t.offline===!0)return this.log("record TTL has been reached but we are resolving offline-only, returning record"),l;this.log("record TTL has been reached, searching routing for updates"),n.push(a)}catch(a){this.log("cached record was invalid",a),await this.localStore.delete(e,t)}else la("ignoring local cache due to nocache=true option");if(t.offline===!0)throw new $e("Record was not present in the cache or has expired");la("did not have record locally");let i=0;if(await Promise.all(this.routers.map(async a=>{let c;try{c=await a.get(e,{...t,validate:!1})}catch(l){la.error("error finding IPNS record",l);return}try{await Oa(e,c),n.push(c)}catch(l){i++,la.error("error finding IPNS record",l)}})),n.length===0)throw i>0?new m5(`${i>1?`${i} records`:"Record"} found for routing key ${i>1?"were":"was"} invalid`):new $e("Could not find record for routing key");let s=n[h5(e,n)];return await this.localStore.put(e,s,t),Pn(s)}async republishRecord(e,t,n={}){let o;try{if(o=Jp(t)?.toMultihash(),o==null)if(typeof e=="string"){e.startsWith(PA)&&(e=e.slice(PA.length));try{o=tt(e).toMultihash()}catch(a){throw new Error(`Invalid string key: ${a.message}`)}}else o=e;if(o==null)throw new Error("No public key multihash found to determine the routing key");let i=$s(o),s=Na(t);await Oa(i,s),await this.localStore.put(i,s,n),n.offline!==!0&&await Promise.all(this.routers.map(async a=>{await a.put(i,s,n)}))}catch(i){throw n.onProgress?.(new j("ipns:republish:error",{key:o,record:t,err:i})),i}}};function vB(r,{routers:e=[]}={}){return new NA(r,e)}var Lu=class extends Map{#e=0;#t=new Map;#r=new Map;#i;#c;#l;constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof e.maxAge=="number"&&e.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.#i=e.maxSize,this.#c=e.maxAge||Number.POSITIVE_INFINITY,this.#l=e.onEviction}get __oldCache(){return this.#r}#s(e){if(typeof this.#l=="function")for(let[t,n]of e)this.#l(t,n.value)}#n(e,t){return typeof t.expiry=="number"&&t.expiry<=Date.now()?(typeof this.#l=="function"&&this.#l(e,t.value),this.delete(e)):!1}#o(e,t){if(this.#n(e,t)===!1)return t.value}#d(e,t){return t.expiry?this.#o(e,t):t.value}#a(e,t){let n=t.get(e);return this.#d(e,n)}#f(e,t){this.#t.set(e,t),this.#e++,this.#e>=this.#i&&(this.#e=0,this.#s(this.#r),this.#r=this.#t,this.#t=new Map)}#u(e,t){this.#r.delete(e),this.#f(e,t)}*#h(){for(let e of this.#r){let[t,n]=e;this.#t.has(t)||this.#n(t,n)===!1&&(yield e)}for(let e of this.#t){let[t,n]=e;this.#n(t,n)===!1&&(yield e)}}get(e){if(this.#t.has(e)){let t=this.#t.get(e);return this.#d(e,t)}if(this.#r.has(e)){let t=this.#r.get(e);if(this.#n(e,t)===!1)return this.#u(e,t),t.value}}set(e,t,{maxAge:n=this.#c}={}){let o=typeof n=="number"&&n!==Number.POSITIVE_INFINITY?Date.now()+n:void 0;return this.#t.has(e)?this.#t.set(e,{value:t,expiry:o}):this.#f(e,{value:t,expiry:o}),this}has(e){return this.#t.has(e)?!this.#n(e,this.#t.get(e)):this.#r.has(e)?!this.#n(e,this.#r.get(e)):!1}peek(e){if(this.#t.has(e))return this.#a(e,this.#t);if(this.#r.has(e))return this.#a(e,this.#r)}delete(e){let t=this.#t.delete(e);return t&&this.#e--,this.#r.delete(e)||t}clear(){this.#t.clear(),this.#r.clear(),this.#e=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");let t=[...this.#h()],n=t.length-e;n<0?(this.#t=new Map(t),this.#r=new Map,this.#e=t.length):(n>0&&this.#s(t.slice(0,n)),this.#r=new Map(t.slice(n)),this.#t=new Map,this.#e=0),this.#i=e}*keys(){for(let[e]of this)yield e}*values(){for(let[,e]of this)yield e}*[Symbol.iterator](){for(let e of this.#t){let[t,n]=e;this.#n(t,n)===!1&&(yield[t,n.value])}for(let e of this.#r){let[t,n]=e;this.#t.has(t)||this.#n(t,n)===!1&&(yield[t,n.value])}}*entriesDescending(){let e=[...this.#t];for(let t=e.length-1;t>=0;--t){let n=e[t],[o,i]=n;this.#n(o,i)===!1&&(yield[o,i.value])}e=[...this.#r];for(let t=e.length-1;t>=0;--t){let n=e[t],[o,i]=n;this.#t.has(o)||this.#n(o,i)===!1&&(yield[o,i.value])}}*entriesAscending(){for(let[e,t]of this.#h())yield[e,t.value]}get size(){if(!this.#e)return this.#r.size;let e=0;for(let t of this.#r.keys())this.#t.has(t)||e++;return Math.min(this.#e+e,this.#i)}get maxSize(){return this.#i}entries(){return this.entriesAscending()}forEach(e,t=this){for(let[n,o]of this.entriesAscending())e.call(t,o,n,this)}get[Symbol.toStringTag](){return"QuickLRU"}toString(){return`QuickLRU(${this.size}/${this.maxSize})`}[Symbol.for("nodejs.util.inspect.custom")](){return this.toString()}};function Bu(r,e={}){let t=vd(r),n={_cancelled:!1,async start(){this._cancelled=!1},async pull(o){try{let{value:i,done:s}=await t.next();if(this._cancelled)return;if(s===!0){o.close();return}o.enqueue(i)}catch(i){o.error(i)}},cancel(){this._cancelled=!0}};return new globalThis.ReadableStream(n,e)}var Er=class extends Error{static name="InvalidRangeError";constructor(e="Invalid range request"){super(e),this.name="InvalidRangeError"}},v5=class extends Error{static name="NoContentError";constructor(e="No content found"){super(e),this.name="NoContentError"}},A5=class extends Error{static name="SubdomainNotSupportedError";constructor(e="Subdomain not supported"){super(e),this.name="SubdomainNotSupportedError"}};function AB(r,e){if(r==null)return;if(r instanceof Headers)return r.get(e)??void 0;if(Array.isArray(r))return r.find(([o])=>o.toLowerCase()===e.toLowerCase())?.[1];let t=Object.keys(r).find(n=>n.toLowerCase()===e.toLowerCase());if(t!=null)return r[t]}function EB(r,e,t){if((r??0)>(e??1/0))throw new Er("Invalid range: Range-start index is greater than range-end index.");if(r!=null&&(e??0)>=(t??1/0))throw new Er("Invalid range: Range-end index is greater than or equal to the size of the file.");if(r==null&&(e??0)>(t??1/0))throw new Er("Invalid range: Range-end index is greater than the size of the file.");if(r!=null&&r<0)throw new Er("Invalid range: Range-start index cannot be negative.");if(r!=null&&e!=null)return{byteSize:e-r+1,start:r,end:e};if(r==null&&e!=null)return t==null?{end:e}:e===t?{byteSize:t,start:0,end:t-1}:{byteSize:e,start:t-e,end:t-1};if(r!=null&&e==null){if(t==null)return{start:r};let n=t-1;return{byteSize:t-r,start:r,end:n}}return{byteSize:t,start:0,end:t!=null?t-1:0}}function SB({ttl:r,protocol:e,response:t}){if(t.headers.has("cache-control"))return;let n;e==="ipfs"?n="public, max-age=29030400, immutable":r==null?n="public, max-age=300":n=`public, max-age=${r}`,t.headers.set("cache-control",n)}function E5({byteStart:r,byteEnd:e,byteSize:t}){let n=t??"*";if((e??0)>=(t??1/0))throw new Er("Invalid range: Range-end index is greater than or equal to the size of the file.");if((r??0)>=(t??1/0))throw new Er("Invalid range: Range-start index is greater than or equal to the size of the file.");if(r!=null&&e==null)return t==null?`bytes */${n}`:`bytes ${r}-${t-1}/${t}`;if(r==null&&e!=null){if(t==null)return`bytes */${n}`;let o=t-1;return`bytes ${o-e+1}-${o}/${t}`}return r==null&&e==null?`bytes */${n}`:`bytes ${r}-${e}/${n}`}function S5(r,e){e!=null&&r.headers.set("X-Ipfs-Roots",Y1(e))}function Y1(r){return r.map(e=>e.toV1().toString()).join(",")}function HQ(r){return typeof r=="string"?r.length:r instanceof ArrayBuffer||r instanceof Uint8Array?r.byteLength:r instanceof Blob?r.size:(r instanceof ReadableStream,null)}function $Q(r){if(!r.startsWith("bytes="))throw new Er("Invalid range request");let t=r.substring(6).split(",").map(o=>o.trim()),n=[];for(let o of t){let i=o.match(/^(?<start>\d+)?-(?<end>\d+)?$/);if(i?.groups==null)throw new Er(`Invalid range specification: ${o}`);let{start:s,end:a}=i.groups;n.push({start:s??null,end:a??null})}if(n.length===0)throw new Er("No valid ranges found");return{ranges:n}}var _5=class{headers;isRangeRequest;_fileSize;_body=null;rangeRequestHeader;log;multiPartBoundary;requestRanges=[];byteRanges=[];isMultiRangeRequest=!1;_isValidRangeRequest=!1;constructor(e,t){if(this.headers=t,this.log=e.forComponent("helia:verified-fetch:byte-range-context"),this.rangeRequestHeader=AB(this.headers,"Range"),this.rangeRequestHeader!=null){this.isRangeRequest=!0,this.log.trace("range request detected");try{let{ranges:n}=$Q(this.rangeRequestHeader);this.isMultiRangeRequest=n.length>1,this.requestRanges=n.map(o=>({start:o.start!=null?parseInt(o.start):null,end:o.end!=null?parseInt(o.end):null})),this.multiPartBoundary=`multipart_byteranges_${Math.floor(Math.random()*1e9)}`}catch(n){this.log.error("error parsing range request header - %e",n),this.requestRanges=[]}this.setOffsetDetails()}else this.log.trace("no range request detected"),this.isRangeRequest=!1}getByteRanges(){return this.byteRanges}setBody(e,t="application/octet-stream"){typeof e=="function"?this._body=this.createRangeStream(e,t):(this._body=e,this.setFileSize(this._fileSize??HQ(e))),this.log.trace("set request body with fileSize %o",this._fileSize)}getBody(e){let t=this._body;if(t==null)return this.log.trace("body is null"),t;if(!this.isRangeRequest||!this.isValidRangeRequest)return this.log.trace("returning body unmodified for non-range, or invalid range, request"),t;if(this.isMultiRangeRequest)return this._body instanceof ReadableStream?this._body:Bu(this.getMultipartBody(e));if(this.byteRanges.length>0){let n=this.byteRanges[0];return t instanceof ReadableStream?t:((n.start!=null||n.end!=null)&&this.log.trace("returning body with byteStart=%o, byteEnd=%o, byteSize=%o",n.start,n.end,n.size),this.getSlicedBody(t,n))}return this.log.error("returning unmodified body for valid range request"),t}getSlicedBody(e,t){let n=t.start??0,o;return t.end!=null&&t.start!=null?o=t.end-t.start+1:o=void 0,this.log.trace("slicing body with offset=%o and length=%o",n,o),typeof e=="string"||e instanceof Blob||e instanceof ArrayBuffer||e instanceof Uint8Array?e.slice(n,o!==void 0?n+o:void 0):e}setFileSize(e){this._fileSize=e!=null?Number(e):null,this._isValidRangeRequest=!1,this.log.trace("set _fileSize to %o",this._fileSize),this.setOffsetDetails()}getFileSize(){return this._fileSize}isValidByteStart(e,t){return!(e!=null&&(e<0||this._fileSize!=null&&e>=this._fileSize||t!=null&&e>t))}isValidByteEnd(e,t){if(t!=null){if(t<0)return this.log.trace("invalid range request, byteEnd is less than 0"),!1;if(this._fileSize!=null&&t>=this._fileSize)return this.log.trace("invalid range request, byteEnd is greater than fileSize"),!1;if(e!=null&&t<e)return this.log.trace("invalid range request, byteEnd is less than byteStart"),!1}return!0}isValidByteRange(e){return this.log.trace("validating byte range: %o",e),e.start!=null&&!this.isValidByteStart(e.start,e.end)?(this.log.trace("invalid range request, byteStart is less than 0 or greater than fileSize"),!1):e.end!=null&&!this.isValidByteEnd(e.start,e.end)?(this.log.trace("invalid range request, byteEnd is less than 0 or greater than fileSize"),!1):!0}get isValidRangeRequest(){return this._isValidRangeRequest?!0:this.isRangeRequest?this.byteRanges.length===0?(this.log.trace("invalid range request, no valid ranges"),!1):this.byteRanges.every(t=>this.isValidByteRange(t))?(this._isValidRangeRequest=!0,!0):(this.log.trace("invalid range request, not all ranges are valid"),!1):!1}getLength(e){if(!this.isValidRangeRequest){this.log.error("cannot get length for invalid range request");return}if(!(this.isMultiRangeRequest&&e==null))return e??=this.byteRanges[0],this.log.trace("getting length for range: %o",e),e.end!=null&&e.start!=null?e.end-e.start+1:e.end!=null?e.end+1:e.size}setOffsetDetails(){if(this.requestRanges.length===0){this.log.trace("no request ranges defined");return}try{this.byteRanges=this.requestRanges.map(e=>{let{start:t,end:n,byteSize:o}=EB(e.start??void 0,e.end??void 0,this._fileSize??void 0);return{start:t,end:n,size:o}}),this.log.trace("set byte ranges: %o",this.byteRanges)}catch(e){this.log.error("error setting offset details: %o",e),this.byteRanges=[]}}async convertToUint8Array(e){if(typeof e=="string")return new TextEncoder().encode(e);if("arrayBuffer"in e&&typeof e.arrayBuffer=="function"){let t=await e.arrayBuffer();return new Uint8Array(t)}if("byteLength"in e&&!("buffer"in e))return new Uint8Array(e);if("buffer"in e&&"byteLength"in e&&"byteOffset"in e)return e;throw new Error("Unsupported content type for multipart response")}async*getMultipartBody(e="application/octet-stream"){let t=this._body;if(t instanceof ReadableStream)return t;if(t===null)throw new Error("Cannot create multipart body from null");let n=new TextEncoder;for(let o of this.byteRanges){if(o.start===void 0||o.end===void 0)continue;let i=`\r
--${this.multiPartBoundary}\r
Content-Type: ${e}\r
Content-Range: ${E5({byteStart:o.start,byteEnd:o.end,byteSize:this._fileSize??void 0})}\r
\r
`;yield n.encode(i);let s=this.getSlicedBodyForRange(t,o.start,o.end);yield await this.convertToUint8Array(s)}yield n.encode(`\r
--${this.multiPartBoundary}--`)}getSlicedBodyForRange(e,t,n){let o=t,i=n-t+1;return this.log.trace("slicing body with offset=%o and length=%o",o,i),typeof e=="string"||e instanceof Blob||e instanceof ArrayBuffer||e instanceof Uint8Array?e.slice(o,o+i):e}getContentType(){if(this.isMultiRangeRequest&&this.isValidRangeRequest)return`multipart/byteranges; boundary=${this.multiPartBoundary}`}get contentRangeHeaderValue(){if(!this.isValidRangeRequest)throw this.log.error("cannot get contentRangeHeaderValue for invalid range request"),new Er("Invalid range request");if(this.isMultiRangeRequest)throw this.log.error("contentRangeHeaderValue should not be called for multipart responses"),new Er("Content-Range header not applicable for multipart responses");if(this.byteRanges.length>0){let e=this.byteRanges[0];return E5({byteStart:e.start,byteEnd:e.end,byteSize:this._fileSize??void 0})}throw new Er("No valid ranges found")}createRangeStream(e,t){let n=new TextEncoder,o=this.byteRanges,i=this.multiPartBoundary,s=this._fileSize,a=this.log,c=this.isMultiRangeRequest;if(o.length===0)throw a.error("Cannot create range stream with no byte ranges"),new Er("No valid ranges found");return new ReadableStream({async start(l){try{for(let u of o){if(c){let f=`\r
--${i}\r
Content-Type: ${t}\r
Content-Range: ${E5({byteStart:u.start,byteEnd:u.end,byteSize:s??void 0})}\r
\r
`;l.enqueue(n.encode(f))}try{let f=e(u);for await(let h of f)l.enqueue(h)}catch(f){throw a.error("Error processing range %o: %o",u,f),f}}c&&l.enqueue(n.encode(`\r
--${i}--`)),l.close()}catch(u){a.error("Error processing range(s): %o",u),l.error(u)}}})}};function OA(r,e,t){Object.defineProperty(r,e,{enumerable:!0,configurable:!1,set:()=>{},get:()=>t})}function ua(r,e){OA(r,"type",e)}function fa(r,e){OA(r,"url",e)}function _B(r){OA(r,"redirected",!0)}function VQ(r,e,t){let n=new Response(e,{...t??{},status:200,statusText:"OK"});return t?.redirected===!0&&_B(n),ua(n,"basic"),fa(n,r),n}function gh(r,e,t){let n=new Response(e,{...t??{},status:502,statusText:"Bad Gateway"});return ua(n,"basic"),fa(n,r),n}function C5(r,e,t){let n=new Response(e,{...t??{},status:501,statusText:"Not Implemented"});return n.headers.set("X-Content-Type-Options","nosniff"),ua(n,"basic"),fa(n,r),n}function da(r,e,t){let n=new Response(e,{...t??{},status:406,statusText:"Not Acceptable"});return ua(n,"basic"),fa(n,r),n}function I5(r,e,t){let n=new Response(e,{...t??{},status:404,statusText:"Not Found"});return ua(n,"basic"),fa(n,r),n}function KQ(r){return Array.isArray(r)&&r.every(e=>e instanceof Error)}function Q1(r,e,t){let n,o;KQ(e)?(n=e[e.length-1].stack,o=e.map(a=>({message:a.message,stack:a.stack??""}))):e instanceof Error&&(n=e.stack,o=[{message:e.message,stack:e.stack??""}]);let i=JSON.stringify({stack:n,errors:o}),s=new Response(i,{status:400,statusText:"Bad Request",...t??{},headers:{...t?.headers??{},"Content-Type":"application/json"}});return ua(s,"basic"),fa(s,r),s}function Z1(r,e,t){let n=new Response(null,{...t??{},status:301,statusText:"Moved Permanently",headers:{...t?.headers??{},location:e}});return ua(n,"basic"),fa(n,r),n}function ln(r,e,{byteRangeContext:t,log:n},o){if(!t.isRangeRequest)return VQ(r,e,o);if(!t.isValidRangeRequest)return mh(r,e,o);let i;try{let s=new Headers(o?.headers),a=t.getContentType();a!=null?s.set("content-type",a):t.isMultiRangeRequest?s.set("content-type","multipart/byteranges"):s.set("content-range",t.contentRangeHeaderValue),i=new Response(e,{...o??{},status:206,statusText:"Partial Content",headers:s})}catch(s){return n?.error("failed to create range response",s),mh(r,e,o)}return o?.redirected===!0&&_B(i),ua(i,"basic"),fa(i,r),i}function mh(r,e,t){let n=new Response(e,{...t??{},status:416,statusText:"Requested Range Not Satisfiable"});return ua(n,"basic"),fa(n,r),n}var Ct=class{codes=[];pluginOptions;_log;get log(){return this._log==null&&(this._log=this.pluginOptions.logger.forComponent(this.id)),this._log}constructor(e){this.pluginOptions=e}};var T5=class extends Ct{id="byte-range-context-plugin";canHandle(e){return e.byteRangeContext==null}async handle(e){return e.byteRangeContext=new _5(this.pluginOptions.logger,e.options?.headers),e.modified++,e.byteRangeContext.isRangeRequest&&!e.byteRangeContext.isValidRangeRequest?mh(e.resource):null}};var MA=st(k5(),1);var UA=40;function FA(r,e){if(!r.length)throw new Error("Unexpected end of data");let t=MA.default.decode(r);return e.seek(MA.default.decode.bytes),t}function HA(r){let e=new DataView(r.buffer,r.byteOffset,r.byteLength),t=0;return{version:2,characteristics:[e.getBigUint64(t,!0),e.getBigUint64(t+=8,!0)],dataOffset:Number(e.getBigUint64(t+=8,!0)),dataSize:Number(e.getBigUint64(t+=8,!0)),indexOffset:Number(e.getBigUint64(t+=8,!0))}}var vc={Null:r=>r===null?r:void 0,Int:r=>Number.isInteger(r)?r:void 0,Float:r=>typeof r=="number"&&Number.isFinite(r)?r:void 0,String:r=>typeof r=="string"?r:void 0,Bool:r=>typeof r=="boolean"?r:void 0,Bytes:r=>r instanceof Uint8Array?r:void 0,Link:r=>r!==null&&typeof r=="object"&&r.asCID===r?r:void 0,List:r=>Array.isArray(r)?r:void 0,Map:r=>r!==null&&typeof r=="object"&&r.asCID!==r&&!Array.isArray(r)&&!(r instanceof Uint8Array)?r:void 0},J1={"CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)":vc.Link,"CarV1HeaderOrV2Pragma > roots (anon)":r=>{if(vc.List(r)!==void 0){for(let e=0;e<r.length;e++){let t=r[e];if(t=J1["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](t),t===void 0)return;if(t!==r[e]){let n=r.slice(0,e);for(let o=e;o<r.length;o++){let i=r[o];if(i=J1["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](i),i===void 0)return;n.push(i)}return n}}return r}},Int:vc.Int,CarV1HeaderOrV2Pragma:r=>{if(vc.Map(r)===void 0)return;let e=Object.entries(r),t=r,n=1;for(let o=0;o<e.length;o++){let[i,s]=e[o];switch(i){case"roots":{let a=J1["CarV1HeaderOrV2Pragma > roots (anon)"](r[i]);if(a===void 0)return;if(a!==s||t!==r){if(t===r){t={};for(let c=0;c<o;c++)t[e[c][0]]=e[c][1]}t.roots=a}}break;case"version":{n--;let a=J1.Int(r[i]);if(a===void 0)return;if(a!==s||t!==r){if(t===r){t={};for(let c=0;c<o;c++)t[e[c][0]]=e[c][1]}t.version=a}}break;default:return}}if(!(n>0))return t}},e0={"CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)":vc.Link,"CarV1HeaderOrV2Pragma > roots (anon)":r=>{if(vc.List(r)!==void 0){for(let e=0;e<r.length;e++){let t=r[e];if(t=e0["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](t),t===void 0)return;if(t!==r[e]){let n=r.slice(0,e);for(let o=e;o<r.length;o++){let i=r[o];if(i=e0["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](i),i===void 0)return;n.push(i)}return n}}return r}},Int:vc.Int,CarV1HeaderOrV2Pragma:r=>{if(vc.Map(r)===void 0)return;let e=Object.entries(r),t=r,n=1;for(let o=0;o<e.length;o++){let[i,s]=e[o];switch(i){case"roots":{let a=e0["CarV1HeaderOrV2Pragma > roots (anon)"](s);if(a===void 0)return;if(a!==s||t!==r){if(t===r){t={};for(let c=0;c<o;c++)t[e[c][0]]=e[c][1]}t.roots=a}}break;case"version":{n--;let a=e0.Int(s);if(a===void 0)return;if(a!==s||t!==r){if(t===r){t={};for(let c=0;c<o;c++)t[e[c][0]]=e[c][1]}t.version=a}}break;default:return}}if(!(n>0))return t}},$A={toTyped:J1.CarV1HeaderOrV2Pragma,toRepresentation:e0.CarV1HeaderOrV2Pragma};var hYe=F7();var sZ=st(k5(),1);var wYe=[new W(I.map,2),new W(I.string,"version"),new W(I.uint,1),new W(I.string,"roots")],xYe=new W(I.tag,42);import PYe from"/node/fs.mjs";import{Readable as DYe}from"/node/stream.mjs";async function VA(r,e){let t=FA(await r.upTo(8),r);if(t===0)throw new Error("Invalid CAR header (zero length)");let n=await r.exactly(t,!0),o=ji(n);if($A.toTyped(o)===void 0)throw new Error("Invalid CAR header format");if(o.version!==1&&o.version!==2||e!==void 0&&o.version!==e)throw new Error(`Invalid CAR version: ${o.version}${e!==void 0?` (expected ${e})`:""}`);if(o.version===1){if(!Array.isArray(o.roots))throw new Error("Invalid CAR header format");return o}if(o.roots!==void 0)throw new Error("Invalid CAR header format");let i=HA(await r.exactly(UA,!0));r.seek(i.dataOffset-r.pos);let s=await VA(r,1);return Object.assign(s,i)}function t0(r){let e=0;return{async upTo(t){return r.subarray(e,e+Math.min(t,r.length-e))},async exactly(t,n=!1){if(t>r.length-e)throw new Error("Unexpected end of data");let o=r.subarray(e,e+t);return n&&(e+=t),o},seek(t){e+=t},get pos(){return e}}}var KA=st(k5(),1),MB=1;function zA(r){let e=Ff({version:MB,roots:r}),t=KA.default.encode(e.length),n=new Uint8Array(t.length+e.length);return n.set(t,0),n.set(e,t.length),n}function UB(r){return{async setRoots(e){let t=zA(e);await r.write(t)},async writeBlock(e){let{cid:t,bytes:n}=e;await r.write(new Uint8Array(KA.default.encode(t.bytes.length+n.length))),await r.write(t.bytes),n.length&&await r.write(n)},async close(){await r.end()},version(){return MB}}}function P5(){}function FB(){let r=[],e=null,t=P5,n=!1,o=null,i=P5,s=()=>(e||(e=new Promise(l=>{t=()=>{e=null,t=P5,l()}})),e),a={write(l){r.push(l);let u=s();return i(),u},async end(){n=!0;let l=s();i(),await l}},c={async next(){let l=r.shift();return l?(r.length===0&&t(),{done:!1,value:l}):n?(t(),{done:!0,value:void 0}):(o||(o=new Promise(u=>{i=()=>(o=null,i=P5,u(c.next()))})),o)}};return{writer:a,iterator:c}}var Mu=class r{constructor(e,t){this._encoder=t,this._mutex=t.setRoots(e),this._ended=!1}async put(e){if(!(e.bytes instanceof Uint8Array)||!e.cid)throw new TypeError("Can only write {cid, bytes} objects");if(this._ended)throw new Error("Already closed");let t=q.asCID(e.cid);if(!t)throw new TypeError("Can only write {cid, bytes} objects");return this._mutex=this._mutex.then(()=>this._encoder.writeBlock({cid:t,bytes:e.bytes})),this._mutex}async close(){if(this._ended)throw new Error("Already closed");return await this._mutex,this._ended=!0,this._encoder.close()}version(){return this._encoder.version()}static create(e){e=uZ(e);let{encoder:t,iterator:n}=HB(),o=new r(e,t),i=new R5(n);return{writer:o,out:i}}static createAppender(){let{encoder:e,iterator:t}=HB();e.setRoots=()=>Promise.resolve();let n=new r([],e),o=new R5(t);return{writer:n,out:o}}static async updateRootsInBytes(e,t){let n=t0(e);await VA(n);let o=zA(t);if(Number(n.pos)!==o.length)throw new Error(`updateRoots() can only overwrite a header of the same length (old header is ${n.pos} bytes, new header is ${o.length} bytes)`);return e.set(o,0),e}},R5=class{constructor(e){this._iterator=e}[Symbol.asyncIterator](){if(this._iterating)throw new Error("Multiple iterator not supported");return this._iterating=!0,this._iterator}};function HB(){let r=FB(),{writer:e,iterator:t}=r;return{encoder:UB(e),iterator:t}}function uZ(r){if(r===void 0)return[];if(!Array.isArray(r)){let t=q.asCID(r);if(!t)throw new TypeError("roots must be a single CID or an array of CIDs");return[t]}let e=[];for(let t of r){let n=q.asCID(t);if(!n)throw new TypeError("roots must be a single CID or an array of CIDs");e.push(n)}return e}var yh=class{async*export(e,t){for(let[,n]of t.links())yield n}};var D5=class{target;constructor(e){this.target=e}isTarget(e){return this.target.equals(e)}async*traverse(e,t){for(let[,n]of t.links())yield n}};var N5=class{components;log;constructor(e,t){this.components=e,this.log=e.logger.forComponent("helia:car")}async import(e,t){await Gr(this.components.blockstore.putMany(Ht(e.blocks(),({cid:n,bytes:o})=>({cid:n,block:o})),t))}async export(e,t,n){let o=ve(),i=Array.isArray(e)?e:[e],s={currentPath:[],pathsToTarget:null},a=n?.traversal,c=n?.exporter??new yh,l=new ii({concurrency:1}),u=!1;l.on("idle",()=>{if(u)o.resolve();else if(!u&&s.pathsToTarget?.length===i.length){this.log.trace("starting export of blocks to the car file"),u=!0;for(let f of s.pathsToTarget){let h=f.length-1,d=f[h];f.slice(0,-1).forEach(m=>{l.add(async()=>{await this.#t({cid:m,queue:l,writer:t,strategy:c,options:n,recursive:!1})}).catch(g=>{this.log.error("error during queue operation - %e",g)})}),l.add(async()=>{await this.#t({cid:d,queue:l,writer:t,strategy:c,options:n})}).catch(m=>{this.log.error("error during queue operation - %e",m)})}}else this.log.trace("no paths to target, skipping export"),o.reject(new Error("Could not traverse to target CID(s)"))}),l.on("error",f=>{l.clear(),o.reject(f)});for(let f of i)l.add(async()=>{this.log.trace("traversing dag from %c",f),await this.#e({cid:f,queue:l,strategy:a??new D5(f),traversalContext:s,parentPath:[],options:n})}).catch(h=>{this.log.error("error during queue operation - %e",h)});try{await o.promise}finally{await t.close()}}async*stream(e,t){let{writer:n,out:o}=Mu.create(e);this.export(e,n,t).catch(i=>{this.log.error("error during streaming export - %e",i)});for await(let i of o)yield i}async#e({cid:e,queue:t,strategy:n,traversalContext:o,parentPath:i,options:s}){let a=[...i,e];if(n.isTarget(e)){o.pathsToTarget=o.pathsToTarget??[],o.pathsToTarget.push([...a]),this.log.trace("found path to target %c",e);return}let c=await this.components.getCodec(e.code),l=await this.components.blockstore.get(e,s),u=Rp({bytes:l,cid:e,codec:c});for await(let f of n.traverse(e,u))t.add(async()=>{await this.#e({cid:f,queue:t,strategy:n,traversalContext:o,parentPath:a??[],options:s})}).catch(h=>{this.log.error("error during traversal queue operation - %e",h)})}async#t({cid:e,queue:t,writer:n,strategy:o,options:i,recursive:s=!0}){if(i?.blockFilter?.has(e.multihash.bytes)===!0)return;let a=await this.components.getCodec(e.code),c=await this.components.blockstore.get(e,i);if(i?.blockFilter?.add(e.multihash.bytes),await n.put({cid:e,bytes:c}),s){let l=Rp({bytes:c,cid:e,codec:a});for await(let u of o.export(e,l))t.add(async()=>{await this.#t({cid:u,queue:t,writer:n,strategy:o,options:i})}).catch(f=>{this.log.error("error during export queue operation - %e",f)})}}};var r0=class{async*export(e,t){}};var O5=class extends Error{static code="ERR_NOT_UNIXFS";static message="Not a UnixFS node";static name="NotUnixFSError";code="ERR_NOT_UNIXFS";message="Not a UnixFS node";name="NotUnixFSError"};var L5=class{async*export(e,t){if(e.code!==112&&e.code!==85)throw new O5("Target CID was not UnixFS - use the SubGraphExporter to export arbitrary graphs");for(let[,n]of t.links())yield n}};var B5=class{pathToTarget;target;constructor(e){this.pathToTarget=e,this.target=e[e.length-1]}isTarget(e){return this.target.equals(e)}async*traverse(e,t){let n=this.pathToTarget.indexOf(e);yield this.pathToTarget[n+1]}};var n0=class r extends Error{static name="InvalidTypeError";static code="ERR_INVALID_TYPE";name=r.name;code=r.code;constructor(e="Invalid type"){super(e)}},M5=class r extends Error{static name="InvalidUnixFSMessageError";static code="ERR_INVALID_MESSAGE";name=r.name;code=r.code;constructor(e="Invalid message"){super(e)}};var Ii;(function(r){let e;(function(o){o.Raw="Raw",o.Directory="Directory",o.File="File",o.Metadata="Metadata",o.Symlink="Symlink",o.HAMTShard="HAMTShard"})(e=r.DataType||(r.DataType={}));let t;(function(o){o[o.Raw=0]="Raw",o[o.Directory=1]="Directory",o[o.File=2]="File",o[o.Metadata=3]="Metadata",o[o.Symlink=4]="Symlink",o[o.HAMTShard=5]="HAMTShard"})(t||(t={})),function(o){o.codec=()=>wt(t)}(e=r.DataType||(r.DataType={}));let n;r.codec=()=>(n==null&&(n=be((o,i,s={})=>{if(s.lengthDelimited!==!1&&i.fork(),o.Type!=null&&(i.uint32(8),r.DataType.codec().encode(o.Type,i)),o.Data!=null&&(i.uint32(18),i.bytes(o.Data)),o.filesize!=null&&(i.uint32(24),i.uint64(o.filesize)),o.blocksizes!=null)for(let a of o.blocksizes)i.uint32(32),i.uint64(a);o.hashType!=null&&(i.uint32(40),i.uint64(o.hashType)),o.fanout!=null&&(i.uint32(48),i.uint64(o.fanout)),o.mode!=null&&(i.uint32(56),i.uint32(o.mode)),o.mtime!=null&&(i.uint32(66),U5.codec().encode(o.mtime,i)),s.lengthDelimited!==!1&&i.ldelim()},(o,i)=>{let s={blocksizes:[]},a=i==null?o.len:o.pos+i;for(;o.pos<a;){let c=o.uint32();switch(c>>>3){case 1:s.Type=r.DataType.codec().decode(o);break;case 2:s.Data=o.bytes();break;case 3:s.filesize=o.uint64();break;case 4:s.blocksizes.push(o.uint64());break;case 5:s.hashType=o.uint64();break;case 6:s.fanout=o.uint64();break;case 7:s.mode=o.uint32();break;case 8:s.mtime=U5.codec().decode(o,o.uint32());break;default:o.skipType(c&7);break}}return s})),n),r.encode=o=>xe(o,r.codec()),r.decode=o=>we(o,r.codec())})(Ii||(Ii={}));var U5;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.Seconds!=null&&(n.uint32(8),n.int64(t.Seconds)),t.FractionalNanoseconds!=null&&(n.uint32(21),n.fixed32(t.FractionalNanoseconds)),o.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let o={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let s=t.uint32();switch(s>>>3){case 1:o.Seconds=t.int64();break;case 2:o.FractionalNanoseconds=t.fixed32();break;default:t.skipType(s&7);break}}return o})),e),r.encode=t=>xe(t,r.codec()),r.decode=t=>we(t,r.codec())})(U5||(U5={}));var $B;(function(r){let e;r.codec=()=>(e==null&&(e=be((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.MimeType!=null&&(n.uint32(10),n.string(t.MimeType)),o.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let o={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let s=t.uint32();switch(s>>>3){case 1:o.MimeType=t.string();break;default:t.skipType(s&7);break}}return o})),e),r.encode=t=>xe(t,r.codec()),r.decode=t=>we(t,r.codec())})($B||($B={}));var VB={Raw:"raw",Directory:"directory",File:"file",Metadata:"metadata",Symlink:"symlink",HAMTShard:"hamt-sharded-directory"},fZ=["directory","hamt-sharded-directory"],KB=parseInt("0644",8),zB=parseInt("0755",8),qB=BigInt(1024),_e=class r{static unmarshal(e){let t=Ii.decode(e);if(t.fanout!=null&&t.fanout>qB)throw new M5(`Fanout size was too large - ${t.fanout} > ${qB}`);let n=new r({type:VB[t.Type!=null?t.Type.toString():"File"],data:t.Data,blockSizes:t.blocksizes,mode:t.mode,mtime:t.mtime!=null?{secs:t.mtime.Seconds??0n,nsecs:t.mtime.FractionalNanoseconds}:void 0,fanout:t.fanout});return n._originalMode=t.mode??0,n}type;data;blockSizes;hashType;fanout;mtime;_mode;_originalMode;constructor(e={type:"file"}){let{type:t,data:n,blockSizes:o,hashType:i,fanout:s,mtime:a,mode:c}=e;if(t!=null&&!Object.values(VB).includes(t))throw new n0("Type: "+t+" is not valid");this.type=t??"file",this.data=n,this.hashType=i,this.fanout=s,this.blockSizes=o??[],this._originalMode=0,this.mode=c,this.mtime=a}set mode(e){e==null?this._mode=this.isDirectory()?zB:KB:this._mode=e&4095}get mode(){return this._mode}isDirectory(){return fZ.includes(this.type)}addBlockSize(e){this.blockSizes.push(e)}removeBlockSize(e){this.blockSizes.splice(e,1)}fileSize(){if(this.isDirectory())return 0n;let e=0n;return this.blockSizes.forEach(t=>{e+=t}),this.data!=null&&(e+=BigInt(this.data.length)),e}marshal(){let e;switch(this.type){case"raw":e=Ii.DataType.Raw;break;case"directory":e=Ii.DataType.Directory;break;case"file":e=Ii.DataType.File;break;case"metadata":e=Ii.DataType.Metadata;break;case"symlink":e=Ii.DataType.Symlink;break;case"hamt-sharded-directory":e=Ii.DataType.HAMTShard;break;default:throw new n0(`Type: ${e} is not valid`)}let t=this.data;(this.data==null||this.data.length===0)&&(t=void 0);let n;this.mode!=null&&(n=this._originalMode&4294963200|(this.mode??0),n===KB&&!this.isDirectory()&&(n=void 0),n===zB&&this.isDirectory()&&(n=void 0));let o;return this.mtime!=null&&(o={Seconds:this.mtime.secs,FractionalNanoseconds:this.mtime.nsecs}),Ii.encode({Type:e,Data:t,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:n,mtime:o})}};function jB(r,e={}){return new N5(r,e)}function dZ({cid:r,ipfsPath:e,query:t}){return t.filename!=null?t.filename:`${e.replace(/\/ipfs\//,"").replace(/\/ipns\//,"").replace(/\//g,"_")}.car`}function hZ({query:r}){let e=r["dag-scope"];return e==="all"||e==="entity"||e==="block"?e:"all"}var F5=class extends Ct{id="car-plugin";canHandle(e){return this.log("checking if we can handle %c with accept %s",e.cid,e.accept),e.byteRangeContext==null||e.pathDetails==null?!1:e.accept?.startsWith("application/vnd.ipld.car")===!0||e.query.format==="car"}async handle(e){let{options:t,pathDetails:n,cid:o}=e;if(n==null)throw new Error("attempted to handle request for car with no path details");let{getBlockstore:i,helia:s}=this.pluginOptions;e.reqFormat="car",e.query.download=!0,e.query.filename=dZ(e);let a=i(o,e.resource,t?.session??!0,t),c=jB({blockstore:a,getCodec:s.getCodec,logger:s.logger}),l=n.ipfsRoots.filter(x=>!x.equals(o)),u={...t};l.length>0&&(u.traversal=new B5(l));let f=hZ(e),h=n.terminalElement.cid??o;f==="block"?u.exporter=new r0:f==="entity"?h.code===Qe?u.exporter=new L5:u.exporter=new r0:u.exporter=new yh;let{writer:d,out:m}=Mu.create(h),g=async function*(){for await(let x of m)yield x};c.export(o,d,u).catch(x=>{this.log.error("error exporting car - %e",x)}),e.byteRangeContext.setBody(Bu(g()));let w=ln(e.resource,e.byteRangeContext.getBody("application/vnd.ipld.car; version=1"),{byteRangeContext:e.byteRangeContext,log:this.log});return w.headers.set("content-type",e.byteRangeContext.getContentType()??"application/vnd.ipld.car; version=1"),w}};function WB(r){let e=xn(r,{allowIndefinite:!1,coerceUndefinedToNull:!1,allowNaN:!1,allowInfinity:!1,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,allowBigInt:!1});return new TextDecoder().decode(Lp(e))}var Ti=class extends Error{name;code;constructor(e,t,n){super(e),this.name=t,this.code=n}},yo=class extends Ti{constructor(e="not a Unixfs node"){super(e,"NotUnixFSError","ERR_NOT_UNIXFS")}},jn=class extends Ti{constructor(e="invalid PBNode"){super(e,"InvalidPBNodeError","ERR_INVALID_PB_NODE")}},Ac=class extends Ti{constructor(e="unknown error"){super(e,"InvalidPBNodeError","ERR_UNKNOWN_ERROR")}},o0=class extends Ti{constructor(e="path already exists"){super(e,"AlreadyExistsError","ERR_ALREADY_EXISTS")}},wh=class extends Ti{constructor(e="path does not exist"){super(e,"DoesNotExistError","ERR_DOES_NOT_EXIST")}},xh=class extends Ti{constructor(e="no content"){super(e,"NoContentError","ERR_NO_CONTENT")}},H5=class extends Ti{constructor(e="not a file"){super(e,"NotAFileError","ERR_NOT_A_FILE")}},Ec=class extends Ti{constructor(e="not a directory"){super(e,"NotADirectoryError","ERR_NOT_A_DIRECTORY")}},wr=class extends Ti{constructor(e="invalid parameters"){super(e,"InvalidParametersError","ERR_INVALID_PARAMETERS")}};function pZ(r){return r[Symbol.asyncIterator]!=null}function mZ(r){if(pZ(r))return(async()=>{let t;for await(let n of r)t=n;return t})();let e;for(let t of r)e=t;return e}var ki=mZ;var $5=class r extends Error{static name="BadPathError";static code="ERR_BAD_PATH";name=r.name;code=r.code;constructor(e="Bad path"){super(e)}},Wo=class r extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=r.name;code=r.code;constructor(e="Not found"){super(e)}},V5=class r extends Error{static name="NoResolverError";static code="ERR_NO_RESOLVER";name=r.name;code=r.code;constructor(e="No resolver"){super(e)}},xr=class r extends Error{static name="NotUnixFSError";static code="ERR_NOT_UNIXFS";name=r.name;code=r.code;constructor(e="Not UnixFS"){super(e)}},K5=class r extends Error{static name="OverReadError";static code="ERR_OVER_READ";name=r.name;code=r.code;constructor(e="Over read"){super(e)}},z5=class r extends Error{static name="UnderReadError";static code="ERR_UNDER_READ";name=r.name;code=r.code;constructor(e="Under read"){super(e)}},q5=class r extends Error{static name="NoPropError";static code="ERR_NO_PROP";name=r.name;code=r.code;constructor(e="No Property found"){super(e)}},Uu=class r extends Error{static name="InvalidParametersError";static code="ERR_INVALID_PARAMS";name=r.name;code=r.code;constructor(e="Invalid parameters"){super(e)}};function bh(r,e,t,n,o,i,s){let a=r,c=o;for(;i.length>0;){let l=i[0];if(l in a){i.shift(),c=`${c}/${l}`;let u=q.asCID(a[l]);if(u!=null)return{entry:{type:"object",name:n,path:o,cid:t,node:e,depth:s,size:BigInt(e.length),content:async function*(){yield r}},next:{cid:u,name:l,path:c,toResolve:i}};a=a[l]}else throw new q5(`No property named ${l} found in node ${t}`)}return{entry:{type:"object",name:n,path:o,cid:t,node:e,depth:s,size:BigInt(e.length),content:async function*(){yield r}}}}var gZ=async(r,e,t,n,o,i,s,a)=>{let c=await s.get(r,a),l=ji(c);return bh(l,c,r,e,t,n,i)},GB=gZ;var yZ=async(r,e,t,n,o,i,s,a)=>{let c=await s.get(r,a),l=$f(c);return bh(l,c,r,e,t,n,i)},XB=yZ;function wZ(r,e,t,n){let o=BigInt(r.length),i=BigInt(e+o);return t>=i||n<e?new Uint8Array(0):(n>=e&&n<i&&(r=r.subarray(0,Number(n-e))),t>=e&&t<i&&(r=r.subarray(Number(t-e))),r)}var Fu=wZ;var xZ=(r,e=0,t=r)=>{let n=BigInt(r),o=BigInt(e??0),i=BigInt(t);if(i!==n&&(i=o+i),i>n&&(i=n),o<0n)throw new Uu("Offset must be greater than or equal to 0");if(o>n)throw new Uu("Offset must be less than the file size");if(i<0n)throw new Uu("Length must be greater than or equal to 0");if(i>n)throw new Uu("Length must be less than the file size");return{start:o,end:i}},vh=xZ;var bZ=r=>{async function*e(t={}){let{start:n,end:o}=vh(r.length,t.offset,t.length),i=Fu(r,0n,n,o);t.onProgress?.(new j("unixfs:exporter:progress:identity",{bytesRead:BigInt(i.byteLength),totalBytes:o-n,fileSize:BigInt(r.byteLength)})),yield i}return e},vZ=async(r,e,t,n,o,i,s,a)=>{if(n.length>0)throw new Wo(`No link named ${t} found in raw node ${r}`);let c=ze(r.multihash.bytes);return{entry:{type:"identity",name:e,path:t,cid:r,content:bZ(c.digest),depth:i,size:BigInt(c.digest.length),node:c.digest}}},YB=vZ;var AZ=async(r,e,t,n,o,i,s,a)=>{let c=await s.get(r,a),l=ww(c);return bh(l,c,r,e,t,n,i)},QB=AZ;var EZ=r=>{async function*e(t={}){let{start:n,end:o}=vh(r.length,t.offset,t.length),i=Fu(r,0n,n,o);t.onProgress?.(new j("unixfs:exporter:progress:raw",{bytesRead:BigInt(i.byteLength),totalBytes:o-n,fileSize:BigInt(r.byteLength)})),yield i}return e},SZ=async(r,e,t,n,o,i,s,a)=>{if(n.length>0)throw new Wo(`No link named ${t} found in raw node ${r}`);let c=await s.get(r,a);return{entry:{type:"raw",name:e,path:t,cid:r,content:EZ(c),depth:i,size:BigInt(c.length),node:c}}},ZB=SZ;var W5=st(tM(),1);function _Z(r){let e=new Array(4);for(let t=0;t<4;t++)e[t]=r&255,r=r>>8;return new Uint8Array(e)}var wZe=Fc({name:"murmur3-32",code:35,encode:r=>_Z(W5.default.x86.hash32(r))}),Hu=Fc({name:"murmur3-128",code:34,encode:r=>Mc.fromHex(W5.default.x64.hash128(r))}),xZe=Fc({name:"murmur3-x64-64",code:34,encode:r=>Mc.fromHex(W5.default.x64.hash128(r)).subarray(0,8)});var oM=st(G5(),1);var wo=class r{_options;_popCount;_parent;_posAtParent;_children;key;constructor(e,t,n=0){this._options=e,this._popCount=0,this._parent=t,this._posAtParent=n,this._children=new oM.default,this.key=null}async put(e,t){let n=await this._findNewBucketAndPos(e);n.bucket._putAt(n,e,t)}async get(e){let t=await this._findChild(e);if(t!=null)return t.value}async del(e){let t=await this._findPlace(e),n=t.bucket._at(t.pos);n!=null&&n.key===e&&t.bucket._delAt(t.pos)}leafCount(){return this._children.compactArray().reduce((t,n)=>n instanceof r?t+n.leafCount():t+1,0)}childrenCount(){return this._children.length}onlyChild(){return this._children.get(0)}*eachLeafSeries(){let e=this._children.compactArray();for(let t of e)t instanceof r?yield*t.eachLeafSeries():yield t}serialize(e,t){let n=[];return t(this._children.reduce((o,i,s)=>(i!=null&&(i instanceof r?o.push(i.serialize(e,t)):o.push(e(i,s))),o),n))}async asyncTransform(e,t){return iM(this,e,t)}toJSON(){return this.serialize(PZ,RZ)}prettyPrint(){return JSON.stringify(this.toJSON(),null,"  ")}tableSize(){return Math.pow(2,this._options.bits)}async _findChild(e){let t=await this._findPlace(e),n=t.bucket._at(t.pos);if(!(n instanceof r)&&n!=null&&n.key===e)return n}async _findPlace(e){let t=this._options.hash(typeof e=="string"?L(e):e),n=await t.take(this._options.bits),o=this._children.get(n);return o instanceof r?o._findPlace(t):{bucket:this,pos:n,hash:t,existingChild:o}}async _findNewBucketAndPos(e){let t=await this._findPlace(e);if(t.existingChild!=null&&t.existingChild.key!==e){let n=new r(this._options,t.bucket,t.pos);t.bucket._putObjectAt(t.pos,n);let o=await n._findPlace(t.existingChild.hash);return o.bucket._putAt(o,t.existingChild.key,t.existingChild.value),n._findNewBucketAndPos(t.hash)}return t}_putAt(e,t,n){this._putObjectAt(e.pos,{key:t,value:n,hash:e.hash})}_putObjectAt(e,t){this._children.get(e)==null&&this._popCount++,this._children.set(e,t)}_delAt(e){if(e===-1)throw new Error("Invalid position");this._children.get(e)!=null&&this._popCount--,this._children.unset(e),this._level()}_level(){if(this._parent!=null&&this._popCount<=1)if(this._popCount===1){let e=this._children.find(kZ);if(e!=null&&!(e instanceof r)){let t=e.hash;t.untake(this._options.bits);let n={pos:this._posAtParent,hash:t,bucket:this._parent};this._parent._putAt(n,e.key,e.value)}}else this._parent._delAt(this._posAtParent)}_at(e){return this._children.get(e)}};function kZ(r){return!!r}function PZ(r,e){return r.key}function RZ(r){return r}async function iM(r,e,t){let n=[];for(let o of r._children.compactArray())if(o instanceof wo)await iM(o,e,t);else{let i=await e(o);n.push({bitField:r._children.bitField(),children:i})}return t(n)}var DZ=[255,254,252,248,240,224,192,128],NZ=[1,3,7,15,31,63,127,255],X5=class{_value;_currentBytePos;_currentBitPos;constructor(e){this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+this._currentBytePos*8}totalBits(){return this._value.length*8}take(e){let t=e,n=0;for(;t>0&&this._haveBits();){let o=this._value[this._currentBytePos],i=this._currentBitPos+1,s=Math.min(i,t),a=OZ(o,i-s,s);n=(n<<s)+a,t-=s,this._currentBitPos-=s,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return n}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}};function OZ(r,e,t){let n=LZ(e,t);return(r&n)>>>e}function LZ(r,e){return DZ[r]&NZ[Math.min(e+r-1,7)]}function sM(r){function e(t){return t instanceof Y5?t:new Y5(t,r)}return e}var Y5=class{_value;_hashFn;_depth;_availableBits;_currentBufferIndex;_buffers;constructor(e,t){if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let n=0;for(;t>0;){let o=this._buffers[this._currentBufferIndex],i=Math.min(o.availableBits(),t),s=o.take(i);n=(n<<i)+s,t-=i,this._availableBits-=i,o.availableBits()===0&&this._currentBufferIndex++}return n}untake(e){let t=e;for(;t>0;){let n=this._buffers[this._currentBufferIndex],o=Math.min(n.totalBits()-n.availableBits(),t);n.untake(o),t-=o,this._availableBits+=o,this._currentBufferIndex>0&&n.totalBits()===n.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;let e=this._depth>0?je([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),n=new X5(t);this._buffers.push(n),this._availableBits+=n.availableBits()}};function Ah(r){if(r==null||r.hashFn==null)throw new Error("please define an options.hashFn");let e={bits:r.bits??8,hash:sM(r.hashFn)};return new wo(e)}var BZ=async function(r){return(await Hu.encode(r)).slice(0,8).reverse()},MZ=async(r,e,t)=>{let n=(e.tableSize()-1).toString(16).length;await Promise.all(r.map(async o=>{if(o.Name==null)throw new Error("Unexpected Link without a Name");if(o.Name.length===n){let i=parseInt(o.Name,16);e._putObjectAt(i,new wo({hash:t._options.hash,bits:t._options.bits},e,i));return}await t.put(o.Name.substring(2),!0)}))},aM=(r,e)=>r.toString(16).toUpperCase().padStart(e,"0").substring(0,e),UZ=r=>{let e=r.bucket,t=[];for(;e._parent!=null;)t.push(e),e=e._parent;return t.push(e),t.reverse()},cM=async(r,e,t,n,o)=>{if(n==null){if(r.Data==null)throw new xr("no data in PBNode");let f;try{f=_e.unmarshal(r.Data)}catch(d){throw new xr(d.message)}if(f.type!=="hamt-sharded-directory")throw new xr("not a HAMT");if(f.fanout==null)throw new xr("missing fanout");let h=Ah({hashFn:BZ,bits:Math.log2(Number(f.fanout))});n={rootBucket:h,hamtDepth:1,lastBucket:h}}let i=(n.lastBucket.tableSize()-1).toString(16).length;await MZ(r.Links,n.lastBucket,n.rootBucket);let s=await n.rootBucket._findNewBucketAndPos(e),a=aM(s.pos,i),c=UZ(s);c.length>n.hamtDepth&&(n.lastBucket=c[n.hamtDepth],a=aM(n.lastBucket._posAtParent,i));let l=r.Links.find(f=>{if(f.Name==null)return!1;let h=f.Name.substring(0,i),d=f.Name.substring(i);return!(h!==a||d!==""&&d!==e)});if(l==null)return;if(l.Name!=null&&l.Name.substring(i)===e)return l.Hash;n.hamtDepth++;let u=await t.get(l.Hash,o);return r=Zt(u),cM(r,e,t,n,o)},lM=cM;var FZ=(r,e,t,n,o,i,s)=>{async function*a(c={}){let l=c.offset??0,u=c.length??e.Links.length,f=e.Links.slice(l,u);c.onProgress?.(new j("unixfs:exporter:walk:directory",{cid:r})),yield*pt(f,h=>Ht(h,d=>async()=>{let m=d.Name??"",g=`${n}/${m}`;return(await o(d.Hash,m,g,[],i+1,s,c)).entry}),h=>En(h,{ordered:!0,concurrency:c.blockReadConcurrency}),h=>ao(h,d=>d!=null))}return a},uM=FZ;async function fM(r,e,t,n,o,i,s){if(e instanceof Uint8Array){let l=Fu(e,n,o,i);t.push(l);return}if(e.Data==null)throw new xr("no data in PBNode");let a;try{a=_e.unmarshal(e.Data)}catch(l){throw new xr(l.message)}if(a.data!=null){let l=a.data,u=Fu(l,n,o,i);t.push(u),n+=BigInt(u.byteLength)}let c=[];if(e.Links.length!==a.blockSizes.length)throw new xr("Inconsistent block sizes and dag links");for(let l=0;l<e.Links.length;l++){let u=e.Links[l],f=n,h=f+a.blockSizes[l];if((o>=f&&o<h||i>=f&&i<=h||o<f&&i>h)&&c.push({link:u,blockStart:n}),n=h,n>i)break}await pt(c,l=>Ht(l,u=>async()=>{let f=await r.get(u.link.Hash,s);return{...u,block:f}}),l=>En(l,{ordered:!0,concurrency:s.blockReadConcurrency}),async l=>{for await(let{link:u,block:f,blockStart:h}of l){let d;switch(u.Hash.code){case Qe:d=Zt(f);break;case mt:d=f;break;default:t.end(new xr(`Unsupported codec: ${u.Hash.code}`));return}let m=new ii({concurrency:1});m.on("error",g=>{t.end(g)}),m.add(async()=>{s.onProgress?.(new j("unixfs:exporter:walk:file",{cid:u.Hash})),await fM(r,d,t,h,o,i,s)}),await m.onIdle()}}),n>=i&&t.end()}var HZ=(r,e,t,n,o,i,s)=>{async function*a(c={}){let l=t.fileSize();if(l===void 0)throw new Error("File was a directory");let{start:u,end:f}=vh(l,c.offset,c.length);if(f===0n)return;let h=0n,d=f-u,m=nr();c.onProgress?.(new j("unixfs:exporter:walk:file",{cid:r})),fM(s,e,m,0n,u,f,c).catch(g=>{m.end(g)});for await(let g of m)if(g!=null){if(h+=BigInt(g.byteLength),h>d)throw m.end(),new K5("Read too many bytes - the file size reported by the UnixFS data in the root node may be incorrect");h===d&&m.end(),c.onProgress?.(new j("unixfs:exporter:progress:unixfs:file",{bytesRead:h,totalBytes:d,fileSize:l})),yield g}if(h<d)throw new z5("Traversed entire DAG but did not read enough bytes")}return a},qA=HZ;var $Z=(r,e,t,n,o,i,s)=>{function a(c={}){return c.onProgress?.(new j("unixfs:exporter:walk:hamt-sharded-directory",{cid:r})),dM(e,n,o,i,s,c)}return a};async function*dM(r,e,t,n,o,i){let s=r.Links;if(r.Data==null)throw new xr("no data in PBNode");let a;try{a=_e.unmarshal(r.Data)}catch(u){throw new xr(u.message)}if(a.fanout==null)throw new xr("missing fanout");let c=(a.fanout-1n).toString(16).length,l=pt(s,u=>Ht(u,f=>async()=>{let h=f.Name!=null?f.Name.substring(c):null;if(h!=null&&h!==""){let d=await t(f.Hash,h,`${e}/${h}`,[],n+1,o,i);return{entries:d.entry==null?[]:[d.entry]}}else{let d=await o.get(f.Hash,i);return r=Zt(d),i.onProgress?.(new j("unixfs:exporter:walk:hamt-sharded-directory",{cid:f.Hash})),{entries:dM(r,e,t,n,o,i)}}}),u=>En(u,{ordered:!0,concurrency:i.blockReadConcurrency}));for await(let{entries:u}of l)yield*u}var hM=$Z;var VZ=(r,e)=>r.Links.find(n=>n.Name===e)?.Hash,KZ={raw:qA,file:qA,directory:uM,"hamt-sharded-directory":hM,metadata:(r,e,t,n,o,i,s)=>()=>[],symlink:(r,e,t,n,o,i,s)=>()=>[]},zZ=async(r,e,t,n,o,i,s,a)=>{let c=await s.get(r,a),l=Zt(c),u,f;if(e==null&&(e=r.toString()),l.Data==null)throw new xr("no data in PBNode");try{u=_e.unmarshal(l.Data)}catch(d){throw new xr(d.message)}if(t==null&&(t=e),n.length>0){let d;if(u?.type==="hamt-sharded-directory"?d=await lM(l,n[0],s):d=VZ(l,n[0]),d==null)throw new Wo("file does not exist");let m=n.shift(),g=`${t}/${m}`;f={cid:d,toResolve:n,name:m??"",path:g}}let h=KZ[u.type](r,l,u,t,o,i,s);if(h==null)throw new Wo("could not find content exporter");return u.isDirectory()?{entry:{type:"directory",name:e,path:t,cid:r,content:h,unixfs:u,depth:i,node:l,size:u.fileSize()},next:f}:{entry:{type:"file",name:e,path:t,cid:r,content:h,unixfs:u,depth:i,node:l,size:u.fileSize()},next:f}},pM=zZ;var qZ={[Qe]:pM,[mt]:ZB,[Pr]:GB,[ui]:XB,[ir.code]:YB,[Bi]:QB},mM=async(r,e,t,n,o,i,s)=>{let a=qZ[r.code];if(a==null)throw new V5(`No resolver for code ${r.code}`);return a(r,e,t,n,mM,o,i,s)},gM=mM;var jZ=(r="")=>(r.trim().match(/([^\\^/]|\\\/)+/g)??[]).filter(Boolean),WZ=r=>{if(r instanceof Uint8Array)return{cid:q.decode(r),toResolve:[]};let e=q.asCID(r);if(e!=null)return{cid:e,toResolve:[]};if(typeof r=="string"){r.indexOf("/ipfs/")===0&&(r=r.substring(6));let t=jZ(r);return{cid:q.parse(t[0]),toResolve:t.slice(1)}}throw new $5(`Unknown path type ${r}`)};async function*s0(r,e,t={}){let{cid:n,toResolve:o}=WZ(r),i=n.toString(),s=i,a=o.length;for(;;){let c=await gM(n,i,s,o,a,e,t);if(c.entry==null&&c.next==null)throw new Wo(`Could not resolve ${r}`);if(c.entry!=null&&(yield c.entry),c.next==null)return;o=c.next.toResolve,n=c.next.cid,i=c.next.name,s=c.next.path}}async function hr(r,e,t={}){let n=await ki(s0(r,e,t));if(n==null)throw new Wo(`Could not resolve ${r}`);return n}async function*Eh(r,e,t={}){let n=await hr(r,e,t);if(n==null)return;if(yield n,n.type==="directory")for await(let i of o(n,t))yield i;async function*o(i,s){for await(let a of i.content(s))yield a,!(a instanceof Uint8Array)&&a.type==="directory"&&(yield*o(a,s))}}async function GZ(r,e,t){let n=[],o;for await(let i of s0(e,r,t))n.push(i.cid),o=i;if(o==null)throw new wh("No terminal element found");return{ipfsRoots:n,terminalElement:o}}function Sh(r){return r.type==="object"}async function yM({cid:r,path:e,resource:t,options:n,blockstore:o,log:i}){try{return await GZ(o,`${r.toString()}/${e}`,n)}catch(s){if(n?.signal?.aborted)throw new Xe(n?.signal?.reason);return["ERR_NO_PROP","ERR_NO_TERMINAL_ELEMENT","ERR_NOT_FOUND"].includes(s.code)?I5(t):(i.error("error walking path %s",e,s),gh(t,"Error walking path"))}}var Q5=class extends Ct{id="dag-cbor-plugin";codes=[Pr];canHandle({cid:e,accept:t,pathDetails:n,byteRangeContext:o,plugins:i}){return this.log("checking if we can handle %c with accept %s",e,t),n==null||!Sh(n.terminalElement)||e.code!==Pr||o==null||t!=null&&t.includes("text/html")&&i.includes("dag-cbor-plugin-html-preview")?!1:Sh(n.terminalElement)}async handle(e){let{cid:t,path:n,resource:o,accept:i,pathDetails:{terminalElement:s,ipfsRoots:a}}=e;this.log.trace("fetching %c/%s",t,n);let c=s.node,l;if(i==="application/octet-stream"||i==="application/vnd.ipld.dag-cbor"||i==="application/cbor")l=c;else if(i==="application/vnd.ipld.dag-json")try{let h=ji(c);l=w2(h)}catch(h){return this.log.error("could not transform %c to application/vnd.ipld.dag-json",h),da(o)}else try{l=WB(c)}catch(h){if(i==="application/json")return this.log('could not decode DAG-CBOR as JSON-safe, but the client sent "Accept: application/json"',h),da(o);this.log("could not decode DAG-CBOR as JSON-safe, falling back to `application/octet-stream`",h),l=c}e.byteRangeContext.setBody(l);let u=i??(l instanceof Uint8Array?"application/octet-stream":"application/json"),f=ln(o,e.byteRangeContext.getBody(u),{byteRangeContext:e.byteRangeContext,log:this.log});return f.headers.set("content-type",e.byteRangeContext.getContentType()??u),this.log.trace('setting content type to "%s"',e.byteRangeContext.getContentType()??u),S5(f,a),f}};function XZ(r){return r[Symbol.asyncIterator]!=null}function YZ(r,e=1){return e=Number(e),XZ(r)?async function*(){let t=[];if(e<1&&(e=1),e!==Math.round(e))throw new Error("Batch size must be an integer");for await(let n of r)for(t.push(n);t.length>=e;)yield t.slice(0,e),t=t.slice(e);for(;t.length>0;)yield t.slice(0,e),t=t.slice(e)}():function*(){let t=[];if(e<1&&(e=1),e!==Math.round(e))throw new Error("Batch size must be an integer");for(let n of r)for(t.push(n);t.length>=e;)yield t.slice(0,e),t=t.slice(e);for(;t.length>0;)yield t.slice(0,e),t=t.slice(e)}()}var Z5=YZ;async function*a0(r,e=1){for await(let t of Z5(r,e)){let n=t.map(async o=>o().then(i=>({ok:!0,value:i}),i=>({ok:!1,err:i})));for(let o=0;o<n.length;o++){let i=await n[o];if(i.ok)yield i.value;else throw i.err}}}var QZ=262144,c0=(r={})=>{let e=r.chunkSize??QZ;return async function*(n){let o=new pe,i=0,s=!1;for await(let a of n)for(o.append(a),i+=a.length;i>=e;)if(yield o.slice(0,e),s=!0,e===o.length)o=new pe,i=0;else{let c=new pe;c.append(o.sublist(e)),o=c,i-=e}(!s||i>0)&&(yield o.subarray(0,i))}};var Pi=async(r,e,t)=>{t.codec==null&&(t.codec=Jt);let n=await De.digest(r),o=q.create(t.cidVersion,t.codec.code,n);return await e.put(o,r,t),o};function wM(r){return async function*(t,n){let o=0n;for await(let i of t.content)yield async()=>{let s,a={codec:Jt,cidVersion:r.cidVersion,onProgress:r.onProgress};r.rawLeaves?(a.codec=Cn,a.cidVersion=1):(s=new _e({type:r.leafType,data:i}),i=We({Data:s.marshal(),Links:[]}));let c=await Pi(i,n,a);return o+=BigInt(i.byteLength),r.onProgress?.(new j("unixfs:importer:progress:file:write",{bytesWritten:o,cid:c,path:t.path})),{cid:c,unixfs:s,size:BigInt(i.length),block:i}}}}var J5=class r extends Error{static name="InvalidParametersError";static code="ERR_INVALID_PARAMS";name=r.name;code=r.code;constructor(e="Invalid parameters"){super(e)}};var Sc=class r extends Error{static name="InvalidContentError";static code="ERR_INVALID_CONTENT";name=r.name;code=r.code;constructor(e="Invalid content"){super(e)}};var xM=async(r,e,t)=>{let n=new _e({type:"directory",mtime:r.mtime,mode:r.mode}),o=We(Kt({Data:n.marshal()})),i=await Pi(o,e,t),s=r.path;return{cid:i,path:s,unixfs:n,size:BigInt(o.length),originalPath:r.originalPath,block:o}};async function*ZZ(r,e,t){let n=-1,o;for await(let i of a0(t.bufferImporter(r,e),t.blockWriteConcurrency)){if(n++,n===0){o={...i,single:!0};continue}else n===1&&o!=null&&(yield{...o,block:void 0,single:void 0},o=void 0);yield{...i,block:void 0}}o!=null&&(yield o)}function bM(r){return r.single===!0}var JZ=(r,e,t)=>async function(o){if(o.length===1&&bM(o[0])&&t.reduceSingleLeafToSelf){let u=o[0],f=u.block;return bM(u)&&(r.mtime!==void 0||r.mode!==void 0)&&(u.unixfs=new _e({type:"file",mtime:r.mtime,mode:r.mode,data:u.block}),f={Data:u.unixfs.marshal(),Links:[]},u.block=We(Kt(f)),u.cid=await Pi(u.block,e,{...t,cidVersion:t.cidVersion}),u.size=BigInt(u.block.length)),t.onProgress?.(new j("unixfs:importer:progress:file:layout",{cid:u.cid,path:u.originalPath})),{cid:u.cid,path:r.path,unixfs:u.unixfs,size:u.size,originalPath:u.originalPath}}let i=new _e({type:"file",mtime:r.mtime,mode:r.mode}),s=o.filter(u=>u.cid.code===mt&&u.size>0||u.unixfs!=null&&u.unixfs.data==null&&u.unixfs.fileSize()>0n?!0:!!u.unixfs?.data?.length).map(u=>u.cid.code===mt?(i.addBlockSize(u.size),{Name:"",Tsize:Number(u.size),Hash:u.cid}):(u.unixfs?.data==null?i.addBlockSize(u.unixfs?.fileSize()??0n):i.addBlockSize(BigInt(u.unixfs.data.length)),{Name:"",Tsize:Number(u.size),Hash:u.cid})),a={Data:i.marshal(),Links:s},c=We(Kt(a)),l=await Pi(c,e,t);return t.onProgress?.(new j("unixfs:importer:progress:file:layout",{cid:l,path:r.originalPath})),{cid:l,path:r.path,unixfs:i,size:BigInt(c.length+a.Links.reduce((u,f)=>u+(f.Tsize??0),0)),originalPath:r.originalPath,block:c}},vM=async(r,e,t)=>t.layout(ZZ(r,e,t),JZ(r,e,t));function eJ(r){return Symbol.iterator in r}function tJ(r){return Symbol.asyncIterator in r}function rJ(r){try{if(r instanceof Uint8Array)return async function*(){yield r}();if(eJ(r))return async function*(){yield*r}();if(tJ(r))return r}catch{throw new Sc("Content was invalid")}throw new Sc("Content was invalid")}function AM(r){return async function*(t,n){for await(let o of t){let i;if(o.path!=null&&(i=o.path,o.path=o.path.split("/").filter(s=>s!=null&&s!==".").join("/")),nJ(o)){let s={path:o.path,mtime:o.mtime,mode:o.mode,content:async function*(){let a=0n;for await(let c of r.chunker(r.chunkValidator(rJ(o.content)))){let l=BigInt(c.byteLength);a+=l,r.onProgress?.(new j("unixfs:importer:progress:file:read",{bytesRead:a,chunkSize:l,path:o.path})),yield c}}(),originalPath:i};yield async()=>vM(s,n,r)}else if(o.path!=null){let s={path:o.path,mtime:o.mtime,mode:o.mode,originalPath:i};yield async()=>xM(s,n,r)}else throw new Error("Import candidate must have content or path or both")}}}function nJ(r){return r.content!=null}var EM=()=>async function*(e){for await(let t of e){if(t.length===void 0)throw new Sc("Content was invalid");if(typeof t=="string"||t instanceof String)yield L(t.toString());else if(Array.isArray(t))yield Uint8Array.from(t);else if(t instanceof Uint8Array)yield t;else throw new Sc("Content was invalid")}};var oJ=174;function l0(r){let e=r?.maxChildrenPerNode??oJ;return async function t(n,o){let i=[];for await(let s of Z5(n,e))i.push(await o(s));return i.length>1?t(i,o):i[0]}}var fs=class{options;root;dir;path;dirty;flat;parent;parentKey;unixfs;mode;mtime;cid;size;nodeSize;constructor(e,t){this.options=t??{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime}},u0=q.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),f0=q.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi");var $u=class extends fs{_children;constructor(e,t){super(e,t),this._children=new Map}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,this._children.set(e,t)}async get(e){return Promise.resolve(this._children.get(e))}childCount(){return this._children.size}directChildrenCount(){return this.childCount()}onlyChild(){return this._children.values().next().value}async*eachChildSeries(){for(let[e,t]of this._children.entries())yield{key:e,child:t}}estimateNodeSize(){if(this.nodeSize!==void 0)return this.nodeSize;this.nodeSize=0;for(let[e,t]of this._children.entries())t.size!=null&&t.cid!=null&&(this.nodeSize+=e.length+(this.options.cidVersion===1?f0.bytes.byteLength:u0.bytes.byteLength));return this.nodeSize}async*flush(e){let t=[];for(let[c,l]of this._children.entries()){let u=l;if(l instanceof fs)for await(let f of l.flush(e))u=f,yield f;u.size!=null&&u.cid!=null&&t.push({Name:c,Tsize:Number(u.size),Hash:u.cid})}let n=new _e({type:"directory",mtime:this.mtime,mode:this.mode}),o={Data:n.marshal(),Links:t},i=We(Kt(o)),s=await Pi(i,e,this.options),a=i.length+o.Links.reduce((c,l)=>c+(l.Tsize??0),0);this.cid=s,this.size=a,yield{cid:s,unixfs:n,path:this.path,size:BigInt(a)}}};async function iJ(r){return(await Hu.encode(r)).slice(0,8).reverse()}var SM=BigInt(34),sJ=8,jA=class extends fs{_bucket;constructor(e,t){super(e,t),this._bucket=Ah({hashFn:iJ,bits:t.shardFanoutBits??sJ})}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(e,t)}async get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(let{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}estimateNodeSize(){return this.nodeSize!==void 0?this.nodeSize:(this.nodeSize=IM(this._bucket,this,this.options),this.nodeSize)}async*flush(e){for await(let t of CM(this._bucket,e,this,this.options))yield{...t,path:this.path}}},_M=jA;async function*CM(r,e,t,n){let o=r._children,i=(r.tableSize()-1).toString(16).length,s=[],a=0n;for(let m=0;m<o.length;m++){let g=o.get(m);if(g==null)continue;let w=m.toString(16).toUpperCase().padStart(i,"0");if(g instanceof wo){let x;for await(let v of CM(g,e,null,n))x=v;if(x==null)throw new Error("Could not flush sharded directory, no subshard found");s.push({Name:w,Tsize:Number(x.size),Hash:x.cid}),a+=x.size}else if(aJ(g.value)){let x=g.value,v;for await(let S of x.flush(e))v=S,yield v;if(v==null)throw new Error("Did not flush dir");let A=w+g.key;s.push({Name:A,Tsize:Number(v.size),Hash:v.cid}),a+=v.size}else{let x=g.value;if(x.cid==null)continue;let v=w+g.key,A=x.size;s.push({Name:v,Tsize:Number(A),Hash:x.cid}),a+=BigInt(A??0)}}let c=Uint8Array.from(o.bitField().reverse()),l=new _e({type:"hamt-sharded-directory",data:c,fanout:BigInt(r.tableSize()),hashType:SM,mtime:t?.mtime,mode:t?.mode}),u={Data:l.marshal(),Links:s},f=We(Kt(u)),h=await Pi(f,e,n),d=BigInt(f.byteLength)+a;yield{cid:h,unixfs:l,size:d}}function aJ(r){return typeof r.flush=="function"}function IM(r,e,t){let n=r._children,o=(r.tableSize()-1).toString(16).length,i=[];for(let l=0;l<n.length;l++){let u=n.get(l);if(u==null)continue;let f=l.toString(16).toUpperCase().padStart(o,"0");if(u instanceof wo){let h=IM(u,null,t);i.push({Name:f,Tsize:Number(h),Hash:t.cidVersion===0?u0:f0})}else if(typeof u.value.flush=="function"){let d=u.value.nodeSize();i.push({Name:f+u.key,Tsize:Number(d),Hash:t.cidVersion===0?u0:f0})}else{let h=u.value;if(h.cid==null)continue;let d=f+u.key,m=h.size;i.push({Name:d,Tsize:Number(m),Hash:h.cid})}}let s=Uint8Array.from(n.bitField().reverse()),a=new _e({type:"hamt-sharded-directory",data:s,fanout:BigInt(r.tableSize()),hashType:SM,mtime:e?.mtime,mode:e?.mode});return We(Kt({Data:a.marshal(),Links:i})).length}async function WA(r,e,t,n){let o=e;e instanceof $u&&e.estimateNodeSize()>t&&(o=await cJ(e,n));let i=o.parent;if(i!=null){if(o!==e){if(r!=null&&(r.parent=o),o.parentKey==null)throw new Error("No parent key found");await i.put(o.parentKey,o)}return WA(o,i,t,n)}return o}async function cJ(r,e){let t=new _M({root:r.root,dir:!0,parent:r.parent,parentKey:r.parentKey,path:r.path,dirty:r.dirty,flat:!1,mtime:r.mtime,mode:r.mode},e);for await(let{key:n,child:o}of r.eachChildSeries())await t.put(n,o);return t}var TM=(r="")=>r.split(/(?<!\\)\//).filter(Boolean);async function lJ(r,e,t){let n=TM(r.path??""),o=n.length-1,i=e,s="";for(let a=0;a<n.length;a++){let c=n[a];s+=`${s!==""?"/":""}${c}`;let l=a===o;if(i.dirty=!0,i.cid=void 0,i.size=void 0,l)await i.put(c,r),e=await WA(null,i,t.shardSplitThresholdBytes,t);else{let u=await i.get(c);(u==null||!(u instanceof fs))&&(u=new $u({root:!1,dir:!0,parent:i,parentKey:c,path:s,dirty:!0,flat:!0,mtime:u?.unixfs?.mtime,mode:u?.unixfs?.mode},t)),await i.put(c,u),i=u}}return e}async function*kM(r,e){if(!(r instanceof fs)){r.unixfs?.isDirectory()===!0&&(yield r);return}yield*r.flush(e)}function PM(r){return async function*(t,n){let o=new $u({root:!0,dir:!0,path:"",dirty:!0,flat:!0},r),i,s=!1;for await(let a of t){if(a==null)continue;let c=`${a.originalPath??""}`.split("/")[0];c!=null&&c!==""&&(i==null?(i=c,s=!0):i!==c&&(s=!1)),o=await lJ(a,o,r),a.unixfs?.isDirectory()!==!0&&(yield a)}if(r.wrapWithDirectory||s&&o.childCount()>1)yield*kM(o,n);else for await(let a of o.eachChildSeries())a!=null&&(yield*kM(a.child,n))}}async function*Vu(r,e,t={}){let n;Symbol.asyncIterator in r||Symbol.iterator in r?n=r:n=[r];let o=t.wrapWithDirectory??!1,i=t.shardSplitThresholdBytes??262144,s=t.shardFanoutBits??8,a=t.cidVersion??1,c=t.rawLeaves??!0,l=t.leafType??"file",u=t.fileImportConcurrency??50,f=t.blockWriteConcurrency??10,h=t.reduceSingleLeafToSelf??!0,d=t.chunker??c0(),m=t.chunkValidator??EM(),g=t.dagBuilder??AM({chunker:d,chunkValidator:m,wrapWithDirectory:o,layout:t.layout??l0(),bufferImporter:t.bufferImporter??wM({cidVersion:a,rawLeaves:c,leafType:l,onProgress:t.onProgress}),blockWriteConcurrency:f,reduceSingleLeafToSelf:h,cidVersion:a,onProgress:t.onProgress}),w=t.treeBuilder??PM({wrapWithDirectory:o,shardSplitThresholdBytes:i,shardFanoutBits:s,cidVersion:a,onProgress:t.onProgress});for await(let x of w(a0(g(n,e),u),e))yield{cid:x.cid,path:x.path,unixfs:x.unixfs,size:x.size}}async function RM(r,e,t={}){let n=await rd(Vu([r],e,t));if(n==null)throw new J5("Nothing imported");return n}async function DM(r,e,t={}){return RM({content:r},e,t)}async function NM(r,e,t={}){return RM({content:r},e,t)}var d0={cidVersion:1,rawLeaves:!0,layout:l0({maxChildrenPerNode:1024}),chunker:c0({chunkSize:1048576})};async function*e8(r,e,t={}){yield*Vu(r,e,{...d0,...t})}async function OM(r,e,t={}){let{cid:n}=await DM(r,e,{...d0,...t});return n}async function LM(r,e,t={}){let{cid:n}=await NM(r,e,{...d0,...t});return n}async function BM(r,e,t={}){if(r.path==null)throw new wr("path is required");if(r.content==null)throw new wr("content is required");let n=await ki(e8([r],e,{...d0,...t,wrapWithDirectory:!0}));if(n==null)throw new wr("Nothing imported");return n.cid}async function MM(r,e,t={}){if(r.content!=null)throw new wr("Directories cannot have content, use addFile instead");let o=await(r.path==null?rd:ki)(e8([{...r,path:r.path??"-"}],e,{...d0,...t,wrapWithDirectory:r.path!=null}));if(o==null)throw new wr("Nothing imported");return o.cid}var QA=st(G5(),1);function r8(r){function e(t){return t instanceof t8?t:new t8(t,r)}return e}var t8=class{_value;_hashFn;_depth;_availableBits;_currentBufferIndex;_buffers;constructor(e,t){if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let n=0;for(;t>0;){let o=this._buffers[this._currentBufferIndex],i=Math.min(o.availableBits(),t),s=o.take(i);n=(n<<i)+s,t-=i,this._availableBits-=i,o.availableBits()===0&&this._currentBufferIndex++}return n}untake(e){let t=e;for(;t>0;){let n=this._buffers[this._currentBufferIndex],o=Math.min(n.totalBits()-n.availableBits(),t);n.untake(o),t-=o,this._availableBits+=o,this._currentBufferIndex>0&&n.totalBits()===n.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;let e=this._depth>0?je([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),n=new GA(t);this._buffers.push(n),this._availableBits+=n.availableBits()}},uJ=[255,254,252,248,240,224,192,128],fJ=[1,3,7,15,31,63,127,255],GA=class{_value;_currentBytePos;_currentBitPos;constructor(e){this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+this._currentBytePos*8}totalBits(){return this._value.length*8}take(e){let t=e,n=0;for(;t>0&&this._haveBits();){let o=this._value[this._currentBytePos],i=this._currentBitPos+1,s=Math.min(i,t),a=dJ(o,i-s,s);n=(n<<s)+a,t-=s,this._currentBitPos-=s,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return n}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}};function dJ(r,e,t){let n=hJ(e,t);return(r&n)>>>e}function hJ(r,e){return uJ[r]&fJ[Math.min(e+r-1,7)]}var h0=BigInt(Hu.code),Ku=8;async function _h(r){return(await Hu.encode(r)).subarray(0,8).reverse()}var HM=st(G5(),1);var Ri=async(r,e,t)=>{t.codec==null&&(t.codec=Jt);let n=await De.digest(r),o=q.create(t.cidVersion,t.codec.code,n);return await e.put(o,r,{...t,signal:t.signal}),o};var XA=class{options;root;dir;path;dirty;flat;parent;parentKey;unixfs;mode;mtime;cid;size;nodeSize;constructor(e,t){this.options=t??{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime}},n8=class extends XA{_bucket;constructor(e,t){super(e,t),this._bucket=Ah({hashFn:_h,bits:8})}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(e,t)}async get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for(let{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}estimateNodeSize(){return this.nodeSize!==void 0?this.nodeSize:(this.nodeSize=FM(this._bucket,this,this.options),this.nodeSize)}async*flush(e){for await(let t of UM(this._bucket,e,this,this.options))yield{...t,path:this.path}}};async function*UM(r,e,t,n){let o=r._children,i=[],s=0n;for(let d=0;d<o.length;d++){let m=o.get(d);if(m==null)continue;let g=d.toString(16).toUpperCase().padStart(2,"0");if(m instanceof wo){let w;for await(let x of UM(m,e,null,n))w=x;if(w==null)throw new Error("Could not flush sharded directory, no sub-shard found");i.push({Name:g,Tsize:Number(w.size),Hash:w.cid}),s+=w.size}else if(pJ(m.value)){let w=m.value,x;for await(let A of w.flush(e))x=A,yield x;if(x==null)throw new Error("Did not flush dir");let v=g+m.key;i.push({Name:v,Tsize:Number(x.size),Hash:x.cid}),s+=x.size}else{let w=m.value;if(w.cid==null)continue;let x=g+m.key,v=w.size;i.push({Name:x,Tsize:Number(v),Hash:w.cid}),s+=BigInt(v??0)}}let a=Uint8Array.from(o.bitField().reverse()),c=new _e({type:"hamt-sharded-directory",data:a,fanout:BigInt(r.tableSize()),hashType:h0,mtime:t?.mtime,mode:t?.mode}),l={Data:c.marshal(),Links:i},u=We(Kt(l)),f=await Ri(u,e,n),h=BigInt(u.byteLength)+s;yield{cid:f,unixfs:c,size:h}}function pJ(r){return typeof r.flush=="function"}function FM(r,e,t){let n=r._children,o=[];for(let c=0;c<n.length;c++){let l=n.get(c);if(l==null)continue;let u=c.toString(16).toUpperCase().padStart(2,"0");if(l instanceof wo){let f=FM(l,null,t);o.push({Name:u,Tsize:Number(f),Hash:t.cidVersion===0?o8:i8})}else if(typeof l.value.flush=="function"){let h=l.value.nodeSize();o.push({Name:u+l.key,Tsize:Number(h),Hash:t.cidVersion===0?o8:i8})}else{let f=l.value;if(f.cid==null)continue;let h=u+l.key,d=f.size;o.push({Name:h,Tsize:Number(d),Hash:f.cid})}}let i=Uint8Array.from(n.bitField().reverse()),s=new _e({type:"hamt-sharded-directory",data:i,fanout:BigInt(r.tableSize()),hashType:h0,mtime:e?.mtime,mode:e?.mode});return We(Kt({Data:s.marshal(),Links:o})).length}var o8=q.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),i8=q.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi");var YA=Be("helia:unixfs:commands:utils:hamt-utils"),s8=r=>r.toString(16).toUpperCase().padStart(2,"0").substring(0,2),$M=async(r,e,t)=>{let n=new n8({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mtime:t.mtime,mode:t.mode},t);for(let i=0;i<e.length;i++)await n._bucket.put(e[i].name,{size:e[i].size,cid:e[i].cid});let o=await ki(n.flush(r));if(o==null)throw new Error("Flushing shard yielded no result");return o},a8=async(r,e,t)=>{let n=_e.unmarshal(r[0].node.Data??new Uint8Array(0)),o=BigInt(Math.pow(2,Ku));r.reverse();let i,s;for(let a=0;a<r.length;a++){let c=a===r.length-1,l=r[a],u=Uint8Array.from(l.children.bitField().reverse()),f=new _e({type:"hamt-sharded-directory",data:u,fanout:o,hashType:h0});c&&(f.mtime=n.mtime,f.mode=n.mode),s={Data:f.marshal(),Links:l.node.Links};let h=We(Kt(s));if(i=await Ri(h,e,t),!c){let d=r[a+1];if(d==null)throw new Error("Was not operating on shard root but also had no parent?");YA("updating link in parent sub-shard with prefix %s",d.prefix),d.node.Links=d.node.Links.filter(m=>m.Name!==d.prefix),d.node.Links.push({Name:d.prefix,Hash:i,Tsize:l.node.Links.reduce((m,g)=>m+(g.Tsize??0),h.byteLength)})}}if(i==null||s==null)throw new Error("Noting persisted");return{cid:i,node:s}},c8=async(r,e,t,n)=>{let i=r8(_h)(L(e)),s=[];for(;;){let a=await t.get(r,n),c=Zt(a),l=new HM.default,u=await i.take(Ku),f=s8(u);s.push({prefix:f,children:l,node:c});let h;for(let m of c.Links){let g=m.Name??"";if(g.length<2)throw new Error("Invalid HAMT - link name was too short");let w=parseInt(g.substring(0,2),16);l.set(w,!0),g.startsWith(f)&&(h=m)}if(h==null){YA("no link found with prefix %s for %s",f,e);break}let d=h.Name??"";if(d.length<2)throw new Error("Invalid HAMT - link name was too short");if(d.length===2){r=h.Hash,YA("descend into sub-shard with prefix %s",d);continue}break}return{path:s,hash:i}};async function l8(r,e,t,n){if(r.Data==null)throw new Error("DagPB node had no data");let o=_e.unmarshal(r.Data),i;if(o.type==="directory")i=mJ(r);else if(o.type==="hamt-sharded-directory")i=await VM(r,0,t,e,n);else throw new Error("Can only estimate the size of directories or shards");return i>t}function mJ(r){let e=0;for(let t of r.Links)e+=(t.Name??"").length,e+=t.Hash.version===1?i8.bytes.byteLength:o8.bytes.byteLength;return e}async function VM(r,e,t,n,o){if(e>t)return t;if(r.Data==null||!_e.unmarshal(r.Data).isDirectory())return e;for(let s of r.Links){let a=s.Name??"";if(a=a.substring(2),e+=a.length,e+=s.Hash.bytes.byteLength,s.Hash.code===Qe){let c=await n.get(s.Hash,o),l=Zt(c);e+=await VM(l,e,t,n,o)}}return e}var ds=Be("helia:unixfs:components:utils:add-link");async function Ch(r,e,t,n){if(r.node.Data==null)throw new wr("Invalid parent passed to addLink");if(_e.unmarshal(r.node.Data).type==="hamt-sharded-directory")return ds("adding link to sharded directory"),wJ(r,e,t,n);ds(`adding ${e.Name} (${e.Hash}) to regular directory`);let i=await yJ(r,e,t,n);if(await l8(i.node,t,n.shardSplitThresholdBytes,n)){ds("converting directory to sharded directory");let s=await gJ(i,t);i.cid=s.cid,i.node=Zt(await t.get(s.cid,n))}return i}var gJ=async(r,e)=>{if(r.node.Data==null)throw new wr("Invalid parent passed to convertToShardedDirectory");let t=_e.unmarshal(r.node.Data),n=await $M(e,r.node.Links.map(o=>({name:o.Name??"",size:BigInt(o.Tsize??0),cid:o.Hash})),{mode:t.mode,mtime:t.mtime,cidVersion:r.cid.version});return ds(`converted directory to sharded directory ${n.cid}`),n},yJ=async(r,e,t,n)=>{let o=r.node.Links.filter(u=>{let f=u.Name===e.Name;if(f&&!n.allowOverwriting)throw new o0;return!f});if(o.push(e),r.node.Data==null)throw new jn("Parent node with no data passed to addToDirectory");let i=_e.unmarshal(r.node.Data),s;if(i.mtime!=null){let u=Date.now(),f=Math.floor(u/1e3);i.mtime={secs:BigInt(f),nsecs:(u-f*1e3)*1e3},s=i.marshal()}else s=r.node.Data;r.node=Kt({Data:s,Links:o});let a=We(r.node),c=await De.digest(a),l=q.create(r.cid.version,Qe,c);return await t.put(l,a),{node:r.node,cid:l}},wJ=async(r,e,t,n)=>{let{path:o,hash:i}=await c8(r.cid,e.Name,t,n),s=o[o.length-1];if(s==null)throw new Error("Invalid HAMT, could not generate path");let a=s.prefix,c=parseInt(a,16);ds("next prefix for %s is %s",e.Name,a);let l=`${a}${e.Name}`,u=s.node.Links.find(f=>(f.Name??"").startsWith(a));if(u!=null)if(ds("link %s was present in shard",l),u.Name===l){if(!n.allowOverwriting)throw new o0;ds("overwriting %s in sub-shard",e.Name),s.node.Links=s.node.Links.filter(f=>f.Name!==l),s.node.Links.push({Name:l,Hash:e.Hash,Tsize:e.Tsize})}else{if(u.Name?.length===2)throw new Error("Existing link was sub-shard?!");{ds("prefix %s already exists, creating new sub-shard",a);let f=s.node.Links.findIndex(w=>w.Name?.startsWith(a)),h=s.node.Links.splice(f,1)[0],d=(h.Name??"").substring(2),g=r8(_h)(L(d));for(let w=0;w<o.length;w++)await g.take(Ku);for(;;){let w=await g.take(Ku),x=s8(w);h.Name=`${x}${d}`;let v=await i.take(Ku),A=s8(v);if(x===A){let _=new QA.default;_.set(v,!0),o.push({prefix:A,children:_,node:{Links:[]}});continue}let S=new QA.default;S.set(v,!0),S.set(w,!0),o.push({prefix:a,children:S,node:{Links:[h,{Name:`${A}${e.Name}`,Hash:e.Hash,Tsize:e.Tsize}]}});break}}}else ds("link %s was not present in sub-shard",l),e.Name=l,s.node.Links.push(e),s.children.set(c,!0),ds("adding %s to existing sub-shard",l);return a8(o,t,n)};async function _c(r,e,t={}){let n=await hr(r,e,t);if(n.type!=="directory")throw new Ec(`${r.toString()} was not a UnixFS directory`);return{cid:r,node:n.node}}async function Ih(r,e,t,n){let o=await hr(r,t,n);if(o.type!=="directory"&&o.type!=="file"&&o.type!=="raw")throw new yo(`${r.toString()} was not a UnixFS node`);return{Name:e,Tsize:o.node instanceof Uint8Array?o.node.byteLength:xJ(o.node),Hash:r}}function xJ(r){let e=r.Links.reduce((t,n)=>t+(n.Tsize??0),0);return We(r).byteLength+e}var bJ=Be("helia:unixfs:components:utils:resolve");async function hs(r,e,t,n){if(e==null||e==="")return{cid:r};let o=`/ipfs/${r}${e==null?"":`/${e}`}`,i=await Vs(s0(o,t,n));if(i.length===0)throw new wh("Could not find path in directory");return bJ("resolved %s to %c",e,r),{cid:i[i.length-1].cid,path:e,segments:i}}async function Th(r,e,t,n){if(e.segments==null||e.segments.length===0)return r;let o=e.segments.pop();if(o==null)throw new Error("Insufficient segments");o.cid=r,e.segments.reverse();for(let i of e.segments){let[s,a]=await Promise.all([_c(i.cid,t,n),Ih(o.cid,o.name,t,n)]);r=(await Ch(s,a,t,{...n,allowOverwriting:!0,cidVersion:r.version})).cid,i.cid=r,o=i}return r}var vJ=zt.bind({ignoreUndefined:!0}),AJ={};async function*KM(r,e,t={}){let n=vJ(AJ,t),o=await hs(r,n.path,e,n),i=await hr(o.cid,e,n);if(i.type!=="file"&&i.type!=="raw")throw new H5;if(i.content==null)throw new xh;yield*i.content(n)}var EJ=zt.bind({ignoreUndefined:!0}),SJ=Be("helia:unixfs:chmod"),_J={recursive:!1,shardSplitThresholdBytes:262144};async function zM(r,e,t,n={}){let o=EJ(_J,n),i=await hs(r,o.path,t,n);if(SJ("chmod %c %d",i.cid,e),o.recursive){let h=await pt(async function*(){for await(let d of Eh(i.cid,t,n)){let m,g=[];if(d.type==="raw")m=new _e({type:"file",data:d.node});else if(d.type==="file"||d.type==="directory")m=d.unixfs,g=d.node.Links;else throw new yo;m.mode=e;let w={Data:m.marshal(),Links:g};yield{path:d.path,content:w}}},d=>Vu(d,t,{...o,dagBuilder:async function*(m,g){for await(let w of m)yield async function(){let x=w.content,v=We(x),A=await Ri(v,g,{...o,cidVersion:r.version});if(x.Data==null)throw new jn(`${A} had no data`);let S=_e.unmarshal(x.Data);return{cid:A,size:BigInt(v.length),path:w.path,unixfs:S}}}}),async d=>ki(d));if(h==null)throw new Ac(`Could not chmod ${i.cid.toString()}`);return Th(h.cid,i,t,o)}let s=await t.get(i.cid,n),a,c=[];if(i.cid.code===mt)a=new _e({type:"file",data:s});else{let h=Zt(s);if(h.Data==null)throw new jn(`${i.cid.toString()} had no data`);c=h.Links,a=_e.unmarshal(h.Data)}a.mode=e;let l=We({Data:a.marshal(),Links:c}),u=await De.digest(l),f=q.create(i.cid.version,Qe,u);return await t.put(f,l),Th(f,i,t,o)}var CJ=zt.bind({ignoreUndefined:!0}),IJ=Be("helia:unixfs:cp"),TJ={force:!1,shardSplitThresholdBytes:262144};async function qM(r,e,t,n,o={}){let i=CJ(TJ,o);if(t.includes("/"))throw new wr("Name must not have slashes");let[s,a]=await Promise.all([_c(e,n,i),Ih(r,t,n,i)]);return IJ('Adding %c as "%s" to %c',r,t,e),(await Ch(s,a,n,{allowOverwriting:i.force,cidVersion:e.version,...i})).cid}var kJ=zt.bind({ignoreUndefined:!0}),PJ={};async function*jM(r,e,t={}){let n=kJ(PJ,t),o=await hs(r,n.path,e,n),i=await hr(o.cid,e);if(i.type==="file"||i.type==="raw"){yield i;return}if(i.content==null)throw new xh;if(i.type!=="directory")throw new Ec;yield*i.content({offset:t.offset,length:t.length})}var RJ=zt.bind({ignoreUndefined:!0}),WM=Be("helia:unixfs:mkdir"),DJ={cidVersion:1,force:!1,shardSplitThresholdBytes:262144};async function GM(r,e,t,n={}){let o=RJ(DJ,n);if(e.includes("/"))throw new wr("Path must not have slashes");if((await hr(r,t,n)).type!=="directory")throw new Ec(`${r.toString()} was not a UnixFS directory`);WM("creating %s",e);let a={Data:new _e({type:"directory",mode:o.mode,mtime:o.mtime}).marshal(),Links:[]},c=We(a),l=await De.digest(c),u=q.create(o.cidVersion,Qe,l);await t.put(u,c);let[f,h]=await Promise.all([_c(r,t,o),Ih(u,e,t,o)]);return WM("adding empty dir called %s to %c",e,r),(await Ch(f,h,t,{...o,allowOverwriting:o.force})).cid}var f8=Be("helia:unixfs:utils:remove-link");async function XM(r,e,t,n){if(r.node.Data==null)throw new jn("Parent node had no data");if(_e.unmarshal(r.node.Data).type==="hamt-sharded-directory"){f8(`removing ${e} from sharded directory`);let i=await OJ(r,e,t,n);return await l8(i.node,t,n.shardSplitThresholdBytes,n)?i:(f8("converting shard to flat directory %c",r.cid),LJ(i,t,n))}return f8(`removing link ${e} regular directory`),NJ(r,e,t,n)}var NJ=async(r,e,t,n)=>{r.node.Links=r.node.Links.filter(s=>s.Name!==e);let o=We(r.node),i=await Ri(o,t,{...n,cidVersion:r.cid.version});return f8(`Updated regular directory ${i}`),{node:r.node,cid:i}},OJ=async(r,e,t,n)=>{let{path:o}=await c8(r.cid,e,t,n),i=o[o.length-1];if(i==null)throw new Error("Invalid HAMT, could not generate path");let s=i.node.Links.filter(l=>(l.Name??"").substring(2)===e).map(l=>l.Name).pop();if(s==null)throw new Error("File not found");let a=s.substring(0,2),c=parseInt(a,16);if(i.node.Links=i.node.Links.filter(l=>l.Name!==s),i.children.unset(c),i.node.Links.length===1)for(;o.length!==1;){let l=o[o.length-1];if(l==null||l.node.Links.length>1)break;o.pop();let u=o[o.length-1];if(u==null)break;let f=l.node.Links[0];u.node.Links=u.node.Links.filter(h=>!(h.Name??"").startsWith(u.prefix)),u.node.Links.push({Hash:f.Hash,Name:`${u.prefix}${(f.Name??"").substring(2)}`,Tsize:f.Tsize})}return a8(o,t,n)},LJ=async(r,e,t)=>{if(r.node.Data==null)throw new wr("Invalid parent passed to convertToFlatDirectory");let n={Links:[]},o=await hr(r.cid,e);if(o.type!=="directory")throw new Error("Unexpected node type");for await(let c of o.content()){let l=0;c.node instanceof Uint8Array?l=c.node.byteLength:l=We(c.node).length,n.Links.push({Hash:c.cid,Name:c.name,Tsize:l})}let i=_e.unmarshal(r.node.Data);n.Data=new _e({type:"directory",mode:i.mode,mtime:i.mtime}).marshal();let s=We(Kt(n));return{cid:await Ri(s,e,{codec:Jt,cidVersion:r.cid.version,signal:t.signal}),node:n}};var BJ=zt.bind({ignoreUndefined:!0}),MJ=Be("helia:unixfs:rm"),UJ={shardSplitThresholdBytes:262144};async function YM(r,e,t,n={}){let o=BJ(UJ,n);if(e.includes("/"))throw new wr("Name must not have slashes");let i=await _c(r,t,o);return MJ("Removing %s from %c",e,r),(await XM(i,e,t,{...o,cidVersion:r.version})).cid}var QM=1877,d8=1604,FJ=zt.bind({ignoreUndefined:!0}),HJ=Be("helia:unixfs:stat"),$J={};async function ZM(r,e,t={}){let n=FJ($J,t),o=await hs(r,t.path,e,n);HJ("stat %c",o.cid);let i=await hr(o.cid,e,n);if(i.type==="raw")return t.extended===!0?qJ(i):zJ(i);if(i.type==="file"||i.type==="directory")return t.extended===!0?KJ(i,e,t.filter??new kf({filterSize:1024}),t):VJ(i);throw new yo}function VJ(r){return{type:r.type,cid:r.cid,unixfs:r.unixfs,mode:r.unixfs.mode??(r.unixfs.isDirectory()?QM:d8),mtime:r.unixfs.mtime,size:r.unixfs.fileSize()}}async function KJ(r,e,t,n){let o=await JM(r.cid,e,!1,t,n);return{type:r.type,cid:r.cid,unixfs:r.unixfs,size:r.unixfs.isDirectory()?o.dirSize:r.unixfs.fileSize(),mode:r.unixfs.mode??(r.unixfs.isDirectory()?QM:d8),mtime:r.unixfs.mtime,localSize:o.localSize,dagSize:o.dagSize,deduplicatedDagSize:o.deduplicatedDagSize,blocks:o.blocks,uniqueBlocks:o.uniqueBlocks}}function zJ(r){return{type:r.type,cid:r.cid,unixfs:void 0,mode:d8,mtime:void 0,size:BigInt(r.node.byteLength)}}function qJ(r){return{type:r.type,cid:r.cid,unixfs:void 0,mode:d8,mtime:void 0,size:BigInt(r.node.byteLength),localSize:BigInt(r.node.byteLength),dagSize:BigInt(r.node.byteLength),deduplicatedDagSize:BigInt(r.node.byteLength),blocks:1n,uniqueBlocks:1n}}async function JM(r,e,t,n,o){let i={dirSize:0n,localSize:0n,dagSize:0n,deduplicatedDagSize:0n,blocks:0n,uniqueBlocks:0n};try{let s=n.has(r.bytes);n.add(r.bytes);let a=await e.get(r,o);if(i.blocks++,i.dagSize+=BigInt(a.byteLength),s||(i.uniqueBlocks++,i.deduplicatedDagSize+=BigInt(a.byteLength)),r.code===mt)i.localSize+=BigInt(a.byteLength),t&&(i.dirSize+=BigInt(a.byteLength));else if(r.code===Qe){let c=Zt(a),l;if(c.Data!=null&&(l=_e.unmarshal(c.Data)),c.Links.length>0){for(let u of c.Links){let f=await JM(u.Hash,e,jJ(u,l),n,o);i.localSize+=f.localSize,i.dagSize+=f.dagSize,i.deduplicatedDagSize+=f.deduplicatedDagSize,i.blocks+=f.blocks,i.uniqueBlocks+=f.uniqueBlocks,i.dirSize+=f.dirSize}t&&l!=null&&(i.dirSize+=l.fileSize())}else{if(l==null)throw new jn(`PBNode ${r.toString()} had no data`);l.data!=null&&(i.localSize+=BigInt(l.data.byteLength??0)),t&&(i.dirSize+=l.fileSize())}}else throw new Ac(`${r.toString()} was neither DAG_PB nor RAW`)}catch(s){if(s.name!=="NotFoundError"||o.offline!==!0)throw s}return i}function jJ(r,e){if(e==null)return!1;let t=r.Name;return t==null?!1:e.type==="directory"?!0:e.type==="hamt-sharded-directory"&&t.length>2}var WJ=zt.bind({ignoreUndefined:!0}),GJ=Be("helia:unixfs:touch"),XJ={recursive:!1,shardSplitThresholdBytes:262144};async function eU(r,e,t={}){let n=WJ(XJ,t),o=await hs(r,n.path,e,n),i=n.mtime??{secs:BigInt(Math.round(Date.now()/1e3)),nsecs:0};if(GJ("touch %c %o",o.cid,i),n.recursive){let h=await pt(async function*(){for await(let d of Eh(o.cid,e)){let m,g;if(d.type==="raw")m=new _e({data:d.node}),g=[];else if(d.type==="file"||d.type==="directory")m=d.unixfs,g=d.node.Links;else throw new yo;m.mtime=i;let w={Data:m.marshal(),Links:g};yield{path:d.path,content:w}}},d=>Vu(d,e,{...n,dagBuilder:async function*(m,g){for await(let w of m)yield async function(){let x=w.content,v=We(x),A=await Ri(v,g,{...n,cidVersion:r.version});if(x.Data==null)throw new jn(`${A} had no data`);let S=_e.unmarshal(x.Data);return{cid:A,size:BigInt(v.length),path:w.path,unixfs:S}}}}),async d=>ki(d));if(h==null)throw new Ac(`Could not chmod ${o.cid.toString()}`);return Th(h.cid,o,e,n)}let s=await e.get(o.cid,t),a,c=[];if(o.cid.code===mt)a=new _e({data:s});else{let h=Zt(s);if(c=h.Links,h.Data==null)throw new jn(`${o.cid.toString()} had no data`);a=_e.unmarshal(h.Data)}a.mtime=i;let l=We({Data:a.marshal(),Links:c}),u=await De.digest(l),f=q.create(o.cid.version,Qe,u);return await e.put(f,l),Th(f,o,e,n)}var h8=class{components;constructor(e){this.components=e}async*addAll(e,t={}){yield*e8(e,this.components.blockstore,t)}async addBytes(e,t={}){return OM(e,this.components.blockstore,t)}async addByteStream(e,t={}){return LM(e,this.components.blockstore,t)}async addFile(e,t={}){return BM(e,this.components.blockstore,t)}async addDirectory(e={},t={}){return MM(e,this.components.blockstore,t)}async*cat(e,t={}){yield*KM(e,this.components.blockstore,t)}async chmod(e,t,n={}){return zM(e,t,this.components.blockstore,n)}async cp(e,t,n,o={}){return qM(e,t,n,this.components.blockstore,o)}async*ls(e,t={}){yield*jM(e,this.components.blockstore,t)}async mkdir(e,t,n={}){return GM(e,t,this.components.blockstore,n)}async rm(e,t,n={}){return YM(e,t,this.components.blockstore,n)}async stat(e,t={}){return ZM(e,this.components.blockstore,t)}async touch(e,t={}){return eU(e,this.components.blockstore,t)}};function tU(r){return new h8(r)}var nU=st(rU(),1);function Wn(r){return new DataView(r.buffer,r.byteOffset)}var oU={len:1,get(r,e){return Wn(r).getUint8(e)},put(r,e,t){return Wn(r).setUint8(e,t),e+1}},Dt={len:2,get(r,e){return Wn(r).getUint16(e,!0)},put(r,e,t){return Wn(r).setUint16(e,t,!0),e+2}},kh={len:2,get(r,e){return Wn(r).getUint16(e)},put(r,e,t){return Wn(r).setUint16(e,t),e+2}};var tr={len:4,get(r,e){return Wn(r).getUint32(e,!0)},put(r,e,t){return Wn(r).setUint32(e,t,!0),e+4}},iU={len:4,get(r,e){return Wn(r).getUint32(e)},put(r,e,t){return Wn(r).setUint32(e,t),e+4}};var sU={len:4,get(r,e){return Wn(r).getInt32(e)},put(r,e,t){return Wn(r).setInt32(e,t),e+4}};var aU={len:8,get(r,e){return Wn(r).getBigUint64(e,!0)},put(r,e,t){return Wn(r).setBigUint64(e,t,!0),e+8}};var Gn=class{constructor(e,t){this.len=e,this.encoding=t,this.textDecoder=new TextDecoder(t)}get(e,t){return this.textDecoder.decode(e.subarray(t,t+this.len))}};var QJ="End-Of-Stream",Nt=class extends Error{constructor(){super(QJ),this.name="EndOfStreamError"}},zu=class extends Error{constructor(e="The operation was aborted"){super(e),this.name="AbortError"}};var qu=class{constructor(){this.endOfStream=!1,this.interrupted=!1,this.peekQueue=[]}async peek(e,t=!1){let n=await this.read(e,t);return this.peekQueue.push(e.subarray(0,n)),n}async read(e,t=!1){if(e.length===0)return 0;let n=this.readFromPeekBuffer(e);if(this.endOfStream||(n+=await this.readRemainderFromStream(e.subarray(n),t)),n===0&&!t)throw new Nt;return n}readFromPeekBuffer(e){let t=e.length,n=0;for(;this.peekQueue.length>0&&t>0;){let o=this.peekQueue.pop();if(!o)throw new Error("peekData should be defined");let i=Math.min(o.length,t);e.set(o.subarray(0,i),n),n+=i,t-=i,i<o.length&&this.peekQueue.push(o.subarray(i))}return n}async readRemainderFromStream(e,t){let n=0;for(;n<e.length&&!this.endOfStream;){if(this.interrupted)throw new zu;let o=await this.readFromStream(e.subarray(n),t);if(o===0)break;n+=o}if(!t&&n<e.length)throw new Nt;return n}};var p8=class extends qu{constructor(e){super(),this.reader=e}async abort(){return this.close()}async close(){this.reader.releaseLock()}};var p0=class extends p8{async readFromStream(e,t){if(e.length===0)return 0;let n=await this.reader.read(new Uint8Array(e.length),{min:t?void 0:e.length});return n.done&&(this.endOfStream=n.done),n.value?(e.set(n.value),n.value.length):0}};var Ph=class extends qu{constructor(e){super(),this.reader=e,this.buffer=null}writeChunk(e,t){let n=Math.min(t.length,e.length);return e.set(t.subarray(0,n)),n<t.length?this.buffer=t.subarray(n):this.buffer=null,n}async readFromStream(e,t){if(e.length===0)return 0;let n=0;for(this.buffer&&(n+=this.writeChunk(e,this.buffer));n<e.length&&!this.endOfStream;){let o=await this.reader.read();if(o.done){this.endOfStream=!0;break}o.value&&(n+=this.writeChunk(e.subarray(n),o.value))}if(!t&&n===0&&this.endOfStream)throw new Nt;return n}abort(){return this.interrupted=!0,this.reader.cancel()}async close(){await this.abort(),this.reader.releaseLock()}};function JA(r){try{let e=r.getReader({mode:"byob"});return e instanceof ReadableStreamDefaultReader?new Ph(e):new p0(e)}catch(e){if(e instanceof TypeError)return new Ph(r.getReader());throw e}}var Cc=class{constructor(e){this.numBuffer=new Uint8Array(8),this.position=0,this.onClose=e?.onClose,e?.abortSignal&&e.abortSignal.addEventListener("abort",()=>{this.abort()})}async readToken(e,t=this.position){let n=new Uint8Array(e.len);if(await this.readBuffer(n,{position:t})<e.len)throw new Nt;return e.get(n,0)}async peekToken(e,t=this.position){let n=new Uint8Array(e.len);if(await this.peekBuffer(n,{position:t})<e.len)throw new Nt;return e.get(n,0)}async readNumber(e){if(await this.readBuffer(this.numBuffer,{length:e.len})<e.len)throw new Nt;return e.get(this.numBuffer,0)}async peekNumber(e){if(await this.peekBuffer(this.numBuffer,{length:e.len})<e.len)throw new Nt;return e.get(this.numBuffer,0)}async ignore(e){if(this.fileInfo.size!==void 0){let t=this.fileInfo.size-this.position;if(e>t)return this.position+=t,t}return this.position+=e,e}async close(){await this.abort(),await this.onClose?.()}normalizeOptions(e,t){if(!this.supportsRandomAccess()&&t&&t.position!==void 0&&t.position<this.position)throw new Error("`options.position` must be equal or greater than `tokenizer.position`");return{mayBeLess:!1,offset:0,length:e.length,position:this.position,...t}}abort(){return Promise.resolve()}};var JJ=256e3,m8=class extends Cc{constructor(e,t){super(t),this.streamReader=e,this.fileInfo=t?.fileInfo??{}}async readBuffer(e,t){let n=this.normalizeOptions(e,t),o=n.position-this.position;if(o>0)return await this.ignore(o),this.readBuffer(e,t);if(o<0)throw new Error("`options.position` must be equal or greater than `tokenizer.position`");if(n.length===0)return 0;let i=await this.streamReader.read(e.subarray(0,n.length),n.mayBeLess);if(this.position+=i,(!t||!t.mayBeLess)&&i<n.length)throw new Nt;return i}async peekBuffer(e,t){let n=this.normalizeOptions(e,t),o=0;if(n.position){let i=n.position-this.position;if(i>0){let s=new Uint8Array(n.length+i);return o=await this.peekBuffer(s,{mayBeLess:n.mayBeLess}),e.set(s.subarray(i)),o-i}if(i<0)throw new Error("Cannot peek from a negative offset in a stream")}if(n.length>0){try{o=await this.streamReader.peek(e.subarray(0,n.length),n.mayBeLess)}catch(i){if(t?.mayBeLess&&i instanceof Nt)return 0;throw i}if(!n.mayBeLess&&o<n.length)throw new Nt}return o}async ignore(e){let t=Math.min(JJ,e),n=new Uint8Array(t),o=0;for(;o<e;){let i=e-o,s=await this.readBuffer(n,{length:Math.min(t,i)});if(s<0)return s;o+=s}return o}abort(){return this.streamReader.abort()}async close(){return this.streamReader.close()}supportsRandomAccess(){return!1}};var g8=class extends Cc{constructor(e,t){super(t),this.uint8Array=e,this.fileInfo={...t?.fileInfo??{},size:e.length}}async readBuffer(e,t){t?.position&&(this.position=t.position);let n=await this.peekBuffer(e,t);return this.position+=n,n}async peekBuffer(e,t){let n=this.normalizeOptions(e,t),o=Math.min(this.uint8Array.length-n.position,n.length);if(!n.mayBeLess&&o<n.length)throw new Nt;return e.set(this.uint8Array.subarray(n.position,n.position+o)),o}close(){return super.close()}supportsRandomAccess(){return!0}setPosition(e){this.position=e}};function cU(r,e){let t=JA(r),n=e??{},o=n.onClose;return n.onClose=async()=>{if(await t.close(),o)return o()},new m8(t,n)}function lU(r,e){return new g8(r,e)}var bo=Uint8Array,Rh=Uint16Array,tee=Int32Array,uU=new bo([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),fU=new bo([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),ree=new bo([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),dU=function(r,e){for(var t=new Rh(31),n=0;n<31;++n)t[n]=e+=1<<r[n-1];for(var o=new tee(t[30]),n=1;n<30;++n)for(var i=t[n];i<t[n+1];++i)o[i]=i-t[n]<<5|n;return{b:t,r:o}},hU=dU(uU,2),pU=hU.b,nee=hU.r;pU[28]=258,nee[258]=28;var mU=dU(fU,0),oee=mU.b,Bot=mU.r,rE=new Rh(32768);for(ot=0;ot<32768;++ot)ha=(ot&43690)>>1|(ot&21845)<<1,ha=(ha&52428)>>2|(ha&13107)<<2,ha=(ha&61680)>>4|(ha&3855)<<4,rE[ot]=((ha&65280)>>8|(ha&255)<<8)>>1;var ha,ot,m0=function(r,e,t){for(var n=r.length,o=0,i=new Rh(e);o<n;++o)r[o]&&++i[r[o]-1];var s=new Rh(e);for(o=1;o<e;++o)s[o]=s[o-1]+i[o-1]<<1;var a;if(t){a=new Rh(1<<e);var c=15-e;for(o=0;o<n;++o)if(r[o])for(var l=o<<4|r[o],u=e-r[o],f=s[r[o]-1]++<<u,h=f|(1<<u)-1;f<=h;++f)a[rE[f]>>c]=l}else for(a=new Rh(n),o=0;o<n;++o)r[o]&&(a[o]=rE[s[r[o]-1]++]>>15-r[o]);return a},g0=new bo(288);for(ot=0;ot<144;++ot)g0[ot]=8;var ot;for(ot=144;ot<256;++ot)g0[ot]=9;var ot;for(ot=256;ot<280;++ot)g0[ot]=7;var ot;for(ot=280;ot<288;++ot)g0[ot]=8;var ot,gU=new bo(32);for(ot=0;ot<32;++ot)gU[ot]=5;var ot;var iee=m0(g0,9,1);var see=m0(gU,5,1),eE=function(r){for(var e=r[0],t=1;t<r.length;++t)r[t]>e&&(e=r[t]);return e},Di=function(r,e,t){var n=e/8|0;return(r[n]|r[n+1]<<8)>>(e&7)&t},tE=function(r,e){var t=e/8|0;return(r[t]|r[t+1]<<8|r[t+2]<<16)>>(e&7)},aee=function(r){return(r+7)/8|0},cee=function(r,e,t){return(e==null||e<0)&&(e=0),(t==null||t>r.length)&&(t=r.length),new bo(r.subarray(e,t))};var lee=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],xo=function(r,e,t){var n=new Error(e||lee[r]);if(n.code=r,Error.captureStackTrace&&Error.captureStackTrace(n,xo),!t)throw n;return n},nE=function(r,e,t,n){var o=r.length,i=n?n.length:0;if(!o||e.f&&!e.l)return t||new bo(0);var s=!t,a=s||e.i!=2,c=e.i;s&&(t=new bo(o*3));var l=function(un){var gs=t.length;if(un>gs){var Dh=new bo(Math.max(gs*2,un));Dh.set(t),t=Dh}},u=e.f||0,f=e.p||0,h=e.b||0,d=e.l,m=e.d,g=e.m,w=e.n,x=o*8;do{if(!d){u=Di(r,f,1);var v=Di(r,f+1,3);if(f+=3,v)if(v==1)d=iee,m=see,g=9,w=5;else if(v==2){var U=Di(r,f,31)+257,k=Di(r,f+10,15)+4,P=U+Di(r,f+5,31)+1;f+=14;for(var E=new bo(P),D=new bo(19),C=0;C<k;++C)D[ree[C]]=Di(r,f+C*3,7);f+=k*3;for(var R=eE(D),T=(1<<R)-1,V=m0(D,R,1),C=0;C<P;){var F=V[Di(r,f,T)];f+=F&15;var A=F>>4;if(A<16)E[C++]=A;else{var H=0,Y=0;for(A==16?(Y=3+Di(r,f,3),f+=2,H=E[C-1]):A==17?(Y=3+Di(r,f,7),f+=3):A==18&&(Y=11+Di(r,f,127),f+=7);Y--;)E[C++]=H}}var Q=E.subarray(0,U),X=E.subarray(U);g=eE(Q),w=eE(X),d=m0(Q,g,1),m=m0(X,w,1)}else xo(1);else{var A=aee(f)+4,S=r[A-4]|r[A-3]<<8,_=A+S;if(_>o){c&&xo(0);break}a&&l(h+S),t.set(r.subarray(A,_),h),e.b=h+=S,e.p=f=_*8,e.f=u;continue}if(f>x){c&&xo(0);break}}a&&l(h+131072);for(var me=(1<<g)-1,oe=(1<<w)-1,G=f;;G=f){var H=d[tE(r,f)&me],Te=H>>4;if(f+=H&15,f>x){c&&xo(0);break}if(H||xo(2),Te<256)t[h++]=Te;else if(Te==256){G=f,d=null;break}else{var et=Te-254;if(Te>264){var C=Te-257,ue=uU[C];et=Di(r,f,(1<<ue)-1)+pU[C],f+=ue}var it=m[tE(r,f)&oe],rr=it>>4;it||xo(3),f+=it&15;var X=oee[rr];if(rr>3){var ue=fU[rr];X+=tE(r,f)&(1<<ue)-1,f+=ue}if(f>x){c&&xo(0);break}a&&l(h+131072);var Bt=h+et;if(h<X){var Mt=i-X,pr=Math.min(X,Bt);for(Mt+h<0&&xo(3);h<pr;++h)t[h]=n[Mt+h]}for(;h<Bt;++h)t[h]=t[h-X]}}e.l=d,e.p=G,e.b=h,e.f=u,d&&(u=1,e.m=g,e.d=m,e.n=w)}while(!u);return h!=t.length&&s?cee(t,0,h):t.subarray(0,h)};var uee=new bo(0);var fee=function(r){(r[0]!=31||r[1]!=139||r[2]!=8)&&xo(6,"invalid gzip data");var e=r[3],t=10;e&4&&(t+=(r[10]|r[11]<<8)+2);for(var n=(e>>3&1)+(e>>4&1);n>0;n-=!r[t++]);return t+(e&2)},dee=function(r){var e=r.length;return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0};var hee=function(r,e){return((r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31)&&xo(6,"invalid zlib data"),(r[1]>>5&1)==+!e&&xo(6,"invalid zlib data: "+(r[1]&32?"need":"unexpected")+" dictionary"),(r[1]>>3&4)+2};function pee(r,e){return nE(r,{i:2},e&&e.out,e&&e.dictionary)}function mee(r,e){var t=fee(r);return t+8>r.length&&xo(6,"invalid gzip data"),nE(r.subarray(t,-8),{i:2},e&&e.out||new bo(dee(r)),e&&e.dictionary)}function gee(r,e){return nE(r.subarray(hee(r,e&&e.dictionary),-4),{i:2},e&&e.out,e&&e.dictionary)}function yU(r,e){return r[0]==31&&r[1]==139&&r[2]==8?mee(r,e):(r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31?pee(r,e):gee(r,e)}var yee=typeof TextDecoder<"u"&&new TextDecoder,wee=0;try{yee.decode(uee,{stream:!0}),wee=1}catch{}var SU=st(bU(),1);var ju={LocalFileHeader:67324752,DataDescriptor:134695760,CentralFileHeader:33639248,EndOfCentralDirectory:101010256},oE={get(r){let e=Dt.get(r,6);return{signature:tr.get(r,0),compressedSize:tr.get(r,8),uncompressedSize:tr.get(r,12)}},len:16},vU={get(r){let e=Dt.get(r,6);return{signature:tr.get(r,0),minVersion:Dt.get(r,4),dataDescriptor:!!(e&8),compressedMethod:Dt.get(r,8),compressedSize:tr.get(r,18),uncompressedSize:tr.get(r,22),filenameLength:Dt.get(r,26),extraFieldLength:Dt.get(r,28),filename:null}},len:30},AU={get(r){return{signature:tr.get(r,0),nrOfThisDisk:Dt.get(r,4),nrOfThisDiskWithTheStart:Dt.get(r,6),nrOfEntriesOnThisDisk:Dt.get(r,8),nrOfEntriesOfSize:Dt.get(r,10),sizeOfCd:tr.get(r,12),offsetOfStartOfCd:tr.get(r,16),zipFileCommentLength:Dt.get(r,20)}},len:22},EU={get(r){let e=Dt.get(r,8);return{signature:tr.get(r,0),minVersion:Dt.get(r,6),dataDescriptor:!!(e&8),compressedMethod:Dt.get(r,10),compressedSize:tr.get(r,20),uncompressedSize:tr.get(r,24),filenameLength:Dt.get(r,28),extraFieldLength:Dt.get(r,30),fileCommentLength:Dt.get(r,32),relativeOffsetOfLocalHeader:tr.get(r,42),filename:null}},len:46};function _U(r){let e=new Uint8Array(tr.len);return tr.put(e,0,r),e}var ps=(0,SU.default)("tokenizer:inflate"),iE=256*1024,Cee=_U(ju.DataDescriptor),w8=_U(ju.EndOfCentralDirectory),x8=class{constructor(e){this.tokenizer=e,this.syncBuffer=new Uint8Array(iE)}async isZip(){return await this.peekSignature()===ju.LocalFileHeader}peekSignature(){return this.tokenizer.peekToken(tr)}async findEndOfCentralDirectoryLocator(){let e=this.tokenizer,t=Math.min(16*1024,e.fileInfo.size),n=this.syncBuffer.subarray(0,t);await this.tokenizer.readBuffer(n,{position:e.fileInfo.size-t});for(let o=n.length-4;o>=0;o--)if(n[o]===w8[0]&&n[o+1]===w8[1]&&n[o+2]===w8[2]&&n[o+3]===w8[3])return e.fileInfo.size-t+o;return-1}async readCentralDirectory(){if(!this.tokenizer.supportsRandomAccess()){ps("Cannot reading central-directory without random-read support");return}ps("Reading central-directory...");let e=this.tokenizer.position,t=await this.findEndOfCentralDirectoryLocator();if(t>0){ps("Central-directory 32-bit signature found");let n=await this.tokenizer.readToken(AU,t),o=[];this.tokenizer.setPosition(n.offsetOfStartOfCd);for(let i=0;i<n.nrOfEntriesOfSize;++i){let s=await this.tokenizer.readToken(EU);if(s.signature!==ju.CentralFileHeader)throw new Error("Expected Central-File-Header signature");s.filename=await this.tokenizer.readToken(new Gn(s.filenameLength,"utf-8")),await this.tokenizer.ignore(s.extraFieldLength),await this.tokenizer.ignore(s.fileCommentLength),o.push(s),ps(`Add central-directory file-entry: n=${i+1}/${o.length}: filename=${o[i].filename}`)}return this.tokenizer.setPosition(e),o}this.tokenizer.setPosition(e)}async unzip(e){let t=await this.readCentralDirectory();if(t)return this.iterateOverCentralDirectory(t,e);let n=!1;do{let o=await this.readLocalFileHeader();if(!o)break;let i=e(o);n=!!i.stop;let s;if(await this.tokenizer.ignore(o.extraFieldLength),o.dataDescriptor&&o.compressedSize===0){let a=[],c=iE;ps("Compressed-file-size unknown, scanning for next data-descriptor-signature....");let l=-1;for(;l<0&&c===iE;){c=await this.tokenizer.peekBuffer(this.syncBuffer,{mayBeLess:!0}),l=Iee(this.syncBuffer.subarray(0,c),Cee);let u=l>=0?l:c;if(i.handler){let f=new Uint8Array(u);await this.tokenizer.readBuffer(f),a.push(f)}else await this.tokenizer.ignore(u)}ps(`Found data-descriptor-signature at pos=${this.tokenizer.position}`),i.handler&&await this.inflate(o,Tee(a),i.handler)}else i.handler?(ps(`Reading compressed-file-data: ${o.compressedSize} bytes`),s=new Uint8Array(o.compressedSize),await this.tokenizer.readBuffer(s),await this.inflate(o,s,i.handler)):(ps(`Ignoring compressed-file-data: ${o.compressedSize} bytes`),await this.tokenizer.ignore(o.compressedSize));if(ps(`Reading data-descriptor at pos=${this.tokenizer.position}`),o.dataDescriptor&&(await this.tokenizer.readToken(oE)).signature!==134695760)throw new Error(`Expected data-descriptor-signature at position ${this.tokenizer.position-oE.len}`)}while(!n)}async iterateOverCentralDirectory(e,t){for(let n of e){let o=t(n);if(o.handler){this.tokenizer.setPosition(n.relativeOffsetOfLocalHeader);let i=await this.readLocalFileHeader();if(i){await this.tokenizer.ignore(i.extraFieldLength);let s=new Uint8Array(n.compressedSize);await this.tokenizer.readBuffer(s),await this.inflate(i,s,o.handler)}}if(o.stop)break}}inflate(e,t,n){if(e.compressedMethod===0)return n(t);ps(`Decompress filename=${e.filename}, compressed-size=${t.length}`);let o=yU(t);return n(o)}async readLocalFileHeader(){let e=await this.tokenizer.peekToken(tr);if(e===ju.LocalFileHeader){let t=await this.tokenizer.readToken(vU);return t.filename=await this.tokenizer.readToken(new Gn(t.filenameLength,"utf-8")),t}if(e===ju.CentralFileHeader)return!1;throw e===3759263696?new Error("Encrypted ZIP"):new Error("Unexpected signature")}};function Iee(r,e){let t=r.length,n=e.length;if(n>t)return-1;for(let o=0;o<=t-n;o++){let i=!0;for(let s=0;s<n;s++)if(r[o+s]!==e[s]){i=!1;break}if(i)return o}return-1}function Tee(r){let e=r.reduce((o,i)=>o+i.length,0),t=new Uint8Array(e),n=0;for(let o of r)t.set(o,n),n+=o.length;return t}var qot={utf8:new globalThis.TextDecoder("utf8")};var jot=new globalThis.TextEncoder;var Wot=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function sE(r){let{byteLength:e}=r;if(e===6)return r.getUint16(0)*2**32+r.getUint32(2);if(e===5)return r.getUint8(0)*2**32+r.getUint32(1);if(e===4)return r.getUint32(0);if(e===3)return r.getUint8(0)*2**16+r.getUint16(1);if(e===2)return r.getUint16(0);if(e===1)return r.getUint8(0)}function kee(r,e){let t=r.length,n=e.length;if(n===0||n>t)return-1;let o=t-n;for(let i=0;i<=o;i++){let s=!0;for(let a=0;a<n;a++)if(r[i+a]!==e[a]){s=!1;break}if(s)return i}return-1}function CU(r,e){return kee(r,e)!==-1}function IU(r){return[...r].map(e=>e.charCodeAt(0))}function TU(r,e=0){let t=Number.parseInt(new Gn(6).get(r,148).replace(/\0.*$/,"").trim(),8);if(Number.isNaN(t))return!1;let n=8*32;for(let o=e;o<e+148;o++)n+=r[o];for(let o=e+156;o<e+512;o++)n+=r[o];return t===n}var kU={get:(r,e)=>r[e+3]&127|r[e+2]<<7|r[e+1]<<14|r[e]<<21,len:4};var PU=["jpg","png","apng","gif","webp","flif","xcf","cr2","cr3","orf","arw","dng","nef","rw2","raf","tif","bmp","icns","jxr","psd","indd","zip","tar","rar","gz","bz2","7z","dmg","mp4","mid","mkv","webm","mov","avi","mpg","mp2","mp3","m4a","oga","ogg","ogv","opus","flac","wav","spx","amr","pdf","epub","elf","macho","exe","swf","rtf","wasm","woff","woff2","eot","ttf","otf","ttc","ico","flv","ps","xz","sqlite","nes","crx","xpi","cab","deb","ar","rpm","Z","lz","cfb","mxf","mts","blend","bpg","docx","pptx","xlsx","3gp","3g2","j2c","jp2","jpm","jpx","mj2","aif","qcp","odt","ods","odp","xml","mobi","heic","cur","ktx","ape","wv","dcm","ics","glb","pcap","dsf","lnk","alias","voc","ac3","m4v","m4p","m4b","f4v","f4p","f4b","f4a","mie","asf","ogm","ogx","mpc","arrow","shp","aac","mp1","it","s3m","xm","ai","skp","avif","eps","lzh","pgp","asar","stl","chm","3mf","zst","jxl","vcf","jls","pst","dwg","parquet","class","arj","cpio","ace","avro","icc","fbx","vsdx","vtt","apk","drc","lz4","potx","xltx","dotx","xltm","ott","ots","otp","odg","otg","xlsm","docm","dotm","potm","pptm","jar","rm","ppsm","ppsx"],RU=["image/jpeg","image/png","image/gif","image/webp","image/flif","image/x-xcf","image/x-canon-cr2","image/x-canon-cr3","image/tiff","image/bmp","image/vnd.ms-photo","image/vnd.adobe.photoshop","application/x-indesign","application/epub+zip","application/x-xpinstall","application/vnd.ms-powerpoint.slideshow.macroenabled.12","application/vnd.oasis.opendocument.text","application/vnd.oasis.opendocument.spreadsheet","application/vnd.oasis.opendocument.presentation","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.openxmlformats-officedocument.presentationml.slideshow","application/zip","application/x-tar","application/x-rar-compressed","application/gzip","application/x-bzip2","application/x-7z-compressed","application/x-apple-diskimage","application/x-apache-arrow","video/mp4","audio/midi","video/x-matroska","video/webm","video/quicktime","video/vnd.avi","audio/wav","audio/qcelp","audio/x-ms-asf","video/x-ms-asf","application/vnd.ms-asf","video/mpeg","video/3gpp","audio/mpeg","audio/mp4","video/ogg","audio/ogg","audio/ogg; codecs=opus","application/ogg","audio/x-flac","audio/ape","audio/wavpack","audio/amr","application/pdf","application/x-elf","application/x-mach-binary","application/x-msdownload","application/x-shockwave-flash","application/rtf","application/wasm","font/woff","font/woff2","application/vnd.ms-fontobject","font/ttf","font/otf","font/collection","image/x-icon","video/x-flv","application/postscript","application/eps","application/x-xz","application/x-sqlite3","application/x-nintendo-nes-rom","application/x-google-chrome-extension","application/vnd.ms-cab-compressed","application/x-deb","application/x-unix-archive","application/x-rpm","application/x-compress","application/x-lzip","application/x-cfb","application/x-mie","application/mxf","video/mp2t","application/x-blender","image/bpg","image/j2c","image/jp2","image/jpx","image/jpm","image/mj2","audio/aiff","application/xml","application/x-mobipocket-ebook","image/heif","image/heif-sequence","image/heic","image/heic-sequence","image/icns","image/ktx","application/dicom","audio/x-musepack","text/calendar","text/vcard","text/vtt","model/gltf-binary","application/vnd.tcpdump.pcap","audio/x-dsf","application/x.ms.shortcut","application/x.apple.alias","audio/x-voc","audio/vnd.dolby.dd-raw","audio/x-m4a","image/apng","image/x-olympus-orf","image/x-sony-arw","image/x-adobe-dng","image/x-nikon-nef","image/x-panasonic-rw2","image/x-fujifilm-raf","video/x-m4v","video/3gpp2","application/x-esri-shape","audio/aac","audio/x-it","audio/x-s3m","audio/x-xm","video/MP1S","video/MP2P","application/vnd.sketchup.skp","image/avif","application/x-lzh-compressed","application/pgp-encrypted","application/x-asar","model/stl","application/vnd.ms-htmlhelp","model/3mf","image/jxl","application/zstd","image/jls","application/vnd.ms-outlook","image/vnd.dwg","application/x-parquet","application/java-vm","application/x-arj","application/x-cpio","application/x-ace-compressed","application/avro","application/vnd.iccprofile","application/x.autodesk.fbx","application/vnd.visio","application/vnd.android.package-archive","application/vnd.google.draco","application/x-lz4","application/vnd.openxmlformats-officedocument.presentationml.template","application/vnd.openxmlformats-officedocument.spreadsheetml.template","application/vnd.openxmlformats-officedocument.wordprocessingml.template","application/vnd.ms-excel.template.macroenabled.12","application/vnd.oasis.opendocument.text-template","application/vnd.oasis.opendocument.spreadsheet-template","application/vnd.oasis.opendocument.presentation-template","application/vnd.oasis.opendocument.graphics","application/vnd.oasis.opendocument.graphics-template","application/vnd.ms-excel.sheet.macroenabled.12","application/vnd.ms-word.document.macroenabled.12","application/vnd.ms-word.template.macroenabled.12","application/vnd.ms-powerpoint.template.macroenabled.12","application/vnd.ms-powerpoint.presentation.macroenabled.12","application/java-archive","application/vnd.rn-realmedia"];var aE=4100;async function DU(r){return new lE().fromBuffer(r)}function cE(r){switch(r.toLowerCase()){case"application/epub+zip":return{ext:"epub",mime:"application/epub+zip"};case"application/vnd.oasis.opendocument.text":return{ext:"odt",mime:"application/vnd.oasis.opendocument.text"};case"application/vnd.oasis.opendocument.text-template":return{ext:"ott",mime:"application/vnd.oasis.opendocument.text-template"};case"application/vnd.oasis.opendocument.spreadsheet":return{ext:"ods",mime:"application/vnd.oasis.opendocument.spreadsheet"};case"application/vnd.oasis.opendocument.spreadsheet-template":return{ext:"ots",mime:"application/vnd.oasis.opendocument.spreadsheet-template"};case"application/vnd.oasis.opendocument.presentation":return{ext:"odp",mime:"application/vnd.oasis.opendocument.presentation"};case"application/vnd.oasis.opendocument.presentation-template":return{ext:"otp",mime:"application/vnd.oasis.opendocument.presentation-template"};case"application/vnd.oasis.opendocument.graphics":return{ext:"odg",mime:"application/vnd.oasis.opendocument.graphics"};case"application/vnd.oasis.opendocument.graphics-template":return{ext:"otg",mime:"application/vnd.oasis.opendocument.graphics-template"};case"application/vnd.openxmlformats-officedocument.presentationml.slideshow":return{ext:"ppsx",mime:"application/vnd.openxmlformats-officedocument.presentationml.slideshow"};case"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":return{ext:"xlsx",mime:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"};case"application/vnd.ms-excel.sheet.macroenabled":return{ext:"xlsm",mime:"application/vnd.ms-excel.sheet.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.spreadsheetml.template":return{ext:"xltx",mime:"application/vnd.openxmlformats-officedocument.spreadsheetml.template"};case"application/vnd.ms-excel.template.macroenabled":return{ext:"xltm",mime:"application/vnd.ms-excel.template.macroenabled.12"};case"application/vnd.ms-powerpoint.slideshow.macroenabled":return{ext:"ppsm",mime:"application/vnd.ms-powerpoint.slideshow.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.wordprocessingml.document":return{ext:"docx",mime:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"};case"application/vnd.ms-word.document.macroenabled":return{ext:"docm",mime:"application/vnd.ms-word.document.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.wordprocessingml.template":return{ext:"dotx",mime:"application/vnd.openxmlformats-officedocument.wordprocessingml.template"};case"application/vnd.ms-word.template.macroenabledtemplate":return{ext:"dotm",mime:"application/vnd.ms-word.template.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.presentationml.template":return{ext:"potx",mime:"application/vnd.openxmlformats-officedocument.presentationml.template"};case"application/vnd.ms-powerpoint.template.macroenabled":return{ext:"potm",mime:"application/vnd.ms-powerpoint.template.macroenabled.12"};case"application/vnd.openxmlformats-officedocument.presentationml.presentation":return{ext:"pptx",mime:"application/vnd.openxmlformats-officedocument.presentationml.presentation"};case"application/vnd.ms-powerpoint.presentation.macroenabled":return{ext:"pptm",mime:"application/vnd.ms-powerpoint.presentation.macroenabled.12"};case"application/vnd.ms-visio.drawing":return{ext:"vsdx",mime:"application/vnd.visio"};case"application/vnd.ms-package.3dmanufacturing-3dmodel+xml":return{ext:"3mf",mime:"model/3mf"};default:}}function ms(r,e,t){t={offset:0,...t};for(let[n,o]of e.entries())if(t.mask){if(o!==(t.mask[n]&r[n+t.offset]))return!1}else if(o!==r[n+t.offset])return!1;return!0}var lE=class{constructor(e){this.detectors=[...e?.customDetectors??[],{id:"core",detect:this.detectConfident},{id:"core.imprecise",detect:this.detectImprecise}],this.tokenizerOptions={abortSignal:e?.signal}}async fromTokenizer(e){let t=e.position;for(let n of this.detectors){let o=await n.detect(e);if(o)return o;if(t!==e.position)return}}async fromBuffer(e){if(!(e instanceof Uint8Array||e instanceof ArrayBuffer))throw new TypeError(`Expected the \`input\` argument to be of type \`Uint8Array\` or \`ArrayBuffer\`, got \`${typeof e}\``);let t=e instanceof Uint8Array?e:new Uint8Array(e);if(t?.length>1)return this.fromTokenizer(lU(t,this.tokenizerOptions))}async fromBlob(e){return this.fromStream(e.stream())}async fromStream(e){let t=await cU(e,this.tokenizerOptions);try{return await this.fromTokenizer(t)}finally{await t.close()}}async toDetectionStream(e,t){let{sampleSize:n=aE}=t,o,i,s=e.getReader({mode:"byob"});try{let{value:l,done:u}=await s.read(new Uint8Array(n));if(i=l,!u&&l)try{o=await this.fromBuffer(l.slice(0,n))}catch(f){if(!(f instanceof Nt))throw f;o=void 0}i=l}finally{s.releaseLock()}let a=new TransformStream({async start(l){l.enqueue(i)},transform(l,u){u.enqueue(l)}}),c=e.pipeThrough(a);return c.fileType=o,c}check(e,t){return ms(this.buffer,e,t)}checkString(e,t){return this.check(IU(e),t)}detectConfident=async e=>{if(this.buffer=new Uint8Array(aE),e.fileInfo.size===void 0&&(e.fileInfo.size=Number.MAX_SAFE_INTEGER),this.tokenizer=e,await e.peekBuffer(this.buffer,{length:12,mayBeLess:!0}),this.check([66,77]))return{ext:"bmp",mime:"image/bmp"};if(this.check([11,119]))return{ext:"ac3",mime:"audio/vnd.dolby.dd-raw"};if(this.check([120,1]))return{ext:"dmg",mime:"application/x-apple-diskimage"};if(this.check([77,90]))return{ext:"exe",mime:"application/x-msdownload"};if(this.check([37,33]))return await e.peekBuffer(this.buffer,{length:24,mayBeLess:!0}),this.checkString("PS-Adobe-",{offset:2})&&this.checkString(" EPSF-",{offset:14})?{ext:"eps",mime:"application/eps"}:{ext:"ps",mime:"application/postscript"};if(this.check([31,160])||this.check([31,157]))return{ext:"Z",mime:"application/x-compress"};if(this.check([199,113]))return{ext:"cpio",mime:"application/x-cpio"};if(this.check([96,234]))return{ext:"arj",mime:"application/x-arj"};if(this.check([239,187,191]))return this.tokenizer.ignore(3),this.detectConfident(e);if(this.check([71,73,70]))return{ext:"gif",mime:"image/gif"};if(this.check([73,73,188]))return{ext:"jxr",mime:"image/vnd.ms-photo"};if(this.check([31,139,8]))return{ext:"gz",mime:"application/gzip"};if(this.check([66,90,104]))return{ext:"bz2",mime:"application/x-bzip2"};if(this.checkString("ID3")){await e.ignore(6);let t=await e.readToken(kU);return e.position+t>e.fileInfo.size?{ext:"mp3",mime:"audio/mpeg"}:(await e.ignore(t),this.fromTokenizer(e))}if(this.checkString("MP+"))return{ext:"mpc",mime:"audio/x-musepack"};if((this.buffer[0]===67||this.buffer[0]===70)&&this.check([87,83],{offset:1}))return{ext:"swf",mime:"application/x-shockwave-flash"};if(this.check([255,216,255]))return this.check([247],{offset:3})?{ext:"jls",mime:"image/jls"}:{ext:"jpg",mime:"image/jpeg"};if(this.check([79,98,106,1]))return{ext:"avro",mime:"application/avro"};if(this.checkString("FLIF"))return{ext:"flif",mime:"image/flif"};if(this.checkString("8BPS"))return{ext:"psd",mime:"image/vnd.adobe.photoshop"};if(this.checkString("MPCK"))return{ext:"mpc",mime:"audio/x-musepack"};if(this.checkString("FORM"))return{ext:"aif",mime:"audio/aiff"};if(this.checkString("icns",{offset:0}))return{ext:"icns",mime:"image/icns"};if(this.check([80,75,3,4])){let t;return await new x8(e).unzip(n=>{switch(n.filename){case"META-INF/mozilla.rsa":return t={ext:"xpi",mime:"application/x-xpinstall"},{stop:!0};case"META-INF/MANIFEST.MF":return t={ext:"jar",mime:"application/java-archive"},{stop:!0};case"mimetype":return{async handler(o){let i=new TextDecoder("utf-8").decode(o).trim();t=cE(i)},stop:!0};case"[Content_Types].xml":return{async handler(o){let i=new TextDecoder("utf-8").decode(o),s=i.indexOf('.main+xml"');if(s===-1){let a="application/vnd.ms-package.3dmanufacturing-3dmodel+xml";i.includes(`ContentType="${a}"`)&&(t=cE(a))}else{i=i.slice(0,Math.max(0,s));let a=i.lastIndexOf('"'),c=i.slice(Math.max(0,a+1));t=cE(c)}},stop:!0};default:return/classes\d*\.dex/.test(n.filename)?(t={ext:"apk",mime:"application/vnd.android.package-archive"},{stop:!0}):{}}}),t??{ext:"zip",mime:"application/zip"}}if(this.checkString("OggS")){await e.ignore(28);let t=new Uint8Array(8);return await e.readBuffer(t),ms(t,[79,112,117,115,72,101,97,100])?{ext:"opus",mime:"audio/ogg; codecs=opus"}:ms(t,[128,116,104,101,111,114,97])?{ext:"ogv",mime:"video/ogg"}:ms(t,[1,118,105,100,101,111,0])?{ext:"ogm",mime:"video/ogg"}:ms(t,[127,70,76,65,67])?{ext:"oga",mime:"audio/ogg"}:ms(t,[83,112,101,101,120,32,32])?{ext:"spx",mime:"audio/ogg"}:ms(t,[1,118,111,114,98,105,115])?{ext:"ogg",mime:"audio/ogg"}:{ext:"ogx",mime:"application/ogg"}}if(this.check([80,75])&&(this.buffer[2]===3||this.buffer[2]===5||this.buffer[2]===7)&&(this.buffer[3]===4||this.buffer[3]===6||this.buffer[3]===8))return{ext:"zip",mime:"application/zip"};if(this.checkString("MThd"))return{ext:"mid",mime:"audio/midi"};if(this.checkString("wOFF")&&(this.check([0,1,0,0],{offset:4})||this.checkString("OTTO",{offset:4})))return{ext:"woff",mime:"font/woff"};if(this.checkString("wOF2")&&(this.check([0,1,0,0],{offset:4})||this.checkString("OTTO",{offset:4})))return{ext:"woff2",mime:"font/woff2"};if(this.check([212,195,178,161])||this.check([161,178,195,212]))return{ext:"pcap",mime:"application/vnd.tcpdump.pcap"};if(this.checkString("DSD "))return{ext:"dsf",mime:"audio/x-dsf"};if(this.checkString("LZIP"))return{ext:"lz",mime:"application/x-lzip"};if(this.checkString("fLaC"))return{ext:"flac",mime:"audio/x-flac"};if(this.check([66,80,71,251]))return{ext:"bpg",mime:"image/bpg"};if(this.checkString("wvpk"))return{ext:"wv",mime:"audio/wavpack"};if(this.checkString("%PDF")){try{if(await e.ignore(1350)===1350){let o=new Uint8Array(Math.min(10485760,e.fileInfo.size-1350));if(await e.readBuffer(o,{mayBeLess:!0}),CU(o,new TextEncoder().encode("AIPrivateData")))return{ext:"ai",mime:"application/postscript"}}}catch(t){if(!(t instanceof Nt))throw t}return{ext:"pdf",mime:"application/pdf"}}if(this.check([0,97,115,109]))return{ext:"wasm",mime:"application/wasm"};if(this.check([73,73])){let t=await this.readTiffHeader(!1);if(t)return t}if(this.check([77,77])){let t=await this.readTiffHeader(!0);if(t)return t}if(this.checkString("MAC "))return{ext:"ape",mime:"audio/ape"};if(this.check([26,69,223,163])){async function t(){let a=await e.peekNumber(oU),c=128,l=0;for(;(a&c)===0&&c!==0;)++l,c>>=1;let u=new Uint8Array(l+1);return await e.readBuffer(u),u}async function n(){let a=await t(),c=await t();c[0]^=128>>c.length-1;let l=Math.min(6,c.length),u=new DataView(a.buffer),f=new DataView(c.buffer,c.length-l,l);return{id:sE(u),len:sE(f)}}async function o(a){for(;a>0;){let c=await n();if(c.id===17026)return(await e.readToken(new Gn(c.len))).replaceAll(/\00.*$/g,"");await e.ignore(c.len),--a}}let i=await n();switch(await o(i.len)){case"webm":return{ext:"webm",mime:"video/webm"};case"matroska":return{ext:"mkv",mime:"video/x-matroska"};default:return}}if(this.checkString("SQLi"))return{ext:"sqlite",mime:"application/x-sqlite3"};if(this.check([78,69,83,26]))return{ext:"nes",mime:"application/x-nintendo-nes-rom"};if(this.checkString("Cr24"))return{ext:"crx",mime:"application/x-google-chrome-extension"};if(this.checkString("MSCF")||this.checkString("ISc("))return{ext:"cab",mime:"application/vnd.ms-cab-compressed"};if(this.check([237,171,238,219]))return{ext:"rpm",mime:"application/x-rpm"};if(this.check([197,208,211,198]))return{ext:"eps",mime:"application/eps"};if(this.check([40,181,47,253]))return{ext:"zst",mime:"application/zstd"};if(this.check([127,69,76,70]))return{ext:"elf",mime:"application/x-elf"};if(this.check([33,66,68,78]))return{ext:"pst",mime:"application/vnd.ms-outlook"};if(this.checkString("PAR1"))return{ext:"parquet",mime:"application/x-parquet"};if(this.checkString("ttcf"))return{ext:"ttc",mime:"font/collection"};if(this.check([207,250,237,254]))return{ext:"macho",mime:"application/x-mach-binary"};if(this.check([4,34,77,24]))return{ext:"lz4",mime:"application/x-lz4"};if(this.check([79,84,84,79,0]))return{ext:"otf",mime:"font/otf"};if(this.checkString("#!AMR"))return{ext:"amr",mime:"audio/amr"};if(this.checkString("{\\rtf"))return{ext:"rtf",mime:"application/rtf"};if(this.check([70,76,86,1]))return{ext:"flv",mime:"video/x-flv"};if(this.checkString("IMPM"))return{ext:"it",mime:"audio/x-it"};if(this.checkString("-lh0-",{offset:2})||this.checkString("-lh1-",{offset:2})||this.checkString("-lh2-",{offset:2})||this.checkString("-lh3-",{offset:2})||this.checkString("-lh4-",{offset:2})||this.checkString("-lh5-",{offset:2})||this.checkString("-lh6-",{offset:2})||this.checkString("-lh7-",{offset:2})||this.checkString("-lzs-",{offset:2})||this.checkString("-lz4-",{offset:2})||this.checkString("-lz5-",{offset:2})||this.checkString("-lhd-",{offset:2}))return{ext:"lzh",mime:"application/x-lzh-compressed"};if(this.check([0,0,1,186])){if(this.check([33],{offset:4,mask:[241]}))return{ext:"mpg",mime:"video/MP1S"};if(this.check([68],{offset:4,mask:[196]}))return{ext:"mpg",mime:"video/MP2P"}}if(this.checkString("ITSF"))return{ext:"chm",mime:"application/vnd.ms-htmlhelp"};if(this.check([202,254,186,190]))return{ext:"class",mime:"application/java-vm"};if(this.checkString(".RMF"))return{ext:"rm",mime:"application/vnd.rn-realmedia"};if(this.checkString("DRACO"))return{ext:"drc",mime:"application/vnd.google.draco"};if(this.check([253,55,122,88,90,0]))return{ext:"xz",mime:"application/x-xz"};if(this.checkString("<?xml "))return{ext:"xml",mime:"application/xml"};if(this.check([55,122,188,175,39,28]))return{ext:"7z",mime:"application/x-7z-compressed"};if(this.check([82,97,114,33,26,7])&&(this.buffer[6]===0||this.buffer[6]===1))return{ext:"rar",mime:"application/x-rar-compressed"};if(this.checkString("solid "))return{ext:"stl",mime:"model/stl"};if(this.checkString("AC")){let t=new Gn(4,"latin1").get(this.buffer,2);if(t.match("^d*")&&t>=1e3&&t<=1050)return{ext:"dwg",mime:"image/vnd.dwg"}}if(this.checkString("070707"))return{ext:"cpio",mime:"application/x-cpio"};if(this.checkString("BLENDER"))return{ext:"blend",mime:"application/x-blender"};if(this.checkString("!<arch>"))return await e.ignore(8),await e.readToken(new Gn(13,"ascii"))==="debian-binary"?{ext:"deb",mime:"application/x-deb"}:{ext:"ar",mime:"application/x-unix-archive"};if(this.checkString("WEBVTT")&&[`
`,"\r","	"," ","\0"].some(t=>this.checkString(t,{offset:6})))return{ext:"vtt",mime:"text/vtt"};if(this.check([137,80,78,71,13,10,26,10])){await e.ignore(8);async function t(){return{length:await e.readToken(sU),type:await e.readToken(new Gn(4,"latin1"))}}do{let n=await t();if(n.length<0)return;switch(n.type){case"IDAT":return{ext:"png",mime:"image/png"};case"acTL":return{ext:"apng",mime:"image/apng"};default:await e.ignore(n.length+4)}}while(e.position+8<e.fileInfo.size);return{ext:"png",mime:"image/png"}}if(this.check([65,82,82,79,87,49,0,0]))return{ext:"arrow",mime:"application/x-apache-arrow"};if(this.check([103,108,84,70,2,0,0,0]))return{ext:"glb",mime:"model/gltf-binary"};if(this.check([102,114,101,101],{offset:4})||this.check([109,100,97,116],{offset:4})||this.check([109,111,111,118],{offset:4})||this.check([119,105,100,101],{offset:4}))return{ext:"mov",mime:"video/quicktime"};if(this.check([73,73,82,79,8,0,0,0,24]))return{ext:"orf",mime:"image/x-olympus-orf"};if(this.checkString("gimp xcf "))return{ext:"xcf",mime:"image/x-xcf"};if(this.checkString("ftyp",{offset:4})&&(this.buffer[8]&96)!==0){let t=new Gn(4,"latin1").get(this.buffer,8).replace("\0"," ").trim();switch(t){case"avif":case"avis":return{ext:"avif",mime:"image/avif"};case"mif1":return{ext:"heic",mime:"image/heif"};case"msf1":return{ext:"heic",mime:"image/heif-sequence"};case"heic":case"heix":return{ext:"heic",mime:"image/heic"};case"hevc":case"hevx":return{ext:"heic",mime:"image/heic-sequence"};case"qt":return{ext:"mov",mime:"video/quicktime"};case"M4V":case"M4VH":case"M4VP":return{ext:"m4v",mime:"video/x-m4v"};case"M4P":return{ext:"m4p",mime:"video/mp4"};case"M4B":return{ext:"m4b",mime:"audio/mp4"};case"M4A":return{ext:"m4a",mime:"audio/x-m4a"};case"F4V":return{ext:"f4v",mime:"video/mp4"};case"F4P":return{ext:"f4p",mime:"video/mp4"};case"F4A":return{ext:"f4a",mime:"audio/mp4"};case"F4B":return{ext:"f4b",mime:"audio/mp4"};case"crx":return{ext:"cr3",mime:"image/x-canon-cr3"};default:return t.startsWith("3g")?t.startsWith("3g2")?{ext:"3g2",mime:"video/3gpp2"}:{ext:"3gp",mime:"video/3gpp"}:{ext:"mp4",mime:"video/mp4"}}}if(this.check([82,73,70,70])){if(this.checkString("WEBP",{offset:8}))return{ext:"webp",mime:"image/webp"};if(this.check([65,86,73],{offset:8}))return{ext:"avi",mime:"video/vnd.avi"};if(this.check([87,65,86,69],{offset:8}))return{ext:"wav",mime:"audio/wav"};if(this.check([81,76,67,77],{offset:8}))return{ext:"qcp",mime:"audio/qcelp"}}if(this.check([73,73,85,0,24,0,0,0,136,231,116,216]))return{ext:"rw2",mime:"image/x-panasonic-rw2"};if(this.check([48,38,178,117,142,102,207,17,166,217])){async function t(){let n=new Uint8Array(16);return await e.readBuffer(n),{id:n,size:Number(await e.readToken(aU))}}for(await e.ignore(30);e.position+24<e.fileInfo.size;){let n=await t(),o=n.size-24;if(ms(n.id,[145,7,220,183,183,169,207,17,142,230,0,192,12,32,83,101])){let i=new Uint8Array(16);if(o-=await e.readBuffer(i),ms(i,[64,158,105,248,77,91,207,17,168,253,0,128,95,92,68,43]))return{ext:"asf",mime:"audio/x-ms-asf"};if(ms(i,[192,239,25,188,77,91,207,17,168,253,0,128,95,92,68,43]))return{ext:"asf",mime:"video/x-ms-asf"};break}await e.ignore(o)}return{ext:"asf",mime:"application/vnd.ms-asf"}}if(this.check([171,75,84,88,32,49,49,187,13,10,26,10]))return{ext:"ktx",mime:"image/ktx"};if((this.check([126,16,4])||this.check([126,24,4]))&&this.check([48,77,73,69],{offset:4}))return{ext:"mie",mime:"application/x-mie"};if(this.check([39,10,0,0,0,0,0,0,0,0,0,0],{offset:2}))return{ext:"shp",mime:"application/x-esri-shape"};if(this.check([255,79,255,81]))return{ext:"j2c",mime:"image/j2c"};if(this.check([0,0,0,12,106,80,32,32,13,10,135,10]))switch(await e.ignore(20),await e.readToken(new Gn(4,"ascii"))){case"jp2 ":return{ext:"jp2",mime:"image/jp2"};case"jpx ":return{ext:"jpx",mime:"image/jpx"};case"jpm ":return{ext:"jpm",mime:"image/jpm"};case"mjp2":return{ext:"mj2",mime:"image/mj2"};default:return}if(this.check([255,10])||this.check([0,0,0,12,74,88,76,32,13,10,135,10]))return{ext:"jxl",mime:"image/jxl"};if(this.check([254,255]))return this.check([0,60,0,63,0,120,0,109,0,108],{offset:2})?{ext:"xml",mime:"application/xml"}:void 0;if(this.check([208,207,17,224,161,177,26,225]))return{ext:"cfb",mime:"application/x-cfb"};if(await e.peekBuffer(this.buffer,{length:Math.min(256,e.fileInfo.size),mayBeLess:!0}),this.check([97,99,115,112],{offset:36}))return{ext:"icc",mime:"application/vnd.iccprofile"};if(this.checkString("**ACE",{offset:7})&&this.checkString("**",{offset:12}))return{ext:"ace",mime:"application/x-ace-compressed"};if(this.checkString("BEGIN:")){if(this.checkString("VCARD",{offset:6}))return{ext:"vcf",mime:"text/vcard"};if(this.checkString("VCALENDAR",{offset:6}))return{ext:"ics",mime:"text/calendar"}}if(this.checkString("FUJIFILMCCD-RAW"))return{ext:"raf",mime:"image/x-fujifilm-raf"};if(this.checkString("Extended Module:"))return{ext:"xm",mime:"audio/x-xm"};if(this.checkString("Creative Voice File"))return{ext:"voc",mime:"audio/x-voc"};if(this.check([4,0,0,0])&&this.buffer.length>=16){let t=new DataView(this.buffer.buffer).getUint32(12,!0);if(t>12&&this.buffer.length>=t+16)try{let n=new TextDecoder().decode(this.buffer.slice(16,t+16));if(JSON.parse(n).files)return{ext:"asar",mime:"application/x-asar"}}catch{}}if(this.check([6,14,43,52,2,5,1,1,13,1,2,1,1,2]))return{ext:"mxf",mime:"application/mxf"};if(this.checkString("SCRM",{offset:44}))return{ext:"s3m",mime:"audio/x-s3m"};if(this.check([71])&&this.check([71],{offset:188}))return{ext:"mts",mime:"video/mp2t"};if(this.check([71],{offset:4})&&this.check([71],{offset:196}))return{ext:"mts",mime:"video/mp2t"};if(this.check([66,79,79,75,77,79,66,73],{offset:60}))return{ext:"mobi",mime:"application/x-mobipocket-ebook"};if(this.check([68,73,67,77],{offset:128}))return{ext:"dcm",mime:"application/dicom"};if(this.check([76,0,0,0,1,20,2,0,0,0,0,0,192,0,0,0,0,0,0,70]))return{ext:"lnk",mime:"application/x.ms.shortcut"};if(this.check([98,111,111,107,0,0,0,0,109,97,114,107,0,0,0,0]))return{ext:"alias",mime:"application/x.apple.alias"};if(this.checkString("Kaydara FBX Binary  \0"))return{ext:"fbx",mime:"application/x.autodesk.fbx"};if(this.check([76,80],{offset:34})&&(this.check([0,0,1],{offset:8})||this.check([1,0,2],{offset:8})||this.check([2,0,2],{offset:8})))return{ext:"eot",mime:"application/vnd.ms-fontobject"};if(this.check([6,6,237,245,216,29,70,229,189,49,239,231,254,116,183,29]))return{ext:"indd",mime:"application/x-indesign"};if(await e.peekBuffer(this.buffer,{length:Math.min(512,e.fileInfo.size),mayBeLess:!0}),TU(this.buffer))return{ext:"tar",mime:"application/x-tar"};if(this.check([255,254]))return this.check([60,0,63,0,120,0,109,0,108,0],{offset:2})?{ext:"xml",mime:"application/xml"}:this.check([255,14,83,0,107,0,101,0,116,0,99,0,104,0,85,0,112,0,32,0,77,0,111,0,100,0,101,0,108,0],{offset:2})?{ext:"skp",mime:"application/vnd.sketchup.skp"}:void 0;if(this.checkString("-----BEGIN PGP MESSAGE-----"))return{ext:"pgp",mime:"application/pgp-encrypted"}};detectImprecise=async e=>{if(this.buffer=new Uint8Array(aE),await e.peekBuffer(this.buffer,{length:Math.min(8,e.fileInfo.size),mayBeLess:!0}),this.check([0,0,1,186])||this.check([0,0,1,179]))return{ext:"mpg",mime:"video/mpeg"};if(this.check([0,1,0,0,0]))return{ext:"ttf",mime:"font/ttf"};if(this.check([0,0,1,0]))return{ext:"ico",mime:"image/x-icon"};if(this.check([0,0,2,0]))return{ext:"cur",mime:"image/x-icon"};if(this.buffer.length>=2&&this.check([255,224],{offset:0,mask:[255,224]})){if(this.check([16],{offset:1,mask:[22]}))return this.check([8],{offset:1,mask:[8]})?{ext:"aac",mime:"audio/aac"}:{ext:"aac",mime:"audio/aac"};if(this.check([2],{offset:1,mask:[6]}))return{ext:"mp3",mime:"audio/mpeg"};if(this.check([4],{offset:1,mask:[6]}))return{ext:"mp2",mime:"audio/mpeg"};if(this.check([6],{offset:1,mask:[6]}))return{ext:"mp1",mime:"audio/mpeg"}}};async readTiffTag(e){let t=await this.tokenizer.readToken(e?kh:Dt);switch(this.tokenizer.ignore(10),t){case 50341:return{ext:"arw",mime:"image/x-sony-arw"};case 50706:return{ext:"dng",mime:"image/x-adobe-dng"};default:}}async readTiffIFD(e){let t=await this.tokenizer.readToken(e?kh:Dt);for(let n=0;n<t;++n){let o=await this.readTiffTag(e);if(o)return o}}async readTiffHeader(e){let t=(e?kh:Dt).get(this.buffer,2),n=(e?iU:tr).get(this.buffer,4);if(t===42){if(n>=6){if(this.checkString("CR",{offset:8}))return{ext:"cr2",mime:"image/x-canon-cr2"};if(n>=8){let i=(e?kh:Dt).get(this.buffer,8),s=(e?kh:Dt).get(this.buffer,10);if(i===28&&s===254||i===31&&s===11)return{ext:"nef",mime:"image/x-nikon-nef"}}}return await this.tokenizer.ignore(n),await this.readTiffIFD(e)??{ext:"tif",mime:"image/tiff"}}if(t===43)return{ext:"tif",mime:"image/tiff"}}},rit=new Set(PU),nit=new Set(RU);var Ic=Be("helia:verified-fetch:content-type-parser"),b8="application/octet-stream";function Pee(r){return Ic("checking for svg"),/^(<\?xml[^>]+>)?[^<^\w]+<svg/ig.test(r)}async function Ree(r){Ic("checking for json");try{return JSON.parse(r),!0}catch(e){return Ic("failed to parse as json",e),!1}}function Dee(r){Ic("checking for text");let e=new TextDecoder("utf-8",{fatal:!0});try{return e.decode(r)}catch{return null}}async function Nee(r){return Ic("checking for html"),/^\s*<(?:!doctype\s+html|html|head|body)\b/i.test(r)}async function NU(r,e){Ic("contentTypeParser called for fileName: %s, byte size=%s",e,r.length);let t=(await DU(r))?.mime;if(t!=null)return Ic("detectedType: %s",t),t;if(Ic("no detectedType"),e==null){let n=Dee(r);return n!=null?Pee(n)?"image/svg+xml":await Ree(n)?"application/json":await Nee(n)?"text/html; charset=utf-8":"text/plain; charset=utf-8":b8}switch(e.split(".").pop()){case"css":return"text/css";case"html":return"text/html; charset=utf-8";case"js":return"application/javascript";case"json":return"application/json";case"txt":return"text/plain";case"woff2":return"font/woff2";case"svg":return"image/svg+xml";case"csv":return"text/csv";case"doc":return"application/msword";case"xls":return"application/vnd.ms-excel";case"ppt":return"application/vnd.ms-powerpoint";case"msi":return"application/x-msdownload";default:return b8}}function OU(r){return r?.then!=null}async function y0({bytes:r,path:e,contentTypeParser:t,log:n,defaultContentType:o="application/octet-stream",filename:i}){let s;if(t!=null)try{let a;i==null?(a=e.split("/").pop()?.trim(),a=a===""||a?.split(".").length===1?void 0:a):a=i;let c=t(r,a);if(OU(c)){let l=await c;l!=null&&(s=l)}else c!=null&&(s=c);n.trace("contentTypeParser returned %s",s)}catch(a){n.error("error parsing content type",a)}return s===b8&&(s=o),s??o}async function uE(r,e,t,n){let o=t.forComponent("helia:verified-fetch:get-stream-from-async-iterable"),i=r[Symbol.asyncIterator](),{value:s,done:a}=await i.next();if(a===!0)throw o.error("no content found for path",e),new v5;return{stream:new ReadableStream({async start(l){n?.onProgress?.(new j("verified-fetch:request:progress:chunk")),l.enqueue(s)},async pull(l){let{value:u,done:f}=await i.next();if(n?.signal?.aborted){l.error(new Xe(n.signal.reason??"signal aborted by user")),l.close();return}if(f===!0){u!=null&&(n?.onProgress?.(new j("verified-fetch:request:progress:chunk")),l.enqueue(u)),l.close();return}n?.onProgress?.(new j("verified-fetch:request:progress:chunk")),l.enqueue(u)}}),firstChunk:s}}var v8=class extends Ct{id="dag-pb-plugin";codes=[Qe];canHandle({cid:e,accept:t,pathDetails:n,byteRangeContext:o}){return this.log("checking if we can handle %c with accept %s",e,t),n==null||o==null?!1:e.code===Qe}getRedirectUrl(e){let{resource:t,path:n}=e;if(n===""?!t.toString().endsWith("/"):!n.endsWith("/"))try{let i=new URL(t.toString());return i.pathname.endsWith("/")?null:(i.pathname=`${i.pathname}/`,i.toString())}catch{return`${t.toString()}/`}return null}async handle(e){let{cid:t,options:n,withServerTiming:o=!1,pathDetails:i,query:s}=e,{handleServerTiming:a,contentTypeParser:c,helia:l,getBlockstore:u}=this.pluginOptions,f=this.log,h=e.resource,d=e.path,m=!1,g=e.byteRangeContext,w=i.ipfsRoots,x=i.terminalElement,v=x.cid,A=tU({...l,blockstore:u(e.cid,e.resource,n?.session??!0,n)});if(x?.type==="directory"){let S=x.cid,_=this.getRedirectUrl(e);if(_!=null){if(f.trace("directory url normalization spec requires redirect..."),n?.redirect==="error")throw f('could not redirect to %s as redirect option was set to "error"',_),new TypeError("Failed to fetch");if(n?.redirect==="manual")return f("returning 301 permanent redirect to %s",_),Z1(h,_);f("following redirect to %s",_),h=_,m=!0}let U="index.html";try{f.trace("found directory at %c/%s, looking for index.html",t,d);let k=await a("exporter-dir","",async()=>hr(`/ipfs/${S}/${U}`,l.blockstore,{signal:n?.signal,onProgress:n?.onProgress}),o);f.trace("found root file at %c/%s with cid %c",S,U,k.cid),d=U,v=k.cid}catch(k){if(n?.signal?.aborted)throw new Xe(n?.signal?.reason);this.log.error("error loading path %c/%s",S,U,k),e.isDirectory=!0,e.directoryEntries=[],e.modified++,this.log.trace("attempting to get directory entries because index.html was not found");try{for await(let P of A.ls(S,{signal:n?.signal,onProgress:n?.onProgress}))e.directoryEntries.push(P);return null}catch(P){return f.error("error listing directory %c",S,P),C5("Unable to get directory contents")}}finally{n?.onProgress?.(new j("verified-fetch:request:end",{cid:S,path:U}))}}try{let S=await A.stat(v,{extended:!0,signal:AbortSignal.timeout(500)});g.setFileSize(S.size)}catch(S){f.error("error getting exact file size for %c/%s - %e",t,d,S),g.setFileSize(i.terminalElement.size),f.trace("using terminal element size of %d for %c/%s",i.terminalElement.size,t,d)}try{let S=await a("exporter-file","",async()=>hr(v,l.blockstore,{signal:n?.signal,onProgress:n?.onProgress}),o),_,U;if(g.isValidRangeRequest)U=await this.handleRangeRequest(e,S);else{let P=S.content({signal:n?.signal,onProgress:n?.onProgress});f("got async iterator for %c/%s",t,d);let E=await a("stream-and-chunk","",async()=>uE(P,d??"",this.pluginOptions.logger,{onProgress:n?.onProgress,signal:n?.signal}),o),D=E.stream;_=E.firstChunk,U=await a("get-content-type","",async()=>y0({filename:s.filename,bytes:_,path:d,contentTypeParser:c,log:f}),o),g.setBody(D)}let k=ln(h,g.getBody(U),{byteRangeContext:g,log:f},{redirected:m});return k.headers.set("Content-Type",g.getContentType()??U),S5(k,w),k}catch(S){if(n?.signal?.aborted)throw new Xe(n?.signal?.reason);return f.error("error streaming %c/%s",t,d,S),g.isRangeRequest&&S.code==="ERR_INVALID_PARAMS"?mh(h):gh(h.toString(),"Unable to stream content")}}async handleRangeRequest(e,t){let{path:n,byteRangeContext:o,options:i,withServerTiming:s=!1}=e,{handleServerTiming:a,contentTypeParser:c}=this.pluginOptions,l=this.log,u=t.content({signal:i?.signal,onProgress:i?.onProgress,offset:0,length:8192}),{firstChunk:f}=await uE(u,n??"",this.pluginOptions.logger,{onProgress:i?.onProgress,signal:i?.signal}),h=await a("get-content-type","",async()=>y0({bytes:f,path:n,contentTypeParser:c,log:l}),s);return o?.setBody(d=>{if(i?.signal?.aborted)throw new Xe(i?.signal?.reason??"aborted while streaming");return t.content({signal:i?.signal,onProgress:i?.onProgress,offset:d.start??0,length:o.getLength(d)})},h),h}};var A8=class extends Ct{id="dag-walk-plugin";canHandle(e){this.log("checking if we can handle %c with accept %s",e.cid,e.accept);let{pathDetails:t,cid:n}=e;return t!=null?!1:n.code===Qe||n.code===Pr}async handle(e){let{cid:t,resource:n,options:o,withServerTiming:i=!1}=e,{getBlockstore:s,handleServerTiming:a}=this.pluginOptions,c=s(t,n,o?.session??!0,o),l=await a("path-walking","",async()=>yM({...e,blockstore:c,log:this.log}),i);return l instanceof Response?(this.log.trace("path walking failed"),l.status===404?l:null):(e.modified++,e.pathDetails=l,null)}};function E8(r){return r.charAt(0)==="1"||r.charAt(0)==="Q"?tt(r):yn(q.parse(r))}var S8=class extends Error{name="PluginError";code;fatal;details;response;constructor(e,t,n){super(t),this.code=e,this.fatal=n?.fatal??!1,this.details=n?.details,this.response=n?.response}},Tc=class extends S8{name="PluginFatalError";constructor(e,t,n){super(e,t,{...n,fatal:!0}),this.name="PluginFatalError"}};var _8=class extends Ct{id="ipns-record-plugin";codes=[];canHandle({cid:e,accept:t,query:n,byteRangeContext:o}){return this.log("checking if we can handle %c with accept %s",e,t),o==null?!1:t==="application/vnd.ipfs.ipns-record"||n.format==="ipns-record"}async handle(e){let{resource:t,path:n,options:o}=e,{helia:i}=this.pluginOptions;if(e.reqFormat="ipns-record",n!==""||!(t.startsWith("ipns://")||t.includes(".ipns.")||t.includes("/ipns/")))throw this.log.error('invalid request for IPNS name "%s" and path "%s"',t,n),new Tc("ERR_INVALID_IPNS_NAME","Invalid IPNS name",{response:Q1(t,new Error("Invalid IPNS name"))});let s;try{let h;t.startsWith("ipns://")?h=t.replace("ipns://",""):t.includes("/ipns/")?h=t.split("/ipns/")[1].split("/")[0].split("?")[0]:h=t.split(".ipns.")[0].split("://")[1],this.log.trace('trying to parse peer id from "%s"',h),s=E8(h)}catch(h){throw this.log.error("could not parse peer id from IPNS url %s",t,h),new Tc("ERR_NO_PEER_ID_FOUND","could not parse peer id from url",{response:Q1(t,h)})}let a=je([L("/ipns/"),s.toMultihash().bytes]),c=new Je("/dht/record/"+K(a,"base32"),!1),l=await i.datastore.get(c,o),u=Pt.deserialize(l);e.byteRangeContext.setBody(u.value);let f=ln(t,e.byteRangeContext.getBody("application/vnd.ipfs.ipns-record"),{byteRangeContext:e.byteRangeContext,log:this.log});return f.headers.set("content-type",e.byteRangeContext.getContentType()??"application/vnd.ipfs.ipns-record"),f}};var C8=class extends Ct{id="json-plugin";codes=[ui,Bi];canHandle({cid:e,accept:t,byteRangeContext:n}){return this.log("checking if we can handle %c with accept %s",e,t),n==null?!1:t==="application/vnd.ipld.dag-json"&&e.code!==Pr?!0:ui===e.code||Bi===e.code}async handle(e){let{path:t,resource:n,cid:o,accept:i,options:s}=e,{getBlockstore:a}=this.pluginOptions,c=s?.session??!0;this.log.trace("fetching %c/%s",o,t);let l=e.pathDetails?.terminalElement.cid??e.cid,f=await a(l,n,c,s).get(l,s),h;if(i==="application/vnd.ipld.dag-cbor"||i==="application/cbor")try{let g=$f(f);h=Ff(g)}catch(g){return this.log.error("could not transform %c to application/vnd.ipld.dag-cbor",g),da(n)}else h=f;let d;i==null?ui===o.code?d="application/vnd.ipld.dag-json":d="application/json":d=i.split(";")[0],e.byteRangeContext.setBody(h);let m=ln(n,e.byteRangeContext.getBody(d),{byteRangeContext:e.byteRangeContext,log:this.log});return m.headers.set("content-type",e.byteRangeContext.getContentType()??d),e.byteRangeContext.isValidRangeRequest||m.headers.set("content-length",h.length.toString()),m}};var Oee=["application/vnd.ipld.dag-json","application/vnd.ipld.raw","application/octet-stream"];function Lee({headers:r,accept:e}){let n=(e??new Headers(r).get("accept")??"").split(",").map(o=>o.split(";")[0]).map(o=>o.trim());for(let o of n){if(o==="*/*")return;if(Oee.includes(o??""))return o}}var I8=class extends Ct{id="raw-plugin";codes=[mt,ir.code];canHandle({cid:e,accept:t,query:n,byteRangeContext:o}){return this.log("checking if we can handle %c with accept %s",e,t),o==null?!1:t==="application/vnd.ipld.raw"||n.format==="raw"}async handle(e){let{path:t,resource:n,cid:o,accept:i,query:s,options:a}=e,{getBlockstore:c,contentTypeParser:l}=this.pluginOptions,u=a?.session??!0,f=this.log;if(i==="application/vnd.ipld.raw"||s.format==="raw"?(e.reqFormat="raw",e.query.download=!0,e.query.filename=e.query.filename??`${o.toString()}.bin`,f.trace("Set content disposition...")):f.trace("Did NOT set content disposition..."),t!==""&&o.code===mt)throw f.trace("404-ing raw codec request for %c/%s",o,t),new Tc("ERR_RAW_PATHS_NOT_SUPPORTED","Raw codec does not support paths",{response:I5(n,"Raw codec does not support paths")});let h=e.pathDetails?.terminalElement.cid??e.cid,m=await c(h,n,u,a).get(h,a);e.byteRangeContext.setBody(m);let g=await y0({filename:s.filename,bytes:m,path:t,defaultContentType:Lee({headers:a?.headers,accept:i}),contentTypeParser:l,log:f}),w=ln(n,e.byteRangeContext.getBody(g),{byteRangeContext:e.byteRangeContext,log:f},{redirected:!1});return w.headers.set("content-type",e.byteRangeContext.getContentType()??g),w}};var Bee=({weak:r,reqFormat:e})=>e==="tar"||e==="car"||e==="ipns-record"||r===!0?"W/":"",Mee=({reqFormat:r})=>r==null?"":r==="tar"?".x-tar":`.${r}`;function kc({cid:r,reqFormat:e,weak:t,rangeStart:n,rangeEnd:o,contentPrefix:i}){let s=Bee({weak:t,reqFormat:e}),a=Mee({reqFormat:e});return(n!=null||o!=null)&&(a+=`.${n??"0"}-${o??"N"}`),`${s}"${i??""}${r.toString()}${a}"`}var cst=L("ustar\0","binary"),lst=L("ustar ","binary"),ust=L(" \0","binary");var FU=st(BU(),1);function Fee(r){return r[Symbol.asyncIterator]!=null}function Hee(r){if(Fee(r))return(async()=>{let n=new Uint8Array(0);for await(let o of r)n=je([n,o],n.length+o.length);return n})();let e=[],t=0;for(let n of r)e.push(n),t+=n.byteLength;return je(e,t)}var MU=Hee;var $ee="0000000000000000000",Vee="7777777777777777777",Kee=48,zee=L("ustar\0","binary"),qee=L("00","binary"),jee=parseInt("7777",8),Wee=257,Gee=263,Xee=function(r){switch(r){case"file":return 0;case"link":return 1;case"symlink":return 2;case"character-device":return 3;case"block-device":return 4;case"directory":return 5;case"fifo":return 6;case"contiguous-file":return 7;case"pax-header":return 72;default:return 0}},Yee=function(r){let e=256;for(let t=0;t<148;t++)e+=r[t];for(let t=156;t<512;t++)e+=r[t];return e},Pc=function(r,e){let t=r.toString(8);return t.length>e?L(Vee.slice(0,e)+" "):L($ee.slice(0,e-t.length)+t+" ")},fE=function(r){let e=L(r).byteLength,t=Math.floor(Math.log(e)/Math.log(10))+1;return e+t>=Math.pow(10,t)&&t++,`${e+t}${r}`};function UU(r){let e="";r.name!=null&&(e+=fE(" path="+r.name+`
`)),r.linkname!=null&&(e+=fE(" linkpath="+r.linkname+`
`));let t=r.pax;if(t!=null)for(let n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e+=fE(" "+n+"="+t[n]+`
`));return L(e)}function T8(r){let e=new Uint8Array(512),t=r.name,n="";if(r.typeflag===5&&t[t.length-1]!=="/"&&(t+="/"),L(t).byteLength!==t.length)return null;for(;L(t).byteLength>100;){let o=t.indexOf("/");if(o===-1)return null;n+=n!==""?"/"+t.slice(0,o):t.slice(0,o),t=t.slice(o+1)}return L(t).byteLength>100||L(n).byteLength>155||r.linkname!=null&&L(r.linkname).byteLength>100?null:(e.set(L(t),0),e.set(Pc(r.mode&jee,6),100),e.set(Pc(r.uid,6),108),e.set(Pc(r.gid,6),116),e.set(Pc(r.size,11),124),e.set(Pc(r.mtime.getTime()/1e3|0,11),136),e[156]=Kee+Xee(r.type),r.linkname!=null&&e.set(L(r.linkname),157),e.set(zee,Wee),e.set(qee,Gee),r.uname!=null&&e.set(L(r.uname),265),r.gname!=null&&e.set(L(r.gname),297),e.set(Pc(r.devmajor??0,6),329),e.set(Pc(r.devminor??0,6),337),n!=null&&e.set(L(n),345),e.set(Pc(Yee(e),6),148),e)}var{S_IFMT:Zee,S_IFBLK:Jee,S_IFCHR:ete,S_IFDIR:tte,S_IFIFO:rte,S_IFLNK:nte}=FU.default,ote=parseInt("755",8),ite=parseInt("644",8),HU=new Uint8Array(1024);function ste(r=0){switch(r&Zee){case Jee:return"block-device";case ete:return"character-device";case tte:return"directory";case rte:return"fifo";case nte:return"symlink";default:return"file"}}function hE(r){return r&=511,r!==0?HU.subarray(0,512-r):new Uint8Array(0)}function dE(r){if(r.pax==null){let e=T8(r);if(e!=null)return e}return ate(r)}function ate(r){let e=UU(r),t={name:"PaxHeader",mode:r.mode,uid:r.uid,gid:r.gid,size:e.length,mtime:r.mtime,type:"pax-header",linkname:r.linkname,uname:r.uname,gname:r.gname,devmajor:r.devmajor,devminor:r.devminor};return new pe(T8(t)??new Uint8Array(0),e,hE(e.length),T8({...t,size:r.size,type:r.type})??new Uint8Array(0)).subarray()}function k8(){return async function*(r){for await(let{header:e,body:t}of r){let n={...e,size:e.type==="symlink"?0:e.size??0,type:e.type??ste(e.mode),mode:e.mode??(e.type==="directory"?ote:ite),uid:e.uid??0,gid:e.gid??0,mtime:e.mtime??new Date};if(typeof t=="string"&&(t=L(t)),t instanceof Uint8Array||Eo(t)){n.size=t.length,yield dE(n),yield Eo(t)?t.subarray():t,yield hE(n.size);continue}if(n.type==="symlink"&&n.linkname==null){if(t==null)throw new Error("type was symlink but no linkname or body specified");n.linkname=K(await MU(t)),yield dE(n);continue}if(yield dE(n),n.type!=="file"&&n.type!=="contiguous-file")continue;let o=0;for await(let i of t??[])o+=i.length,yield Eo(i)?i.subarray():i;if(o!==n.size)throw new Error(`size mismatch, wrote ${o} of ${n.size} bytes`);yield hE(n.size)}yield HU}}var cte=["file","raw","directory"];function lte(r){let e,t;return(r.type==="file"||r.type==="directory")&&(e=r.unixfs.mode,t=r.unixfs.mtime!=null?new Date(Number(r.unixfs.mtime.secs*1000n)):void 0),{name:r.path,mode:e,mtime:t,size:Number(r.size),type:r.type==="directory"?"directory":"file"}}function $U(r){if(!cte.includes(r.type))throw new yo(`${r.type} is not a UnixFS node`);let e={header:lte(r)};return(r.type==="file"||r.type==="raw")&&(e.body=r.content()),e}async function*VU(r,e,t){let n=await hr(r,e,t);if(n.type==="file"||n.type==="raw"){yield*pt([$U(n)],k8());return}if(n.type==="directory"){yield*pt(Eh(r,e,t),o=>Ht(o,i=>$U(i)),k8());return}throw new yo("Not a UnixFS node")}var P8=class extends Ct{id="tar-plugin";codes=[];canHandle({cid:e,accept:t,query:n,byteRangeContext:o}){return this.log("checking if we can handle %c with accept %s",e,t),o==null?!1:t==="application/x-tar"||n.format==="tar"}async handle(e){let{cid:t,path:n,resource:o,options:i,pathDetails:s}=e,{getBlockstore:a}=this.pluginOptions,c=s?.terminalElement.cid??t;if(c.code!==Qe&&c.code!==mt)return da("only UnixFS data can be returned in a TAR file");e.reqFormat="tar",e.query.download=!0,e.query.filename=e.query.filename??`${c.toString()}.tar`;let l=a(c,o,i?.session,i),u=Bu(VU(`/ipfs/${t}/${n}`,l,i));e.byteRangeContext.setBody(u);let f=ln(o,e.byteRangeContext.getBody("application/x-tar"),{byteRangeContext:e.byteRangeContext,log:this.log});return f.headers.set("content-type",e.byteRangeContext.getContentType()??"application/x-tar"),f.headers.set("etag",kc({cid:c,reqFormat:e.reqFormat,weak:!0})),f}};function KU(r){let e=ute(r);return e===r?`filename="${r}"`:`filename="${e}"; filename*=UTF-8''${encodeURIComponent(r)}`}function ute(r){return r.replace(/[^\x00-\x7F]/g,"_")}var fte={[Pr]:["application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car","text/html"],[ui]:["application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car"],[Bi]:["application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car"],[Qe]:["application/octet-stream","application/json","application/vnd.ipld.dag-cbor","application/cbor","application/vnd.ipld.dag-json","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.car","application/x-tar"],[mt]:["application/octet-stream","application/vnd.ipld.raw","application/vnd.ipfs.ipns-record","application/vnd.ipld.dag-json","application/vnd.ipld.car","application/x-tar"]};function zU(r,e){let t=fte[r.code];if(e!=null)return dte(e,t)}function dte(r,e){let t=r.split(",").map(n=>{let o=n.trim().split(";");return{mimeType:`${o[0]}`.trim(),weight:hte(o[1])}}).sort((n,o)=>n.weight===o.weight?0:n.weight>o.weight?-1:1).map(n=>n.mimeType);for(let n of t)for(let o of e)if(n.includes(o)||n==="*/*"||n.startsWith("*/")&&o.split("/")[1]===n.split("/")[1]||n.endsWith("/*")&&o.split("/")[0]===n.split("/")[0])return o}function hte(r){if(r!=null&&(r=r.trim()),r?.startsWith("q=")!==!0)return 1;let e=parseFloat(r.replace("q=",""));return isNaN(e)?0:e}var R8={raw:"application/vnd.ipld.raw",car:"application/vnd.ipld.car","dag-json":"application/vnd.ipld.dag-json","dag-cbor":"application/vnd.ipld.dag-cbor",json:"application/json",cbor:"application/cbor","ipns-record":"application/vnd.ipfs.ipns-record",tar:"application/x-tar"};function qU(r){if(r!=null)return R8[r]}function pE(r){let e=r.get("accept");return!!(e!=null&&Object.values(R8).includes(e))}function mE(r){let e=r?.format;return!!(e!=null&&Object.keys(R8).includes(e))}function jU({query:r,headers:e}){return pE(e)||mE(r)}function WU({query:r,headers:e,logger:t}){let n=t.forComponent("helia:verified-fetch:get-resolved-accept-header"),o=new Headers(e),i=o.get("accept")??void 0;if(i!=null&&n('incoming accept header "%s"',i),!jU({query:r,headers:o}))return n("no explicit IPLD content-type requested, returning incoming accept header %s",i),i;let s=qU(r?.format);r?.format!=null&&n('incoming query format "%s", mapped to %s',r.format,s);let a=i;return!pE(o)&&mE(r)&&(n("accept header not recognized, but query format provided, setting accept header to %s",s),a=s),n('resolved accept header to "%s"',a),a}async function w0(r,e,t){let n=performance.now();try{let o=await t(),s=(performance.now()-n).toFixed(1),a=`${r};dur=${s};desc="${e}"`;return{result:o,header:a,error:null}}catch(o){let s=(performance.now()-n).toFixed(1),a=`${r};dur=${s};desc="${e}"`;return{result:null,error:o,header:a}}}var D8=class{lru;constructor(e){this.lru=new Lu({maxSize:e})}get(e){return this.lru.get(e)}set(e,t,n){this.lru.set(e,t,{maxAge:Date.now()+n})}has(e){return this.get(e)!=null}remove(e){this.lru.delete(e)}clear(){this.lru.clear()}};var GU=new D8(1e3),pte=/^(?<protocol>ip[fn]s):\/\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\/?(?<path>[^?]*)\??(?<queryString>.*)$/,mte=/^\/(?<protocol>ip[fn]s)\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\/?(?<path>[^?]*)\??(?<queryString>.*)$/,gte=/^https?:\/\/(.*[^/])\/(?<protocol>ip[fn]s)\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\/?(?<path>[^?]*)\??(?<queryString>.*)$/,yte=/^https?:\/\/(?<cidOrPeerIdOrDnsLink>[^/?]+)\.(?<protocol>ip[fn]s)\.([^/?]+)\/?(?<path>[^?]*)\??(?<queryString>.*)$/;function wte(r){let e=r?.protocol;if(e==null)return!1;let t=r?.cidOrPeerIdOrDnsLink;if(t==null)return!1;let n=r?.path,o=r?.queryString;return["ipns","ipfs"].includes(e)&&typeof t=="string"&&(n==null||typeof n=="string")&&(o==null||typeof o=="string")}function x0(r){for(let e of[yte,pte,gte,mte]){let t=r.match(e);if(wte(t?.groups))return t.groups}throw new TypeError(`Invalid URL: ${r}, please use ipfs://, ipns://, or gateway URLs only`)}function xte(r){if(r==null)return;let e=r.answer?.TTL,t=r.record?.ttl,n=t!=null?Number(t/BigInt(1e9)):void 0;return e??n}var bte=/^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?$/;function vte(r){return bte.test(r)&&r.includes("-")&&!r.includes(".")}function Ate(r){return r.replace(/--/g,"%").replace(/-/g,".").replace(/%/g,"-")}async function XU({urlString:r,ipns:e,logger:t,withServerTiming:n=!1},o){let i=t.forComponent("helia:verified-fetch:parse-url-string"),{protocol:s,cidOrPeerIdOrDnsLink:a,path:c,queryString:l}=x0(r),u,f,h=[],d,m=[];if(s==="ipfs")try{u=q.parse(a)}catch(x){i.error(x),h.push(new TypeError("Invalid CID for ipfs://<cid> URL"))}else if(d=GU.get(a),d!=null)u=d.cid,f=d.path,i.trace("resolved %s to %c from cache",a,u);else{i.trace("Attempting to resolve PeerId for %s",a);let x;try{x=E8(a);let v=x?.publicKey;if(v==null)throw new TypeError("cidOrPeerIdOrDnsLink contains no public key");if(n){let A=async()=>e.resolve(v,o),S=await w0("ipns.resolve",`Resolve IPNS name ${a}`,A);if(m.push(S),S.error!=null)throw S.error;d=S.result}else d=await e.resolve(v,o);u=d?.cid,f=d?.path,i.trace("resolved %s to %c",a,u)}catch(v){if(o?.signal?.aborted)throw new Xe(o?.signal?.reason);x==null?(i.error('could not parse PeerId string "%s"',a,v),h.push(new TypeError(`Could not parse PeerId in ipns url "${a}", ${v.message}`))):(i.error("could not resolve PeerId %c",x,v),h.push(new TypeError(`Could not resolve PeerId "${a}": ${v.message}`)))}if(u==null){let v=a;vte(a)&&(v=Ate(a),i.trace('decoded dnslink from "%s" to "%s"',a,v)),i.trace("Attempting to resolve DNSLink for %s",v);try{if(n){let A=await w0("ipns.resolveDNSLink",`Resolve DNSLink ${v}`,e.resolveDNSLink.bind(e,v,o));if(m.push(A),A.error!=null)throw A.error;d=A.result}else d=await e.resolveDNSLink(v,o);u=d?.cid,f=d?.path,i.trace("resolved %s to %c",v,u)}catch(A){if(o?.signal?.aborted)throw new Xe(o?.signal?.reason);i.error('could not resolve DnsLink for "%s"',a,A),h.push(A)}}}if(u==null)throw h.length===1?h[0]:(h.push(new Error(`Invalid resource. Cannot determine CID from URL "${r}".`)),h);let g=xte(d);d!=null&&(g=g??60*2,i.trace("caching %s resolved to %s with TTL: %s",a,u,g),GU.set(a,d,g*1e3));let w={};if(l!=null&&l.length>0){let x=l.split("&");for(let v of x){let[A,S]=v.split("=");w[A]=decodeURIComponent(S)}w.download!=null&&(w.download=w.download==="true"),w.filename!=null&&(w.filename=w.filename.toString())}return{protocol:s,cid:u,path:Ete(f,c??""),query:w,ttl:g,ipfsPath:`/${s}/${a}${c!=null&&c!==""?`/${c}`:""}`,serverTimings:m}}function Ete(r,e){let t="";return r!=null&&(t+=r),e.length>0&&(t=`${t.length>0?`${t}/`:t}${e}`),t=t.replace(/\/(\/)+/g,"/"),t.startsWith("/")&&(t=t.substring(1)),t.split("/").map(decodeURIComponent).join("/")}function YU(r){return r.match(/\.[a-zA-Z0-9]{1,4}$/)!=null||r.endsWith("/")?r:`${r}/`}async function QU({resource:r,options:e,logger:t,cid:n,fetch:o=globalThis.fetch}){let i=t.forComponent("helia:verified-fetch:get-redirect-response");if(typeof r!="string"||e==null||["ipfs://","ipns://"].some(u=>r.startsWith(u)))return null;let s=new Headers(e?.headers),a=s.get("x-forwarded-host"),c=s.get("host");if(s.get("x-forwarded-for")==null&&a==null&&c==null)return i.trace("no redirect info found in headers"),null;i.trace("checking for redirect info");try{let u=x0(r),f=new URL(r),h=a??f.host,d=new URL(f);if(u.protocol==="ipfs"&&n.version===0?d.host=`${n.toV1()}.ipfs.${h}`:d.host=`${u.cidOrPeerIdOrDnsLink}.${u.protocol}.${h}`,c?.includes(u.protocol)===!0&&d.host.includes(c))return i.trace("request was for a subdomain already, not setting location header"),null;if(c!=null&&!d.host.includes(c))return i.trace("host header is not the same as the subdomain url host, not setting location header"),null;if(f.host===d.host)return i.trace("req url is the same as the subdomain url, not setting location header"),null;d.pathname=YU(f.pathname.replace(`/${u.cidOrPeerIdOrDnsLink}`,"").replace(`/${u.protocol}`,"")),i.trace("subdomain url %s",d.href);let m=new URL(f,`${f.protocol}//${h}`);m.pathname=YU(f.pathname),i.trace("path url %s",m.href);try{let g=await o(d,{method:"HEAD"});if(g.ok)return i("subdomain supported, redirecting to subdomain"),Z1(r.toString(),d.href);throw i("subdomain not supported, subdomain failed with status %s %s",g.status,g.statusText),new A5("subdomain not supported")}catch(g){return i("subdomain not supported",g),m.href===f.href?(i("path url is the same as the request url, not setting location header"),null):Z1(r.toString(),m.href)}}catch(u){i.error("error setting location header for x-forwarded-host",u)}return null}async function ZU(r,{ipns:e,logger:t},{withServerTiming:n=!1,...o}={withServerTiming:!1}){if(typeof r=="string")return XU({urlString:r,ipns:e,logger:t,withServerTiming:n},o);let i=q.asCID(r);if(i!=null)return{cid:i,protocol:"ipfs",path:"",query:{},ipfsPath:`/ipfs/${i.toString()}`,ttl:29030400,serverTimings:[]};throw new TypeError(`Invalid resource. Cannot determine CID from resource: ${r}`)}function JU(r){let e=q.asCID(r);if(e!=null)return`ipfs://${e}`;try{return`ipfs://${q.parse(r.toString())}`}catch{}let{protocol:t,cidOrPeerIdOrDnsLink:n}=x0(r.toString());return`${t}://${n}`}var Ste=100,_te=60*1e3;function Cte(r){if(r==null)return;let e;return r?.signal===null?e=void 0:e=r?.signal,{...r,signal:e}}var N8=class{helia;ipns;log;contentTypeParser;blockstoreSessions;serverTimingHeaders=[];withServerTiming;plugins=[];constructor({helia:e,ipns:t},n){this.helia=e,this.log=e.logger.forComponent("helia:verified-fetch"),this.ipns=t??vB(e),this.contentTypeParser=n?.contentTypeParser??NU,this.blockstoreSessions=new Lu({maxSize:n?.sessionCacheSize??Ste,maxAge:n?.sessionTTLms??_te,onEviction:(a,c)=>{c.close()}}),this.withServerTiming=n?.withServerTiming??!1;let o={...n,logger:Z_("helia:verified-fetch"),getBlockstore:(a,c,l,u)=>this.getBlockstore(a,c,l,u),handleServerTiming:async(a,c,l)=>this.handleServerTiming(a,c,l,this.withServerTiming),helia:e,contentTypeParser:this.contentTypeParser},i=[new A8(o),new T5(o),new _8(o),new F5(o),new I8(o),new P8(o),new C8(o),new Q5(o),new v8(o)],s=n?.plugins?.map(a=>a(o))??[];if(s.length>0){let a=new Map(i.map(l=>[l.id,l])),c=new Map(s.map(l=>[l.id,l]));this.plugins=i.map(l=>c.get(l.id)??l),this.plugins.push(...s.filter(l=>!a.has(l.id)))}else this.plugins=i;this.log.trace("created VerifiedFetch instance")}getBlockstore(e,t,n=!0,o={}){let i=JU(t);if(!n)return this.helia.blockstore;let s=this.blockstoreSessions.get(i);return s==null&&(s=this.helia.blockstore.createSession(e,o),this.blockstoreSessions.set(i,s)),s}async handleServerTiming(e,t,n,o){if(!o)return n();let{error:i,result:s,header:a}=await w0(e,t,n);if(this.serverTimingHeaders.push(a),i!=null)throw i;return s}handleFinalResponse(e,{query:t,cid:n,reqFormat:o,ttl:i,protocol:s,ipfsPath:a,pathDetails:c,byteRangeContext:l,options:u}={}){if(this.serverTimingHeaders.length>0){let h=this.serverTimingHeaders.join(", ");e.headers.set("Server-Timing",h),this.serverTimingHeaders=[]}if(e.headers.get("Transfer-Encoding")!=="chunked"&&l!=null){let h=l.getLength();h!=null&&(this.log.trace("Setting Content-Length from byteRangeContext: %d",h),e.headers.set("Content-Length",h.toString()))}let f;if(this.log.trace("checking for content disposition"),t?.download===!0?f="attachment":this.log.trace("download not requested"),t?.filename!=null?(f==null&&(f="inline"),f=`${f}; ${KU(t.filename)}`):this.log.trace("no filename specified in query"),f!=null?e.headers.set("Content-Disposition",f):this.log.trace("no content disposition specified"),n!=null&&e.headers.get("etag")==null&&e.headers.set("etag",kc({cid:c?.terminalElement.cid??n,reqFormat:o,weak:!1})),s!=null&&SB({response:e,ttl:i,protocol:s}),a!=null&&e.headers.set("X-Ipfs-Path",a),e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Allow-Methods","GET, HEAD, OPTIONS"),e.headers.set("Access-Control-Allow-Headers","Range, X-Requested-With"),e.headers.set("Access-Control-Expose-Headers","Content-Range, Content-Length, X-Ipfs-Path, X-Stream-Output"),o!=="car"?e.headers.set("Accept-Ranges","bytes"):e.headers.set("Accept-Ranges","none"),u?.method==="HEAD"){let h=e?.headers;return new Response(null,{status:200,headers:h})}return e}async runPluginPipeline(e,t=3){let n,o=0,i=new Set,s=e.modified;for(;o<t;){this.log(`Starting pipeline pass #${o+1}`),o++;let a=this.plugins.filter(u=>!i.has(u.id)).filter(u=>u.canHandle(e));if(a.length===0){this.log.trace("No plugins can handle the current context.. checking by CID code");let u=this.plugins.filter(f=>f.codes.includes(e.cid.code));if(u.length>0)a.push(...u);else{this.log.trace("No plugins found that can handle request by CID code; exiting pipeline.");break}}this.log.trace("Plugins ready to handle request: ",a.map(u=>u.id).join(", "));let c=!1,l=!1;for(let u of a){try{this.log.trace("Invoking plugin:",u.id),i.add(u.id);let f=await u.handle(e);if(f!=null){n=f,l=!0;break}}catch(f){if(e.options?.signal?.aborted)throw new Xe(e.options?.signal?.reason);if(this.log.error("Error in plugin:",u.constructor.name,f),f.name==="PluginFatalError")return f.response??gh(e.resource,"Failed to fetch")}finally{let f=e.modified;c=f!==s,c&&(s=f)}if(n!=null){this.log.trace("Plugin produced final response:",u.id);break}}if(l&&n!=null)break;if(!c){this.log.trace("No context changes and no final response; exiting pipeline.");break}}return n}async fetch(e,t){if(this.log("fetch %s",e),t?.method==="OPTIONS")return this.handleFinalResponse(new Response(null,{status:200}));let n=Cte(t),o=n?.withServerTiming??this.withServerTiming;n?.onProgress?.(new j("verified-fetch:request:start",{resource:e}));let i;try{i=await this.handleServerTiming("parse-resource","",async()=>ZU(e,{ipns:this.ipns,logger:this.helia.logger},{withServerTiming:o,...n}),o),this.serverTimingHeaders.push(...i.serverTimings.map(({header:h})=>h))}catch(h){if(n?.signal?.aborted)throw new Xe(n?.signal?.reason);return this.log.error("error parsing resource %s",e,h),this.handleFinalResponse(Q1(e.toString(),h))}n?.onProgress?.(new j("verified-fetch:request:resolve",{cid:i.cid,path:i.path}));let s=WU({query:i.query,headers:n?.headers,logger:this.helia.logger}),a=zU(i.cid,s);if(this.log("output type %s",a),s!=null&&a==null)return this.handleFinalResponse(da(e.toString()));let c=a?.split(";")[0]??"application/octet-stream",l=await QU({resource:e,options:n,logger:this.helia.logger,cid:i.cid});if(l!=null)return this.handleFinalResponse(l);let u={...i,resource:e.toString(),accept:a,options:n,withServerTiming:o,onProgress:n?.onProgress,modified:0,plugins:this.plugins.map(h=>h.id)};this.log.trace('finding handler for cid code "%s" and response content type "%s"',i.cid.code,c);let f=await this.runPluginPipeline(u);return n?.onProgress?.(new j("verified-fetch:request:end",{cid:i.cid,path:i.path})),this.handleFinalResponse(f??C5(e.toString()),u)}async start(){await this.helia.start()}async stop(){await this.helia.stop()}};var b0,gE=async function(e,t){return b0==null&&(b0=await eF()),b0(e,t)};gE.start=async function(){await b0?.start()};gE.stop=async function(){await b0?.stop()};function Ite(r){return"ipfs-_blank"}function Tte(r,e){let t=e.globalData.gatewayURLWithoutSubdomain.host;return`<a class="ipfs-hash" translate="no" href="${e.globalData.gatewayURLWithoutSubdomain.protocol}//${t}/ipfs/${r.hash}?filename=${r.name}">${r.shortHash}</a>`}function kte(r){let e=r.split("."),t=[];for(let n=e.length-1;n>=0;n--){let o=e[n];if(o==="ipfs"||o==="ipns")break;t.push(o)}return t.reverse(),t.join(".")}function Pte(r){let e;try{e=new URL(r)}catch{e=new URL("https://inbrowser.link")}return e.host=kte(e.host),e}function Rte(r){return r.path!=null?`Index of <a href="${`${r.globalData.gatewayURL}/${r.path}`}">${r.name}</a>`:`Index of ${r.name} ${r.path}`}function Dte(r){return r.listing.map(e=>`<div class="type-icon">
      <div class="${Ite(e.name)}">&nbsp;</div>
    </div>
    <div>
      <a href="${e.path}">${e.name}</a>
    </div>
    <div class="nowrap">
      ${Tte(e,r)}
    </div>
    <div class="nowrap" title="Cumulative size of IPFS DAG (data + metadata)">${e.size}</div>`).join(" ")}function Nte(r){return r.path.split("/").pop()??r.path}function Ote(r){return r.length<=11?r:`${r.slice(0,4)}...${r.slice(-4)}`}var tF=(r,e,{gatewayURL:t,dnsLink:n,log:o})=>{o("loading directory html for %s",r.path);let i={globalData:{gatewayURL:t,gatewayURLWithoutSubdomain:Pte(t),dnsLink:n??!1},listing:e.map(s=>({size:s.size.toString(),name:s.name,path:Nte(s),hash:s.cid.toString(),shortHash:Ote(s.cid.toString())})),name:r.name,size:r.size.toString(),path:r.path,breadcrumbs:[],backLink:"",hash:r.cid.toString()};return`<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="description" content="A directory of content-addressed files hosted on IPFS.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlo89/56ZQ/8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACUjDu1lo89/6mhTP+zrVP/nplD/5+aRK8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHNiIS6Wjz3/ubFY/761W/+vp1D/urRZ/8vDZf/GvmH/nplD/1BNIm8AAAAAAAAAAAAAAAAAAAAAAAAAAJaPPf+knEj/vrVb/761W/++tVv/r6dQ/7q0Wf/Lw2X/y8Nl/8vDZf+tpk7/nplD/wAAAAAAAAAAAAAAAJaPPf+2rVX/vrVb/761W/++tVv/vrVb/6+nUP+6tFn/y8Nl/8vDZf/Lw2X/y8Nl/8G6Xv+emUP/AAAAAAAAAACWjz3/vrVb/761W/++tVv/vrVb/761W/+vp1D/urRZ/8vDZf/Lw2X/y8Nl/8vDZf/Lw2X/nplD/wAAAAAAAAAAlo89/761W/++tVv/vrVb/761W/++tVv/r6dQ/7q0Wf/Lw2X/y8Nl/8vDZf/Lw2X/y8Nl/56ZQ/8AAAAAAAAAAJaPPf++tVv/vrVb/761W/++tVv/vbRa/5aPPf+emUP/y8Nl/8vDZf/Lw2X/y8Nl/8vDZf+emUP/AAAAAAAAAACWjz3/vrVb/761W/++tVv/vrVb/5qTQP+inkb/op5G/6KdRv/Lw2X/y8Nl/8vDZf/Lw2X/nplD/wAAAAAAAAAAlo89/761W/++tVv/sqlS/56ZQ//LxWb/0Mlp/9DJaf/Kw2X/oJtE/7+3XP/Lw2X/y8Nl/56ZQ/8AAAAAAAAAAJaPPf+9tFr/mJE+/7GsUv/Rymr/0cpq/9HKav/Rymr/0cpq/9HKav+xrFL/nplD/8vDZf+emUP/AAAAAAAAAACWjz3/op5G/9HKav/Rymr/0cpq/9HKav/Rymr/0cpq/9HKav/Rymr/0cpq/9HKav+inkb/nplD/wAAAAAAAAAAAAAAAKKeRv+3slb/0cpq/9HKav/Rymr/0cpq/9HKav/Rymr/0cpq/9HKav+1sFX/op5G/wAAAAAAAAAAAAAAAAAAAAAAAAAAop5GUKKeRv/Nxmf/0cpq/9HKav/Rymr/0cpq/83GZ/+inkb/op5GSAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAop5G16KeRv/LxWb/y8Vm/6KeRv+inkaPAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAop5G/6KeRtcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/n8AAPgfAADwDwAAwAMAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAwAMAAPAPAAD4HwAA/n8AAA==">
    <title>${i.path}</title>
    <style>${Lte}</style>
  </head>
  <body>
    <!--
    # Some JSON content for debugging:

    ## dirData
    ${JSON.stringify(i,null,2)}
    -->
    <header id="header">
      <div class="ipfs-logo">&nbsp;</div>
      <!--
      <nav>
        <a href="https://ipfs.tech" target="_blank" rel="noopener noreferrer">About<span class="dn-mobile"> IPFS</span></a>
        <a href="https://docs.ipfs.tech/install/" target="_blank" rel="noopener noreferrer">Install<span class="dn-mobile"> IPFS</span></a>
      </nav>
      -->
    </header>
    <main id="main">
      <header class="flex flex-wrap">
        <div>
          <strong>${Rte(i)}</strong>
          ${i.hash==null?"":`<div class="ipfs-hash" translate="no">
                ${i.hash}
              </div>`}
        </div>
        ${i.size==null?"":`<div class="nowrap flex-shrink ml-auto">
              <strong title="Cumulative size of IPFS DAG (data + metadata)">&nbsp;${i.size}</strong>
            </div>`}
      </header>
      <div>
        <div class="grid dir">
          <!--{{ if .BackLink }}
            <div class="type-icon">
              <div class="ipfs-_blank">&nbsp;</div>
            </div>
            <div>
              <a href="{{.BackLink | urlEscape}}">..</a>
            </div>
            <div></div>
            <div></div>
          </tr>
          {{ end }}-->
          ${Dte(i)}
        </div>
      </div>
    </main>
  </body>
</html>`},Lte=`

    .ipfs-_blank {
        background-image: url("data:image/svg+xml,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 72 100'%3E%3ClinearGradient id='a' gradientUnits='userSpaceOnUse' x1='36' y1='1' x2='36' y2='99' gradientTransform='matrix(1 0 0 -1 0 100)'%3E%3Cstop offset='0' stop-color='%23c8d4db'/%3E%3Cstop offset='.139' stop-color='%23d8e1e6'/%3E%3Cstop offset='.359' stop-color='%23ebf0f3'/%3E%3Cstop offset='.617' stop-color='%23f9fafb'/%3E%3Cstop offset='1' stop-color='%23fff'/%3E%3C/linearGradient%3E%3Cpath d='M45 1l27 26.7V99H0V1h45z' fill='url(%23a)'/%3E%3Cpath d='M45 1l27 26.7V99H0V1h45z' fill-opacity='0' stroke='%237191a1' stroke-width='2'/%3E%3ClinearGradient id='b' gradientUnits='userSpaceOnUse' x1='45.068' y1='72.204' x2='58.568' y2='85.705' gradientTransform='matrix(1 0 0 -1 0 100)'%3E%3Cstop offset='0' stop-color='%23fff'/%3E%3Cstop offset='.35' stop-color='%23fafbfb'/%3E%3Cstop offset='.532' stop-color='%23edf1f4'/%3E%3Cstop offset='.675' stop-color='%23dde5e9'/%3E%3Cstop offset='.799' stop-color='%23c7d3da'/%3E%3Cstop offset='.908' stop-color='%23adbdc7'/%3E%3Cstop offset='1' stop-color='%2392a5b0'/%3E%3C/linearGradient%3E%3Cpath d='M45 1l27 26.7H45V1z' fill='url(%23b)'/%3E%3Cpath d='M45 1l27 26.7H45V1z' fill-opacity='0' stroke='%237191a1' stroke-width='2' stroke-linejoin='bevel'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-size: contain
    }

    :root {
        --sans-serif: "Plex",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
        --monospace: Consolas, monaco, monospace;
        --navy: #073a53;
        --teal: #6bc4ce;
        --turquoise: #47AFB4;
        --steel-gray: #3f5667;
        --dark-white: #d9dbe2;
        --light-white: #edf0f4;
        --near-white: #f7f8fa;
        --radius: 4px;
    }

    body {
        color: #34373f;
        font-family: var(--sans-serif);
        line-height: 1.43;
        margin: 0;
        word-break: break-all;
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
        -webkit-tap-highlight-color: transparent;
    }

    pre, code {
        font-family: var(--monospace);
    }

    a {
        color: #117eb3;
        text-decoration: none;
    }

    a:hover {
        color: #00b0e9;
        text-decoration: underline;
    }

    a:active,a:visited {
        color: #00b0e9;
    }

    .flex {
        display: flex;
    }

    .flex-wrap {
        flex-flow: wrap;
    }

    .flex-shrink {
        flex-shrink: 1;
    }

    .ml-auto {
        margin-left: auto;
    }

    .nowrap {
        white-space: nowrap
    }

    .ipfs-hash {
        color: #7f8491;
        font-family: var(--monospace);
    }

    #header {
        align-items: center;
        background: var(--navy);
        border-bottom: 4px solid var(--teal);
        color: #fff;
        display: flex;
        font-weight: 500;
        justify-content: space-between;
        padding: 0 1em;
    }

    #header a {
        color: var(--teal);
    }

    #header a:active {
        color: #9ad4db;
    }

    #header a:hover {
        color: #fff;
    }

    #header .ipfs-logo {
        height: 2.25em;
        margin: .7em .7em .7em 0;
        width: 7.15em
    }

    #header nav {
        align-items: center;
        display: flex;
        margin: .65em 0;
    }

    #header nav a {
        margin: 0 .6em;
    }

    #header nav a:last-child {
        margin: 0 0 0 .6em;
    }

    #header nav svg {
        fill: var(--teal);
        height: 1.8em;
        margin-top: .125em;
    }

    #header nav svg:hover {
        fill: #fff;
    }

    main {
        border: 1px solid var(--dark-white);
        border-radius: var(--radius);
        overflow: hidden;
        margin: 1em;
        font-size: .875em;
    }

    main header,main .container {
        padding-left: 1em;
        padding-right: 1em;
    }

    main header {
        padding-top: .7em;
        padding-bottom: .7em;
        background-color: var(--light-white);
    }

    main header,main section:not(:last-child) {
        border-bottom: 1px solid var(--dark-white);
    }

    main section header {
        background-color: var(--near-white);
    }

    .grid {
        display: grid;
        overflow-x: auto;
    }

    .grid .grid {
        overflow-x: visible;
    }

    .grid > div {
        padding: .7em;
        border-bottom: 1px solid var(--dark-white);
    }

    .grid.dir {
        grid-template-columns: min-content 1fr min-content min-content;
    }

    .grid.dir > div:nth-of-type(4n+1) {
        padding-left: 1em;
    }

    .grid.dir > div:nth-of-type(4n+4) {
        padding-right: 1em;
    }

    .grid.dir > div:nth-last-child(-n+4) {
        border-bottom: 0;
    }

    .grid.dir > div:nth-of-type(8n+5),.grid.dir > div:nth-of-type(8n+6),.grid.dir > div:nth-of-type(8n+7),.grid.dir > div:nth-of-type(8n+8) {
        background-color: var(--near-white);
    }

    .grid.dag {
        grid-template-columns: max-content 1fr;
    }

    .grid.dag pre {
        margin: 0;
    }

    .grid.dag .grid {
        padding: 0;
    }

    .grid.dag > div:nth-last-child(-n+2) {
        border-bottom: 0;
    }

    .grid.dag > div {
        background: white
    }

    .grid.dag > div:nth-child(4n),.grid.dag > div:nth-child(4n+3) {
        background-color: var(--near-white);
    }

    section > .grid.dag > div:nth-of-type(2n+1) {
        padding-left: 1em;
    }

    .type-icon,.type-icon > * {
        width: 1.15em
    }

    .terminal {
        background: var(--steel-gray);
        color: white;
        padding: .7em;
        border-radius: var(--radius);
        word-wrap: break-word;
        white-space: break-spaces;
    }

    @media print {
        #header {
            display: none;
        }

        #main header,.ipfs-hash,body {
            color: #000;
        }

        #main,#main header {
            border-color: #000;
        }

        a,a:visited {
            color: #000;
            text-decoration: underline;
        }

        a[href]:after {
            content: " (" attr(href) ")"
        }
    }

    @media only screen and (max-width: 500px) {
        .dn-mobile {
            display: none;
        }
    }`;async function Bte(r){let e=r.reduce((n,o)=>`${n}${o.name}${o.cid.toString()}`,""),t=await De.encode(new TextEncoder().encode(e));return Vt.encode(t)}var O8=class extends Ct{id="dir-index-html-plugin";codes=[Qe];canHandle(e){let{cid:t,pathDetails:n,directoryEntries:o}=e;return n==null||n.terminalElement?.type!=="directory"||o==null||o.length===0?!1:t.code===Qe}async handle(e){let{resource:t,pathDetails:n,directoryEntries:o}=e,{terminalElement:i,ipfsRoots:s}=n,c=tF(i,o,{gatewayURL:t,log:this.log});e.byteRangeContext.setBody(c);let l=`DirIndex-${await Bte(o)}_CID-`;return ln(t,e.byteRangeContext.getBody("text/html"),{byteRangeContext:e.byteRangeContext,log:this.log},{headers:{"Content-Type":e.byteRangeContext.getContentType()??"text/html","Cache-Control":"public, max-age=604800, stale-while-revalidate=2678400","X-Ipfs-Roots":Y1(s),Etag:kc({cid:i.cid,reqFormat:e.reqFormat,contentPrefix:l})}})}},Mte=r=>new O8(r);function rF(r){if(r==null)return!1;let e=r;return e["/"]!=null&&e["/"]===e.bytes||r.asCID===r}function nF(r){return r==null||typeof r=="string"||typeof r=="number"||typeof r=="boolean"||typeof r=="bigint"||typeof r=="symbol"}async function oF(r){let e="0.0.1",t=Object.entries(r).reduce((o,[i,s])=>nF(s)?`${o}${i}${s}`:`${o}${i}${oF(s)}`,""),n=await De.encode(new TextEncoder().encode(e+t));return Vt.encode(n)}var L8=class extends Ct{id="dag-cbor-plugin-html-preview";codes=[Pr];canHandle({cid:e,accept:t,pathDetails:n}){return this.log("checking if we can handle %c with accept %s",e,t),n==null||!Sh(n.terminalElement)||e.code!==Pr||t==null||!t.includes("text/html")?!1:Sh(n.terminalElement)}async handle(e){let{cid:t,path:n,pathDetails:{terminalElement:o,ipfsRoots:i}}=e;this.log.trace("generating html preview for %c/%s",t,n);let s=o.node,a;try{a=ji(s)}catch(l){return new Response(`<pre>Failed to decode DAG-CBOR: ${String(l)}</pre>`,{status:500,headers:{"Content-Type":"text/html"}})}let c=this.getHtml({path:n,obj:a,cid:t});return new Response(c,{status:200,headers:{"Content-Type":"text/html","X-Ipfs-Roots":Y1(i),"Cache-Control":"public, max-age=604800, stale-while-revalidate=2678400",Etag:kc({cid:t,reqFormat:e.reqFormat,contentPrefix:`DagIndex-${await oF(a)}_CID-`})}})}getHtml({path:e,obj:t,cid:n}){return`<!DOCTYPE html>
  <html lang="en">
    <head>
      <meta charset="utf-8">
      <meta name="description" content="Content-addressed dag-cbor document hosted on IPFS.">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlo89/56ZQ/8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACUjDu1lo89/6mhTP+zrVP/nplD/5+aRK8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHNiIS6Wjz3/ubFY/761W/+vp1D/urRZ/8vDZf/GvmH/nplD/1BNIm8AAAAAAAAAAAAAAAAAAAAAAAAAAJaPPf+knEj/vrVb/761W/++tVv/r6dQ/7q0Wf/Lw2X/y8Nl/8vDZf+tpk7/nplD/wAAAAAAAAAAAAAAAJaPPf+2rVX/vrVb/761W/++tVv/vrVb/6+nUP+6tFn/y8Nl/8vDZf/Lw2X/y8Nl/8G6Xv+emUP/AAAAAAAAAACWjz3/vrVb/761W/++tVv/vrVb/761W/+vp1D/urRZ/8vDZf/Lw2X/y8Nl/8vDZf/Lw2X/nplD/wAAAAAAAAAAlo89/761W/++tVv/vrVb/761W/++tVv/r6dQ/7q0Wf/Lw2X/y8Nl/8vDZf/Lw2X/y8Nl/56ZQ/8AAAAAAAAAAJaPPf++tVv/vrVb/761W/++tVv/vbRa/5aPPf+emUP/y8Nl/8vDZf/Lw2X/y8Nl/8vDZf+emUP/AAAAAAAAAACWjz3/vrVb/761W/++tVv/vrVb/5qTQP+inkb/op5G/6KdRv/Lw2X/y8Nl/8vDZf/Lw2X/nplD/wAAAAAAAAAAlo89/761W/++tVv/sqlS/56ZQ//LxWb/0Mlp/9DJaf/Kw2X/oJtE/7+3XP/Lw2X/y8Nl/56ZQ/8AAAAAAAAAAJaPPf+9tFr/mJE+/7GsUv/Rymr/0cpq/9HKav/Rymr/0cpq/9HKav+xrFL/nplD/8vDZf+emUP/AAAAAAAAAACWjz3/op5G/9HKav/Rymr/0cpq/9HKav/Rymr/0cpq/9HKav/Rymr/0cpq/9HKav+inkb/nplD/wAAAAAAAAAAAAAAAKKeRv+3slb/0cpq/9HKav/Rymr/0cpq/9HKav/Rymr/0cpq/9HKav+1sFX/op5G/wAAAAAAAAAAAAAAAAAAAAAAAAAAop5GUKKeRv/Nxmf/0cpq/9HKav/Rymr/0cpq/83GZ/+inkb/op5GSAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAop5G16KeRv/LxWb/y8Vm/6KeRv+inkaPAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAop5G/6KeRtcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/n8AAPgfAADwDwAAwAMAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAwAMAAPAPAAD4HwAA/n8AAA==">
      <title>${n.toString()} DAG-CBOR Preview</title>
      <style>
      :root {
        --sans-serif: "Plex", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
        --monospace: Consolas, monaco, monospace;
        --navy: #073a53;
        --teal: #6bc4ce;
        --turquoise: #47AFB4;
        --steel-gray: #3f5667;
        --dark-white: #d9dbe2;
        --light-white: #edf0f4;
        --near-white: #f7f8fa;
        --radius: 4px;
      }
      body {
        color: #34373f;
        font-family: var(--sans-serif);
        line-height: 1.43;
        margin: 0;
        word-break: break-all;
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
        -webkit-tap-highlight-color: transparent;
      }
      main {
        border: 1px solid var(--dark-white);
        border-radius: var(--radius);
        overflow: hidden;
        margin: 1em;
        font-size: .875em;
      }
      main section header {
        background-color: var(--near-white);
      }
      main header, main section:not(:last-child) {
        border-bottom: 1px solid var(--dark-white);
      }
      main header {
        padding-top: .7em;
        padding-bottom: .7em;
        background-color: var(--light-white);
      }
      main header, main .container {
        padding-left: 1em;
        padding-right: 1em;
      }
      section {
        display: block;
      }
      .grid.dag {
        grid-template-columns: max-content 1fr;
      }
      .grid {
        display: grid;
        overflow-x: auto;
      }
      .grid.dag > div {
        background: white;
      }
      .grid.dag > div:nth-of-type(2n+1) {
        padding-left: 1em;
      }
      .grid.dag > div:nth-child(4n), .grid.dag > div:nth-child(4n+3) {
        background-color: var(--near-white);
      }
      .grid.dag .grid {
        padding: 0;
      }
      /* change coloring of nested grid
      .grid.dag .grid.dag > div:nth-child(4n), .grid.dag .grid.dag > div:nth-child(4n+3) {
        background-color: white;
      }
      .grid.dag .grid.dag div:nth-child(4n+1), .grid.dag .grid.dag div:nth-child(4n+2) {
        background-color: var(--near-white);
      } */
      .grid.dag > div:nth-last-child(-n+2) {
        border-bottom: 0;
      }
      .grid .grid {
        overflow-x: visible;
      }
      .grid > div {
        padding: .7em;
        border-bottom: 1px solid var(--dark-white);
      }
      .nowrap {
        white-space: nowrap;
      }
      pre, code {
        font-family: var(--monospace);
      }
      strong {
        font-weight: bolder;
      }
      a:active, a:visited {
        color: #00b0e9;
      }
      .ipfs-hash {
        color: #7f8491;
        font-family: var(--monospace);
      }
      a {
        color: #117eb3;
        text-decoration: none;
      }
      header { margin-bottom: 2em; }
      .ipfs-logo { width: 32px; height: 32px; background: url('data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlo89/56ZQ/8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACUjDu1lo89/6mhTP+zrVP/nplD/5+aRK8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHNiIS6Wjz3/ubFY/761W/+vp1D/urRZ/8vDZf/GvmH/nplD/1BNIm8AAAAAAAAAAAAAAAAAAAAAAAAAAJaPPf+knEj/vrVb/761W/++tVv/r6dQ/7q0Wf/Lw2X/y8Nl/8vDZf+tpk7/nplD/wAAAAAAAAAAAAAAAJaPPf+2rVX/vrVb/761W/++tVv/vrVb/6+nUP+6tFn/y8Nl/8vDZf/Lw2X/y8Nl/8G6Xv+emUP/AAAAAAAAAACWjz3/vrVb/761W/++tVv/vrVb/761W/+vp1D/urRZ/8vDZf/Lw2X/y8Nl/8vDZf/Lw2X/nplD/wAAAAAAAAAAlo89/761W/++tVv/vrVb/761W/++tVv/r6dQ/7q0Wf/Lw2X/y8Nl/8vDZf/Lw2X/y8Nl/56ZQ/8AAAAAAAAAAJaPPf++tVv/vrVb/761W/++tVv/vbRa/5aPPf+emUP/y8Nl/8vDZf/Lw2X/y8Nl/8vDZf+emUP/AAAAAAAAAACWjz3/vrVb/761W/++tVv/vrVb/5qTQP+inkb/op5G/6KdRv/Lw2X/y8Nl/8vDZf/Lw2X/nplD/wAAAAAAAAAAlo89/761W/++tVv/sqlS/56ZQ//LxWb/0Mlp/9DJaf/Kw2X/oJtE/7+3XP/Lw2X/y8Nl/56ZQ/8AAAAAAAAAAJaPPf+9tFr/mJE+/7GsUv/Rymr/0cpq/9HKav/Rymr/0cpq/9HKav+xrFL/nplD/8vDZf+emUP/AAAAAAAAAACWjz3/op5G/9HKav/Rymr/0cpq/9HKav/Rymr/0cpq/9HKav/Rymr/0cpq/9HKav+inkb/nplD/wAAAAAAAAAAAAAAAKKeRv+3slb/0cpq/9HKav/Rymr/0cpq/9HKav/Rymr/0cpq/9HKav+1sFX/op5G/wAAAAAAAAAAAAAAAAAAAAAAAAAAop5GUKKeRv/Nxmf/0cpq/9HKav/Rymr/0cpq/83GZ/+inkb/op5GSAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAop5G16KeRv/LxWb/y8Vm/6KeRv+inkaPAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAop5G/6KeRtcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/n8AAPgfAADwDwAAwAMAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAwAMAAPAPAAD4HwAA/n8AAA==') no-repeat center/contain; display: inline-block; }
    </style>
    </head>
    <body>
      <main>
        <header>
          <div><strong>CID: </strong> <code class="nowrap">${n}</code></div>
          <div><strong>Codec: </strong> ${this.valueHTML("dag-cbor (0x71)",null)}</div>
        </header>
        <section class="container">
          <p>You can download this block as:</p>
          <ul>
            <li><a href="?format=raw&download=true&filename=${n.toString()}.bin" rel="nofollow" download="${n.toString()}.bin">Raw Block</a> (no conversion)</li>
            <li><a href="?format=dag-json&download=true&filename=${n.toString()}.json" rel="nofollow" download="${n.toString()}">Valid DAG-JSON</a> (specs at <a href="https://ipld.io/specs/codecs/dag-json/spec/" target="_blank" rel="noopener noreferrer">IPLD</a> and <a href="https://www.iana.org/assignments/media-types/application/vnd.ipld.dag-json" target="_blank" rel="noopener noreferrer">IANA</a>)</li>
            <li><a href="?format=dag-cbor&download=true&filename=${n.toString()}.dag-cbor" rel="nofollow" download="${n.toString()}.dag-cbor">Valid DAG-CBOR</a> (specs at <a href="https://ipld.io/specs/codecs/dag-cbor/spec/" target="_blank" rel="noopener noreferrer">IPLD</a> and <a href="https://www.iana.org/assignments/media-types/application/vnd.ipld.dag-cbor" target="_blank" rel="noopener noreferrer">IANA</a>)</li>
          </ul>
        </section>
        <section>
          <header><strong>DAG-CBOR Preview</strong></header>
          <div class="grid dag">
            ${this.renderRows(t,e)}
          </div>
        </section>
      </main>
    </body>
  </html>`}valueHTML(e,t){let n,o=rF(e);!o&&typeof e!="string"?n=JSON.stringify(e):n=e.toString();let i=`<code class="nowrap">${n}</code>`;return o&&t!=null?`<a class="ipfs-hash" href="/${t}">${i}</a>`:i}renderValue(e,t,n){let o="";return t.forEach((i,s)=>{let a=n?`${n}/${e}/${s}`:`${e}/${s}`;o+=`<div>${this.valueHTML(s,null)}</div>`,nF(i)?o+=`<div>${this.valueHTML(i,a)}</div>`:(o+='<div class="grid dag">',o+=this.renderRows(i,a),o+="</div>")}),o}renderRows(e,t=""){let n="";for(let[o,i]of Object.entries(e))if(Array.isArray(i))n+=`<div>${o}</div>`,n+='<div class="grid dag">',n+=this.renderValue(o,i,t),n+="</div>";else{let s=t?`${t}/${o}`:o;n+=`<div>${o}</div><div>${this.valueHTML(i,s)}</div>`}return n}},Ute=r=>new L8(r);async function eF(r,e){let t;if(!Fte(r)){let i=Hte(r?.dnsResolvers),s=dB();s.dns=i;let a=r?.routers??["https://delegated-ipfs.dev"];for(let u=0;u<a.length;u++){let f=a[u];s.services[`delegatedRouting${u}`]=()=>iy(f)}r?.libp2pConfig!=null&&Object.assign(s,r.libp2pConfig),t=await I3(s);let c=[Mp()],l=[rm(t)];(r?.gateways==null||r.gateways.length>0)&&(c.push(Yp({allowInsecure:r?.allowInsecure,allowLocal:r?.allowLocal})),l.push(tm({gateways:r?.gateways??["https://trustless-gateway.link"]}))),r=await fB({libp2p:t,blockBrokers:c,dns:i,routers:l,hashers:r?.hashers}),r.logger.forComponent("helia:verified-fetch").trace("created verified-fetch with libp2p config: %j",s)}let n=new N8({helia:r},e);async function o(i,s){return n.fetch(i,s)}return o.start=n.start.bind(n),o.stop=n.stop.bind(n),o}function Fte(r){return r?.blockstore!=null&&r?.datastore!=null&&r?.gc!=null&&r?.stop!=null&&r?.start!=null}function Hte(r){if(r!=null)return Array.isArray(r)?sl({resolvers:{".":r}}):sl({resolvers:r})}export{Ct as BasePlugin,L8 as DagCborHtmlPreviewPlugin,O8 as DirIndexHtmlPlugin,S8 as PluginError,Tc as PluginFatalError,eF as createVerifiedFetch,Ute as dagCborHtmlPreviewPluginFactory,Mte as dirIndexHtmlPluginFactory,gE as verifiedFetch};
/*! Bundled license information:

pvtsutils/build/index.js:
  (*!
   * MIT License
   * 
   * Copyright (c) 2017-2024 Peculiar Ventures, LLC
   * 
   * Permission is hereby granted, free of charge, to any person obtaining a copy
   * of this software and associated documentation files (the "Software"), to deal
   * in the Software without restriction, including without limitation the rights
   * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   * copies of the Software, and to permit persons to whom the Software is
   * furnished to do so, subject to the following conditions:
   * 
   * The above copyright notice and this permission notice shall be included in all
   * copies or substantial portions of the Software.
   * 
   * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   * SOFTWARE.
   * 
   *)

reflect-metadata/Reflect.js:
  (*! *****************************************************************************
  Copyright (C) Microsoft. All rights reserved.
  Licensed under the Apache License, Version 2.0 (the "License"); you may not use
  this file except in compliance with the License. You may obtain a copy of the
  License at http://www.apache.org/licenses/LICENSE-2.0
  
  THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
  WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
  MERCHANTABLITY OR NON-INFRINGEMENT.
  
  See the Apache Version 2.0 License for specific language governing permissions
  and limitations under the License.
  ***************************************************************************** *)

ieee754/index.js:
  (*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> *)

@noble/hashes/esm/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/utils.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/modular.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/curve.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/edwards.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/montgomery.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/ed25519.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/weierstrass.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/_shortw_utils.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/secp256k1.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

pvutils/build/utils.es.js:
  (*!
   Copyright (c) Peculiar Ventures, LLC
  *)

asn1js/build/index.es.js:
  (*!
   * Copyright (c) 2014, GMO GlobalSign
   * Copyright (c) 2015-2022, Peculiar Ventures
   * All rights reserved.
   * 
   * Author 2014-2019, Yury Strozhevsky
   * 
   * Redistribution and use in source and binary forms, with or without modification,
   * are permitted provided that the following conditions are met:
   * 
   * * Redistributions of source code must retain the above copyright notice, this
   *   list of conditions and the following disclaimer.
   * 
   * * Redistributions in binary form must reproduce the above copyright notice, this
   *   list of conditions and the following disclaimer in the documentation and/or
   *   other materials provided with the distribution.
   * 
   * * Neither the name of the copyright holder nor the names of its
   *   contributors may be used to endorse or promote products derived from
   *   this software without specific prior written permission.
   * 
   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
   * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
   * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
   * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
   * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
   * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
   * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
   * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
   * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
   * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
   * 
   *)

@noble/ciphers/esm/utils.js:
  (*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) *)

@peculiar/x509/build/x509.es.js:
  (*!
   * MIT License
   * 
   * Copyright (c) Peculiar Ventures. All rights reserved.
   * 
   * Permission is hereby granted, free of charge, to any person obtaining a copy
   * of this software and associated documentation files (the "Software"), to deal
   * in the Software without restriction, including without limitation the rights
   * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   * copies of the Software, and to permit persons to whom the Software is
   * furnished to do so, subject to the following conditions:
   * 
   * The above copyright notice and this permission notice shall be included in all
   * copies or substantial portions of the Software.
   * 
   * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   * SOFTWARE.
   * 
   *)
*/
//# sourceMappingURL=verified-fetch.bundle.mjs.map
